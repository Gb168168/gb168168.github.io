<!doctype html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>點餐系統 - 管理者</title>

  <style>
    :root{
      --bg:#0b1220;
      --panel:#0a1430;
      --card:#0f1a33;
      --text:#e8eeff;
      --muted:#a9b4d6;
      --line:rgba(255,255,255,.10);
      --primary:#6ee7ff;
      --accent:#fb7185;
      --ok:#34d399;
      --warn:#fbbf24;
      --shadow: 0 10px 30px rgba(0,0,0,.35);
    }

    /* ✅ 修白底：讓瀏覽器原生表單 UI 走深色 */
    :root, body{ color-scheme: dark; }

    *{box-sizing:border-box}
    body{
      margin:0;
      font-family: ui-sans-serif, system-ui, -apple-system, "Segoe UI", Roboto, "Noto Sans TC", Arial;
      background:
        radial-gradient(1000px 600px at 15% 0%, rgba(110,231,255,.15), transparent 55%),
        radial-gradient(900px 600px at 100% 25%, rgba(251,113,133,.14), transparent 55%),
        var(--bg);
      color:var(--text);
    }

    .wrap{display:flex;min-height:100vh}
    aside{
      width:260px;
      padding:16px;
      border-right:1px solid var(--line);
      background:linear-gradient(180deg, rgba(255,255,255,.04), rgba(255,255,255,.02));
      backdrop-filter: blur(10px);
    }
    .brand{display:flex;flex-direction:column;gap:4px;margin-bottom:14px}
    .brand b{font-size:16px}
    .brand span{font-size:12px;color:var(--muted)}

    .menu{display:grid;gap:10px;margin-top:10px}
    .menu button{
      width:100%;
      text-align:left;
      padding:11px 12px;
      border-radius:14px;
      border:1px solid var(--line);
      background:rgba(255,255,255,.04);
      color:var(--text);
      cursor:pointer;
      transition:.15s;
    }
    .menu button:hover{transform:translateY(-1px);background:rgba(255,255,255,.07)}
    .menu button.active{
      border-color:rgba(110,231,255,.35);
      background:rgba(110,231,255,.12);
    }

    main{flex:1;padding:18px;max-width:1200px}
    header{
      display:flex;gap:10px;align-items:center;justify-content:space-between;
      padding:14px 16px;
      border:1px solid var(--line);
      border-radius:18px;
      background:linear-gradient(135deg, rgba(255,255,255,.06), rgba(255,255,255,.02));
      box-shadow: var(--shadow);
    }
    .row{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
    .pill{
      display:inline-flex;gap:8px;align-items:center;
      padding:7px 10px;border:1px solid var(--line);border-radius:999px;
      background:rgba(255,255,255,.03); color:var(--muted); font-size:12px;
    }
    .card{
      margin-top:14px;
      border:1px solid var(--line);
      border-radius:18px;
      background:linear-gradient(180deg, rgba(255,255,255,.05), rgba(255,255,255,.02));
      padding:14px;
      box-shadow: var(--shadow);
    }
    .hr{height:1px;background:var(--line);margin:12px 0}
    .hint{font-size:12px;color:var(--muted);line-height:1.5}
    .hint.ok{color:var(--ok)}
    .hint.warn{color:var(--warn)}
    .hint.bad{color:var(--accent)}

    input,select,textarea{
      padding:10px 12px;
      border-radius:12px;
      border:1px solid var(--line);
      background:rgba(255,255,255,.04);
      color:var(--text);
      outline:none;
    }
    textarea{width:100%;min-height:80px;resize:vertical}

    /* ✅ 修白底：option 深色 */
    select option{
      background:#0b1630;
      color:#e8eeff;
    }
    select option[value=""]{ color: rgba(232,238,255,.55); }
    select option:checked{ background: rgba(110,231,255,.25); color:#e8eeff; }

    .btn{
      border:1px solid var(--line);
      background:rgba(255,255,255,.06);
      color:var(--text);
      padding:10px 12px;
      border-radius:12px;
      cursor:pointer;
      transition:.15s;
      user-select:none;
      white-space:nowrap;
    }
    .btn:hover{transform:translateY(-1px);background:rgba(255,255,255,.09)}
    .btn.primary{border-color:rgba(110,231,255,.35);background:rgba(110,231,255,.10)}
    .btn.danger{border-color:rgba(251,113,133,.35);background:rgba(251,113,133,.10)}

    .grid2{display:grid;grid-template-columns:1fr 1fr;gap:12px}
    @media (max-width: 900px){ .grid2{grid-template-columns:1fr} }

    .list{display:grid;gap:10px}
    .sectionTitle{display:flex;justify-content:space-between;gap:10px;align-items:center}
    .sectionTitle b{font-size:14px}
    .tag{
      font-size:12px;color:var(--muted);
      border:1px solid var(--line);
      background:rgba(255,255,255,.03);
      padding:6px 10px;border-radius:999px;
    }

    .group{
      border:1px solid var(--line);
      border-radius:16px;
      background:rgba(255,255,255,.03);
      overflow:hidden;
    }
    .groupHead{
      padding:12px 12px;
      display:flex;align-items:center;justify-content:space-between;
      cursor:pointer;
      user-select:none;
      background:rgba(255,255,255,.02);
    }
    .groupHead:hover{background:rgba(255,255,255,.04)}
    .groupBody{padding:12px;display:grid;gap:10px}
    .hidden{display:none !important}

    .miniRow{display:flex;gap:10px;flex-wrap:wrap;align-items:center;justify-content:space-between}
    .itemRow{
      border:1px solid var(--line);
      border-radius:14px;
      padding:10px;
      background:rgba(255,255,255,.02);
      display:flex;justify-content:space-between;gap:10px;align-items:flex-start;
    }
    .itemRow b{font-size:13px}
    .itemRow .meta{font-size:12px;color:var(--muted);line-height:1.5}
    .itemRow .actions{display:flex;gap:8px;align-items:center}

    .mono{font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;}
  </style>
</head>

<body>
<div class="wrap">

  <aside>
    <div class="brand">
      <b>點餐系統（管理者）</b>
      <span>人員 / 餐廳 / 訂餐紀錄</span>
    </div>

    <div class="menu">
      <button class="active" data-tab="staff">人員管理</button>
      <button data-tab="restaurants">餐廳管理</button>
      <button data-tab="orders">訂餐紀錄</button>
      <button id="btnGoUser">回使用者頁</button>
    </div>

    <div class="hr"></div>
    <div class="hint">
      提醒：此版本為「不需要 Index」寫法（抓全部 → 前端處理）
    </div>
  </aside>

  <main>
    <header>
      <div>
        <b style="font-size:16px">管理者後台</b>
        <div class="hint" id="topHint">載入中…</div>
      </div>
      <div class="row">
        <span class="pill" id="statPill">—</span>
        <button class="btn" id="btnReloadAll">重新載入</button>
      </div>
    </header>

    <!-- 人員管理 -->
    <section id="tab-staff" class="card">
      <div class="sectionTitle">
        <b>人員管理</b>
        <span class="tag">同部門收合</span>
      </div>

      <div class="hr"></div>

      <div class="grid2">
        <div>
          <div class="hint">新增人員（部門 + 姓名）</div>
          <div class="row" style="margin-top:8px">
            <input id="staffDept" placeholder="部門" style="flex:1;min-width:140px">
            <input id="staffName" placeholder="姓名" style="flex:1;min-width:140px">
            <button class="btn primary" id="btnAddStaff">新增</button>
          </div>
          <div class="hint" id="staffHint"></div>
        </div>

        <div>
          <div class="hint">快速刪除：在清單內點「刪除」即可</div>
          <div class="hint">資料表：<span class="mono">staff</span>（欄位：dept、name）</div>
        </div>
      </div>

      <div class="hr"></div>
      <div id="staffList" class="list"></div>
    </section>

    <!-- 餐廳管理 -->
    <section id="tab-restaurants" class="card hidden">
      <div class="sectionTitle">
        <b>餐廳管理</b>
        <span class="tag">收合顯示＋含餐點/加購</span>
      </div>

      <div class="hr"></div>

      <div class="grid2">
        <div>
          <div class="hint">新增餐廳（名稱必填、網址可空）</div>
          <div class="row" style="margin-top:8px">
            <input id="restName" placeholder="餐廳名稱" style="flex:1;min-width:180px">
            <input id="restUrl" placeholder="店家網址（可空）" style="flex:1;min-width:220px">
            <button class="btn primary" id="btnAddRest">新增</button>
          </div>
          <div class="hint" id="restHint"></div>
        </div>

        <div>
          <div class="hint">資料表：<span class="mono">restaurants</span></div>
          <div class="hint">欄位：name、url、img（可空）、menus（陣列）、addons（陣列）</div>
        </div>
      </div>

      <div class="hr"></div>

      <!-- 餐點新增（對選定餐廳） -->
      <div class="group" style="margin-bottom:12px">
        <div class="groupHead" id="menuAddHead">
          <b>新增餐點（先選餐廳）</b>
          <span class="tag" id="menuAddTag">尚未選餐廳</span>
        </div>
        <div class="groupBody" id="menuAddBody">
          <div class="row">
            <select id="restSelectForMenu" style="flex:1;min-width:240px">
              <option value="">請選餐廳</option>
            </select>
          </div>

          <div class="grid2">
            <div class="row">
              <input id="menuCategory" placeholder="餐點類別（例如：飯/麵/飲料）" style="flex:1;min-width:180px">
              <input id="menuName" placeholder="餐點名稱" style="flex:1;min-width:180px">
            </div>
            <div class="row">
              <input id="menuPrice" placeholder="價格（單份）" type="number" min="0" step="1" style="width:180px">
              <input id="menuDefaultQty" placeholder="預設數量" type="number" min="0" step="1" style="width:160px">
            </div>
          </div>

          <div class="group" style="margin-top:10px">
            <div class="groupHead" id="addonHead">
              <b>此餐點加購項目</b>
              <span class="hint">可新增多筆（免費/金額）</span>
            </div>
            <div class="groupBody" id="addonBody">
              <div class="row">
                <input id="addonName" placeholder="加購名稱（例如：加蛋）" style="flex:1;min-width:200px">
                <input id="addonPrice" placeholder="金額（0=免費）" type="number" min="0" step="1" style="width:180px">
                <button class="btn" id="btnAddAddon">加入加購</button>
              </div>
              <div class="hint" id="addonHint"></div>
              <div id="addonTempList" class="list"></div>
            </div>
          </div>

          <div class="row" style="justify-content:space-between;margin-top:10px">
            <div class="hint" id="menuHint"></div>
            <button class="btn primary" id="btnAddMenu">新增餐點</button>
          </div>
        </div>
      </div>

      <div id="restaurantList" class="list"></div>
    </section>

    <!-- 訂餐紀錄 -->
    <section id="tab-orders" class="card hidden">
      <div class="sectionTitle">
        <b>訂餐紀錄（彙整輸出）</b>
        <span class="tag">可刪除 / 匯出 Excel</span>
      </div>

      <div class="hr"></div>

      <div class="grid2">
        <div>
          <div class="hint">篩選（前端篩選，不需要 index）</div>
          <div class="row" style="margin-top:8px">
            <select id="fDept" style="min-width:180px">
              <option value="">全部部門</option>
            </select>
            <select id="fName" style="min-width:180px">
              <option value="">全部姓名</option>
            </select>
            <select id="fRest" style="min-width:220px">
              <option value="">全部餐廳</option>
            </select>
            <button class="btn" id="btnClearFilter">清除篩選</button>
          </div>
          <div class="hint" id="orderHint"></div>
        </div>

        <div class="row" style="justify-content:flex-end;align-items:flex-end">
          <button class="btn primary" id="btnExportExcel">匯出 Excel</button>
          <button class="btn" id="btnReloadOrders">重新載入訂單</button>
        </div>
      </div>

      <div class="hr"></div>
      <div id="orderList" class="list"></div>
    </section>

  </main>
</div>

<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
  import {
    getFirestore, collection, getDocs, addDoc, deleteDoc, doc, updateDoc
  } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

  /* ✅ 換成你自己的（要跟 index/user 一樣） */
  const firebaseConfig = {
    apiKey: "YOUR_API_KEY",
    authDomain: "goldbricks-order.firebaseapp.com",
    projectId: "goldbricks-order",
    storageBucket: "goldbricks-order.appspot.com",
    messagingSenderId: "YOUR_SENDER_ID",
    appId: "YOUR_APP_ID"
  };

  const app = initializeApp(firebaseConfig);
  const db = getFirestore(app);

  const $ = (id)=>document.getElementById(id);
  const esc = (s)=>String(s??"").replace(/[&<>"']/g,m=>({ "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;" }[m]));
  const money = (n)=>(Number(n)||0).toLocaleString("zh-TW");

  function setHint(el, text, type=""){
    el.classList.remove("ok","warn","bad");
    if(type) el.classList.add(type);
    el.textContent = text || "";
  }

  // ========= 管理者密碼 =========
  (function guard(){
    const ok = sessionStorage.getItem("isAdmin") === "1";
    if(ok) return;
    const pin = prompt("輸入 8520 進入管理者後台");
    if(pin === "8520"){
      sessionStorage.setItem("isAdmin","1");
      return;
    }
    alert("管理者密碼錯誤");
    location.href = "index.html";
  })();

  // ========= Tabs =========
  document.querySelectorAll(".menu button[data-tab]").forEach(btn=>{
    btn.addEventListener("click", ()=>{
      document.querySelectorAll(".menu button").forEach(b=>b.classList.remove("active"));
      btn.classList.add("active");
      const tab = btn.dataset.tab;
      ["staff","restaurants","orders"].forEach(t=> $("tab-"+t).classList.toggle("hidden", t!==tab));
    });
  });

  $("btnGoUser").onclick=()=>location.href="user.html";

  // ========= Data Cache =========
  let staff = [];        // {id,dept,name}
  let restaurants = [];  // {id,name,url,img,menus,addons}
  let orders = [];       // {id,dept,name,staffKey,restaurantName,total,items,createdAt,note}

  // ========= 人員管理 =========
  async function loadStaff(){
    setHint($("topHint"), "載入人員中…");
    const snap = await getDocs(collection(db,"staff")); // 不用 orderBy，避免 index
    staff = snap.docs.map(d=>({ id:d.id, ...(d.data()||{}) }))
      .filter(x=>x.dept && x.name);

    // 前端排序
    staff.sort((a,b)=> String(a.dept).localeCompare(String(b.dept),"zh-Hant") || String(a.name).localeCompare(String(b.name),"zh-Hant"));

    renderStaff();
    setHint($("topHint"), "已載入", "ok");
  }

  function renderStaff(){
    const box = $("staffList");
    box.innerHTML = "";
    if(!staff.length){
      box.innerHTML = `<div class="hint warn">尚無人員</div>`;
      return;
    }

    const map = new Map();
    for(const s of staff){
      if(!map.has(s.dept)) map.set(s.dept, []);
      map.get(s.dept).push(s);
    }

    for(const [dept, people] of map.entries()){
      const group = document.createElement("div");
      group.className = "group";

      const head = document.createElement("div");
      head.className = "groupHead";
      head.innerHTML = `<b>${esc(dept)}</b><span class="tag">${people.length} 人</span>`;

      const body = document.createElement("div");
      body.className = "groupBody";

      head.addEventListener("click", ()=> body.classList.toggle("hidden"));

      for(const p of people){
        const row = document.createElement("div");
        row.className = "itemRow";
        row.innerHTML = `
          <div>
            <b>${esc(p.name)}</b>
            <div class="meta">部門：${esc(p.dept)}</div>
          </div>
          <div class="actions">
            <button class="btn danger">刪除</button>
          </div>
        `;
        row.querySelector("button").onclick = async ()=>{
          if(!confirm(`刪除人員：${p.dept} / ${p.name}？`)) return;
          await deleteDoc(doc(db,"staff",p.id));
          await loadAll();
        };
        body.appendChild(row);
      }

      group.appendChild(head);
      group.appendChild(body);
      box.appendChild(group);
    }
  }

  $("btnAddStaff").onclick = async ()=>{
    const dept = ($("staffDept").value||"").trim();
    const name = ($("staffName").value||"").trim();
    if(!dept || !name){
      setHint($("staffHint"), "請輸入部門與姓名", "warn");
      return;
    }
    await addDoc(collection(db,"staff"), { dept, name });
    $("staffName").value = "";
    setHint($("staffHint"), "✅ 已新增", "ok");
    await loadAll();
  };

  // ========= 餐廳管理 =========
  async function loadRestaurants(){
    const snap = await getDocs(collection(db,"restaurants"));
    restaurants = snap.docs.map(d=>{
      const v = d.data() || {};
      return {
        id:d.id,
        name:(v.name||"").trim(),
        url:(v.url||"").trim(),
        img:(v.img||"").trim(),
        menus:Array.isArray(v.menus)?v.menus:[],
        addons:Array.isArray(v.addons)?v.addons:[]
      };
    }).filter(r=>r.name);

    restaurants.sort((a,b)=>a.name.localeCompare(b.name,"zh-Hant"));

    // 填餐廳下拉（給新增餐點用）
    $("restSelectForMenu").innerHTML =
      `<option value="">請選餐廳</option>` +
      restaurants.map(r=>`<option value="${esc(r.id)}">${esc(r.name)}</option>`).join("");

    renderRestaurants();
  }

  function renderRestaurants(){
    const box = $("restaurantList");
    box.innerHTML = "";
    if(!restaurants.length){
      box.innerHTML = `<div class="hint warn">尚無餐廳</div>`;
      return;
    }

    restaurants.forEach(r=>{
      const group = document.createElement("div");
      group.className = "group";

      const head = document.createElement("div");
      head.className = "groupHead";
      head.innerHTML = `
        <div style="display:flex;flex-direction:column;gap:4px">
          <b>${esc(r.name)}</b>
          <span class="hint">${r.url ? "點此可開啟店家網址" : "（無店家網址）"}</span>
        </div>
        <div class="row">
          <span class="tag">${(r.menus||[]).length} 道餐點</span>
          <button class="btn danger" data-del>刪除</button>
        </div>
      `;

      // 點 head（非刪除）=> 收合
      const body = document.createElement("div");
      body.className = "groupBody hidden";

      head.addEventListener("click", (e)=>{
        if(e.target?.closest?.("[data-del]")) return;
        if(r.url) window.open(r.url, "_blank");
        body.classList.toggle("hidden");
      });

      head.querySelector("[data-del]").onclick = async (e)=>{
        e.stopPropagation();
        if(!confirm(`刪除餐廳：${r.name}（會連同餐點資料一起刪除該文件）？`)) return;
        await deleteDoc(doc(db,"restaurants",r.id));
        await loadAll();
      };

      // body：餐點清單（可刪）
      const menus = (r.menus||[]).map(m=>({
        id: m.id || m.itemId || crypto.randomUUID(),
        category: (m.category||m.type||"").trim(),
        name: (m.name||m.title||"").trim(),
        price: Number(m.price||0),
        defaultQty: Number(m.defaultQty||m.qty||0),
        addons: Array.isArray(m.addons)?m.addons:[]
      })).filter(m=>m.name);

      menus.sort((a,b)=> (a.category||"").localeCompare(b.category||"") || a.name.localeCompare(b.name,"zh-Hant"));

      if(!menus.length){
        const empty = document.createElement("div");
        empty.className = "hint warn";
        empty.textContent = "尚未設定餐點";
        body.appendChild(empty);
      }else{
        menus.forEach(m=>{
          const row = document.createElement("div");
          row.className = "itemRow";
          const addonText = (m.addons||[]).map(a=>{
            const n = (a?.name||a?.title||"").trim();
            const p = Number(a?.price||0);
            return n ? `${n}${p?`(+${p})`:"(免費)"}` : "";
          }).filter(Boolean).join("、");

          row.innerHTML = `
            <div>
              <b>${m.category ? `【${esc(m.category)}】 ` : ""}${esc(m.name)}</b>
              <div class="meta">價格：$ ${money(m.price)}｜預設數量：${Number.isFinite(m.defaultQty)?m.defaultQty:0}</div>
              ${addonText ? `<div class="meta">加購：${esc(addonText)}</div>` : `<div class="meta">加購：—</div>`}
            </div>
            <div class="actions">
              <button class="btn danger">刪除此餐點</button>
            </div>
          `;

          row.querySelector("button").onclick = async ()=>{
            if(!confirm(`刪除餐點：${m.name}（${r.name}）？`)) return;
            const newMenus = (r.menus||[]).filter(x => (x.id||x.itemId) !== (m.id));
            // 若原本沒 id，則用 name+price 做 fallback（避免刪不到）
            const fallback = (x)=> (String((x.name||x.title||"")).trim()===m.name && Number(x.price||0)===m.price);
            const filtered = newMenus.length !== (r.menus||[]).length ? newMenus : (r.menus||[]).filter(x=>!fallback(x));

            await updateDoc(doc(db,"restaurants",r.id), { menus: filtered });
            await loadAll();
          };

          body.appendChild(row);
        });
      }

      group.appendChild(head);
      group.appendChild(body);
      box.appendChild(group);
    });
  }

  $("btnAddRest").onclick = async ()=>{
    const name = ($("restName").value||"").trim();
    const url = ($("restUrl").value||"").trim();
    if(!name){
      setHint($("restHint"), "餐廳名稱必填", "warn");
      return;
    }
    await addDoc(collection(db,"restaurants"), { name, url, img:"", menus:[], addons:[] });
    $("restName").value = "";
    $("restUrl").value = "";
    setHint($("restHint"), "✅ 已新增", "ok");
    await loadAll();
  };

  // ========= 新增餐點：暫存加購 =========
  let tempAddons = [];
  function renderTempAddons(){
    const box = $("addonTempList");
    box.innerHTML = "";
    if(!tempAddons.length){
      setHint($("addonHint"), "尚未加入加購", "");
      return;
    }
    setHint($("addonHint"), `已加入 ${tempAddons.length} 筆加購`, "ok");

    tempAddons.forEach((a, idx)=>{
      const row = document.createElement("div");
      row.className = "itemRow";
      row.innerHTML = `
        <div>
          <b>${esc(a.name)}</b>
          <div class="meta">${a.price ? `+ $ ${money(a.price)}` : "免費"}</div>
        </div>
        <div class="actions">
          <button class="btn danger">移除</button>
        </div>
      `;
      row.querySelector("button").onclick = ()=>{
        tempAddons.splice(idx,1);
        renderTempAddons();
      };
      box.appendChild(row);
    });
  }

  $("btnAddAddon").onclick = ()=>{
    const name = ($("addonName").value||"").trim();
    const price = Number(($("addonPrice").value||"0").trim() || 0);
    if(!name) return setHint($("addonHint"), "請輸入加購名稱", "warn");
    tempAddons.push({ name, price: Math.max(0, price|0) });
    $("addonName").value = "";
    $("addonPrice").value = "";
    renderTempAddons();
  };

  $("restSelectForMenu").addEventListener("change", ()=>{
    const rid = $("restSelectForMenu").value;
    const r = restaurants.find(x=>x.id===rid);
    $("menuAddTag").textContent = r ? r.name : "尚未選餐廳";
  });

  $("btnAddMenu").onclick = async ()=>{
    const rid = $("restSelectForMenu").value;
    const r = restaurants.find(x=>x.id===rid);
    if(!r) return setHint($("menuHint"), "請先選餐廳", "warn");

    const category = ($("menuCategory").value||"").trim();
    const name = ($("menuName").value||"").trim();
    const price = Number(($("menuPrice").value||"0").trim() || 0);
    const defaultQty = Number(($("menuDefaultQty").value||"0").trim() || 0);

    if(!name) return setHint($("menuHint"), "餐點名稱必填", "warn");

    const newItem = {
      id: crypto.randomUUID(),
      category,
      name,
      price: Math.max(0, price|0),
      defaultQty: Math.max(0, defaultQty|0),
      addons: tempAddons.map(a=>({ name:a.name, price:a.price }))
    };

    const newMenus = Array.isArray(r.menus) ? [...r.menus, newItem] : [newItem];
    await updateDoc(doc(db,"restaurants",r.id), { menus: newMenus });

    // reset form
    $("menuCategory").value = "";
    $("menuName").value = "";
    $("menuPrice").value = "";
    $("menuDefaultQty").value = "";
    tempAddons = [];
    renderTempAddons();
    setHint($("menuHint"), "✅ 已新增餐點", "ok");

    await loadAll();
  };

  // ========= 訂單紀錄 =========
  async function loadOrders(){
    const snap = await getDocs(collection(db,"orders")); // 不用 where/orderBy，避免 index
    orders = snap.docs.map(d=>({ id:d.id, ...(d.data()||{}) }));

    // 前端排序：createdAt desc
    orders.sort((a,b)=> (b.createdAt?.seconds||0) - (a.createdAt?.seconds||0));

    buildOrderFilters();
    renderOrders();
  }

  function buildOrderFilters(){
    const depts = new Set();
    const names = new Set();
    const rests = new Set();

    orders.forEach(o=>{
      if(o.dept) depts.add(o.dept);
      if(o.name) names.add(o.name);
      if(o.restaurantName) rests.add(o.restaurantName);
    });

    const setOptions = (sel, items, label)=>{
      const cur = sel.value;
      sel.innerHTML = `<option value="">${label}</option>` + [...items].sort((a,b)=>String(a).localeCompare(String(b),"zh-Hant"))
        .map(x=>`<option value="${esc(x)}">${esc(x)}</option>`).join("");
      sel.value = cur && [...items].includes(cur) ? cur : "";
    };

    setOptions($("fDept"), depts, "全部部門");
    setOptions($("fName"), names, "全部姓名");
    setOptions($("fRest"), rests, "全部餐廳");
  }

  function getFilteredOrders(){
    const fd = $("fDept").value;
    const fn = $("fName").value;
    const fr = $("fRest").value;

    return orders.filter(o=>{
      if(fd && o.dept !== fd) return false;
      if(fn && o.name !== fn) return false;
      if(fr && o.restaurantName !== fr) return false;
      return true;
    });
  }

  function renderOrders(){
    const box = $("orderList");
    box.innerHTML = "";

    const list = getFilteredOrders();

    let sum = 0;
    list.forEach(o=> sum += Number(o.total||0));

    setHint($("orderHint"), `共 ${list.length} 筆｜合計 $ ${money(sum)}`, list.length? "ok":"warn");
    $("statPill").textContent = `訂單 ${list.length}｜$ ${money(sum)}`;

    if(!list.length){
      box.innerHTML = `<div class="hint warn">目前沒有訂單</div>`;
      return;
    }

    list.forEach(o=>{
      const items = Array.isArray(o.items) ? o.items : [];
      const itemsText = items.map(it=>{
        const addons = (it.addons||[]).map(a=>{
          const n = (a?.name||"").trim();
          const p = Number(a?.price||0);
          return n ? `${n}${p?`(+${p})`:"(免費)"}` : "";
        }).filter(Boolean).join("、");

        const qty = Number(it.qty||0);
        const price = Number(it.price||0);
        const addonsSum = (it.addons||[]).reduce((s,a)=>s+(Number(a?.price||0)),0);
        const lineTotal = (price + addonsSum) * qty;

        return `• ${esc(it.name||"")} x${qty} ｜單價$${money(price)}`
          + (addons ? ` ｜加購：${esc(addons)}` : ``)
          + ` ｜品項金額：$${money(lineTotal)}`;
      }).join("<br>");

      const createdText = o.createdAt?.seconds ? new Date(o.createdAt.seconds*1000).toLocaleString("zh-TW") : "";

      const row = document.createElement("div");
      row.className = "itemRow";
      row.innerHTML = `
        <div>
          <b>${esc(o.restaurantName||"（未知餐廳）")} <span class="tag">${esc(o.dept||"")}/${esc(o.name||"")}</span></b>
          <div class="meta">時間：${esc(createdText)}｜訂單總額：$ ${money(o.total||0)}</div>
          <div class="meta" style="margin-top:6px">${itemsText || "（無品項）"}</div>
          ${o.note ? `<div class="meta" style="margin-top:6px">整單備註：${esc(o.note)}</div>` : ``}
        </div>
        <div class="actions">
          <button class="btn danger">刪除</button>
        </div>
      `;

      row.querySelector("button").onclick = async ()=>{
        if(!confirm(`刪除這筆訂單？\n${o.dept||""}/${o.name||""} - ${o.restaurantName||""}`)) return;
        await deleteDoc(doc(db,"orders",o.id));
        await loadAll();
      };

      box.appendChild(row);
    });
  }

  $("fDept").onchange = renderOrders;
  $("fName").onchange = renderOrders;
  $("fRest").onchange = renderOrders;

  $("btnClearFilter").onclick = ()=>{
    $("fDept").value = "";
    $("fName").value = "";
    $("fRest").value = "";
    renderOrders();
  };

  $("btnReloadOrders").onclick = async ()=>{ await loadOrders(); };

  // ========= 匯出 Excel（CSV，Excel 可開） =========
  $("btnExportExcel").onclick = ()=>{
    const list = getFilteredOrders();

    // 表頭
    const rows = [[
      "部門","姓名","餐廳","品項","加購","數量","單價","加購金額","品項金額","訂單總額","下單時間","整單備註"
    ]];

    list.forEach(o=>{
      const createdText = o.createdAt?.seconds ? new Date(o.createdAt.seconds*1000).toLocaleString("zh-TW") : "";
      const items = Array.isArray(o.items) ? o.items : [];

      if(!items.length){
        rows.push([
          o.dept||"", o.name||"", o.restaurantName||"",
          "", "", "", "", "", "",
          o.total||0, createdText, o.note||""
        ]);
        return;
      }

      items.forEach(it=>{
        const qty = Number(it.qty||0);
        const price = Number(it.price||0);

        const addonsArr = (it.addons||[]).map(a=>{
          const n = (a?.name||"").trim();
          const p = Number(a?.price||0);
          return n ? `${n}${p?`(+${p})`:"(免費)"}` : "";
        }).filter(Boolean);

        const addonsText = addonsArr.join("、");
        const addonsSum = (it.addons||[]).reduce((s,a)=>s+(Number(a?.price||0)),0);
        const lineTotal = (price + addonsSum) * qty;

        rows.push([
          o.dept||"", o.name||"", o.restaurantName||"",
          it.name||"", addonsText,
          qty, price, addonsSum, lineTotal,
          Number(o.total||0), createdText, o.note||""
        ]);
      });
    });

    // 轉 CSV（含 BOM，避免 Excel 亂碼）
    const csv = "\uFEFF" + rows.map(r=>r.map(v=>{
      const s = String(v ?? "");
      // 逗號/換行/引號 → 用引號包起來，內部引號雙寫
      return /[,"\n]/.test(s) ? `"${s.replace(/"/g,'""')}"` : s;
    }).join(",")).join("\n");

    const a = document.createElement("a");
    a.href = URL.createObjectURL(new Blob([csv], { type:"text/csv;charset=utf-8" }));
    a.download = `orders_${new Date().toISOString().slice(0,10)}.csv`;
    a.click();
  };

  // ========= Reload =========
  $("btnReloadAll").onclick = async ()=>{ await loadAll(); };

  async function loadAll(){
    try{
      setHint($("topHint"), "載入資料中…");
      await loadStaff();
      await loadRestaurants();
      await loadOrders();
      setHint($("topHint"), "✅ 已更新", "ok");
    }catch(err){
      console.error(err);
      setHint($("topHint"), "讀取失敗：" + String(err?.message||err), "bad");
    }
  }

  // init
  renderTempAddons();
  loadAll();

</script>
</body>
</html>
