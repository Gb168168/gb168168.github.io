<!doctype html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>點餐系統｜管理者</title>
  <style>
    :root{
      --bg:#f6f7fb; --card:#ffffff; --text:#0f172a; --muted:#64748b;
      --primary:#fb7185; --primary2:#f97316; --line:rgba(15,23,42,.10);
      --shadow:0 14px 35px rgba(15,23,42,.10);
      --r:18px;
    }
    *{box-sizing:border-box}
    body{margin:0;font-family:ui-sans-serif,system-ui,-apple-system,"Segoe UI",Roboto,"Noto Sans TC";background:var(--bg);color:var(--text)}
    .app{display:grid;grid-template-columns:280px 1fr;min-height:100vh}
    .side{
      background:linear-gradient(180deg,rgba(15,23,42,.05),rgba(251,113,133,.10));
      border-right:1px solid var(--line); padding:18px; position:sticky; top:0; height:100vh
    }
    .brand{display:flex;gap:10px;align-items:center;margin-bottom:14px}
    .dot{width:10px;height:10px;border-radius:999px;background:linear-gradient(90deg,var(--primary),var(--primary2))}
    .brand h1{font-size:16px;margin:0}
    .pill{display:inline-flex;gap:8px;align-items:center;padding:8px 10px;border:1px solid var(--line);border-radius:999px;background:#fff;font-size:12px;color:var(--muted)}
    .nav{margin-top:12px;display:grid;gap:8px}
    .nav button{
      width:100%;text-align:left;padding:12px;border-radius:14px;border:1px solid var(--line);background:#fff;
      cursor:pointer;font-weight:900
    }
    .nav button.active{border-color:rgba(251,113,133,.55);background:rgba(251,113,133,.10);color:#be123c}
    .muted{color:var(--muted);font-size:12px;line-height:1.6}
    .main{padding:18px;display:grid;gap:14px}
    .topbar{display:flex;gap:10px;align-items:center;justify-content:space-between}
    .title{display:grid;gap:4px}
    .title h2{margin:0;font-size:18px}
    .title .sub{color:var(--muted);font-size:12px}
    .card{
      background:var(--card);border:1px solid var(--line);border-radius:24px;box-shadow:var(--shadow);
      overflow:hidden
    }
    .cardHead{padding:14px 16px;border-bottom:1px solid var(--line);background:linear-gradient(90deg,rgba(251,113,133,.10),rgba(249,115,22,.06))}
    .cardHead b{font-size:14px}
    .cardBody{padding:14px 16px;display:grid;gap:12px}
    label{font-size:12px;color:var(--muted)}
    input,select,textarea{
      width:100%;padding:10px 12px;border-radius:14px;border:1px solid var(--line);outline:none;background:#fff;font-size:14px
    }
    input:focus,select:focus,textarea:focus{border-color:rgba(251,113,133,.55);box-shadow:0 0 0 4px rgba(251,113,133,.14)}
    .btn{
      padding:10px 12px;border-radius:14px;border:0;cursor:pointer;font-weight:900;color:#fff;
      background:linear-gradient(90deg,var(--primary),var(--primary2));
      box-shadow:0 12px 26px rgba(251,113,133,.22);
    }
    .btn2{padding:10px 12px;border-radius:14px;border:1px solid var(--line);background:#fff;cursor:pointer;font-weight:900}
    .row2{display:grid;grid-template-columns:1fr 1fr;gap:10px}
    .list{display:grid;gap:10px}
    .item{border:1px solid var(--line);border-radius:18px;background:#fff;padding:12px}
    .itemTop{display:flex;justify-content:space-between;gap:10px;align-items:flex-start}
    .itemTop b{font-size:14px}
    .tag{font-size:12px;color:var(--muted)}
    .mini{display:flex;gap:8px;flex-wrap:wrap;margin-top:8px}
    .chip{font-size:12px;padding:6px 10px;border-radius:999px;border:1px solid var(--line);background:rgba(15,23,42,.02)}
    .danger{border:1px solid rgba(185,28,28,.22);background:rgba(185,28,28,.06);color:#b91c1c}
    .ok{border:1px solid rgba(22,163,74,.22);background:rgba(22,163,74,.06);color:#166534}
    .tab-page{display:none}
    .tab-page.active{display:block}
    details{border:1px solid var(--line);border-radius:18px;background:#fff;padding:10px 12px}
    summary{cursor:pointer;font-weight:900}
    @media (max-width: 980px){
      .app{grid-template-columns:1fr}
      .side{position:relative;height:auto}
    }
  </style>
</head>
<body>
  <div class="app">
    <aside class="side">
      <div class="brand">
        <span class="dot"></span>
        <h1>點餐系統（管理者）</h1>
      </div>
      <div class="pill">管理者模式（目前 Rules：A 只讀）</div>

      <div class="nav">
        <button class="tab-btn active" data-tab="staff" type="button">人員管理</button>
        <button class="tab-btn" data-tab="restaurant" type="button">餐廳管理</button>
        <button class="tab-btn" data-tab="orders" type="button">歷史訂單</button>
        <button id="goUser" type="button">切到使用者</button>
        <button id="goIndex" type="button">回登入</button>
      </div>

      <div style="margin-top:12px" class="muted">
        ✅ 左側可切換功能。<br/>
        ⚠️ 目前 Firestore 規則為 A（read only），新增/刪除會被擋是正常。
      </div>
    </aside>

    <main class="main">
      <div class="topbar">
        <div class="title">
          <h2 id="pageTitle">人員管理</h2>
          <div class="sub" id="pageSub">新增/瀏覽人員，依部門收合</div>
        </div>
        <div style="display:flex;gap:10px">
          <button class="btn2" id="refreshBtn" type="button">重新整理</button>
        </div>
      </div>

      <!-- 人員管理 -->
      <section id="tab-staff" class="tab-page active">
        <div class="card">
          <div class="cardHead"><b>新增人員（單行）</b></div>
          <div class="cardBody">
            <div class="row2">
              <div>
                <label>部門</label>
                <input id="staffDept" placeholder="例：行銷部" />
              </div>
              <div>
                <label>姓名</label>
                <input id="staffName" placeholder="例：小美（按 Enter 新增）" />
              </div>
            </div>
            <div style="display:flex;gap:10px;align-items:center">
              <button class="btn" id="addStaffBtn" type="button">新增</button>
              <div class="muted" id="staffMsg"></div>
            </div>

            <div class="card" style="box-shadow:none">
              <div class="cardHead"><b>人員列表（依部門收合）</b></div>
              <div class="cardBody" id="staffList"></div>
            </div>
          </div>
        </div>
      </section>

      <!-- 餐廳管理 -->
      <section id="tab-restaurant" class="tab-page">
        <div class="card">
          <div class="cardHead"><b>餐廳管理</b></div>
          <div class="cardBody">
            <div class="row2">
              <div>
                <label>餐廳名稱</label>
                <input id="restName" placeholder="例：阿婆麵店" autocomplete="off"/>
              </div>
              <div>
                <label>餐廳圖片（Storage，上傳在 A 規則會被擋）</label>
                <input id="restImg" type="file" accept="image/*" />
              </div>
            </div>
            <div style="display:flex;gap:10px;align-items:center">
              <button class="btn" id="addRestBtn" type="button">新增餐廳</button>
              <div class="muted" id="restMsg"></div>
            </div>

            <div class="card" style="box-shadow:none">
              <div class="cardHead"><b>餐廳列表（點擊進入餐點管理）</b></div>
              <div class="cardBody">
                <div id="restList" class="list"></div>
              </div>
            </div>

            <div class="card" style="box-shadow:none" id="menuPanel" hidden>
              <div class="cardHead"><b id="menuTitle">餐點管理</b></div>
              <div class="cardBody">
                <div class="row2">
                  <div>
                    <label>餐點名稱</label>
                    <input id="menuName" placeholder="例：牛肉麵" />
                  </div>
                  <div>
                    <label>預設數量（取代圖片管理）</label>
                    <input id="menuDefaultQty" type="number" min="1" value="1" />
                  </div>
                </div>
                <div class="row2">
                  <div>
                    <label>價格（可空）</label>
                    <input id="menuPrice" type="number" min="0" placeholder="例：120" />
                  </div>
                  <div style="display:flex;gap:10px;align-items:flex-end">
                    <button class="btn" id="addMenuBtn" type="button">新增餐點</button>
                    <button class="btn2" id="closeMenuBtn" type="button">關閉</button>
                  </div>
                </div>

                <div class="card" style="box-shadow:none">
                  <div class="cardHead"><b>餐點列表</b></div>
                  <div class="cardBody">
                    <div id="menuList" class="list"></div>
                  </div>
                </div>

              </div>
            </div>

          </div>
        </div>
      </section>

      <!-- 歷史訂單 -->
      <section id="tab-orders" class="tab-page">
        <div class="card">
          <div class="cardHead"><b>歷史訂單（全部）</b></div>
          <div class="cardBody">
            <div class="muted">最新在上。A 規則下只能讀取，刪除會失敗是正常。</div>
            <div id="orderList" class="list"></div>
          </div>
        </div>
      </section>

    </main>
  </div>

  <!-- Firebase compat（不要用 import） -->
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-storage-compat.js"></script>

  <script>
  /* =========================
     Firebase 初始化（GitHub Pages：compat）
     ========================= */
  const firebaseConfig = {
    apiKey: "AIzaSyBdgOddTGAfqqHLnhnaJRv2_y7gyweuQEo",
    authDomain: "goldbricks-order.firebaseapp.com",
    projectId: "goldbricks-order",
    storageBucket: "goldbricks-order.firebasestorage.app",
    messagingSenderId: "463709758954",
    appId: "1:463709758954:web:429dc920f2f812d51cbe93"
  };

  if (!firebase.apps.length) firebase.initializeApp(firebaseConfig);
  const db = firebase.firestore();
  const storage = firebase.storage();

  console.log("✅ Firebase initialized:", firebaseConfig.projectId);

  const $ = (id)=>document.getElementById(id);
  const tabButtons = document.querySelectorAll('.tab-btn');
  const tabPages = document.querySelectorAll('.tab-page');

  function escapeHtml(s){
    return String(s??'').replace(/[&<>"']/g, c=>({ "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;" }[c]));
  }
  function formatTs(ts){
    try{
      if(!ts) return '-';
      const d = ts.toDate ? ts.toDate() : new Date(ts);
      const y=d.getFullYear(), m=String(d.getMonth()+1).padStart(2,'0'), da=String(d.getDate()).padStart(2,'0');
      const hh=String(d.getHours()).padStart(2,'0'), mm=String(d.getMinutes()).padStart(2,'0');
      return `${y}-${m}-${da} ${hh}:${mm}`;
    }catch{return '-'}
  }
  function safeFileName(name){ return String(name||'file').replace(/[^a-zA-Z0-9._-]/g,'_'); }

  /* =========================
     Tab 切換（真的切）
     ========================= */
  function setTab(tab){
    tabPages.forEach(p => p.classList.toggle('active', p.id === `tab-${tab}`));
    tabButtons.forEach(b => b.classList.toggle('active', b.dataset.tab === tab));

    $('pageTitle').textContent =
      tab==='staff' ? '人員管理' : tab==='restaurant' ? '餐廳管理' : '歷史訂單';
    $('pageSub').textContent =
      tab==='staff' ? '新增/瀏覽人員，依部門收合' :
      tab==='restaurant' ? '新增餐廳、管理餐點（預設數量取代圖片）' :
      '查看所有訂單';

    // 進入某頁才載入（更穩）
    if(tab==='staff') loadStaff();
    if(tab==='restaurant') loadRestaurants();
    if(tab==='orders') loadOrders();
  }
  tabButtons.forEach(btn => btn.addEventListener('click', ()=>setTab(btn.dataset.tab)));

  $('goUser').onclick = ()=>location.href='user.html';
  $('goIndex').onclick = ()=>location.href='index.html';
  $('refreshBtn').onclick = ()=>location.reload();

  /* =========================
     人員管理（staff）
     ========================= */
  async function addStaff(){
    const dept = ($('staffDept').value||'').trim();
    const name = ($('staffName').value||'').trim();
    if(!dept || !name){ $('staffMsg').textContent='請輸入部門與姓名'; return; }

    $('addStaffBtn').disabled = true;
    $('staffMsg').textContent = '新增中…（A 規則可能會擋）';

    try{
      await db.collection('staff').add({
        dept, name,
        createdAt: firebase.firestore.FieldValue.serverTimestamp()
      });
      $('staffName').value='';
      $('staffMsg').textContent = '✅ 已新增';
      loadStaff();
    }catch(e){
      console.error(e);
      $('staffMsg').textContent = '❌ 新增失敗（目前 A 規則只讀，這是正常）';
    }finally{
      $('addStaffBtn').disabled = false;
    }
  }
  $('addStaffBtn').onclick = addStaff;
  $('staffName').addEventListener('keydown',(e)=>{ if(e.key==='Enter') addStaff(); });

  async function loadStaff(){
    const wrap = $('staffList');
    wrap.innerHTML = '載入中…';
    try{
      const snap = await db.collection('staff').orderBy('dept').orderBy('name').get();
      const groups = {};
      snap.forEach(d=>{
        const s=d.data();
        if(!s.dept || !s.name) return;
        (groups[s.dept] ||= []).push({ id:d.id, name:s.name });
      });

      const depts = Object.keys(groups).sort((a,b)=>a.localeCompare(b,'zh-Hant'));
      wrap.innerHTML='';
      if(!depts.length){
        wrap.innerHTML = `<div class="item">尚無人員</div>`;
        return;
      }

      depts.forEach(dept=>{
        const det = document.createElement('details');
        det.open = true;
        const list = groups[dept].sort((a,b)=>a.name.localeCompare(b.name,'zh-Hant'));
        det.innerHTML = `
          <summary>${escapeHtml(dept)} <span class="chip">${list.length} 人</span></summary>
          <div style="margin-top:10px" class="list"></div>
        `;
        const box = det.querySelector('.list');
        list.forEach(p=>{
          const div = document.createElement('div');
          div.className='item';
          div.innerHTML = `
            <div class="itemTop">
              <div><b>${escapeHtml(p.name)}</b><div class="tag">${escapeHtml(dept)}</div></div>
              <button class="btn2 danger" type="button">刪除</button>
            </div>
          `;
          div.querySelector('button').onclick = async ()=>{
            if(!confirm(`刪除 ${dept} - ${p.name}？`)) return;
            try{
              await db.collection('staff').doc(p.id).delete();
              loadStaff();
            }catch(e){
              alert('刪除失敗（A 規則只讀，正常）');
            }
          };
          box.appendChild(div);
        });
        wrap.appendChild(det);
      });
    }catch(e){
      console.error(e);
      wrap.innerHTML = `<div class="item danger">讀取失敗（檢查網路/專案）</div>`;
    }
  }

  /* =========================
     餐廳/餐點（restaurants / menus）
     ========================= */
  const state = { activeRestaurant:null, restaurants:[] };

  $('addRestBtn').onclick = async ()=>{
    const name = ($('restName').value||'').trim();
    const file = $('restImg').files?.[0] || null;
    if(!name){ $('restMsg').textContent='請輸入餐廳名稱'; return; }

    $('addRestBtn').disabled = true;
    $('restMsg').textContent = '新增中…（A 規則會擋）';

    try{
      let imageUrl = '';
      if(file){
        const path = `restaurants/${Date.now()}_${safeFileName(file.name)}`;
        const ref = storage.ref().child(path);
        await ref.put(file);                  // A 規則/Storage 規則若鎖會失敗（正常）
        imageUrl = await ref.getDownloadURL();
      }

      await db.collection('restaurants').add({
        name, imageUrl,
        createdAt: firebase.firestore.FieldValue.serverTimestamp()
      });

      $('restName').value='';
      $('restImg').value='';
      $('restMsg').textContent='✅ 已新增';
      loadRestaurants();
    }catch(e){
      console.error(e);
      $('restMsg').textContent='❌ 新增失敗（A 規則只讀，正常）';
    }finally{
      $('addRestBtn').disabled = false;
    }
  };

  async function loadRestaurants(){
    const list = $('restList');
    list.innerHTML='載入中…';
    $('menuPanel').hidden = true;
    state.activeRestaurant = null;

    try{
      const snap = await db.collection('restaurants').orderBy('createdAt','desc').get();
      state.restaurants = [];
      snap.forEach(d=>{
        const r=d.data();
        state.restaurants.push({ id:d.id, name:r.name||'(未命名)', imageUrl:r.imageUrl||'' });
      });

      list.innerHTML='';
      if(!state.restaurants.length){
        list.innerHTML = `<div class="item">尚無餐廳</div>`;
        return;
      }

      state.restaurants.forEach(r=>{
        const div=document.createElement('div');
        div.className='item';
        div.innerHTML = `
          <div class="itemTop">
            <div>
              <b>${escapeHtml(r.name)}</b>
              <div class="tag">${r.imageUrl ? '有圖片' : '無圖片'} ・ 點擊進入餐點管理</div>
            </div>
            <div style="display:flex;gap:8px">
              <button class="btn2" type="button">管理餐點</button>
              <button class="btn2 danger" type="button">刪除</button>
            </div>
          </div>
        `;
        const [btnManage, btnDel] = div.querySelectorAll('button');
        btnManage.onclick=()=>openMenuPanel(r);
        btnDel.onclick=async ()=>{
          if(!confirm(`刪除餐廳「${r.name}」？`)) return;
          try{
            await db.collection('restaurants').doc(r.id).delete();
            loadRestaurants();
          }catch(e){
            alert('刪除失敗（A 規則只讀，正常）');
          }
        };
        div.onclick=(e)=>{
          if(e.target.tagName==='BUTTON') return;
          openMenuPanel(r);
        };
        list.appendChild(div);
      });
    }catch(e){
      console.error(e);
      list.innerHTML = `<div class="item danger">讀取失敗</div>`;
    }
  }

  function openMenuPanel(r){
    state.activeRestaurant = r;
    $('menuPanel').hidden = false;
    $('menuTitle').textContent = `餐點管理｜${r.name}`;
    $('menuName').value='';
    $('menuDefaultQty').value=1;
    $('menuPrice').value='';
    loadMenus(r.id);
  }
  $('closeMenuBtn').onclick=()=>{
    $('menuPanel').hidden = true;
    state.activeRestaurant = null;
  };

  $('addMenuBtn').onclick = async ()=>{
    const r = state.activeRestaurant;
    if(!r) return;
    const name = ($('menuName').value||'').trim();
    const defaultQty = Number($('menuDefaultQty').value||1);
    const priceRaw = ($('menuPrice').value||'').trim();
    const price = priceRaw==='' ? null : Number(priceRaw);

    if(!name){ alert('請輸入餐點名稱'); return; }

    $('addMenuBtn').disabled = true;
    try{
      await db.collection('menus').add({
        restaurantId: r.id,
        name,
        defaultQty: isFinite(defaultQty) && defaultQty>0 ? defaultQty : 1,
        price: (price==null || !isFinite(price)) ? null : price,
        createdAt: firebase.firestore.FieldValue.serverTimestamp()
      });
      $('menuName').value='';
      $('menuDefaultQty').value=1;
      $('menuPrice').value='';
      loadMenus(r.id);
    }catch(e){
      console.error(e);
      alert('新增餐點失敗（A 規則只讀，正常）');
    }finally{
      $('addMenuBtn').disabled = false;
    }
  };

  async function loadMenus(restaurantId){
    const list = $('menuList');
    list.innerHTML='載入中…';
    try{
      const snap = await db.collection('menus')
        .where('restaurantId','==',restaurantId)
        .orderBy('createdAt','desc')
        .get();

      list.innerHTML='';
      if(snap.empty){
        list.innerHTML = `<div class="item">尚無餐點</div>`;
        return;
      }

      snap.forEach(d=>{
        const m=d.data();
        const div=document.createElement('div');
        div.className='item';
        div.innerHTML = `
          <div class="itemTop">
            <div>
              <b>${escapeHtml(m.name||'')}</b>
              <div class="tag">預設數量：${escapeHtml(m.defaultQty??'-')} ${m.price!=null?`・價格：$${m.price}`:''}</div>
            </div>
            <button class="btn2 danger" type="button">刪除</button>
          </div>
        `;
        div.querySelector('button').onclick=async ()=>{
          if(!confirm(`刪除餐點「${m.name}」？`)) return;
          try{
            await db.collection('menus').doc(d.id).delete();
            loadMenus(restaurantId);
          }catch(e){
            alert('刪除失敗（A 規則只讀，正常）');
          }
        };
        list.appendChild(div);
      });
    }catch(e){
      console.error(e);
      list.innerHTML = `<div class="item danger">讀取餐點失敗</div>`;
    }
  }

  /* =========================
     歷史訂單（orders）
     ========================= */
  async function loadOrders(){
    const list = $('orderList');
    list.innerHTML='載入中…';
    try{
      const snap = await db.collection('orders').orderBy('createdAt','desc').limit(60).get();
      list.innerHTML='';
      if(snap.empty){
        list.innerHTML = `<div class="item">尚無訂單</div>`;
        return;
      }
      snap.forEach(d=>{
        const o=d.data();
        const div=document.createElement('div');
        div.className='item';
        const items=(o.items||[]).map(i=>`<div class="chip">${escapeHtml(i.menuName)} × ${Number(i.qty||1)}${i.note?`（${escapeHtml(i.note)}）`:''}</div>`).join('');
        div.innerHTML = `
          <div class="itemTop">
            <div>
              <b>${escapeHtml(o.restaurantName||'')}</b>
              <div class="tag">${formatTs(o.createdAt)} ・ ${escapeHtml(o.dept||'')}｜${escapeHtml(o.name||'')}</div>
            </div>
            <button class="btn2 danger" type="button">刪除</button>
          </div>
          <div class="mini">${items}</div>
        `;
        div.querySelector('button').onclick=async ()=>{
          if(!confirm('確定刪除此訂單？')) return;
          try{
            await db.collection('orders').doc(d.id).delete();
            loadOrders();
          }catch(e){
            alert('刪除失敗（A 規則只讀，正常）');
          }
        };
        list.appendChild(div);
      });
    }catch(e){
      console.error(e);
      list.innerHTML = `<div class="item danger">讀取失敗</div>`;
    }
  }

  /* =========================
     啟動：預設 staff
     ========================= */
  setTab('staff');
  </script>
</body>
</html>
