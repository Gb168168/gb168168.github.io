<!doctype html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>GoldBricks å‘·å¥”ğŸ‘½~ï½œç®¡ç†è€…</title>

  <!-- âœ… Excelï¼ˆSheetJSï¼‰ -->
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.19.3/dist/xlsx.full.min.js"></script>

  <style>
    :root{
      /* âœ… åˆ†å±¤æ›´æ¸…æ¥šï¼šèƒŒæ™¯ / å´æ¬„ / å¡ç‰‡ / æ¸…å–® */
      --bg-main:#eef1f7;
      --bg-panel:#f6f7fb;

      --card-main:#ffffff;
      --card-sub:#fafbff;

      --text:#0b1220;
      --muted:#516074;

      --accent:#fb7185;
      --accent2:#ff9a9e;
      --accent-soft:rgba(251,113,133,.12);

      --border-soft:rgba(15,23,42,.10);
      --border-strong:rgba(15,23,42,.18);

      --shadow:0 12px 34px rgba(2,6,23,.10);
      --shadow2:0 10px 26px rgba(2,6,23,.08);
      --radius:18px;

      --ok:#22c55e;
      --warn:#f59e0b;
      --danger:#ef4444;

      --focus:rgba(251,113,133,.65);
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      font-family: ui-sans-serif, system-ui, -apple-system, "Segoe UI", Arial;
      background:
        radial-gradient(1200px 520px at 18% -12%, rgba(251,113,133,.14), transparent 60%),
        radial-gradient(900px 520px at 110% 0%, rgba(99,102,241,.10), transparent 55%),
        linear-gradient(180deg, var(--bg-panel) 0%, var(--bg-main) 60%, var(--bg-main) 100%);
      color:var(--text);
      min-height:100vh;
    }
    .wrap{max-width:1300px; margin:0 auto; padding:16px;}

    /* âœ… sticky topbar */
    .topbar{
      position: sticky;
      top: 0;
      z-index: 1000;
      background: rgba(255,255,255,.90);
      border:1px solid var(--border-soft);
      border-radius: var(--radius);
      box-shadow: 0 6px 20px rgba(15,23,42,.12);
      backdrop-filter: blur(12px);
      padding:12px 14px;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:12px;
    }
    .topbar h1{font-size:18px; margin:0}
    .topbar .right{display:flex; gap:10px; align-items:center; flex-wrap:wrap}

    .pill{
      padding:8px 12px;
      border-radius:999px;
      border:1px solid var(--border-strong);
      background:#fff;
      color:var(--muted);
      font-size:12.5px
    }
    .btn{
      padding:9px 12px;
      border-radius:14px;
      border:1px solid var(--border-strong);
      background:#fff;
      cursor:pointer;
      font-weight:900;
    }
    .btn:hover{filter:brightness(.98)}
    .primary{
      padding:9px 12px;
      border-radius:14px;
      border:none;
      cursor:pointer;
      font-weight:900;
      background: linear-gradient(90deg, var(--accent), var(--accent2));
      color:#fff;
      box-shadow: 0 14px 28px rgba(251,113,133,.20);
    }
    .primary:hover{filter:saturate(1.04)}
    .btn:disabled,.primary:disabled{opacity:.55; cursor:not-allowed}
    .danger{border-color: rgba(239,68,68,.42)}

    .grid{display:grid; grid-template-columns: 280px 1fr; gap:14px; margin-top:14px}
    @media (max-width:980px){.grid{grid-template-columns:1fr}}

    .navCard{
      background: var(--bg-panel);
      border:1px solid var(--border-soft);
      border-radius:var(--radius);
      box-shadow: var(--shadow2);
      padding:14px;
    }
    .navBtn{
      width:100%;
      text-align:left;
      padding:10px 12px;
      border-radius:14px;
      border:1px solid var(--border-strong);
      background:#fff;
      cursor:pointer;
      font-weight:900;
    }
    .navBtn.active{
      border-color: rgba(251,113,133,.70);
      background: var(--accent-soft);
      box-shadow:0 10px 22px rgba(251,113,133,.14);
    }

    .card{
      background:var(--card-main);
      border:1px solid var(--border-soft);
      border-radius:var(--radius);
      box-shadow: var(--shadow2);
      padding:14px;
    }
    .cardSub{
      background:var(--card-sub);
      border:1px solid var(--border-soft);
      border-radius:var(--radius);
      padding:12px;
    }
    .card h2{margin:0 0 10px; font-size:15px}

    label{display:block; font-size:13px; color:var(--muted); margin:10px 0 6px;}
    input,select,textarea{
      width:100%;
      padding:11px 12px;
      border-radius:14px;
      border:1px solid var(--border-strong);
      outline:none;
      background:#fff;
      font-size:14px;
    }
    textarea{min-height:92px; resize:vertical}
    input:focus,select:focus,textarea:focus{
      border-color: var(--focus);
      box-shadow:0 0 0 4px rgba(251,113,133,.10)
    }

    .row{display:grid; grid-template-columns: 1fr 1fr; gap:10px}
    .muted{color:var(--muted); font-size:12.5px; line-height:1.6}
    .hr{height:1px; background: var(--border-soft); margin:12px 0}
    .tag{
      display:inline-flex;
      padding:5px 10px;
      border-radius:999px;
      border:1px solid var(--border-strong);
      background:#fff;
      color:var(--muted);
      font-size:12px
    }
    .inline{display:flex; gap:10px; align-items:center; flex-wrap:wrap}

    .section{display:none;}
    .section.active{display:block;}

    .box{
      border:1px solid var(--border-soft);
      border-radius:16px;
      padding:12px;
      background:#fff;
      margin-top:10px;
    }
    .miniRow{display:grid; grid-template-columns: 1.1fr .7fr .6fr; gap:10px}
    @media (max-width:980px){.miniRow{grid-template-columns:1fr}}

    table{width:100%; border-collapse:collapse; font-size:13.5px}
    th,td{border-bottom:1px solid rgba(15,23,42,.08); padding:10px 8px; text-align:left; vertical-align:top}
    th{color:var(--muted); font-weight:900}

    .listLine{
      border:1px solid var(--border-soft);
      border-radius:14px;
      padding:10px 12px;
      background:#fff;
      margin-top:10px;
    }
    details > summary{
      cursor:pointer;
      list-style:none;
      user-select:none;
    }
    details > summary::-webkit-details-marker{display:none}

    /* âœ… æ‹–æ›³æ¸…å–®ï¼ˆä¸é¡¯ç¤ºé †åºè™Ÿç¢¼ï¼‰ */
    .draggableItem{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      padding:10px 12px;
      border-radius:14px;
      border:1px solid var(--border-soft);
      background:#fff;
      margin-top:10px;
    }
    .draggableItem:hover{
      border-color: rgba(251,113,133,.35);
      box-shadow: 0 10px 22px rgba(251,113,133,.10);
    }
    .dragHandle{
      cursor: grab;
      opacity:.55;
      user-select:none;
      font-weight:900;
      padding:6px 10px;
      border-radius:12px;
      border:1px solid var(--border-soft);
      background: var(--card-sub);
    }
    .draggableItem:hover .dragHandle{opacity:1}
    .dragging{
      opacity:.55;
      transform: scale(.995);
    }
    .dragOver{
      background: var(--accent-soft) !important;
      border-color: var(--accent) !important;
    }
  </style>
</head>

<body>
  <div class="wrap">
    <div class="topbar">
      <div>
        <h1>ç®¡ç†è€…å¾Œå°</h1>
        <div class="muted" id="whoLine">å°šæœªé¸æ“‡é¤å»³</div>
      </div>
      <div class="right">
        <span class="pill" id="statusPill">é€£ç·šä¸­â€¦</span>
        <button class="btn" id="btnGoUser">å›ä½¿ç”¨è€…</button>
        <button class="btn" id="btnLogout">ç™»å‡º</button>
      </div>
    </div>

    <div class="grid">
      <!-- LEFT NAV -->
      <div class="navCard">
        <div class="inline" style="justify-content:space-between">
          <b>åŠŸèƒ½</b>
          <span class="tag">Admin</span>
        </div>
        <div class="hr"></div>
        <button class="navBtn active" data-tab="tabRestaurants">é»é¤ç®¡ç†</button>
        <button class="navBtn" data-tab="tabStaff">äººå“¡ç®¡ç†</button>
        <button class="navBtn" data-tab="tabOrders">æ­·å²ç´€éŒ„ / åŒ¯å‡º</button>
        <div class="hr"></div>
        <div class="muted">
          æç¤ºï¼šè‹¥è®€å–å¤±æ•—ï¼Œå¤šåŠæ˜¯ Rules / ç¶²è·¯ / Firebase è¨­å®šã€‚
        </div>
      </div>

      <!-- RIGHT CONTENT -->
      <div>

        <!-- TAB: RESTAURANTS / MENU -->
        <div class="section active" id="tabRestaurants">

          <div class="card">
            <h2>1ï¼‰é¤å»³æ¸…å–®ï¼ˆæ‹–æ›³æ’åºï¼‹è‡ªå‹•å„²å­˜ï¼‰</h2>

            <!-- âœ… å¯æ‹–æ›³é¤å»³åˆ—è¡¨ï¼ˆå–ä»£ã€Œä¸‹æ‹‰ç„¡æ³•æ‹–æ›³ã€çš„å•é¡Œï¼‰ -->
            <div class="cardSub">
              <div class="inline" style="justify-content:space-between">
                <b>åº—å®¶åˆ—è¡¨ï¼ˆæ‹–æ›³å¯æ’åºï¼‰</b>
                <button class="btn" id="btnReloadRestaurants">é‡æ–°è¼‰å…¥</button>
              </div>
              <div class="muted" style="margin-top:6px">æ‹–æ›³æ”¾é–‹æœƒè‡ªå‹•å„²å­˜é †åºï¼ˆä¸é¡¯ç¤ºé †åºè™Ÿç¢¼ï¼‰ã€‚</div>
              <div id="restaurantDnDList" class="muted" style="margin-top:10px">è¼‰å…¥ä¸­â€¦</div>
            </div>

            <div class="hr"></div>

            <!-- ä¿ç•™ï¼šä¸‹æ‹‰é¸é¤å»³ï¼ˆæ–¹ä¾¿å¿«é€Ÿè·³ï¼‰ -->
            <div class="row">
              <div>
                <label>å¿«é€Ÿé¸æ“‡é¤å»³ï¼ˆä¸‹æ‹‰ï¼‰</label>
                <select id="restaurantSelect">
                  <option value="">è¼‰å…¥ä¸­â€¦</option>
                </select>
              </div>
              <div class="inline" style="align-self:end; justify-content:flex-end">
                <button class="btn danger" id="btnDeleteRestaurant">åˆªé™¤é¤å»³</button>
              </div>
            </div>

            <div class="hr"></div>

            <div class="row">
              <div>
                <label>é¡¯ç¤ºçµ¦ä½¿ç”¨è€…ï¼ˆisVisibleï¼‰</label>
                <select id="rVisible">
                  <option value="true">é¡¯ç¤º</option>
                  <option value="false">éš±è—</option>
                </select>
              </div>
              <div>
                <label>çµå–®ï¼ˆisClosedï¼‰</label>
                <select id="rClosed">
                  <option value="false">é–‹å–®ä¸­</option>
                  <option value="true">å·²çµå–®</option>
                </select>
              </div>
            </div>

            <div class="inline" style="margin-top:10px">
              <span class="muted" id="restaurantFlagHint">ï¼ˆç‹€æ…‹è®Šæ›´æœƒè‡ªå‹•å„²å­˜ï¼‰</span>
            </div>

            <div class="hr"></div>

            <!-- âœ… é¤å»³è³‡è¨Šå¯ç·¨è¼¯ï¼ˆEnter/Blur è‡ªå‹•å­˜ï¼‰ -->
            <h2 style="margin:0 0 10px">1-2ï¼‰é¤å»³è³‡è¨Šï¼ˆå¯ç·¨è¼¯ï¼ŒEnter å³å­˜ï¼‰</h2>
            <div id="restaurantEditWrap" class="muted">è«‹å…ˆé¸æ“‡é¤å»³ã€‚</div>
          </div>

          <div class="card" style="margin-top:14px">
            <h2>2ï¼‰æ–°å¢é¤å»³ï¼ˆEnter ä¹Ÿå¯ç›´æ¥æ–°å¢ï¼‰</h2>

            <div class="row">
              <div>
                <label>é¤å»³åç¨±</label>
                <input id="newRName" placeholder="ä¾‹ï¼šXXä¾¿ç•¶"/>
              </div>
              <div>
                <label>é¤å»³åœ–ç‰‡ URLï¼ˆå¯ç©ºï¼‰</label>
                <input id="newRImg" placeholder="https://..."/>
              </div>
            </div>

            <div class="row">
              <div>
                <label>åœ°å€ï¼ˆå¯ç©ºï¼‰</label>
                <input id="newRAddr" placeholder="ä¾‹ï¼šå°ä¸­å¸‚..."/>
              </div>
              <div>
                <label>é›»è©±ï¼ˆå¯ç©ºï¼‰</label>
                <input id="newRPhone" placeholder="ä¾‹ï¼š04-..."/>
              </div>
            </div>

            <label>Google Map é€£çµï¼ˆå¯ç©ºï¼‰</label>
            <input id="newRMap" placeholder="https://maps.google.com/..."/>

            <div class="inline" style="margin-top:12px">
              <button class="primary" id="btnAddRestaurant">æ–°å¢é¤å»³</button>
              <span class="muted">æ–°å¢å¾Œæœƒè‡ªå‹•å»ºç«‹ã€Œé¤é»é¡åˆ¥ã€ç¾¤çµ„ï¼ˆä¸é å¡é¡åˆ¥ï¼‰ã€‚</span>
            </div>
          </div>

          <div class="card" style="margin-top:14px">
            <h2>3ï¼‰é¡åˆ¥ç®¡ç†ï¼ˆcategoryGroupsï¼‰</h2>
            <div id="catMgrWrap" class="muted">è«‹å…ˆé¸æ“‡é¤å»³ã€‚</div>
          </div>

          <div class="card" style="margin-top:14px">
            <h2>4ï¼‰æ–°å¢é¤é»ï¼ˆé¡åˆ¥ä¸‹æ‹‰ + é¸é …/åŠ è³¼ç¾¤çµ„ï¼‰</h2>
            <div id="menuAddWrap" class="muted">è«‹å…ˆé¸æ“‡é¤å»³ã€‚</div>

            <div class="hr"></div>
            <h2 style="margin-top:0">5ï¼‰é¤é»æ¸…å–®ï¼ˆé¡åˆ¥å…§å¯æ‹–æ›³æ’åºï¼‹è‡ªå‹•å„²å­˜ï¼‰</h2>
            <div class="muted" style="margin-top:-6px">æ¯å€‹é¡åˆ¥å…§å¯æ‹–æ›³é¤é»é †åºï¼ˆä¸é¡¯ç¤ºé †åºè™Ÿç¢¼ï¼‰ã€‚</div>
            <div id="menuList" class="muted">å°šæœªé¸æ“‡é¤å»³ã€‚</div>
          </div>

        </div>

        <!-- TAB: STAFF -->
        <div class="section" id="tabStaff">
          <div class="card">
            <h2>äººå“¡ç®¡ç†ï¼ˆéƒ¨é–€ / äººå“¡ï¼‰</h2>

            <div class="row">
              <div>
                <label>éƒ¨é–€</label>
                <input id="staffDept" placeholder="ä¾‹ï¼šå·¥ç¨‹éƒ¨"/>
              </div>
              <div>
                <label>äººå“¡å§“åï¼ˆEnter ç›´æ¥æ–°å¢ï¼‰</label>
                <input id="staffName" placeholder="ä¾‹ï¼šå°æ˜"/>
              </div>
            </div>

            <div class="inline" style="margin-top:12px">
              <button class="primary" id="btnAddStaff">æ–°å¢äººå“¡</button>
              <button class="btn" id="btnReloadStaff">é‡æ–°è¼‰å…¥</button>
            </div>

            <div class="hr"></div>
            <div class="muted">éƒ¨é–€é è¨­æ”¶åˆï¼›éƒ¨é–€å…§äººå“¡å¯æ‹–æ›³æ’åºï¼ˆè‡ªå‹•å„²å­˜ï¼‰ã€‚</div>
            <div id="staffWrap" class="muted" style="margin-top:10px">è¼‰å…¥ä¸­â€¦</div>
          </div>
        </div>

        <!-- TAB: ORDERS -->
        <div class="section" id="tabOrders">
          <div class="card">
            <h2>æ­·å²ç´€éŒ„ï¼ˆæŸ¥è©¢ / Excel åŒ¯å‡ºï¼‰</h2>
            <div class="row">
              <div>
                <label>æ—¥æœŸ</label>
                <input id="qDate" type="date"/>
              </div>
              <div>
                <label>åº—å®¶</label>
                <select id="qRestaurant">
                  <option value="">å…¨éƒ¨</option>
                </select>
              </div>
            </div>

            <label>è¼¸å…¥åç¨±ï¼ˆäººå“¡ï¼‰</label>
            <input id="qName" placeholder="ä¾‹ï¼šå°æ˜ï¼ˆEnter ç›´æ¥æŸ¥è©¢ï¼‰"/>

            <div class="inline" style="margin-top:12px">
              <button class="primary" id="btnQuery">æŸ¥è©¢</button>
              <button class="btn" id="btnToday">ğŸ²</button>

              <select id="qPeriod" style="width:auto; min-width:140px">
                <option value="">å…¨éƒ¨æ™‚æ®µ</option>
                <option value="noon">ä¸­åˆï¼ˆ12:00å‰ï¼‰</option>
                <option value="night">æ™šä¸Šï¼ˆ12:00å¾Œï¼‰</option>
              </select>

              <button class="btn" id="btnExportExcel">åŒ¯å‡º Excel</button>
            </div>

            <div class="hr"></div>
            <div id="ordersWrap" class="muted">å°šç„¡è³‡æ–™ã€‚</div>
          </div>
        </div>

      </div>
    </div>
  </div>

  <script type="module">
    // ===== Role Gate =====
    const roleKey = "gb_role";
    if (!localStorage.getItem(roleKey)) localStorage.setItem(roleKey, "admin");
    if (localStorage.getItem(roleKey) !== "admin") location.href = "./index.html";

    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-app.js";
    import {
      getFirestore, collection, addDoc, doc, getDocs, getDoc, updateDoc,
      deleteDoc, query, where, limit
    } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-firestore.js";

    // âœ… ä½ çš„ Firebase è¨­å®šï¼ˆæ²¿ç”¨ä½ æä¾›çš„ï¼‰
    const firebaseConfig = {
      apiKey: "AIzaSyBdgOddTGAfqqHLnhnaJRv2_y7gyweuQEo",
      authDomain: "goldbricks-order.firebaseapp.com",
      projectId: "goldbricks-order",
      storageBucket: "goldbricks-order.firebasestorage.app",
      messagingSenderId: "463709758954",
      appId: "1:463709758954:web:429dc920f2f812d51cbe93",
      measurementId: "G-YQK8ZCC26R"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    const $ = (id)=> document.getElementById(id);
    const statusPill = $("statusPill");
    const esc = (s)=> (s??"").toString()
      .replaceAll("&","&amp;").replaceAll("<","&lt;").replaceAll(">","&gt;").replaceAll('"',"&quot;");

    const todayISO = ()=>{
      const d = new Date(); const pad = (n)=> String(n).padStart(2,"0");
      return `${d.getFullYear()}-${pad(d.getMonth()+1)}-${pad(d.getDate())}`;
    };

    function setStatus(txt, ok=true){
      statusPill.textContent = txt;
      statusPill.style.borderColor = ok ? "rgba(15,23,42,.18)" : "rgba(239,68,68,.42)";
    }

    // âœ… Enter/Blur Auto Saveï¼ˆæ‰€æœ‰è¼¸å…¥çš„å…±ç”¨è¦å‰‡ï¼‰
    function bindEnterSave(el, saveFn){
      if(!el) return;
      el.addEventListener("keydown", (e)=>{
        if(e.key === "Enter"){
          e.preventDefault();
          saveFn();
          el.blur();
        }
      });
      el.addEventListener("blur", ()=>{
        saveFn();
      });
    }

    // âœ… æ‹–æ›³æ’åºï¼šDOM reorder å¾Œå›å‚³ ids
    function enableSortable(container, itemSelector, getId, onReorder){
      let draggingEl = null;

      function clearOver(){
        container.querySelectorAll(".dragOver").forEach(x=> x.classList.remove("dragOver"));
      }

      container.addEventListener("dragstart", (e)=>{
        const item = e.target.closest(itemSelector);
        if(!item) return;
        draggingEl = item;
        item.classList.add("dragging");
        e.dataTransfer.effectAllowed = "move";
      });

      container.addEventListener("dragend", ()=>{
        if(draggingEl) draggingEl.classList.remove("dragging");
        draggingEl = null;
        clearOver();
      });

      container.addEventListener("dragover", (e)=>{
        if(!draggingEl) return;
        e.preventDefault();

        const over = e.target.closest(itemSelector);
        if(!over || over === draggingEl) return;

        clearOver();
        over.classList.add("dragOver");

        const rect = over.getBoundingClientRect();
        const shouldInsertBefore = (e.clientY - rect.top) < rect.height/2;

        if(shouldInsertBefore){
          container.insertBefore(draggingEl, over);
        }else{
          container.insertBefore(draggingEl, over.nextSibling);
        }
      });

      container.addEventListener("drop", async (e)=>{
        if(!draggingEl) return;
        e.preventDefault();
        clearOver();
        const ids = Array.from(container.querySelectorAll(itemSelector)).map(el=> getId(el)).filter(Boolean);
        await onReorder(ids);
      });
    }

    // ===== Collections =====
    const colStaff = collection(db, "staff");
    const colRestaurants = collection(db, "restaurants");
    const colOrders = collection(db, "orders");

    // ===== State =====
    let restaurants = [];
    let selectedRestaurantId = "";
    let selectedRestaurant = null;
    let menuCache = [];

    function setWhoLine(){
      $("whoLine").innerHTML = selectedRestaurantId
        ? `<span class="tag">åº—å®¶</span> <b style="margin-left:6px">${esc(selectedRestaurant?.name || "")}</b>`
        : `å°šæœªé¸æ“‡é¤å»³`;
    }

    // ===== Tabs =====
    document.querySelectorAll(".navBtn").forEach(btn=>{
      btn.onclick = ()=>{
        document.querySelectorAll(".navBtn").forEach(b=> b.classList.remove("active"));
        btn.classList.add("active");
        const tab = btn.dataset.tab;
        document.querySelectorAll(".section").forEach(s=> s.classList.remove("active"));
        document.getElementById(tab).classList.add("active");
      };
    });

    // ===== CategoryGroups (ä¸é è¨­ä»»ä½•é¡åˆ¥) =====
    function ensureCategoryGroups(obj){
      const cur = Array.isArray(obj?.categoryGroups) ? obj.categoryGroups : null;
      if(cur && cur.length > 0) return cur;

      return [{
        name: "é¤é»é¡åˆ¥",
        type: "single",
        required: true,
        options: [] // options: [{name, order}]
      }];
    }

    // ===== Restaurants =====
    function normalizeOrder(list){
      // è®“æ²’æœ‰ order çš„ä¹Ÿèƒ½æ’ï¼Œä¸¦ä¸”ç©©å®š
      return list.map((x,idx)=> ({
        ...x,
        order: Number.isFinite(Number(x.order)) ? Number(x.order) : (idx*10)
      }));
    }

    async function saveRestaurantOrder(ids){
      // ids = [rid, rid, ...] in visual order
      try{
        setStatus("å„²å­˜é¤å»³æ’åºä¸­â€¦");
        // ç”¨ index*10 é‡æ–°ç·¨è™Ÿï¼ˆä¸é¡¯ç¤ºçµ¦äººçœ‹ï¼‰
        for(let i=0;i<ids.length;i++){
          await updateDoc(doc(db, "restaurants", ids[i]), { order: i*10 });
        }
        setStatus("é¤å»³æ’åºå·²å„²å­˜ âœ…");
        await loadRestaurants(true);
      }catch(err){
        console.error(err);
        setStatus("é¤å»³æ’åºå„²å­˜å¤±æ•—", false);
        alert("é¤å»³æ’åºå„²å­˜å¤±æ•—ï¼ˆRules/ç¶²è·¯ï¼‰\n\n" + (err?.message || err));
      }
    }

    function renderRestaurantDnDList(){
      const wrap = $("restaurantDnDList");
      if(restaurants.length === 0){
        wrap.innerHTML = `<div class="muted">å°šç„¡é¤å»³ã€‚</div>`;
        return;
      }

      wrap.innerHTML = `
        <div id="rDnDContainer">
          ${restaurants.map(r=>{
            const vis = (r.isVisible !== false);
            const closed = !!r.isClosed;
            return `
              <div class="draggableItem" draggable="true" data-rid="${esc(r.id)}">
                <div class="inline" style="gap:10px; align-items:center">
                  <span class="dragHandle" title="æ‹–æ›³æ’åº">â˜°</span>
                  <div>
                    <div style="font-weight:900">${esc(r.name||"æœªå‘½å")}</div>
                    <div class="muted" style="margin-top:2px">
                      ${vis ? `<span class="tag">é¡¯ç¤º</span>` : `<span class="tag">éš±è—</span>`}
                      ${closed ? `<span class="tag" style="margin-left:6px">å·²çµå–®</span>` : `<span class="tag" style="margin-left:6px">é–‹å–®ä¸­</span>`}
                    </div>
                  </div>
                </div>
                <div class="inline" style="justify-content:flex-end">
                  <button class="btn" data-pick-r="${esc(r.id)}" type="button">é¸æ“‡</button>
                </div>
              </div>
            `;
          }).join("")}
        </div>
      `;

      wrap.querySelectorAll("button[data-pick-r]").forEach(btn=>{
        btn.onclick = async ()=>{
          const rid = btn.dataset.pickR;
          $("restaurantSelect").value = rid;
          await loadRestaurantDoc(rid);
        };
      });

      const container = document.getElementById("rDnDContainer");
      enableSortable(
        container,
        ".draggableItem",
        (el)=> el.dataset.rid,
        saveRestaurantOrder
      );
    }

    async function loadRestaurants(keepSelection=false){
      try{
        setStatus("è¼‰å…¥é¤å»³ä¸­â€¦");
        const snap = await getDocs(colRestaurants);
        let list = [];
        snap.forEach(d=> list.push({ id:d.id, ...d.data() }));

        list = normalizeOrder(list);

        list.sort((a,b)=>{
          const aa = Number(a.order||0), bb = Number(b.order||0);
          if(aa !== bb) return aa - bb;
          const ta = Number(a.createdAt||0), tb = Number(b.createdAt||0);
          if(tb !== ta) return tb - ta;
          return (a.name||"").localeCompare((b.name||""),"zh-Hant");
        });

        restaurants = list;

        // ä¸‹æ‹‰
        const sel = $("restaurantSelect");
        sel.innerHTML = `<option value="">è«‹é¸æ“‡</option>` + restaurants.map(r=>{
          const vis = (r.isVisible !== false);
          const closed = !!r.isClosed;
          const hint = `${vis ? "é¡¯ç¤º" : "éš±è—"} / ${closed ? "å·²çµå–®" : "é–‹å–®ä¸­"}`;
          return `<option value="${esc(r.id)}">${esc(r.name||"æœªå‘½å")}ï¼ˆ${esc(hint)}ï¼‰</option>`;
        }).join("");

        $("qRestaurant").innerHTML = `<option value="">å…¨éƒ¨</option>` + restaurants.map(r=>
          `<option value="${esc(r.id)}">${esc(r.name||"æœªå‘½å")}</option>`
        ).join("");

        // DnD list
        renderRestaurantDnDList();

        // ä¿æŒé¸æ“‡
        if(keepSelection && selectedRestaurantId && restaurants.find(r=> r.id===selectedRestaurantId)){
          sel.value = selectedRestaurantId;
        }else if(selectedRestaurantId && restaurants.find(r=> r.id===selectedRestaurantId)){
          sel.value = selectedRestaurantId;
        }else{
          selectedRestaurantId = "";
          selectedRestaurant = null;
          menuCache = [];
        }

        setWhoLine();
        renderRestaurantFlags();
        renderRestaurantEdit();
        renderCategoryManager();
        renderMenuAdd();
        renderMenuList();

        setStatus("é¤å»³è¼‰å…¥å®Œæˆ âœ…");
      }catch(err){
        console.error("loadRestaurants failed:", err);
        setStatus("é¤å»³è®€å–å¤±æ•—", false);
        alert("é¤å»³è®€å–å¤±æ•—ï¼ˆRules/ç¶²è·¯ï¼‰\n\n" + (err?.message || err));
      }
    }

    async function loadRestaurantDoc(rid){
      if(!rid){
        selectedRestaurantId = "";
        selectedRestaurant = null;
        menuCache = [];
        setWhoLine();
        renderRestaurantFlags();
        renderRestaurantEdit();
        renderCategoryManager();
        renderMenuAdd();
        renderMenuList();
        return;
      }
      try{
        setStatus("è®€å–é¤å»³è³‡æ–™â€¦");
        const snap = await getDoc(doc(db, "restaurants", rid));
        selectedRestaurantId = rid;
        selectedRestaurant = snap.exists() ? snap.data() : null;

        const fixed = ensureCategoryGroups(selectedRestaurant || {});
        if(!Array.isArray(selectedRestaurant?.categoryGroups) || selectedRestaurant.categoryGroups.length===0){
          try{
            await updateDoc(doc(db, "restaurants", rid), { categoryGroups: fixed });
            const snap2 = await getDoc(doc(db, "restaurants", rid));
            selectedRestaurant = snap2.exists() ? snap2.data() : selectedRestaurant;
          }catch(e){
            console.warn("patch categoryGroups failed:", e);
          }
        }

        setWhoLine();
        renderRestaurantFlags();
        renderRestaurantEdit();
        renderCategoryManager();

        await loadMenu(rid);
        renderMenuAdd();
        renderMenuList();

        setStatus("å·²é¸æ“‡é¤å»³ âœ…");
      }catch(err){
        console.error("loadRestaurantDoc failed:", err);
        setStatus("è®€å–é¤å»³å¤±æ•—", false);
        alert("è®€å–é¤å»³å¤±æ•—ï¼ˆRules/ç¶²è·¯ï¼‰\n\n" + (err?.message || err));
      }
    }

    async function addRestaurant(){
      const name = ($("newRName").value || "").trim();
      const imageUrl = ($("newRImg").value || "").trim();
      const address = ($("newRAddr").value || "").trim();
      const phone = ($("newRPhone").value || "").trim();
      const mapUrl = ($("newRMap").value || "").trim();

      if(!name) return alert("è«‹è¼¸å…¥é¤å»³åç¨±");

      try{
        setStatus("æ–°å¢é¤å»³ä¸­â€¦");
        const payload = {
          name,
          imageUrl,
          address,
          phone,
          mapUrl,
          isVisible: true,
          isClosed: false,
          createdAt: Date.now(),
          // âœ… é †åºæ¬„ä½ï¼ˆä¸é¡¯ç¤ºï¼‰ï¼šæ–°åº—å®¶æ”¾æœ€å¾Œ
          order: (restaurants.length ? (Number(restaurants[restaurants.length-1].order||0)+10) : 0),
          categoryGroups: ensureCategoryGroups({})
        };
        const ref = await addDoc(colRestaurants, payload);

        $("newRName").value = "";
        $("newRImg").value = "";
        $("newRAddr").value = "";
        $("newRPhone").value = "";
        $("newRMap").value = "";

        await loadRestaurants(true);
        $("restaurantSelect").value = ref.id;
        await loadRestaurantDoc(ref.id);

        setStatus("æ–°å¢é¤å»³å®Œæˆ âœ…");
      }catch(err){
        console.error("addRestaurant failed:", err);
        setStatus("æ–°å¢é¤å»³å¤±æ•—", false);
        alert("æ–°å¢é¤å»³å¤±æ•—ï¼ˆRules/ç¶²è·¯ï¼‰\n\n" + (err?.message || err));
      }
    }

    function renderRestaurantFlags(){
      const hint = $("restaurantFlagHint");
      if(!selectedRestaurantId || !selectedRestaurant){
        $("rVisible").disabled = true;
        $("rClosed").disabled = true;
        hint.textContent = "è«‹å…ˆé¸æ“‡é¤å»³";
        return;
      }
      $("rVisible").disabled = false;
      $("rClosed").disabled = false;

      $("rVisible").value = (selectedRestaurant.isVisible !== false) ? "true" : "false";
      $("rClosed").value = (!!selectedRestaurant.isClosed) ? "true" : "false";
      hint.textContent = "ï¼ˆç‹€æ…‹è®Šæ›´æœƒè‡ªå‹•å„²å­˜ï¼‰";
    }

    async function saveRestaurantFlags(){
      if(!selectedRestaurantId) return;
      try{
        setStatus("å„²å­˜é¤å»³ç‹€æ…‹â€¦");
        const isVisible = $("rVisible").value === "true";
        const isClosed = $("rClosed").value === "true";
        await updateDoc(doc(db, "restaurants", selectedRestaurantId), { isVisible, isClosed });
        await loadRestaurantDoc(selectedRestaurantId);
        await loadRestaurants(true);
        setStatus("ç‹€æ…‹å·²å„²å­˜ âœ…");
      }catch(err){
        console.error("saveRestaurantFlags failed:", err);
        setStatus("ç‹€æ…‹å„²å­˜å¤±æ•—", false);
        alert("å„²å­˜å¤±æ•—ï¼ˆRules/ç¶²è·¯ï¼‰\n\n" + (err?.message || err));
      }
    }

    function renderRestaurantEdit(){
      const wrap = $("restaurantEditWrap");
      if(!selectedRestaurantId || !selectedRestaurant){
        wrap.innerHTML = `<div class="muted">è«‹å…ˆé¸æ“‡é¤å»³ã€‚</div>`;
        return;
      }

      const r = selectedRestaurant || {};
      wrap.innerHTML = `
        <div class="row">
          <div>
            <label>é¤å»³åç¨±ï¼ˆEnter/é›¢é–‹å³å­˜ï¼‰</label>
            <input id="editRName" value="${esc(r.name||"")}"/>
          </div>
          <div>
            <label>åœ–ç‰‡ URLï¼ˆå¯ç©ºï¼‰</label>
            <input id="editRImg" value="${esc(r.imageUrl||"")}"/>
          </div>
        </div>

        <div class="row">
          <div>
            <label>åœ°å€ï¼ˆå¯ç©ºï¼‰</label>
            <input id="editRAddr" value="${esc(r.address||"")}"/>
          </div>
          <div>
            <label>é›»è©±ï¼ˆå¯ç©ºï¼‰</label>
            <input id="editRPhone" value="${esc(r.phone||"")}"/>
          </div>
        </div>

        <label>Google Map é€£çµï¼ˆå¯ç©ºï¼‰</label>
        <input id="editRMap" value="${esc(r.mapUrl||"")}"/>

        <div class="inline" style="margin-top:10px">
          <span class="muted">â€» ä½ ä¸ç”¨æŒ‰æŒ‰éˆ•ï¼ŒEnter æˆ–é›¢é–‹æ¬„ä½æœƒè‡ªå‹•å„²å­˜ã€‚</span>
        </div>
      `;

      const saveInfo = async ()=>{
        const payload = {
          name: (document.getElementById("editRName").value||"").trim(),
          imageUrl: (document.getElementById("editRImg").value||"").trim(),
          address: (document.getElementById("editRAddr").value||"").trim(),
          phone: (document.getElementById("editRPhone").value||"").trim(),
          mapUrl: (document.getElementById("editRMap").value||"").trim(),
        };
        if(!payload.name) return; // name ä¸å…è¨±ç©ºç™½ï¼ˆé¿å…èª¤è§¸æŠŠåå­—æ¸…æ‰ï¼‰
        try{
          setStatus("å„²å­˜é¤å»³è³‡è¨Šâ€¦");
          await updateDoc(doc(db, "restaurants", selectedRestaurantId), payload);
          await loadRestaurantDoc(selectedRestaurantId);
          await loadRestaurants(true);
          setStatus("é¤å»³è³‡è¨Šå·²å„²å­˜ âœ…");
        }catch(err){
          console.error(err);
          setStatus("é¤å»³è³‡è¨Šå„²å­˜å¤±æ•—", false);
        }
      };

      bindEnterSave(document.getElementById("editRName"), saveInfo);
      bindEnterSave(document.getElementById("editRImg"), saveInfo);
      bindEnterSave(document.getElementById("editRAddr"), saveInfo);
      bindEnterSave(document.getElementById("editRPhone"), saveInfo);
      bindEnterSave(document.getElementById("editRMap"), saveInfo);
    }

    async function deleteRestaurant(){
      if(!selectedRestaurantId) return alert("è«‹å…ˆé¸æ“‡é¤å»³");
      if(!confirm("ç¢ºå®šåˆªé™¤æ­¤é¤å»³ï¼Ÿ\nï¼ˆæ³¨æ„ï¼šå­é›†åˆ menu ä¸æœƒè‡ªå‹•åˆªï¼ŒFirestore éœ€è¦å¦å¤–æ¸…é™¤ï¼‰")) return;
      try{
        await deleteDoc(doc(db, "restaurants", selectedRestaurantId));
        selectedRestaurantId = "";
        selectedRestaurant = null;
        menuCache = [];
        await loadRestaurants(false);
        setStatus("åˆªé™¤é¤å»³å®Œæˆ âœ…");
      }catch(err){
        console.error("deleteRestaurant failed:", err);
        alert("åˆªé™¤é¤å»³å¤±æ•—ï¼ˆRules/ç¶²è·¯ï¼‰\n\n" + (err?.message || err));
      }
    }

    // ===== Category Manager (categoryGroups) =====
    function getCategoryGroup(){
      const groups = ensureCategoryGroups(selectedRestaurant || {});
      // options: [{name, order}]
      const g0 = groups[0] || { name:"é¤é»é¡åˆ¥", type:"single", required:true, options:[] };
      g0.options = Array.isArray(g0.options) ? g0.options : [];
      g0.options = g0.options.map((o,idx)=> ({
        ...o,
        order: Number.isFinite(Number(o.order)) ? Number(o.order) : idx*10
      })).sort((a,b)=> Number(a.order||0)-Number(b.order||0));
      groups[0] = g0;
      return { groups, g0 };
    }

    async function saveCategoryGroups(groups){
      if(!selectedRestaurantId) return;
      await updateDoc(doc(db, "restaurants", selectedRestaurantId), { categoryGroups: groups });
      await loadRestaurantDoc(selectedRestaurantId);
      await loadRestaurants(true);
    }

    async function saveCategoryOrder(namesInOrder){
      try{
        setStatus("å„²å­˜é¡åˆ¥æ’åºä¸­â€¦");
        const { groups, g0 } = getCategoryGroup();
        const map = new Map((g0.options||[]).map(o=> [o.name, o]));
        const next = namesInOrder.map((name,idx)=> ({
          ...(map.get(name) || { name }),
          order: idx*10
        }));
        g0.options = next;
        groups[0] = g0;
        await saveCategoryGroups(groups);
        renderMenuAdd();
        setStatus("é¡åˆ¥æ’åºå·²å„²å­˜ âœ…");
      }catch(err){
        console.error(err);
        setStatus("é¡åˆ¥æ’åºå„²å­˜å¤±æ•—", false);
        alert("é¡åˆ¥æ’åºå„²å­˜å¤±æ•—ï¼ˆRules/ç¶²è·¯ï¼‰\n\n" + (err?.message || err));
      }
    }

    function renderCategoryManager(){
      const wrap = $("catMgrWrap");
      if(!selectedRestaurantId || !selectedRestaurant){
        wrap.innerHTML = `<div class="muted">è«‹å…ˆé¸æ“‡é¤å»³ã€‚</div>`;
        return;
      }

      const { groups, g0 } = getCategoryGroup();
      const opts = Array.isArray(g0.options) ? g0.options : [];

      wrap.innerHTML = `
        <div class="inline" style="justify-content:space-between">
          <div>
            <span class="tag">ç¾¤çµ„</span>
            <b style="margin-left:8px">${esc(g0.name || "é¤é»é¡åˆ¥")}</b>
          </div>
          <span class="muted">ï¼ˆç”¨æ–¼ã€Œæ–°å¢é¤é»ã€çš„é¡åˆ¥ä¸‹æ‹‰ï¼‰</span>
        </div>

        <div class="box" style="margin-top:10px">
          <div class="row">
            <div>
              <label>æ–°å¢é¡åˆ¥ï¼ˆEnter ç›´æ¥æ–°å¢ï¼‰</label>
              <input id="catNewName" placeholder="ä¾‹ï¼šéºµé¡ / é£¯é¡ / å°èœ"/>
            </div>
            <div class="inline" style="align-self:end; justify-content:flex-end">
              <button class="primary" id="btnAddCategory" type="button">æ–°å¢</button>
            </div>
          </div>

          <div class="hr"></div>

          <!-- âœ… ç›®å‰é …ç›®é è¨­æ”¶åˆ -->
          <details class="box" style="margin-top:0; background:var(--card-sub)">
            <summary>
              <b>ç›®å‰é¡åˆ¥ï¼ˆ${opts.length}ï¼‰</b>
              <span class="tag" style="margin-left:8px">é»æˆ‘å±•é–‹</span>
              <span class="muted" style="margin-left:8px">ï¼ˆå¯æ‹–æ›³æ’åºï¼‰</span>
            </summary>

            <div style="margin-top:10px">
              <div id="catDnDWrap" class="muted"></div>
            </div>
          </details>
        </div>
      `;

      const catListWrap = document.getElementById("catDnDWrap");
      if(opts.length === 0){
        catListWrap.innerHTML = `<div class="muted">å°šç„¡é¡åˆ¥ï¼Œè«‹å…ˆæ–°å¢ã€‚</div>`;
      }else{
        catListWrap.innerHTML = `
          <div id="catDnDContainer">
            ${opts.map(o=>`
              <div class="draggableItem" draggable="true" data-cat="${esc(o.name||"")}">
                <div class="inline" style="gap:10px">
                  <span class="dragHandle" title="æ‹–æ›³æ’åº">â˜°</span>
                  <b>${esc(o.name||"")}</b>
                </div>
                <div class="inline">
                  <button class="btn danger" data-del-cat="${esc(o.name||"")}" type="button">åˆªé™¤</button>
                </div>
              </div>
            `).join("")}
          </div>
        `;

        // åˆªé™¤é¡åˆ¥
        catListWrap.querySelectorAll("button[data-del-cat]").forEach(btn=>{
          btn.onclick = async ()=>{
            const name = btn.dataset.delCat;
            if(!confirm("ç¢ºå®šåˆªé™¤æ­¤é¡åˆ¥ï¼Ÿ")) return;
            const { groups, g0 } = getCategoryGroup();
            g0.options = (g0.options||[]).filter(o=> (o.name||"") !== name);
            groups[0] = g0;
            try{
              setStatus("åˆªé™¤é¡åˆ¥ä¸­â€¦");
              await saveCategoryGroups(groups);
              renderMenuAdd();
              setStatus("åˆªé™¤é¡åˆ¥å®Œæˆ âœ…");
            }catch(err){
              console.error(err);
              alert("åˆªé™¤é¡åˆ¥å¤±æ•—ï¼ˆRules/ç¶²è·¯ï¼‰\n\n" + (err?.message || err));
            }
          };
        });

        // æ‹–æ›³æ’åº
        const container = document.getElementById("catDnDContainer");
        enableSortable(
          container,
          ".draggableItem",
          (el)=> el.dataset.cat,
          async (names)=> await saveCategoryOrder(names)
        );
      }

      // æ–°å¢é¡åˆ¥
      const addCat = async ()=>{
        const name = (document.getElementById("catNewName").value || "").trim();
        if(!name) return alert("è«‹è¼¸å…¥é¡åˆ¥åç¨±");

        const { groups, g0 } = getCategoryGroup();
        const cur = Array.isArray(g0.options) ? g0.options : [];
        if(cur.some(x => (x.name||"") === name)) return alert("æ­¤é¡åˆ¥å·²å­˜åœ¨");

        g0.options = [...cur, { name, order: (cur.length ? (Number(cur[cur.length-1].order||0)+10) : 0) }];
        groups[0] = g0;

        try{
          setStatus("æ–°å¢é¡åˆ¥ä¸­â€¦");
          await saveCategoryGroups(groups);
          renderMenuAdd();
          setStatus("æ–°å¢é¡åˆ¥å®Œæˆ âœ…");
        }catch(err){
          console.error(err);
          alert("æ–°å¢é¡åˆ¥å¤±æ•—ï¼ˆRules/ç¶²è·¯ï¼‰\n\n" + (err?.message || err));
        }
      };

      document.getElementById("btnAddCategory").onclick = addCat;
      document.getElementById("catNewName").addEventListener("keydown", (e)=>{
        if(e.key === "Enter"){ e.preventDefault(); addCat(); }
      });
    }

    // ===== Menu =====
    async function loadMenu(rid){
      try{
        setStatus("è¼‰å…¥é¤é»ä¸­â€¦");
        const menuCol = collection(db, "restaurants", rid, "menu");
        const snap = await getDocs(menuCol);
        let list = [];
        snap.forEach(d=> list.push({ id:d.id, ...d.data() }));

        // âœ… è®“é¤é»èƒ½æ‹–æ›³æ’åºï¼šä½¿ç”¨ menu.orderï¼ˆæ²’ order å°±ç”¨ createdAtï¼‰
        list = list.map((m,idx)=> ({
          ...m,
          order: Number.isFinite(Number(m.order)) ? Number(m.order) : (Number(m.createdAt||0) || idx*10)
        }));

        list.sort((a,b)=>{
          const ca = (a.category||"").localeCompare((b.category||""),"zh-Hant");
          if(ca !== 0) return ca;
          const oa = Number(a.order||0), ob = Number(b.order||0);
          if(oa !== ob) return oa - ob;
          return (a.name||"").localeCompare((b.name||""),"zh-Hant");
        });

        menuCache = list;
        setStatus("é¤é»è¼‰å…¥å®Œæˆ âœ…");
      }catch(err){
        console.error("loadMenu failed:", err);
        setStatus("é¤é»è®€å–å¤±æ•—", false);
        menuCache = [];
      }
    }

    function renderCategoryPickerHTML(){
      const { g0 } = getCategoryGroup();
      const opts = Array.isArray(g0.options) ? g0.options : [];
      const req = (g0.required !== false);

      if(opts.length === 0){
        return `
          <div class="box" style="background:var(--card-sub)">
            <div class="inline" style="justify-content:space-between">
              <b>${esc(g0.name || "é¤é»é¡åˆ¥")}</b>
              <span class="tag">${req ? "å¿…é¸" : "å¯ä¸é¸"}</span>
            </div>
            <div class="muted" style="margin-top:6px">å°šç„¡é¡åˆ¥ï¼Œè«‹å…ˆåˆ°ä¸Šæ–¹ã€Œé¡åˆ¥ç®¡ç†ã€æ–°å¢è‡³å°‘ä¸€å€‹é¡åˆ¥ã€‚</div>
          </div>
        `;
      }

      return `
        <div class="box" style="background:var(--card-sub)">
          <div class="inline" style="justify-content:space-between">
            <b>${esc(g0.name || "é¤é»é¡åˆ¥")}</b>
            <span class="tag">${req ? "å¿…é¸" : "å¯ä¸é¸"}</span>
          </div>
          <select id="menuCategorySelect" data-cat-gi="0" style="margin-top:8px">
            ${req ? "" : `<option value="-1">ä¸é¸æ“‡</option>`}
            ${opts.map((o,oi)=>`<option value="${oi}">${esc(o.name||"")}</option>`).join("")}
          </select>
          <div class="muted" style="margin-top:6px">â€» æ–°å¢é¤é»æ™‚æœƒæŠŠé¸åˆ°çš„é¡åˆ¥å­˜åˆ° menu.categoryï¼ˆå­—ä¸²ï¼‰</div>
        </div>
      `;
    }

    function getPickedCategoryValue(){
      const sel = document.getElementById("menuCategorySelect");
      if(!sel) return "";
      const idx = Number(sel.value);
      const { g0 } = getCategoryGroup();
      const req = (g0.required !== false);
      if(req && (!Number.isFinite(idx) || idx < 0)) return "";
      const opt = (Array.isArray(g0.options) ? g0.options : [])[idx];
      return (opt?.name || "").trim();
    }

    function renderMenuAdd(){
      const wrap = $("menuAddWrap");
      if(!selectedRestaurantId || !selectedRestaurant){
        wrap.innerHTML = `<div class="muted">è«‹å…ˆé¸æ“‡é¤å»³ã€‚</div>`;
        return;
      }

      wrap.innerHTML = `
        ${renderCategoryPickerHTML()}

        <div class="row" style="margin-top:10px">
          <div>
            <label>é¤é»åç¨±ï¼ˆEnter ç›´æ¥æ–°å¢ï¼‰</label>
            <input id="mName" placeholder="ä¾‹ï¼šæ³•å¼ç‚’éºµ"/>
          </div>
          <div>
            <label>åƒ¹æ ¼ï¼ˆå–®ä»½ï¼‰</label>
            <input id="mPrice" type="number" min="0" value="0"/>
          </div>
        </div>

        <div class="row">
          <div>
            <label>é è¨­æ•¸é‡ï¼ˆdefaultQtyï¼‰</label>
            <input id="mDefaultQty" type="number" min="1" value="1"/>
          </div>
          <div>
            <label>å‚™è¨»ï¼ˆå¯ç©ºï¼‰</label>
            <input id="mNote" placeholder="ä¾‹ï¼šå¯èª¿è¾£åº¦"/>
          </div>
        </div>

        <!-- âœ… addonGroups -->
        <div class="box">
          <div class="inline" style="justify-content:space-between">
            <b>åŠ è³¼ç¾¤çµ„ addonGroupsï¼ˆå¯å–®é¸ / å¤šé¸ / å¯åŠ åƒ¹ï¼‰</b>
            <button class="btn" id="btnAddAddonGroup" type="button">ï¼‹æ–°å¢ä¸€çµ„</button>
          </div>
          <div id="addonGroupsWrap" class="muted" style="margin-top:8px"></div>
        </div>

        <div class="box">
          <div class="inline" style="justify-content:space-between">
            <b>é¸é … optionGroupsï¼ˆä¸‹æ‹‰ / å¯åŠ åƒ¹ï¼‰</b>
            <button class="btn" id="btnAddOptionGroup" type="button">ï¼‹æ–°å¢ä¸€çµ„</button>
          </div>
          <div id="optGroupsWrap" class="muted" style="margin-top:8px"></div>
        </div>

        <div class="inline" style="margin-top:12px">
          <button class="primary" id="btnAddMenu" type="button">æ–°å¢é¤é»</button>
          <span class="muted">Enter ä¹Ÿå¯ç›´æ¥æ–°å¢ï¼ˆç„¦é»åœ¨é¤é»åç¨±æ™‚ï¼‰</span>
        </div>
      `;

      // ===== addonGroups builder =====
      const addonWrap = document.getElementById("addonGroupsWrap");
      addonWrap.innerHTML = `<div class="muted">ï¼ˆå°šç„¡åŠ è³¼ç¾¤çµ„ï¼ŒæŒ‰ã€Œæ–°å¢ä¸€çµ„ã€åŠ å…¥ï¼‰</div>`;
      let addonGroupCount = 0;

      document.getElementById("btnAddAddonGroup").onclick = ()=>{
        addonGroupCount++;
        if(addonGroupCount === 1) addonWrap.innerHTML = "";
        const gid = `ag_${Date.now()}_${Math.random().toString(16).slice(2)}`;

        const groupEl = document.createElement("div");
        groupEl.className = "box";
        groupEl.dataset.gid = gid;

        groupEl.innerHTML = `
          <div class="row">
            <div>
              <label>ç¾¤çµ„åç¨±</label>
              <input data-ag-name placeholder="ä¾‹ï¼šåŠ æ–™ï¼ˆéºµï¼‰ / é£²æ–™åŠ è³¼"/>
            </div>
            <div class="row" style="grid-template-columns:1fr 1fr; gap:10px">
              <div>
                <label>é¸æ“‡æ–¹å¼</label>
                <select data-ag-type>
                  <option value="multi">å¤šé¸</option>
                  <option value="single">å–®é¸</option>
                </select>
              </div>
              <div>
                <label>å¿…é¸</label>
                <select data-ag-required>
                  <option value="false">å¯ä¸é¸</option>
                  <option value="true">å¿…é¸</option>
                </select>
              </div>
            </div>
          </div>

          <div class="inline" style="justify-content:space-between; margin-top:8px">
            <b>åŠ è³¼é …ç›®ï¼ˆoptionsï¼‰</b>
            <button class="btn" data-ag-add-opt type="button">ï¼‹æ–°å¢é …ç›®</button>
          </div>
          <div class="muted" style="margin-top:6px">ï¼ˆæ¯å€‹é …ç›®å¯è¨­å®šå…è²»/åŠ åƒ¹ï¼‰</div>
          <div data-ag-opt-list style="margin-top:8px"></div>

          <div class="inline" style="justify-content:flex-end; margin-top:10px">
            <button class="btn danger" data-ag-del-group type="button">åˆªé™¤æ­¤ç¾¤çµ„</button>
          </div>
        `;

        addonWrap.appendChild(groupEl);

        const optList = groupEl.querySelector("[data-ag-opt-list]");
        optList.innerHTML = `<div class="muted">ï¼ˆå°šç„¡é …ç›®ï¼Œè«‹æ–°å¢ï¼‰</div>`;
        let optCount = 0;

        groupEl.querySelector("[data-ag-add-opt]").onclick = ()=>{
          optCount++;
          if(optCount === 1) optList.innerHTML = "";
          const optEl = document.createElement("div");
          optEl.className = "box";
          optEl.style.marginTop = "10px";
          optEl.innerHTML = `
            <div class="miniRow">
              <div>
                <label>åç¨±</label>
                <input data-ag-opt-name placeholder="ä¾‹ï¼šåŠ è›‹"/>
              </div>
              <div>
                <label>åƒ¹æ ¼</label>
                <input data-ag-opt-price type="number" min="0" value="0"/>
              </div>
              <div>
                <label>å…è²»</label>
                <select data-ag-opt-free>
                  <option value="false">å¦</option>
                  <option value="true">æ˜¯</option>
                </select>
              </div>
            </div>
            <div class="inline" style="justify-content:flex-end; margin-top:10px">
              <button class="btn danger" data-ag-del-opt type="button">åˆªé™¤</button>
            </div>
          `;
          optList.appendChild(optEl);
          optEl.querySelector("[data-ag-del-opt]").onclick = ()=>{
            optEl.remove();
            if(optList.querySelectorAll(".box").length === 0){
              optCount = 0;
              optList.innerHTML = `<div class="muted">ï¼ˆå°šç„¡é …ç›®ï¼Œè«‹æ–°å¢ï¼‰</div>`;
            }
          };
        };

        groupEl.querySelector("[data-ag-del-group]").onclick = ()=>{
          groupEl.remove();
          if(addonWrap.querySelectorAll(".box[data-gid]").length === 0){
            addonGroupCount = 0;
            addonWrap.innerHTML = `<div class="muted">ï¼ˆå°šç„¡åŠ è³¼ç¾¤çµ„ï¼ŒæŒ‰ã€Œæ–°å¢ä¸€çµ„ã€åŠ å…¥ï¼‰</div>`;
          }
        };
      };

      // ===== optionGroups builder =====
      const optWrap = document.getElementById("optGroupsWrap");
      optWrap.innerHTML = `<div class="muted">ï¼ˆå°šç„¡é¸é …ï¼ŒæŒ‰ã€Œæ–°å¢ä¸€çµ„ã€åŠ å…¥ï¼‰</div>`;
      let groupCount = 0;

      document.getElementById("btnAddOptionGroup").onclick = ()=>{
        groupCount++;
        if(groupCount === 1) optWrap.innerHTML = "";
        const gid = `g_${Date.now()}_${Math.random().toString(16).slice(2)}`;
        const groupEl = document.createElement("div");
        groupEl.className = "box";
        groupEl.dataset.gid = gid;
        groupEl.innerHTML = `
          <div class="row">
            <div>
              <label>ç¾¤çµ„åç¨±</label>
              <input data-g-name placeholder="ä¾‹ï¼šè‚‰é¡é¸æ“‡"/>
            </div>
            <div>
              <label>å¿…é¸</label>
              <select data-g-required>
                <option value="true">å¿…é¸</option>
                <option value="false">å¯ä¸é¸</option>
              </select>
            </div>
          </div>

          <div class="inline" style="justify-content:space-between; margin-top:8px">
            <b>é¸é …ï¼ˆoptionsï¼‰</b>
            <button class="btn" data-add-opt type="button">ï¼‹æ–°å¢é¸é …</button>
          </div>
          <div class="muted" style="margin-top:6px">ï¼ˆæ¯å€‹é¸é …å¯åŠ åƒ¹ priceï¼‰</div>
          <div data-opt-list style="margin-top:8px"></div>

          <div class="inline" style="justify-content:flex-end; margin-top:10px">
            <button class="btn danger" data-del-group type="button">åˆªé™¤æ­¤ç¾¤çµ„</button>
          </div>
        `;

        optWrap.appendChild(groupEl);

        const optList = groupEl.querySelector("[data-opt-list]");
        optList.innerHTML = `<div class="muted">ï¼ˆå°šç„¡é¸é …ï¼Œè«‹æ–°å¢ï¼‰</div>`;
        let optCount = 0;

        groupEl.querySelector("[data-add-opt]").onclick = ()=>{
          optCount++;
          if(optCount === 1) optList.innerHTML = "";
          const optEl = document.createElement("div");
          optEl.className = "box";
          optEl.style.marginTop = "10px";
          optEl.innerHTML = `
            <div class="miniRow">
              <div>
                <label>é¸é …åç¨±</label>
                <input data-opt-name placeholder="ä¾‹ï¼šè±¬è‚‰"/>
              </div>
              <div>
                <label>åŠ åƒ¹</label>
                <input data-opt-price type="number" min="0" value="0"/>
              </div>
              <div class="inline" style="align-self:end; justify-content:flex-end">
                <button class="btn danger" data-del-opt type="button">åˆªé™¤</button>
              </div>
            </div>
          `;
          optList.appendChild(optEl);
          optEl.querySelector("[data-del-opt]").onclick = ()=>{
            optEl.remove();
            if(optList.querySelectorAll(".box").length === 0){
              optCount = 0;
              optList.innerHTML = `<div class="muted">ï¼ˆå°šç„¡é¸é …ï¼Œè«‹æ–°å¢ï¼‰</div>`;
            }
          };
        };

        groupEl.querySelector("[data-del-group]").onclick = ()=>{
          groupEl.remove();
          if(optWrap.querySelectorAll(".box[data-gid]").length === 0){
            groupCount = 0;
            optWrap.innerHTML = `<div class="muted">ï¼ˆå°šç„¡é¸é …ï¼ŒæŒ‰ã€Œæ–°å¢ä¸€çµ„ã€åŠ å…¥ï¼‰</div>`;
          }
        };
      };

      document.getElementById("btnAddMenu").onclick = addMenuItem;

      // âœ… Enter = æ–°å¢é¤é»ï¼ˆç„¦é»åœ¨åç¨±ï¼‰
      document.getElementById("mName").addEventListener("keydown", (e)=>{
        if(e.key === "Enter"){ e.preventDefault(); addMenuItem(); }
      });
    }

    function collectAddonGroups(){
      const groups = [];
      const groupEls = document.querySelectorAll("#addonGroupsWrap .box[data-gid]");
      groupEls.forEach(gel=>{
        const name = (gel.querySelector("[data-ag-name]")?.value || "").trim();
        const type = (gel.querySelector("[data-ag-type]")?.value || "multi");
        const required = (gel.querySelector("[data-ag-required]")?.value || "false") === "true";

        const optList = gel.querySelectorAll("[data-ag-opt-list] .box");
        const options = [];
        optList.forEach(oel=>{
          const oname = (oel.querySelector("[data-ag-opt-name]")?.value || "").trim();
          if(!oname) return;
          const price = Number(oel.querySelector("[data-ag-opt-price]")?.value || 0);
          const free = (oel.querySelector("[data-ag-opt-free]")?.value || "false") === "true";
          options.push({ name: oname, price: Number.isFinite(price)?price:0, free });
        });

        if(!name && options.length===0) return;

        groups.push({
          name: name || "åŠ è³¼",
          type: (type === "single") ? "single" : "multi",
          required,
          options
        });
      });
      return groups;
    }

    function collectOptionGroups(){
      const groups = [];
      const groupEls = document.querySelectorAll("#optGroupsWrap .box[data-gid]");
      groupEls.forEach(gel=>{
        const name = (gel.querySelector("[data-g-name]")?.value || "").trim();
        const required = (gel.querySelector("[data-g-required]")?.value || "true") === "true";

        const optList = gel.querySelectorAll("[data-opt-list] .box");
        const options = [];
        optList.forEach(oel=>{
          const oname = (oel.querySelector("[data-opt-name]")?.value || "").trim();
          if(!oname) return;
          const price = Number(oel.querySelector("[data-opt-price]")?.value || 0);
          options.push({ name: oname, price: Number.isFinite(price)?price:0 });
        });

        if(!name && options.length===0) return;

        groups.push({
          name: name || "é¸é …",
          type: "single",
          required,
          options
        });
      });
      return groups;
    }

    async function addMenuItem(){
      if(!selectedRestaurantId) return alert("è«‹å…ˆé¸æ“‡é¤å»³");

      const category = getPickedCategoryValue();
      if(!category) return alert("è«‹å…ˆåœ¨ã€Œé¡åˆ¥ç®¡ç†ã€æ–°å¢é¡åˆ¥ï¼Œä¸¦é¸æ“‡é¤é»é¡åˆ¥");

      const name = ($("mName")?.value || "").trim();
      const price = Number($("mPrice")?.value || 0);
      const defaultQty = Math.max(1, Number($("mDefaultQty")?.value || 1));
      const note = ($("mNote")?.value || "").trim();

      if(!name) return alert("è«‹è¼¸å…¥é¤é»åç¨±");
      if(!Number.isFinite(price) || price < 0) return alert("åƒ¹æ ¼ä¸æ­£ç¢º");

      const addonGroups = collectAddonGroups();
      const optionGroups = collectOptionGroups();

      for(const g of optionGroups){
        if((g.required !== false) && (!Array.isArray(g.options) || g.options.length===0)){
          return alert(`é¸é …ç¾¤çµ„ã€Œ${g.name}ã€æ˜¯å¿…é¸ï¼Œä½†æ²’æœ‰ä»»ä½•é¸é …`);
        }
      }
      for(const g of addonGroups){
        if((g.required === true) && (!Array.isArray(g.options) || g.options.length===0)){
          return alert(`åŠ è³¼ç¾¤çµ„ã€Œ${g.name}ã€æ˜¯å¿…é¸ï¼Œä½†æ²’æœ‰ä»»ä½•åŠ è³¼é …ç›®`);
        }
      }

      try{
        setStatus("æ–°å¢é¤é»ä¸­â€¦");
        const menuCol = collection(db, "restaurants", selectedRestaurantId, "menu");
        const lastOrder = menuCache.length ? Number(menuCache[menuCache.length-1].order||0) : 0;
        await addDoc(menuCol, {
          category,
          name,
          price,
          defaultQty,
          note,
          addonGroups,
          optionGroups,
          createdAt: Date.now(),
          // âœ… æ–°å¢çš„é¤é»æ”¾åœ¨è©²é¡åˆ¥æœ€å¾Œï¼ˆé€™è£¡å…ˆç”¨æ•´é«”æœ€å¾Œï¼Œä¹‹å¾Œæ‹–æ›³å¯èª¿ï¼‰
          order: lastOrder + 10
        });

        $("mName").value = "";
        $("mPrice").value = "0";
        $("mDefaultQty").value = "1";
        $("mNote").value = "";

        await loadMenu(selectedRestaurantId);
        renderMenuAdd();
        renderMenuList();
        setStatus("æ–°å¢é¤é»å®Œæˆ âœ…");
      }catch(err){
        console.error("addMenuItem failed:", err);
        setStatus("æ–°å¢é¤é»å¤±æ•—", false);
        alert("æ–°å¢é¤é»å¤±æ•—ï¼ˆRules/ç¶²è·¯ï¼‰\n\n" + (err?.message || err));
      }
    }

    async function saveMenuOrderForCategory(cat, ids){
      // ids: menu doc ids in visual order for that category
      try{
        setStatus("å„²å­˜é¤é»æ’åºä¸­â€¦");
        for(let i=0;i<ids.length;i++){
          await updateDoc(doc(db, "restaurants", selectedRestaurantId, "menu", ids[i]), { order: i*10 });
        }
        setStatus("é¤é»æ’åºå·²å„²å­˜ âœ…");
        await loadMenu(selectedRestaurantId);
        renderMenuList();
      }catch(err){
        console.error(err);
        setStatus("é¤é»æ’åºå„²å­˜å¤±æ•—", false);
        alert("é¤é»æ’åºå„²å­˜å¤±æ•—ï¼ˆRules/ç¶²è·¯ï¼‰\n\n" + (err?.message || err));
      }
    }

    function renderMenuList(){
      const wrap = $("menuList");
      if(!selectedRestaurantId){
        wrap.innerHTML = `<div class="muted">å°šæœªé¸æ“‡é¤å»³ã€‚</div>`;
        return;
      }
      if(menuCache.length === 0){
        wrap.innerHTML = `<div class="muted">æ­¤é¤å»³å°šç„¡é¤é»ã€‚</div>`;
        return;
      }

      const map = new Map();
      for(const m of menuCache){
        const cat = (m.category || "æœªåˆ†é¡").trim();
        if(!map.has(cat)) map.set(cat, []);
        map.get(cat).push(m);
      }

      wrap.innerHTML = Array.from(map.entries()).map(([cat, items], ci)=>{
        const listId = `menuDnD_${ci}_${cat.replace(/\s/g,"_")}`;
        return `
          <details class="box" style="padding:10px 12px">
            <summary>
              <b>${esc(cat)}</b>
              <span class="tag" style="margin-left:8px">${items.length} é …</span>
              <span class="muted" style="margin-left:8px">ï¼ˆå±•é–‹å¾Œå¯æ‹–æ›³æ’åºï¼‰</span>
            </summary>

            <div style="margin-top:10px" id="${esc(listId)}">
              ${items.map(m=>{
                const og = Array.isArray(m.optionGroups) ? m.optionGroups : [];
                const ag = Array.isArray(m.addonGroups) ? m.addonGroups : [];
                return `
                  <div class="draggableItem" draggable="true" data-mid="${esc(m.id)}">
                    <div class="inline" style="gap:10px; align-items:flex-start">
                      <span class="dragHandle" title="æ‹–æ›³æ’åº">â˜°</span>
                      <div>
                        <div style="font-weight:900">${esc(m.name||"")}</div>
                        <div class="muted" style="margin-top:4px">
                          <span class="tag">åƒ¹æ ¼ï¼š${Number(m.price||0)}</span>
                          <span class="tag" style="margin-left:6px">é è¨­ï¼š${Number(m.defaultQty||1)}</span>
                        </div>

                        ${m.note ? `<div class="muted" style="margin-top:6px">å‚™è¨»ï¼š${esc(m.note)}</div>` : ``}

                        ${og.length ? `
                          <div class="muted" style="margin-top:8px">
                            é¸é …ç¾¤çµ„ï¼š${esc(og.map(g=> `${g.name}ï¼ˆ${(g.required!==false)?"å¿…é¸":"å¯ä¸é¸"} / ${Array.isArray(g.options)?g.options.length:0}é …ï¼‰`).join("ï¼›"))}
                          </div>
                        ` : ``}

                        ${ag.length ? `
                          <div class="muted" style="margin-top:8px">
                            åŠ è³¼ç¾¤çµ„ï¼š${esc(ag.map(g=>{
                              const t = (g.type==="single") ? "å–®é¸" : "å¤šé¸";
                              const req = (g.required===true) ? "å¿…é¸" : "å¯ä¸é¸";
                              const cnt = Array.isArray(g.options)?g.options.length:0;
                              return `${g.name}ï¼ˆ${t} / ${req} / ${cnt}é …ï¼‰`;
                            }).join("ï¼›"))}
                          </div>
                        ` : ``}
                      </div>
                    </div>

                    <div class="inline" style="justify-content:flex-end">
                      <button class="btn danger" data-del-menu="${esc(m.id)}" type="button">åˆªé™¤</button>
                    </div>
                  </div>
                `;
              }).join("")}
            </div>
          </details>
        `;
      }).join("");

      // åˆªé™¤é¤é»
      wrap.querySelectorAll("button[data-del-menu]").forEach(btn=>{
        btn.onclick = async ()=>{
          const mid = btn.dataset.delMenu;
          if(!confirm("ç¢ºå®šåˆªé™¤æ­¤é¤é»ï¼Ÿ")) return;
          try{
            await deleteDoc(doc(db, "restaurants", selectedRestaurantId, "menu", mid));
            await loadMenu(selectedRestaurantId);
            renderMenuList();
          }catch(err){
            console.error("delete menu failed:", err);
            alert("åˆªé™¤é¤é»å¤±æ•—ï¼ˆRules/ç¶²è·¯ï¼‰\n\n" + (err?.message || err));
          }
        };
      });

      // âœ… é¡åˆ¥å…§æ‹–æ›³æ’åº
      Array.from(map.entries()).forEach(([cat, items], ci)=>{
        const listId = `menuDnD_${ci}_${cat.replace(/\s/g,"_")}`;
        const container = document.getElementById(listId);
        if(!container) return;

        enableSortable(
          container,
          ".draggableItem",
          (el)=> el.dataset.mid,
          async (ids)=> await saveMenuOrderForCategory(cat, ids)
        );
      });
    }

    // ===== Staff =====
    async function saveStaffOrder(dept, ids){
      // ids: staff doc ids
      try{
        setStatus("å„²å­˜äººå“¡æ’åºä¸­â€¦");
        for(let i=0;i<ids.length;i++){
          await updateDoc(doc(db, "staff", ids[i]), { order: i*10 });
        }
        setStatus("äººå“¡æ’åºå·²å„²å­˜ âœ…");
        await loadStaff();
      }catch(err){
        console.error(err);
        setStatus("äººå“¡æ’åºå„²å­˜å¤±æ•—", false);
        alert("äººå“¡æ’åºå„²å­˜å¤±æ•—ï¼ˆRules/ç¶²è·¯ï¼‰\n\n" + (err?.message || err));
      }
    }

    async function loadStaff(){
      try{
        setStatus("è¼‰å…¥äººå“¡ä¸­â€¦");
        const snap = await getDocs(colStaff);
        const map = {}; // dept -> [{id,name,order}]
        snap.forEach(d=>{
          const v = d.data() || {};
          const dept = (v.dept || "æœªåˆ†éƒ¨é–€").trim();
          const name = (v.name || "").trim();
          if(!name) return;
          const order = Number.isFinite(Number(v.order)) ? Number(v.order) : (Number(v.createdAt||0) || 0);
          if(!map[dept]) map[dept] = [];
          map[dept].push({ id:d.id, name, order });
        });

        Object.keys(map).forEach(k=> map[k].sort((a,b)=> (a.order-b.order) || a.name.localeCompare(b.name,"zh-Hant")));
        const depts = Object.keys(map).sort((a,b)=> a.localeCompare(b,"zh-Hant"));

        const wrap = $("staffWrap");
        if(depts.length===0){
          wrap.innerHTML = `<div class="muted">å°šç„¡äººå“¡ã€‚</div>`;
        }else{
          wrap.innerHTML = depts.map((dept,di)=>{
            const listId = `staffDnD_${di}_${dept.replace(/\s/g,"_")}`;
            return `
              <!-- âœ… é è¨­æ”¶åˆï¼šæ‹¿æ‰ open -->
              <details class="box">
                <summary>
                  <b>${esc(dept)}</b>
                  <span class="tag" style="margin-left:8px">${map[dept].length} äºº</span>
                  <span class="muted" style="margin-left:8px">ï¼ˆå±•é–‹å¾Œå¯æ‹–æ›³æ’åºï¼‰</span>
                </summary>
                <div style="margin-top:10px" id="${esc(listId)}">
                  ${map[dept].map(p=>`
                    <div class="draggableItem" draggable="true" data-sid="${esc(p.id)}">
                      <div class="inline" style="gap:10px">
                        <span class="dragHandle" title="æ‹–æ›³æ’åº">â˜°</span>
                        <b>${esc(p.name)}</b>
                      </div>
                      <button class="btn danger" data-del-staff="${esc(p.id)}" type="button">åˆªé™¤</button>
                    </div>
                  `).join("")}
                </div>
              </details>
            `;
          }).join("");

          // åˆªé™¤äººå“¡
          wrap.querySelectorAll("button[data-del-staff]").forEach(btn=>{
            btn.onclick = async ()=>{
              const id = btn.dataset.delStaff;
              if(!confirm("ç¢ºå®šåˆªé™¤æ­¤äººå“¡ï¼Ÿ")) return;
              try{
                await deleteDoc(doc(db, "staff", id));
                await loadStaff();
              }catch(err){
                console.error(err);
                alert("åˆªé™¤äººå“¡å¤±æ•—ï¼ˆRules/ç¶²è·¯ï¼‰\n\n" + (err?.message || err));
              }
            };
          });

          // æ‹–æ›³æ’åºï¼ˆæ¯å€‹ dept å„ä¸€å€‹å®¹å™¨ï¼‰
          depts.forEach((dept,di)=>{
            const listId = `staffDnD_${di}_${dept.replace(/\s/g,"_")}`;
            const container = document.getElementById(listId);
            if(!container) return;
            enableSortable(
              container,
              ".draggableItem",
              (el)=> el.dataset.sid,
              async (ids)=> await saveStaffOrder(dept, ids)
            );
          });
        }

        setStatus("äººå“¡è¼‰å…¥å®Œæˆ âœ…");
      }catch(err){
        console.error("loadStaff failed:", err);
        setStatus("äººå“¡è®€å–å¤±æ•—", false);
        alert("äººå“¡è®€å–å¤±æ•—ï¼ˆRules/ç¶²è·¯ï¼‰\n\n" + (err?.message || err));
      }
    }

    async function addStaff(){
      const dept = ($("staffDept").value || "").trim();
      const name = ($("staffName").value || "").trim();
      if(!dept) return alert("è«‹è¼¸å…¥éƒ¨é–€");
      if(!name) return alert("è«‹è¼¸å…¥äººå“¡å§“å");

      try{
        setStatus("æ–°å¢äººå“¡ä¸­â€¦");
        await addDoc(colStaff, { dept, name, createdAt: Date.now(), order: 999999 });
        $("staffName").value = "";
        await loadStaff();
        setStatus("æ–°å¢äººå“¡å®Œæˆ âœ…");
      }catch(err){
        console.error("addStaff failed:", err);
        setStatus("æ–°å¢äººå“¡å¤±æ•—", false);
        alert("æ–°å¢äººå“¡å¤±æ•—ï¼ˆRules/ç¶²è·¯ï¼‰\n\n" + (err?.message || err));
      }
    }

    // ===== Orders (Query + Excel) =====
    function fmtTime(ms){
      if(!ms) return "";
      const d = new Date(ms);
      const pad = (n)=> String(n).padStart(2,"0");
      return `${d.getFullYear()}-${pad(d.getMonth()+1)}-${pad(d.getDate())} ${pad(d.getHours())}:${pad(d.getMinutes())}`;
    }
    function periodOf(ms){
      const d = new Date(ms||0);
      return d.getHours() < 12 ? "noon" : "night";
    }

    function optionText(optionGroups, chosen){
      const groups = Array.isArray(optionGroups) ? optionGroups : [];
      const pick = chosen || {};
      const out = [];
      for (let gi=0; gi<groups.length; gi++){
        const g = groups[gi] || {};
        if ((g.type || "single") !== "single") continue;
        const idx = Number(pick[gi]);
        const name = (g.name || "").trim();
        if (!Number.isFinite(idx) || idx < 0) continue;
        const opt = (Array.isArray(g.options) ? g.options : [])[idx];
        if (!opt) continue;
        const p = Number(opt.price || 0);
        out.push(`${name ? (name+"ï¼š") : ""}${opt.name || ""}${p ? (" +"+p) : ""}`);
      }
      return out.join("ï¼›");
    }
    function addonText(addons){
      const list = Array.isArray(addons) ? addons : [];
      return list.map(a=>{
        const p = (a && a.free) ? 0 : Number(a.price||0);
        return `+${a.name||""}${(a && a.free) ? "(å…è²»)" : (p?(" "+p):"")}`;
      }).join("ï¼›");
    }
    function calcItemLine(it){
      const base = Number(it.price||0);
      const addonSum = (it.addons||[]).reduce((s,a)=> s + ((a && a.free) ? 0 : Number(a.price||0)), 0);
      const og = Array.isArray(it.optionGroups) ? it.optionGroups : [];
      const chosen = it.chosenOptions || {};
      let optSum = 0;
      for(let gi=0; gi<og.length; gi++){
        const g = og[gi] || {};
        if((g.type||"single") !== "single") continue;
        const idx = Number(chosen[gi]);
        if(!Number.isFinite(idx) || idx < 0) continue;
        const opt = (Array.isArray(g.options)?g.options:[])[idx];
        if(!opt) continue;
        optSum += Number(opt.price||0);
      }
      const qty = Number(it.qty||0);
      const unit = base + addonSum + optSum;
      const lineTotal = unit * qty;
      return { unit, lineTotal, addonSum, optSum };
    }

    async function queryOrders(){
      const qDate = ($("qDate").value || "").trim();
      const qRid = ($("qRestaurant").value || "").trim();
      const qName = ($("qName").value || "").trim();
      const qPeriod = ($("qPeriod").value || "").trim();

      try{
        setStatus("æŸ¥è©¢ä¸­â€¦");
        let snap;
        if(qDate){
          snap = await getDocs(query(colOrders, where("orderDate","==", qDate), limit(3000)));
        }else{
          snap = await getDocs(query(colOrders, limit(3000)));
        }

        const rows = [];
        snap.forEach(d=> rows.push({ id:d.id, ...d.data() }));

        const filtered = rows.filter(o=>{
          if(qRid && o.restaurantId !== qRid) return false;
          if(qName && !(String(o.userName||"").includes(qName))) return false;
          if(qPeriod){
            if(periodOf(Number(o.createdAt||0)) !== qPeriod) return false;
          }
          return true;
        }).sort((a,b)=> Number(b.createdAt||0) - Number(a.createdAt||0));

        renderOrders(filtered);
        setStatus("å·²æŸ¥è©¢ âœ…");
      }catch(err){
        console.error("queryOrders failed:", err);
        setStatus("æŸ¥è©¢å¤±æ•—", false);
        alert("æŸ¥è©¢å¤±æ•—ï¼ˆRules/ç¶²è·¯ï¼‰\n\n" + (err?.message || err));
      }
    }

    function renderOrders(list){
      const wrap = $("ordersWrap");
      if(list.length===0){
        wrap.innerHTML = `<div class="muted">å°šç„¡è³‡æ–™ã€‚</div>`;
        return;
      }
      wrap.innerHTML = list.map(o=>{
        const items = Array.isArray(o.items) ? o.items : [];
        const lines = items.map(it=>{
          const optTxt = optionText(it.optionGroups, it.chosenOptions);
          const addTxt = addonText(it.addons);
          const calc = calcItemLine(it);
          return `
            â€¢ <b>${esc(it.name||"")}</b>ã€€
            å–®åƒ¹ï¼š${Number(it.price||0)}
            ${optTxt?`ï¼ˆé¸é … +${calc.optSum}ï¼‰`:``}
            ${addTxt?`ï¼ˆåŠ è³¼ +${calc.addonSum}ï¼‰`:``}
            Ã— ${Number(it.qty||0)}
            â†’ å°è¨ˆï¼š${calc.lineTotal}
            ${it.note?`ï¼ˆå‚™è¨»ï¼š${esc(it.note)}ï¼‰`:``}
            ${optTxt?`<div class="muted" style="margin-top:4px">ã€€ã€€é¸é …ï¼š${esc(optTxt)}</div>`:``}
            ${addTxt?`<div class="muted" style="margin-top:4px">ã€€ã€€åŠ è³¼ï¼š${esc(addTxt)}</div>`:``}
          `;
        }).join("<br/>");

        return `
          <div class="listLine">
            <div class="inline" style="justify-content:space-between">
              <div>
                <b>${esc(o.userDept||"")}</b> / <b>${esc(o.userName||"")}</b>
                â€” <span class="tag">${esc(o.restaurantName||"")}</span>
                ${o.orderDate ? `<span class="tag" style="margin-left:6px">${esc(o.orderDate)}</span>` : ``}
                <span class="tag" style="margin-left:6px">${periodOf(Number(o.createdAt||0))==="noon"?"ä¸­åˆ":"æ™šä¸Š"}</span>
              </div>
              <span class="tag">ç¸½é¡ï¼š${Number(o.total||0)}</span>
            </div>
            <div class="muted" style="margin-top:8px">${lines}</div>
            ${(o.orderNote||o.remark) ? `<div class="muted" style="margin-top:8px">æ•´ç­†å‚™è¨»ï¼š${esc(o.orderNote||o.remark)}</div>` : ``}
            <div class="muted" style="margin-top:8px">å»ºç«‹æ™‚é–“ï¼š${esc(fmtTime(Number(o.createdAt||0)))}</div>
          </div>
        `;
      }).join("");
    }

    async function exportOrdersExcel(){
      if(!window.XLSX) return alert("Excel åŒ¯å‡ºå…ƒä»¶æœªè¼‰å…¥ï¼ˆXLSXï¼‰");

      const qDate = ($("qDate").value || "").trim();
      const qRid = ($("qRestaurant").value || "").trim();
      const qName = ($("qName").value || "").trim();
      const qPeriod = ($("qPeriod")?.value || "").trim();

      try{
        setStatus("åŒ¯å‡ºä¸­â€¦");

        let snap;
        if(qDate){
          snap = await getDocs(query(colOrders, where("orderDate","==", qDate), limit(3000)));
        }else{
          snap = await getDocs(query(colOrders, limit(3000)));
        }

        const rows = [];
        snap.forEach(d=> rows.push({ id:d.id, ...d.data() }));

        const filtered = rows.filter(o=>{
          if(qRid && o.restaurantId !== qRid) return false;
          if(qName && !(String(o.userName||"").includes(qName))) return false;
          if(qPeriod){
            if(periodOf(Number(o.createdAt||0)) !== qPeriod) return false;
          }
          return true;
        }).sort((a,b)=> Number(a.createdAt||0) - Number(b.createdAt||0));

        if(filtered.length === 0){
          setStatus("ç„¡è³‡æ–™å¯åŒ¯å‡º", false);
          return alert("ç›®å‰ç¯©é¸æ¢ä»¶ä¸‹æ²’æœ‰è³‡æ–™å¯åŒ¯å‡º");
        }

        const detail = [];
        for(const o of filtered){
          const items = Array.isArray(o.items) ? o.items : [];
          for(const it of items){
            const optTxt = optionText(it.optionGroups, it.chosenOptions);
            const addTxt = addonText(it.addons);
            const calc = calcItemLine(it);

            detail.push({
              "è¨‚å–®æ—¥æœŸ": o.orderDate || "",
              "å»ºç«‹æ™‚é–“": fmtTime(Number(o.createdAt||0)),
              "æ™‚æ®µ": periodOf(Number(o.createdAt||0)) === "noon" ? "ä¸­åˆ" : "æ™šä¸Š",
              "éƒ¨é–€": o.userDept || "",
              "å§“å": o.userName || "",
              "åº—å®¶": o.restaurantName || "",
              "å“é …": it.name || "",
              "é¸é …": optTxt || "",
              "åŠ è³¼": addTxt || "",
              "å–®å“å‚™è¨»": it.note || "",
              "æ•¸é‡": Number(it.qty||0),
              "åŸå–®åƒ¹": Number(it.price||0),
              "é¸é …åŠ åƒ¹": Number(calc.optSum||0),
              "åŠ è³¼åŠ åƒ¹": Number(calc.addonSum||0),
              "å°è¨ˆå–®åƒ¹": Number(calc.unit||0),
              "å“é …å°è¨ˆ": Number(calc.lineTotal||0),
              "æ•´ç­†å‚™è¨»": (o.orderNote || o.remark) ? (o.orderNote || o.remark) : "",
              "è¨‚å–®ç¸½é¡": Number(o.total||0),
            });
          }
        }

        const sumMap = new Map();
        for(const r of detail){
          const key = `${r["éƒ¨é–€"]}__${r["å§“å"]}`;
          if(!sumMap.has(key)) sumMap.set(key, { "éƒ¨é–€": r["éƒ¨é–€"], "å§“å": r["å§“å"], "é‡‘é¡å°è¨ˆ": 0 });
          sumMap.get(key)["é‡‘é¡å°è¨ˆ"] += Number(r["å“é …å°è¨ˆ"]||0);
        }
        const byPerson = Array.from(sumMap.values())
          .sort((a,b)=> (a["éƒ¨é–€"]+a["å§“å"]).localeCompare(b["éƒ¨é–€"]+b["å§“å"], "zh-Hant"));

        const deptMap = new Map();
        for(const p of byPerson){
          const d = p["éƒ¨é–€"] || "æœªåˆ†éƒ¨é–€";
          if(!deptMap.has(d)) deptMap.set(d, { "éƒ¨é–€": d, "é‡‘é¡å°è¨ˆ": 0 });
          deptMap.get(d)["é‡‘é¡å°è¨ˆ"] += Number(p["é‡‘é¡å°è¨ˆ"]||0);
        }
        const byDept = Array.from(deptMap.values())
          .sort((a,b)=> a["éƒ¨é–€"].localeCompare(b["éƒ¨é–€"], "zh-Hant"));

        const grandTotal = byPerson.reduce((s,x)=> s + Number(x["é‡‘é¡å°è¨ˆ"]||0), 0);
        byDept.push({ "éƒ¨é–€": "â€”", "é‡‘é¡å°è¨ˆ": "" });
        byDept.push({ "éƒ¨é–€": "ç¸½è¨ˆ", "é‡‘é¡å°è¨ˆ": grandTotal });

        const wb = XLSX.utils.book_new();
        XLSX.utils.book_append_sheet(wb, XLSX.utils.json_to_sheet(detail), "æ˜ç´°");
        XLSX.utils.book_append_sheet(wb, XLSX.utils.json_to_sheet(byPerson), "äººå“¡åŠ ç¸½");
        XLSX.utils.book_append_sheet(wb, XLSX.utils.json_to_sheet(byDept), "éƒ¨é–€åŠ ç¸½");

        const shopName = qRid ? ($("qRestaurant").selectedOptions?.[0]?.textContent || "Shop") : "AllShops";
        const filename = `Orders_${qDate||"AllDates"}_${shopName}_${qPeriod?(qPeriod==="noon"?"Noon":"Night"):"AllDay"}`.replace(/[\\/:*?"<>|]/g, "-") + ".xlsx";
        XLSX.writeFile(wb, filename);

        setStatus("åŒ¯å‡ºå®Œæˆ âœ…");
      }catch(err){
        console.error("exportOrdersExcel failed:", err);
        setStatus("åŒ¯å‡ºå¤±æ•—", false);
        alert("åŒ¯å‡ºå¤±æ•—ï¼ˆRules/ç¶²è·¯ï¼‰\n\n" + (err?.message || err));
      }
    }

    // ===== Events / Buttons =====
    $("restaurantSelect").onchange = async ()=>{
      const rid = $("restaurantSelect").value;
      await loadRestaurantDoc(rid);
    };

    $("rVisible").onchange = saveRestaurantFlags;
    $("rClosed").onchange = saveRestaurantFlags;

    $("btnReloadRestaurants").onclick = ()=> loadRestaurants(true);
    $("btnAddRestaurant").onclick = addRestaurant;
    $("btnDeleteRestaurant").onclick = deleteRestaurant;

    $("btnAddStaff").onclick = addStaff;
    $("btnReloadStaff").onclick = loadStaff;
    $("staffName").addEventListener("keydown", (e)=>{
      if(e.key === "Enter"){ e.preventDefault(); addStaff(); }
    });

    $("btnQuery").onclick = queryOrders;
    $("btnToday").onclick = ()=>{
      $("qDate").value = todayISO();
      queryOrders();
    };
    $("btnExportExcel").onclick = exportOrdersExcel;

    // âœ… qName Enter ç›´æ¥æŸ¥è©¢
    $("qName").addEventListener("keydown",(e)=>{
      if(e.key==="Enter"){ e.preventDefault(); queryOrders(); }
    });

    $("btnGoUser").onclick = ()=>{
      localStorage.setItem(roleKey, "user");
      location.href = "./user.html";
    };
    $("btnLogout").onclick = ()=>{
      localStorage.removeItem(roleKey);
      location.href = "./index.html";
    };

    // âœ… æ–°å¢é¤å»³ Enter ç›´æ¥æ–°å¢ï¼ˆåœ¨åç¨±è¼¸å…¥æ¡†ï¼‰
    $("newRName").addEventListener("keydown",(e)=>{
      if(e.key==="Enter"){ e.preventDefault(); addRestaurant(); }
    });

    // ===== Init =====
    $("qDate").value = todayISO();
    setStatus("å·²é€£ç·š Firestore âœ…");
    await loadRestaurants(false);
    await loadStaff();
    await queryOrders();

    document.addEventListener("visibilitychange", async ()=>{
      if(document.visibilityState === "visible"){
        await loadRestaurants(true);
        if(selectedRestaurantId) await loadRestaurantDoc(selectedRestaurantId);
      }
    });
  </script>
</body>
</html>
