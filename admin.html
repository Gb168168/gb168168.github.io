<!doctype html>
<html lang="zh-Hant">
<head>
<meta charset="utf-8"/>
<title>Excel åŒ¯å‡ºæ¸¬è©¦ï¼ˆä¿è­‰å¯ä¸‹è¼‰ï¼‰</title>

<!-- SheetJS -->
<script src="https://cdn.jsdelivr.net/npm/xlsx@0.19.3/dist/xlsx.full.min.js"></script>

<style>
body{font-family:sans-serif;padding:20px}
button{padding:10px 14px;font-size:15px}
</style>
</head>
<body>

<h2>æ­·å²ç´€éŒ„ / Excel åŒ¯å‡ºï¼ˆç©©å®šç‰ˆï¼‰</h2>

<button id="btnQuery">æŸ¥è©¢ï¼ˆæ¨¡æ“¬ï¼‰</button>
<button id="btnExport">åŒ¯å‡º Excel</button>

<pre id="log"></pre>

<script>
/* =========================
   1ï¸âƒ£ æ¨¡æ“¬æŸ¥è©¢çµæœï¼ˆé‡é»ï¼‰
   æŸ¥è©¢å¾Œä¸€å®šè¦å­˜åœ¨å…¨åŸŸ
========================= */
window.__lastOrdersResult = [];

// æ¨¡æ“¬æŸ¥è©¢ï¼ˆç­‰åŒä½ ç¾åœ¨çš„ queryOrdersï¼‰
document.getElementById("btnQuery").onclick = ()=>{
  const mock = [
    {
      orderDate:"2025-12-13",
      userDept:"é£Ÿç®¡",
      userName:"å¤§é ­",
      restaurantName:"è€å‘çš„åº—",
      total:65,
      items:[
        { name:"ç‚’é£¯", price:65, qty:1, addons:[] }
      ]
    }
  ];

  window.__lastOrdersResult = mock;
  log("âœ… å·²æŸ¥è©¢ï¼Œç­†æ•¸ï¼š" + mock.length);
};

/* =========================
   2ï¸âƒ£ åŒ¯å‡ºï¼ˆå®Œå…¨åŒæ­¥ï¼‰
   âŒ æ²’æœ‰ await
   âŒ æ²’æœ‰ Firestore
========================= */
document.getElementById("btnExport").onclick = ()=>{
  if(!window.XLSX){
    alert("XLSX æœªè¼‰å…¥");
    return;
  }

  const list = window.__lastOrdersResult || [];
  if(list.length === 0){
    alert("æ²’æœ‰è³‡æ–™å¯åŒ¯å‡º");
    return;
  }

  const rows = [];
  for(const o of list){
    for(const it of o.items){
      rows.push({
        "æ—¥æœŸ": o.orderDate,
        "éƒ¨é–€": o.userDept,
        "å§“å": o.userName,
        "åº—å®¶": o.restaurantName,
        "å“é …": it.name,
        "å–®åƒ¹": it.price,
        "æ•¸é‡": it.qty,
        "å°è¨ˆ": it.price * it.qty,
        "è¨‚å–®ç¸½é¡": o.total
      });
    }
  }

  const wb = XLSX.utils.book_new();
  const ws = XLSX.utils.json_to_sheet(rows);
  XLSX.utils.book_append_sheet(wb, ws, "æ˜ç´°");

  // âœ… é—œéµï¼šåŒæ­¥ writeFile
  XLSX.writeFile(wb, "orders.xlsx");

  log("ğŸ“¥ Excel å·²ä¸‹è¼‰");
};

function log(t){
  document.getElementById("log").textContent += t + "\n";
}
</script>

</body>
</html>
