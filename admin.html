<script type="module">
  // Firebase CDN
  import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.0/firebase-app.js";
  import {
    getFirestore,
    collection,
    addDoc,
    getDocs
  } from "https://www.gstatic.com/firebasejs/11.0.0/firebase-firestore.js";

  // 你的 Firebase 設定
  const firebaseConfig = {
    apiKey: "AIzaSyBdgOddTGAfqlLhnnaJRv2_y7gyweuQEo",
    authDomain: "goldbricks-order.firebaseapp.com",
    projectId: "goldbricks-order",
    storageBucket: "goldbricks-order.appspot.com",
    messagingSenderId: "463709758954",
    appId: "1:463709758954:web:429dc920f2f812d51cbe93",
    measurementId: "G-YQK8ZCC26R"
  };

  // 初始化 Firebase
  const app = initializeApp(firebaseConfig);
  const db = getFirestore(app);

  console.log("Firebase 已成功連線");

  // ===== 以下是原本的 admin.js，改成用 Firestore 存資料 =====

  // 角色檢查：不是 admin 就踢回登入頁
  (function checkAdmin() {
    const role = localStorage.getItem('gb_role');
    if (role !== 'admin') {
      window.location.href = 'index.html';
    }
  })();

  let staffData = [];
  let restaurants = [];
  let menuItems = [];

  // 側邊漢堡
  const menuToggle = document.getElementById('menuToggle');
  const sideMenu   = document.getElementById('sideMenu');
  menuToggle.addEventListener('click', () => {
    sideMenu.classList.toggle('open');
  });

  // 側邊主選單：切換 section
  const mainMenuBtns = document.querySelectorAll('#mainMenu button');
  const sections = document.querySelectorAll('.section');
  mainMenuBtns.forEach(btn => {
    btn.addEventListener('click', () => {
      mainMenuBtns.forEach(b => b.classList.remove('active'));
      btn.classList.add('active');
      const targetId = btn.dataset.target;
      sections.forEach(sec => {
        sec.classList.toggle('active', sec.id === targetId);
      });
      sideMenu.classList.remove('open');
    });
  });

  // 切換到使用者模式
  document.getElementById('switchUserBtn').addEventListener('click', () => {
    localStorage.setItem('gb_role', 'user');
    window.location.href = 'user.html';
  });

  // 登出
  document.getElementById('logoutBtn').addEventListener('click', () => {
    localStorage.removeItem('gb_role');
    window.location.href = 'index.html';
  });

  // 新增人員 + 刪除（目前仍暫存在前端，可之後再串 Firestore）
  const deptInput  = document.getElementById('deptInput');
  const staffInput = document.getElementById('staffInput');
  const staffList  = document.getElementById('staffList');

  document.getElementById('addStaffBtn')?.addEventListener('click', () => {
    const dept  = deptInput.value.trim();
    const staff = staffInput.value.trim();
    if (!dept || !staff) {
      alert('請輸入部門與人員姓名');
      return;
    }
    staffData.push({ id: Date.now(), dept, staff });
    deptInput.value = '';
    staffInput.value = '';
    renderStaff();
  });

  function renderStaff() {
    staffList.innerHTML = '';
    staffData.forEach(item => {
      const pill = document.createElement('div');
      pill.className = 'pill';
      pill.innerHTML = `
        <span>${item.dept} - ${item.staff}</span>
        <button type="button">✕</button>
      `;
      pill.querySelector('button').addEventListener('click', () => {
        const idx = staffData.findIndex(s => s.id === item.id);
        if (idx !== -1) staffData.splice(idx, 1);
        renderStaff();
      });
      staffList.appendChild(pill);
    });
  }

  // 餐廳資料
  const restName = document.getElementById('restName');
  const restPhone= document.getElementById('restPhone');
  const restAddr = document.getElementById('restAddr');
  const restNote = document.getElementById('restNote');
  const restMap  = document.getElementById('restMap');
  const restImg  = document.getElementById('restImg');
  const restList = document.getElementById('restList');
  const menuRestSelect = document.getElementById('menuRestSelect');

  // 從 Firestore 載入餐廳
  async function loadRestaurantsFromDB() {
    restaurants = [];
    const snap = await getDocs(collection(db, "restaurants"));
    snap.forEach(docSnap => {
      restaurants.push({
        id: docSnap.id,
        ...docSnap.data()
      });
    });
    renderRestaurants();
    syncRestaurantSelect();
  }

  // 新增餐廳按鈕 → 存到 Firestore
  document.getElementById('addRestBtn')?.addEventListener('click', () => {
    const name = restName.value.trim();
    if (!name) { alert('餐廳名稱為必填'); return; }

    const data = {
      name,
      phone: restPhone.value.trim(),
      addr : restAddr.value.trim(),
      note : restNote.value.trim(),
      map  : restMap.value.trim(),
      img  : null
    };

    const file = restImg.files[0];
    if (file) {
      const reader = new FileReader();
      reader.onload = e => {
        data.img = e.target.result;
        pushRestaurantToDB(data);
      };
      reader.readAsDataURL(file);
    } else {
      pushRestaurantToDB(data);
    }
  });

  // 寫入 Firestore 並更新畫面
  function pushRestaurantToDB(r) {
    addDoc(collection(db, "restaurants"), r)
      .then(docRef => {
        r.id = docRef.id;
        restaurants.push(r);
        clearRestaurantInputs();
        renderRestaurants();
        syncRestaurantSelect();
      })
      .catch(err => {
        console.error(err);
        alert('儲存餐廳失敗，請稍後再試');
      });
  }

  function clearRestaurantInputs() {
    restName.value='';
    restPhone.value='';
    restAddr.value='';
    restNote.value='';
    restMap.value='';
    restImg.value='';
  }

  function renderRestaurants() {
    restList.innerHTML = '';
    restaurants.forEach((r, idx) => {
      const card = document.createElement('div');
      card.className = 'rest-card';

      const img = document.createElement('img');
      img.className = 'rest-thumb';
      if (r.img) img.src = r.img; else img.alt = 'no image';

      const info = document.createElement('div');
      info.style.flex = '1';
      info.innerHTML = `
        <div class="rest-name">${r.name}</div>
        <div>${r.phone || ''}</div>
        <div>${r.addr || ''}</div>
        <div class="section-sub" style="margin-top:2px;">${r.note || ''}</div>
      `;

      const btns = document.createElement('div');
      const up = document.createElement('button');
      up.className = 'btn-mini';
      up.textContent = '上移';
      up.onclick = () => moveRestaurant(idx, -1);
      const down = document.createElement('button');
      down.className = 'btn-mini';
      down.textContent = '下移';
      down.onclick = () => moveRestaurant(idx, 1);
      btns.appendChild(up);
      btns.appendChild(down);

      card.appendChild(img);
      card.appendChild(info);
      card.appendChild(btns);
      restList.appendChild(card);
    });
  }

  function moveRestaurant(i, dir) {
    const j = i + dir;
    if (j < 0 || j >= restaurants.length) return;
    const tmp = restaurants[i];
    restaurants[i] = restaurants[j];
    restaurants[j] = tmp;
    renderRestaurants();
    syncRestaurantSelect();
  }

  function syncRestaurantSelect() {
    menuRestSelect.innerHTML = '';
    if (!restaurants.length) {
      const op = document.createElement('option');
      op.value = '';
      op.textContent = '請先在上方新增餐廳';
      menuRestSelect.appendChild(op);
      return;
    }
    restaurants.forEach(r => {
      const op = document.createElement('option');
      op.value = r.id;
      op.textContent = r.name;
      menuRestSelect.appendChild(op);
    });
  }

  // 搜尋餐廳
  const searchInput = document.getElementById('globalSearch');
  const searchBtn   = document.getElementById('searchBtn');

  function doSearch() {
    const keyword = searchInput.value.trim().toLowerCase();
    document.querySelectorAll('.rest-card').forEach(card => {
      const nameEl = card.querySelector('.rest-name');
      if (!nameEl) return;
      const text = nameEl.textContent.toLowerCase();
      const match = !keyword || text.includes(keyword);
      card.style.display = match ? 'flex' : 'none';
      nameEl.style.color = match && keyword ? '#38bdf8' : '#e5e7eb';
    });
  }

  searchBtn.addEventListener('click', doSearch);
  searchInput.addEventListener('keydown', e => {
    if (e.key === 'Enter') {
      e.preventDefault();
      doSearch();
    }
  });

  // 加購項目
  const addonBox = document.getElementById('addonBox');

  function addAddonRow() {
    const row = document.createElement('div');
    row.className = 'addon-row';

    const name = document.createElement('input');
    name.type = 'text';
    name.placeholder = '加購名稱（蛋 / 加麵）';

    const price = document.createElement('input');
    price.type = 'number';
    price.min = '0';
    price.placeholder = '加價金額';

    const right = document.createElement('div');
    right.innerHTML = `
      <label style="font-size:11px;color:var(--text-soft);display:flex;align-items:center;gap:4px;">
        <input type="checkbox" class="addon-free"> 免費
      </label>
      <button type="button" class="btn-mini">刪除</button>
    `;
    const freeChk = right.querySelector('.addon-free');
    freeChk.onchange = () => {
      if (freeChk.checked) {
        price.value = '';
        price.disabled = true;
      } else {
        price.disabled = false;
      }
    };
    right.querySelector('button').onclick = () => row.remove();

    row.appendChild(name);
    row.appendChild(price);
    row.appendChild(right);
    addonBox.appendChild(row);
  }

  document.getElementById('addAddonBtn').addEventListener('click', addAddonRow);
  addAddonRow(); // 先一列

  // 餐點管理
  const menuCat  = document.getElementById('menuCat');
  const menuName = document.getElementById('menuName');
  const menuPrice= document.getElementById('menuPrice');
  const menuQty  = document.getElementById('menuQty');
  const menuTableBody = document.getElementById('menuTableBody');

  // 從 Firestore 載入餐點
  async function loadMenuItemsFromDB() {
    menuItems = [];
    const snap = await getDocs(collection(db, "menuItems"));
    snap.forEach(docSnap => {
      menuItems.push({
        id: docSnap.id,
        ...docSnap.data()
      });
    });
    renderMenuTable();
  }

  // 新增餐點 → Firestore
  document.getElementById('addMenuBtn').addEventListener('click', () => {
    const restId = menuRestSelect.value;
    if (!restId) { alert('請先選擇餐廳'); return; }
    const rest = restaurants.find(r => String(r.id) === String(restId));
    const cat  = menuCat.value.trim();
    const name = menuName.value.trim();
    const price= Number(menuPrice.value);
    const qty  = Number(menuQty.value || 1);
    if (!name || isNaN(price)) {
      alert('請填寫餐點名稱與價格');
      return;
    }

    const addons = [];
    addonBox.querySelectorAll('.addon-row').forEach(row => {
      const inputs = row.querySelectorAll('input');
      const aName  = inputs[0].value.trim();
      const aPrice = Number(inputs[1].value || 0);
      const aFree  = row.querySelector('.addon-free').checked;
      if (!aName) return;
      addons.push({
        name: aName,
        price: aFree ? 0 : aPrice,
        free : aFree
      });
    });

    const item = {
      restId,
      restName: rest ? rest.name : '',
      cat,
      name,
      price,
      qty,
      addons
    };

    addDoc(collection(db, "menuItems"), item)
      .then(docRef => {
        menuItems.push({ id: docRef.id, ...item });
        renderMenuTable();

        // 清空輸入（保留餐廳）
        menuCat.value = '';
        menuName.value = '';
        menuPrice.value = '';
        menuQty.value = 1;
        addonBox.innerHTML = '';
        addAddonRow();
      })
      .catch(err => {
        console.error(err);
        alert('儲存餐點失敗，請稍後再試');
      });
  });

  function renderMenuTable() {
    menuTableBody.innerHTML = '';
    menuItems.forEach(item => {
      const tr = document.createElement('tr');
      const addonText = item.addons && item.addons.length
        ? item.addons.map(a => a.free ? `${a.name}(免費)` : `${a.name}+${a.price}`).join('、')
        : '-';

      tr.innerHTML = `
        <td>${item.restName}</td>
        <td>${item.cat || '-'}</td>
        <td>${item.name}</td>
        <td class="text-right">${item.price}</td>
        <td class="text-right">${item.qty}</td>
        <td>${addonText}</td>
      `;
      menuTableBody.appendChild(tr);
    });
  }

  // 一進頁面就從 Firestore 把餐廳 & 餐點抓回來
  loadRestaurantsFromDB();
  loadMenuItemsFromDB();
</script>
</body>
</html>
