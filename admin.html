<!DOCTYPE html>
<html lang="zh-Hant">
<head>
<meta charset="UTF-8">
<title>管理者後台</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<style>
/* ===== 基本樣式（精簡版） ===== */
*{box-sizing:border-box}
body{margin:0;font-family:system-ui;background:#f5f4fb}
.app{display:grid;grid-template-columns:240px 1fr;min-height:100vh}
.side{background:#111827;color:#fff;padding:16px}
.side button{width:100%;margin-bottom:6px;padding:10px;border:none;border-radius:10px;background:#1f2937;color:#fff;cursor:pointer}
.side button.active{background:#fb7185}
.main{padding:16px}
.card{background:#fff;border-radius:16px;padding:16px;margin-bottom:16px;box-shadow:0 8px 25px rgba(0,0,0,.08)}
.grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(220px,1fr));gap:12px}
input,textarea{width:100%;padding:8px;border-radius:10px;border:1px solid #d1d5db}
.btn{padding:8px 14px;border:none;border-radius:999px;background:#fb7185;color:#fff;cursor:pointer}
.btn.secondary{background:#e5e7eb;color:#111}
.btn.danger{background:#ef4444}
.item{background:#f9fafb;border-radius:12px;padding:10px;margin-bottom:8px}
.muted{font-size:12px;color:#6b7280}
.restaurant-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(180px,1fr));gap:14px}
.restaurant-card{background:#f9fafb;border-radius:12px;padding:10px;cursor:pointer}
.restaurant-card img{width:100%;height:120px;object-fit:cover;border-radius:10px}
</style>
</head>

<body>
<div class="app">
  <aside class="side">
    <button id="navAdd" class="active">新增餐廳</button>
    <button id="navManage">餐廳管理</button>
    <button id="navLogout">登出</button>
  </aside>

  <main class="main">

    <!-- 新增餐廳 -->
    <section id="viewAdd">
      <div class="card">
        <h3>店家資訊</h3>
        <div class="grid">
          <input id="rName" placeholder="餐廳名稱">
          <input id="rPhone" placeholder="電話">
          <input id="rAddress" placeholder="地址">
          <input id="rMap" placeholder="Google map 連結">
          <input id="rImage" type="file" accept="image/*">
          <textarea id="rNote" placeholder="備註"></textarea>
        </div>
      </div>

      <div class="card">
        <h3>新增餐點（草稿）</h3>
        <div class="grid">
          <input id="mCategory" placeholder="餐點類別">
          <input id="mName" placeholder="餐點名稱">
          <input id="mPrice" type="number" placeholder="價格">
          <input id="mQty" type="number" value="1">
        </div>
        <button class="btn secondary" id="btnAddMenuDraft">加入此餐點到清單</button>
        <div id="menuDraftList" class="muted"></div>
        <button class="btn" id="btnCreateRestaurant">新增店家</button>
      </div>
    </section>

    <!-- 餐廳管理 -->
    <section id="viewManage" style="display:none">
      <div class="card">
        <h3>餐廳管理（點圖片）</h3>
        <div class="restaurant-grid" id="restaurantGrid"></div>
      </div>
    </section>

  </main>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js";
import { getFirestore, collection, addDoc, getDocs, query, where, deleteDoc, doc, writeBatch } 
from "https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore.js";
import { getStorage, ref, uploadBytes, getDownloadURL } 
from "https://www.gstatic.com/firebasejs/9.23.0/firebase-storage.js";

/* ===== Firebase 設定（換成你的） ===== */
const firebaseConfig = {
  apiKey: "YOUR_KEY",
  authDomain: "YOUR_DOMAIN",
  projectId: "YOUR_ID",
  storageBucket: "YOUR_BUCKET",
  appId: "YOUR_APPID"
};

const app = initializeApp(firebaseConfig);
const db = getFirestore(app);
const storage = getStorage(app);

/* ===== 切頁 ===== */
const viewAdd = document.getElementById("viewAdd");
const viewManage = document.getElementById("viewManage");
navAdd.onclick = ()=>{viewAdd.style.display="block";viewManage.style.display="none";}
navManage.onclick = async ()=>{viewAdd.style.display="none";viewManage.style.display="block";await loadRestaurants();}
navLogout.onclick = ()=>{localStorage.removeItem("role");location.href="index.html";}

/* ===== 新增餐廳 ===== */
let menuDraft = [];
btnAddMenuDraft.onclick = ()=>{
  if(!mName.value||!mCategory.value||!mPrice.value){
    alert("請填完整餐點");
    return;
  }
  menuDraft.push({
    category:mCategory.value,
    name:mName.value,
    price:Number(mPrice.value),
    defaultQty:Number(mQty.value||1),
    addons:[]
  });
  mCategory.value=mName.value=mPrice.value="";
  renderDraft();
};

function renderDraft(){
  menuDraftList.innerHTML = menuDraft.map(m=>`${m.category}｜${m.name} $${m.price}`).join("<br>");
}

async function uploadImage(file){
  if(!file) return "";
  const r = ref(storage,"restaurants/"+Date.now()+"_"+file.name);
  await uploadBytes(r,file);
  return await getDownloadURL(r);
}

/* ===== C 方案：永遠可按，按下才檢查 ===== */
btnCreateRestaurant.onclick = async ()=>{
  const missing=[];
  if(!rName.value.trim()) missing.push("餐廳名稱");
  if(menuDraft.length===0) missing.push("至少一個餐點（請按加入）");
  if(missing.length){
    alert("無法新增店家，缺少：\n- "+missing.join("\n- "));
    return;
  }

  const imageUrl = await uploadImage(rImage.files[0]||null);

  const restRef = await addDoc(collection(db,"restaurants"),{
    name:rName.value,
    phone:rPhone.value,
    address:rAddress.value,
    map:rMap.value,
    note:rNote.value,
    imageUrl
  });

  const batch = writeBatch(db);
  menuDraft.forEach(m=>{
    const d = doc(collection(db,"menus"));
    batch.set(d,{...m,restaurantId:restRef.id});
  });
  await batch.commit();

  alert("新增完成");
  location.reload();
};

/* ===== 餐廳管理 ===== */
async function loadRestaurants(){
  const snap = await getDocs(collection(db,"restaurants"));
  restaurantGrid.innerHTML = snap.docs.map(d=>{
    const r=d.data();
    return `<div class="restaurant-card">
      <img src="${r.imageUrl||""}">
      <b>${r.name}</b>
    </div>`;
  }).join("");
}
</script>
</body>
</html>
