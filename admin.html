<!doctype html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>GoldBricks å‘·å¥”ğŸ‘½~ï½œç®¡ç†è€…</title>

  <!-- Drag & Drop -->
  <script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.2/Sortable.min.js"></script>

  <!-- Excelï¼ˆSheetJSï¼‰â€» å…ˆæ”¾ä¸€å€‹ï¼Œä¸‹é¢ JS ä¹Ÿæœƒã€Œè‡ªå‹•è£œè¼‰å…¥ã€é¿å… XLSX æœªè¼‰å…¥ -->
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.19.3/dist/xlsx.full.min.js"></script>

  <style>
    :root{
      --bg:#eef2f8;
      --panel:#f6f8fd;
      --card:#ffffff;

      --text:#0b1220;
      --muted:#55657b;

      --primary:#fb7185;
      --primary2:#ff9a9e;

      --border:rgba(15,23,42,.10);
      --border2:rgba(15,23,42,.16);

      --shadow:0 12px 34px rgba(2,6,23,.10);
      --radius:18px;

      --navBg:#f2f5ff;
      --navActiveBg:rgba(99,102,241,.10);
      --navActiveBorder:rgba(99,102,241,.55);

      --focus:rgba(251,113,133,.55);

      --good:#16a34a;
      --bad:#ef4444;
      --warn:#f59e0b;
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      font-family: ui-sans-serif, system-ui, -apple-system, "Segoe UI", Arial;
      background:
        radial-gradient(1200px 520px at 18% -12%, rgba(251,113,133,.12), transparent 60%),
        radial-gradient(900px 520px at 110% 0%, rgba(99,102,241,.10), transparent 55%),
        linear-gradient(180deg, #f6f8fd 0%, var(--bg) 60%, #eef2f8 100%);
      color:var(--text);
      min-height:100vh;
    }
    .wrap{max-width:1320px; margin:0 auto; padding:16px;}
    .topbar{
      position: sticky;
      top: 0;
      z-index: 50;
      background: rgba(255,255,255,.90);
      border:1px solid var(--border);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      backdrop-filter: blur(10px);
      padding:12px 14px;
      display:flex; align-items:center; justify-content:space-between; gap:12px;
    }
    .topbar h1{font-size:18px; margin:0}
    .topbar .right{display:flex; gap:10px; align-items:center; flex-wrap:wrap}
    .pill{padding:8px 12px; border-radius:999px; border:1px solid var(--border2); background:#fff; color:var(--muted); font-size:12.5px}
    .btn{
      padding:9px 12px; border-radius:14px; border:1px solid var(--border2);
      background:#fff; cursor:pointer; font-weight:900;
    }
    .btn:hover{filter:brightness(.98)}
    .primary{
      padding:9px 12px; border-radius:14px; border:none; cursor:pointer; font-weight:900;
      background: linear-gradient(90deg, var(--primary), var(--primary2));
      color:#fff; box-shadow: 0 14px 28px rgba(251,113,133,.18);
    }
    .primary:hover{filter:saturate(1.04)}
    .btn:disabled,.primary:disabled{opacity:.55; cursor:not-allowed}

    .grid{display:grid; grid-template-columns: 310px 1fr; gap:14px; margin-top:14px}
    @media (max-width:980px){.grid{grid-template-columns:1fr}}

    .card{
      background:var(--card);
      border:1px solid var(--border);
      border-radius:var(--radius);
      box-shadow: 0 10px 26px rgba(2,6,23,.06);
      padding:14px;
    }
    .panel{
      background:var(--panel);
      border:1px solid var(--border);
      border-radius:var(--radius);
      box-shadow: 0 10px 22px rgba(2,6,23,.05);
      padding:14px;
    }
    .card h2{margin:0 0 10px; font-size:15px}

    label{display:block; font-size:13px; color:var(--muted); margin:10px 0 6px;}
    input,select,textarea{
      width:100%; padding:11px 12px; border-radius:14px;
      border:1px solid var(--border2); outline:none; background:#fff;
      font-size:14px;
    }
    textarea{min-height:92px; resize:vertical}
    input:focus,select:focus,textarea:focus{border-color: var(--focus); box-shadow:0 0 0 4px rgba(251,113,133,.10)}

    .row{display:grid; grid-template-columns: 1fr 1fr; gap:10px}
    @media (max-width:720px){.row{grid-template-columns:1fr}}
    .muted{color:var(--muted); font-size:12.5px; line-height:1.6}
    .hr{height:1px; background: var(--border); margin:12px 0}
    .tag{display:inline-flex; padding:5px 10px; border-radius:999px; border:1px solid var(--border2); background:#fff; color:var(--muted); font-size:12px}
    .inline{display:flex; gap:10px; align-items:center; flex-wrap:wrap}
    .danger{border-color: rgba(239,68,68,.42)}
    .okTag{border-color: rgba(22,163,74,.35)}
    .warnTag{border-color: rgba(245,158,11,.40)}

    .navCard{
      background: var(--navBg);
      border:1px solid var(--border);
      border-radius:var(--radius);
      box-shadow: 0 10px 24px rgba(2,6,23,.06);
      padding:14px;
    }
    .navBtn{
      width:100%; text-align:left; padding:10px 12px;
      border-radius:14px; border:1px solid var(--border2);
      background:#fff; cursor:pointer; font-weight:900;
      display:flex; justify-content:space-between; align-items:center;
    }
    .navBtn.active{
      border-color: var(--navActiveBorder);
      background: var(--navActiveBg);
      box-shadow:0 10px 18px rgba(99,102,241,.12);
    }

    .section{display:none;}
    .section.active{display:block;}

    details > summary{
      cursor:pointer;
      list-style:none;
      user-select:none;
      padding:8px 10px;
      border-radius:12px;
    }
    details > summary::-webkit-details-marker{display:none}
    details summary:hover{background: rgba(2,6,23,.03)}
    .box{
      border:1px solid rgba(15,23,42,.10);
      border-radius:16px;
      padding:12px;
      background:#fff;
      margin-top:10px;
    }
    .listLine{
      border:1px solid rgba(15,23,42,.10);
      border-radius:14px;
      padding:10px 12px;
      background:#fff;
      margin-top:10px;
    }

    /* Drag UI */
    .dragItem{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      padding:10px 12px;
      border:1px solid rgba(15,23,42,.10);
      border-radius:14px;
      background:#fff;
      margin-top:10px;
    }
    .dragLeft{display:flex; align-items:center; gap:10px; min-width:0}
    .dragHandle{
      cursor:grab;
      opacity:.55;
      font-weight:900;
      user-select:none;
    }
    .dragItem:hover .dragHandle{opacity:1}
    .dragTitle{font-weight:900; white-space:nowrap; overflow:hidden; text-overflow:ellipsis}
    .ghost{opacity:.45}
    .chosen{box-shadow:0 12px 24px rgba(2,6,23,.10)}
    .dragRight{display:flex; gap:8px; align-items:center; flex-wrap:wrap}

    .tinyBtn{
      padding:7px 10px;
      border-radius:12px;
      border:1px solid var(--border2);
      background:#fff;
      cursor:pointer;
      font-weight:900;
      font-size:12.5px;
    }
    .tinyBtn:hover{filter:brightness(.98)}
    .tinyDanger{border-color: rgba(239,68,68,.42)}
    .hintBar{
      display:flex; align-items:center; justify-content:space-between; gap:10px;
      background: rgba(2,6,23,.03);
      border:1px dashed rgba(15,23,42,.16);
      border-radius:14px;
      padding:10px 12px;
      margin-top:10px;
    }

    /* âœ… ç·¨è¼¯é¤é»ï¼šå…§åµŒç·¨è¼¯å€ */
    .editBox{
      border:1px dashed rgba(15,23,42,.18);
      background: rgba(2,6,23,.02);
      border-radius:16px;
      padding:12px;
      margin-top:10px;
      display:none;
    }
    .editBox.show{display:block;}

    /* âœ… ç›´è¦ºåŠ è³¼ç·¨è¼¯ UI */
    .groupCard{
      border:1px solid rgba(15,23,42,.12);
      border-radius:16px;
      padding:12px;
      background:#fff;
      margin-top:10px;
    }
    .groupHead{
      display:flex; align-items:center; justify-content:space-between; gap:10px;
    }
    .groupHead b{font-size:13.5px}
    .groupOps{display:flex; gap:8px; align-items:center; flex-wrap:wrap}
    .small{
      font-size:12px;
      padding:7px 10px;
      border-radius:12px;
      border:1px solid var(--border2);
      background:#fff;
      cursor:pointer;
      font-weight:900;
    }
    .small:hover{filter:brightness(.98)}
    .smallDanger{border-color: rgba(239,68,68,.42)}
    .itemRow{
      border:1px dashed rgba(15,23,42,.16);
      border-radius:14px;
      padding:10px;
      background: rgba(2,6,23,.02);
      margin-top:10px;
    }
  </style>
</head>

<body>
  <div class="wrap">
    <div class="topbar">
      <div>
        <h1>ç®¡ç†è€…å¾Œå°</h1>
        <div class="muted" id="whoLine">å°šæœªé¸æ“‡é¤å»³</div>
      </div>
      <div class="right">
        <span class="pill" id="statusPill">é€£ç·šä¸­â€¦</span>
        <button class="btn" id="btnGoUser">å›ä½¿ç”¨è€…</button>
        <button class="btn" id="btnLogout">ç™»å‡º</button>
      </div>
    </div>

    <div class="grid">
      <!-- LEFT NAV -->
      <div class="navCard">
        <div class="inline" style="justify-content:space-between">
          <b>åŠŸèƒ½</b>
          <span class="tag">Admin</span>
        </div>
        <div class="hr"></div>
        <button class="navBtn active" data-tab="tabRestaurants"><span>é»é¤ç®¡ç†</span><span class="tag">ğŸ½ï¸</span></button>
        <button class="navBtn" data-tab="tabStaff"><span>äººå“¡ç®¡ç†</span><span class="tag">â›‘ï¸</span></button>
        <button class="navBtn" data-tab="tabOrders"><span>æ­·å²ç´€éŒ„ / åŒ¯å‡º</span><span class="tag">ğŸ“ƒ</span></button>
        <div class="hr"></div>
        <div class="muted">æç¤ºï¼šè®€å–å¤±æ•—å¤šåŠæ˜¯ Rules / ç¶²è·¯ / Firebase è¨­å®šã€‚</div>

        <div class="hr"></div>

        <!-- âœ… åº—å®¶åˆ—è¡¨ï¼ˆå¯æ‹–æ›³æ’åº / é è¨­æ”¶åˆï¼‰ -->
        <details class="panel" id="restaurantSortPanel">
          <summary class="inline" style="justify-content:space-between">
            <div class="inline">
              <b>åº—å®¶åˆ—è¡¨ï¼ˆå¯æ‹–æ›³æ’åºï¼‰</b>
              <span class="tag" id="restCountTag">0 é–“</span>
            </div>
            <span class="tag">æ”¶åˆ</span>
          </summary>
          <div class="muted" style="margin-top:8px">æ‹–æ›³å¾Œè‡ªå‹•å„²å­˜</div>
          <div id="restaurantsSortList" style="margin-top:8px"></div>
        </details>
      </div>

      <!-- RIGHT CONTENT -->
      <div>
        <!-- TAB: RESTAURANTS / MENU -->
        <div class="section active" id="tabRestaurants">
          <div class="card">
            <h2>1ï¼‰é¤å»³æ¸…å–®ï¼ˆé¸æ“‡å¾Œç®¡ç†é¤é»/é¡åˆ¥/ç‹€æ…‹ï¼‰</h2>

            <div class="row">
              <div>
                <label>é¸æ“‡é¤å»³</label>
                <select id="restaurantSelect">
                  <option value="">è¼‰å…¥ä¸­â€¦</option>
                </select>
                <div class="muted" style="margin-top:6px">æç¤ºï¼šé¤å»³é¸å–®æ’åºè·Ÿå·¦å´ã€Œåº—å®¶æ‹–æ›³æ’åºã€ä¸€è‡´ã€‚</div>
              </div>
              <div class="inline" style="align-self:end; justify-content:flex-end">
                <button class="btn" id="btnReloadRestaurants">é‡æ–°è¼‰å…¥</button>
                <button class="btn danger" id="btnDeleteRestaurant">åˆªé™¤é¤å»³</button>
              </div>
            </div>

            <div class="hr"></div>

            <div class="row">
              <div>
                <label>é¡¯ç¤ºçµ¦ä½¿ç”¨è€…ï¼ˆisVisibleï¼‰</label>
                <select id="rVisible">
                  <option value="true">é¡¯ç¤º</option>
                  <option value="false">éš±è—</option>
                </select>
              </div>
              <div>
                <label>çµå–®ï¼ˆisClosedï¼‰</label>
                <select id="rClosed">
                  <option value="false">é–‹å–®ä¸­</option>
                  <option value="true">å·²çµå–®</option>
                </select>
              </div>
            </div>

            <div class="inline" style="margin-top:10px">
              <button class="primary" id="btnSaveRestaurantFlags">å„²å­˜ç‹€æ…‹</button>
              <span class="muted" id="restaurantFlagHint"></span>
            </div>
          </div>

          <!-- âœ… é¤å»³è³‡è¨Šï¼šå¯ç·¨è¼¯ï¼ˆEnter/blur è‡ªå‹•å­˜ï¼‰ -->
          <div class="card" style="margin-top:14px">
            <h2>1-2ï¼‰é¤å»³è³‡è¨Šï¼ˆå¯ç·¨è¼¯ï¼‰</h2>
            <div id="restaurantEditWrap" class="muted">è«‹å…ˆé¸æ“‡é¤å»³ã€‚</div>
          </div>

          <div class="card" style="margin-top:14px">
            <h2>2ï¼‰æ–°å¢é¤å»³ï¼ˆEnter ä¹Ÿå¯æ–°å¢ï¼‰</h2>

            <div class="row">
              <div>
                <label>é¤å»³åç¨±</label>
                <input id="newRName" placeholder="ä¾‹ï¼šXXä¾¿ç•¶"/>
              </div>
              <div>
                <label>é¤å»³åœ–ç‰‡ URLï¼ˆå¯ç©ºï¼‰</label>
                <input id="newRImg" placeholder="https://..."/>
              </div>
            </div>

            <div class="row">
              <div>
                <label>åœ°å€ï¼ˆå¯ç©ºï¼‰</label>
                <input id="newRAddr" placeholder="ä¾‹ï¼šå°ä¸­å¸‚..."/>
              </div>
              <div>
                <label>é›»è©±ï¼ˆå¯ç©ºï¼‰</label>
                <input id="newRPhone" placeholder="ä¾‹ï¼š04-..."/>
              </div>
            </div>

            <label>Google Map é€£çµï¼ˆå¯ç©ºï¼‰</label>
            <input id="newRMap" placeholder="https://maps.google.com/..."/>

            <div class="inline" style="margin-top:12px">
              <button class="primary" id="btnAddRestaurant">æ–°å¢é¤å»³</button>
              <span class="muted">æ–°å¢å¾Œæœƒå»ºç«‹ã€Œé¤é»é¡åˆ¥ã€ç¾¤çµ„ã€‚</span>
            </div>
          </div>

          <div class="card" style="margin-top:14px">
            <h2>3ï¼‰é¡åˆ¥ç®¡ç†</h2>
            <div id="catMgrWrap" class="muted">è«‹å…ˆé¸æ“‡é¤å»³ã€‚</div>
          </div>

          <div class="card" style="margin-top:14px">
            <h2>4ï¼‰æ–°å¢é¤é»ï¼ˆé¡åˆ¥ä¸‹æ‹‰ï¼‰</h2>
            <div id="menuAddWrap" class="muted">è«‹å…ˆé¸æ“‡é¤å»³ã€‚</div>

            <div class="hr"></div>
            <h2 style="margin-top:0">5ï¼‰é¤é»æ¸…å–®ï¼ˆé¡åˆ¥å…§å¯æ‹–æ›³æ’åºï¼‹è‡ªå‹•å„²å­˜ï¼‰</h2>
            <div class="muted" style="margin-top:-6px">
              âœ… å·²å¥—ç”¨ï¼šé¤é»ã€ŒåŠ è³¼ addonGroupsã€æ”¹æˆç›´è¦ºè¼¸å…¥ï¼ˆä¸æ˜¯ JSON åƒæ•¸ï¼‰ã€‚
              <br/>âŒ å·²ç§»é™¤ï¼šé¸é … optionGroupsï¼ˆä¸‹æ‹‰ / å¯åŠ åƒ¹ï¼‰åŠŸèƒ½ï¼ˆæ–°å¢/ç·¨è¼¯/è¨ˆç®—/åŒ¯å‡ºéƒ½ä¸å†ä½¿ç”¨ï¼‰ã€‚
            </div>
            <div id="menuList" class="muted">å°šæœªé¸æ“‡é¤å»³ã€‚</div>
          </div>
        </div>

        <!-- TAB: STAFF -->
        <div class="section" id="tabStaff">
          <div class="card">
            <h2>äººå“¡ç®¡ç†ï¼ˆéƒ¨é–€ / äººå“¡ï¼‰</h2>

            <div class="row">
              <div>
                <label>éƒ¨é–€</label>
                <input id="staffDept" placeholder="ä¾‹ï¼šå·¥ç¨‹éƒ¨"/>
              </div>
              <div>
                <label>äººå“¡å§“åï¼ˆEnter ç›´æ¥æ–°å¢ï¼‰</label>
                <input id="staffName" placeholder="ä¾‹ï¼šå°æ˜"/>
              </div>
            </div>

            <div class="inline" style="margin-top:12px">
              <button class="primary" id="btnAddStaff">æ–°å¢äººå“¡</button>
              <button class="btn" id="btnReloadStaff">é‡æ–°è¼‰å…¥</button>
            </div>

            <div class="hr"></div>
            <div class="hintBar">
              <div class="muted">éƒ¨é–€é è¨­æ”¶åˆï¼›å±•é–‹å¾Œå¯æ‹–æ›³æ’åºï¼ˆè‡ªå‹•å„²å­˜ï¼‰ã€‚</div>
              <span class="tag">ä¸é¡¯ç¤ºé †åºè™Ÿç¢¼</span>
            </div>
            <div id="staffWrap" class="muted" style="margin-top:10px">è¼‰å…¥ä¸­â€¦</div>
          </div>
        </div>

        <!-- TAB: ORDERS -->
        <div class="section" id="tabOrders">
          <div class="card">
            <h2>æ­·å²ç´€éŒ„ï¼ˆæŸ¥è©¢ / Excel åŒ¯å‡ºï¼‰</h2>
            <div class="muted" style="margin-top:-6px">
              âœ… å·²ä¿®ï¼šè‹¥è·³å‡ºã€ŒExcel åŒ¯å‡ºå…ƒä»¶æœªè¼‰å…¥ï¼ˆXLSXï¼‰ã€ï¼Œæœƒè‡ªå‹•è£œè¼‰å…¥ï¼Œè¼‰å…¥å®Œæˆæ‰å¯åŒ¯å‡ºã€‚
            </div>

            <div class="row" style="margin-top:10px">
              <div>
                <label>æ—¥æœŸ</label>
                <input id="qDate" type="date"/>
              </div>
              <div>
                <label>åº—å®¶</label>
                <select id="qRestaurant">
                  <option value="">å…¨éƒ¨</option>
                </select>
              </div>
            </div>

            <label>è¼¸å…¥åç¨±ï¼ˆäººå“¡ï¼‰</label>
            <input id="qName" placeholder="ä¾‹ï¼šå°æ˜"/>

            <div class="inline" style="margin-top:12px">
              <button class="primary" id="btnQuery">æŸ¥è©¢</button>
              <button class="btn" id="btnToday">ğŸ²</button>

              <select id="qPeriod" style="width:auto; min-width:140px">
                <option value="">å…¨éƒ¨æ™‚æ®µ</option>
                <option value="noon">ä¸­åˆï¼ˆ12:00å‰ï¼‰</option>
                <option value="night">æ™šä¸Šï¼ˆ12:00å¾Œï¼‰</option>
              </select>

              <button class="btn" id="btnExportExcel" disabled>åŒ¯å‡º Excel</button>
              <span class="muted" id="xlsxHint"></span>
            </div>

            <div class="hr"></div>
            <div id="ordersWrap" class="muted">å°šç„¡è³‡æ–™ã€‚</div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <script type="module">
    // ===== Role Gate =====
    const roleKey = "gb_role";
    if (!localStorage.getItem(roleKey)) localStorage.setItem(roleKey, "admin");
    if (localStorage.getItem(roleKey) !== "admin") location.href = "./index.html";

    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-app.js";
    import {
      getFirestore, collection, addDoc, doc, getDocs, getDoc, updateDoc,
      deleteDoc, query, where, limit
    } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyBdgOddTGAfqqHLnhnaJRv2_y7gyweuQEo",
      authDomain: "goldbricks-order.firebaseapp.com",
      projectId: "goldbricks-order",
      storageBucket: "goldbricks-order.firebasestorage.app",
      messagingSenderId: "463709758954",
      appId: "1:463709758954:web:429dc920f2f812d51cbe93",
      measurementId: "G-YQK8ZCC26R"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    const $ = (id)=> document.getElementById(id);
    const statusPill = $("statusPill");
    const esc = (s)=> (s??"").toString()
      .replaceAll("&","&amp;").replaceAll("<","&lt;").replaceAll(">","&gt;").replaceAll('"',"&quot;");

    const todayISO = ()=>{
      const d = new Date(); const pad = (n)=> String(n).padStart(2,"0");
      return `${d.getFullYear()}-${pad(d.getMonth()+1)}-${pad(d.getDate())}`;
    };

    const ORDER_GAP = 100;

    // ===== Collections =====
    const colStaff = collection(db, "staff");
    const colRestaurants = collection(db, "restaurants");
    const colOrders = collection(db, "orders");

    // ===== State =====
    let restaurants = [];
    let selectedRestaurantId = "";
    let selectedRestaurant = null;
    let menuCache = [];

    // ===== Tabs =====
    document.querySelectorAll(".navBtn").forEach(btn=>{
      btn.onclick = ()=>{
        document.querySelectorAll(".navBtn").forEach(b=> b.classList.remove("active"));
        btn.classList.add("active");
        const tab = btn.dataset.tab;
        document.querySelectorAll(".section").forEach(s=> s.classList.remove("active"));
        document.getElementById(tab).classList.add("active");
      };
    });

    function setWhoLine(){
      $("whoLine").innerHTML = selectedRestaurantId
        ? `<span class="tag">åº—å®¶</span> <b style="margin-left:6px">${esc(selectedRestaurant?.name || "")}</b>`
        : `å°šæœªé¸æ“‡é¤å»³`;
    }

    // ===== âœ… CategoryGroupsï¼ˆä¸é è¨­ä»»ä½•é¡åˆ¥ï¼‰ =====
    function ensureCategoryGroups(obj){
      const cur = Array.isArray(obj?.categoryGroups) ? obj.categoryGroups : null;
      if(cur && cur.length > 0) return cur;

      return [{
        name: "é¤é»é¡åˆ¥",
        type: "single",
        required: true,
        options: [] // {name, order}
      }];
    }
    function getCategoryGroup(){
      const groups = ensureCategoryGroups(selectedRestaurant || {});
      const g0 = groups[0] || { name:"é¤é»é¡åˆ¥", type:"single", required:true, options:[] };
      if(!Array.isArray(g0.options)) g0.options = [];
      g0.options = g0.options.map((o,i)=> ({ name: o?.name||"", order: Number.isFinite(Number(o?.order)) ? Number(o.order) : (i*ORDER_GAP) }));
      groups[0] = g0;
      return { groups, g0 };
    }
    async function saveCategoryGroups(groups){
      if(!selectedRestaurantId) return;
      await updateDoc(doc(db, "restaurants", selectedRestaurantId), { categoryGroups: groups });
      await loadRestaurantDoc(selectedRestaurantId);
      await loadRestaurants();
    }

    // ===== âœ… Enter/blur auto-save helper =====
    function bindEnterBlurSave(el, saver){
      if(!el) return;
      el.addEventListener("keydown", (e)=>{
        if(e.key === "Enter"){
          e.preventDefault();
          saver();
          el.blur();
        }
      });
      el.addEventListener("blur", ()=> saver());
    }

    // ===== âœ… XLSX loaderï¼ˆä¿®ä½ é‡åˆ°çš„ã€ŒXLSX æœªè¼‰å…¥ã€ï¼‰ =====
    async function ensureXLSX(){
      const hint = $("xlsxHint");
      const btn = $("btnExportExcel");

      const ok = ()=> {
        if(hint) hint.textContent = "Excel å…ƒä»¶å·²å°±ç·’ âœ…";
        if(btn) btn.disabled = false;
      };
      const bad = (msg)=> {
        if(hint) hint.textContent = msg || "Excel å…ƒä»¶è¼‰å…¥å¤±æ•—";
        if(btn) btn.disabled = true;
      };

      if(window.XLSX){
        ok();
        return true;
      }

      if(hint) hint.textContent = "è¼‰å…¥ Excel å…ƒä»¶ä¸­â€¦";
      if(btn) btn.disabled = true;

      const load = (src)=> new Promise((resolve, reject)=>{
        const s = document.createElement("script");
        s.src = src;
        s.async = true;
        s.onload = ()=> resolve(true);
        s.onerror = ()=> reject(new Error("load failed: " + src));
        document.head.appendChild(s);
      });

      // å…ˆè£œè¼‰å…¥ä¸€æ¬¡ï¼ˆè·Ÿä¸Šé¢ script åŒæºï¼Œä½†é¿å… CDN/å¿«å–é€ æˆ window.XLSX æ²’æ›ä¸Šï¼‰
      try{
        await load("https://cdn.jsdelivr.net/npm/xlsx@0.19.3/dist/xlsx.full.min.js");
        if(window.XLSX){ ok(); return true; }
      }catch(e){}

      // fallbackï¼šunpkg
      try{
        await load("https://unpkg.com/xlsx@0.19.3/dist/xlsx.full.min.js");
        if(window.XLSX){ ok(); return true; }
      }catch(e){}

      bad("Excel åŒ¯å‡ºå…ƒä»¶æœªè¼‰å…¥ï¼ˆXLSXï¼‰â€” è«‹ç¢ºèªç¶²è·¯/CDN æ˜¯å¦è¢«æ“‹");
      return false;
    }

    statusPill.textContent = "å·²é€£ç·š Firestore";

    // ===== Restaurants =====
    async function loadRestaurants(){
      try{
        statusPill.textContent = "è¼‰å…¥é¤å»³ä¸­â€¦";
        const snap = await getDocs(colRestaurants);
        const list = [];
        snap.forEach(d=> list.push({ id:d.id, ...d.data() }));

        list.sort((a,b)=>{
          const ao = Number.isFinite(Number(a.order)) ? Number(a.order) : 1e15;
          const bo = Number.isFinite(Number(b.order)) ? Number(b.order) : 1e15;
          if(ao !== bo) return ao - bo;
          const aa = Number(a.createdAt||0), bb = Number(b.createdAt||0);
          if(bb !== aa) return bb - aa;
          return (a.name||"").localeCompare((b.name||""),"zh-Hant");
        });

        restaurants = list;

        const sel = $("restaurantSelect");
        sel.innerHTML = `<option value="">è«‹é¸æ“‡</option>` + restaurants.map(r=>{
          const vis = (r.isVisible !== false);
          const closed = !!r.isClosed;
          const hint = `${vis ? "é¡¯ç¤º" : "éš±è—"} / ${closed ? "å·²çµå–®" : "é–‹å–®ä¸­"}`;
          return `<option value="${esc(r.id)}">${esc(r.name||"æœªå‘½å")}ï¼ˆ${esc(hint)}ï¼‰</option>`;
        }).join("");

        $("qRestaurant").innerHTML = `<option value="">å…¨éƒ¨</option>` + restaurants.map(r=>
          `<option value="${esc(r.id)}">${esc(r.name||"æœªå‘½å")}</option>`
        ).join("");

        renderRestaurantSortList();

        if(selectedRestaurantId && restaurants.find(r=> r.id===selectedRestaurantId)){
          sel.value = selectedRestaurantId;
        }else{
          selectedRestaurantId = "";
          selectedRestaurant = null;
          menuCache = [];
        }

        setWhoLine();
        renderRestaurantFlags();
        renderRestaurantEdit();
        renderCategoryManager();
        renderMenuAdd();
        renderMenuList();

        statusPill.textContent = "é¤å»³è¼‰å…¥å®Œæˆ âœ…";
      }catch(err){
        console.error("loadRestaurants failed:", err);
        statusPill.textContent = "é¤å»³è®€å–å¤±æ•—ï¼ˆçœ‹ consoleï¼‰";
        alert("é¤å»³è®€å–å¤±æ•—ï¼ˆRules/ç¶²è·¯ï¼‰\n\n" + (err?.message || err));
      }
    }

    async function loadRestaurantDoc(rid){
      if(!rid){
        selectedRestaurantId = "";
        selectedRestaurant = null;
        menuCache = [];
        setWhoLine();
        renderRestaurantFlags();
        renderRestaurantEdit();
        renderCategoryManager();
        renderMenuAdd();
        renderMenuList();
        return;
      }
      try{
        statusPill.textContent = "è®€å–é¤å»³è³‡æ–™â€¦";
        const snap = await getDoc(doc(db, "restaurants", rid));
        selectedRestaurantId = rid;
        selectedRestaurant = snap.exists() ? snap.data() : null;

        const fixed = ensureCategoryGroups(selectedRestaurant || {});
        if(!Array.isArray(selectedRestaurant?.categoryGroups) || selectedRestaurant.categoryGroups.length===0){
          try{
            await updateDoc(doc(db, "restaurants", rid), { categoryGroups: fixed });
            const snap2 = await getDoc(doc(db, "restaurants", rid));
            selectedRestaurant = snap2.exists() ? snap2.data() : selectedRestaurant;
          }catch(e){
            console.warn("patch categoryGroups failed:", e);
          }
        }

        setWhoLine(); renderRestaurantFlags(); renderRestaurantEdit(); renderCategoryManager();

        await loadMenu(rid);
        renderMenuAdd(); renderMenuList();

        statusPill.textContent = "å·²é¸æ“‡é¤å»³ âœ…";
      }catch(err){
        console.error("loadRestaurantDoc failed:", err);
        statusPill.textContent = "è®€å–é¤å»³å¤±æ•—ï¼ˆçœ‹ consoleï¼‰";
        alert("è®€å–é¤å»³å¤±æ•—ï¼ˆRules/ç¶²è·¯ï¼‰\n\n" + (err?.message || err));
      }
    }

    async function addRestaurant(){
      const name = ($("newRName").value || "").trim();
      const imageUrl = ($("newRImg").value || "").trim();
      const address = ($("newRAddr").value || "").trim();
      const phone = ($("newRPhone").value || "").trim();
      const mapUrl = ($("newRMap").value || "").trim();
      if(!name) return alert("è«‹è¼¸å…¥é¤å»³åç¨±");

      try{
        statusPill.textContent = "æ–°å¢é¤å»³ä¸­â€¦";
        const maxOrder = restaurants.reduce((m,r)=> Math.max(m, Number.isFinite(Number(r.order)) ? Number(r.order) : 0), 0);
        const payload = {
          name, imageUrl, address, phone, mapUrl,
          isVisible: true,
          isClosed: false,
          createdAt: Date.now(),
          order: (maxOrder + ORDER_GAP),
          categoryGroups: ensureCategoryGroups({})
        };
        const ref = await addDoc(colRestaurants, payload);

        ["newRName","newRImg","newRAddr","newRPhone","newRMap"].forEach(id=> $(id).value="");

        await loadRestaurants();
        $("restaurantSelect").value = ref.id;
        await loadRestaurantDoc(ref.id);

        statusPill.textContent = "æ–°å¢é¤å»³å®Œæˆ âœ…";
      }catch(err){
        console.error("addRestaurant failed:", err);
        statusPill.textContent = "æ–°å¢é¤å»³å¤±æ•—ï¼ˆçœ‹ consoleï¼‰";
        alert("æ–°å¢é¤å»³å¤±æ•—ï¼ˆRules/ç¶²è·¯ï¼‰\n\n" + (err?.message || err));
      }
    }

    ["newRName","newRImg","newRAddr","newRPhone","newRMap"].forEach(id=>{
      $(id).addEventListener("keydown",(e)=>{
        if(e.key==="Enter"){ e.preventDefault(); addRestaurant(); }
      });
    });

    function renderRestaurantFlags(){
      const hint = $("restaurantFlagHint");
      if(!selectedRestaurantId || !selectedRestaurant){
        $("rVisible").disabled = true;
        $("rClosed").disabled = true;
        $("btnSaveRestaurantFlags").disabled = true;
        hint.textContent = "è«‹å…ˆé¸æ“‡é¤å»³";
        return;
      }
      $("rVisible").disabled = false;
      $("rClosed").disabled = false;
      $("btnSaveRestaurantFlags").disabled = false;

      $("rVisible").value = (selectedRestaurant.isVisible !== false) ? "true" : "false";
      $("rClosed").value = (!!selectedRestaurant.isClosed) ? "true" : "false";
      hint.textContent = "";
    }

    async function saveRestaurantFlags(){
      if(!selectedRestaurantId) return;
      try{
        statusPill.textContent = "å„²å­˜é¤å»³ç‹€æ…‹â€¦";
        const isVisible = $("rVisible").value === "true";
        const isClosed = $("rClosed").value === "true";
        await updateDoc(doc(db, "restaurants", selectedRestaurantId), { isVisible, isClosed });
        await loadRestaurantDoc(selectedRestaurantId);
        await loadRestaurants();
        statusPill.textContent = "å„²å­˜å®Œæˆ âœ…";
      }catch(err){
        console.error("saveRestaurantFlags failed:", err);
        statusPill.textContent = "å„²å­˜å¤±æ•—ï¼ˆçœ‹ consoleï¼‰";
        alert("å„²å­˜å¤±æ•—ï¼ˆRules/ç¶²è·¯ï¼‰\n\n" + (err?.message || err));
      }
    }

    // âœ… é¤å»³è³‡è¨Šå¯ç·¨è¼¯ï¼ˆEnter/blur è‡ªå‹•å­˜ï¼‰
    function renderRestaurantEdit(){
      const wrap = $("restaurantEditWrap");
      if(!selectedRestaurantId || !selectedRestaurant){
        wrap.innerHTML = `<div class="muted">è«‹å…ˆé¸æ“‡é¤å»³ã€‚</div>`;
        return;
      }
      const r = selectedRestaurant || {};
      wrap.innerHTML = `
        <div class="row">
          <div>
            <label>é¤å»³åç¨±</label>
            <input id="editRName" value="${esc(r.name||"")}"/>
          </div>
          <div>
            <label>é¤å»³åœ–ç‰‡ URL</label>
            <input id="editRImg" value="${esc(r.imageUrl||"")}"/>
            ${r.imageUrl ? `<div class="muted" style="margin-top:6px">åœ–é€£çµï¼š<a href="${esc(r.imageUrl)}" target="_blank">é–‹å•Ÿ</a></div>` : ``}
          </div>
        </div>

        <div class="row">
          <div>
            <label>åœ°å€</label>
            <input id="editRAddr" value="${esc(r.address||"")}"/>
          </div>
          <div>
            <label>é›»è©±</label>
            <input id="editRPhone" value="${esc(r.phone||"")}"/>
          </div>
        </div>

        <label>Google Map é€£çµ</label>
        <input id="editRMap" value="${esc(r.mapUrl||"")}"/>
        ${r.mapUrl ? `<div class="muted" style="margin-top:6px">Mapï¼š<a href="${esc(r.mapUrl)}" target="_blank">é–‹å•Ÿ</a></div>` : ``}

        <div class="muted" style="margin-top:10px">â€» ä»¥ä¸Šæ¬„ä½ Enter æˆ–é›¢é–‹è¼¸å…¥æ¡†æœƒè‡ªå‹•å„²å­˜ã€‚</div>
      `;

      const saveInfo = async ()=>{
        if(!selectedRestaurantId) return;
        const payload = {
          name: ($("editRName").value||"").trim(),
          imageUrl: ($("editRImg").value||"").trim(),
          address: ($("editRAddr").value||"").trim(),
          phone: ($("editRPhone").value||"").trim(),
          mapUrl: ($("editRMap").value||"").trim(),
        };
        try{
          statusPill.textContent = "å„²å­˜é¤å»³è³‡è¨Šâ€¦";
          await updateDoc(doc(db,"restaurants",selectedRestaurantId), payload);
          await loadRestaurantDoc(selectedRestaurantId);
          await loadRestaurants();
          statusPill.textContent = "å„²å­˜å®Œæˆ âœ…";
        }catch(err){
          console.error(err);
          statusPill.textContent = "å„²å­˜å¤±æ•—";
        }
      };

      ["editRName","editRImg","editRAddr","editRPhone","editRMap"].forEach(id=>{
        bindEnterBlurSave($(id), saveInfo);
      });
    }

    async function deleteRestaurant(){
      if(!selectedRestaurantId) return alert("è«‹å…ˆé¸æ“‡é¤å»³");
      if(!confirm("ç¢ºå®šåˆªé™¤æ­¤é¤å»³ï¼Ÿ\nï¼ˆæ³¨æ„ï¼šå­é›†åˆ menu ä¸æœƒè‡ªå‹•åˆªï¼ŒFirestore éœ€å¦æ¸…ï¼‰")) return;
      try{
        await deleteDoc(doc(db, "restaurants", selectedRestaurantId));
        selectedRestaurantId = "";
        selectedRestaurant = null;
        menuCache = [];
        await loadRestaurants();
        statusPill.textContent = "åˆªé™¤é¤å»³å®Œæˆ âœ…";
      }catch(err){
        console.error("deleteRestaurant failed:", err);
        alert("åˆªé™¤é¤å»³å¤±æ•—ï¼ˆRules/ç¶²è·¯ï¼‰\n\n" + (err?.message || err));
      }
    }

    // ===== âœ… åº—å®¶åˆ—è¡¨ï¼ˆå¯æ‹–æ›³æ’åºï¼‹è‡ªå‹•å„²å­˜ï¼‰ =====
    let restaurantSorter = null;
    function renderRestaurantSortList(){
      const listEl = $("restaurantsSortList");
      $("restCountTag").textContent = `${restaurants.length} é–“`;

      if(restaurants.length === 0){
        listEl.innerHTML = `<div class="muted">å°šç„¡é¤å»³ã€‚</div>`;
        return;
      }

      listEl.innerHTML = restaurants.map(r=>{
        const vis = (r.isVisible !== false);
        const closed = !!r.isClosed;
        const sTag = closed ? `<span class="tag warnTag">å·²çµå–®</span>` : `<span class="tag okTag">é–‹å–®ä¸­</span>`;
        const vTag = vis ? `<span class="tag okTag">é¡¯ç¤º</span>` : `<span class="tag">éš±è—</span>`;
        return `
          <div class="dragItem" data-id="${esc(r.id)}">
            <div class="dragLeft" style="min-width:0">
              <span class="dragHandle">â˜°</span>
              <div style="min-width:0">
                <div class="dragTitle">${esc(r.name||"æœªå‘½å")}</div>
                <div class="muted" style="margin-top:4px">${vTag} ${sTag}</div>
              </div>
            </div>
            <div class="dragRight">
              <button class="tinyBtn" data-pick="${esc(r.id)}">é¸æ“‡</button>
            </div>
          </div>
        `;
      }).join("");

      listEl.querySelectorAll("button[data-pick]").forEach(btn=>{
        btn.onclick = async ()=>{
          const rid = btn.dataset.pick;
          $("restaurantSelect").value = rid;
          await loadRestaurantDoc(rid);
        };
      });

      if(restaurantSorter) restaurantSorter.destroy();
      restaurantSorter = new Sortable(listEl, {
        animation: 150,
        handle: ".dragHandle",
        ghostClass: "ghost",
        chosenClass: "chosen",
        onEnd: async ()=>{
          try{
            statusPill.textContent = "å„²å­˜åº—å®¶æ’åºâ€¦";
            const ids = Array.from(listEl.querySelectorAll(".dragItem")).map(el=> el.dataset.id);
            for(let i=0;i<ids.length;i++){
              await updateDoc(doc(db,"restaurants",ids[i]), { order: i*ORDER_GAP });
            }
            await loadRestaurants();
            statusPill.textContent = "åº—å®¶æ’åºå·²å„²å­˜ âœ…";
          }catch(err){
            console.error(err);
            statusPill.textContent = "åº—å®¶æ’åºå„²å­˜å¤±æ•—";
          }
        }
      });
    }

    // ===== Category Manager (categoryGroups) =====
    let catSorter = null;

    function renderCategoryManager(){
      const wrap = $("catMgrWrap");
      if(!selectedRestaurantId || !selectedRestaurant){
        wrap.innerHTML = `<div class="muted">è«‹å…ˆé¸æ“‡é¤å»³ã€‚</div>`;
        return;
      }

      const { groups, g0 } = getCategoryGroup();
      const opts = (Array.isArray(g0.options) ? g0.options : [])
        .slice()
        .sort((a,b)=> Number(a.order||0) - Number(b.order||0));

      wrap.innerHTML = `
        <div class="inline" style="justify-content:space-between">
          <div>
            <span class="tag">ç¾¤çµ„</span>
            <b style="margin-left:8px">${esc(g0.name || "é¤é»é¡åˆ¥")}</b>
          </div>
          <span class="muted">ï¼ˆæ­¤ç¾¤çµ„ç”¨æ–¼ã€Œæ–°å¢é¤é»ã€çš„é¡åˆ¥ä¸‹æ‹‰ï¼‰</span>
        </div>

        <div class="box" style="margin-top:10px">
          <div class="row">
            <div>
              <label>æ–°å¢é¡åˆ¥ï¼ˆEnter / é›¢é–‹è‡ªå‹•å­˜ï¼‰</label>
              <input id="catNewName" placeholder="ä¾‹ï¼šéºµé¡ / é£¯é¡ / å°èœ"/>
            </div>
            <div class="inline" style="align-self:end; justify-content:flex-end">
              <button class="primary" id="btnAddCategory" type="button">æ–°å¢</button>
            </div>
          </div>

          <div class="hr"></div>

          <details class="panel" id="catCurrentDetails">
            <summary class="inline" style="justify-content:space-between">
              <div class="inline">
                <b>ç›®å‰é¡åˆ¥ï¼ˆå¯æ‹–æ›³æ’åºï¼‰</b>
                <span class="tag">${opts.length} å€‹</span>
              </div>
              <span class="tag">æ”¶åˆ</span>
            </summary>
            <div class="muted" style="margin-top:8px">å±•é–‹å¾Œå¯æ‹–æ›³ï¼›æ‹–æ›³å®Œæˆè‡ªå‹•å„²å­˜ï¼ˆä¸é¡¯ç¤ºé †åºè™Ÿç¢¼ï¼‰ã€‚</div>
            <div id="catSortList" style="margin-top:8px"></div>
          </details>
        </div>
      `;

      const listEl = document.getElementById("catSortList");
      if(opts.length === 0){
        listEl.innerHTML = `<div class="muted" style="margin-top:8px">å°šç„¡é¡åˆ¥ï¼Œè«‹å…ˆæ–°å¢ã€‚</div>`;
      }else{
        listEl.innerHTML = opts.map(o=>`
          <div class="dragItem" data-name="${esc(o.name||"")}">
            <div class="dragLeft" style="min-width:0">
              <span class="dragHandle">â˜°</span>
              <div class="dragTitle">${esc(o.name||"")}</div>
            </div>
            <div class="dragRight">
              <button class="tinyBtn tinyDanger" data-del-cat="${esc(o.name||"")}" type="button">åˆªé™¤</button>
            </div>
          </div>
        `).join("");

        listEl.querySelectorAll("button[data-del-cat]").forEach(btn=>{
          btn.onclick = async ()=>{
            const name = btn.dataset.delCat;
            if(!confirm(`ç¢ºå®šåˆªé™¤æ­¤é¡åˆ¥ï¼Ÿ\nï¼ˆé¡åˆ¥ï¼š${name}ï¼‰`)) return;
            const { groups, g0 } = getCategoryGroup();
            g0.options = (g0.options||[]).filter(x => (x.name||"") !== name);
            g0.options = (g0.options||[]).map((x,i)=> ({ name:x.name, order:i*ORDER_GAP }));
            groups[0]=g0;

            try{
              statusPill.textContent = "åˆªé™¤é¡åˆ¥ä¸­â€¦";
              await saveCategoryGroups(groups);
              renderMenuAdd();
              statusPill.textContent = "åˆªé™¤é¡åˆ¥å®Œæˆ âœ…";
            }catch(err){
              console.error(err);
              alert("åˆªé™¤é¡åˆ¥å¤±æ•—ï¼ˆRules/ç¶²è·¯ï¼‰\n\n" + (err?.message || err));
            }
          };
        });

        if(catSorter) catSorter.destroy();
        catSorter = new Sortable(listEl, {
          animation: 150,
          handle: ".dragHandle",
          ghostClass: "ghost",
          chosenClass: "chosen",
          onEnd: async ()=>{
            try{
              statusPill.textContent = "å„²å­˜é¡åˆ¥æ’åºâ€¦";
              const names = Array.from(listEl.querySelectorAll(".dragItem")).map(el=> el.dataset.name);
              const { groups, g0 } = getCategoryGroup();
              const set = new Set(names);
              const kept = (g0.options||[]).filter(x=> set.has(x.name));
              const newOpts = names.map((n,idx)=>{
                const found = kept.find(x=> x.name===n) || { name:n };
                return { name: found.name, order: idx*ORDER_GAP };
              });
              g0.options = newOpts;
              groups[0]=g0;
              await saveCategoryGroups(groups);
              renderMenuAdd();
              statusPill.textContent = "é¡åˆ¥æ’åºå·²å„²å­˜ âœ…";
            }catch(err){
              console.error(err);
              statusPill.textContent = "é¡åˆ¥æ’åºå„²å­˜å¤±æ•—";
            }
          }
        });
      }

      const addCategory = async ()=>{
        const name = (document.getElementById("catNewName").value || "").trim();
        if(!name) return;
        const { groups, g0 } = getCategoryGroup();
        const cur = Array.isArray(g0.options) ? g0.options : [];
        if(cur.some(x => (x.name||"") === name)) return alert("æ­¤é¡åˆ¥å·²å­˜åœ¨");
        const maxOrder = cur.reduce((m,x)=> Math.max(m, Number(x.order||0)), 0);
        g0.options = [...cur, { name, order: maxOrder + ORDER_GAP }];
        groups[0] = g0;

        try{
          statusPill.textContent = "æ–°å¢é¡åˆ¥ä¸­â€¦";
          await saveCategoryGroups(groups);
          document.getElementById("catNewName").value = "";
          renderMenuAdd();
          statusPill.textContent = "æ–°å¢é¡åˆ¥å®Œæˆ âœ…";
        }catch(err){
          console.error(err);
          alert("æ–°å¢é¡åˆ¥å¤±æ•—ï¼ˆRules/ç¶²è·¯ï¼‰\n\n" + (err?.message || err));
        }
      };

      document.getElementById("btnAddCategory").onclick = addCategory;
      bindEnterBlurSave(document.getElementById("catNewName"), addCategory);
    }

    // ===== Menu =====
    async function loadMenu(rid){
      try{
        statusPill.textContent = "è¼‰å…¥é¤é»ä¸­â€¦";
        const menuCol = collection(db, "restaurants", rid, "menu");
        const snap = await getDocs(menuCol);
        const list = [];
        snap.forEach(d=> list.push({ id:d.id, ...d.data() }));

        list.forEach((m,i)=>{
          if(!Number.isFinite(Number(m.order))) m.order = i*ORDER_GAP;
        });

        list.sort((a,b)=>{
          const ca = (a.category||"").localeCompare((b.category||""),"zh-Hant");
          if(ca !== 0) return ca;
          const ao = Number(a.order||0), bo = Number(b.order||0);
          if(ao !== bo) return ao - bo;
          const aa = Number(a.createdAt||0), bb = Number(b.createdAt||0);
          if(bb !== aa) return bb - aa;
          return (a.name||"").localeCompare((b.name||""),"zh-Hant");
        });

        menuCache = list;
        statusPill.textContent = "é¤é»è¼‰å…¥å®Œæˆ âœ…";
      }catch(err){
        console.error("loadMenu failed:", err);
        statusPill.textContent = "é¤é»è®€å–å¤±æ•—ï¼ˆçœ‹ consoleï¼‰";
        menuCache = [];
      }
    }

    function renderCategoryPickerHTML(){
      const { g0 } = getCategoryGroup();
      const opts = (Array.isArray(g0.options) ? g0.options : [])
        .slice()
        .sort((a,b)=> Number(a.order||0)-Number(b.order||0));
      const req = (g0.required !== false);

      if(opts.length === 0){
        return `
          <div class="panel">
            <div class="inline" style="justify-content:space-between">
              <b>${esc(g0.name || "é¤é»é¡åˆ¥")}</b>
              <span class="tag">${req ? "å¿…é¸" : "å¯ä¸é¸"}</span>
            </div>
            <div class="muted" style="margin-top:6px">å°šç„¡é¡åˆ¥ï¼Œè«‹å…ˆåˆ°ä¸Šæ–¹ã€Œé¡åˆ¥ç®¡ç†ã€æ–°å¢è‡³å°‘ä¸€å€‹é¡åˆ¥ã€‚</div>
          </div>
        `;
      }

      return `
        <div class="panel">
          <div class="inline" style="justify-content:space-between">
            <b>${esc(g0.name || "é¤é»é¡åˆ¥")}</b>
            <span class="tag">${req ? "å¿…é¸" : "å¯ä¸é¸"}</span>
          </div>
          <select id="menuCategorySelect" style="margin-top:8px">
            ${req ? "" : `<option value="-1">ä¸é¸æ“‡</option>`}
            ${opts.map(o=>`<option value="${esc(o.name||"")}">${esc(o.name||"")}</option>`).join("")}
          </select>
          <div class="muted" style="margin-top:6px">â€» æ–°å¢é¤é»æ™‚æœƒæŠŠé¸åˆ°çš„é¡åˆ¥å­˜åˆ° menu.categoryï¼ˆå­—ä¸²ï¼‰</div>
        </div>
      `;
    }

    function getPickedCategoryValue(){
      const sel = document.getElementById("menuCategorySelect");
      if(!sel) return "";
      const v = (sel.value || "").trim();
      return v;
    }

    function renderMenuAdd(){
      const wrap = $("menuAddWrap");
      if(!selectedRestaurantId || !selectedRestaurant){
        wrap.innerHTML = `<div class="muted">è«‹å…ˆé¸æ“‡é¤å»³ã€‚</div>`;
        return;
      }

      wrap.innerHTML = `
        ${renderCategoryPickerHTML()}

        <div class="row" style="margin-top:10px">
          <div>
            <label>é¤é»åç¨±</label>
            <input id="mName" placeholder="ä¾‹ï¼šæ³•å¼ç‚’éºµ"/>
          </div>
          <div>
            <label>åƒ¹æ ¼ï¼ˆå–®ä»½ï¼‰</label>
            <input id="mPrice" type="number" min="0" value="0"/>
          </div>
        </div>

        <div class="row">
          <div>
            <label>é è¨­æ•¸é‡ï¼ˆdefaultQtyï¼‰</label>
            <input id="mDefaultQty" type="number" min="1" value="1"/>
          </div>
          <div>
            <label>å‚™è¨»ï¼ˆå¯ç©ºï¼‰</label>
            <input id="mNote" placeholder="ä¾‹ï¼šå¯èª¿è¾£åº¦"/>
          </div>
        </div>

        <!-- âœ… åŠ è³¼ç¾¤çµ„ -->
        <div class="box">
          <div class="inline" style="justify-content:space-between">
            <b>åŠ è³¼ addonGroupsï¼ˆå¯å–®é¸ / å¤šé¸ / å¯åŠ åƒ¹ï¼‰</b>
            <button class="btn" id="btnAddAddonGroup" type="button">ï¼‹æ–°å¢ä¸€çµ„</button>
          </div>
          <div id="addonGroupsWrap" class="muted" style="margin-top:8px"></div>
        </div>

        <div class="inline" style="margin-top:12px">
          <button class="primary" id="btnAddMenu" type="button">æ–°å¢é¤é»</button>
          <span class="muted">Enter ä¹Ÿå¯æ–°å¢ï¼ˆåœ¨é¤é»åç¨±æ¬„ä½ï¼‰</span>
        </div>
      `;

      document.getElementById("mName").addEventListener("keydown",(e)=>{
        if(e.key==="Enter"){ e.preventDefault(); addMenuItem(); }
      });

      // ===== addonGroups builder =====
      const addonWrap = document.getElementById("addonGroupsWrap");
      addonWrap.innerHTML = `<div class="muted">ï¼ˆå°šç„¡åŠ è³¼ç¾¤çµ„ï¼ŒæŒ‰ã€Œæ–°å¢ä¸€çµ„ã€åŠ å…¥ï¼‰</div>`;
      let addonGroupCount = 0;

      document.getElementById("btnAddAddonGroup").onclick = ()=>{
        addonGroupCount++;
        if(addonGroupCount === 1) addonWrap.innerHTML = "";
        const gid = `ag_${Date.now()}_${Math.random().toString(16).slice(2)}`;

        const groupEl = document.createElement("div");
        groupEl.className = "box";
        groupEl.dataset.gid = gid;

        groupEl.innerHTML = `
          <div class="row">
            <div>
              <label>ç¾¤çµ„åç¨±</label>
              <input data-ag-name placeholder="ä¾‹ï¼šåŠ æ–™ / é£²æ–™åŠ è³¼"/>
            </div>
            <div class="row" style="grid-template-columns:1fr 1fr; gap:10px">
              <div>
                <label>é¸æ“‡æ–¹å¼</label>
                <select data-ag-type>
                  <option value="multi">å¤šé¸</option>
                  <option value="single">å–®é¸</option>
                </select>
              </div>
              <div>
                <label>å¿…é¸</label>
                <select data-ag-required>
                  <option value="false">å¯ä¸é¸</option>
                  <option value="true">å¿…é¸</option>
                </select>
              </div>
            </div>
          </div>

          <div class="inline" style="justify-content:space-between; margin-top:8px">
            <b>åŠ è³¼é …ç›®</b>
            <button class="btn" data-ag-add-opt type="button">ï¼‹æ–°å¢é …ç›®</button>
          </div>
          <div class="muted" style="margin-top:6px">ï¼ˆæ¯å€‹é …ç›®å¯è¨­å®šå…è²»/åŠ åƒ¹ï¼‰</div>
          <div data-ag-opt-list style="margin-top:8px"></div>

          <div class="inline" style="justify-content:flex-end; margin-top:10px">
            <button class="btn danger" data-ag-del-group type="button">åˆªé™¤æ­¤ç¾¤çµ„</button>
          </div>
        `;

        addonWrap.appendChild(groupEl);

        const optList = groupEl.querySelector("[data-ag-opt-list]");
        optList.innerHTML = `<div class="muted">ï¼ˆå°šç„¡é …ç›®ï¼Œè«‹æ–°å¢ï¼‰</div>`;
        let optCount = 0;

        groupEl.querySelector("[data-ag-add-opt]").onclick = ()=>{
          optCount++;
          if(optCount === 1) optList.innerHTML = "";
          const optEl = document.createElement("div");
          optEl.className = "box";
          optEl.style.marginTop = "10px";
          optEl.innerHTML = `
            <div class="row" style="grid-template-columns:1.1fr .7fr .6fr; gap:10px">
              <div>
                <label>åç¨±</label>
                <input data-ag-opt-name placeholder="ä¾‹ï¼šåŠ è›‹"/>
              </div>
              <div>
                <label>åƒ¹æ ¼</label>
                <input data-ag-opt-price type="number" min="0" value="0"/>
              </div>
              <div>
                <label>å…è²»</label>
                <select data-ag-opt-free>
                  <option value="false">å¦</option>
                  <option value="true">æ˜¯</option>
                </select>
              </div>
            </div>
            <div class="inline" style="justify-content:flex-end; margin-top:10px">
              <button class="btn danger" data-ag-del-opt type="button">åˆªé™¤</button>
            </div>
          `;
          optList.appendChild(optEl);
          optEl.querySelector("[data-ag-del-opt]").onclick = ()=>{
            optEl.remove();
            if(optList.querySelectorAll(".box").length === 0){
              optCount = 0;
              optList.innerHTML = `<div class="muted">ï¼ˆå°šç„¡é …ç›®ï¼Œè«‹æ–°å¢ï¼‰</div>`;
            }
          };
        };

        groupEl.querySelector("[data-ag-del-group]").onclick = ()=>{
          groupEl.remove();
          if(addonWrap.querySelectorAll(".box[data-gid]").length === 0){
            addonGroupCount = 0;
            addonWrap.innerHTML = `<div class="muted">ï¼ˆå°šç„¡åŠ è³¼ç¾¤çµ„ï¼ŒæŒ‰ã€Œæ–°å¢ä¸€çµ„ã€åŠ å…¥ï¼‰</div>`;
          }
        };
      };

      document.getElementById("btnAddMenu").onclick = addMenuItem;
    }

    function collectAddonGroups(){
      const groups = [];
      const groupEls = document.querySelectorAll("#addonGroupsWrap .box[data-gid]");
      groupEls.forEach(gel=>{
        const name = (gel.querySelector("[data-ag-name]")?.value || "").trim();
        const type = (gel.querySelector("[data-ag-type]")?.value || "multi");
        const required = (gel.querySelector("[data-ag-required]")?.value || "false") === "true";

        const optList = gel.querySelectorAll("[data-ag-opt-list] .box");
        const options = [];
        optList.forEach(oel=>{
          const oname = (oel.querySelector("[data-ag-opt-name]")?.value || "").trim();
          if(!oname) return;
          const price = Number(oel.querySelector("[data-ag-opt-price]")?.value || 0);
          const free = (oel.querySelector("[data-ag-opt-free]")?.value || "false") === "true";
          options.push({ name: oname, price: Number.isFinite(price)?price:0, free });
        });

        if(!name && options.length===0) return;

        groups.push({
          name: name || "åŠ è³¼",
          type: (type === "single") ? "single" : "multi",
          required,
          options
        });
      });
      return groups;
    }

    async function addMenuItem(){
      if(!selectedRestaurantId) return alert("è«‹å…ˆé¸æ“‡é¤å»³");
      const category = getPickedCategoryValue();
      if(!category) return alert("è«‹å…ˆåœ¨ã€Œé¡åˆ¥ç®¡ç†ã€æ–°å¢é¡åˆ¥ï¼Œä¸¦é¸æ“‡é¤é»é¡åˆ¥");

      const name = ($("mName")?.value || "").trim();
      const price = Number($("mPrice")?.value || 0);
      const defaultQty = Math.max(1, Number($("mDefaultQty")?.value || 1));
      const note = ($("mNote")?.value || "").trim();

      if(!name) return alert("è«‹è¼¸å…¥é¤é»åç¨±");
      if(!Number.isFinite(price) || price < 0) return alert("åƒ¹æ ¼ä¸æ­£ç¢º");

      const addonGroups = collectAddonGroups();

      for(const g of addonGroups){
        if((g.required === true) && (!Array.isArray(g.options) || g.options.length===0)){
          return alert(`åŠ è³¼ç¾¤çµ„ã€Œ${g.name}ã€æ˜¯å¿…é¸ï¼Œä½†æ²’æœ‰ä»»ä½•åŠ è³¼é …ç›®`);
        }
      }

      try{
        statusPill.textContent = "æ–°å¢é¤é»ä¸­â€¦";
        const menuCol = collection(db, "restaurants", selectedRestaurantId, "menu");

        const sameCat = menuCache.filter(m=> (m.category||"") === category);
        const maxOrder = sameCat.reduce((m,x)=> Math.max(m, Number(x.order||0)), 0);

        await addDoc(menuCol, {
          category, name, price, defaultQty, note,
          addonGroups,
          optionGroups: [],              // âœ… optionGroups å·²ç§»é™¤ï¼ˆä»å¯«ç©ºé™£åˆ—é¿å…èˆŠ code æœŸå¾…æ¬„ä½ï¼‰
          order: maxOrder + ORDER_GAP,
          createdAt: Date.now()
        });

        $("mName").value = "";
        $("mPrice").value = "0";
        $("mDefaultQty").value = "1";
        $("mNote").value = "";

        await loadMenu(selectedRestaurantId);
        renderMenuAdd();
        renderMenuList();
        statusPill.textContent = "æ–°å¢é¤é»å®Œæˆ âœ…";
      }catch(err){
        console.error("addMenuItem failed:", err);
        statusPill.textContent = "æ–°å¢é¤é»å¤±æ•—ï¼ˆçœ‹ consoleï¼‰";
        alert("æ–°å¢é¤é»å¤±æ•—ï¼ˆRules/ç¶²è·¯ï¼‰\n\n" + (err?.message || err));
      }
    }

    // ===== âœ… é¤é»ï¼šç·¨è¼¯ï¼ˆåªç•™ï¼šåç¨±/åƒ¹æ ¼/é è¨­æ•¸é‡/å‚™è¨» + åŠ è³¼ç›´è¦ºè¼¸å…¥ï¼‰ =====
    function normalizeAddonGroups(raw){
      const list = Array.isArray(raw) ? raw : [];
      return list.map(g=>({
        name: (g?.name || "åŠ è³¼").toString(),
        type: (g?.type === "single") ? "single" : "multi",
        required: (g?.required === true),
        options: Array.isArray(g?.options) ? g.options.map(o=>({
          name: (o?.name||"").toString(),
          price: Number.isFinite(Number(o?.price)) ? Number(o.price) : 0,
          free: (o?.free === true),
        })) : []
      }));
    }

    function renderAddonEditor(mid, addonGroups){
      const safe = normalizeAddonGroups(addonGroups);
      return `
        <div class="hr"></div>
        <div class="inline" style="justify-content:space-between">
          <b>åŠ è³¼ï¼ˆaddonGroupsï¼‰</b>
          <button class="small" data-mid="${esc(mid)}" data-ag-add-group type="button">ï¼‹æ–°å¢åŠ è³¼ç¾¤çµ„</button>
        </div>

        <div class="muted" style="margin-top:6px">ç¾¤çµ„å¯è¨­å®šã€Œå¤šé¸/å–®é¸ã€å¿…é¸ã€ï¼Œæ¯å€‹é …ç›®å¯ã€Œå…è²»/åŠ åƒ¹ã€ã€‚</div>

        <div data-mid="${esc(mid)}" data-ag-editor>
          ${safe.length===0 ? `<div class="muted" style="margin-top:10px">ç›®å‰æ²’æœ‰åŠ è³¼ç¾¤çµ„ã€‚</div>` : ""}
          ${safe.map((g,gi)=>`
            <div class="groupCard" data-gidx="${gi}">
              <div class="groupHead">
                <b>ç¾¤çµ„ #${gi+1}</b>
                <div class="groupOps">
                  <button class="small smallDanger" data-mid="${esc(mid)}" data-ag-del-group="${gi}" type="button">åˆªé™¤ç¾¤çµ„</button>
                </div>
              </div>

              <div class="row" style="margin-top:8px">
                <div>
                  <label>ç¾¤çµ„åç¨±</label>
                  <input data-mid="${esc(mid)}" data-ag-gname="${gi}" value="${esc(g.name)}" placeholder="ä¾‹ï¼šåŠ æ–™"/>
                </div>
                <div class="row" style="grid-template-columns:1fr 1fr; gap:10px">
                  <div>
                    <label>é¸æ“‡æ–¹å¼</label>
                    <select data-mid="${esc(mid)}" data-ag-gtype="${gi}">
                      <option value="multi" ${g.type==="multi"?"selected":""}>å¤šé¸</option>
                      <option value="single" ${g.type==="single"?"selected":""}>å–®é¸</option>
                    </select>
                  </div>
                  <div>
                    <label>å¿…é¸</label>
                    <select data-mid="${esc(mid)}" data-ag-greq="${gi}">
                      <option value="false" ${g.required? "":"selected"}>å¯ä¸é¸</option>
                      <option value="true" ${g.required? "selected":""}>å¿…é¸</option>
                    </select>
                  </div>
                </div>
              </div>

              <div class="inline" style="justify-content:space-between; margin-top:10px">
                <b>é …ç›®</b>
                <button class="small" data-mid="${esc(mid)}" data-ag-add-item="${gi}" type="button">ï¼‹æ–°å¢é …ç›®</button>
              </div>

              <div data-mid="${esc(mid)}" data-ag-items="${gi}">
                ${g.options.length===0 ? `<div class="muted" style="margin-top:10px">æ­¤ç¾¤çµ„å°šç„¡é …ç›®ã€‚</div>` : ""}
                ${g.options.map((o,oi)=>`
                  <div class="itemRow" data-oi="${oi}">
                    <div class="row" style="grid-template-columns:1.2fr .7fr .6fr; gap:10px">
                      <div>
                        <label>åç¨±</label>
                        <input data-mid="${esc(mid)}" data-ag-oname="${gi}:${oi}" value="${esc(o.name)}" placeholder="ä¾‹ï¼šåŠ è›‹"/>
                      </div>
                      <div>
                        <label>åƒ¹æ ¼</label>
                        <input data-mid="${esc(mid)}" data-ag-oprice="${gi}:${oi}" type="number" min="0" value="${Number(o.price||0)}"/>
                      </div>
                      <div>
                        <label>å…è²»</label>
                        <select data-mid="${esc(mid)}" data-ag-ofree="${gi}:${oi}">
                          <option value="false" ${o.free? "":"selected"}>å¦</option>
                          <option value="true" ${o.free? "selected":""}>æ˜¯</option>
                        </select>
                      </div>
                    </div>
                    <div class="inline" style="justify-content:flex-end; margin-top:10px">
                      <button class="small smallDanger" data-mid="${esc(mid)}" data-ag-del-item="${gi}:${oi}" type="button">åˆªé™¤æ­¤é …ç›®</button>
                    </div>
                  </div>
                `).join("")}
              </div>
            </div>
          `).join("")}
        </div>
      `;
    }

    function readAddonEditor(mid){
      const root = document.querySelector(`[data-mid="${mid}"][data-edit-box]`);
      if(!root) return [];

      const editor = root.querySelector(`[data-mid="${mid}"][data-ag-editor]`);
      if(!editor) return [];

      const groups = [];
      editor.querySelectorAll(".groupCard").forEach((gCard)=>{
        const gi = Number(gCard.dataset.gidx||0);

        const nameEl = gCard.querySelector(`[data-mid="${mid}"][data-ag-gname="${gi}"]`);
        const typeEl = gCard.querySelector(`[data-mid="${mid}"][data-ag-gtype="${gi}"]`);
        const reqEl  = gCard.querySelector(`[data-mid="${mid}"][data-ag-greq="${gi}"]`);

        const gname = (nameEl?.value||"").trim() || "åŠ è³¼";
        const gtype = (typeEl?.value==="single") ? "single" : "multi";
        const greq  = (reqEl?.value==="true");

        const options = [];
        gCard.querySelectorAll(".itemRow").forEach((row)=>{
          const oi = Number(row.dataset.oi||0);
          const on = (row.querySelector(`[data-mid="${mid}"][data-ag-oname="${gi}:${oi}"]`)?.value||"").trim();
          if(!on) return;
          const op = Number(row.querySelector(`[data-mid="${mid}"][data-ag-oprice="${gi}:${oi}"]`)?.value||0);
          const of = (row.querySelector(`[data-mid="${mid}"][data-ag-ofree="${gi}:${oi}"]`)?.value==="true");
          options.push({ name:on, price: Number.isFinite(op)?op:0, free: of });
        });

        groups.push({ name:gname, type:gtype, required:greq, options });
      });

      return groups;
    }

    async function saveMenuItemEdits(mid){
      if(!selectedRestaurantId || !mid) return;

      const nameEl = document.querySelector(`[data-mid="${mid}"][data-edit-name]`);
      const priceEl = document.querySelector(`[data-mid="${mid}"][data-edit-price]`);
      const qtyEl = document.querySelector(`[data-mid="${mid}"][data-edit-qty]`);
      const noteEl = document.querySelector(`[data-mid="${mid}"][data-edit-note]`);
      const errEl = document.querySelector(`[data-mid="${mid}"][data-edit-err]`);

      if(!nameEl || !priceEl || !qtyEl) return;

      const name = (nameEl.value||"").trim();
      const price = Number(priceEl.value||0);
      const defaultQty = Math.max(1, Number(qtyEl.value||1));
      const note = (noteEl?.value||"").trim();

      if(!name) {
        if(errEl) errEl.textContent = "â— é¤é»åç¨±ä¸å¯ç©ºç™½";
        return;
      }
      if(!Number.isFinite(price) || price < 0){
        if(errEl) errEl.textContent = "â— åƒ¹æ ¼ä¸æ­£ç¢º";
        return;
      }

      const addonGroups = readAddonEditor(mid);
      for(const g of addonGroups){
        if(g.required === true && (!Array.isArray(g.options) || g.options.length===0)){
          if(errEl) errEl.textContent = `â— åŠ è³¼ç¾¤çµ„ã€Œ${g.name}ã€æ˜¯å¿…é¸ï¼Œä½†é …ç›®ä¸èƒ½ç‚ºç©º`;
          return;
        }
      }

      try{
        if(errEl) errEl.textContent = "";
        statusPill.textContent = "å„²å­˜é¤é»ç·¨è¼¯â€¦";
        await updateDoc(doc(db,"restaurants",selectedRestaurantId,"menu",mid), {
          name, price, defaultQty, note,
          addonGroups,
          optionGroups: [],         // âœ… optionGroups åŠŸèƒ½å·²ç§»é™¤ï¼šå›ºå®šæ¸…ç©º
          updatedAt: Date.now()
        });
        await loadMenu(selectedRestaurantId);
        renderMenuList();
        statusPill.textContent = "é¤é»å·²æ›´æ–° âœ…";
      }catch(err){
        console.error(err);
        if(errEl) errEl.textContent = `â— å„²å­˜å¤±æ•—ï¼š${err?.message||err}`;
        statusPill.textContent = "é¤é»å„²å­˜å¤±æ•—";
      }
    }

    function toggleMenuEditBox(mid){
      const box = document.querySelector(`[data-mid="${mid}"][data-edit-box]`);
      if(!box) return;
      const willShow = !box.classList.contains("show");
      document.querySelectorAll("[data-edit-box].show").forEach(el=> el.classList.remove("show"));
      if(willShow) box.classList.add("show");
    }

    function bindMenuEditAutoSave(mid){
      const save = ()=> saveMenuItemEdits(mid);

      const ids = [
        `[data-mid="${mid}"][data-edit-name]`,
        `[data-mid="${mid}"][data-edit-price]`,
        `[data-mid="${mid}"][data-edit-qty]`,
        `[data-mid="${mid}"][data-edit-note]`,
      ];
      ids.forEach(sel=>{
        const el = document.querySelector(sel);
        if(el) bindEnterBlurSave(el, save);
      });

      const btnSave = document.querySelector(`[data-mid="${mid}"][data-edit-save]`);
      if(btnSave) btnSave.onclick = save;

      const btnCancel = document.querySelector(`[data-mid="${mid}"][data-edit-cancel]`);
      if(btnCancel) btnCancel.onclick = ()=> toggleMenuEditBox(mid);

      // addon editor actions
      const box = document.querySelector(`[data-mid="${mid}"][data-edit-box]`);
      if(!box) return;

      box.querySelectorAll(`[data-mid="${mid}"][data-ag-add-group]`).forEach(btn=>{
        btn.onclick = ()=>{
          const m = menuCache.find(x=> x.id===mid) || {};
          const cur = normalizeAddonGroups(m.addonGroups);
          cur.push({ name:"åŠ è³¼", type:"multi", required:false, options:[] });
          // ç›´æ¥æ”¹ DOMï¼šæœ€ç°¡å–®åšæ³• -> å…ˆå¯«å› DB å†é‡ç¹ª
          updateDoc(doc(db,"restaurants",selectedRestaurantId,"menu",mid), { addonGroups: cur, updatedAt: Date.now(), optionGroups: [] })
            .then(()=> loadMenu(selectedRestaurantId))
            .then(()=> renderMenuList())
            .catch(console.error);
        };
      });

      box.querySelectorAll(`[data-mid="${mid}"][data-ag-del-group]`).forEach(btn=>{
        btn.onclick = ()=>{
          const gi = Number(btn.getAttribute("data-ag-del-group")||0);
          const m = menuCache.find(x=> x.id===mid) || {};
          const cur = normalizeAddonGroups(m.addonGroups).filter((_,i)=> i!==gi);
          updateDoc(doc(db,"restaurants",selectedRestaurantId,"menu",mid), { addonGroups: cur, updatedAt: Date.now(), optionGroups: [] })
            .then(()=> loadMenu(selectedRestaurantId))
            .then(()=> renderMenuList())
            .catch(console.error);
        };
      });

      box.querySelectorAll(`[data-mid="${mid}"][data-ag-add-item]`).forEach(btn=>{
        btn.onclick = ()=>{
          const gi = Number(btn.getAttribute("data-ag-add-item")||0);
          const m = menuCache.find(x=> x.id===mid) || {};
          const cur = normalizeAddonGroups(m.addonGroups);
          if(!cur[gi]) cur[gi] = { name:"åŠ è³¼", type:"multi", required:false, options:[] };
          cur[gi].options.push({ name:"", price:0, free:false });
          updateDoc(doc(db,"restaurants",selectedRestaurantId,"menu",mid), { addonGroups: cur, updatedAt: Date.now(), optionGroups: [] })
            .then(()=> loadMenu(selectedRestaurantId))
            .then(()=> renderMenuList())
            .catch(console.error);
        };
      });

      box.querySelectorAll(`[data-mid="${mid}"][data-ag-del-item]`).forEach(btn=>{
        btn.onclick = ()=>{
          const key = btn.getAttribute("data-ag-del-item")||"";
          const [giS, oiS] = key.split(":");
          const gi = Number(giS||0), oi = Number(oiS||0);
          const m = menuCache.find(x=> x.id===mid) || {};
          const cur = normalizeAddonGroups(m.addonGroups);
          if(!cur[gi] || !Array.isArray(cur[gi].options)) return;
          cur[gi].options = cur[gi].options.filter((_,i)=> i!==oi);
          updateDoc(doc(db,"restaurants",selectedRestaurantId,"menu",mid), { addonGroups: cur, updatedAt: Date.now(), optionGroups: [] })
            .then(()=> loadMenu(selectedRestaurantId))
            .then(()=> renderMenuList())
            .catch(console.error);
        };
      });

      // æ‰€æœ‰ addon æ¬„ä½ blur å°±å­˜
      box.querySelectorAll(`input[data-mid="${mid}"],select[data-mid="${mid}"]`).forEach(el=>{
        // åŸºæœ¬æ¬„ä½å·²ç¶é Enter/blurï¼›é€™è£¡å†è£œï¼šåŠ è³¼æ¬„ä½ blur è‡ªå‹•å­˜
        if(el.hasAttribute("data-ag-gname") || el.hasAttribute("data-ag-gtype") || el.hasAttribute("data-ag-greq")
          || el.hasAttribute("data-ag-oname") || el.hasAttribute("data-ag-oprice") || el.hasAttribute("data-ag-ofree")){
          el.addEventListener("blur", save);
          el.addEventListener("change", save);
        }
      });
    }

    // ===== âœ… é¤é»æ¸…å–®ï¼šé¡åˆ¥å…§æ‹–æ›³æ’åº + ç·¨è¼¯ =====
    const menuSorters = new Map(); // category -> Sortable

    function renderMenuList(){
      const wrap = $("menuList");
      menuSorters.forEach(s=>{ try{s.destroy()}catch(e){} });
      menuSorters.clear();

      if(!selectedRestaurantId){
        wrap.innerHTML = `<div class="muted">å°šæœªé¸æ“‡é¤å»³ã€‚</div>`;
        return;
      }
      if(menuCache.length === 0){
        wrap.innerHTML = `<div class="muted">æ­¤é¤å»³å°šç„¡é¤é»ã€‚</div>`;
        return;
      }

      const map = new Map();
      for(const m of menuCache){
        const cat = (m.category || "æœªåˆ†é¡").trim();
        if(!map.has(cat)) map.set(cat, []);
        map.get(cat).push(m);
      }

      const { g0 } = getCategoryGroup();
      const catOrder = new Map((g0.options||[]).map(o=> [o.name, Number(o.order||0)]));
      const cats = Array.from(map.keys()).sort((a,b)=>{
        const ao = catOrder.has(a) ? catOrder.get(a) : 1e15;
        const bo = catOrder.has(b) ? catOrder.get(b) : 1e15;
        if(ao !== bo) return ao - bo;
        return a.localeCompare(b,"zh-Hant");
      });

      wrap.innerHTML = cats.map(cat=>{
        const items = map.get(cat).slice().sort((a,b)=> Number(a.order||0)-Number(b.order||0));
        return `
          <details class="box" style="padding:10px 12px">
            <summary class="inline" style="justify-content:space-between">
              <div class="inline">
                <b>${esc(cat)}</b>
                <span class="tag">${items.length} é …</span>
              </div>
              <span class="tag">æ”¶åˆ</span>
            </summary>

            <div class="muted" style="margin-top:8px">å±•é–‹å¾Œå¯æ‹–æ›³é¤é»æ’åºï¼ˆè‡ªå‹•å„²å­˜ï¼‰</div>

            <div class="menuSortable" data-cat="${esc(cat)}" style="margin-top:8px">
              ${items.map(m=>{
                const ag = Array.isArray(m.addonGroups) ? m.addonGroups : [];
                return `
                  <div class="dragItem" data-id="${esc(m.id)}">
                    <div class="dragLeft" style="min-width:0">
                      <span class="dragHandle">â˜°</span>
                      <div style="min-width:0">
                        <div class="dragTitle">${esc(m.name||"")}</div>
                        <div class="muted" style="margin-top:4px">
                          <span class="tag">åƒ¹æ ¼ï¼š${Number(m.price||0)}</span>
                          <span class="tag">é è¨­ï¼š${Number(m.defaultQty||1)}</span>
                        </div>
                      </div>
                    </div>
                    <div class="dragRight">
                      <button class="tinyBtn" data-edit-menu="${esc(m.id)}" type="button">ç·¨è¼¯</button>
                      <button class="tinyBtn tinyDanger" data-del-menu="${esc(m.id)}" type="button">åˆªé™¤</button>
                    </div>
                  </div>

                  ${m.note ? `<div class="muted" style="margin-top:6px; padding-left:6px">å‚™è¨»ï¼š${esc(m.note)}</div>` : ``}

                  ${ag.length ? `
                    <div class="muted" style="margin-top:6px; padding-left:6px">
                      åŠ è³¼ç¾¤çµ„ï¼š${esc(ag.map(g=>{
                        const t = (g.type==="single") ? "å–®é¸" : "å¤šé¸";
                        const req = (g.required===true) ? "å¿…é¸" : "å¯ä¸é¸";
                        const cnt = Array.isArray(g.options)?g.options.length:0;
                        return `${g.name}ï¼ˆ${t} / ${req} / ${cnt}é …ï¼‰`;
                      }).join("ï¼›"))}
                    </div>
                  ` : ``}

                  <div class="editBox" data-mid="${esc(m.id)}" data-edit-box>
                    <div class="inline" style="justify-content:space-between">
                      <b>ç·¨è¼¯é¤é»</b>
                      <span class="tag">Enter/é›¢é–‹æœƒè‡ªå‹•å­˜</span>
                    </div>

                    <div class="row" style="margin-top:8px">
                      <div>
                        <label>é¤é»åç¨±</label>
                        <input data-mid="${esc(m.id)}" data-edit-name value="${esc(m.name||"")}"/>
                      </div>
                      <div>
                        <label>åƒ¹æ ¼ï¼ˆå–®ä»½ï¼‰</label>
                        <input data-mid="${esc(m.id)}" data-edit-price type="number" min="0" value="${Number(m.price||0)}"/>
                      </div>
                    </div>

                    <div class="row">
                      <div>
                        <label>é è¨­æ•¸é‡ï¼ˆdefaultQtyï¼‰</label>
                        <input data-mid="${esc(m.id)}" data-edit-qty type="number" min="1" value="${Number(m.defaultQty||1)}"/>
                      </div>
                      <div>
                        <label>å‚™è¨»ï¼ˆå¯ç©ºï¼‰</label>
                        <input data-mid="${esc(m.id)}" data-edit-note value="${esc(m.note||"")}"/>
                      </div>
                    </div>

                    ${renderAddonEditor(m.id, m.addonGroups)}

                    <div class="inline" style="justify-content:space-between; margin-top:10px">
                      <div class="muted" data-mid="${esc(m.id)}" data-edit-err style="color:#b91c1c"></div>
                      <div class="inline">
                        <button class="btn" data-mid="${esc(m.id)}" data-edit-cancel type="button">æ”¶èµ·</button>
                        <button class="primary" data-mid="${esc(m.id)}" data-edit-save type="button">ç«‹å³å„²å­˜</button>
                      </div>
                    </div>
                  </div>
                `;
              }).join("")}
            </div>
          </details>
        `;
      }).join("");

      wrap.querySelectorAll("button[data-del-menu]").forEach(btn=>{
        btn.onclick = async ()=>{
          const mid = btn.dataset.delMenu;
          if(!confirm("ç¢ºå®šåˆªé™¤æ­¤é¤é»ï¼Ÿ")) return;
          try{
            await deleteDoc(doc(db, "restaurants", selectedRestaurantId, "menu", mid));
            await loadMenu(selectedRestaurantId);
            renderMenuList();
          }catch(err){
            console.error("delete menu failed:", err);
            alert("åˆªé™¤é¤é»å¤±æ•—ï¼ˆRules/ç¶²è·¯ï¼‰\n\n" + (err?.message || err));
          }
        };
      });

      wrap.querySelectorAll("button[data-edit-menu]").forEach(btn=>{
        btn.onclick = ()=>{
          const mid = btn.dataset.editMenu;
          toggleMenuEditBox(mid);
          setTimeout(()=> bindMenuEditAutoSave(mid), 0);
        };
      });

      wrap.querySelectorAll(".menuSortable").forEach(listEl=>{
        const cat = listEl.dataset.cat || "";
        const sorter = new Sortable(listEl, {
          animation: 150,
          handle: ".dragHandle",
          ghostClass: "ghost",
          chosenClass: "chosen",
          onEnd: async ()=>{
            try{
              statusPill.textContent = `å„²å­˜é¤é»æ’åºï¼ˆ${cat}ï¼‰â€¦`;
              const ids = Array.from(listEl.querySelectorAll(".dragItem")).map(el=> el.dataset.id);
              for(let i=0;i<ids.length;i++){
                await updateDoc(doc(db,"restaurants",selectedRestaurantId,"menu",ids[i]), { order: i*ORDER_GAP });
              }
              await loadMenu(selectedRestaurantId);
              statusPill.textContent = "é¤é»æ’åºå·²å„²å­˜ âœ…";
            }catch(err){
              console.error(err);
              statusPill.textContent = "é¤é»æ’åºå„²å­˜å¤±æ•—";
            }
          }
        });
        menuSorters.set(cat, sorter);
      });
    }

    // ===== Staff (dept collapsed + drag reorder in dept) =====
    const staffSorters = new Map(); // dept -> Sortable
    async function loadStaff(){
      staffSorters.forEach(s=>{ try{s.destroy()}catch(e){} });
      staffSorters.clear();

      try{
        statusPill.textContent = "è¼‰å…¥äººå“¡ä¸­â€¦";
        const snap = await getDocs(colStaff);
        const map = {};
        snap.forEach(d=>{
          const v = d.data() || {};
          const dept = (v.dept || "æœªåˆ†éƒ¨é–€").trim();
          const name = (v.name || "").trim();
          if(!name) return;
          const order = Number.isFinite(Number(v.order)) ? Number(v.order) : 0;
          if(!map[dept]) map[dept] = [];
          map[dept].push({ id:d.id, name, order });
        });

        Object.keys(map).forEach(k=> map[k].sort((a,b)=> (a.order-b.order) || a.name.localeCompare(b.name,"zh-Hant")));
        const depts = Object.keys(map).sort((a,b)=> a.localeCompare(b,"zh-Hant"));

        const wrap = $("staffWrap");
        if(depts.length===0){
          wrap.innerHTML = `<div class="muted">å°šç„¡äººå“¡ã€‚</div>`;
        }else{
          wrap.innerHTML = depts.map(dept=>`
            <details class="box" data-dept="${esc(dept)}">
              <summary class="inline" style="justify-content:space-between">
                <div class="inline">
                  <b>${esc(dept)}</b>
                  <span class="tag">${map[dept].length} äºº</span>
                </div>
                <span class="tag">æ”¶åˆ</span>
              </summary>

              <div class="muted" style="margin-top:8px">å±•é–‹å¾Œå¯æ‹–æ›³æ’åºï¼ˆè‡ªå‹•å„²å­˜ï¼‰</div>

              <div class="staffSortable" data-dept="${esc(dept)}" style="margin-top:8px">
                ${map[dept].map(p=>`
                  <div class="dragItem" data-id="${esc(p.id)}">
                    <div class="dragLeft">
                      <span class="dragHandle">â˜°</span>
                      <div class="dragTitle">${esc(p.name)}</div>
                    </div>
                    <div class="dragRight">
                      <button class="tinyBtn tinyDanger" data-del-staff="${esc(p.id)}" type="button">åˆªé™¤</button>
                    </div>
                  </div>
                `).join("")}
              </div>
            </details>
          `).join("");

          wrap.querySelectorAll("button[data-del-staff]").forEach(btn=>{
            btn.onclick = async ()=>{
              const id = btn.dataset.delStaff;
              if(!confirm("ç¢ºå®šåˆªé™¤æ­¤äººå“¡ï¼Ÿ")) return;
              try{
                await deleteDoc(doc(db, "staff", id));
                await loadStaff();
              }catch(err){
                console.error(err);
                alert("åˆªé™¤äººå“¡å¤±æ•—ï¼ˆRules/ç¶²è·¯ï¼‰\n\n" + (err?.message || err));
              }
            };
          });

          wrap.querySelectorAll(".staffSortable").forEach(listEl=>{
            const dept = listEl.dataset.dept || "";
            const sorter = new Sortable(listEl, {
              animation: 150,
              handle: ".dragHandle",
              ghostClass: "ghost",
              chosenClass: "chosen",
              onEnd: async ()=>{
                try{
                  statusPill.textContent = `å„²å­˜äººå“¡æ’åºï¼ˆ${dept}ï¼‰â€¦`;
                  const ids = Array.from(listEl.querySelectorAll(".dragItem")).map(el=> el.dataset.id);
                  for(let i=0;i<ids.length;i++){
                    await updateDoc(doc(db,"staff",ids[i]), { order: i*ORDER_GAP, dept });
                  }
                  await loadStaff();
                  statusPill.textContent = "äººå“¡æ’åºå·²å„²å­˜ âœ…";
                }catch(err){
                  console.error(err);
                  statusPill.textContent = "äººå“¡æ’åºå„²å­˜å¤±æ•—";
                }
              }
            });
            staffSorters.set(dept, sorter);
          });
        }

        statusPill.textContent = "äººå“¡è¼‰å…¥å®Œæˆ âœ…";
      }catch(err){
        console.error("loadStaff failed:", err);
        statusPill.textContent = "äººå“¡è®€å–å¤±æ•—ï¼ˆçœ‹ consoleï¼‰";
        alert("äººå“¡è®€å–å¤±æ•—ï¼ˆRules/ç¶²è·¯ï¼‰\n\n" + (err?.message || err));
      }
    }

    async function addStaff(){
      const dept = ($("staffDept").value || "").trim();
      const name = ($("staffName").value || "").trim();
      if(!dept) return alert("è«‹è¼¸å…¥éƒ¨é–€");
      if(!name) return alert("è«‹è¼¸å…¥äººå“¡å§“å");

      try{
        statusPill.textContent = "æ–°å¢äººå“¡ä¸­â€¦";
        const all = await getDocs(query(colStaff, where("dept","==",dept), limit(500)));
        let maxOrder = 0;
        all.forEach(d=>{
          const o = Number(d.data()?.order||0);
          if(o>maxOrder) maxOrder=o;
        });
        await addDoc(colStaff, { dept, name, order: maxOrder + ORDER_GAP, createdAt: Date.now() });
        $("staffName").value = "";
        await loadStaff();
        statusPill.textContent = "æ–°å¢äººå“¡å®Œæˆ âœ…";
      }catch(err){
        console.error("addStaff failed:", err);
        statusPill.textContent = "æ–°å¢äººå“¡å¤±æ•—ï¼ˆçœ‹ consoleï¼‰";
        alert("æ–°å¢äººå“¡å¤±æ•—ï¼ˆRules/ç¶²è·¯ï¼‰\n\n" + (err?.message || err));
      }
    }

    // ===== Orders (Query + Excel) =====
     async function exportOrdersExcel(){
      if(!window.XLSX) return alert("Excel åŒ¯å‡ºå…ƒä»¶æœªè¼‰å…¥ï¼ˆXLSXï¼‰");

      const qDate = ($("qDate").value || "").trim();
      const qRid = ($("qRestaurant").value || "").trim();
      const qName = ($("qName").value || "").trim();
      const qPeriod = ($("qPeriod")?.value || "").trim();

      try{
        statusPill.textContent = "åŒ¯å‡ºä¸­â€¦";

        let snap;
        if(qDate){
          snap = await getDocs(query(colOrders, where("orderDate","==", qDate), limit(3000)));
        }else{
          snap = await getDocs(query(colOrders, limit(3000)));
        }

        const rows = [];
        snap.forEach(d=> rows.push({ id:d.id, ...d.data() }));

        const filtered = rows.filter(o=>{
          if(qRid && o.restaurantId !== qRid) return false;
          if(qName && !(String(o.userName||"").includes(qName))) return false;
          if(qPeriod){
            if(periodOf(Number(o.createdAt||0)) !== qPeriod) return false;
          }
          return true;
        }).sort((a,b)=> Number(a.createdAt||0) - Number(b.createdAt||0));

        if(filtered.length === 0){
          statusPill.textContent = "ç„¡è³‡æ–™å¯åŒ¯å‡º";
          return alert("ç›®å‰ç¯©é¸æ¢ä»¶ä¸‹æ²’æœ‰è³‡æ–™å¯åŒ¯å‡º");
        }

        const detail = [];
        for(const o of filtered){
          const items = Array.isArray(o.items) ? o.items : [];
          for(const it of items){
            const optTxt = optionText(it.optionGroups, it.chosenOptions);
            const addTxt = addonText(it.addons);
            const calc = calcItemLine(it);

            detail.push({
              "è¨‚å–®æ—¥æœŸ": o.orderDate || "",
              "å»ºç«‹æ™‚é–“": fmtTime(Number(o.createdAt||0)),
              "æ™‚æ®µ": periodOf(Number(o.createdAt||0)) === "noon" ? "ä¸­åˆ" : "æ™šä¸Š",
              "éƒ¨é–€": o.userDept || "",
              "å§“å": o.userName || "",
              "åº—å®¶": o.restaurantName || "",
              "å“é …": it.name || "",
              "é¸é …": optTxt || "",
              "åŠ è³¼": addTxt || "",
              "å–®å“å‚™è¨»": it.note || "",
              "æ•¸é‡": Number(it.qty||0),
              "åŸå–®åƒ¹": Number(it.price||0),
              "é¸é …åŠ åƒ¹": Number(calc.optSum||0),
              "åŠ è³¼åŠ åƒ¹": Number(calc.addonSum||0),
              "å°è¨ˆå–®åƒ¹": Number(calc.unit||0),
              "å“é …å°è¨ˆ": Number(calc.lineTotal||0),
              "æ•´ç­†å‚™è¨»": (o.orderNote || o.remark) ? (o.orderNote || o.remark) : "",
              "è¨‚å–®ç¸½é¡": Number(o.total||0),
            });
          }
        }

        const sumMap = new Map();
        for(const r of detail){
          const key = `${r["éƒ¨é–€"]}__${r["å§“å"]}`;
          if(!sumMap.has(key)) sumMap.set(key, { "éƒ¨é–€": r["éƒ¨é–€"], "å§“å": r["å§“å"], "é‡‘é¡å°è¨ˆ": 0 });
          sumMap.get(key)["é‡‘é¡å°è¨ˆ"] += Number(r["å“é …å°è¨ˆ"]||0);
        }
        const byPerson = Array.from(sumMap.values())
          .sort((a,b)=> (a["éƒ¨é–€"]+a["å§“å"]).localeCompare(b["éƒ¨é–€"]+b["å§“å"], "zh-Hant"));

        const deptMap = new Map();
        for(const p of byPerson){
          const d = p["éƒ¨é–€"] || "æœªåˆ†éƒ¨é–€";
          if(!deptMap.has(d)) deptMap.set(d, { "éƒ¨é–€": d, "é‡‘é¡å°è¨ˆ": 0 });
          deptMap.get(d)["é‡‘é¡å°è¨ˆ"] += Number(p["é‡‘é¡å°è¨ˆ"]||0);
        }
        const byDept = Array.from(deptMap.values())
          .sort((a,b)=> a["éƒ¨é–€"].localeCompare(b["éƒ¨é–€"], "zh-Hant"));

        const grandTotal = byPerson.reduce((s,x)=> s + Number(x["é‡‘é¡å°è¨ˆ"]||0), 0);
        byDept.push({ "éƒ¨é–€": "â€”", "é‡‘é¡å°è¨ˆ": "" });
        byDept.push({ "éƒ¨é–€": "ç¸½è¨ˆ", "é‡‘é¡å°è¨ˆ": grandTotal });

        const wb = XLSX.utils.book_new();
        XLSX.utils.book_append_sheet(wb, XLSX.utils.json_to_sheet(detail), "æ˜ç´°");
        XLSX.utils.book_append_sheet(wb, XLSX.utils.json_to_sheet(byPerson), "äººå“¡åŠ ç¸½");
        XLSX.utils.book_append_sheet(wb, XLSX.utils.json_to_sheet(byDept), "éƒ¨é–€åŠ ç¸½");

        const shopName = qRid ? ($("qRestaurant").selectedOptions?.[0]?.textContent || "Shop") : "AllShops";
        const filename = `Orders_${qDate||"AllDates"}_${shopName}_${qPeriod?(qPeriod==="noon"?"Noon":"Night"):"AllDay"}`.replace(/[\\/:*?"<>|]/g, "-") + ".xlsx";
        XLSX.writeFile(wb, filename);

        statusPill.textContent = "åŒ¯å‡ºå®Œæˆ âœ…";
      }catch(err){
        console.error("exportOrdersExcel failed:", err);
        statusPill.textContent = "åŒ¯å‡ºå¤±æ•—ï¼ˆçœ‹ consoleï¼‰";
        alert("åŒ¯å‡ºå¤±æ•—ï¼ˆRules/ç¶²è·¯ï¼‰\n\n" + (err?.message || err));
      }
    }

    // ===== Events / Buttons =====
    $("restaurantSelect").onchange = async ()=>{
      const rid = $("restaurantSelect").value;
      await loadRestaurantDoc(rid);
    };
    $("btnReloadRestaurants").onclick = loadRestaurants;
    $("btnSaveRestaurantFlags").onclick = saveRestaurantFlags;
    $("btnAddRestaurant").onclick = addRestaurant;
    $("btnDeleteRestaurant").onclick = deleteRestaurant;

    $("btnAddStaff").onclick = addStaff;
    $("btnReloadStaff").onclick = loadStaff;
    $("staffName").addEventListener("keydown", (e)=>{
      if(e.key === "Enter") addStaff();
    });

    $("btnQuery").onclick = queryOrders;
    $("btnToday").onclick = ()=>{
      $("qDate").value = todayISO();
      queryOrders();
    };
    $("btnExportExcel").onclick = exportOrdersExcel;

    $("btnGoUser").onclick = ()=>{
      localStorage.setItem(roleKey, "user");
      location.href = "./user.html";
    };
    $("btnLogout").onclick = ()=>{
      localStorage.removeItem(roleKey);
      location.href = "./index.html";
    };

    // ===== Init =====
    $("qDate").value = todayISO();
    await loadRestaurants();
    await loadStaff();
    await queryOrders();

    document.addEventListener("visibilitychange", async ()=>{
      if(document.visibilityState === "visible"){
        await loadRestaurants();
        if(selectedRestaurantId) await loadRestaurantDoc(selectedRestaurantId);
      }
    });
  </script>
</body>
</html>
