<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>GoldBricks å‘·å¥”ğŸ‘½ï½œç®¡ç†99</title>

  <!-- âœ… é¡åˆ¥æ‹–æ›³æ’åºç”¨ -->
  <script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.2/Sortable.min.js"></script>

  <style>
    :root{
      --bg:#f5f4fb; --card:#fff; --text:#0f172a; --muted:#64748b;
      --primary:#fb7185; --primary2:#ff9a9e; --border:rgba(15,23,42,.10);
      --shadow:0 10px 30px rgba(15,23,42,.10);
      --radius:18px;
    }
    *{box-sizing:border-box}
    body{
      margin:0; font-family: ui-sans-serif, system-ui, -apple-system, "Segoe UI", Arial;
      background: radial-gradient(1200px 500px at 20% -10%, rgba(251,113,133,.22), transparent 60%),
                  radial-gradient(900px 500px at 100% 0%, rgba(255,154,158,.14), transparent 55%),
                  var(--bg);
      color:var(--text);
      min-height:100vh;
    }
.layout{
  display:grid;
  grid-template-columns: 300px 1fr;
  gap:16px;
  padding:0 16px 16px;

  align-items: start;   /* â† é€™ä¸€è¡Œæ˜¯ä¸»å›  */
}

    @media (max-width:980px){.layout{grid-template-columns:1fr}}
    .sidebar,.main{
      background: rgba(255,255,255,.78);
      border:1px solid var(--border);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      backdrop-filter: blur(10px);
    }
 .sidebar{
  padding:14px;
  position:sticky;
  top:0;

  align-self: start;   /* â­ é—œéµï¼šä¸è¦æ’é«˜ grid row */
}

    .brand{display:flex; align-items:center; justify-content:space-between; gap:10px; padding:10px 10px 6px;}
    .brand h1{font-size:16px; margin:0}
    .brand small{color:var(--muted)}
    .nav{margin-top:10px; display:flex; flex-direction:column; gap:8px}
    .nav button{
      text-align:left; padding:11px 12px; border-radius:14px;
      border:1px solid var(--border); background:#fff; cursor:pointer;
      font-weight:800;
    }
    .nav button.active{
      border-color: rgba(251,113,133,.55);
      background: linear-gradient(90deg, rgba(251,113,133,.18), rgba(255,154,158,.10));
      box-shadow: 0 10px 22px rgba(251,113,133,.18);
    }

   .main{
  padding:14px;
  align-self: start;   /* â† åŠ é€™ä¸€è¡Œ */
}
   .topbar{
  display:flex;
  align-items:center;
  justify-content:space-between;
  gap:12px;
  padding:0 6px 12px;     /* âœ… ä¸Šæ–¹è²¼é½Š */
}

    .topbar h2{margin:0; font-size:18px}
    .topbar .right{display:flex; gap:10px; align-items:center; flex-wrap:wrap}
    .pill{padding:8px 12px; border-radius:999px; border:1px solid var(--border); background:#fff; color:var(--muted); font-size:12.5px}
    .ghost{
      padding:9px 12px; border-radius:14px; border:1px solid var(--border);
      background:#fff; cursor:pointer; font-weight:800;
    }
    .primary{
      padding:9px 12px; border-radius:14px; border:none; cursor:pointer; font-weight:900;
      background: linear-gradient(90deg, var(--primary), var(--primary2));
      color:#fff; box-shadow: 0 14px 28px rgba(251,113,133,.22);
    }

    .grid{display:grid; grid-template-columns: 1fr 1fr; gap:14px}
    @media (max-width:980px){.grid{grid-template-columns:1fr}}

    /* âœ… è¨‚é¤ç´€éŒ„ï¼šå·¦å°å³å¤§ï¼ˆåªå½±éŸ¿ view_ordersï¼‰ */
    #view_orders .grid{ grid-template-columns: 360px 1fr; }
    @media (max-width:980px){ #view_orders .grid{ grid-template-columns: 1fr; } }

    .card{
      background:#fff; border:1px solid var(--border); border-radius:var(--radius);
      box-shadow: 0 8px 25px rgba(15,23,42,.07);
      padding:14px;
    }
    .card h3{margin:0 0 10px; font-size:15px}
    label{display:block; font-size:13px; color:var(--muted); margin:10px 0 6px;}
    input,select,textarea{
      width:100%; padding:11px 12px; border-radius:14px;
      border:1px solid var(--border); outline:none; background:#fff;
      font-size:14px;
    }
    textarea{min-height:92px; resize:vertical}
    input:focus,select:focus,textarea:focus{border-color: rgba(251,113,133,.7)}
    .row{display:grid; grid-template-columns: 1fr 1fr; gap:10px}
    .row3{display:grid; grid-template-columns: 1fr 1fr 1fr; gap:10px}
    .actions{display:flex; gap:10px; margin-top:12px; flex-wrap:wrap}
    .muted{color:var(--muted); font-size:12.5px; line-height:1.6}
    .hr{height:1px; background: var(--border); margin:12px 0}
    table{width:100%; border-collapse:collapse; font-size:13.5px}
    th,td{border-bottom:1px solid rgba(15,23,42,.08); padding:10px 8px; text-align:left; vertical-align:top}
    th{color:var(--muted); font-weight:900}
    .tag{display:inline-flex; align-items:center; gap:8px; padding:5px 10px; border-radius:999px; border:1px solid var(--border); background:#fff; color:var(--muted); font-size:12px}
    .tag{display:inline-flex; align-items:center; gap:8px; padding:5px 10px; border-radius:999px; border:1px solid var(--border); background:#fff; color:var(--muted); font-size:12px }
/* === æœªé»é¤ï¼šé•·æ¢ï¼‹æ¡†æ¡†ï¼ˆåƒã€Œé–‹å–®ä¸­çš„é¤å»³ã€ï¼‰ === */
.missStrip{
  border:1px dashed rgba(15,23,42,.18);
  border-radius:18px;
  background:#fff;
  padding:12px 14px;
}

.missStripHead{
  display:flex;
  align-items:flex-start;
  justify-content:space-between;
  gap:12px;
}

.missTitle{
  font-weight:900;
  font-size:14px;
}

.missSub{
  margin-top:4px;
  color:var(--muted);
  font-size:12.5px;
}

.missPills{
  margin-top:10px;
  display:flex;
  flex-wrap:wrap;
  gap:10px;
}

.missPill{
  display:inline-flex;
  align-items:center;
  gap:8px;
  padding:7px 10px;
  border-radius:999px;
  border:1px solid rgba(15,23,42,.14);
  background:#fff;
  font-size:13px;
  white-space:nowrap;
}

.missDept{
  font-weight:900;
  color:#0f172a;
}

.missCount{
  padding:4px 8px;
  border-radius:999px;
  border:1px solid rgba(15,23,42,.12);
  background:rgba(15,23,42,.03);
  color:var(--muted);
  font-size:12px;
  font-weight:900;
}

.missNames{
  color:#0f172a;
}

    .btnSmall{
      padding:7px 10px; border-radius:12px; border:1px solid var(--border);
      background:#fff; cursor:pointer; font-weight:800; font-size:12.5px;
      white-space:nowrap;
    }
    .btnDanger{border-color: rgba(239,68,68,.35)}
    .btnDanger:hover{border-color: rgba(239,68,68,.60)}
    .btnOk:hover{border-color: rgba(16,185,129,.55)}
    details summary{cursor:pointer; font-weight:900}
    .inline{display:flex; gap:10px; align-items:center; flex-wrap:wrap}
    .imgPrev{width:100%; max-height:220px; object-fit:cover; border-radius:14px; border:1px solid var(--border)}
    .qrPrev{width:100%; max-height:220px; object-fit:contain; border-radius:14px; border:1px solid var(--border); background:rgba(15,23,42,.02)}
    .subcard{
      background: rgba(15,23,42,.02);
      border:1px dashed rgba(15,23,42,.18);
      border-radius:16px;
      padding:12px;
    }
    .kpi{display:flex; gap:10px; flex-wrap:wrap; margin-top:8px}
    .kpi .tag{font-weight:900}

    .stateGood{border-color: rgba(16,185,129,.35); color:#065f46; background:rgba(16,185,129,.08)}
    .stateBad{border-color: rgba(239,68,68,.35); color:#7f1d1d; background:rgba(239,68,68,.06)}

    .chkline{display:flex; align-items:center; gap:10px; flex-wrap:wrap}
    .chkline input[type="checkbox"]{width:18px; height:18px; margin:0}

    .mini{font-size:12px}
    .optBox{border:1px solid rgba(15,23,42,.10); border-radius:16px; padding:10px 12px; background:#fff}
    .optRow{display:grid; grid-template-columns: 1fr 140px 120px; gap:10px}
    @media (max-width:980px){.optRow{grid-template-columns:1fr}}

    /* STEP1ï¼šè¨‚é¤ç´€éŒ„-ä¸Šæ–¹æ©«æ¢ */
    #view_orders .ordersTopBar{
      display:flex;
      align-items:flex-end;
      justify-content:space-between;
      gap:12px;
      flex-wrap:wrap;
    }
    #view_orders .ordersTopBar .leftCtl{
      display:flex;
      gap:12px;
      align-items:flex-end;
      flex-wrap:wrap;
    }
    #view_orders .ordersTopBar .dateBox{
      min-width:260px;
    }
    @media (max-width:980px){
      #view_orders .ordersTopBar .dateBox{ min-width:100%; }
    }

    /* ğŸ”” æœªé»é¤æé†’æ¢ */
    .alertBar{
      margin-top:8px;
      padding:8px 10px;
      border-radius:12px;
      font-size:13px;
      line-height:1.5;
    }
    .alertWarn{
      background:rgba(248,113,113,.06);
      border:1px solid rgba(248,113,113,.45);
      color:#7f1d1d;
    }
    .alertOk{
      background:rgba(16,185,129,.06);
      border:1px solid rgba(16,185,129,.45);
      color:#064e3b;
    }

    /* ğŸ”” æœªé»é¤å½ˆè·³è¦–çª— */
    .modalMask{
      position:fixed;
      inset:0;
      background:rgba(15,23,42,.35);
      display:flex;
      align-items:center;
      justify-content:center;
      z-index:50;
    }
    .modalBox{
      background:#fff;
      border-radius:18px;
      padding:18px 18px 14px;
      max-width:420px;
      width:90%;
      box-shadow:0 20px 40px rgba(15,23,42,.35);
    }

 /* =============== çµå–® Modal å‹•ç•« =============== */

/* é»‘èƒŒæ™¯æ·¡å…¥ */
.modalMask.fadeIn {
  animation: fadeInBg 0.25s ease forwards;
}

@keyframes fadeInBg {
  from { background: rgba(0,0,0,0); }
  to   { background: rgba(0,0,0,0.35); }
}

/* å…§å®¹å¾®ç¸®æ”¾å½ˆå‡º */
.modalBox.popIn {
  animation: popIn 0.28s cubic-bezier(0.15, 1.30, 0.40, 1) forwards;
}

@keyframes popIn {
  0%   { transform: scale(0.85); opacity: 0; }
  60%  { transform: scale(1.05); opacity: 1; }
  100% { transform: scale(1.00); opacity: 1; }
}

    /* ğŸ“… ç­è¡¨æ¨£å¼ */
    .schDayBlock{
      border:1px solid var(--border);
      border-radius:16px;
      background:#fff;
      margin-top:10px;
    }
    .schDayBlock > details{
      padding:8px 10px 10px;
    }
    .schDaySummary{
      list-style:none;
      font-size:14px;
      font-weight:700;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:8px;
    }
    .schDaySummary::-webkit-details-marker{display:none;}
    .schDayInner{
      margin-top:8px;
    }
    .schDeptBlock{
      padding:8px 4px;
      border-top:1px dashed rgba(15,23,42,.12);
    }
    .schDeptBlock:first-of-type{
      border-top:none;
    }
    .schDeptTitle{
      font-size:12.5px;
      font-weight:800;
      color:var(--muted);
      margin-bottom:4px;
    }
    .schStaffGrid{
      display:flex;
      flex-wrap:wrap;
      gap:6px 14px;
    }
    .schStaff{
      font-size:13px;
      display:flex;
      align-items:center;
      gap:4px;
    }
    .tag.miniTag{
      font-size:11px;
      padding:3px 7px;
    }
  </style>
</head>
<body>

  <div class="layout">
    <aside class="sidebar">
      <div class="brand">
        <div>
          <h1>ç®¡ç†è€…å¾Œå°</h1>
          <small>GoldBricks Order</small>
        </div>
        <span class="tag">admin</span>
      </div>

      <div class="nav">
        <button class="navBtn" data-view="staff">ç®¡ç†äººå“¡</button>
        <button class="navBtn" data-view="schedule">ç­è¡¨ç®¡ç†</button>
        <button class="navBtn" data-view="addRestaurant">æ–°å¢é¤å»³</button>
        <button class="navBtn" data-view="restaurants">é¤å»³ç®¡ç†</button>
        <button class="navBtn" data-view="orders">è¨‚é¤ç´€éŒ„</button>
        <div class="hr"></div>
        <button id="switchUser" class="navBtn">åˆ‡æ›ä½¿ç”¨è€…æ¨¡å¼</button>
        <button id="logout" class="navBtn">ç™»å‡º</button>
      </div>

      <p class="muted" style="margin:12px 8px 0;">
        âœ… é¤å»³ï¼šå¯é¡¯ç¤º/éš±è—ã€å¯çµå–®/é–‹å–®ã€å¯è¨­å®šç‡Ÿæ¥­æ™‚é–“/å…¬ä¼‘æ—¥<br/>
        âœ… è¨‚å–®ï¼šæ”¯æ´ Excel åŒ¯å‡ºã€æ”¯æ´åˆªæ•´ç­†/åˆªå–®ä¸€é“<br/>
        âœ… é¤é»ï¼šæ”¯æ´ã€Œæ“‡ä¸€(ä¸‹æ‹‰) / åŠ è³¼(å¤šé¸)ã€é¸é …<br/>
        âœ… æ–°å¢é¤é»ï¼šé¤é»é¡åˆ¥æ”¯æ´ã€Œç¾¤çµ„æ–°å¢ + æ‹–æ›³æ’åºã€<br/>
        âœ… ç­è¡¨ï¼šæ¯æœˆå¯å‹¾é¸ä¸Šç­äººå“¡ï¼Œè¨‚é¤é æœƒæé†’æœªé»é¤åå–®<br/>
      </p>
    </aside>

    <main class="main">
      <div class="topbar">
        <h2 id="pageTitle">æ–°å¢é¤å»³</h2>
        <div class="right">
          <span class="pill" id="statusPill">é€£ç·šä¸­â€¦</span>
          <button class="ghost" id="gotoIndex">ğŸ°</button>
        </div>
      </div>

      <!-- VIEW: æ–°å¢é¤å»³ -->
      <section class="view" id="view_addRestaurant">
        <div class="grid">
          <div class="card">
            <h3>é¤å»³è³‡æ–™ï¼ˆé»æ“Šæ–°å¢ï¼‰</h3>

          <label>é¤å»³åˆ†é¡ï¼ˆå¯è¼¸å…¥æˆ–å¿«é€Ÿé¸æ“‡ï¼‰</label>
<div class="row">
  <div>
    <input id="r_category" autocomplete="off" placeholder="ä¾‹ï¼šç‡’è‡˜ / ç²¥å“ / éºµé¡ / ä¾¿ç•¶"/>
  </div>

  <div>
    <select id="r_category_select">
      <option value="">é¸æ“‡å·²ä½¿ç”¨éçš„åˆ†é¡</option>
    </select>
  </div>
</div>

            <label>é¤å»³åç¨±</label>
            <input id="r_name" name="r_name_no_autofill" autocomplete="off" placeholder="ä¾‹ï¼šé‡‘ç£šä¾¿ç•¶"/>

            <div class="row">
              <div>
                <label>é›»è©±</label>
                <input id="r_phone" autocomplete="off" placeholder="ä¾‹ï¼š02-1234-5678"/>
              </div>
              <div>
                <label>åœ°å€</label>
                <input id="r_addr" autocomplete="off" placeholder="ä¾‹ï¼šå°ä¸­å¸‚â€¦"/>
              </div>
            </div>

            <div class="row">
              <div>
                <label>Google map é€£çµ</label>
                <input id="r_map" autocomplete="off" placeholder="https://maps.google.com/..."/>
              </div>
              <div>
                <label>é¤å»³åœ–ç‰‡ç¶²å€</label>
                <input id="r_imgUrl" autocomplete="off" placeholder="https://...jpg / png"/>
              </div>
            </div>

            <label>ç‡Ÿæ¥­æ™‚é–“</label>
            <input id="r_hours" autocomplete="off" placeholder="ä¾‹ï¼š11:00~14:30 / 16:30~19:30"/>

            <label>å…¬ä¼‘æ—¥</label>
            <div class="chkline mini" id="r_weeklyOffWrap">
              <label style="margin:0; display:flex; align-items:center; gap:6px;">
                <input type="checkbox" data-weekday="é€±ä¸€å…¬ä¼‘"> é€±ä¸€
              </label>
              <label style="margin:0; display:flex; align-items:center; gap:6px;">
                <input type="checkbox" data-weekday="é€±äºŒå…¬ä¼‘"> é€±äºŒ
              </label>
              <label style="margin:0; display:flex; align-items:center; gap:6px;">
                <input type="checkbox" data-weekday="é€±ä¸‰å…¬ä¼‘"> é€±ä¸‰
              </label>
              <label style="margin:0; display:flex; align-items:center; gap:6px;">
                <input type="checkbox" data-weekday="é€±å››å…¬ä¼‘"> é€±å››
              </label>
              <label style="margin:0; display:flex; align-items:center; gap:6px;">
                <input type="checkbox" data-weekday="é€±äº”å…¬ä¼‘"> é€±äº”
              </label>
              <label style="margin:0; display:flex; align-items:center; gap:6px;">
                <input type="checkbox" data-weekday="é€±å…­å…¬ä¼‘"> é€±å…­
              </label>
              <label style="margin:0; display:flex; align-items:center; gap:6px;">
                <input type="checkbox" data-weekday="é€±æ—¥å…¬ä¼‘"> é€±æ—¥
              </label>
            </div>

            <div class="row">
              <div>
                <label>Line QR Code åœ–ç‰‡ç¶²å€</label>
                <input id="r_lineQrUrl" autocomplete="off" placeholder="https://...pngï¼ˆQR code åœ–ï¼‰"/>
              </div>
              <div class="muted" style="display:flex; align-items:end"></div>
            </div>

            <img id="r_imgPrev" class="imgPrev" style="display:none; margin-top:10px" alt="preview"/>
            <img id="r_lineQrPrev" class="qrPrev" style="display:none; margin-top:10px" alt="Line QR preview"/>

            <div class="row">
              <div class="chkline" style="margin-top:12px">
                <input id="r_visible" type="checkbox" checked>
                <label style="margin:0; color:var(--muted)">ä½¿ç”¨è€…é¡¯ç¤º</label>
              </div>
              <div class="chkline" style="margin-top:12px">
                <input id="r_closed" type="checkbox">
                <label style="margin:0; color:var(--muted)">çµå–®ï¼ˆä½¿ç”¨è€…ä¸å¯é€å–®ï¼‰</label>
              </div>
            </div>

            <label>å‚™è¨»</label>
            <textarea id="r_note" autocomplete="off" placeholder="å¯å¡«ç‡Ÿæ¥­æ™‚é–“è£œå……ã€ä»˜æ¬¾æ–¹å¼â€¦"></textarea>

            <div class="actions">
              <button class="primary" id="btnSubmitAll">æ–°å¢ï¼ˆé¤å»³ + é¤é»æ¸…å–®ï¼‰</button>
              <button class="ghost" id="btnClearAll" type="button">æ¸…ç©º</button>
            </div>

            <p class="muted">å³é‚Šå¯å…ˆæŠŠé¤é»åŠ å…¥æ¸…å–®ï¼Œå†æŒ‰ä¸€æ¬¡ã€Œç›´æ¥æ–°å¢ä¸Šã€ã€‚</p>
          </div>

          <div class="card">
            <h3>é¤é»ï¼ˆå…ˆåŠ å…¥æ¸…å–®ï¼Œå¯å¤šç­†ï¼‰</h3>

            <!-- âœ… é¤é»é¡åˆ¥ï¼ˆç¾¤çµ„åˆ¶ + æ‹–æ›³æ’åºï¼‰ -->
            <h3 style="margin-top:0">é¤é»é¡åˆ¥ï¼ˆéœ€å…ˆå»ºç«‹ç¾¤çµ„ï¼‰</h3>
            <div class="subcard">
              <div class="inline">
                <input id="cat_input" placeholder="ä¾‹ï¼šé£¯é¡ / éºµé¡ / å°èœ / é£²æ–™"/>
                <button class="btnSmall btnOk" id="btnAddCatGroup" type="button">æ–°å¢é¡åˆ¥</button>
              </div>

              <div id="catGroupWrap" class="kpi" style="margin-top:10px"></div>
              <div class="muted mini">å¯æ‹–æ›³èª¿æ•´é¡¯ç¤ºé †åºï¼ˆâ˜° ä½ç½®æŒ‰ä½æ‹–æ‹‰ï¼‰</div>
            </div>

            <label style="margin-top:12px">é¤é»é¡åˆ¥ï¼ˆå¾å·²å»ºç«‹ç¾¤çµ„é¸æ“‡ï¼‰</label>
            <select id="m_cat">
              <option value="">è«‹å…ˆé¸æ“‡é¤é»é¡åˆ¥</option>
            </select>

            <div class="row" style="margin-top:10px">
              <div>
                <label>é¤é»åç¨±</label>
                <input id="m_name" placeholder="ä¾‹ï¼šæ³•å¼ç‚’éºµ"/>
              </div>
              <div>
                <label>åƒ¹æ ¼ï¼ˆå–®ä»½ï¼‰</label>
                <input id="m_price" type="number" min="0" placeholder="120"/>
              </div>
            </div>

            <div class="row">
              <div>
                <label>é è¨­æ•¸é‡</label>
                <input id="m_defaultQty" type="number" min="1" value="1"/>
              </div>
              <div class="muted" style="display:flex; align-items:end"></div>
            </div>

           <div class="hr"></div>

<details id="secOptionGroups" class="fold">
  
  <summary>
    âœ… é¸é …ç¾¤çµ„ï¼ˆå¯é¸è¦ä¸è¦ç”¨ï¼‰
    <span class="muted mini" style="margin-left:8px">ï¼ˆå¯æ”¶åˆï¼‰</span>
  </summary>

  <p class="muted mini" style="margin-top:8px">
    -ã€Œæ“‡ä¸€ã€ï¼šä½¿ç”¨è€…æœƒé¡¯ç¤ºä¸‹æ‹‰é¸å–®ï¼ˆä¾‹ï¼šè‚‰é¡ï¼šè±¬è‚‰/é›è‚‰ï¼‰<br/>
    -ã€ŒåŠ è³¼ã€ï¼šä½¿ç”¨è€…æœƒé¡¯ç¤ºå¯å‹¾é¸ï¼ˆä¾‹ï¼šåŠ è›‹ +10 / åŠ éºµ +15ï¼‰
  </p>

            <div class="subcard">
              <div class="row3">
                <div>
                  <label>ç¾¤çµ„åç¨±</label>
                  <input id="og_name" placeholder="ä¾‹ï¼šè‚‰é¡ / é†¬æ–™ / éºµé«”"/>
                </div>
                <div>
                  <label>é¡å‹</label>
                  <select id="og_type">
                    <option value="single">æ“‡ä¸€ï¼ˆä¸‹æ‹‰ï¼‰</option>
                    <option value="addon">åŠ è³¼ï¼ˆå¤šé¸ï¼‰</option>
                  </select>
                </div>
                <div style="display:flex; align-items:end; gap:10px">
                  <label style="display:flex; align-items:center; gap:8px; margin:0;">
                    <input id="og_required" type="checkbox" style="width:18px; height:18px;" checked/>
                    å¿…é¸ï¼ˆæ“‡ä¸€ç”¨ï¼‰
                  </label>
                  <button class="btnSmall btnOk" id="btnStartGroup" type="button">æ–°å¢ç¾¤çµ„</button>
                </div>
              </div>

              <div id="groupDraftArea" style="margin-top:10px; display:none">
                <div class="optBox">
                  <div class="inline" style="justify-content:space-between; align-items:flex-start">
                    <div>
                      <b id="draftGroupTitle">ç¾¤çµ„</b>
                      <div class="muted mini" id="draftGroupDesc"></div>
                    </div>
                    <button class="btnSmall btnDanger" id="btnCancelGroup" type="button">å–æ¶ˆç¾¤çµ„</button>
                  </div>

                  <div class="hr"></div>

                  <div class="optRow">
                    <div>
                      <label>é¸é …åç¨±</label>
                      <input id="opt_name" placeholder="ä¾‹ï¼šè±¬è‚‰ / é›è‚‰ / åŠ è›‹"/>
                    </div>
                    <div>
                      <label>åŠ åƒ¹ï¼ˆå¯ç‚º 0ï¼‰</label>
                      <input id="opt_price" type="number" min="0" placeholder="0"/>
                    </div>
                    <div style="display:flex; align-items:end; gap:10px">
                      <button class="btnSmall btnOk" id="btnAddChoice" type="button">åŠ å…¥é¸é …</button>
                    </div>
                  </div>

                  <div id="choiceDraftList" style="margin-top:10px"></div>

                  <div class="actions">
                    <button class="btnSmall btnOk" id="btnCommitGroup" type="button">å®Œæˆæ­¤ç¾¤çµ„ï¼ˆåŠ å…¥åˆ°é¤é»ï¼‰</button>
                  </div>
                </div>
              </div>

              <div id="menuOptionGroupsList" style="margin-top:10px"></div>
              </div>

             </details>

<!-- =========================
âœ… å¥—é¤é¸é …ï¼ˆå¯é¸è¦ä¸è¦ç”¨ï¼‰
========================= -->
<div class="hr"></div>

<!-- âœ… é è¨­æ”¶åˆï¼šä¸è¦åŠ  open -->
<details id="secSetMeal" class="fold">
  <summary>
    âœ… å¥—é¤é¸é …ï¼ˆå¯é¸è¦ä¸è¦ç”¨ï¼‰
    <span class="muted mini" style="margin-left:8px">ï¼ˆå¯æ”¶åˆï¼‰</span>
  </summary>

  <p class="muted mini" style="margin-top:8px">
    - å…ˆå»ºç«‹ã€Œå¥—é¤æ¨¡æ¿ã€ï¼Œå¯è¨­å®šæ¯å€‹é¡åˆ¥è¦ã€Œé¸1/é¸2ã€ï¼Œèˆ‡å„é¸é …åŠ åƒ¹<br/>
    - å»ºå¥½å¾Œï¼Œåœ¨ä¸‹æ–¹å‹¾é¸ã€Œæ­¤é¤é»æ”¯æ´å“ªäº›å¥—é¤ã€
  </p>

  <div class="subcard">
    <div class="row3">
      <div>
        <label>å¥—é¤åç¨±</label>
        <input id="sm_name" placeholder="ä¾‹ï¼šAé¤ / è¶…å€¼å¥—é¤"/>
      </div>
      <div>
        <label>å¥—é¤åƒ¹æ ¼ï¼ˆåŸºç¤ï¼‰</label>
        <input id="sm_price" type="number" min="0" placeholder="ä¾‹ï¼š59"/>
      </div>
      <div style="display:flex; align-items:end; gap:10px">
        <button class="btnSmall btnOk" id="btnStartSetMeal" type="button">æ–°å¢å¥—é¤</button>
      </div>
    </div>

    <!-- å¥—é¤ç·¨è¼¯å€ï¼ˆè‰ç¨¿ï¼‰ -->
    <div id="setMealDraftArea" style="margin-top:10px; display:none">
      <div class="optBox">
        <div class="inline" style="justify-content:space-between; align-items:flex-start">
          <div>
            <b id="draftSetMealTitle">å¥—é¤</b>
            <div class="muted mini" id="draftSetMealDesc"></div>
          </div>
          <button class="btnSmall btnDanger" id="btnCancelSetMeal" type="button">å–æ¶ˆå¥—é¤</button>
        </div>

        <div class="hr"></div>

        <div class="row3">
          <div>
            <label>å¥—é¤é¡åˆ¥</label>
            <input id="sm_catName" placeholder="ä¾‹ï¼šå°é» / æ¹¯å“ / é£²å“"/>
          </div>
          <div>
            <label>æ­¤é¡åˆ¥è¦é¸å¹¾æ¨£</label>
            <select id="sm_pickCount">
              <option value="1">é¸ 1</option>
              <option value="2">é¸ 2</option>
            </select>
          </div>
          <div style="display:flex; align-items:end; gap:10px">
            <button class="btnSmall btnOk" id="btnAddSetMealCategory" type="button">åŠ å…¥é¡åˆ¥</button>
          </div>
        </div>

        <div id="setMealCategoryList" style="margin-top:10px"></div>

        <div class="actions">
          <button class="btnSmall btnOk" id="btnCommitSetMeal" type="button">å®Œæˆæ­¤å¥—é¤ï¼ˆåŠ å…¥åˆ°æ¨¡æ¿æ¸…å–®ï¼‰</button>
        </div>
      </div>
    </div>

    <!-- å·²å»ºç«‹çš„å¥—é¤æ¨¡æ¿ -->
    <div style="margin-top:10px">
      <div class="muted mini" style="margin-bottom:6px">å·²å»ºç«‹çš„å¥—é¤æ¨¡æ¿ï¼ˆå¯åˆªé™¤ï¼‰</div>
      <div id="setMealTemplatesList"></div>
    </div>

    <div class="hr"></div>

    <!-- æ­¤é¤é»æ”¯æ´å“ªäº›å¥—é¤ï¼ˆå‹¾é¸ï¼‰ -->
    <div>
      <div class="muted mini" style="margin-bottom:6px">æ­¤é¤é»æ”¯æ´å“ªäº›å¥—é¤ï¼ˆå‹¾é¸ï¼‰</div>
      <div id="setMealPickList" class="kpi"></div>
    </div>
  </div>
</details>

<div class="hr"></div>

<!-- âœ… é€™å…©é¡†æŒ‰éˆ•è¦æ”¾åœ¨ã€Œå¥—é¤ã€ä¸‹é¢ï¼ˆä½ è¦çš„ï¼‰ -->
<div class="actions">
  <button class="btnSmall btnOk" id="btnAddMenuToQueue" type="button">åŠ å…¥é¤é»æ¸…å–®</button>
  <button class="ghost" id="btnClearMenu" type="button">æ¸…ç©ºé¤é»æ¬„ä½ï¼ˆå«é¸é …ç¾¤çµ„ï¼‰</button>
</div>
            
 <div class="hr"></div>

<!-- =========================
âœ… å¥—é¤é¸é …ï¼ˆå¯é¸è¦ä¸è¦ç”¨ï¼‰
========================= -->


</div>
<!-- âœ… å¥—é¤é¸é …çµæŸ -->

           <div style="grid-column: 1 / -1">
  <div class="hr"></div>
  <h3 style="margin-top:0">é¤é»æ¸…å–®ï¼ˆå°‡ä¸€èµ·æ–°å¢ï¼‰</h3>
  <div id="menuQueueWrap" class="muted">å°šæœªåŠ å…¥é¤é»ã€‚</div>
</div>
          </div>
        </div>
      </section>

      <!-- VIEW: æ–°å¢äººå“¡ -->
      <section class="view" id="view_staff" style="display:none">
        <div class="grid">
          <div class="card">
            <h3>æ–°å¢äººå“¡</h3>

            <label>éƒ¨é–€</label>
            <input id="s_dept" list="deptList" placeholder="ä¾‹ï¼šFAE"/>
            <datalist id="deptList">
             <option>ç®¡ç†éƒ¨</option>
              <option>TSE-æ—©</option>
              <option>FAE-æ—©</option>
              <option>å€‰ç®¡</option>
              <option>æ–°å ´</option>
              <option>å·¥ç¨‹å¸«</option>
              <option>æ•™è‚²è¨“ç·´</option>
              <option>ç·šä¸Šå®¢æœ-æ—©</option>
            </datalist>

            <label>äººå“¡åç¨±</label>
            <input id="s_name" placeholder="ä¾‹ï¼šå°æ˜ï¼ˆæŒ‰ Enter ä¹Ÿå¯æ–°å¢ï¼‰"/>

            <div class="actions">
              <button class="primary" id="btnAddStaff" type="button">æ–°å¢</button>
              <button class="ghost" id="btnClearStaff" type="button">æ¸…ç©º</button>
            </div>

            <p class="muted">ç›¸åŒéƒ¨é–€æœƒè‡ªå‹•æ”¶åˆé¡¯ç¤ºï¼Œä¸¦å¯åˆªé™¤äººå“¡ã€‚</p>
          </div>

          <div class="card">
            <h3>äººå“¡æ¸…å–®</h3>
            <div id="staffWrap"></div>
          </div>
        </div>
      </section>

      <!-- VIEW: ç­è¡¨ç®¡ç† -->
      <section class="view" id="view_schedule" style="display:none">
        <div class="card">
          <h3>ç­è¡¨ç®¡ç†ï¼ˆæ¯æœˆä¸Šç­äººå“¡å‹¾é¸ï¼‰</h3>

          <div class="inline" style="margin-top:4px; align-items:flex-end;">
            <div>
              <label>æœˆä»½</label>
              <input id="sch_month" type="month"/>
            </div>
            <div>
              <button class="primary" id="btnLoadSchedule" type="button">è¼‰å…¥ç­è¡¨</button>
              <button class="ghost" id="btnScheduleToday" type="button">è·³åˆ°ä»Šå¤©</button>
            </div>
          </div>

          <p class="muted mini" style="margin-top:8px">
            âœ” å‹¾é¸ä»£è¡¨ã€Œç•¶æ—¥ä¸Šç­äººå“¡ã€ï¼›ä¾ã€éƒ¨é–€ã€‘åˆ†æ®µæ’åˆ—ã€‚<br/>
            âœ” æ—¥æœŸåˆ—é è¨­æ”¶åˆï¼Œé»ä¸€ä¸‹å¯å±•é–‹ï¼æ”¶åˆã€‚<br/>
            âœ” å‹¾ï¼å–æ¶ˆå‹¾æœƒè‡ªå‹•å„²å­˜åˆ° Firestoreã€Œschedulesã€é›†åˆã€‚<br/>
          </p>

          <div id="scheduleWrap" style="margin-top:10px"></div>
        </div>
      </section>

      <!-- VIEW: é¤å»³ç®¡ç† -->
      <section class="view" id="view_restaurants" style="display:none">
  <div class="card">
          <h3>é¤å»³ç®¡ç†</h3>
<!-- ğŸ”µ é¡¯ç¤ºä¸­çš„é¤å»³ -->
<div class="subcard" style="margin-top:10px; margin-bottom:10px;">
  <div class="inline" style="justify-content:space-between; align-items:center;">
    <div>
      <div style="font-size:13px; font-weight:800;">é¡¯ç¤ºä¸­çš„é¤å»³</div>
      <div class="muted mini">ä½¿ç”¨è€…ç«¯å¯è¦‹çš„åº—å®¶</div>
    </div>
    <span class="tag" id="restShowCount">0 å®¶</span>
  </div>
  <div id="restShowList" class="kpi" style="margin-top:8px;">
    <div class="muted mini">è¼‰å…¥ä¸­â€¦</div>
  </div>
</div>

<!-- ğŸ”µ é–‹å–®ä¸­çš„é¤å»³ -->
<div class="subcard" style="margin-top:10px; margin-bottom:10px;">
  <div class="inline" style="justify-content:space-between; align-items:center;">
    <div>
      <div style="font-size:13px; font-weight:800;">é–‹å–®ä¸­çš„é¤å»³</div>
      <div class="muted mini">ç›®å‰å¯ä¾›è¨‚å–®é€å‡ºçš„åº—å®¶</div>
    </div>
    <span class="tag" id="restOpenCount">0 å®¶</span>
  </div>
  <div id="restOpenList" class="kpi" style="margin-top:8px;">
    <div class="muted mini">è¼‰å…¥ä¸­â€¦</div>
  </div>
</div>
          <!-- ğŸ”µ ğŸ”µ ğŸ”µ ç¸½è¦½å¡ç‰‡çµæŸ ğŸ”µ ğŸ”µ ğŸ”µ -->

          <!-- ğŸ”¸ æœå°‹å€å¡Š -->
          <div class="inline" style="margin-top:10px">
            <label style="margin:0; min-width:120px; color:var(--muted)">æœå°‹é¤å»³</label>
            <input id="restSearchOpen" placeholder="è¼¸å…¥é—œéµå­—å¾ŒæŒ‰ Enter (å¯æœåº—å/åˆ†é¡/å…¬ä¼‘æ—¥/ç‡Ÿæ¥­æ™‚é–“)" style="min-width:340px">
            <button class="btnSmall" type="button" id="btnRestSearchClear">æ¸…é™¤</button>
          </div>

          <div class="hr"></div>
          <p class="muted">
            âœ…ã€Œä½¿ç”¨è€…é¡¯ç¤ºã€é—œé–‰å¾Œï¼šä½¿ç”¨è€…é çœ‹ä¸åˆ°è©²åº—<br/>
            âœ…ã€Œçµå–®ã€é–‹å•Ÿå¾Œï¼šä½¿ç”¨è€…ä¸èƒ½é€å–®<br/>
            âœ… å…¬ä¼‘æ—¥æœƒé¡¯ç¤ºåœ¨ summaryï¼Œä¾‹å¦‚ï¼šé€±ä¸€å…¬ä¼‘ãƒ»é€±æ—¥å…¬ä¼‘
          </p>
          <div id="restaurantsWrap"></div>
        </div>
      </section>

      <!-- VIEW: è¨‚é¤ç´€éŒ„ -->
      <section class="view" id="view_orders" style="display:none">
        <!-- âœ… ä¸Šï¼šæ§åˆ¶æ©«æ¢ ï¼›ä¸‹ï¼šå·¦å³å…©æ¬„ -->
        <div style="display:grid; gap:14px">

          <!-- âœ… ä¸Šæ–¹æ©«æ¢ï¼šè¨‚å–®çµ±è¨ˆï¼ˆæ§åˆ¶åˆ—ï¼‰ -->
          <div class="card">
            <h3>è¨‚å–®çµ±è¨ˆ</h3>

            <!-- ğŸ”” æœªé»é¤æé†’æ¢ -->
            <div id="noOrderBanner" class="alertBar" style="display:none"></div>

            <div class="ordersTopBar">
              <div class="leftCtl">
                <div class="dateBox">
                  <label>è¨‚å–®æ—¥æœŸ</label>
                  <input id="o_date" type="date"/>
                </div>

                <div>
                  <label>é¡¯ç¤ºæ¨¡å¼</label>
                  <div class="pill" style="height:42px; display:flex; align-items:center;">
                    åŒå“é …å½™ç¸½ï¼ˆè·¨æ‰€æœ‰äººï¼‰
                  </div>
                </div>

                <div>
                  <label>æ“ä½œ</label>
                  <div class="inline">
                    <button class="primary" id="btnLoadOrders" type="button">è¼‰å…¥</button>
                    <button class="ghost" id="btnToday" type="button">ä»Šå¤©</button>
                    <button class="btnSmall btnOk" id="btnExportExcel" type="button">åŒ¯å‡º Excel</button>
                  </div>
                </div>
              </div>
            </div>

            <p class="muted" style="margin-top:10px">
              Excel æ¬„ä½ï¼šéƒ¨é–€ã€å§“åã€é¤å»³ã€å“é …ã€åŠ è³¼/æ“‡ä¸€ã€é¤é»å‚™è¨»ã€æ•¸é‡ã€å–®åƒ¹ã€åŠ è³¼é‡‘é¡ã€å“é …é‡‘é¡ã€å“é …å°è¨ˆã€è¨‚å–®ç¸½é¡ã€ä¸‹å–®æ™‚é–“ã€æ•´å–®å‚™è¨»
            </p>
          </div>

          <!-- âœ… ä¸‹æ–¹å·¦å³ï¼šå·¦çµ±è¨ˆè¡¨ / å³è¨‚å–®æ˜ç´° -->
          <div style="display:grid; grid-template-columns: 1fr 1fr; gap:14px" id="ordersTwoCol">
            <!-- å·¦ï¼šåŒå“é …å½™ç¸½ -->
            <div class="card">
              <h3>è¨‚å–®çµ±è¨ˆï¼ˆåŒå“é …å½™ç¸½ï¼‰</h3>
              <div id="ordersSummaryOut" class="muted">è«‹é¸æ—¥æœŸå¾ŒæŒ‰ã€Œè¼‰å…¥ã€ã€‚</div>
            </div>

            <!-- å³ï¼šè¨‚å–®æ˜ç´° -->
            <div class="card">
              <h3>è¨‚å–®æ˜ç´°ï¼ˆå¯åˆªæ•´ç­† / åˆªä¸€é“ï¼‰</h3>
              <div id="ordersDetailOut" class="muted">è«‹é¸æ—¥æœŸå¾ŒæŒ‰ã€Œè¼‰å…¥ã€ã€‚</div>
            </div>
          </div>

        </div>
      </section>

      <script>
        // âœ… å°è¢å¹•è‡ªå‹•æ”¹æˆå–®æ¬„ï¼ˆä¸å½±éŸ¿ä½ åŸæœ¬å…¨åŸŸ @mediaï¼‰
        (function(){
          const mq = window.matchMedia("(max-width:980px)");
          const apply = ()=>{
            const el = document.getElementById("ordersTwoCol");
            if(!el) return;
            el.style.gridTemplateColumns = mq.matches ? "1fr" : "1fr 1fr";
          };
          apply();
          mq.addEventListener?.("change", apply);
        })();
      </script>

    </main>
  </div>

  <!-- ğŸ”” æœªé»é¤å½ˆè·³è¦–çª— -->
  <div id="noOrderModal" class="modalMask" style="display:none">
    <div class="modalBox">
      <h3 style="margin-top:0; margin-bottom:8px;">ä»Šæ—¥æœªé»é¤äººå“¡</h3>
      <div id="noOrderList" class="muted mini">
        ï¼ˆå°šç„¡è³‡æ–™ï¼‰
      </div>
      <div class="actions" style="margin-top:12px; justify-content:flex-end;">
        <button class="ghost" type="button" id="btnCloseNoOrder">é—œé–‰</button>
      </div>
    </div>
  </div>
  
  <!-- âš ï¸ çµå–®ç¢ºèªå½ˆè·³è¦–çª— -->
<div id="closeConfirmModal" class="modalMask" style="display:none;">
  <div class="modalBox">
    <h3 style="margin-top:0; margin-bottom:8px;">âš ï¸ ç¢ºå®šè¦çµå–®å—ï¼Ÿ</h3>
    <p class="muted mini" style="line-height:1.5; margin-bottom:8px;">
      çµå–®å¾Œï¼Œä½¿ç”¨è€…å°‡ç„¡æ³•å†é€å–®ã€‚<br/>
      é»æ“Šã€Œç¢ºå®šçµå–®ã€å¾Œï¼Œè¦è¨˜å¾—å„²å­˜é¤å»³è³‡æ–™å–”ã€‚
    </p>

    <!-- ğŸ” æœ¬æ—¥ä¸Šç­æœªé»é¤çš„äººå“¡ï¼ˆå‹•æ…‹å¡«å…¥ï¼‰ -->
    <div id="closeConfirmNoOrder" class="muted mini" style="margin-bottom:12px;">
      æœ¬æ—¥ä¸Šç­æœªé»é¤äººå“¡ï¼šè¨ˆç®—ä¸­â€¦
    </div>

    <div class="actions" style="justify-content:flex-end; gap:12px;">
      <button class="ghost" type="button" id="btnCancelClose">å…ˆä¸è¦</button>
      <button class="primary" type="button" id="btnConfirmClose">ç¢ºå®šçµå–®</button>
    </div>
  </div>
</div>


  <!-- âœ… Excel åŒ¯å‡ºç”¨ï¼ˆSheetJSï¼‰ -->
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>

  <script type="module">
    const roleKey = "gb_role";
    if (localStorage.getItem(roleKey) !== "admin") location.href = "./index.html";

    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-app.js";
    import {
      getFirestore, collection, addDoc, doc, updateDoc, deleteDoc, getDocs, getDoc,
      query, where, limit, writeBatch, orderBy, setDoc, onSnapshot
    } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyBdgOddTGAfqqHLnhnaJRv2_y7gyweuQEo",
      authDomain: "goldbricks-order.firebaseapp.com",
      projectId: "goldbricks-order",
      storageBucket: "goldbricks-order.firebasestorage.app",
      messagingSenderId: "463709758954",
      appId: "1:463709758954:web:429dc920f2f812d51cbe93",
      measurementId: "G-YQK8ZCC26R"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    const $ = (id)=> document.getElementById(id);
    const esc = (s)=> (s??"").toString()
      .replaceAll("&","&amp;").replaceAll("<","&lt;").replaceAll(">","&gt;").replaceAll('"',"&quot;");

    const pad2 = (n)=> String(n).padStart(2,"0");
    const todayISO = ()=>{
      const d = new Date();
      return `${d.getFullYear()}-${pad2(d.getMonth()+1)}-${pad2(d.getDate())}`;
    };
    const WEEKDAY_LABEL = ["æ—¥","ä¸€","äºŒ","ä¸‰","å››","äº”","å…­"];

    // âœ… ç›¸å®¹ï¼šcreatedAt å¯èƒ½æ˜¯ number(ms) æˆ– Firestore Timestamp
    const toMs = (v)=>{
      if(v==null) return 0;
      if(typeof v === "number") return v;
      if(typeof v?.toMillis === "function") return v.toMillis();
      if(typeof v?.seconds === "number") return Math.floor(v.seconds*1000);
      return 0;
    };
    const toTWTime = (v)=>{
      const ms = toMs(v);
      if(!ms) return "";
      try{ return new Date(ms).toLocaleString("zh-TW", { hour12:false }); }
      catch{ return String(ms); }
    };

    /* =========================================================
       âœ… éƒ¨é–€æ’åºï¼šå›ºå®šé †åºï¼ˆè¨‚å–®æ˜ç´°/Excel/äººå“¡æ¸…å–® å…±ç”¨ï¼‰
       ========================================================= */
    const DEPT_ORDER = [
     "ç®¡ç†éƒ¨",
      "TSE-æ—©",
      "FAE-æ—©",
      "å€‰ç®¡",
      "æ–°å ´",
      "å·¥ç¨‹å¸«",
      "æ•™è‚²è¨“ç·´",
      "ç·šä¸Šå®¢æœ-æ—©"
    ];
    const DEPT_INDEX = new Map(DEPT_ORDER.map((d,i)=>[d,i]));
    function deptRank(dept){
      return DEPT_INDEX.has(dept) ? DEPT_INDEX.get(dept) : 999;
    }

    const statusPill = $("statusPill");
    statusPill.textContent = "å·²é€£ç·š Firestore";

    // âœ… å¼·åˆ¶ç§»é™¤ã€Œé¤å»³åç¨±é è¨­å€¼ã€ï¼ˆé¿å…ç€è¦½å™¨è¨˜ä½ï¼‰
    window.addEventListener("load", ()=>{
      const el = $("r_name");
      if (el) el.value = "";
      const m = $("sch_month");
      if(m) m.value = todayISO().slice(0,7);
    });

    // ====== Views ======



    const pageTitle = $("pageTitle");
    const views = {
      staff: $("view_staff"),
      schedule: $("view_schedule"),
      addRestaurant: $("view_addRestaurant"),
      restaurants: $("view_restaurants"),
      orders: $("view_orders"),
    };
    function show(viewKey){
      Object.entries(views).forEach(([k,el])=> el.style.display = (k===viewKey) ? "" : "none");
      document.querySelectorAll(".navBtn[data-view]").forEach(b=> b.classList.toggle("active", b.dataset.view===viewKey));
      pageTitle.textContent =
        viewKey==="staff" ? "æ–°å¢äººå“¡" :
        viewKey==="schedule" ? "ç­è¡¨ç®¡ç†" :
        viewKey==="addRestaurant" ? "æ–°å¢é¤å»³" :
        viewKey==="restaurants" ? "é¤å»³ç®¡ç†" :
        "è¨‚é¤ç´€éŒ„";

      if(viewKey==="staff") refreshStaffList();
      if(viewKey==="restaurants") refreshRestaurantsManage();
    }
    document.querySelectorAll(".navBtn[data-view]").forEach(btn=>{
      btn.addEventListener("click", ()=> show(btn.dataset.view));
    });
    show("addRestaurant");

    $("logout").onclick = ()=>{ localStorage.removeItem(roleKey); location.href = "./index.html"; };
    $("switchUser").onclick = ()=>{ localStorage.setItem(roleKey, "user"); location.href = "./user.html"; };
    $("gotoIndex").onclick = ()=> location.href = "./index.html";

    const colRestaurants = collection(db, "restaurants");
    const colStaff = collection(db, "staff");
    const colOrders = collection(db, "orders");
    const colSchedules = collection(db, "schedules");

   // âœ… é¤å»³ç®¡ç†ï¼šå¿«å–æ¯å€‹é¤é»çš„ optionGroupsï¼Œçµ¦ inline ç·¨è¼¯ç”¨
let menuOptionCache = new Map();

// æ·±æ‹·è²æˆä¹¾æ·¨çš„ optionGroups çµæ§‹ï¼ˆå¯«å› Firestore ç”¨ï¼‰
function cloneOptionGroups(src){
  const arr = Array.isArray(src) ? src : [];
  return arr.map(g => ({
    name: g.name || "",
    type: g.type === "addon" ? "addon" : "single",
    required: !!g.required,
    choices: Array.isArray(g.choices)
      ? g.choices.map(c => ({
          name: c.name || "",
          price: Number(c.price || 0)
        }))
      : []
  }));
}
    // ====== æ–°å¢é¤å»³ï¼šåœ–ç‰‡ç¶²å€é è¦½ ======


    const r_imgUrl = $("r_imgUrl");
    const r_imgPrev = $("r_imgPrev");
    r_imgUrl.addEventListener("input", ()=>{
      const url = r_imgUrl.value.trim();
      if(!url){ r_imgPrev.style.display="none"; return; }
      r_imgPrev.src = url;
      r_imgPrev.style.display="";
    });
    r_imgPrev.addEventListener("error", ()=>{ r_imgPrev.style.display="none"; });

    // å–å¾—æ‰€æœ‰æ—¢æœ‰é¤å»³åˆ†é¡
async function loadExistingCategories() {
  const snap = await getDocs(collection(db, "restaurants"));
  const set = new Set();

  snap.forEach(doc => {
    const c = doc.data().category;
    if (c && typeof c === "string") {
      set.add(c.trim());
    }
  });

  return Array.from(set);
}

// åˆå§‹åŒ–åˆ†é¡ä¸‹æ‹‰
async function initCategoryDropdown() {
  const input = $("r_category");
  const select = $("r_category_select");

  const list = await loadExistingCategories();

  list.forEach(cat => {
    const opt = document.createElement("option");
    opt.value = cat;
    opt.textContent = cat;
    select.appendChild(opt);
  });

  select.onchange = () => {
    if (select.value) {
      input.value = select.value;
    }
  };
}

initCategoryDropdown();

    // âœ… æ–°å¢é¤å»³ï¼šLine QR é è¦½
    const r_lineQrUrl = $("r_lineQrUrl");
    const r_lineQrPrev = $("r_lineQrPrev");
    r_lineQrUrl.addEventListener("input", ()=>{
      const url = r_lineQrUrl.value.trim();
      if(!url){ r_lineQrPrev.style.display="none"; return; }
      r_lineQrPrev.src = url;
      r_lineQrPrev.style.display="";
    });
    r_lineQrPrev.addEventListener("error", ()=>{ r_lineQrPrev.style.display="none"; });

    // âœ… å…¬ä¼‘æ—¥ï¼šæ–°å¢é¤å»³è¡¨å–®æ”¶é›†/æ¸…ç©º
    function getWeeklyOffFromCreateForm(){
      const arr = [];
      document.querySelectorAll('#r_weeklyOffWrap input[type="checkbox"]').forEach(ch=>{
        if(ch.checked) arr.push(ch.dataset.weekday);
      });
      return arr;
    }
    function clearWeeklyOffCreateForm(){
      document.querySelectorAll('#r_weeklyOffWrap input[type="checkbox"]').forEach(ch=>{
        ch.checked = false;
      });
    }

    /* ===============================
       âœ… æ–°å¢é¤å»³ï¼šé¤é»é¡åˆ¥ï¼ˆç¾¤çµ„åˆ¶ + æ‹–æ›³æ’åºï¼‰
       =============================== */
    let catGroups = []; // åªå­˜å·²å»ºç«‹çš„é¤é»é¡åˆ¥

    const catInput = $("cat_input");
    const catWrap  = $("catGroupWrap");
    const catSelect = $("m_cat");

    function renderCatGroups(){
      if(catGroups.length === 0){
        catWrap.innerHTML = `<div class="muted mini">å°šæœªå»ºç«‹é¤é»é¡åˆ¥</div>`;
      }else{
        catWrap.innerHTML = catGroups.map((c,i)=>`
          <span class="tag" data-cat-index="${i}" style="cursor:grab">
            â˜° ${esc(c)}
            <button class="btnSmall btnDanger" data-del-cat="${i}" type="button">Ã—</button>
          </span>
        `).join("");
      }

      catSelect.innerHTML = `
        <option value="">è«‹é¸æ“‡é¤é»é¡åˆ¥</option>
        ${catGroups.map(c=> `<option value="${esc(c)}">${esc(c)}</option>`).join("")}
      `;

      catWrap.querySelectorAll("[data-del-cat]").forEach(btn=>{
        btn.onclick = ()=>{
          catGroups.splice(Number(btn.dataset.delCat), 1);
          renderCatGroups();
        };
      });

      Sortable.create(catWrap, {
        animation: 150,
        onEnd(){
          const newOrder = [];
          catWrap.querySelectorAll("[data-cat-index]").forEach(el=>{
            newOrder.push(catGroups[Number(el.dataset.catIndex)]);
          });
          catGroups = newOrder;
          renderCatGroups();
        }
      });
    }

    $("btnAddCatGroup").onclick = ()=>{
      const v = (catInput?.value || "").trim();
      if(!v) return alert("è«‹è¼¸å…¥é¤é»é¡åˆ¥åç¨±");
      if(catGroups.includes(v)) return alert("æ­¤é¡åˆ¥å·²å­˜åœ¨");
      catGroups.push(v);
      catInput.value = "";
      renderCatGroups();
    };
    catInput?.addEventListener("keydown", e=>{
      if(e.key==="Enter"){
        e.preventDefault();
        $("btnAddCatGroup").click();
      }
    });

    renderCatGroups();

    // ====== âœ… é¤é»ã€Œé¸é …ç¾¤çµ„ã€ï¼šæ“‡ä¸€/åŠ è³¼ï¼ˆå¯é¸è¦ä¸è¦ç”¨ï¼‰ ======
    let draftGroups = [];
    let activeGroupDraft = null;

    function renderGroups(){
      const wrap = $("menuOptionGroupsList");
      if(draftGroups.length===0){
        wrap.innerHTML = `<div class="muted">ï¼ˆå°šæœªåŠ å…¥ä»»ä½•é¸é …ç¾¤çµ„ï¼šå¯ä¸ä½¿ç”¨ï¼‰</div>`;
        return;
      }
      wrap.innerHTML = draftGroups.map((g,gi)=>{
        const choices = (g.choices||[]).map(c=> `${c.name}${Number(c.price||0)?`(+${Number(c.price||0)})`:``}`).join("ã€") || "â€”";
        return `
          <div class="inline" style="justify-content:space-between; padding:10px 12px; border:1px solid rgba(15,23,42,.10); border-radius:16px; background:#fff; margin-top:10px;">
            <div>
              <b>${esc(g.name)}</b>
              <span class="tag" style="margin-left:8px">${g.type==="single" ? "æ“‡ä¸€(ä¸‹æ‹‰)" : "åŠ è³¼(å¤šé¸)"}</span>
              ${g.type==="single" ? `<span class="tag" style="margin-left:6px">${g.required ? "å¿…é¸" : "éå¿…é¸"}</span>` : ``}
              <div class="muted mini" style="margin-top:6px">é¸é …ï¼š${esc(choices)}</div>
            </div>
            <button class="btnSmall btnDanger" type="button" data-delg="${gi}">åˆªé™¤</button>
          </div>
        `;
      }).join("");

      wrap.querySelectorAll("button[data-delg]").forEach(b=>{
        b.onclick = ()=>{
          draftGroups.splice(Number(b.dataset.delg), 1);
          renderGroups();
        };
      });
    }

    function showGroupDraftUI(on){ $("groupDraftArea").style.display = on ? "" : "none"; }

    function renderChoiceDraft(){
      const wrap = $("choiceDraftList");
      const g = activeGroupDraft;
      if(!g || !Array.isArray(g.choices) || g.choices.length===0){
        wrap.innerHTML = `<div class="muted">å°šæœªåŠ å…¥é¸é …</div>`;
        return;
      }
      wrap.innerHTML = g.choices.map((c,ci)=>`
        <div class="inline" style="justify-content:space-between; padding:8px 10px; border:1px solid rgba(15,23,42,.10); border-radius:14px; background:#fff; margin-top:8px;">
          <div>
            <b>${esc(c.name)}</b>
            <span class="tag" style="margin-left:8px">+${Number(c.price||0)}</span>
          </div>
          <button class="btnSmall btnDanger" type="button" data-delc="${ci}">åˆªé™¤</button>
        </div>
      `).join("");
      wrap.querySelectorAll("button[data-delc]").forEach(b=>{
        b.onclick = ()=>{
          g.choices.splice(Number(b.dataset.delc), 1);
          renderChoiceDraft();
        };
      });
    }

    /* =========================================================
   âœ… å¥—é¤æ¨¡æ¿ï¼ˆå¯é¸è¦ä¸è¦ç”¨ï¼‰
   ========================================================= */

const uid = () =>
  (crypto?.randomUUID?.() ||
   `sm_${Date.now()}_${Math.random().toString(16).slice(2)}`);

let setMealTemplates = [];          // å·²å»ºç«‹çš„å¥—é¤æ¨¡æ¿ï¼ˆå…¨åº—ï¼‰
let activeSetMealDraft = null;      // æ­£åœ¨ç·¨è¼¯ä¸­çš„å¥—é¤
let menuSetMealSelected = new Set();// æ­¤é¤é»å‹¾é¸çš„å¥—é¤ id

/* ===== UI helpers ===== */
function showSetMealDraftUI(on){
  $("setMealDraftArea").style.display = on ? "" : "none";
}

/* ===== å¥—é¤æ¨¡æ¿åˆ—è¡¨ ===== */
function renderSetMealTemplates(){
  const wrap = $("setMealTemplatesList");
  if(!wrap) return;

  if(setMealTemplates.length === 0){
    wrap.innerHTML = `<div class="muted">ï¼ˆå°šæœªå»ºç«‹ä»»ä½•å¥—é¤ï¼‰</div>`;
    return;
  }

  wrap.innerHTML = setMealTemplates.map((t, i)=>{
    const cats = (t.categories||[]).map(c=>{
      const opts = (c.options||[])
        .map(o=> `${o.name}${Number(o.addPrice||0) ? `(+${o.addPrice})` : ""}`)
        .join("ã€") || "â€”";
      return `${c.name}ï¼ˆé¸${c.pickCount}ï¼‰ï¼š${opts}`;
    }).join("<br/>");

    return `
      <div style="margin-top:10px; padding:10px 12px; border:1px solid rgba(15,23,42,.12); border-radius:14px; background:#fff">
        <div class="inline" style="justify-content:space-between">
          <div>
            <b>${esc(t.name)}</b>
            <span class="tag" style="margin-left:6px">å¥—é¤ ${t.price}</span>
            <div class="muted mini" style="margin-top:6px">${cats}</div>
          </div>
          <button class="btnSmall btnDanger" data-sm-del="${i}">åˆªé™¤</button>
        </div>
      </div>
    `;
  }).join("");

  wrap.querySelectorAll("[data-sm-del]").forEach(btn=>{
    btn.onclick = ()=>{
      const idx = Number(btn.dataset.smDel);
      const removed = setMealTemplates[idx];
      setMealTemplates.splice(idx,1);
      if(removed?.id) menuSetMealSelected.delete(removed.id);
      renderSetMealTemplates();
      renderSetMealPickList();
    };
  });
}

/* ===== å¥—é¤å‹¾é¸ï¼ˆæ­¤é¤é»ï¼‰ ===== */
function renderSetMealPickList(){
  const wrap = $("setMealPickList");
  if(!wrap) return;

  if(setMealTemplates.length === 0){
    wrap.innerHTML = `<div class="muted mini">ï¼ˆæ²’æœ‰å¥—é¤å¯é¸ï¼‰</div>`;
    return;
  }

  wrap.innerHTML = setMealTemplates.map(t=>{
    const checked = menuSetMealSelected.has(t.id) ? "checked" : "";
    return `
      <label class="tag" style="cursor:pointer">
        <input type="checkbox" data-sm-pick="${t.id}" ${checked}
               style="width:16px; height:16px; margin:0;">
        ${esc(t.name)} <span class="muted mini">(${t.price})</span>
      </label>
    `;
  }).join("");

  wrap.querySelectorAll("[data-sm-pick]").forEach(ch=>{
    ch.onchange = ()=>{
      const id = ch.dataset.smPick;
      ch.checked ? menuSetMealSelected.add(id)
                 : menuSetMealSelected.delete(id);
    };
  });
}

/* ===== å¥—é¤è‰ç¨¿ï¼ˆé¡åˆ¥ / é¸é …ï¼‰ ===== */
function renderSetMealCategoryList(){
  const wrap = $("setMealCategoryList");
  const t = activeSetMealDraft;
  if(!wrap) return;

  if(!t || !t.categories.length){
    wrap.innerHTML = `<div class="muted">å°šæœªåŠ å…¥é¡åˆ¥</div>`;
    return;
  }

  wrap.innerHTML = t.categories.map((c,ci)=>{
    const opts = c.options.map((o,oi)=>`
      <div class="inline" style="justify-content:space-between; margin-top:6px">
        <div>${esc(o.name)} <span class="tag">+${o.addPrice}</span></div>
        <button class="btnSmall btnDanger" data-sm-delopt="${ci}|${oi}">åˆªé™¤</button>
      </div>
    `).join("");

    return `
      <div style="margin-top:10px; padding:10px; border:1px dashed rgba(15,23,42,.2); border-radius:12px">
        <b>${esc(c.name)}</b>
        <span class="tag">é¸ ${c.pickCount}</span>

        <div class="optRow" style="margin-top:8px">
          <input data-sm-optname="${ci}" placeholder="é¸é …åç¨±">
          <input data-sm-optprice="${ci}" type="number" min="0" placeholder="åŠ åƒ¹">
          <button class="btnSmall btnOk" data-sm-addopt="${ci}">åŠ å…¥</button>
        </div>

        ${opts || `<div class="muted mini">å°šç„¡é¸é …</div>`}
      </div>
    `;
  }).join("");

  wrap.querySelectorAll("[data-sm-addopt]").forEach(btn=>{
    btn.onclick = ()=>{
      const ci = Number(btn.dataset.smAddopt);
      const nameEl = wrap.querySelector(`[data-sm-optname="${ci}"]`);
      const priceEl = wrap.querySelector(`[data-sm-optprice="${ci}"]`);
      const n = nameEl.value.trim();
      const p = Number(priceEl.value||0);
      if(!n) return alert("è«‹è¼¸å…¥é¸é …åç¨±");
      activeSetMealDraft.categories[ci].options.push({name:n, addPrice:p});
      nameEl.value = "";
      priceEl.value = "";
      renderSetMealCategoryList();
    };
  });

  wrap.querySelectorAll("[data-sm-delopt]").forEach(btn=>{
    btn.onclick = ()=>{
      const [ci,oi] = btn.dataset.smDelopt.split("|").map(Number);
      activeSetMealDraft.categories[ci].options.splice(oi,1);
      renderSetMealCategoryList();
    };
  });
}

/* ===== äº‹ä»¶ ===== */
$("btnStartSetMeal").onclick = ()=>{
  const name = $("sm_name").value.trim();
  const price = Number($("sm_price").value||0);
  if(!name) return alert("è«‹è¼¸å…¥å¥—é¤åç¨±");

  activeSetMealDraft = { id: uid(), name, price, categories: [] };
  $("draftSetMealTitle").textContent = `å¥—é¤ï¼š${name}`;
  $("draftSetMealDesc").textContent = `å¥—é¤åƒ¹ ${price}`;
  showSetMealDraftUI(true);
  renderSetMealCategoryList();
};

$("btnCancelSetMeal").onclick = ()=>{
  activeSetMealDraft = null;
  showSetMealDraftUI(false);
};

$("btnAddSetMealCategory").onclick = ()=>{
  if(!activeSetMealDraft) return;
  const n = $("sm_catName").value.trim();
  const p = Number($("sm_pickCount").value||1);
  if(!n) return alert("è«‹è¼¸å…¥é¡åˆ¥åç¨±");
  activeSetMealDraft.categories.push({name:n, pickCount:p, options:[]});
  $("sm_catName").value = "";
  renderSetMealCategoryList();
};

$("btnCommitSetMeal").onclick = ()=>{
  const t = activeSetMealDraft;
  if(!t || !t.categories.length) return alert("è‡³å°‘è¦ä¸€å€‹é¡åˆ¥");
  for(const c of t.categories){
    if(!c.options.length) return alert(`é¡åˆ¥ã€Œ${c.name}ã€æ²’æœ‰é¸é …`);
  }
  setMealTemplates.push(t);
  activeSetMealDraft = null;
  showSetMealDraftUI(false);
  $("sm_name").value = "";
  $("sm_price").value = "";
  renderSetMealTemplates();
  renderSetMealPickList();
};

/* ===== åˆå§‹åŒ– ===== */
renderSetMealTemplates();
renderSetMealPickList();

    $("btnStartGroup").onclick = ()=>{
      const name = $("og_name").value.trim();
      const type = $("og_type").value;
      const required = !!$("og_required").checked;

      if(!name) return alert("è«‹è¼¸å…¥ç¾¤çµ„åç¨±");
      activeGroupDraft = { name, type, required: (type==="single" ? required : false), choices: [] };

      $("draftGroupTitle").textContent = `ç¾¤çµ„ï¼š${name}`;
      $("draftGroupDesc").textContent = type==="single"
        ? `é¡å‹ï¼šæ“‡ä¸€ï¼ˆä¸‹æ‹‰ï¼‰ï½œ${required ? "å¿…é¸" : "éå¿…é¸"}`
        : `é¡å‹ï¼šåŠ è³¼ï¼ˆå¤šé¸ï¼‰`;

      $("opt_name").value = "";
      $("opt_price").value = "";
      showGroupDraftUI(true);
      renderChoiceDraft();
    };

    $("btnCancelGroup").onclick = ()=>{
      activeGroupDraft = null;
      showGroupDraftUI(false);
      renderChoiceDraft();
    };

    $("btnAddChoice").onclick = ()=>{
      if(!activeGroupDraft) return;
      const n = $("opt_name").value.trim();
      const p = Number($("opt_price").value || 0);
      if(!n) return alert("è«‹è¼¸å…¥é¸é …åç¨±");
      if(isNaN(p) || p < 0) return alert("åŠ åƒ¹ä¸æ­£ç¢º");

      activeGroupDraft.choices.push({ name: n, price: p });
      $("opt_name").value = "";
      $("opt_price").value = "";
      renderChoiceDraft();
    };

    $("opt_price").addEventListener("keydown",(e)=>{
      if(e.key==="Enter"){ e.preventDefault(); $("btnAddChoice").click(); }
    });
    $("opt_name").addEventListener("keydown",(e)=>{
      if(e.key==="Enter"){ e.preventDefault(); $("btnAddChoice").click(); }
    });

    $("btnCommitGroup").onclick = ()=>{
      const g = activeGroupDraft;
      if(!g) return;
      if(!Array.isArray(g.choices) || g.choices.length===0) return alert("è«‹è‡³å°‘åŠ å…¥ 1 å€‹é¸é …");
      draftGroups.push(g);

      activeGroupDraft = null;
      $("og_name").value = "";
      $("og_type").value = "single";
      $("og_required").checked = true;
      showGroupDraftUI(false);
      renderGroups();
    };

    renderGroups();

    // ====== æ–°å¢é¤å»³ï¼šé¤é»æ¸…å–®ï¼ˆå«é¸é …ç¾¤çµ„ï¼‰ ======
    let menuQueue = [];

    function summarizeGroups(groups){
      const gs = Array.isArray(groups) ? groups : [];
      if(gs.length===0) return "ï¼ˆç„¡ï¼‰";
      return gs.map(g=>{
        const t = g.type==="single" ? "æ“‡ä¸€" : "åŠ è³¼";
        return `${g.name}-${t}`;
      }).join("ã€");
    }

    function renderMenuQueue(){
  const wrap = $("menuQueueWrap");
  if(!wrap) return;

  if(menuQueue.length===0){
    wrap.innerHTML = '<div class="muted">å°šæœªåŠ å…¥é¤é»ã€‚</div>';
    return;
  }

  const group = new Map();
  for(const m of menuQueue){
    const cat = (m.category||"æœªåˆ†é¡").trim() || "æœªåˆ†é¡";
    if(!group.has(cat)) group.set(cat, []);
    group.get(cat).push(m);
  }

  wrap.innerHTML = Array.from(group.entries()).map(([cat, list])=>{
    const rows = list.map((m)=>{
      const globalIndex = menuQueue.indexOf(m);

      // âœ… å–å‡ºé€™é“é¤å‹¾é¸çš„å¥—é¤åç¨±
      let setMealNames = [];
      if(Array.isArray(m.setMealTemplateIds) && Array.isArray(setMealTemplates)){
        setMealNames = setMealTemplates
          .filter(t => m.setMealTemplateIds.includes(t.id))
          .map(t => t.name);
      }
      const setMealText = setMealNames.length ? setMealNames.join("ã€") : "ç„¡";

      return `
        <div style="margin-top:10px; padding:10px 12px; border:1px solid rgba(15,23,42,.10); border-radius:16px; background:#fff">
          <div class="inline" style="justify-content:space-between">
            <div>
              <b>${esc(m.name)}</b>
              <span class="tag" style="margin-left:6px">åƒ¹æ ¼ ${Number(m.price||0)}</span>
              <span class="tag" style="margin-left:6px">é è¨­æ•¸é‡ ${Number(m.defaultQty||1)}</span>
            </div>
            <button class="btnSmall btnDanger" data-del-menu="${globalIndex}" type="button">åˆªé™¤</button>
          </div>

          <div class="muted mini" style="margin-top:8px">å¥—é¤ï¼š${esc(setMealText)}</div>
          <div class="muted mini" style="margin-top:4px">é¸é …ç¾¤çµ„ï¼š${esc(summarizeGroups(m.optionGroups))}</div>
        </div>
      `;
    }).join("");

    return `
      <details style="border:1px solid rgba(15,23,42,.10); border-radius:16px; padding:10px 12px; background:#fff; margin-top:10px;">
        <summary>${esc(cat)} <span class="tag" style="margin-left:8px">${list.length} é“</span></summary>
        <div style="margin-top:10px">${rows}</div>
      </details>
    `;
  }).join("");

  wrap.querySelectorAll("button[data-del-menu]").forEach(b=>{
    b.onclick = ()=>{
      menuQueue.splice(Number(b.dataset.delMenu), 1);
      renderMenuQueue();
    };
  });
}
    renderMenuQueue();

   $("btnClearMenu").onclick = ()=>{
  $("m_cat").value="";
  $("m_name").value="";
  $("m_price").value="";
  $("m_defaultQty").value="1";

  draftGroups = [];
  activeGroupDraft = null;
  showGroupDraftUI(false);
  $("og_name").value="";
  $("og_type").value="single";
  $("og_required").checked=true;
  $("opt_name").value="";
  $("opt_price").value="";
  renderGroups();
  renderChoiceDraft();

  // âœ… æ¸…æ‰ã€Œæœ¬é¤é»å‹¾é¸çš„å¥—é¤ã€ï¼ˆæ¨¡æ¿ä¿ç•™ï¼‰
  menuSetMealSelected = new Set();
  renderSetMealPickList();
};

   $("btnAddMenuToQueue").onclick = ()=>{
  const category = $("m_cat").value;
  if(!category) return alert("è«‹å…ˆå»ºç«‹ä¸¦é¸æ“‡é¤é»é¡åˆ¥ï¼ˆéœ€ä½¿ç”¨æ–°å¢é¡åˆ¥ç¾¤çµ„ï¼‰");

  const name = $("m_name").value.trim();
  const price = Number($("m_price").value||0);
  const defaultQty = Math.max(1, Number($("m_defaultQty").value||1));

  if(!name) return alert("è«‹è¼¸å…¥é¤é»åç¨±");
  if(isNaN(price) || price<0) return alert("åƒ¹æ ¼ä¸æ­£ç¢º");

  const optionGroups = (draftGroups||[]).map(g=> ({
    name: g.name,
    type: g.type,
    required: !!g.required,
    choices: (g.choices||[]).map(c=> ({ name:c.name, price:Number(c.price||0) }))
  }));

  // âœ… å¥—é¤ï¼šæŠŠå‹¾é¸çš„å¥—é¤ id ä¸€èµ·å¸¶é€²é¤é»
  const setMealTemplateIds = Array.from(menuSetMealSelected);

  menuQueue.push({ category, name, price, defaultQty, optionGroups, setMealTemplateIds });

  // âœ… åªæ¸…ç©ºé¤é»æ¬„ä½ï¼ˆä¿ç•™é¸é …ç¾¤çµ„ï¼‰
  $("m_name").value = "";
  $("m_price").value = "";
  $("m_defaultQty").value = "1";

  // âœ… æ¸…æ‰ã€Œæœ¬é¤é»å‹¾é¸çš„å¥—é¤ã€ï¼Œé¿å…ä¸‹ä¸€é“æ²¿ç”¨
  menuSetMealSelected = new Set();
  renderSetMealPickList();

  renderMenuQueue();
};

    ["m_name","m_price","m_defaultQty"].forEach(id=>{
      $(id).addEventListener("keydown",(e)=>{
        if(e.key==="Enter"){
          e.preventDefault();
          $("btnAddMenuToQueue").click();
        }
      });
    });

    $("btnClearAll").onclick = ()=>{
      $("r_category").value="";
      $("r_name").value=""; $("r_phone").value=""; $("r_addr").value="";
      $("r_map").value=""; $("r_note").value="";
      $("r_hours").value="";
      $("r_imgUrl").value=""; r_imgPrev.style.display="none";
      $("r_lineQrUrl").value=""; r_lineQrPrev.style.display="none";
      $("r_visible").checked = true;
      $("r_closed").checked = false;
      clearWeeklyOffCreateForm();

      catGroups = [];
      if(catInput) catInput.value = "";
      renderCatGroups();

      // âœ…ã€é€™ä¸€æ®µæ˜¯ä½ è¦åŠ çš„ã€‘
  setMealTemplates = [];
  activeSetMealDraft = null;
  menuSetMealSelected = new Set();
  showSetMealDraftUI(false);
  renderSetMealTemplates();
  renderSetMealPickList();
      
      menuQueue = [];
      $("btnClearMenu").click();
      renderMenuQueue();
    };

    $("btnSubmitAll").onclick = async ()=>{
  const name = $("r_name").value.trim();
  if(!name) return alert("è«‹è¼¸å…¥é¤å»³åç¨±");
  statusPill.textContent = "æ–°å¢é¤å»³ä¸­â€¦";

  try{
    const restaurantRef = await addDoc(colRestaurants, {
      category: $("r_category").value.trim(),
      name,
      phone: $("r_phone").value.trim(),
      address: $("r_addr").value.trim(),
      mapUrl: $("r_map").value.trim(),
      note: $("r_note").value.trim(),
      businessHours: $("r_hours").value.trim(),
      weeklyOff: getWeeklyOffFromCreateForm(),
      imageUrl: $("r_imgUrl").value.trim(),
      lineQrUrl: $("r_lineQrUrl").value.trim(),
      isVisible: $("r_visible").checked,
      isClosed: $("r_closed").checked,
      createdAt: Date.now()
    });

    if(menuQueue.length>0){
      statusPill.textContent = "æ–°å¢é¤é»æ¸…å–®ä¸­â€¦";
      const menuCol = collection(db, "restaurants", restaurantRef.id, "menu");

      for(const m of menuQueue){
        await addDoc(menuCol, {
          category: m.category,
          name: m.name,
          price: Number(m.price||0),
          defaultQty: Math.max(1, Number(m.defaultQty||1)),
          optionGroups: Array.isArray(m.optionGroups) ? m.optionGroups : [],
          // âœ… å¥—é¤ id ä¸€èµ·å¯«å…¥
          setMealTemplateIds: Array.isArray(m.setMealTemplateIds) ? m.setMealTemplateIds : [],
          createdAt: Date.now()
        });
      }
    }

    statusPill.textContent = "æ–°å¢å®Œæˆ âœ…";
    alert(menuQueue.length>0 ? "é¤å»³ + é¤é»å·²æ–°å¢ï¼" : "é¤å»³å·²æ–°å¢ï¼");
    $("btnClearAll").click();
    await refreshRestaurantsManage();

  }catch(err){
    console.error(err);
    alert("æ–°å¢å¤±æ•—\n\n" + (err?.message || err));
    statusPill.textContent = "æ–°å¢å¤±æ•—ï¼ˆçœ‹ consoleï¼‰";
  }
};

    /* ===== staff / restaurants / ç­è¡¨ ===== */

    // ä¾›ç­è¡¨/æœªé»é¤ä½¿ç”¨çš„å…¨åŸŸäººå“¡å¿«å–
let allStaffBase = [];
let allStaffLoaded = false;

// âœ… åªæŠ“ä¸€æ¬¡ staffï¼Œä¸¦ç…§ã€Œéƒ¨é–€é †åº + æ–°å¢é †åºã€æ’å¥½
async function loadAllStaffOnce(){
  if(allStaffLoaded && allStaffBase.length) return;

    const snap = await getDocs(colStaff);
  const arr = [];
  snap.forEach(d=>{
    const v = d.data() || {};
    arr.push({
      id: d.id,
      ...v
    });
  });

  // âœ… ä¾è‡ªè¨‚éƒ¨é–€é †åº +ã€Œæ–°å¢é †åºã€ï¼ˆåŒéƒ¨é–€å…§ç…§ä½ æ–°å¢é †åºï¼‰
  arr.sort((a,b)=>{
  const da = (a.dept || "").trim();
  const db = (b.dept || "").trim();

  const ra = deptRank(da);
  const rb = deptRank(db);
  if(ra !== rb) return ra - rb;

  const oa = Number(a.order || 0);
  const ob = Number(b.order || 0);
  if(oa !== ob) return oa - ob;

  const ta = Number(a.createdAt || 0);
  const tb = Number(b.createdAt || 0);
  if(ta !== tb) return ta - tb;

  return (a.name || "").localeCompare((b.name || ""), "zh-Hant");
});

  allStaffBase = arr;
  allStaffLoaded = true;
}

/* âœ… äººå“¡æ¸…å–®ï¼šä¾æŒ‡å®šéƒ¨é–€é †åºï¼ˆç®¡ç†éƒ¨â†’æ–°å ´â†’â€¦â†’æ•™è‚²è¨“ç·´ï¼‰ */
async function refreshStaffList(){
  const wrap = $("staffWrap");
  wrap.innerHTML = `<div class="muted">è¼‰å…¥ä¸­â€¦</div>`;

  try{
    // ç”¨å…±ç”¨çš„å¿«å– + æ’åº
    await loadAllStaffOnce();
    const arr = allStaffBase;

    // åˆ†çµ„
    const map = new Map();
    for(const v of arr){
      const dept = (v.dept||"æœªåˆ†éƒ¨é–€").trim();
      if(!map.has(dept)) map.set(dept, []);
      map.get(dept).push(v);
    }

    if(map.size===0){
      wrap.innerHTML = `<div class="muted">å°šæœªæ–°å¢äººå“¡</div>`;
      return;
    }

    // ä¾ DEPT_ORDER è¼¸å‡ºï¼Œæœªå®šç¾©çš„æ’æœ€å¾Œ
    const orderedDepts = [
      ...DEPT_ORDER.filter(d => map.has(d)),
      ...Array.from(map.keys()).filter(d => !DEPT_INDEX.has(d))
    ];

    wrap.innerHTML = orderedDepts.map(dept=>{
      const list = map.get(dept) || [];
      return `
        <details style="border:1px solid rgba(15,23,42,.10); border-radius:16px; padding:10px 12px; margin-bottom:10px; background:#fff">
          <summary>${esc(dept)} <span class="tag" style="margin-left:8px">${list.length}äºº</span></summary>
          <div style="margin-top:10px">
            ${list.map(p=>`
              <div class="inline" style="justify-content:space-between; padding:8px 10px; border:1px solid rgba(15,23,42,.08); border-radius:14px; margin-top:8px;">
                <div><b>${esc(p.name||"")}</b></div>
                <button class="btnSmall btnDanger" data-delstaff="${p.id}" type="button">åˆªé™¤</button>
              </div>
            `).join("")}
          </div>
        </details>
      `;
    }).join("");

    // åˆªé™¤äººå“¡
    wrap.querySelectorAll("[data-delstaff]").forEach(b=>{
      b.onclick = async ()=>{
        if(!confirm("ç¢ºå®šåˆªé™¤è©²äººå“¡ï¼Ÿ")) return;
        try{
          await deleteDoc(doc(db,"staff", b.dataset.delstaff));
          // è®“å¿«å–å¤±æ•ˆï¼Œä¸‹æ¬¡é‡æŠ“
          allStaffLoaded = false;
          await refreshStaffList();
        }catch(err){
          console.error(err);
          alert("åˆªé™¤äººå“¡å¤±æ•—\n\n" + (err?.message || err));
        }
      };
    });

  }catch(err){
    console.error(err);
    wrap.innerHTML = `<div class="muted">è¼‰å…¥å¤±æ•—ï¼ˆçœ‹ consoleï¼‰</div>`;
  }
}

    $("btnAddStaff").onclick = async ()=>{
      const dept = $("s_dept").value.trim();
      const name = $("s_name").value.trim();
      if(!dept) return alert("è«‹è¼¸å…¥éƒ¨é–€");
      if(!name) return alert("è«‹è¼¸å…¥äººå“¡åç¨±");
      try{
        await addDoc(colStaff, { dept, name, createdAt: Date.now() });
        $("s_name").value="";
        statusPill.textContent = "å·²æ–°å¢äººå“¡ âœ…";
        allStaffLoaded = false;          // ğŸ‘ˆ è®“å¿«å–ä¸‹æ¬¡é‡æŠ“
        await refreshStaffList();
      }catch(err){
        console.error(err);
        alert("æ–°å¢äººå“¡å¤±æ•—\n\n" + (err?.message || err));
      }
    };
    $("btnClearStaff").onclick = ()=>{
      $("s_dept").value="";
      $("s_name").value="";
      statusPill.textContent = "å·²æ¸…ç©ºè¼¸å…¥";
    };
    $("s_name").addEventListener("keydown", (e)=>{
      if(e.key==="Enter"){
        e.preventDefault();
        $("btnAddStaff").click();
      }
    });

    /* ===============================
       âœ… ç­è¡¨ç®¡ç†ï¼šæ¯æœˆä¸Šç­äººå“¡å‹¾é¸ï¼ˆä¾éƒ¨é–€åˆ†æ®µï¼Œæ—¥æœŸå¯æ”¶åˆï¼‰
       =============================== */

    async function loadScheduleDocsForMonth(ym){
      try{
        const qSch = query(colSchedules, where("month","==", ym), limit(1000));
        const snap = await getDocs(qSch);
        const map = new Map();
        snap.forEach(d=>{
          const data = d.data()||{};
          const date = data.date || d.id;
          const arr = Array.isArray(data.workerKeys) ? data.workerKeys : [];
          map.set(date, arr);
        });
        return map;
      }catch(err){
        console.error(err);
        return new Map();
      }
    }

    async function saveScheduleForDate(dateStr){
      try{
        const wrap = $("scheduleWrap");
        if(!wrap) return;
        const checks = wrap.querySelectorAll(`input[data-sch-date="${dateStr}"]`);
        const workerKeys = [];
        checks.forEach(ch=>{
          if(ch.checked) workerKeys.push(ch.dataset.schKey);
        });
        const ref = doc(db,"schedules", dateStr);
        await setDoc(ref, {
          date: dateStr,
          month: dateStr.slice(0,7),
          workerKeys,
          updatedAt: Date.now()
        }, { merge:true });
        statusPill.textContent = "ç­è¡¨å·²å„²å­˜ âœ…";
      }catch(err){
        console.error(err);
        alert("å„²å­˜ç­è¡¨å¤±æ•—\n\n" + (err?.message || err));
        statusPill.textContent = "ç­è¡¨å„²å­˜å¤±æ•—ï¼ˆçœ‹ consoleï¼‰";
      }
    }

    async function renderScheduleMonth(){
      const wrap = $("scheduleWrap");
      if(!wrap) return;
      const ym = $("sch_month")?.value;
      if(!ym){
        wrap.innerHTML = `<div class="muted">è«‹å…ˆé¸æ“‡æœˆä»½</div>`;
        return;
      }

      wrap.innerHTML = `<div class="muted">è¼‰å…¥ä¸­â€¦</div>`;

      try{
        await loadAllStaffOnce();
        if(allStaffBase.length===0){
          wrap.innerHTML = `<div class="muted">å°šæœªæ–°å¢ä»»ä½•äººå“¡ï¼Œç„¡æ³•å»ºç«‹ç­è¡¨ã€‚</div>`;
          return;
        }

        const schMap = await loadScheduleDocsForMonth(ym);
        const [yy,mm] = ym.split("-").map(Number);
        const days = new Date(yy, mm, 0).getDate();

        // äººå“¡ä¾éƒ¨é–€åˆ†çµ„
        const deptMap = new Map();
        for(const s of allStaffBase){
          const dept = (s.dept||"æœªåˆ†éƒ¨é–€").trim() || "æœªåˆ†éƒ¨é–€";
          if(!deptMap.has(dept)) deptMap.set(dept, []);
          deptMap.get(dept).push(s);
        }
        const orderedDepts = [
          ...DEPT_ORDER.filter(d=>deptMap.has(d)),
          ...Array.from(deptMap.keys()).filter(d=>!DEPT_INDEX.has(d))
        ];

        const blocks = [];
        for(let d=1; d<=days; d++){
          const dd = pad2(d);
          const dateStr = `${ym}-${dd}`;
          const weekday = WEEKDAY_LABEL[new Date(yy, mm-1, d).getDay()];
          const workerKeys = schMap.get(dateStr) || [];
          const workerSet = new Set(workerKeys);

          const deptHtml = orderedDepts.map(dept=>{
            const list = deptMap.get(dept) || [];
            const people = list.map(p=>{
              const key = `${(p.dept||"").trim()}||${(p.name||"").trim()}`;
              const checked = workerSet.has(key) ? "checked" : "";
              return `
                <label class="schStaff">
                  <input type="checkbox" data-sch-date="${dateStr}" data-sch-key="${esc(key)}" ${checked}/>
                  <span>${esc(p.name||"")}</span>
                </label>
              `;
            }).join("") || `<div class="muted mini">ï¼ˆæœ¬éƒ¨é–€å°šç„¡äººå“¡ï¼‰</div>`;

            return `
              <div class="schDeptBlock">
                <div class="schDeptTitle">${esc(dept)}</div>
                <div class="schStaffGrid">${people}</div>
              </div>
            `;
          }).join("");

          blocks.push(`


            <div class="schDayBlock">
              <details>
                <summary class="schDaySummary">
                  <span>${mm}/${d}ï¼ˆ${weekday}ï¼‰</span>
                  <span class="tag miniTag">å·²å‹¾é¸ ${workerSet.size} äºº</span>
                </summary>
                <div class="schDayInner" data-sch-day="${dateStr}">
                  ${deptHtml}
                </div>
              </details>
            </div>
          `);
        }

        wrap.innerHTML = blocks.join("");

        // é è¨­å…¨éƒ¨æ”¶åˆï¼ˆdetails ä¸åŠ  open å±¬æ€§å³å¯ï¼‰
        wrap.querySelectorAll("input[data-sch-date]").forEach(ch=>{
          ch.addEventListener("change", ()=>{
            const dateStr = ch.dataset.schDate;
            saveScheduleForDate(dateStr);
          });
        });

      }catch(err){
        console.error(err);
        wrap.innerHTML = `<div class="muted">ç­è¡¨è¼‰å…¥å¤±æ•—<br/>${esc(err?.message || err)}</div>`;
      }
    }

    $("btnLoadSchedule")?.addEventListener("click", ()=>{
      renderScheduleMonth();
    });

    $("btnScheduleToday")?.addEventListener("click", ()=>{
      const today = todayISO();
      const ym = today.slice(0,7);
      const inp = $("sch_month");
      if(inp) inp.value = ym;
      renderScheduleMonth().then(()=>{
        const inner = document.querySelector(`[data-sch-day="${today}"]`);
        if(inner){
          const det = inner.closest("details");
          if(det){
            det.open = true;
            det.scrollIntoView({ behavior:"smooth", block:"start" });
          }
        }
      });
    });

    /* ===============================
       âœ… é¤å»³ç®¡ç†ï¼šæœå°‹ Enter æ‰å±•é–‹å®šä½ï¼ˆåˆ†é¡æ”¶åˆä¹Ÿæ‰¾å¾—åˆ°ï¼‰
       =============================== */
    function openRestaurantByKeyword(keyword){
      const kw = (keyword||"").trim().toLowerCase();
      if(!kw) return false;

      const wrap = $("restaurantsWrap");
      if(!wrap) return false;

      const allDetails = Array.from(wrap.querySelectorAll(`details`)).filter(d=>{
        const s = d.querySelector("summary");
        return s && (s.textContent||"").trim();
      });

      const hit = allDetails.find(d=>{
        const t = (d.querySelector("summary")?.textContent || "").toLowerCase();
        return t.includes(kw);
      });

      if(!hit) return false;

      hit.open = true;
      let p = hit.parentElement;
      while(p){
        if(p.tagName === "DETAILS") p.open = true;
        p = p.parentElement;
      }

      hit.scrollIntoView({ behavior:"smooth", block:"start" });
      return true;
    }

    $("restSearchOpen")?.addEventListener("keydown", (e)=>{
      if(e.key==="Enter"){
        e.preventDefault();
        const v = $("restSearchOpen").value;
        const ok = openRestaurantByKeyword(v);
        if(!ok) alert("æ‰¾ä¸åˆ°ç¬¦åˆçš„é¤å»³ï¼ˆå¯èƒ½å°šæœªè¼‰å…¥æˆ–é—œéµå­—ä¸ç¬¦ï¼‰");
      }
    });

    $("btnRestSearchClear")?.addEventListener("click", ()=>{
      const inp = $("restSearchOpen");
      if(inp) inp.value = "";
    });

   // è®€å–æŸé¤å»³çš„æ‰€æœ‰é¤é»
async function loadMenusOfRestaurant(rid){
  try{
    const menuCol = collection(db, "restaurants", rid, "menu");
    const snap = await getDocs(query(menuCol, limit(2500)));

    const list = [];
    snap.forEach(d => {
      list.push({
        id: d.id,
        ...(d.data() || {})
      });
    });

    // æ’åºï¼šorder â†’ createdAt â†’ category â†’ name
    list.sort((a,b)=>{
      const ao = Number(a.order || 0);
      const bo = Number(b.order || 0);
      if (ao !== bo) return ao - bo;

      const aa = Number(a.createdAt || 0);
      const bb = Number(b.createdAt || 0);
      if (aa !== bb) return aa - bb;

      const ca = (a.category || "").localeCompare((b.category || ""),"zh-Hant");
      if (ca !== 0) return ca;

      return (a.name || "").localeCompare((b.name || ""),"zh-Hant");
    });

    return list;
  }catch(err){
    console.error(err);
    return null;
  }
}

    function optionGroupsSummary(groups){
      const gs = Array.isArray(groups) ? groups : [];
      if(gs.length===0) return "â€”";
      return gs.map(g=>{
        const t = g.type==="single" ? "æ“‡ä¸€" : "åŠ è³¼";
        const req = (g.type==="single" && g.required) ? "å¿…é¸" : "";
        const c = (g.choices||[]).map(x=> `${x.name}${Number(x.price||0)?`(+${Number(x.price||0)})`:``}`).join("ã€");
        return `${g.name}(${t}${req?`/${req}`:""}): ${c}`;
      }).join("ï½œ");
    }
// âœ… é¤å»³ç®¡ç†ï¼šæ¯é“é¤é» inline ç·¨è¼¯ optionGroups ç”¨
function renderMenuOptionEditor(rid, mid, container){
  if(!container) return;

  const key = `${rid}__${mid}`;
  let groups = menuOptionCache.get(key) || [];
  // æ­£è¦åŒ–ä¸€ä¸‹ï¼Œé¿å…èˆŠè³‡æ–™ç¼ºæ¬„ä½
  groups = cloneOptionGroups(groups);
  menuOptionCache.set(key, groups);

  let html = `
    <div class="muted mini" style="margin-bottom:6px">
      åœ¨æ­¤å¯ç›´æ¥è¨­å®šã€Œæ“‡ä¸€ / åŠ è³¼ã€é¸é …ç¾¤çµ„ï¼ˆä¸æœƒè·³è¦–çª—ï¼‰ã€‚<br/>
      âœ ç·¨è¼¯å®Œæˆå¾Œè¨˜å¾—æŒ‰ä¸Šæ–¹ã€Œå„²å­˜ã€è©²é¤é»ï¼Œæ‰æœƒå¯«å› Firestoreã€‚
    </div>
    <div class="actions" style="margin:4px 0 10px; justify-content:flex-start;">
      <button class="btnSmall btnOk" type="button" data-role="add-group">æ–°å¢ç¾¤çµ„</button>
    </div>
  `;

  if(groups.length===0){
    html += `<div class="muted mini">ç›®å‰æ²’æœ‰ä»»ä½•é¸é …ç¾¤çµ„ã€‚</div>`;
  }else{
    html += groups.map((g,gi)=>{
      const choices = Array.isArray(g.choices) ? g.choices : [];
      const rows = choices.length
        ? choices.map((c,ci)=>`
            <tr data-ci="${ci}">
              <td><input data-role="c-name" value="${esc(c.name||"")}"></td>
              <td><input data-role="c-price" type="number" min="0" value="${Number(c.price||0)}"></td>
              <td style="width:1%; white-space:nowrap;">
                <button class="btnSmall btnDanger" type="button" data-role="del-choice">åˆªé™¤</button>
              </td>
            </tr>
          `).join("")
        : `<tr><td colspan="3" class="muted mini">å°šæœªåŠ å…¥ä»»ä½•é¸é …</td></tr>`;

      return `
        <div class="optBox" data-gi="${gi}" style="margin-bottom:10px;">
          <div class="row3">
            <div>
              <label>ç¾¤çµ„åç¨±
                <input data-role="g-name" value="${esc(g.name||"")}">
              </label>
            </div>
            <div>
              <label>é¡å‹
                <select data-role="g-type">
                  <option value="single" ${g.type==="addon"?"":"selected"}>æ“‡ä¸€ï¼ˆä¸‹æ‹‰ï¼‰</option>
                  <option value="addon" ${g.type==="addon"?"selected":""}>åŠ è³¼ï¼ˆå¤šé¸ï¼‰</option>
                </select>
              </label>
            </div>
            <div style="display:flex; align-items:flex-end; gap:10px;">
              <label style="margin:0; display:flex; align-items:center; gap:6px;">
                <input type="checkbox" data-role="g-required"
                  style="width:18px; height:18px;" ${(g.type==="single" && g.required) ? "checked":""}>
                å¿…é¸ï¼ˆæ“‡ä¸€ç”¨ï¼‰
              </label>
              <button class="btnSmall btnDanger" type="button" data-role="del-group">åˆªé™¤æ­¤ç¾¤çµ„</button>
            </div>
          </div>

          <div class="hr"></div>

          <table style="width:100%; border-collapse:collapse; font-size:12.5px;">
            <thead>
              <tr>
                <th>é¸é …åç¨±</th>
                <th>åŠ åƒ¹</th>
                <th style="width:1%;">æ“ä½œ</th>
              </tr>
            </thead>
            <tbody>
              ${rows}
              <tr>
                <td><input data-role="new-c-name" placeholder="ä¾‹ï¼šè±¬è‚‰ / åŠ éºµ"></td>
                <td><input data-role="new-c-price" type="number" min="0" placeholder="0"></td>
                <td>
                  <button class="btnSmall btnOk" type="button" data-role="add-choice">æ–°å¢é¸é …</button>
                </td>
              </tr>
            </tbody>
          </table>
        </div>
      `;
    }).join("");
  }

  container.innerHTML = html;

  // â• æ–°å¢ç¾¤çµ„
  const addGroupBtn = container.querySelector('[data-role="add-group"]');
  if(addGroupBtn){
    addGroupBtn.onclick = ()=>{
      groups.push({ name:"", type:"single", required:true, choices:[] });
      menuOptionCache.set(key, groups);
      renderMenuOptionEditor(rid, mid, container);
    };
  }

  // ç¶å®šæ¯å€‹ç¾¤çµ„å…§çš„äº‹ä»¶
  container.querySelectorAll(".optBox").forEach(box=>{
    const gi = Number(box.dataset.gi);
    const g = groups[gi];
    if(!g) return;

    const nameInp = box.querySelector('[data-role="g-name"]');
    if(nameInp){
      nameInp.addEventListener("input", e=>{
        g.name = e.target.value;
        menuOptionCache.set(key, groups);
      });
    }

    const typeSel = box.querySelector('[data-role="g-type"]');
    if(typeSel){
      typeSel.addEventListener("change", e=>{
        const v = e.target.value === "addon" ? "addon" : "single";
        g.type = v;
        if(v !== "single") g.required = false;
        menuOptionCache.set(key, groups);
        renderMenuOptionEditor(rid, mid, container);
      });
    }

    const reqChk = box.querySelector('[data-role="g-required"]');
    if(reqChk){
      reqChk.addEventListener("change", e=>{
        g.required = !!e.target.checked;
        menuOptionCache.set(key, groups);
      });
    }

    const delGroupBtn = box.querySelector('[data-role="del-group"]');
    if(delGroupBtn){
      delGroupBtn.onclick = ()=>{
        groups.splice(gi,1);
        menuOptionCache.set(key, groups);
        renderMenuOptionEditor(rid, mid, container);
      };
    }

    // æ—¢æœ‰é¸é …
    box.querySelectorAll("tr[data-ci]").forEach(row=>{
      const ci = Number(row.dataset.ci);
      const c = g.choices[ci];
      if(!c) return;

      const nInp = row.querySelector('[data-role="c-name"]');
      const pInp = row.querySelector('[data-role="c-price"]');
      const delBtn = row.querySelector('[data-role="del-choice"]');

      if(nInp){
        nInp.addEventListener("input", e=>{
          c.name = e.target.value;
          menuOptionCache.set(key, groups);
        });
      }
      if(pInp){
        pInp.addEventListener("input", e=>{
          let v = Number(e.target.value || 0);
          if(isNaN(v) || v < 0) v = 0;
          c.price = v;
          menuOptionCache.set(key, groups);
        });
      }
      if(delBtn){
        delBtn.addEventListener("click", ()=>{
          g.choices.splice(ci,1);
          menuOptionCache.set(key, groups);
          renderMenuOptionEditor(rid, mid, container);
        });
      }
    });

    // æ–°å¢é¸é …
    const newName = box.querySelector('[data-role="new-c-name"]');
    const newPrice = box.querySelector('[data-role="new-c-price"]');
    const addChoiceBtn = box.querySelector('[data-role="add-choice"]');

    if(addChoiceBtn){
      const submitNew = ()=>{
        const name = (newName?.value || "").trim();
        const price = Number(newPrice?.value || 0);
        if(!name) return alert("è«‹è¼¸å…¥é¸é …åç¨±");
        if(isNaN(price) || price < 0) return alert("åŠ åƒ¹éœ€ç‚º 0 æˆ–æ­£æ•¸");
        if(!Array.isArray(g.choices)) g.choices = [];
        g.choices.push({ name, price });
        menuOptionCache.set(key, groups);
        renderMenuOptionEditor(rid, mid, container);
      };
      addChoiceBtn.addEventListener("click", submitNew);
      newName?.addEventListener("keydown", e=>{ if(e.key==="Enter"){ e.preventDefault(); submitNew(); }});
      newPrice?.addEventListener("keydown", e=>{ if(e.key==="Enter"){ e.preventDefault(); submitNew(); }});
    }
  });
}

    function buildCatDatalistForRestaurant(rid, menus){
      const set = new Set();
      (menus||[]).forEach(m=>{
        const c = (m.category||"").trim();
        if(c) set.add(c);
      });
      const dlId = `catList_${rid}`;
      const html = `<datalist id="${dlId}">${
        Array.from(set).sort((a,b)=>a.localeCompare(b,"zh-Hant")).map(c=>`<option value="${esc(c)}"></option>`).join("")
      }</datalist>`;
      return { dlId, html };
    }

    async function refreshRestaurantsManage(){
  const wrap = $("restaurantsWrap");

  // âœ… è¨˜éŒ„ç›®å‰æœ‰å±•é–‹çš„é¤å»³ï¼ˆä»¥ data-saver çš„ rid ç‚ºä¸»ï¼‰
  const openRids = new Set();
  wrap.querySelectorAll("details").forEach(d=>{
    if(!d.open) return;
    const btn = d.querySelector("button[data-saver]");
    const rid = btn?.dataset?.saver;
    if(rid) openRids.add(rid);
  });

  wrap.innerHTML = `<div class="muted">è¼‰å…¥ä¸­â€¦</div>`;

      let restaurants = [];
      try{
        const snap = await getDocs(query(colRestaurants, limit(1200)));
        snap.forEach(d => restaurants.push({ id: d.id, ...(d.data() || {}) }));

        restaurants.sort((a,b)=>{
          const aa = toMs(a.createdAt||0), bb = toMs(b.createdAt||0);
          if(bb !== aa) return bb - aa;
          return (a.name||"").localeCompare((b.name||""),"zh-Hant");
        });

      }catch(err){
        console.error(err);
        wrap.innerHTML = `<div class="muted">ç„¡æ³•è®€å–é¤å»³<br/>${esc(err?.message || err)}</div>`;
        return;
      }

      /* ğŸ”µ æ›´æ–°ä¸Šæ–¹å…©å¼µçµ±è¨ˆå¡ç‰‡ï¼šé¡¯ç¤ºä¸­çš„ / é–‹å–®ä¸­çš„ */
      const showCountEl = $("restShowCount");
      const showListEl  = $("restShowList");
      const openCountEl = $("restOpenCount");
      const openListEl  = $("restOpenList");

      if (showCountEl && showListEl && openCountEl && openListEl) {
        if (restaurants.length === 0) {
          showCountEl.textContent = "0 å®¶";
          openCountEl.textContent = "0 å®¶";
          showListEl.innerHTML = `<div class="muted mini">ç›®å‰å°šæœªæ–°å¢é¤å»³</div>`;
          openListEl.innerHTML = `<div class="muted mini">ç›®å‰å°šæœªæ–°å¢é¤å»³</div>`;
        } else {
          const visibleList = restaurants.filter(r => (r.isVisible !== false));
          const openListArr = restaurants.filter(r => !r.isClosed);

          const sortByCatName = (arr)=>{
            return [...arr].sort((a,b)=>{
              const ca = (a.category || "").trim();
              const cb = (b.category || "").trim();
              const c = ca.localeCompare(cb, "zh-Hant");
              if (c !== 0) return c;
              return (a.name||"").localeCompare((b.name||""), "zh-Hant");
            });
          };

          showCountEl.textContent = `${visibleList.length} å®¶`;
          openCountEl.textContent = `${openListArr.length} å®¶`;

          const buildTag = (arr)=> arr.length
            ? sortByCatName(arr).map(r => `
              <span class="tag mini" style="cursor:pointer" data-goto-rid="${r.id}">
                ${esc(r.name || "æœªå‘½å")}
                <span class="muted mini">ï½œ${esc((r.category||"").trim() || "æœªåˆ†é¡")}</span>
              </span>
            `).join("")
            : `<div class="muted mini">ç›®å‰æ²’æœ‰ç¬¦åˆæ¢ä»¶çš„é¤å»³</div>`;

          showListEl.innerHTML = buildTag(visibleList);
          openListEl.innerHTML = buildTag(openListArr);

          // é»æ“Šæ²åˆ°è©²é¤å»³
          [showListEl, openListEl].forEach(listEl=>{
            listEl.querySelectorAll("[data-goto-rid]").forEach(el => {
              el.onclick = () => {
                const rid = el.dataset.gotoRid;
                const wrap = $("restaurantsWrap");
                if (!wrap) return;

                const btn = wrap.querySelector(`button[data-saver="${rid}"]`);
                const detail = btn?.closest("details");
                if (detail) {
                  detail.open = true;
                  let p = detail.parentElement;
                  while (p) {
                    if (p.tagName === "DETAILS") p.open = true;
                    p = p.parentElement;
                  }
                  detail.scrollIntoView({ behavior:"smooth", block:"start" });
                }
              };
            });
          });
        }
      }
      /* ğŸ”µ ç¸½è¦½å¡ç‰‡æ›´æ–°çµæŸ */

      if(restaurants.length===0){
        wrap.innerHTML = `<div class="muted">å°šæœªæ–°å¢é¤å»³</div>`;
        return;
      }

      // âœ… ä¾é¤å»³çš„ category æ¬„ä½åˆ†çµ„
      const map = new Map();
      for(const r of restaurants){
        const cat = (r.category||"").trim() || "æœªåˆ†é¡";
        if(!map.has(cat)) map.set(cat, []);
        map.get(cat).push(r);
      }

      const categoryKeys = Array.from(map.keys()).sort((a,b)=>{
        if(a==="æœªåˆ†é¡" && b!=="æœªåˆ†é¡") return 1;
        if(b==="æœªåˆ†é¡" && a!=="æœªåˆ†é¡") return -1;
        return a.localeCompare(b,"zh-Hant");
      });

      const blocks = [];

      for(const cat of categoryKeys){
        const list = map.get(cat) || [];
        const inner = [];

        for(const r of list){
          const menus = await loadMenusOfRestaurant(r.id);

          const isVisible = (r.isVisible !== false);
          const isClosed = !!r.isClosed;

          const visibleTag = isVisible
            ? `<span class="tag stateGood" style="margin-left:10px">ä½¿ç”¨è€…é¡¯ç¤º</span>`
            : `<span class="tag stateBad" style="margin-left:10px">ä½¿ç”¨è€…éš±è—</span>`;

          const closedTag = isClosed
            ? `<span class="tag stateBad" style="margin-left:6px">å·²çµå–®</span>`
            : `<span class="tag stateGood" style="margin-left:6px">é–‹å–®ä¸­</span>`;

          // âœ… weeklyOff + ç‡Ÿæ¥­æ™‚é–“ï¼šsummary ç›´æ¥é¡¯ç¤º
          const weeklyOffArr = Array.isArray(r.weeklyOff) ? r.weeklyOff : [];
          const weeklyOffLabel = weeklyOffArr.length ? weeklyOffArr.join("ãƒ»") : "";
          const weeklyOffTag = weeklyOffLabel
            ? `<span class="tag stateBad" style="margin-left:6px">${esc(weeklyOffLabel)}</span>`
            : "";

          const hoursText = (r.businessHours || "").trim();
          const hoursTag = hoursText
            ? `<span class="tag" style="margin-left:6px">â° ${esc(hoursText)}</span>`
            : "";

          const menuRows = (menus === null)
            ? `<div class="muted" style="margin-top:8px">ï¼ˆç„¡æ³•è®€å–é¤é»ï¼šè«‹ç¢ºèª Rules/ç¶²è·¯ï¼‰</div>`
            : (menus.length===0)
              ? `<div class="muted" style="margin-top:8px">ï¼ˆæ­¤é¤å»³å°šç„¡é¤é»ï¼‰</div>`
              : (()=>{
                  const byCat = new Map();
                  for(const m of menus){
                    const mc = (m.category||"æœªåˆ†é¡").trim() || "æœªåˆ†é¡";
                    if(!byCat.has(mc)) byCat.set(mc, []);
                    byCat.get(mc).push(m);
                  }

                  return Array.from(byCat.entries()).map(([mc, mlist])=>{
                    const table = `
                      <table style="margin-top:10px">
                        <thead>
                          <tr>
                            <th>é¤é»é¡åˆ¥</th><th>é¤é»åç¨±</th><th>åƒ¹æ ¼</th><th>é è¨­æ•¸é‡</th><th>é¸é …ç¾¤çµ„</th><th>æ“ä½œ</th>
                          </tr>
                        </thead>
                        <tbody>
                          ${mlist.map(m=>{
  const optText = optionGroupsSummary(m.optionGroups);
  const optKey = `${r.id}__${m.id}`;
  if(!menuOptionCache.has(optKey)){
    menuOptionCache.set(optKey, cloneOptionGroups(m.optionGroups));
  }

  return `
    <tr>
      <td><input data-rid="${r.id}" data-mid="${m.id}" data-k="category" value="${esc(m.category||"")}"></td>
      <td><input data-rid="${r.id}" data-mid="${m.id}" data-k="name" value="${esc(m.name||"")}"></td>
      <td><input data-rid="${r.id}" data-mid="${m.id}" data-k="price" type="number" min="0" value="${Number(m.price||0)}"></td>
      <td><input data-rid="${r.id}" data-mid="${m.id}" data-k="defaultQty" type="number" min="1" value="${Number(m.defaultQty||1)}"></td>
      <td class="muted" style="max-width:340px">${esc(optText)}</td>
      <td style="white-space:nowrap">
        <button class="btnSmall" type="button" data-editopt="1" data-rid="${r.id}" data-mid="${m.id}">é¸é …ç¾¤çµ„</button>
        <button class="btnSmall btnOk" type="button" data-savem2="1" data-rid="${r.id}" data-mid="${m.id}">å„²å­˜</button>
        <button class="btnSmall btnDanger" type="button" data-delm2="1" data-rid="${r.id}" data-mid="${m.id}">åˆªé™¤</button>
      </td>
    </tr>
   <tr class="menuOptEditorRow" data-opt-row="${r.id}__${m.id}" style="display:none;">
  <td colspan="6">
    <div class="muted mini" style="margin-bottom:6px">
      å¯åœ¨é€™è£¡ç·¨è¼¯ã€Œæ“‡ä¸€ / åŠ è³¼ã€é¸é …ç¾¤çµ„ï¼Œç·¨è¼¯å®Œæˆå¾Œè«‹æŒ‰ä¸Šæ–¹ã€Œå„²å­˜ã€ã€‚
    </div>
    <!-- âœ… çœŸæ­£æ¸²æŸ“é¸é …ç¾¤çµ„ç·¨è¼¯ UI çš„å®¹å™¨ -->
    <div class="optEditorBox" data-opt-editor="${r.id}__${m.id}"></div>
  </td>
</tr>

  `;
}).join("")}
                        </tbody>
                      </table>
                    `;

                    return `
                      <details style="border:1px solid rgba(15,23,42,.10); border-radius:16px; padding:10px 12px; background:rgba(15,23,42,.02); margin-top:10px;">
                        <summary>${esc(mc)} <span class="tag" style="margin-left:8px">${mlist.length} é“</span></summary>
                        ${table}
                      </details>
                    `;
                  }).join("");
                })();

          const catDl = buildCatDatalistForRestaurant(r.id, menus===null?[]:menus);

          const weekOptions = [
            "é€±ä¸€å…¬ä¼‘","é€±äºŒå…¬ä¼‘","é€±ä¸‰å…¬ä¼‘","é€±å››å…¬ä¼‘",
            "é€±äº”å…¬ä¼‘","é€±å…­å…¬ä¼‘","é€±æ—¥å…¬ä¼‘"
          ];
          const weeklyOffChecks = weekOptions.map(label=>{
            const checked = weeklyOffArr.includes(label) ? "checked" : "";
            return `
              <label class="chkline mini">
                <input type="checkbox" data-r="${r.id}" data-weekly="${esc(label)}" ${checked}/>
                <span>${esc(label)}</span>
              </label>
            `;
          }).join("");

                    const addForm = `
            <div class="hr"></div>
            <h3 style="margin:0">â• ç›´æ¥æ–°å¢é¤é»åˆ°ã€Œ${esc(r.name||"æœªå‘½å")}ã€</h3>

            ${catDl.html}

            <div class="row" style="margin-top:10px">
              <div>
                <label>é¤é»é¡åˆ¥ï¼ˆè¼¸å…¥ + ä¸‹æ‹‰å»ºè­°ï¼‰</label>
                <input list="${catDl.dlId}" data-add-rid="${r.id}" data-add-k="category" placeholder="ä¾‹ï¼šé£¯é¡ / éºµé¡ / å°èœ / é£²æ–™">
              </div>
              <div>
                <label>é¤é»åç¨±</label>
                <input data-add-rid="${r.id}" data-add-k="name" placeholder="ä¾‹ï¼šæ³•å¼ç‚’éºµ">
              </div>
            </div>

            <div class="row">
              <div>
                <label>åƒ¹æ ¼ï¼ˆå–®ä»½ï¼‰</label>
                <input data-add-rid="${r.id}" data-add-k="price" type="number" min="0" placeholder="120">
              </div>
              <div>
                <label>é è¨­æ•¸é‡</label>
                <input data-add-rid="${r.id}" data-add-k="defaultQty" type="number" min="1" value="1">
              </div>
            </div>

            <div class="actions">
              <button class="btnSmall btnOk" type="button" data-addmenu="${r.id}">æ–°å¢é¤é»</button>
              <button class="btnSmall" type="button" data-clearadd="${r.id}">æ¸…ç©ºæ¬„ä½</button>
            </div>
          `;

          // ğŸ”½ğŸ”½ğŸ”½ é€™æ•´æ®µ inner.push æ”¹æˆæ–°çš„ ğŸ”½ğŸ”½ğŸ”½
          inner.push(`
            <details style="border:1px solid rgba(15,23,42,.14); border-radius:16px; padding:12px; background:#ffffff; margin-top:12px;">
              <summary class="inline" style="cursor:pointer; justify-content:space-between; align-items:center; gap:8px;">
                <div>
                  <span style="font-size:15px; font-weight:700;">${esc(r.name||"æœªå‘½å")}</span>
                  ${visibleTag}
                  ${closedTag}
                  ${weeklyOffTag}
                  ${hoursTag}
                </div>
                <div class="muted mini">
                  åˆ†é¡ï¼š${esc((r.category||"").trim() || "æœªåˆ†é¡")}
                </div>
              </summary>

              <!-- ğŸŸ¦ é¤å»³è³‡è¨Šï¼ˆè—åº•ï¼Œå¯æ”¶åˆï¼‰ -->
              <details style="margin-top:10px; border-radius:12px; padding:10px; background:#f0f9ff; border-left:4px solid #38bdf8;">
                <summary style="cursor:pointer; font-size:14px; font-weight:700;">
                  é¤å»³è³‡è¨Š
                </summary>
                <div style="margin-top:8px">

                                   <div class="kpi">
                    ${r.phone ? `<span class="tag">â˜ ${esc(r.phone)}</span>` : ``}
                    ${r.address ? `<span class="tag">ğŸ“ ${esc(r.address)}</span>` : ``}
                    ${r.mapUrl ? `<span class="tag"><a target="_blank" href="${esc(r.mapUrl)}" style="color:inherit; text-decoration:none">Google Map</a></span>` : ``}
                    ${r.lineQrUrl ? `<span class="tag"><a target="_blank" href="${esc(r.lineQrUrl)}" style="color:inherit; text-decoration:none">Line QR</a></span>` : ``}
                  </div>

                  <!-- âœ… ä½¿ç”¨è€…é¡¯ç¤º / çµå–® å‹¾é¸ -->
                  <div class="row" style="margin:10px 0; gap:16px;">
                    <label style="margin:0; display:flex; align-items:center; gap:6px;">
                      <input
                        type="checkbox"
                        data-r="${r.id}"
                        data-k="isVisible"
                        style="width:18px; height:18px;"
                        ${r.isVisible === false ? "" : "checked"}
                      />
                      <span>ä½¿ç”¨è€…é¡¯ç¤º</span>
                    </label>

                    <label style="margin:0; display:flex; align-items:center; gap:6px;">
                      <input
                        type="checkbox"
                        data-r="${r.id}"
                        data-k="isClosed"
                        style="width:18px; height:18px;"
                        ${r.isClosed ? "checked" : ""}
                      />
                      <span>çµå–®ï¼ˆä½¿ç”¨è€…ä¸å¯é€å–®ï¼‰</span>
                    </label>
                  </div>

                  <label>é¤å»³é¡åˆ¥åˆ†é¡</label>
                  <input data-r="${r.id}" data-k="category" value="${esc((r.category||"").trim())}" placeholder="ä¾‹ï¼šç‡’è‡˜ / ç²¥å“"/>

                  <div class="row" style="margin-top:10px">
                    <div>
                      <label>é›»è©±</label>
                      <input data-r="${r.id}" data-k="phone" value="${esc(r.phone||"")}"/>
                    </div>
                    <div>
                      <label>åœ°å€</label>
                      <input data-r="${r.id}" data-k="address" value="${esc(r.address||"")}"/>
                    </div>
                  </div>

                  <label>Google Map é€£çµ</label>
                  <input data-r="${r.id}" data-k="mapUrl" value="${esc(r.mapUrl||"")}"/>

                  <label>ç‡Ÿæ¥­æ™‚é–“</label>
                  <input data-r="${r.id}" data-k="businessHours"
                         value="${esc(r.businessHours || "")}"
                         placeholder="ä¾‹ï¼š11:00~14:30 / 16:30~19:30"/>

                  <label>å…¬ä¼‘æ—¥ï¼ˆå¯å¤šé¸ï¼‰</label>
                  <div class="chkline mini">
                    ${weeklyOffChecks}
                  </div>

                  <div class="row">
                    <div>
                      <label>Line QR Code åœ–ç‰‡ç¶²å€</label>
                      <div class="inline" style="gap:8px">
                        <input data-r="${r.id}" data-k="lineQrUrl" value="${esc(r.lineQrUrl||"")}"/>
                        <button class="btnSmall" type="button" data-openqr="${r.id}">é–‹å•Ÿ</button>
                      </div>
                    </div>
                    <div class="muted" style="display:flex; align-items:end">
                      ï¼ˆè²¼ QR code åœ–ç‰‡ç¶²å€å³å¯ï¼‰
                    </div>
                  </div>

                  ${r.imageUrl ? `<img src="${esc(r.imageUrl)}" class="previewImg" style="max-width:160px; border-radius:12px; margin-top:10px" alt="img" onerror="this.style.display='none'"/>`
                               : `<div class="muted" style="margin-top:10px">ï¼ˆå°šç„¡é¤å»³åœ–ç‰‡ç¶²å€ï¼‰</div>`}

                  ${r.lineQrUrl ? `<img src="${esc(r.lineQrUrl)}" class="previewImg" style="max-width:160px; border-radius:12px; margin-top:10px" alt="line-qr" onerror="this.style.display='none'"/>`
                                : `<div class="muted" style="margin-top:10px">ï¼ˆå°šç„¡ Line QR codeï¼‰</div>`}

                  <label>å‚™è¨»</label>
                  <textarea data-r="${r.id}" data-k="note">${esc(r.note||"")}</textarea>

                  <div class="actions">
                    <button class="btnSmall btnOk" type="button" data-saver="${r.id}">å„²å­˜é¤å»³è³‡æ–™</button>
                    <button class="btnSmall btnDanger" type="button" data-delr="${r.id}">åˆªé™¤é¤å»³</button>
                  </div>

                </div>
              </details>

              <!-- ğŸŸ© å·²è¨­å®šé¤é»ï¼ˆç¶ åº•ï¼Œå¯æ”¶åˆï¼‰ -->
              <details style="margin-top:10px; border-radius:12px; padding:10px; background:#ecfdf3; border-left:4px solid #22c55e;">
                <summary style="cursor:pointer; font-size:14px; font-weight:700;">
                  å·²è¨­å®šé¤é»ï¼ˆä¾é¡åˆ¥æ”¶åˆï¼‰
                </summary>
                <div style="margin-top:8px">
                  ${menuRows}
                </div>
              </details>

              <!-- ğŸŸ£ æ–°å¢é¤é»ï¼ˆç´«åº•ï¼Œå¯æ”¶åˆï¼‰ -->
              <details style="margin-top:10px; border-radius:12px; padding:10px; background:#faf5ff; border-left:4px solid #c084fc;">
                <summary style="cursor:pointer; font-size:14px; font-weight:700;">
                  æ–°å¢é¤é»
                </summary>
                <div style="margin-top:8px">
                  ${addForm}
                </div>
              </details>

            </details>
          `);
          // ğŸ”¼ğŸ”¼ğŸ”¼ inner.push åˆ°é€™è£¡çµæŸ ğŸ”¼ğŸ”¼ğŸ”¼
        }

        blocks.push(`
          <details style="border:1px solid rgba(15,23,42,.10); border-radius:16px; padding:12px; background:rgba(255,255,255,.9); margin-top:12px;">
            <summary>
              <span style="font-size:15px">${esc(cat)}</span>
              <span class="tag" style="margin-left:8px">${list.length} å®¶</span>
            </summary>
            ${inner.join("")}
          </details>
        `);
      }

      wrap.innerHTML = blocks.join("");

            // âœ… æŠŠå‰›å‰›å·²ç¶“å±•é–‹çš„é¤å»³å†æ‰“é–‹
      openRids.forEach(rid=>{
        const btn = wrap.querySelector(`button[data-saver="${rid}"]`);
        if(!btn) return;
        let d = btn.closest("details");
        while(d){
          if(d.tagName === "DETAILS") d.open = true;
          d = d.parentElement?.closest("details");
        }
      });

      // ===== ç¶å®šé¤å»³ç®¡ç†å…§å„ç¨®æŒ‰éˆ• =====
      wrap.querySelectorAll("button[data-openimg]").forEach(btn=>{
        btn.onclick = ()=>{
          const rid = btn.dataset.openimg;
          const input = wrap.querySelector(`[data-r="${rid}"][data-k="imageUrl"]`);
          const url = (input?.value || "").trim();
          if(!url) return alert("ç›®å‰æ²’æœ‰åœ–ç‰‡ç¶²å€");
          const finalUrl = url.startsWith("http://") || url.startsWith("https://") ? url : ("https://" + url);
          window.open(finalUrl, "_blank");
        };
      });

      wrap.querySelectorAll("button[data-openqr]").forEach(btn=>{
        btn.onclick = ()=>{
          const rid = btn.dataset.openqr;
          const input = wrap.querySelector(`[data-r="${rid}"][data-k="lineQrUrl"]`);
          const url = (input?.value || "").trim();
          if(!url) return alert("ç›®å‰æ²’æœ‰ Line QR é€£çµ");
          const finalUrl = url.startsWith("http://") || url.startsWith("https://") ? url : ("https://" + url);
          window.open(finalUrl, "_blank");
        };
      });

      wrap.querySelectorAll("button[data-saver]").forEach(b=>{
        b.onclick = async ()=>{
          const rid = b.dataset.saver;
          const inputs = wrap.querySelectorAll(`[data-r="${rid}"]`);
          const patch = {};
          inputs.forEach(i=>{
            const k = i.dataset.k;
            if(i.type === "checkbox") patch[k] = !!i.checked;
            else patch[k] = i.value.trim();
          });

          // å…¬ä¼‘æ—¥ï¼šcheckbox æ”¶é›†
          const weeklyChecked = [];
          wrap.querySelectorAll(`[data-r="${rid}"][data-weekly]`).forEach(ch=>{
            if(ch.checked) weeklyChecked.push(ch.dataset.weekly || "");
          });
          patch.weeklyOff = weeklyChecked;

          try{
            statusPill.textContent = "å„²å­˜ä¸­â€¦";
            await updateDoc(doc(db,"restaurants", rid), patch);
            statusPill.textContent = "å„²å­˜å®Œæˆ âœ…";
            await refreshRestaurantsManage();
          }catch(err){
            console.error(err);
            alert("å„²å­˜å¤±æ•—\n\n" + (err?.message || err));
            statusPill.textContent = "å„²å­˜å¤±æ•—ï¼ˆçœ‹ consoleï¼‰";
          }
        };
      });

      wrap.querySelectorAll("button[data-delr]").forEach(b=>{
        b.onclick = async ()=>{
          const rid = b.dataset.delr;
          if(!confirm("ç¢ºå®šåˆªé™¤é¤å»³ï¼Ÿï¼ˆæœƒé€£åŒè©²é¤å»³çš„é¤é»ä¸€èµ·åˆªé™¤ï¼‰")) return;

          try{
            statusPill.textContent = "åˆªé™¤é¤å»³ä¸­â€¦";

            const menuCol = collection(db, "restaurants", rid, "menu");
            const menuSnap = await getDocs(query(menuCol, limit(2500)));

            let batch = writeBatch(db);
            let count = 0;

            for (const d of menuSnap.docs){
              batch.delete(d.ref);
              count++;
              if(count % 450 === 0){
                await batch.commit();
                batch = writeBatch(db);
              }
            }

            if(count > 0){
              await batch.commit();
            }

            await deleteDoc(doc(db,"restaurants", rid));
            statusPill.textContent = "åˆªé™¤å®Œæˆ âœ…";
            await refreshRestaurantsManage();
          }catch(err){
            console.error(err);
            alert("åˆªé™¤å¤±æ•—\n\n" + (err?.message || err));
            statusPill.textContent = "åˆªé™¤å¤±æ•—ï¼ˆçœ‹ consoleï¼‰";
          }
        };
      });

      // ===== é¤é»ï¼šé¸é …ç¾¤çµ„ç·¨è¼¯ & å„²å­˜ / åˆªé™¤ =====
      wrap.querySelectorAll("button[data-editopt]").forEach(btn=>{
        btn.onclick = async ()=>{
          const rid = btn.dataset.rid;
          const mid = btn.dataset.mid;
          const rowKey = `${rid}__${mid}`;

          const row = wrap.querySelector(`.menuOptEditorRow[data-opt-row="${rowKey}"]`);
          if(!row) return;

          const box = row.querySelector(".optEditorBox");
          if(!box) return;

          const isOpen = row.style.display === "" || row.style.display === "table-row";
          if(isOpen){
            row.style.display = "none";
            box.innerHTML = "";
            return;
          }

          const menuSnap = await getDoc(doc(db,"restaurants", rid, "menu", mid));
          const menuData = menuSnap.exists() ? menuSnap.data() : {};

          let groups = Array.isArray(menuData.optionGroups) ? menuData.optionGroups : [];
          groups = cloneOptionGroups(groups);

          const cacheKey = `${rid}__${mid}`;
          menuOptionCache.set(cacheKey, groups);

          renderMenuOptionEditor(rid, mid, box);
          row.style.display = "table-row";
        };
      });

    wrap.querySelectorAll("button[data-savem2]").forEach(b=>{
  b.onclick = async ()=>{
    const rid = b.dataset.rid;
    const mid = b.dataset.mid;

    // è®€é€™ä¸€åˆ—é¤é»æ¬„ä½
    const els = wrap.querySelectorAll(`[data-rid="${rid}"][data-mid="${mid}"]`);
    const patch = {};
    els.forEach(el=>{
      const k = el.dataset.k;
      patch[k] = (k==="price" || k==="defaultQty")
        ? Number(el.value||0)
        : el.value.trim();
    });
    patch.defaultQty = Math.max(1, Number(patch.defaultQty||1));
    patch.price = Math.max(0, Number(patch.price||0));

    // ğŸ” çœ‹çœ‹å¿«å–è£¡æœ‰æ²’æœ‰ç¾¤çµ„ï¼ˆé™¤éŒ¯ç”¨ï¼‰
    const ogKey = `${rid}__${mid}`;
    const og = menuOptionCache.get(ogKey);
    console.log("å„²å­˜æ™‚çš„é¸é …ç¾¤çµ„å¿«å–ï¼š", ogKey, og);

    // âœ… æœ‰çš„è©±ä¸€èµ·å¯«å› optionGroups
    if(Array.isArray(og)){
      patch.optionGroups = cloneOptionGroups(og);
    }

    try{
      statusPill.textContent = "é¤é»å„²å­˜ä¸­â€¦";
      await updateDoc(doc(db,"restaurants", rid, "menu", mid), patch);
      statusPill.textContent = "é¤é»å·²å„²å­˜ âœ…";

      // âœ… é †ä¾¿æ›´æ–°ã€Œå·²è¨­å®šé¤é»ã€é‚£ä¸€æ ¼ summaryï¼Œé¦¬ä¸Šçœ‹åˆ°çµæœ
      const td = b.closest("tr")?.querySelector("td:nth-child(5)");
      if(td && Array.isArray(patch.optionGroups)){
        td.textContent = optionGroupsSummary(patch.optionGroups);
      }

      await refreshRestaurantsManage();
    }catch(err){
      console.error(err);
      alert("å„²å­˜é¤é»å¤±æ•—\n\n" + (err?.message || err));
      statusPill.textContent = "é¤é»å„²å­˜å¤±æ•—ï¼ˆçœ‹ consoleï¼‰";
    }
  };
});

      wrap.querySelectorAll("button[data-delm2]").forEach(b=>{
        b.onclick = async ()=>{
          const rid = b.dataset.rid;
          const mid = b.dataset.mid;
          if(!confirm("ç¢ºå®šåˆªé™¤é¤é»ï¼Ÿ")) return;
          try{
            await deleteDoc(doc(db,"restaurants", rid, "menu", mid));
            await refreshRestaurantsManage();
          }catch(err){
            console.error(err);
            alert("åˆªé™¤é¤é»å¤±æ•—\n\n" + (err?.message || err));
          }
        };
      });

      // ===== é¤å»³ç®¡ç†ï¼šæ–°å¢é¤é» / æ¸…ç©º =====
      wrap.querySelectorAll("button[data-addmenu]").forEach(btn=>{
        btn.onclick = async ()=>{
          const rid = btn.dataset.addmenu;

          const category = (wrap.querySelector(`[data-add-rid="${rid}"][data-add-k="category"]`)?.value || "").trim();
          const name = (wrap.querySelector(`[data-add-rid="${rid}"][data-add-k="name"]`)?.value || "").trim();
          const price = Number(
            wrap.querySelector(`[data-add-rid="${rid}"][data-add-k="price"]`)?.value || 0
          );
          const defaultQty = Math.max(
            1,
            Number(wrap.querySelector(`[data-add-rid="${rid}"][data-add-k="defaultQty"]`)?.value || 1)
          );

          if(!category) return alert("è«‹è¼¸å…¥é¤é»é¡åˆ¥");
          if(!name) return alert("è«‹è¼¸å…¥é¤é»åç¨±");
          if(isNaN(price) || price<0) return alert("åƒ¹æ ¼ä¸æ­£ç¢º");

          try{
            statusPill.textContent = "æ–°å¢é¤é»ä¸­â€¦";

            const menuCol = collection(db, "restaurants", rid, "menu");
            await addDoc(menuCol, {
              category,
              name,
              price,
              defaultQty,
              optionGroups: [],
              createdAt: Date.now()
            });

            statusPill.textContent = "å·²æ–°å¢é¤é» âœ…";

            const c1 = wrap.querySelector(`[data-add-rid="${rid}"][data-add-k="category"]`);
            const c2 = wrap.querySelector(`[data-add-rid="${rid}"][data-add-k="name"]`);
            const c3 = wrap.querySelector(`[data-add-rid="${rid}"][data-add-k="price"]`);
            const c4 = wrap.querySelector(`[data-add-rid="${rid}"][data-add-k="defaultQty"]`);
            if(c1) c1.value = "";
            if(c2) c2.value = "";
            if(c3) c3.value = "";
            if(c4) c4.value = "1";

            await refreshRestaurantsManage();
          }catch(err){
            console.error(err);
            alert("æ–°å¢é¤é»å¤±æ•—\n\n" + (err?.message || err));
            statusPill.textContent = "æ–°å¢é¤é»å¤±æ•—ï¼ˆçœ‹ consoleï¼‰";
          }
        };
      });

      // âœ… æ¸…ç©ºã€Œæ–°å¢é¤é»ã€è¼¸å…¥æ¬„ä½
      wrap.querySelectorAll("button[data-clearadd]").forEach(btn=>{
        btn.onclick = ()=>{
          const rid = btn.dataset.clearadd;
          const c1 = wrap.querySelector(`[data-add-rid="${rid}"][data-add-k="category"]`);
          const c2 = wrap.querySelector(`[data-add-rid="${rid}"][data-add-k="name"]`);
          const c3 = wrap.querySelector(`[data-add-rid="${rid}"][data-add-k="price"]`);
          const c4 = wrap.querySelector(`[data-add-rid="${rid}"][data-add-k="defaultQty"]`);
          if(c1) c1.value = "";
          if(c2) c2.value = "";
          if(c3) c3.value = "";
          if(c4) c4.value = "1";
        };
      });

}

    // ====== è¨‚é¤ç´€éŒ„ï¼ˆå½™æ•´è¼¸å‡º + Excel + åˆªå–®/åˆªä¸€é“ + æœªé»é¤æé†’ï¼‰ ======
    $("btnToday").onclick = ()=> $("o_date").value = todayISO();
    $("o_date").value = todayISO();

    let lastLoadedOrders = [];
    let ordersUnsub = null;

    function dayRangeMs(dateStr){
      const start = new Date(dateStr + "T00:00:00").getTime();
      const end   = new Date(dateStr + "T23:59:59.999").getTime();
      return { start, end };
    }

    function itemNoteText(it){
      return (it?.note ?? it?.remark ?? it?.itemNote ?? it?.memo ?? "").toString().trim();
    }

    function addonText(addons){
      const arr = Array.isArray(addons) ? addons : [];
      if(arr.length===0) return "";
      return arr.map(a=>{
        const p = Number(a?.price||0);
        const group = a?.group ? `(${a.group})` : "";
        const kind = a?.kind === "choice" ? "æ“‡ä¸€" : (a?.kind === "addon" ? "åŠ è³¼" : "");
        const kindTxt = kind ? `[${kind}]` : "";
        return `+${kindTxt}${group}${a?.name||""}${p?(" "+p):""}`;
      }).join(" ");
    }

    function addonUnitSum(addons){
      const arr = Array.isArray(addons) ? addons : [];
      return arr.reduce((s,a)=> s + Number(a?.price||0), 0);
    }

    function addonsKey(addons){
      const arr = Array.isArray(addons) ? addons : [];
      const norm = arr.map(a=>({
        name: (a?.name ?? "").toString(),
        price: Number(a?.price ?? 0),
        kind: (a?.kind ?? "").toString(),
        group: (a?.group ?? "").toString(),
      }));
      norm.sort((x,y)=>{
        const a = `${x.kind}|${x.group}|${x.name}|${x.price}`;
        const b = `${y.kind}|${y.group}|${y.name}|${y.price}`;
        return a.localeCompare(b, "zh-Hant");
      });
      return JSON.stringify(norm);
    }

    function calcOrderTotal(items){
      const arr = Array.isArray(items) ? items : [];
      return arr.reduce((s,it)=>{
        const unitAddon = addonUnitSum(it.addons);
        return s + (Number(it.price||0) + unitAddon) * Number(it.qty||0);
      }, 0);
    }

    // âœ… è¨‚å–®æ’åºï¼ˆç•«é¢èˆ‡ Excel å…±ç”¨ï¼‰ï¼šä¾æŒ‡å®šéƒ¨é–€é †åº + å§“å + é¤å»³ + æ™‚é–“(æ–°â†’èˆŠ)
    function sortOrdersForDetails(arr){
      const orders = Array.isArray(arr) ? [...arr] : [];
      orders.sort((a,b)=>{
        const da = (a.userDept || "").trim();
        const dbb = (b.userDept || "").trim();

        const ra = deptRank(da);
        const rb = deptRank(dbb);
        if(ra !== rb) return ra - rb;

        const na = (a.userName || "").trim();
        const nb = (b.userName || "").trim();
        if(na !== nb) return na.localeCompare(nb, "zh-Hant");

        const raName = (a.restaurantName || "").trim();
        const rbName = (b.restaurantName || "").trim();
        if(raName !== rbName) return raName.localeCompare(rbName, "zh-Hant");

        return toMs(b.createdAt||0) - toMs(a.createdAt||0);
      });
      return orders;
    }

    // âœ… createdAt æ—¥æœŸå€é–“æŸ¥è©¢ï¼ˆçµ¦ getDocs ç”¨ï¼‰
async function loadOrdersByDate(dateStr){
  const { start, end } = dayRangeMs(dateStr);

  const snap = await getDocs(query(
    colOrders,
    where("createdAt", ">=", start),
    where("createdAt", "<=", end),
    orderBy("createdAt", "desc"),
    limit(5000)
  ));

  const orders = [];
  snap.forEach(d => {
    orders.push({
      id: d.id,
      ...(d.data() || {})
    });
  });

  return orders;
}

    async function deleteWholeOrder(orderId){
      if(!confirm("ç¢ºå®šåˆªé™¤æ•´ç­†è¨‚å–®ï¼Ÿ")) return;
      try{
        statusPill.textContent = "åˆªé™¤è¨‚å–®ä¸­â€¦";
        await deleteDoc(doc(db, "orders", orderId));
        statusPill.textContent = "å·²åˆªé™¤è¨‚å–® âœ…";
      }catch(err){
        console.error(err);
        alert("åˆªé™¤è¨‚å–®å¤±æ•—\n\n" + (err?.message || err));
      }
    }

    async function deleteOrderItem(orderId, itemIndex){
      const o = lastLoadedOrders.find(x=> x.id === orderId);
      if(!o) return alert("æ‰¾ä¸åˆ°è©²è¨‚å–®ï¼ˆè«‹é‡æ–°è¼‰å…¥ï¼‰");

      const items = Array.isArray(o.items) ? [...o.items] : [];
      const it = items[itemIndex];
      if(!it) return;

      if(!confirm(`ç¢ºå®šåˆªé™¤é€™ä¸€é“ï¼Ÿ\n\n${it.name || ""}`)) return;

      items.splice(itemIndex, 1);

      if(items.length === 0){
        if(confirm("æ­¤è¨‚å–®å·²ç„¡é¤é»ï¼Œè¦ç›´æ¥åˆªé™¤æ•´ç­†è¨‚å–®å—ï¼Ÿ")){
          await deleteWholeOrder(orderId);
          return;
        }
      }

      const newTotal = calcOrderTotal(items);

      try{
        statusPill.textContent = "æ›´æ–°è¨‚å–®ä¸­â€¦";
        await updateDoc(doc(db,"orders", orderId), {
          items,
          total: newTotal
        });
        statusPill.textContent = "å·²æ›´æ–°è¨‚å–® âœ…";
      }catch(err){
        console.error(err);
        alert("åˆªé™¤é¤é»å¤±æ•—ï¼ˆæ›´æ–°è¨‚å–®å¤±æ•—ï¼‰\n\n" + (err?.message || err));
      }
    }

    function renderOrdersSummaryAndList(orders){
      const agg = new Map();
      let grandTotal = 0;

      for(const o of orders){
        const items = Array.isArray(o.items) ? o.items : [];
        let orderTotal = Number(o.total||0);
        if(!orderTotal) orderTotal = calcOrderTotal(items);
        grandTotal += orderTotal;

        for(const it of items){
          const rName = o.restaurantName || "";
          const unit = Number(it.price||0);
          const addons = Array.isArray(it.addons) ? it.addons : [];
          const aKey = addonsKey(addons);
          const note = itemNoteText(it);
          const key = `${rName}__${it.name||""}__${unit}__${aKey}__note:${note}`;

          if(!agg.has(key)){
            agg.set(key, { restaurant: rName, item: it.name||"", unit, addons, note, qty: 0 });
          }
          agg.get(key).qty += Number(it.qty||0);
        }
      }

      // ===== å·¦ï¼šåŒå“é …å½™ç¸½ =====
      const summaryRows = Array.from(agg.values())
        .sort((a,b)=> b.qty-a.qty)
        .map(x=>{
          const unitAddon = addonUnitSum(x.addons);
          const addonAmt = unitAddon * x.qty;
          const itemAmt = x.unit * x.qty;
          const total = (x.unit + unitAddon) * x.qty;
          return `
            <tr>
              <td>${esc(x.restaurant)}</td>
              <td>${esc(x.item)}</td>
              <td class="muted">${esc(addonText(x.addons))}</td>
              <td class="muted">${esc(x.note || "")}</td>
              <td>${x.qty}</td>
              <td>${x.unit}</td>
              <td>${addonAmt}</td>
              <td>${itemAmt}</td>
              <td>${total}</td>
            </tr>
          `;
        }).join("");

      const summaryHTML = `
        <div class="inline" style="justify-content:space-between; margin-bottom:10px">
          <span class="tag">å…± ${orders.length} ç­†è¨‚å–®</span>
          <span class="tag">è¨‚å–®ç¸½åŠ ç¸½ï¼š${grandTotal}</span>
        </div>

        <table>
          <thead>
            <tr>
              <th>é¤å»³</th>
              <th>å“é …</th>
              <th>åŠ è³¼/æ“‡ä¸€</th>
              <th>é¤é»å‚™è¨»</th>
              <th>æ•¸é‡</th>
              <th>å–®åƒ¹</th>
              <th>åŠ è³¼é‡‘é¡</th>
              <th>å“é …é‡‘é¡</th>
              <th>å°è¨ˆ</th>
            </tr>
          </thead>
          <tbody>
            ${summaryRows || `<tr><td colspan="9" class="muted">æ­¤æ—¥æœŸæ²’æœ‰è¨‚å–®</td></tr>`}
          </tbody>
        </table>
      `;

      // ===== å³ï¼šè¨‚å–®æ˜ç´°ï¼ˆä¾éƒ¨é–€åˆ†çµ„ï¼‰ =====
      const detailOrders = sortOrdersForDetails(orders);

      const deptMap = new Map();
      for (const o of detailOrders) {
        const dept = (o.userDept || "æœªåˆ†éƒ¨é–€").trim() || "æœªåˆ†éƒ¨é–€";
        if (!deptMap.has(dept)) deptMap.set(dept, []);
        deptMap.get(dept).push(o);
      }

      const orderedDepts = [
        ...DEPT_ORDER.filter(d => deptMap.has(d)),
        ...Array.from(deptMap.keys()).filter(d => !DEPT_INDEX.has(d))
      ];

      const detailHTML = orderedDepts.map(dept=>{
        const list = deptMap.get(dept) || [];

        const deptInner = list.map(o=>{
          const name = o.userName || "";
          const restaurant = o.restaurantName || "";
          const time = toTWTime(o.createdAt);
          const orderNote = (o.orderNote || o.remark || "");
          const items = Array.isArray(o.items) ? o.items : [];
          const total = Number(o.total||0) || calcOrderTotal(items);

          return `
            <details style="border:1px solid rgba(15,23,42,.10); border-radius:16px; padding:10px 12px; background:#fff; margin-top:10px;">
              <summary>
                <span style="font-size:14px">${esc(name)}ï½œ${esc(restaurant)}</span>
                <span class="tag" style="margin-left:8px">${items.length} é“</span>
                <span class="tag" style="margin-left:6px">ç¸½é¡ ${total}</span>
                <span class="tag" style="margin-left:6px">${esc(time)}</span>
              </summary>

              ${orderNote ? `<div class="muted mini" style="margin-top:8px">æ•´å–®å‚™è¨»ï¼š${esc(orderNote)}</div>` : ``}

              <div class="hr"></div>

              ${items.length===0 ? `<div class="muted">ï¼ˆæ­¤è¨‚å–®æ²’æœ‰é¤é»ï¼‰</div>` : `
                <table>
                  <thead>
                    <tr>
                      <th>å“é …</th>
                      <th>åŠ è³¼/æ“‡ä¸€</th>
                      <th>é¤é»å‚™è¨»</th>
                      <th>æ•¸é‡</th>
                      <th>å–®åƒ¹</th>
                      <th>å°è¨ˆ</th>
                      <th>æ“ä½œ</th>
                    </tr>
                  </thead>
                  <tbody>
                    ${items.map((it,idx)=>{
                      const qty = Number(it.qty||0);
                      const unit = Number(it.price||0);
                      const unitAddon = addonUnitSum(it.addons);
                      const sub = (unit + unitAddon) * qty;
                      return `
                        <tr>
                          <td><b>${esc(it.name||"")}</b></td>
                          <td class="muted">${esc(addonText(it.addons))}</td>
                          <td class="muted">${esc(itemNoteText(it))}</td>
                          <td>${qty}</td>
                          <td>${unit}</td>
                          <td>${sub}</td>
                          <td>
                            <button class="btnSmall btnDanger" type="button"
                              data-del-item="1" data-oid="${o.id}" data-idx="${idx}">åˆªæ­¤ä¸€é“</button>
                          </td>
                        </tr>
                      `;
                    }).join("")}
                  </tbody>
                </table>
              `}

              <div class="actions">
                <button class="btnSmall btnDanger" type="button" data-del-order="1" data-oid="${o.id}">åˆªæ•´ç­†è¨‚å–®</button>
              </div>
            </details>
          `;
        }).join("");

        return `
          <details style="border:1px solid rgba(15,23,42,.10); border-radius:16px; padding:10px 12px; background:rgba(255,255,255,.9); margin-top:10px;">
            <summary>
              <span style="font-size:14.5px">${esc(dept)}</span>
              <span class="tag" style="margin-left:8px">${list.length} ç­†è¨‚å–®</span>
            </summary>
            <div style="margin-top:10px">
              ${deptInner || `<div class="muted">ï¼ˆæ­¤éƒ¨é–€æ²’æœ‰è¨‚å–®ï¼‰</div>`}
            </div>
          </details>
        `;
      }).join("");

      return { summaryHTML, detailHTML };
    }

    function bindOrderDeleteButtons(){
      const out = $("ordersDetailOut");
      if(!out) return;

      out.querySelectorAll("[data-del-order]").forEach(btn=>{
        btn.onclick = async ()=>{
          const oid = btn.dataset.oid;
          await deleteWholeOrder(oid);
        };
      });

      out.querySelectorAll("[data-del-item]").forEach(btn=>{
        btn.onclick = async ()=>{
          const oid = btn.dataset.oid;
          const idx = Number(btn.dataset.idx);
          await deleteOrderItem(oid, idx);
        };
      });
    }

    const noOrderBanner = $("noOrderBanner");
    const noOrderModal = $("noOrderModal");
    const noOrderList = $("noOrderList");

    async function checkNotOrderedForDate(dateStr, orders, showModal){
      try{
        if(!Array.isArray(orders)){
          orders = await loadOrdersByDate(dateStr);
        }
        await loadAllStaffOnce();

        if(!noOrderBanner) return;

        const schSnap = await getDoc(doc(db,"schedules", dateStr));
        if(!schSnap.exists()){
          noOrderBanner.className = "alertBar alertWarn";
          noOrderBanner.textContent = "âš  ä»Šæ—¥å°šæœªè¨­å®šç­è¡¨ï¼Œç„¡æ³•åˆ¤æ–·èª°æœªé»é¤ï¼ˆè«‹åˆ°ã€Œç­è¡¨ç®¡ç†ã€è¨­å®šï¼‰ã€‚";
          noOrderBanner.style.display = "";
          if(showModal && noOrderModal && noOrderList){
            noOrderList.textContent = "å°šæœªè¨­å®šä»Šæ—¥ç­è¡¨ã€‚è«‹å…ˆåˆ°ã€Œç­è¡¨ç®¡ç†ã€ç‚ºæ­¤æ—¥æœŸå‹¾é¸ä¸Šç­äººå“¡ã€‚";
            noOrderModal.style.display = "flex";
          }
          return;
        }

        const data = schSnap.data()||{};
        const workerKeys = Array.isArray(data.workerKeys) ? data.workerKeys : [];
        if(workerKeys.length===0){
          noOrderBanner.className = "alertBar alertWarn";
          noOrderBanner.textContent = "âš  ä»Šæ—¥ç­è¡¨æ²’æœ‰ä»»ä½•ä¸Šç­äººå“¡ï¼ˆæœªå‹¾é¸ï¼‰ã€‚";
          noOrderBanner.style.display = "";
          return;
        }

        const workingSet = new Set(workerKeys);

        const orderedSet = new Set();
        for(const o of orders){
          const dept = (o.userDept || "").trim();
          const name = (o.userName || "").trim();
          if(!name) continue;
          orderedSet.add(`${dept}||${name}`);
        }

        const missingKeys = [];
        workingSet.forEach(k=>{
          if(!orderedSet.has(k)) missingKeys.push(k);
        });

        if(missingKeys.length===0){
          noOrderBanner.className = "alertBar alertOk";
          noOrderBanner.textContent = "âœ… ä»Šæ—¥æ‰€æœ‰æ‡‰ä¸Šç­äººå“¡çš†å·²é»é¤";
          noOrderBanner.style.display = "";
          if(showModal && noOrderModal && noOrderList){
            noOrderList.textContent = "ä»Šæ—¥æ‰€æœ‰æ‡‰ä¸Šç­äººå“¡çš†å·²é»é¤ã€‚";
            noOrderModal.style.display = "flex";
          }
          return;
        }

        const byDept = new Map();
        missingKeys.forEach(k=>{
          const [dept,name] = k.split("||");
          const d = (dept || "æœªåˆ†éƒ¨é–€");
          if(!byDept.has(d)) byDept.set(d,[]);
          byDept.get(d).push(name || "");
        });
        const lines = Array.from(byDept.entries()).map(([dept,names])=>`${dept}ï¼š${names.join("ã€")}`);

        noOrderBanner.className = "alertBar alertWarn";
        noOrderBanner.textContent = `ğŸ”” ä»Šæ—¥å°šæœ‰ ${missingKeys.length} äººæœªé»é¤ï¼š` + lines.join("ï¼›");
        noOrderBanner.style.display = "";

        if(showModal && noOrderModal && noOrderList){
          noOrderList.innerHTML = `
            <p class="muted">ä»Šæ—¥å°šæœ‰ <b>${missingKeys.length}</b> äººæœªé»é¤ï¼š</p>
            <ul class="mini">
              ${lines.map(line=>`<li>${esc(line)}</li>`).join("")}
            </ul>
            <p class="muted mini">æé†’ï¼šåå–®ä¾†æºç‚ºã€Œç­è¡¨ç®¡ç†ã€ä¸­æ­¤æ—¥æœŸæœ‰å‹¾é¸ä¸Šç­çš„äººã€‚</p>
          `;
          noOrderModal.style.display = "flex";
        }
      }catch(err){
        console.error(err);
        if(noOrderBanner){
          noOrderBanner.className = "alertBar alertWarn";
          noOrderBanner.textContent = "ç„¡æ³•å–å¾—ç­è¡¨æˆ–è¨‚å–®è³‡æ–™ï¼ˆè«‹æŸ¥çœ‹ consoleï¼‰ã€‚";
          noOrderBanner.style.display = "";
        }
      }
    }
    
// âœ… çµå–®è¦–çª—ç”¨ï¼šè¨ˆç®—ã€Œä½ æ‰“å‹¾ä½†å°šæœªé»é¤çš„äººã€
async function updateCloseConfirmNoOrder(){
  const box = $("closeConfirmNoOrder");
  if(!box) return;

  box.textContent = "æœ¬æ—¥ä¸Šç­æœªé»é¤äººå“¡ï¼šè¨ˆç®—ä¸­â€¦";

  try{
    const dateStr = todayISO();

    // å–å¾—ä»Šå¤©æ‰€æœ‰è¨‚å–®
    const orders = await loadOrdersByDate(dateStr);
    const orderedSet = new Set();
    for(const o of orders){
      const dept = (o.userDept || "").trim();
      const name = (o.userName || "").trim();
      if(name) orderedSet.add(`${dept}||${name}`);
    }

    // å–å¾—ä½ å‹¾é¸çš„ä¸Šç­äººå“¡ï¼ˆdata-k="isClosed"ï¼‰
    const workingKeys = [];
    document.querySelectorAll('input[data-k="isClosed"]').forEach(cb=>{
      if(cb.checked){
        const dept = cb.dataset.dept || "";
        const name = cb.dataset.name || "";
        if(name) workingKeys.push(`${dept}||${name}`);
      }
    });

    if(workingKeys.length === 0){
      box.textContent = "å°šæœªå‹¾é¸ä»Šæ—¥ä¸Šç­äººå“¡ã€‚";
      return;
    }

    // è¨ˆç®—æœªé»é¤
    const missing = [];
    workingKeys.forEach(k=>{
      if(!orderedSet.has(k)) missing.push(k);
    });

    if(missing.length === 0){
      box.textContent = "âœ… ä»Šæ—¥æ‰€æœ‰ä¸Šç­äººå“¡çš†å·²é»é¤ã€‚";
      return;
    }

    // ä¾éƒ¨é–€åˆ†çµ„
    const byDept = new Map();
    missing.forEach(k=>{
      const [dept,name] = k.split("||");
      const d = dept || "æœªåˆ†éƒ¨é–€";
      if(!byDept.has(d)) byDept.set(d, []);
      byDept.get(d).push(name);
    });

    const lines = Array.from(byDept.entries())
      .map(([dept,names]) => `${dept}ï¼š${names.join("ã€")}`);

    box.innerHTML = `
      <div style="margin-bottom:4px;">æœ¬æ—¥ä¸Šç­æœªé»é¤äººå“¡ï¼š</div>
      <ul class="mini">${lines.map(l=>`<li>${esc(l)}</li>`).join("")}</ul>
    `;

  }catch(err){
    console.error(err);
    box.textContent = "âš  ç„¡æ³•å–å¾—è³‡æ–™ï¼ˆè«‹æŸ¥çœ‹ consoleï¼‰ã€‚";
  }
}

    $("btnCloseNoOrder")?.addEventListener("click", ()=>{
      if(noOrderModal) noOrderModal.style.display = "none";
    });
    noOrderModal?.addEventListener("click", (e)=>{
      if(e.target.id === "noOrderModal"){
        noOrderModal.style.display = "none";
      }
    });

   // âœ… è¨‚å–®å³æ™‚ç›£è½ï¼ˆç®¡ç†è€…å¾Œå°ï¼‰
async function setupOrdersLive(dateStr){
  // å…ˆæŠŠèˆŠçš„ç›£è½é—œæ‰
  if (ordersUnsub) {
    ordersUnsub();
    ordersUnsub = null;
  }

  const { start, end } = dayRangeMs(dateStr);

  const qOrders = query(
    colOrders,
    where("createdAt", ">=", start),
    where("createdAt", "<=", end),
    orderBy("createdAt", "desc"),
    limit(5000)
  );

  statusPill.textContent = "è®€å–è¨‚å–®ä¸­â€¦";

  ordersUnsub = onSnapshot(
    qOrders,
    (snap)=>{
      (async ()=>{
        const orders = [];
        snap.forEach(d=>{
          const v = d.data() || {};
          orders.push({
            id: d.id,
            ...v
          });
        });

        // å¿«å–
        lastLoadedOrders = orders;

        // ç•«é¢è¼¸å‡º
        if (!orders.length) {
          $("ordersSummaryOut").innerHTML = `<div class="muted">æ­¤æ—¥æœŸæ²’æœ‰è¨‚å–®</div>`;
          $("ordersDetailOut").innerHTML = `<div class="muted">æ­¤æ—¥æœŸæ²’æœ‰è¨‚å–®</div>`;
          statusPill.textContent = "å·²è¼‰å…¥ï¼ˆç›®å‰ç„¡è¨‚å–®ï¼‰";
        } else {
          const { summaryHTML, detailHTML } = renderOrdersSummaryAndList(orders);
          $("ordersSummaryOut").innerHTML = summaryHTML;
          $("ordersDetailOut").innerHTML = detailHTML;
          bindOrderDeleteButtons();
          statusPill.textContent = "å·²è¼‰å…¥ âœ…";
        }

        // æª¢æŸ¥ã€Œæœªé»é¤çš„äººå“¡ã€
        await checkNotOrderedForDate(dateStr, orders, false);
      })().catch(console.error);
    },
    (err)=>{
      console.error(err);
      $("ordersSummaryOut").innerHTML =
        `<div class="muted">è®€å–è¨‚å–®å¤±æ•—<br/>${esc(err?.message || err)}</div>`;
      $("ordersDetailOut").innerHTML =
        `<div class="muted">è®€å–è¨‚å–®å¤±æ•—<br/>${esc(err?.message || err)}</div>`;
      alert("è®€å–è¨‚å–®å¤±æ•—\n\n" + (err?.message || err));
      statusPill.textContent = "è®€å–å¤±æ•—ï¼ˆçœ‹ consoleï¼‰";
    }
  );
}

    $("btnLoadOrders").onclick = async ()=>{
      const date = $("o_date").value;
      if(!date) return alert("è«‹é¸æ—¥æœŸ");

      try{
        statusPill.textContent = "è¼‰å…¥è¨‚å–®ä¸­â€¦";
        await loadAllStaffOnce(); // è®“æœªé»é¤æç¤ºæœ‰ staff åå–®
        await setupOrdersLive(date); // æœƒè‡ªå‹•æ›´æ–°ç•«é¢ + æœªé»é¤æé†’ï¼ˆBï¼‰
      }catch(err){
        console.error(err);
        $("ordersSummaryOut").innerHTML = `<div class="muted">è®€å–è¨‚å–®å¤±æ•—<br/>${esc(err?.message || err)}</div>`;
        $("ordersDetailOut").innerHTML = `<div class="muted">è®€å–è¨‚å–®å¤±æ•—<br/>${esc(err?.message || err)}</div>`;
        alert("è®€å–è¨‚å–®å¤±æ•—\n\n" + (err?.message || err));
        statusPill.textContent = "è®€å–å¤±æ•—ï¼ˆçœ‹ consoleï¼‰";
      }
    };

    $("btnExportExcel").onclick = async ()=>{
      const date = $("o_date").value;
      if(!date) return alert("è«‹é¸æ—¥æœŸ");

      try{
        await loadAllStaffOnce();
        // åŒ¯å‡ºå‰å…ˆåšä¸€æ¬¡å¼·æé†’ï¼ˆAï¼‰
        await checkNotOrderedForDate(date, lastLoadedOrders, true);

        statusPill.textContent = "æº–å‚™ Excelâ€¦";

        let orders = lastLoadedOrders;
        if(!Array.isArray(orders) || orders.length===0){
          orders = await loadOrdersByDate(date);
          lastLoadedOrders = orders;
        }
        if(!orders || orders.length===0) return alert("æ­¤æ—¥æœŸæ²’æœ‰è¨‚å–®å¯åŒ¯å‡º");

        // âœ… ä¾ä½ åŸæœ¬æ’åºï¼ˆéƒ¨é–€é †åº + å§“å + é¤å»³ + æ™‚é–“ï¼‰
        const sorted = sortOrdersForDetails(orders);

        // âœ… Person Mapï¼škey=dept||name
        const personMap = new Map();

        for(const o of sorted){
          const dept = (o.userDept || "æœªåˆ†éƒ¨é–€").trim() || "æœªåˆ†éƒ¨é–€";
          const name = (o.userName || "").trim();
          const restaurant = (o.restaurantName || "").trim();
          if(!name) continue;

          const pKey = `${dept}||${name}`;
          if(!personMap.has(pKey)){
            personMap.set(pKey, { dept, name, restMap: new Map(), totalAmountAll: 0 });
          }
          const p = personMap.get(pKey);

          if(!p.restMap.has(restaurant)){
            p.restMap.set(restaurant, { total: 0, items: [] });
          }
          const rObj = p.restMap.get(restaurant);

          const items = Array.isArray(o.items) ? o.items : [];
          for(const it of items){
            const qty = Number(it.qty || 0);
            const unit = Number(it.price || 0);
            const addonUnit = addonUnitSum(it.addons);
            const amount = (unit + addonUnit) * qty;

            const rowItem = {
              itemName: it.name || "",
              addonText: addonText(it.addons),
              note: itemNoteText(it),
              amount,
            };

            rObj.items.push(rowItem);
            rObj.total += amount;

            p.totalAmountAll += amount;
          }
        }

        // âœ… æ’åºäººå“¡ï¼šéƒ¨é–€é †åº â†’ å§“å
        const persons = Array.from(personMap.values());
        persons.sort((a,b)=>{
          const ra = deptRank(a.dept), rb = deptRank(b.dept);
          if(ra !== rb) return ra - rb;
          return (a.name||"").localeCompare((b.name||""), "zh-Hant");
        });

        // ========= Sheet 1ï¼šç¸½è¡¨ï¼ˆæ¯äººä¸€åˆ—ï¼‰ =========
        const summaryRows = [];
        let personNo = 0;
        let lastDeptSummary = null;

        for(const p of persons){
          personNo += 1;

          // âœ… æ‡‰æ”¶ï¼šæ¯å®¶é¤å»³å„æ‰£ä¸€æ¬¡ 140
          let receivableAll = 0;
          for(const [rest, rObj] of p.restMap.entries()){
            receivableAll += Math.max(Number(rObj.total || 0) - 140, 0);
          }

          const showDept = p.dept !== lastDeptSummary;

          summaryRows.push({
            "äººæ•¸": personNo,
            "éƒ¨é–€": showDept ? p.dept : "",
            "å§“å": p.name,
            "ç¸½é‡‘é¡": Number(p.totalAmountAll || 0),
            "ç¸½æ‡‰æ”¶": Number(receivableAll || 0),
          });

          lastDeptSummary = p.dept;
        }

        const summaryHeader = ["äººæ•¸","éƒ¨é–€","å§“å","ç¸½é‡‘é¡","ç¸½æ‡‰æ”¶"];
        const wsSummary = XLSX.utils.json_to_sheet(summaryRows, { header: summaryHeader });
        wsSummary["!freeze"] = { xSplit: 0, ySplit: 1 };
        const rangeS = XLSX.utils.decode_range(wsSummary["!ref"]);
        wsSummary["!autofilter"] = { ref: XLSX.utils.encode_range({ s:{r:0,c:0}, e:{r:rangeS.e.r,c:rangeS.e.c} }) };
        wsSummary["!cols"] = [
          { wch: 6 },
          { wch: 10 },
          { wch: 12 },
          { wch: 10 },
          { wch: 10 },
        ];

        // ========= Sheet 2ï¼šæ˜ç´°ï¼ˆé€å“é …ï¼‰ =========
        const detailRows = [];
        personNo = 0;
        let lastDeptDetail = null;

        for(const p of persons){
          personNo += 1;

          const showDept = p.dept !== lastDeptDetail;

          const rests = Array.from(p.restMap.entries()).sort((a,b)=>{
            return (a[0]||"").localeCompare((b[0]||""), "zh-Hant");
          });

          let firstLineOfPerson = true;

          for(const [restName, rObj] of rests){
            const receivableThisRest = Math.max(Number(rObj.total || 0) - 140, 0);
            const list = Array.isArray(rObj.items) ? rObj.items : [];

            if(list.length === 0){
              detailRows.push({
                "äººæ•¸": firstLineOfPerson ? personNo : "",
                "éƒ¨é–€": (firstLineOfPerson && showDept) ? p.dept : "",
                "å§“å": firstLineOfPerson ? p.name : "",
                "å“é …": "",
                "åŠ è³¼/æ“‡ä¸€": "",
                "é¤é»å‚™è¨»": "",
                "é‡‘é¡": 0,
                "æ‡‰æ”¶": receivableThisRest
              });
              firstLineOfPerson = false;
              continue;
            }

            list.forEach((it, idx)=>{
              detailRows.push({
                "äººæ•¸": (firstLineOfPerson && idx===0) ? personNo : "",
                "éƒ¨é–€": (firstLineOfPerson && idx===0 && showDept) ? p.dept : "",
                "å§“å": (firstLineOfPerson && idx===0) ? p.name : "",
                "å“é …": it.itemName,
                "åŠ è³¼/æ“‡ä¸€": it.addonText,
                "é¤é»å‚™è¨»": it.note,
                "é‡‘é¡": it.amount,
                "æ‡‰æ”¶": idx === 0 ? receivableThisRest : ""
              });
            });

            firstLineOfPerson = false;
          }

          lastDeptDetail = p.dept;
        }

        const detailHeader = ["äººæ•¸","éƒ¨é–€","å§“å","å“é …","åŠ è³¼/æ“‡ä¸€","é¤é»å‚™è¨»","é‡‘é¡","æ‡‰æ”¶"];
        const wsDetail = XLSX.utils.json_to_sheet(detailRows, { header: detailHeader });
        wsDetail["!freeze"] = { xSplit: 0, ySplit: 1 };
        const rangeD = XLSX.utils.decode_range(wsDetail["!ref"]);
        wsDetail["!autofilter"] = { ref: XLSX.utils.encode_range({ s:{r:0,c:0}, e:{r:rangeD.e.r,c:rangeD.e.c} }) };
        wsDetail["!cols"] = [
          { wch: 6 },
          { wch: 10 },
          { wch: 12 },
          { wch: 24 },
          { wch: 28 },
          { wch: 18 },
          { wch: 10 },
          { wch: 10 },
        ];

        const wb = XLSX.utils.book_new();
        XLSX.utils.book_append_sheet(wb, wsSummary, "ç¸½è¡¨(æ¯äººä¸€åˆ—)");
        XLSX.utils.book_append_sheet(wb, wsDetail, "æ˜ç´°(é€å“é …)");

        XLSX.writeFile(wb, `GoldBricks_æ‡‰æ”¶_${date}.xlsx`);
        statusPill.textContent = "Excel å·²åŒ¯å‡º âœ…";

      }catch(err){
        console.error(err);
        alert("åŒ¯å‡ºå¤±æ•—\n\n" + (err?.message || err));
        statusPill.textContent = "åŒ¯å‡ºå¤±æ•—ï¼ˆçœ‹ consoleï¼‰";
      }
    };
    
// ========= çµå–®ç¢ºèªï¼ˆç°¡å–®ç‰ˆï¼‰ =========

// æš«å­˜å‰›å‰›è¢«å‹¾é¸çš„ã€Œçµå–®ã€ checkbox
let pendingCloseCheckbox = null;

// ç›£è½æ‰€æœ‰è®Šæ›´äº‹ä»¶ï¼ŒæŠ“åˆ° data-k="isClosed" çš„å‹¾å‹¾
document.addEventListener("change", (e) => {
  const cb = e.target;
  if (!(cb instanceof HTMLInputElement)) return; // ä¸æ˜¯ input å°±æ°
  if (cb.type !== "checkbox") return;            // ä¸æ˜¯ checkbox æ°
  if (cb.dataset.k !== "isClosed") return;       // åªè™•ç† çµå–® çš„å‹¾å‹¾

  // åªæœ‰ã€Œå‹¾èµ·ä¾†ã€æ™‚è¦è·³è¦–çª—ï¼Œå–æ¶ˆå‹¾é¸å°±ç›´æ¥æ”¾é
  if (!cb.checked) return;

  pendingCloseCheckbox = cb;

  const modal = document.getElementById("closeConfirmModal");
  if (!modal) return;

  // é¡¯ç¤ºå½ˆè·³çª—åœ¨ç•«é¢æ­£ä¸­å¤®
  modal.style.display = "flex";

  // åŠ ä¸Šå‹•ç•« classï¼ˆå°æ‡‰ä½ ä¸Šé¢ CSS çš„ .modalMask.fadeIn / .modalBox.popInï¼‰
  modal.classList.add("fadeIn");
  const box = modal.querySelector(".modalBox");
  if (box) box.classList.add("popIn");
});

// ã€Œå…ˆä¸è¦ã€â†’ é—œé–‰è¦–çª— + æŠŠå‹¾å‹¾å–æ¶ˆ
document.getElementById("btnCancelClose")?.addEventListener("click", () => {
  const modal = document.getElementById("closeConfirmModal");
  if (modal) {
    modal.style.display = "none";
    modal.classList.remove("fadeIn");
    const box = modal.querySelector(".modalBox");
    if (box) box.classList.remove("popIn");
  }

  if (pendingCloseCheckbox) {
    pendingCloseCheckbox.checked = false; // é‚„åŸæˆæ²’çµå–®
    pendingCloseCheckbox = null;
  }
});

// ã€Œç¢ºå®šçµå–®ã€â†’ é—œé–‰è¦–çª—ï¼Œä½†ä¿ç•™å‹¾å‹¾ï¼ˆçœŸçš„çµå–®ï¼‰
document.getElementById("btnConfirmClose")?.addEventListener("click", () => {
  const modal = document.getElementById("closeConfirmModal");
  if (modal) {
    modal.style.display = "none";
    modal.classList.remove("fadeIn");
    const box = modal.querySelector(".modalBox");
    if (box) box.classList.remove("popIn");
  }

  // ä¿ç•™ checked ç‹€æ…‹å°±å¥½
  pendingCloseCheckbox = null;
});

</script>
</body>
</html>
