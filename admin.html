<!-- admin.htmlï¼ˆå®Œæ•´ï¼‰ -->
<!doctype html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>ç®¡ç†è€…å¾Œå°ï½œé¤å»³ç®¡ç†ï¼‹é¤é»ç®¡ç†</title>
  <style>
    :root{
      --bg:#f5f4fb;
      --card:#ffffff;
      --text:#0f172a;
      --muted:#64748b;
      --line:#e8eaf3;
      --primary:#fb7185;
      --primary2:#fda4af;
      --danger:#ef4444;
      --ok:#22c55e;
      --shadow:0 10px 30px rgba(15,23,42,.08);
      --r:20px;
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      font-family: ui-sans-serif, system-ui, -apple-system, "Segoe UI", "Noto Sans TC", Arial;
      background:linear-gradient(135deg,#fff1f2 0%, #f5f4fb 40%, #eef2ff 100%);
      color:var(--text);
    }
    header{
      position:sticky; top:0; z-index:50;
      backdrop-filter: blur(10px);
      background:rgba(245,244,251,.7);
      border-bottom:1px solid rgba(232,234,243,.8);
    }
    .wrap{max-width:1100px;margin:0 auto;padding:16px}
    .topbar{
      display:flex; gap:12px; align-items:center; justify-content:space-between;
    }
    .brand{
      display:flex; gap:10px; align-items:center;
    }
    .logo{
      width:42px;height:42px;border-radius:14px;
      background:linear-gradient(135deg,var(--primary),#ffd5c2);
      box-shadow: 0 10px 18px rgba(251,113,133,.25);
    }
    h1{margin:0;font-size:18px;letter-spacing:.5px}
    .sub{font-size:12px;color:var(--muted);margin-top:2px}
    .pill{
      font-size:12px;
      padding:8px 10px;
      border-radius:999px;
      border:1px solid rgba(232,234,243,.9);
      background:rgba(255,255,255,.6);
      display:flex; gap:8px; align-items:center;
      white-space:nowrap;
    }
    .pill b{color:var(--primary)}
    main{padding:16px 0 40px}
    .grid{
      display:grid;
      grid-template-columns: 420px 1fr;
      gap:16px;
      align-items:start;
    }
    @media (max-width: 980px){
      .grid{grid-template-columns:1fr}
    }
    .card{
      background:rgba(255,255,255,.9);
      border:1px solid rgba(232,234,243,.9);
      box-shadow:var(--shadow);
      border-radius:var(--r);
      overflow:hidden;
    }
    .cardHead{
      padding:14px 16px;
      border-bottom:1px solid rgba(232,234,243,.9);
      display:flex; align-items:center; justify-content:space-between; gap:10px;
      background:linear-gradient(90deg, rgba(251,113,133,.09), rgba(253,164,175,.04), rgba(99,102,241,.04));
    }
    .cardHead h2{margin:0;font-size:14px}
    .cardBody{padding:14px 16px}
    .row{display:flex; gap:10px}
    .row > *{flex:1}
    label{display:block;font-size:12px;color:var(--muted);margin:10px 0 6px}
    input, textarea, select{
      width:100%;
      border:1px solid rgba(232,234,243,.95);
      background:#fff;
      border-radius:14px;
      padding:10px 12px;
      outline:none;
      font-size:14px;
    }
    textarea{min-height:80px;resize:vertical}
    input:focus, textarea:focus, select:focus{
      border-color: rgba(251,113,133,.55);
      box-shadow: 0 0 0 4px rgba(251,113,133,.12);
    }
    .btns{display:flex; gap:10px; flex-wrap:wrap; margin-top:12px}
    button{
      border:none;
      border-radius:14px;
      padding:10px 12px;
      cursor:pointer;
      font-weight:700;
      font-size:14px;
    }
    .btnPrimary{
      background:linear-gradient(135deg,var(--primary),#ff9aa6);
      color:#fff;
      box-shadow: 0 10px 18px rgba(251,113,133,.22);
    }
    .btnGhost{
      background:rgba(255,255,255,.8);
      border:1px solid rgba(232,234,243,.95);
      color:var(--text);
    }
    .btnDanger{
      background:rgba(239,68,68,.1);
      color:var(--danger);
      border:1px solid rgba(239,68,68,.25);
    }
    .btnOk{
      background:rgba(34,197,94,.12);
      color:#15803d;
      border:1px solid rgba(34,197,94,.25);
    }
    .hint{font-size:12px;color:var(--muted);line-height:1.5}
    .list{
      display:grid;
      grid-template-columns: repeat(2, minmax(0,1fr));
      gap:12px;
    }
    @media (max-width: 520px){
      .list{grid-template-columns:1fr}
    }
    .rCard{
      border:1px solid rgba(232,234,243,.95);
      background:rgba(255,255,255,.85);
      border-radius:18px;
      overflow:hidden;
      cursor:pointer;
      transition:transform .12s ease, box-shadow .12s ease;
    }
    .rCard:hover{
      transform: translateY(-1px);
      box-shadow: 0 16px 30px rgba(15,23,42,.10);
    }
    .thumb{
      height:120px;
      background:#f8fafc;
      border-bottom:1px solid rgba(232,234,243,.95);
      display:flex; align-items:center; justify-content:center;
      color:var(--muted);
      font-size:12px;
    }
    .thumb img{width:100%;height:100%;object-fit:cover;display:block}
    .rInfo{padding:10px 12px}
    .rTitle{font-weight:900;font-size:14px;margin:0 0 4px}
    .rMeta{margin:0;color:var(--muted);font-size:12px;line-height:1.4}
    .badge{
      display:inline-flex; align-items:center; gap:6px;
      padding:6px 10px;
      font-size:12px;
      border-radius:999px;
      border:1px solid rgba(232,234,243,.95);
      background:rgba(255,255,255,.75);
    }

    /* detail view */
    .detailTop{
      display:flex; align-items:center; justify-content:space-between; gap:10px; flex-wrap:wrap;
    }
    .detailTitle{
      display:flex; flex-direction:column; gap:2px;
    }
    .detailTitle b{font-size:16px}
    .split{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap:12px;
    }
    @media (max-width: 980px){
      .split{grid-template-columns:1fr}
    }
    .menuList{
      display:grid;
      grid-template-columns: repeat(2, minmax(0,1fr));
      gap:12px;
    }
    @media (max-width: 560px){
      .menuList{grid-template-columns:1fr}
    }
    .mCard{
      border:1px solid rgba(232,234,243,.95);
      background:rgba(255,255,255,.9);
      border-radius:18px;
      overflow:hidden;
    }
    .mHead{
      padding:10px 12px;
      border-bottom:1px solid rgba(232,234,243,.95);
      display:flex; align-items:center; justify-content:space-between; gap:10px;
      background:linear-gradient(90deg, rgba(99,102,241,.06), rgba(251,113,133,.06));
    }
    .mName{font-weight:900;font-size:14px}
    .mCat{font-size:12px;color:var(--muted)}
    .mBody{padding:10px 12px}
    .mLine{display:flex;justify-content:space-between;gap:10px;font-size:13px}
    .mDesc{margin:8px 0 0;color:var(--muted);font-size:12px;line-height:1.5}
    .empty{
      padding:14px 16px;
      border:1px dashed rgba(148,163,184,.6);
      border-radius:18px;
      color:var(--muted);
      background:rgba(255,255,255,.5);
      font-size:13px;
      line-height:1.6;
    }
    .toast{
      position:fixed; left:50%; bottom:18px; transform:translateX(-50%);
      background:rgba(15,23,42,.92);
      color:#fff;
      padding:10px 12px;
      border-radius:999px;
      font-size:13px;
      opacity:0; pointer-events:none;
      transition:opacity .18s ease, transform .18s ease;
    }
    .toast.show{
      opacity:1;
      transform:translateX(-50%) translateY(-4px);
    }
    .mutedSmall{font-size:12px;color:var(--muted)}
    .inline{
      display:flex; gap:10px; align-items:center; flex-wrap:wrap;
    }
    .inline input[type="checkbox"]{width:auto}
  </style>
</head>

<body>
<header>
  <div class="wrap">
    <div class="topbar">
      <div class="brand">
        <div class="logo"></div>
        <div>
          <h1>ç®¡ç†è€…å¾Œå°</h1>
          <div class="sub">é¤å»³ç®¡ç†ï¼ˆé»é¤å»³é€²å…¥é¤é»ç®¡ç†ï¼‰</div>
        </div>
      </div>
      <div class="pill">
        ç‹€æ…‹ï¼š<b id="saveState">å·²è¼‰å…¥</b>
        <span class="mutedSmall" id="counts">0 é¤å»³ / 0 é¤é»</span>
      </div>
    </div>
  </div>
</header>

<main class="wrap">
  <div class="grid">
    <!-- å·¦ï¼šæ–°å¢é¤å»³ -->
    <section class="card" id="createRestaurantCard">
      <div class="cardHead">
        <h2>æ–°å¢é¤å»³ï¼ˆåŒä¸€é ï¼Œä¸åˆ†ä¸Šä¸‹ï¼‰</h2>
        <span class="badge">Admin</span>
      </div>
      <div class="cardBody">
        <div class="hint">æ–°å¢å¾Œæœƒç«‹å³å¯«å…¥ç€è¦½å™¨å„²å­˜ï¼ˆlocalStorageï¼‰ï¼Œä¹‹å¾Œé€²é¤é»ç®¡ç†æ–°å¢çš„é¤é»ä¹Ÿæœƒä¸€èµ·è¨˜éŒ„ã€‚</div>

        <label>é¤å»³åç¨± *</label>
        <input id="rName" placeholder="ä¾‹ï¼šå‘·å¥”å˜ä¾¿ç•¶åº—" />

        <div class="row">
          <div>
            <label>é›»è©±</label>
            <input id="rPhone" placeholder="ä¾‹ï¼š04-1234-5678" />
          </div>
          <div>
            <label>åº—å®¶åœ–ç‰‡ï¼ˆURLï¼‰</label>
            <input id="rPhoto" placeholder="https://..." />
          </div>
        </div>

        <label>åœ°å€</label>
        <input id="rAddress" placeholder="ä¾‹ï¼šå°ä¸­å¸‚..." />

        <label>Google map é€£çµ</label>
        <input id="rMap" placeholder="https://maps.google.com/..." />

        <label>å‚™è¨»</label>
        <textarea id="rNote" placeholder="ä¾‹ï¼šé€±æ—¥å…¬ä¼‘ / å¤–é€é–€æª»..."></textarea>

        <div class="btns">
          <button class="btnPrimary" id="btnAddRestaurant">æ–°å¢é¤å»³</button>
          <button class="btnGhost" id="btnSeedDemo">å¡å…¥ç¤ºç¯„è³‡æ–™</button>
          <button class="btnDanger" id="btnResetAll">æ¸…ç©ºå…¨éƒ¨è³‡æ–™</button>
        </div>

        <div class="hint" style="margin-top:10px;">
          â€»ã€Œé¤é»ç®¡ç†ã€åœ¨å³å´ï¼šé»ä»»ä½•é¤å»³å¡ç‰‡é€²å…¥å¾Œï¼Œå°±èƒ½æ–°å¢é¤é»/é¤é»é¡åˆ¥ï¼Œä¸”ä¸€å®šæœƒè¨˜éŒ„ã€‚
        </div>
      </div>
    </section>

    <!-- å³ï¼šé¤å»³æ¸…å–® / é¤é»ç®¡ç† -->
    <section class="card" id="rightPanel">
      <div class="cardHead">
        <h2 id="rightTitle">é¤å»³ç®¡ç†ï¼ˆé»ä»»ä¸€é¤å»³é€²å…¥é¤é»ç®¡ç†ï¼‰</h2>
        <div class="inline">
          <button class="btnGhost" id="btnBack" style="display:none;">â† è¿”å›é¤å»³æ¸…å–®</button>
          <button class="btnOk" id="btnExport">åŒ¯å‡º JSON</button>
          <button class="btnGhost" id="btnImport">åŒ¯å…¥ JSON</button>
        </div>
      </div>

      <!-- åˆ—è¡¨è¦–åœ– -->
      <div class="cardBody" id="listView">
        <div class="hint" style="margin-bottom:10px;">é»å¡ç‰‡é€²å…¥é¤é»ç®¡ç†ï¼›å³ä¸Šå¯åŒ¯å‡º/åŒ¯å…¥ï¼Œæ–¹ä¾¿æ¬ç§»è³‡æ–™åˆ°åˆ¥å°é›»è…¦ã€‚</div>
        <div class="list" id="restaurantList"></div>
        <div id="emptyRestaurants" class="empty" style="display:none;margin-top:12px;">
          ç›®å‰æ²’æœ‰é¤å»³ã€‚<br/>
          è«‹å…ˆåœ¨å·¦å´æ–°å¢é¤å»³ï¼ˆé¤å»³åç¨±å¿…å¡«ï¼‰ã€‚
        </div>
      </div>

      <!-- è©³ç´°è¦–åœ–ï¼ˆé¤é»ç®¡ç†ï¼‰ -->
      <div class="cardBody" id="detailView" style="display:none;">
        <div class="detailTop">
          <div class="detailTitle">
            <b id="dName">â€”</b>
            <span class="mutedSmall" id="dMeta">â€”</span>
          </div>
          <div class="inline">
            <button class="btnDanger" id="btnDeleteRestaurant">åˆªé™¤æ­¤é¤å»³</button>
          </div>
        </div>

        <div style="height:12px"></div>

        <div class="split">
          <!-- æ–°å¢é¤é»é¡åˆ¥/é¤é» -->
          <div class="card" style="box-shadow:none">
            <div class="cardHead">
              <h2>é¤é»ç®¡ç†ï¼ˆæ–°å¢æœƒè‡ªå‹•è¨˜éŒ„ï¼‰</h2>
              <span class="badge" id="dMenuCount">0 é¤é»</span>
            </div>
            <div class="cardBody">
              <label>æ–°å¢é¤é»é¡åˆ¥ï¼ˆè¼¸å…¥ï¼‰</label>
              <div class="row">
                <input id="catInput" placeholder="ä¾‹ï¼šä¾¿ç•¶ / é£²æ–™ / å°èœ..." />
                <button class="btnPrimary" id="btnAddCat" style="flex:0 0 auto;min-width:110px;">æ–°å¢é¡åˆ¥</button>
              </div>

              <label style="margin-top:14px;">é¸æ“‡é¤é»é¡åˆ¥</label>
              <select id="dishCategory"></select>

              <label>é¤é»åç¨± *</label>
              <input id="dishName" placeholder="ä¾‹ï¼šæ‹›ç‰Œé›è…¿ä¾¿ç•¶" />

              <div class="row">
                <div>
                  <label>åƒ¹æ ¼</label>
                  <input id="dishPrice" type="number" min="0" step="1" placeholder="ä¾‹ï¼š100" />
                </div>
                <div>
                  <label>é¤é»åœ–ç‰‡ï¼ˆURLï¼‰</label>
                  <input id="dishPhoto" placeholder="https://..." />
                </div>
              </div>

              <label>é¤é»æè¿° / å‚™è¨»</label>
              <textarea id="dishDesc" placeholder="ä¾‹ï¼šå¯åŠ è¾£ / ä¸è¦è”¥..."></textarea>

              <div class="inline" style="margin-top:10px;">
                <input type="checkbox" id="dishEnabled" checked />
                <label for="dishEnabled" style="margin:0;color:var(--text);font-size:13px;">æ­¤é¤é»å¯è²©å”®ï¼ˆé¡¯ç¤ºåœ¨ä½¿ç”¨è€…ç«¯ï¼‰</label>
              </div>

              <div class="btns">
                <button class="btnPrimary" id="btnAddDish">æ–°å¢é¤é»</button>
                <button class="btnGhost" id="btnClearDish">æ¸…ç©ºè¼¸å…¥</button>
              </div>

              <div class="hint" style="margin-top:10px;">
                â€» ä½ å‰›å‰›èªªã€ŒAdmin ä¸æœƒè¨˜éŒ„åˆ°æˆ‘æ–°å¢çš„é¤é»ã€ï¼šé€™ç‰ˆæ¯æ¬¡æ–°å¢/åˆªé™¤é¤é»èˆ‡é¡åˆ¥éƒ½æœƒç«‹åˆ» <b>save()</b> åˆ° localStorageï¼Œé‡æ–°æ•´ç†ä¹Ÿä¸æœƒä¸è¦‹ã€‚
              </div>
            </div>
          </div>

          <!-- é¤é»æ¸…å–® -->
          <div class="card" style="box-shadow:none">
            <div class="cardHead">
              <h2>æ­¤é¤å»³çš„é¤é»æ¸…å–®</h2>
              <span class="badge" id="dCatCount">0 é¡åˆ¥</span>
            </div>
            <div class="cardBody">
              <div id="emptyMenu" class="empty" style="display:none;">
                é€™é–“é¤å»³ç›®å‰æ²’æœ‰é¤é»ã€‚<br/>
                è«‹åœ¨å·¦å´ã€Œé¤é»ç®¡ç†ã€æ–°å¢é¤é»ã€‚
              </div>
              <div class="menuList" id="menuList"></div>
            </div>
          </div>
        </div>
      </div>
    </section>
  </div>
</main>

<div class="toast" id="toast">å·²å„²å­˜</div>

<script>
  /***********************
   * è³‡æ–™çµæ§‹ï¼ˆæœƒå­˜é€² localStorageï¼‰
   ***********************/
  const STORE_KEY = "jabenlo_admin_data_v1";

  const uid = () => Math.random().toString(36).slice(2, 10) + Date.now().toString(36);

  function defaultData(){
    return { restaurants: [] };
  }

  function load(){
    try{
      const raw = localStorage.getItem(STORE_KEY);
      if(!raw) return defaultData();
      const data = JSON.parse(raw);

      // é˜²å‘†è£œæ¬„ä½ï¼ˆé¿å…èˆŠç‰ˆè³‡æ–™ç¼ºæ¬„ï¼‰
      data.restaurants = Array.isArray(data.restaurants) ? data.restaurants : [];
      data.restaurants.forEach(r=>{
        r.id = r.id || uid();
        r.name = r.name || "";
        r.phone = r.phone || "";
        r.address = r.address || "";
        r.map = r.map || "";
        r.photo = r.photo || "";
        r.note = r.note || "";
        r.categories = Array.isArray(r.categories) ? r.categories : []; // é¡åˆ¥æ¸…å–®
        r.menu = Array.isArray(r.menu) ? r.menu : []; // é¤é»æ¸…å–®
      });
      return data;
    }catch(e){
      console.error(e);
      return defaultData();
    }
  }

  function save(){
    localStorage.setItem(STORE_KEY, JSON.stringify(state.data));
    setSaveState("å·²å„²å­˜");
    toast("å·²å„²å­˜");
    refreshCounts();
  }

  function setSaveState(txt){
    document.getElementById("saveState").textContent = txt;
  }

  function toast(msg){
    const el = document.getElementById("toast");
    el.textContent = msg;
    el.classList.add("show");
    clearTimeout(state.toastTimer);
    state.toastTimer = setTimeout(()=> el.classList.remove("show"), 1200);
  }

  const state = {
    data: load(),
    selectedRestaurantId: null,
    toastTimer: null
  };

  /***********************
   * DOM
   ***********************/
  const $ = (id) => document.getElementById(id);

  const listView = $("listView");
  const detailView = $("detailView");
  const btnBack = $("btnBack");
  const rightTitle = $("rightTitle");

  function refreshCounts(){
    const rCount = state.data.restaurants.length;
    const mCount = state.data.restaurants.reduce((acc,r)=> acc + (r.menu?.length || 0), 0);
    $("counts").textContent = `${rCount} é¤å»³ / ${mCount} é¤é»`;
  }

  /***********************
   * é¤å»³åˆ—è¡¨æ¸²æŸ“
   ***********************/
  function renderRestaurants(){
    const list = $("restaurantList");
    list.innerHTML = "";

    const restaurants = state.data.restaurants;

    $("emptyRestaurants").style.display = restaurants.length ? "none" : "block";

    restaurants.forEach(r=>{
      const card = document.createElement("div");
      card.className = "rCard";
      card.onclick = () => openRestaurant(r.id);

      const thumb = document.createElement("div");
      thumb.className = "thumb";
      if(r.photo){
        const img = document.createElement("img");
        img.src = r.photo;
        img.alt = r.name;
        img.onerror = () => { thumb.innerHTML = "åœ–ç‰‡è¼‰å…¥å¤±æ•—"; };
        thumb.appendChild(img);
      }else{
        thumb.textContent = "å°šæœªè¨­å®šåº—å®¶åœ–ç‰‡";
      }

      const info = document.createElement("div");
      info.className = "rInfo";

      const title = document.createElement("p");
      title.className = "rTitle";
      title.textContent = r.name || "(æœªå‘½å)";

      const meta = document.createElement("p");
      meta.className = "rMeta";
      const phone = r.phone ? `â˜ ${r.phone}` : "";
      const addr = r.address ? `ğŸ“ ${r.address}` : "";
      const menuN = `ğŸ± ${r.menu?.length || 0} é¤é»`;
      meta.textContent = [phone, addr, menuN].filter(Boolean).join("  Â·  ");

      info.appendChild(title);
      info.appendChild(meta);

      card.appendChild(thumb);
      card.appendChild(info);

      list.appendChild(card);
    });

    refreshCounts();
  }

  /***********************
   * æ–°å¢é¤å»³
   ***********************/
  $("btnAddRestaurant").addEventListener("click", ()=>{
    const name = $("rName").value.trim();
    if(!name){
      toast("è«‹è¼¸å…¥é¤å»³åç¨±");
      $("rName").focus();
      return;
    }

    const r = {
      id: uid(),
      name,
      phone: $("rPhone").value.trim(),
      address: $("rAddress").value.trim(),
      map: $("rMap").value.trim(),
      photo: $("rPhoto").value.trim(),
      note: $("rNote").value.trim(),
      categories: [],   // é¡åˆ¥ï¼ˆè¼¸å…¥æ–°å¢ï¼‰
      menu: []          // é¤é»
    };

    state.data.restaurants.unshift(r);
    save();
    clearRestaurantForm();
    renderRestaurants();
  });

  function clearRestaurantForm(){
    $("rName").value = "";
    $("rPhone").value = "";
    $("rAddress").value = "";
    $("rMap").value = "";
    $("rPhoto").value = "";
    $("rNote").value = "";
  }

  /***********************
   * é€²å…¥é¤é»ç®¡ç†ï¼ˆé»é¤å»³ï¼‰
   ***********************/
  function openRestaurant(id){
    state.selectedRestaurantId = id;
    const r = getSelectedRestaurant();
    if(!r) return;

    // é¡¯ç¤º detail view
    listView.style.display = "none";
    detailView.style.display = "block";
    btnBack.style.display = "inline-flex";
    rightTitle.textContent = "é¤é»ç®¡ç†ï¼ˆé»è¿”å›å›é¤å»³æ¸…å–®ï¼‰";

    // å¡«æ¨™é¡Œ
    $("dName").textContent = r.name;
    $("dMeta").textContent = [
      r.phone ? `â˜ ${r.phone}` : "",
      r.address ? `ğŸ“ ${r.address}` : "",
      r.map ? `ğŸ—º å·²æœ‰åœ°åœ–é€£çµ` : ""
    ].filter(Boolean).join("  Â·  ") || "â€”";

    // é¡åˆ¥ä¸‹æ‹‰
    ensureDefaultCategories(r);
    renderCategorySelect();
    renderMenuList();
    refreshBadges();
    refreshCounts();
  }

  function closeRestaurant(){
    state.selectedRestaurantId = null;
    listView.style.display = "block";
    detailView.style.display = "none";
    btnBack.style.display = "none";
    rightTitle.textContent = "é¤å»³ç®¡ç†ï¼ˆé»ä»»ä¸€é¤å»³é€²å…¥é¤é»ç®¡ç†ï¼‰";
    renderRestaurants();
  }

  btnBack.addEventListener("click", closeRestaurant);

  function getSelectedRestaurant(){
    return state.data.restaurants.find(x=> x.id === state.selectedRestaurantId);
  }

  function ensureDefaultCategories(r){
    // è‹¥å®Œå…¨æ²’æœ‰é¡åˆ¥ï¼Œå…ˆæ”¾ä¸€å€‹ã€Œæœªåˆ†é¡ã€
    if(!Array.isArray(r.categories)) r.categories = [];
    if(r.categories.length === 0){
      r.categories.push("æœªåˆ†é¡");
      save(); // é€™ä¹Ÿè¦è¨˜éŒ„
    }
  }

  function refreshBadges(){
    const r = getSelectedRestaurant();
    if(!r) return;
    $("dMenuCount").textContent = `${r.menu.length} é¤é»`;
    $("dCatCount").textContent = `${r.categories.length} é¡åˆ¥`;
  }

  /***********************
   * æ–°å¢é¤é»é¡åˆ¥
   ***********************/
  $("btnAddCat").addEventListener("click", ()=>{
    const r = getSelectedRestaurant();
    if(!r) return;

    const cat = $("catInput").value.trim();
    if(!cat){
      toast("è«‹è¼¸å…¥é¡åˆ¥åç¨±");
      $("catInput").focus();
      return;
    }
    if(r.categories.includes(cat)){
      toast("æ­¤é¡åˆ¥å·²å­˜åœ¨");
      return;
    }
    r.categories.push(cat);
    $("catInput").value = "";
    save();
    renderCategorySelect(cat);
    refreshBadges();
  });

  function renderCategorySelect(selectValue){
    const r = getSelectedRestaurant();
    if(!r) return;

    const sel = $("dishCategory");
    sel.innerHTML = "";

    r.categories.forEach(cat=>{
      const opt = document.createElement("option");
      opt.value = cat;
      opt.textContent = cat;
      sel.appendChild(opt);
    });

    if(selectValue && r.categories.includes(selectValue)){
      sel.value = selectValue;
    }
  }

  /***********************
   * æ–°å¢é¤é»ï¼ˆé‡é»ï¼šä¸€å®šè¦å­˜ï¼‰
   ***********************/
  $("btnAddDish").addEventListener("click", ()=>{
    const r = getSelectedRestaurant();
    if(!r) return;

    const name = $("dishName").value.trim();
    if(!name){
      toast("è«‹è¼¸å…¥é¤é»åç¨±");
      $("dishName").focus();
      return;
    }

    const dish = {
      id: uid(),
      category: $("dishCategory").value || "æœªåˆ†é¡",
      name,
      price: Number($("dishPrice").value || 0),
      photo: $("dishPhoto").value.trim(),
      desc: $("dishDesc").value.trim(),
      enabled: $("dishEnabled").checked
    };

    r.menu.unshift(dish);

    // âœ… é€™è£¡æ˜¯ä½ é‡åˆ°çš„å•é¡Œæ ¸å¿ƒï¼šæ–°å¢å¾Œç«‹åˆ» save()
    save();

    clearDishForm(false);
    renderMenuList();
    refreshBadges();
  });

  $("btnClearDish").addEventListener("click", ()=> clearDishForm(true));

  function clearDishForm(clearCategory){
    $("dishName").value = "";
    $("dishPrice").value = "";
    $("dishPhoto").value = "";
    $("dishDesc").value = "";
    $("dishEnabled").checked = true;
    if(clearCategory){
      $("dishCategory").selectedIndex = 0;
    }
  }

  /***********************
   * é¤é»æ¸…å–®ï¼ˆå«åˆªé™¤/ä¸Šä¸‹æ¶ï¼‰
   ***********************/
  function renderMenuList(){
    const r = getSelectedRestaurant();
    if(!r) return;

    const box = $("menuList");
    box.innerHTML = "";

    $("emptyMenu").style.display = r.menu.length ? "none" : "block";

    r.menu.forEach(d=>{
      const card = document.createElement("div");
      card.className = "mCard";

      const head = document.createElement("div");
      head.className = "mHead";

      const left = document.createElement("div");
      left.style.display = "flex";
      left.style.flexDirection = "column";

      const name = document.createElement("div");
      name.className = "mName";
      name.textContent = d.name;

      const cat = document.createElement("div");
      cat.className = "mCat";
      cat.textContent = `${d.category || "æœªåˆ†é¡"} Â· ${d.enabled ? "ä¸Šæ¶ä¸­" : "å·²ä¸‹æ¶"}`;

      left.appendChild(name);
      left.appendChild(cat);

      const actions = document.createElement("div");
      actions.className = "inline";

      const toggleBtn = document.createElement("button");
      toggleBtn.className = d.enabled ? "btnGhost" : "btnOk";
      toggleBtn.style.padding = "8px 10px";
      toggleBtn.textContent = d.enabled ? "ä¸‹æ¶" : "ä¸Šæ¶";
      toggleBtn.onclick = (ev)=>{
        ev.stopPropagation();
        d.enabled = !d.enabled;
        save();
        renderMenuList();
        refreshBadges();
      };

      const delBtn = document.createElement("button");
      delBtn.className = "btnDanger";
      delBtn.style.padding = "8px 10px";
      delBtn.textContent = "åˆªé™¤";
      delBtn.onclick = (ev)=>{
        ev.stopPropagation();
        const ok = confirm(`ç¢ºå®šåˆªé™¤é¤é»ã€Œ${d.name}ã€ï¼Ÿ`);
        if(!ok) return;
        r.menu = r.menu.filter(x=> x.id !== d.id);
        save();
        renderMenuList();
        refreshBadges();
      };

      actions.appendChild(toggleBtn);
      actions.appendChild(delBtn);

      head.appendChild(left);
      head.appendChild(actions);

      const body = document.createElement("div");
      body.className = "mBody";

      const line1 = document.createElement("div");
      line1.className = "mLine";
      const p = document.createElement("div");
      p.textContent = `åƒ¹æ ¼ï¼š$${Number(d.price||0)}`;
      const hasPhoto = document.createElement("div");
      hasPhoto.textContent = d.photo ? "ğŸ–¼ æœ‰åœ–ç‰‡" : "ğŸ–¼ ç„¡åœ–ç‰‡";
      hasPhoto.style.color = "var(--muted)";
      line1.appendChild(p);
      line1.appendChild(hasPhoto);

      const desc = document.createElement("div");
      desc.className = "mDesc";
      desc.textContent = d.desc || "ï¼ˆç„¡æè¿°ï¼‰";

      body.appendChild(line1);
      body.appendChild(desc);

      card.appendChild(head);
      card.appendChild(body);

      box.appendChild(card);
    });
  }

  /***********************
   * åˆªé™¤é¤å»³
   ***********************/
  $("btnDeleteRestaurant").addEventListener("click", ()=>{
    const r = getSelectedRestaurant();
    if(!r) return;
    const ok = confirm(`ç¢ºå®šåˆªé™¤é¤å»³ã€Œ${r.name}ã€ï¼Ÿï¼ˆé¤é»ä¹Ÿæœƒä¸€èµ·åˆªé™¤ï¼‰`);
    if(!ok) return;

    state.data.restaurants = state.data.restaurants.filter(x=> x.id !== r.id);
    save();
    closeRestaurant();
  });

  /***********************
   * åŒ¯å‡º / åŒ¯å…¥
   ***********************/
  $("btnExport").addEventListener("click", ()=>{
    const dataStr = JSON.stringify(state.data, null, 2);
    navigator.clipboard?.writeText(dataStr).then(()=>{
      toast("å·²è¤‡è£½ JSON åˆ°å‰ªè²¼ç°¿");
    }).catch(()=>{
      // é€€è€Œæ±‚å…¶æ¬¡ï¼šè·³å‡º prompt
      prompt("è¤‡è£½ä¸‹é¢ JSONï¼š", dataStr);
    });
  });

  $("btnImport").addEventListener("click", ()=>{
    const raw = prompt("è²¼ä¸Š JSON ä»¥åŒ¯å…¥ï¼ˆæœƒè¦†è“‹ç›®å‰è³‡æ–™ï¼‰ï¼š");
    if(!raw) return;
    try{
      const incoming = JSON.parse(raw);
      if(!incoming || !Array.isArray(incoming.restaurants)) throw new Error("æ ¼å¼ä¸æ­£ç¢º");
      state.data = incoming;
      // é€²è¡Œè£œæ¬„ä½
      state.data = loadFromObject(state.data);
      localStorage.setItem(STORE_KEY, JSON.stringify(state.data));
      toast("åŒ¯å…¥æˆåŠŸ");
      closeRestaurant();
      renderRestaurants();
      refreshCounts();
    }catch(e){
      alert("åŒ¯å…¥å¤±æ•—ï¼šJSON æ ¼å¼ä¸æ­£ç¢º");
    }
  });

  function loadFromObject(obj){
    const data = obj || defaultData();
    data.restaurants = Array.isArray(data.restaurants) ? data.restaurants : [];
    data.restaurants.forEach(r=>{
      r.id = r.id || uid();
      r.name = r.name || "";
      r.phone = r.phone || "";
      r.address = r.address || "";
      r.map = r.map || "";
      r.photo = r.photo || "";
      r.note = r.note || "";
      r.categories = Array.isArray(r.categories) ? r.categories : [];
      r.menu = Array.isArray(r.menu) ? r.menu : [];
      r.menu.forEach(d=>{
        d.id = d.id || uid();
        d.category = d.category || "æœªåˆ†é¡";
        d.name = d.name || "";
        d.price = Number(d.price || 0);
        d.photo = d.photo || "";
        d.desc = d.desc || "";
        d.enabled = (d.enabled === false) ? false : true;
      });
    });
    return data;
  }

  /***********************
   * ç¤ºç¯„è³‡æ–™ / æ¸…ç©º
   ***********************/
  $("btnSeedDemo").addEventListener("click", ()=>{
    const demo = {
      restaurants: [
        {
          id: uid(),
          name:"å‘·å¥”å˜ä¾¿ç•¶åº—",
          phone:"04-1234-5678",
          address:"å°ä¸­å¸‚è¥¿å€ç¾æ‘è·¯ä¸€æ®µ 1 è™Ÿ",
          map:"",
          photo:"",
          note:"é€±æ—¥å…¬ä¼‘",
          categories:["ä¾¿ç•¶","å–®é»","é£²æ–™"],
          menu:[
            { id: uid(), category:"ä¾¿ç•¶", name:"æ‹›ç‰Œé›è…¿ä¾¿ç•¶", price:110, photo:"", desc:"å¯é¸é£¯å¤š/é£¯å°‘", enabled:true },
            { id: uid(), category:"ä¾¿ç•¶", name:"æ»·æ’éª¨ä¾¿ç•¶", price:95, photo:"", desc:"ä¸è¦èœå¯å‚™è¨»", enabled:true },
            { id: uid(), category:"é£²æ–™", name:"ç´…èŒ¶", price:20, photo:"", desc:"å†°/ç†±", enabled:true }
          ]
        }
      ]
    };
    state.data = demo;
    localStorage.setItem(STORE_KEY, JSON.stringify(state.data));
    toast("å·²å¡å…¥ç¤ºç¯„è³‡æ–™");
    closeRestaurant();
    renderRestaurants();
    refreshCounts();
  });

  $("btnResetAll").addEventListener("click", ()=>{
    const ok = confirm("ç¢ºå®šæ¸…ç©ºå…¨éƒ¨è³‡æ–™ï¼Ÿï¼ˆä¸å¯å¾©åŸï¼‰");
    if(!ok) return;
    state.data = defaultData();
    localStorage.removeItem(STORE_KEY);
    toast("å·²æ¸…ç©º");
    closeRestaurant();
    renderRestaurants();
    refreshCounts();
  });

  /***********************
   * åˆå§‹åŒ–
   ***********************/
  setSaveState("å·²è¼‰å…¥");
  renderRestaurants();
  refreshCounts();
</script>
</body>
</html>
