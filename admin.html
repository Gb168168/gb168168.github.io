<!doctype html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>GoldBricks å‘·å¥”ğŸ‘½~ï½œç®¡ç†è€…</title>

  <!-- é¡åˆ¥æ‹–æ›³ -->
  <script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.2/Sortable.min.js"></script>

  <!-- Excel -->
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>

  <style>
    :root{
      --bg:#f5f4fb; --card:#fff; --text:#0f172a; --muted:#64748b;
      --primary:#fb7185; --primary2:#ff9a9e; --border:rgba(15,23,42,.10);
      --shadow:0 10px 30px rgba(15,23,42,.10);
      --radius:18px;
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      font-family: ui-sans-serif, system-ui, -apple-system, "Segoe UI", Arial;
      background: var(--bg);
      color:var(--text);
      min-height:100vh;
    }
    .layout{display:grid; grid-template-columns:300px 1fr; gap:16px; padding:16px}
    @media(max-width:980px){.layout{grid-template-columns:1fr}}
    .sidebar,.main{
      background:#fff;
      border:1px solid var(--border);
      border-radius:var(--radius);
      box-shadow:var(--shadow);
    }
    .sidebar{padding:14px}
    .nav button{width:100%; margin-bottom:8px; padding:10px; border-radius:14px; border:1px solid var(--border); background:#fff; cursor:pointer; font-weight:800}
    .nav button.active{background:linear-gradient(90deg,#fb718533,#ff9a9e22)}
    .main{padding:14px}
    .topbar{display:flex; justify-content:space-between; align-items:center}
    .card{border:1px solid var(--border); border-radius:16px; padding:14px; margin-bottom:14px}
    table{width:100%; border-collapse:collapse; font-size:13px}
    th,td{border-bottom:1px solid #e5e7eb; padding:8px}
    th{color:var(--muted)}
    .tag{padding:4px 10px; border-radius:999px; border:1px solid var(--border); font-size:12px}
    .muted{color:var(--muted)}
    button{cursor:pointer}
  </style>
</head>

<body>
<div class="layout">
  <aside class="sidebar">
    <h3>ç®¡ç†è€…å¾Œå°</h3>
    <div class="nav">
      <button class="navBtn active" data-view="orders">è¨‚é¤ç´€éŒ„</button>
    </div>
  </aside>

  <main class="main">
    <div class="topbar">
      <h2>è¨‚é¤ç´€éŒ„ï¼ˆå½™æ•´è¼¸å‡ºï¼‰</h2>
      <span id="statusPill" class="tag">å·²é€£ç·š</span>
    </div>

    <section id="view_orders">
      <div class="card">
        <label>è¨‚å–®æ—¥æœŸ</label>
        <input id="o_date" type="date"/>
        <div style="margin-top:10px">
          <button id="btnLoadOrders">è¼‰å…¥</button>
          <button id="btnExportExcel">åŒ¯å‡º Excel</button>
        </div>
      </div>

      <div class="card">
        <div id="ordersOut" class="muted">è«‹é¸æ—¥æœŸå¾Œè¼‰å…¥</div>
      </div>
    </section>
  </main>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-app.js";
import { getFirestore, collection, getDocs, query, where } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-firestore.js";

const firebaseConfig = {
  apiKey: "AIzaSyBdgOddTGAfqqHLnhnaJRv2_y7gyweuQEo",
  authDomain: "goldbricks-order.firebaseapp.com",
  projectId: "goldbricks-order"
};

const app = initializeApp(firebaseConfig);
const db = getFirestore(app);

const $ = id=>document.getElementById(id);
const esc = s=>(s??"").toString().replaceAll("&","&amp;").replaceAll("<","&lt;").replaceAll(">","&gt;");

const colOrders = collection(db,"orders");

function addonText(addons){
  const arr = Array.isArray(addons)?addons:[];
  return arr.map(a=>`+${a.name}${a.price?` ${a.price}`:""}`).join(" ");
}
function addonUnitSum(addons){
  return (Array.isArray(addons)?addons:[]).reduce((s,a)=>s+Number(a.price||0),0);
}

/* âœ… é¤é»å‚™è¨»ï¼ˆæ”¯æ´å¤šç¨®å‘½åï¼‰ */
function itemNoteText(it){
  return (it?.note ?? it?.remark ?? it?.itemNote ?? it?.memo ?? "").toString().trim();
}

async function loadOrdersByDate(date){
  const snap = await getDocs(query(colOrders, where("orderDate","==",date)));
  const arr=[];
  snap.forEach(d=>arr.push(d.data()));
  return arr;
}

/* âœ… å½™æ•´é¡¯ç¤ºï¼ˆå«é¤é»å‚™è¨»ï¼‰ */
function renderOrdersSummary(orders){
  const map=new Map();
  let totalAll=0;

  for(const o of orders){
    const items=o.items||[];
    for(const it of items){
      const unit=Number(it.price||0);
      const addons=it.addons||[];
      const note=itemNoteText(it);
      const key=`${o.restaurantName}__${it.name}__${unit}__${addonText(addons)}__${note}`;
      if(!map.has(key)){
        map.set(key,{
          restaurant:o.restaurantName||"",
          item:it.name||"",
          addons:addons,
          note,
          unit,
          qty:0
        });
      }
      map.get(key).qty+=Number(it.qty||0);
      totalAll+=(unit+addonUnitSum(addons))*Number(it.qty||0);
    }
  }

  const rows=[...map.values()].map(x=>{
    const addonAmt=addonUnitSum(x.addons)*x.qty;
    const itemAmt=x.unit*x.qty;
    const sum=(x.unit+addonUnitSum(x.addons))*x.qty;
    return `
      <tr>
        <td>${esc(x.restaurant)}</td>
        <td>${esc(x.item)}</td>
        <td>${esc(addonText(x.addons))}</td>
        <td class="muted">${esc(x.note)}</td>
        <td>${x.qty}</td>
        <td>${x.unit}</td>
        <td>${addonAmt}</td>
        <td>${itemAmt}</td>
        <td>${sum}</td>
      </tr>`;
  }).join("");

  return `
    <div class="tag">è¨‚å–®ç¸½é‡‘é¡ï¼š${totalAll}</div>
    <table>
      <thead>
        <tr>
          <th>é¤å»³</th><th>å“é …</th><th>åŠ è³¼/æ“‡ä¸€</th>
          <th>é¤é»å‚™è¨»</th>
          <th>æ•¸é‡</th><th>å–®åƒ¹</th>
          <th>åŠ è³¼é‡‘é¡</th><th>å“é …é‡‘é¡</th><th>å°è¨ˆ</th>
        </tr>
      </thead>
      <tbody>${rows||"<tr><td colspan='9'>ç„¡è³‡æ–™</td></tr>"}</tbody>
    </table>`;
}

$("btnLoadOrders").onclick=async()=>{
  const date=$("o_date").value;
  if(!date) return alert("è«‹é¸æ—¥æœŸ");
  const orders=await loadOrdersByDate(date);
  $("ordersOut").innerHTML=orders.length?renderOrdersSummary(orders):"æ­¤æ—¥æœŸæ²’æœ‰è¨‚å–®";
};

/* âœ… Excel åŒ¯å‡ºï¼ˆå«é¤é»å‚™è¨»ï¼‰ */
$("btnExportExcel").onclick=async()=>{
  const date=$("o_date").value;
  if(!date) return alert("è«‹é¸æ—¥æœŸ");
  const orders=await loadOrdersByDate(date);
  if(!orders.length) return alert("ç„¡è¨‚å–®");

  const rows=[];
  for(const o of orders){
    for(const it of (o.items||[])){
      rows.push({
        "éƒ¨é–€":o.userDept||"",
        "å§“å":o.userName||"",
        "é¤å»³":o.restaurantName||"",
        "å“é …":it.name||"",
        "åŠ è³¼/æ“‡ä¸€":addonText(it.addons),
        "é¤é»å‚™è¨»":itemNoteText(it),
        "æ•¸é‡":it.qty||0,
        "å–®åƒ¹":it.price||0,
        "åŠ è³¼é‡‘é¡":addonUnitSum(it.addons)*(it.qty||0),
        "å“é …é‡‘é¡":Number(it.price||0)*(it.qty||0),
        "è¨‚å–®ç¸½é¡":o.total||0
      });
    }
  }

  const ws=XLSX.utils.json_to_sheet(rows);
  const wb=XLSX.utils.book_new();
  XLSX.utils.book_append_sheet(wb,ws,"Orders");
  XLSX.writeFile(wb,`GoldBricks_Orders_${date}.xlsx`);
};
</script>
</body>
</html>
