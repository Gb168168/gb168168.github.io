<!doctype html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>GoldBricks å‘·å¥”ğŸ‘½ï½œç®¡ç†1</title>

  <!-- âœ… é¡åˆ¥æ‹–æ›³æ’åºç”¨ -->
  <script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.2/Sortable.min.js"></script>

  <style>
    :root{
      --bg:#f5f4fb; --card:#fff; --text:#0f172a; --muted:#64748b;
      --primary:#fb7185; --primary2:#ff9a9e; --border:rgba(15,23,42,.10);
      --shadow:0 10px 30px rgba(15,23,42,.10);
      --radius:18px;
    }
    *{box-sizing:border-box}
    body{
      margin:0; font-family: ui-sans-serif, system-ui, -apple-system, "Segoe UI", Arial;
      background: radial-gradient(1200px 500px at 20% -10%, rgba(251,113,133,.22), transparent 60%),
                  radial-gradient(900px 500px at 100% 0%, rgba(255,154,158,.14), transparent 55%),
                  var(--bg);
      color:var(--text);
      min-height:100vh;
    }
    .layout{display:grid; grid-template-columns: 300px 1fr; gap:16px; padding:16px;}
    @media (max-width:980px){.layout{grid-template-columns:1fr}}
    .sidebar,.main{
      background: rgba(255,255,255,.78);
      border:1px solid var(--border);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      backdrop-filter: blur(10px);
    }
    .sidebar{padding:14px; position:sticky; top:16px; height: fit-content}
    .brand{display:flex; align-items:center; justify-content:space-between; gap:10px; padding:10px 10px 6px;}
    .brand h1{font-size:16px; margin:0}
    .brand small{color:var(--muted)}
    .nav{margin-top:10px; display:flex; flex-direction:column; gap:8px}
    .nav button{
      text-align:left; padding:11px 12px; border-radius:14px;
      border:1px solid var(--border); background:#fff; cursor:pointer;
      font-weight:800;
    }
    .nav button.active{
      border-color: rgba(251,113,133,.55);
      background: linear-gradient(90deg, rgba(251,113,133,.18), rgba(255,154,158,.10));
      box-shadow: 0 10px 22px rgba(251,113,133,.18);
    }

    .main{padding:14px}
    .topbar{display:flex; align-items:center; justify-content:space-between; gap:12px; padding:6px 6px 12px;}
    .topbar h2{margin:0; font-size:18px}
    .topbar .right{display:flex; gap:10px; align-items:center; flex-wrap:wrap}
    .pill{padding:8px 12px; border-radius:999px; border:1px solid var(--border); background:#fff; color:var(--muted); font-size:12.5px}
    .ghost{
      padding:9px 12px; border-radius:14px; border:1px solid var(--border);
      background:#fff; cursor:pointer; font-weight:800;
    }
    .primary{
      padding:9px 12px; border-radius:14px; border:none; cursor:pointer; font-weight:900;
      background: linear-gradient(90deg, var(--primary), var(--primary2));
      color:#fff; box-shadow: 0 14px 28px rgba(251,113,133,.22);
    }

    .grid{display:grid; grid-template-columns: 1fr 1fr; gap:14px}
    @media (max-width:980px){.grid{grid-template-columns:1fr}}

    /* âœ… è¨‚é¤ç´€éŒ„ï¼šå·¦å°å³å¤§ï¼ˆåªå½±éŸ¿ view_ordersï¼‰ */
    #view_orders .grid{ grid-template-columns: 360px 1fr; }
    @media (max-width:980px){ #view_orders .grid{ grid-template-columns: 1fr; } }

    .card{
      background:#fff; border:1px solid var(--border); border-radius:var(--radius);
      box-shadow: 0 8px 25px rgba(15,23,42,.07);
      padding:14px;
    }
    .card h3{margin:0 0 10px; font-size:15px}
    label{display:block; font-size:13px; color:var(--muted); margin:10px 0 6px;}
    input,select,textarea{
      width:100%; padding:11px 12px; border-radius:14px;
      border:1px solid var(--border); outline:none; background:#fff;
      font-size:14px;
    }
    textarea{min-height:92px; resize:vertical}
    input:focus,select:focus,textarea:focus{border-color: rgba(251,113,133,.7)}
    .row{display:grid; grid-template-columns: 1fr 1fr; gap:10px}
    .row3{display:grid; grid-template-columns: 1fr 1fr 1fr; gap:10px}
    .actions{display:flex; gap:10px; margin-top:12px; flex-wrap:wrap}
    .muted{color:var(--muted); font-size:12.5px; line-height:1.6}
    .hr{height:1px; background: var(--border); margin:12px 0}
    table{width:100%; border-collapse:collapse; font-size:13.5px}
    th,td{border-bottom:1px solid rgba(15,23,42,.08); padding:10px 8px; text-align:left; vertical-align:top}
    th{color:var(--muted); font-weight:900}
    .tag{display:inline-flex; align-items:center; gap:8px; padding:5px 10px; border-radius:999px; border:1px solid var(--border); background:#fff; color:var(--muted); font-size:12px}
    .btnSmall{
      padding:7px 10px; border-radius:12px; border:1px solid var(--border);
      background:#fff; cursor:pointer; font-weight:800; font-size:12.5px;
      white-space:nowrap;
    }
    .btnDanger{border-color: rgba(239,68,68,.35)}
    .btnDanger:hover{border-color: rgba(239,68,68,.60)}
    .btnOk:hover{border-color: rgba(16,185,129,.55)}
    details summary{cursor:pointer; font-weight:900}
    .inline{display:flex; gap:10px; align-items:center; flex-wrap:wrap}
    .imgPrev{width:100%; max-height:220px; object-fit:cover; border-radius:14px; border:1px solid var(--border)}
    .qrPrev{width:100%; max-height:220px; object-fit:contain; border-radius:14px; border:1px solid var(--border); background:rgba(15,23,42,.02)}
    .subcard{
      background: rgba(15,23,42,.02);
      border:1px dashed rgba(15,23,42,.18);
      border-radius:16px;
      padding:12px;
    }
    .kpi{display:flex; gap:10px; flex-wrap:wrap; margin-top:8px}
    .kpi .tag{font-weight:900}

    .stateGood{border-color: rgba(16,185,129,.35); color:#065f46; background:rgba(16,185,129,.08)}
    .stateBad{border-color: rgba(239,68,68,.35); color:#7f1d1d; background:rgba(239,68,68,.06)}

    .chkline{display:flex; align-items:center; gap:10px; flex-wrap:wrap}
    .chkline input[type="checkbox"]{width:18px; height:18px; margin:0}

    .mini{font-size:12px}
    .optBox{border:1px solid rgba(15,23,42,.10); border-radius:16px; padding:10px 12px; background:#fff}
    .optRow{display:grid; grid-template-columns: 1fr 140px 120px; gap:10px}
    @media (max-width:980px){.optRow{grid-template-columns:1fr}}

    /* STEP1ï¼šè¨‚é¤ç´€éŒ„-ä¸Šæ–¹æ©«æ¢ */
    #view_orders .ordersTopBar{
      display:flex;
      align-items:flex-end;
      justify-content:space-between;
      gap:12px;
      flex-wrap:wrap;
    }
    #view_orders .ordersTopBar .leftCtl{
      display:flex;
      gap:12px;
      align-items:flex-end;
      flex-wrap:wrap;
    }
    #view_orders .ordersTopBar .dateBox{
      min-width:260px;
    }
    @media (max-width:980px){
      #view_orders .ordersTopBar .dateBox{ min-width:100%; }
    }

    /* ğŸ”” æœªé»é¤æé†’æ¢ */
    .alertBar{
      margin-top:8px;
      padding:8px 10px;
      border-radius:12px;
      font-size:13px;
      line-height:1.5;
    }
    .alertWarn{
      background:rgba(248,113,113,.06);
      border:1px solid rgba(248,113,113,.45);
      color:#7f1d1d;
    }
    .alertOk{
      background:rgba(16,185,129,.06);
      border:1px solid rgba(16,185,129,.45);
      color:#064e3b;
    }

    /* ğŸ”” æœªé»é¤å½ˆè·³è¦–çª— */
    .modalMask{
      position:fixed;
      inset:0;
      background:rgba(15,23,42,.35);
      display:flex;
      align-items:center;
      justify-content:center;
      z-index:50;
    }
    .modalBox{
      background:#fff;
      border-radius:18px;
      padding:18px 18px 14px;
      max-width:420px;
      width:90%;
      box-shadow:0 20px 40px rgba(15,23,42,.35);
    }

    /* ğŸ“… ç­è¡¨æ¨£å¼ */
    .schDayBlock{
      border:1px solid var(--border);
      border-radius:16px;
      background:#fff;
      margin-top:10px;
    }
    .schDayBlock > details{
      padding:8px 10px 10px;
    }
    .schDaySummary{
      list-style:none;
      font-size:14px;
      font-weight:700;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:8px;
    }
    .schDaySummary::-webkit-details-marker{display:none;}
    .schDayInner{
      margin-top:8px;
    }
    .schDeptBlock{
      padding:8px 4px;
      border-top:1px dashed rgba(15,23,42,.12);
    }
    .schDeptBlock:first-of-type{
      border-top:none;
    }
    .schDeptTitle{
      font-size:12.5px;
      font-weight:800;
      color:var(--muted);
      margin-bottom:4px;
    }
    .schStaffGrid{
      display:flex;
      flex-wrap:wrap;
      gap:6px 14px;
    }
    .schStaff{
      font-size:13px;
      display:flex;
      align-items:center;
      gap:4px;
    }
    .tag.miniTag{
      font-size:11px;
      padding:3px 7px;
    }
  </style>
</head>
<body>

  <div class="layout">
    <aside class="sidebar">
      <div class="brand">
        <div>
          <h1>ç®¡ç†è€…å¾Œå°</h1>
          <small>GoldBricks Order</small>
        </div>
        <span class="tag">admin</span>
      </div>

      <div class="nav">
        <button class="navBtn" data-view="staff">ç®¡ç†äººå“¡</button>
        <button class="navBtn" data-view="schedule">ç­è¡¨ç®¡ç†</button>
        <button class="navBtn" data-view="addRestaurant">æ–°å¢é¤å»³</button>
        <button class="navBtn" data-view="restaurants">é¤å»³ç®¡ç†</button>
        <button class="navBtn" data-view="orders">è¨‚é¤ç´€éŒ„</button>
        <div class="hr"></div>
        <button id="switchUser" class="navBtn">åˆ‡æ›ä½¿ç”¨è€…æ¨¡å¼</button>
        <button id="logout" class="navBtn">ç™»å‡º</button>
      </div>

      <p class="muted" style="margin:12px 8px 0;">
        âœ… é¤å»³ï¼šå¯é¡¯ç¤º/éš±è—ã€å¯çµå–®/é–‹å–®ã€å¯è¨­å®šç‡Ÿæ¥­æ™‚é–“/å…¬ä¼‘æ—¥<br/>
        âœ… è¨‚å–®ï¼šæ”¯æ´ Excel åŒ¯å‡ºã€æ”¯æ´åˆªæ•´ç­†/åˆªå–®ä¸€é“<br/>
        âœ… é¤é»ï¼šæ”¯æ´ã€Œæ“‡ä¸€(ä¸‹æ‹‰) / åŠ è³¼(å¤šé¸)ã€é¸é …<br/>
        âœ… æ–°å¢é¤é»ï¼šé¤é»é¡åˆ¥æ”¯æ´ã€Œç¾¤çµ„æ–°å¢ + æ‹–æ›³æ’åºã€<br/>
        âœ… ç­è¡¨ï¼šæ¯æœˆå¯å‹¾é¸ä¸Šç­äººå“¡ï¼Œè¨‚é¤é æœƒæé†’æœªé»é¤åå–®<br/>
      </p>
    </aside>

    <main class="main">
      <div class="topbar">
        <h2 id="pageTitle">æ–°å¢é¤å»³</h2>
        <div class="right">
          <span class="pill" id="statusPill">é€£ç·šä¸­â€¦</span>
          <button class="ghost" id="gotoIndex">ğŸ°</button>
        </div>
      </div>

      <!-- VIEW: æ–°å¢é¤å»³ -->
      <section class="view" id="view_addRestaurant">
        <div class="grid">
          <div class="card">
            <h3>é¤å»³è³‡æ–™ï¼ˆé»æ“Šæ–°å¢ï¼‰</h3>

            <label>é¤å»³åˆ†é¡ï¼ˆæ‰‹å‹•è¼¸å…¥ï¼Œç”¨æ–¼é¤å»³ç®¡ç†çš„åˆ†é¡æ”¶åˆï¼‰</label>
            <input id="r_category" autocomplete="off" placeholder="ä¾‹ï¼šç‡’è‡˜ / ç²¥å“ / éºµé¡ / ä¾¿ç•¶"/>

            <label>é¤å»³åç¨±</label>
            <input id="r_name" name="r_name_no_autofill" autocomplete="off" placeholder="ä¾‹ï¼šé‡‘ç£šä¾¿ç•¶"/>

            <div class="row">
              <div>
                <label>é›»è©±</label>
                <input id="r_phone" autocomplete="off" placeholder="ä¾‹ï¼š02-1234-5678"/>
              </div>
              <div>
                <label>åœ°å€</label>
                <input id="r_addr" autocomplete="off" placeholder="ä¾‹ï¼šå°ä¸­å¸‚â€¦"/>
              </div>
            </div>

            <div class="row">
              <div>
                <label>Google map é€£çµ</label>
                <input id="r_map" autocomplete="off" placeholder="https://maps.google.com/..."/>
              </div>
              <div>
                <label>é¤å»³åœ–ç‰‡ç¶²å€ï¼ˆå¯ç©ºï¼‰</label>
                <input id="r_imgUrl" autocomplete="off" placeholder="https://...jpg / png"/>
              </div>
            </div>

            <label>ç‡Ÿæ¥­æ™‚é–“ï¼ˆå¯ç©ºï¼Œæ–‡å­—å³å¯ï¼‰</label>
            <input id="r_hours" autocomplete="off" placeholder="ä¾‹ï¼š11:00~14:30 / 16:30~19:30"/>

            <label>å…¬ä¼‘æ—¥ï¼ˆå¯å¤šé¸ï¼‰</label>
            <div class="chkline mini" id="r_weeklyOffWrap">
              <label style="margin:0; display:flex; align-items:center; gap:6px;">
                <input type="checkbox" data-weekday="é€±ä¸€å…¬ä¼‘"> é€±ä¸€
              </label>
              <label style="margin:0; display:flex; align-items:center; gap:6px;">
                <input type="checkbox" data-weekday="é€±äºŒå…¬ä¼‘"> é€±äºŒ
              </label>
              <label style="margin:0; display:flex; align-items:center; gap:6px;">
                <input type="checkbox" data-weekday="é€±ä¸‰å…¬ä¼‘"> é€±ä¸‰
              </label>
              <label style="margin:0; display:flex; align-items:center; gap:6px;">
                <input type="checkbox" data-weekday="é€±å››å…¬ä¼‘"> é€±å››
              </label>
              <label style="margin:0; display:flex; align-items:center; gap:6px;">
                <input type="checkbox" data-weekday="é€±äº”å…¬ä¼‘"> é€±äº”
              </label>
              <label style="margin:0; display:flex; align-items:center; gap:6px;">
                <input type="checkbox" data-weekday="é€±å…­å…¬ä¼‘"> é€±å…­
              </label>
              <label style="margin:0; display:flex; align-items:center; gap:6px;">
                <input type="checkbox" data-weekday="é€±æ—¥å…¬ä¼‘"> é€±æ—¥
              </label>
            </div>

            <div class="row">
              <div>
                <label>Line QR Code åœ–ç‰‡ç¶²å€ï¼ˆå¯ç©ºï¼‰</label>
                <input id="r_lineQrUrl" autocomplete="off" placeholder="https://...pngï¼ˆQR code åœ–ï¼‰"/>
              </div>
              <div class="muted" style="display:flex; align-items:end"></div>
            </div>

            <img id="r_imgPrev" class="imgPrev" style="display:none; margin-top:10px" alt="preview"/>
            <img id="r_lineQrPrev" class="qrPrev" style="display:none; margin-top:10px" alt="Line QR preview"/>

            <div class="row">
              <div class="chkline" style="margin-top:12px">
                <input id="r_visible" type="checkbox" checked>
                <label style="margin:0; color:var(--muted)">ä½¿ç”¨è€…é¡¯ç¤º</label>
              </div>
              <div class="chkline" style="margin-top:12px">
                <input id="r_closed" type="checkbox">
                <label style="margin:0; color:var(--muted)">çµå–®ï¼ˆä½¿ç”¨è€…ä¸å¯é€å–®ï¼‰</label>
              </div>
            </div>

            <label>å‚™è¨»</label>
            <textarea id="r_note" autocomplete="off" placeholder="å¯å¡«ç‡Ÿæ¥­æ™‚é–“è£œå……ã€ä»˜æ¬¾æ–¹å¼â€¦"></textarea>

            <div class="actions">
              <button class="primary" id="btnSubmitAll">æ–°å¢ï¼ˆé¤å»³ + é¤é»æ¸…å–®ï¼‰</button>
              <button class="ghost" id="btnClearAll" type="button">æ¸…ç©º</button>
            </div>

            <p class="muted">å³é‚Šå¯å…ˆæŠŠé¤é»åŠ å…¥æ¸…å–®ï¼Œå†æŒ‰ä¸€æ¬¡ã€Œç›´æ¥æ–°å¢ä¸Šã€ã€‚</p>
          </div>

          <div class="card">
            <h3>é¤é»ï¼ˆå…ˆåŠ å…¥æ¸…å–®ï¼Œå¯å¤šç­†ï¼‰</h3>

            <!-- âœ… é¤é»é¡åˆ¥ï¼ˆç¾¤çµ„åˆ¶ + æ‹–æ›³æ’åºï¼‰ -->
            <h3 style="margin-top:0">é¤é»é¡åˆ¥ï¼ˆéœ€å…ˆå»ºç«‹ç¾¤çµ„ï¼‰</h3>
            <div class="subcard">
              <div class="inline">
                <input id="cat_input" placeholder="ä¾‹ï¼šé£¯é¡ / éºµé¡ / å°èœ / é£²æ–™"/>
                <button class="btnSmall btnOk" id="btnAddCatGroup" type="button">æ–°å¢é¡åˆ¥</button>
              </div>

              <div id="catGroupWrap" class="kpi" style="margin-top:10px"></div>
              <div class="muted mini">å¯æ‹–æ›³èª¿æ•´é¡¯ç¤ºé †åºï¼ˆâ˜° ä½ç½®æŒ‰ä½æ‹–æ‹‰ï¼‰</div>
            </div>

            <label style="margin-top:12px">é¤é»é¡åˆ¥ï¼ˆå¾å·²å»ºç«‹ç¾¤çµ„é¸æ“‡ï¼‰</label>
            <select id="m_cat">
              <option value="">è«‹å…ˆé¸æ“‡é¤é»é¡åˆ¥</option>
            </select>

            <div class="row" style="margin-top:10px">
              <div>
                <label>é¤é»åç¨±</label>
                <input id="m_name" placeholder="ä¾‹ï¼šæ³•å¼ç‚’éºµ"/>
              </div>
              <div>
                <label>åƒ¹æ ¼ï¼ˆå–®ä»½ï¼‰</label>
                <input id="m_price" type="number" min="0" placeholder="120"/>
              </div>
            </div>

            <div class="row">
              <div>
                <label>é è¨­æ•¸é‡</label>
                <input id="m_defaultQty" type="number" min="1" value="1"/>
              </div>
              <div class="muted" style="display:flex; align-items:end"></div>
            </div>

            <div class="hr"></div>
            <h3 style="margin-top:0">âœ… é¸é …ç¾¤çµ„ï¼ˆå¯é¸è¦ä¸è¦ç”¨ï¼‰</h3>
            <p class="muted mini" style="margin-top:-4px">
              - ã€Œæ“‡ä¸€ã€ï¼šä½¿ç”¨è€…ç«¯æœƒé¡¯ç¤ºä¸‹æ‹‰é¸å–®ï¼ˆä¾‹ï¼šè‚‰é¡ï¼šè±¬è‚‰/é›è‚‰ï¼‰<br/>
              - ã€ŒåŠ è³¼ã€ï¼šä½¿ç”¨è€…ç«¯æœƒé¡¯ç¤ºå¯å‹¾é¸ï¼ˆä¾‹ï¼šåŠ è›‹ +10 / åŠ éºµ +15ï¼‰
            </p>

            <div class="subcard">
              <div class="row3">
                <div>
                  <label>ç¾¤çµ„åç¨±</label>
                  <input id="og_name" placeholder="ä¾‹ï¼šè‚‰é¡ / é†¬æ–™ / éºµé«”"/>
                </div>
                <div>
                  <label>é¡å‹</label>
                  <select id="og_type">
                    <option value="single">æ“‡ä¸€ï¼ˆä¸‹æ‹‰ï¼‰</option>
                    <option value="addon">åŠ è³¼ï¼ˆå¤šé¸ï¼‰</option>
                  </select>
                </div>
                <div style="display:flex; align-items:end; gap:10px">
                  <label style="display:flex; align-items:center; gap:8px; margin:0;">
                    <input id="og_required" type="checkbox" style="width:18px; height:18px;" checked/>
                    å¿…é¸ï¼ˆæ“‡ä¸€ç”¨ï¼‰
                  </label>
                  <button class="btnSmall btnOk" id="btnStartGroup" type="button">æ–°å¢ç¾¤çµ„</button>
                </div>
              </div>

              <div id="groupDraftArea" style="margin-top:10px; display:none">
                <div class="optBox">
                  <div class="inline" style="justify-content:space-between; align-items:flex-start">
                    <div>
                      <b id="draftGroupTitle">ç¾¤çµ„</b>
                      <div class="muted mini" id="draftGroupDesc"></div>
                    </div>
                    <button class="btnSmall btnDanger" id="btnCancelGroup" type="button">å–æ¶ˆç¾¤çµ„</button>
                  </div>

                  <div class="hr"></div>

                  <div class="optRow">
                    <div>
                      <label>é¸é …åç¨±</label>
                      <input id="opt_name" placeholder="ä¾‹ï¼šè±¬è‚‰ / é›è‚‰ / åŠ è›‹"/>
                    </div>
                    <div>
                      <label>åŠ åƒ¹ï¼ˆå¯ç‚º 0ï¼‰</label>
                      <input id="opt_price" type="number" min="0" placeholder="0"/>
                    </div>
                    <div style="display:flex; align-items:end; gap:10px">
                      <button class="btnSmall btnOk" id="btnAddChoice" type="button">åŠ å…¥é¸é …</button>
                    </div>
                  </div>

                  <div id="choiceDraftList" style="margin-top:10px"></div>

                  <div class="actions">
                    <button class="btnSmall btnOk" id="btnCommitGroup" type="button">å®Œæˆæ­¤ç¾¤çµ„ï¼ˆåŠ å…¥åˆ°é¤é»ï¼‰</button>
                  </div>
                </div>
              </div>

              <div id="menuOptionGroupsList" style="margin-top:10px"></div>
            </div>

            <div class="hr"></div>

            <div class="actions">
              <button class="btnSmall btnOk" id="btnAddMenuToQueue" type="button">åŠ å…¥é¤é»æ¸…å–®</button>
              <button class="ghost" id="btnClearMenu" type="button">æ¸…ç©ºé¤é»æ¬„ä½ï¼ˆå«é¸é …ç¾¤çµ„ï¼‰</button>
            </div>

            <div class="hr"></div>
            <h3 style="margin-top:0">é¤é»æ¸…å–®ï¼ˆå°‡ä¸€èµ·æ–°å¢ï¼‰</h3>
            <div id="menuQueueWrap" class="muted">å°šæœªåŠ å…¥é¤é»ã€‚</div>
          </div>
        </div>
      </section>

      <!-- VIEW: æ–°å¢äººå“¡ -->
      <section class="view" id="view_staff" style="display:none">
        <div class="grid">
          <div class="card">
            <h3>æ–°å¢äººå“¡ï¼ˆå¯æ–°å¢éƒ¨é–€/äººå“¡åç¨±ï¼‰</h3>

            <label>éƒ¨é–€</label>
            <input id="s_dept" list="deptList" placeholder="ä¾‹ï¼šFAE"/>
            <datalist id="deptList">
             <option>ç®¡ç†éƒ¨</option>
             <option>FAE</option>
             <option>TSE</option>
             <option>æ–°å ´</option>
             <option>å€‰ç®¡</option>
             <option>å·¥ç¨‹å¸«</option>
             <option>æ•™è‚²è¨“ç·´</option>
             <option>ç·šä¸Šå®¢æœ</option>

            </datalist>

            <label>äººå“¡åç¨±</label>
            <input id="s_name" placeholder="ä¾‹ï¼šå°æ˜ï¼ˆæŒ‰ Enter ä¹Ÿå¯æ–°å¢ï¼‰"/>

            <div class="actions">
              <button class="primary" id="btnAddStaff" type="button">æ–°å¢</button>
              <button class="ghost" id="btnClearStaff" type="button">æ¸…ç©º</button>
            </div>

            <p class="muted">ç›¸åŒéƒ¨é–€æœƒè‡ªå‹•æ”¶åˆé¡¯ç¤ºï¼Œä¸¦å¯åˆªé™¤äººå“¡ã€‚</p>
          </div>

          <div class="card">
            <h3>äººå“¡æ¸…å–®ï¼ˆéƒ¨é–€æ”¶åˆï¼‰</h3>
            <div id="staffWrap"></div>
          </div>
        </div>
      </section>

      <!-- VIEW: ç­è¡¨ç®¡ç† -->
      <section class="view" id="view_schedule" style="display:none">
        <div class="card">
          <h3>ç­è¡¨ç®¡ç†ï¼ˆæ¯æœˆä¸Šç­äººå“¡å‹¾é¸ï¼‰</h3>

          <div class="inline" style="margin-top:4px; align-items:flex-end;">
            <div>
              <label>æœˆä»½</label>
              <input id="sch_month" type="month"/>
            </div>
            <div>
              <button class="primary" id="btnLoadSchedule" type="button">è¼‰å…¥ç­è¡¨</button>
              <button class="ghost" id="btnScheduleToday" type="button">è·³åˆ°ä»Šå¤©</button>
            </div>
          </div>

          <p class="muted mini" style="margin-top:8px">
            âœ” å‹¾é¸ä»£è¡¨ã€Œç•¶æ—¥ä¸Šç­äººå“¡ã€ï¼›ä¾ã€éƒ¨é–€ã€‘åˆ†æ®µæ’åˆ—ã€‚<br/>
            âœ” æ—¥æœŸåˆ—é è¨­æ”¶åˆï¼Œé»ä¸€ä¸‹å¯å±•é–‹ï¼æ”¶åˆã€‚<br/>
            âœ” å‹¾ï¼å–æ¶ˆå‹¾æœƒè‡ªå‹•å„²å­˜åˆ° Firestoreã€Œschedulesã€é›†åˆã€‚<br/>
          </p>

          <div id="scheduleWrap" style="margin-top:10px"></div>
        </div>
      </section>

      <!-- VIEW: é¤å»³ç®¡ç† -->
      <section class="view" id="view_restaurants" style="display:none">
        <div class="card" style="margin-top:14px">
          <h3>é¤å»³ç®¡ç†ï¼ˆä¾åˆ†é¡æ”¶åˆé¡¯ç¤º + å¯é¡¯ç¤º/éš±è— + å¯çµå–®/é–‹å–®ï¼‰</h3>

          <!-- âœ… æœå°‹ï¼šEnter æ‰å±•é–‹å®šä½ï¼ˆä¸æ•æ„Ÿï¼‰ -->
          <div class="inline" style="margin-top:10px">
            <label style="margin:0; min-width:120px; color:var(--muted)">æœå°‹é¤å»³</label>
            <input id="restSearchOpen"
                   placeholder="è¼¸å…¥é—œéµå­—å¾ŒæŒ‰ Enterï¼ˆå¯æœåº—å/åˆ†é¡/å…¬ä¼‘æ—¥/ç‡Ÿæ¥­æ™‚é–“ï¼‰"
                   style="min-width:340px"/>
            <button class="btnSmall" type="button" id="btnRestSearchClear">æ¸…é™¤</button>
          </div>

          <div class="hr"></div>
         <p class="muted">
            âœ…ã€Œä½¿ç”¨è€…é¡¯ç¤ºã€é—œé–‰å¾Œï¼šä½¿ç”¨è€…é çœ‹ä¸åˆ°è©²åº—<br/>
            âœ…ã€Œçµå–®ã€é–‹å•Ÿå¾Œï¼šä½¿ç”¨è€…ä¸èƒ½é€å–®<br/>
           âœ… å…¬ä¼‘æ—¥æœƒé¡¯ç¤ºåœ¨ summaryï¼Œä¾‹å¦‚ï¼šé€±ä¸€å…¬ä¼‘ãƒ»é€±æ—¥å…¬ä¼‘
         </p>

         <!-- ğŸ†• ç›®å‰ä½¿ç”¨è€…é¡¯ç¤ºä¸­çš„é¤å»³ï¼ˆå¾ˆé†’ç›®çš„å½©è‰²æ¢ï¼‰ -->
         <div id="visibleRestBar" class="alertBar" style="display:none; margin-top:4px"></div>

         <div id="restaurantsWrap"></div>

        </div>
      </section>

      <!-- VIEW: è¨‚é¤ç´€éŒ„ -->
      <section class="view" id="view_orders" style="display:none">
        <!-- âœ… ä¸Šï¼šæ§åˆ¶æ©«æ¢ ï¼›ä¸‹ï¼šå·¦å³å…©æ¬„ -->
        <div style="display:grid; gap:14px">

          <!-- âœ… ä¸Šæ–¹æ©«æ¢ï¼šè¨‚å–®çµ±è¨ˆï¼ˆæ§åˆ¶åˆ—ï¼‰ -->
          <div class="card">
            <h3>è¨‚å–®çµ±è¨ˆ</h3>

            <!-- ğŸ”” æœªé»é¤æé†’æ¢ -->
            <div id="noOrderBanner" class="alertBar" style="display:none"></div>

            <div class="ordersTopBar">
              <div class="leftCtl">
                <div class="dateBox">
                  <label>è¨‚å–®æ—¥æœŸ</label>
                  <input id="o_date" type="date"/>
                </div>

                <div>
                  <label>é¡¯ç¤ºæ¨¡å¼</label>
                  <div class="pill" style="height:42px; display:flex; align-items:center;">
                    åŒå“é …å½™ç¸½ï¼ˆè·¨æ‰€æœ‰äººï¼‰
                  </div>
                </div>

                <div>
                  <label>æ“ä½œ</label>
                  <div class="inline">
                    <button class="primary" id="btnLoadOrders" type="button">è¼‰å…¥</button>
                    <button class="ghost" id="btnToday" type="button">ä»Šå¤©</button>
                    <button class="btnSmall btnOk" id="btnExportExcel" type="button">åŒ¯å‡º Excel</button>
                  </div>
                </div>
              </div>
            </div>

            <p class="muted" style="margin-top:10px">
              Excel æ¬„ä½ï¼šéƒ¨é–€ã€å§“åã€é¤å»³ã€å“é …ã€åŠ è³¼/æ“‡ä¸€ã€é¤é»å‚™è¨»ã€æ•¸é‡ã€å–®åƒ¹ã€åŠ è³¼é‡‘é¡ã€å“é …é‡‘é¡ã€å“é …å°è¨ˆã€è¨‚å–®ç¸½é¡ã€ä¸‹å–®æ™‚é–“ã€æ•´å–®å‚™è¨»
            </p>
          </div>

          <!-- âœ… ä¸‹æ–¹å·¦å³ï¼šå·¦çµ±è¨ˆè¡¨ / å³è¨‚å–®æ˜ç´° -->
          <div style="display:grid; grid-template-columns: 1fr 1fr; gap:14px" id="ordersTwoCol">
            <!-- å·¦ï¼šåŒå“é …å½™ç¸½ -->
            <div class="card">
              <h3>è¨‚å–®çµ±è¨ˆï¼ˆåŒå“é …å½™ç¸½ï¼‰</h3>
              <div id="ordersSummaryOut" class="muted">è«‹é¸æ—¥æœŸå¾ŒæŒ‰ã€Œè¼‰å…¥ã€ã€‚</div>
            </div>

            <!-- å³ï¼šè¨‚å–®æ˜ç´° -->
            <div class="card">
              <h3>è¨‚å–®æ˜ç´°ï¼ˆå¯åˆªæ•´ç­† / åˆªä¸€é“ï¼‰</h3>
              <div id="ordersDetailOut" class="muted">è«‹é¸æ—¥æœŸå¾ŒæŒ‰ã€Œè¼‰å…¥ã€ã€‚</div>
            </div>
          </div>

        </div>
      </section>

      <script>
        // âœ… å°è¢å¹•è‡ªå‹•æ”¹æˆå–®æ¬„ï¼ˆä¸å½±éŸ¿ä½ åŸæœ¬å…¨åŸŸ @mediaï¼‰
        (function(){
          const mq = window.matchMedia("(max-width:980px)");
          const apply = ()=>{
            const el = document.getElementById("ordersTwoCol");
            if(!el) return;
            el.style.gridTemplateColumns = mq.matches ? "1fr" : "1fr 1fr";
          };
          apply();
          mq.addEventListener?.("change", apply);
        })();
      </script>

    </main>
  </div>

  <!-- ğŸ”” æœªé»é¤å½ˆè·³è¦–çª— -->
  <div id="noOrderModal" class="modalMask" style="display:none">
    <div class="modalBox">
      <h3 style="margin-top:0; margin-bottom:8px;">ä»Šæ—¥æœªé»é¤äººå“¡</h3>
      <div id="noOrderList" class="muted mini">
        ï¼ˆå°šç„¡è³‡æ–™ï¼‰
      </div>
      <div class="actions" style="margin-top:12px; justify-content:flex-end;">
        <button class="ghost" type="button" id="btnCloseNoOrder">é—œé–‰</button>
      </div>
    </div>
  </div>

  <!-- âœ… Excel åŒ¯å‡ºç”¨ï¼ˆSheetJSï¼‰ -->
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>

  <script type="module">
/* =========================================================
   åŸºæœ¬è¨­å®š & Firebase
   ========================================================= */
const roleKey = "gb_role";
if (localStorage.getItem(roleKey) !== "admin") {
  location.href = "./index.html";
}

// Firebase
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-app.js";
import {
  getFirestore, collection, addDoc, doc, updateDoc, deleteDoc, getDocs,
  query, where, limit, orderBy
} from "https://www.gstatic.com/firebasejs/10.12.5/firebase-firestore.js";

const firebaseConfig = {
  apiKey: "AIzaSyBdgOddTGAfqqHLnhnaJRv2_y7gyweuQEo",
  authDomain: "goldbricks-order.firebaseapp.com",
  projectId: "goldbricks-order",
  storageBucket: "goldbricks-order.firebasestorage.app",
  messagingSenderId: "463709758954",
  appId: "1:463709758954:web:429dc920f2f812d51cbe93",
  measurementId: "G-YQK8ZCC26R"
};

const app = initializeApp(firebaseConfig);
const db  = getFirestore(app);

/* =========================================================
   å°å·¥å…·
   ========================================================= */
const $ = (id)=> document.getElementById(id);
const esc = (s)=> (s ?? "").toString()
  .replaceAll("&","&amp;").replaceAll("<","&lt;").replaceAll(">","&gt;").replaceAll('"',"&quot;");

const pad2 = (n)=> String(n).padStart(2,"0");
const todayISO = ()=>{
  const d = new Date();
  return `${d.getFullYear()}-${pad2(d.getMonth()+1)}-${pad2(d.getDate())}`;
};

const WEEKDAY_LABEL = ["æ—¥","ä¸€","äºŒ","ä¸‰","å››","äº”","å…­"];

// createdAt å¯èƒ½æ˜¯ number / Timestamp
const toMs = (v)=>{
  if (v == null) return 0;
  if (typeof v === "number") return v;
  if (typeof v?.toMillis === "function") return v.toMillis();
  if (typeof v?.seconds === "number") return Math.floor(v.seconds * 1000);
  return 0;
};
const toTWTime = (v)=>{
  const ms = toMs(v);
  if (!ms) return "";
  try{
    return new Date(ms).toLocaleString("zh-TW",{ hour12:false });
  }catch{
    return String(ms);
  }
};

/* =========================================================
   éƒ¨é–€æ’åºï¼ˆç®¡ç†éƒ¨â†’FAEâ†’TSEâ†’â€¦ï¼‰
   ========================================================= */
const DEPT_ORDER = [
  "ç®¡ç†éƒ¨",
  "FAE",
  "TSE",
  "æ–°å ´",
  "å€‰ç®¡",
  "å·¥ç¨‹å¸«",
  "æ•™è‚²è¨“ç·´",
  "ç·šä¸Šå®¢æœ"
];
const DEPT_INDEX = new Map(DEPT_ORDER.map((d,i)=>[d,i]));
function deptRank(dept){
  return DEPT_INDEX.has(dept) ? DEPT_INDEX.get(dept) : 999;
}

/* =========================================================
   åˆå§‹ UI & Nav
   ========================================================= */
const statusPill = $("statusPill");
statusPill.textContent = "å·²é€£ç·š Firestore";

window.addEventListener("load", ()=>{
  const rName = $("r_name");
  if (rName) rName.value = "";
  const m = $("sch_month");
  if (m) m.value = todayISO().slice(0,7);
});

// View åˆ‡æ›
const pageTitle = $("pageTitle");
const views = {
  staff:        $("view_staff"),
  schedule:     $("view_schedule"),
  addRestaurant:$("view_addRestaurant"),
  restaurants:  $("view_restaurants"),
  orders:       $("view_orders"),
};
function show(viewKey){
  Object.entries(views).forEach(([k,el])=>{
    if (!el) return;
    el.style.display = (k === viewKey) ? "" : "none";
  });

  document.querySelectorAll(".navBtn[data-view]").forEach(btn=>{
    btn.classList.toggle("active", btn.dataset.view === viewKey);
  });

  pageTitle.textContent =
    viewKey === "staff"        ? "æ–°å¢äººå“¡"   :
    viewKey === "schedule"     ? "ç­è¡¨ç®¡ç†"   :
    viewKey === "addRestaurant"? "æ–°å¢é¤å»³"   :
    viewKey === "restaurants"  ? "é¤å»³ç®¡ç†"   :
    "è¨‚é¤ç´€éŒ„";

  if (viewKey === "staff")       refreshStaffList();
  if (viewKey === "restaurants") refreshRestaurantsManage();
}
document.querySelectorAll(".navBtn[data-view]").forEach(btn=>{
  btn.addEventListener("click", ()=> show(btn.dataset.view));
});
show("addRestaurant");

// å³ä¸Šè§’æŒ‰éˆ•
$("logout").onclick = ()=>{
  localStorage.removeItem(roleKey);
  location.href = "./index.html";
};
$("switchUser").onclick = ()=>{
  localStorage.setItem(roleKey,"user");
  location.href = "./user.html";
};
$("gotoIndex").onclick = ()=> location.href = "./index.html";

/* =========================================================
   Firestore collections
   ========================================================= */
const colRestaurants = collection(db, "restaurants");
const colStaff       = collection(db, "staff");
const colOrders      = collection(db, "orders");
const colSchedules   = collection(db, "schedules");

/* =========================================================
   æ–°å¢é¤å»³ï¼šåœ–ç‰‡ / Line QR é è¦½ & å…¬ä¼‘æ—¥ helper
   ï¼ˆç°¡åŒ–ç‰ˆï¼šåªæ–°å¢é¤å»³ï¼Œä¸è™•ç†å³å´é¤é»ç¾¤çµ„ï¼‰
   ========================================================= */
const r_imgUrl    = $("r_imgUrl");
const r_imgPrev   = $("r_imgPrev");
const r_lineQrUrl = $("r_lineQrUrl");
const r_lineQrPrev= $("r_lineQrPrev");

if (r_imgUrl){
  r_imgUrl.addEventListener("input", ()=>{
    const url = r_imgUrl.value.trim();
    if (!url){ r_imgPrev.style.display="none"; return; }
    r_imgPrev.src = url;
    r_imgPrev.style.display = "";
  });
}
if (r_imgPrev){
  r_imgPrev.addEventListener("error", ()=>{ r_imgPrev.style.display="none"; });
}
if (r_lineQrUrl){
  r_lineQrUrl.addEventListener("input", ()=>{
    const url = r_lineQrUrl.value.trim();
    if (!url){ r_lineQrPrev.style.display="none"; return; }
    r_lineQrPrev.src = url;
    r_lineQrPrev.style.display = "";
  });
}
if (r_lineQrPrev){
  r_lineQrPrev.addEventListener("error", ()=>{ r_lineQrPrev.style.display="none"; });
}

// å…¬ä¼‘æ—¥
function getWeeklyOffFromCreateForm(){
  const arr = [];
  document.querySelectorAll('#r_weeklyOffWrap input[type="checkbox"]').forEach(ch=>{
    if (ch.checked) arr.push(ch.dataset.weekday);
  });
  return arr;
}
function clearWeeklyOffCreateForm(){
  document.querySelectorAll('#r_weeklyOffWrap input[type="checkbox"]').forEach(ch=>{
    ch.checked = false;
  });
}

// æ¸…ç©ºã€Œæ–°å¢é¤å»³ã€è¡¨å–®
$("btnClearAll").onclick = ()=>{
  $("r_category").value = "";
  $("r_name").value     = "";
  $("r_phone").value    = "";
  $("r_addr").value     = "";
  $("r_map").value      = "";
  $("r_note").value     = "";
  $("r_hours").value    = "";
  $("r_imgUrl").value   = "";
  $("r_lineQrUrl").value= "";
  if (r_imgPrev)    r_imgPrev.style.display    = "none";
  if (r_lineQrPrev) r_lineQrPrev.style.display = "none";
  $("r_visible").checked = true;
  $("r_closed").checked  = false;
  clearWeeklyOffCreateForm();
};

// æ–°å¢é¤å»³ï¼ˆä¸å«å³å´é¤é»æ¸…å–®ï¼Œå…ˆåšç©©å®šç‰ˆï¼‰
$("btnSubmitAll").onclick = async ()=>{
  const name = $("r_name").value.trim();
  if (!name) return alert("è«‹è¼¸å…¥é¤å»³åç¨±");

  statusPill.textContent = "æ–°å¢é¤å»³ä¸­â€¦";

  try{
    await addDoc(colRestaurants, {
      category:     $("r_category").value.trim(),
      name,
      phone:        $("r_phone").value.trim(),
      address:      $("r_addr").value.trim(),
      mapUrl:       $("r_map").value.trim(),
      note:         $("r_note").value.trim(),
      businessHours:$("r_hours").value.trim(),
      weeklyOff:    getWeeklyOffFromCreateForm(),
      imageUrl:     $("r_imgUrl").value.trim(),
      lineQrUrl:    $("r_lineQrUrl").value.trim(),
      isVisible:    $("r_visible").checked,
      isClosed:     $("r_closed").checked,
      createdAt:    Date.now()
    });

    alert("é¤å»³å·²æ–°å¢ï¼");
    statusPill.textContent = "æ–°å¢å®Œæˆ âœ…";
    $("btnClearAll").click();
    await refreshRestaurantsManage();
  }catch(err){
    console.error(err);
    alert("æ–°å¢å¤±æ•—\n\n" + (err?.message || err));
    statusPill.textContent = "æ–°å¢å¤±æ•—ï¼ˆçœ‹ consoleï¼‰";
  }
};

/* =========================================================
   äººå“¡ç®¡ç†ï¼ˆæ–°å¢ + åˆ—è¡¨ + åˆªé™¤ï¼‰
   ========================================================= */
let allStaffBase   = [];
let allStaffLoaded = false;
let staffOpenDepts = new Set();   // è¨˜ä½ç›®å‰æœ‰å±•é–‹çš„éƒ¨é–€
    
async function loadAllStaffOnce(){
  if (allStaffLoaded && allStaffBase.length) return allStaffBase;

  const snap = await getDocs(colStaff);
  const arr  = [];
  snap.forEach(d=> arr.push({ id:d.id, ...(d.data() || {}) }));

  // éƒ¨é–€ â†’ é †åºï¼›åŒéƒ¨é–€ç…§æ–°å¢æ™‚é–“
  arr.sort((a,b)=>{
    const da = (a.dept || "").trim();
    const db = (b.dept || "").trim();
    const ra = deptRank(da);
    const rb = deptRank(db);
    if (ra !== rb) return ra - rb;
    return Number(a.createdAt || 0) - Number(b.createdAt || 0);
  });

  allStaffBase   = arr;
  allStaffLoaded = true;
  return arr;
}

async function refreshStaffList(){
  const wrap = $("staffWrap");
  if (!wrap) return;

  wrap.innerHTML = `<div class="muted">è¼‰å…¥ä¸­â€¦</div>`;

  try{
    const arr = await loadAllStaffOnce();

    // ä¾éƒ¨é–€åˆ†çµ„
    const deptMap = new Map();
    for (const s of arr){
      const dept = (s.dept || "æœªåˆ†éƒ¨é–€").trim() || "æœªåˆ†éƒ¨é–€";
      if (!deptMap.has(dept)) deptMap.set(dept, []);
      deptMap.get(dept).push(s);
    }

    const orderedDepts = [
      ...DEPT_ORDER.filter(d=> deptMap.has(d)),
      ...Array.from(deptMap.keys()).filter(d=> !DEPT_INDEX.has(d))
    ];

    const html = orderedDepts.map(dept=>{
      const list = deptMap.get(dept) || [];
      const peopleHtml = list.map(s=>`
        <div class="inline" style="justify-content:space-between; margin-top:6px">
          <span>${esc(s.name || "")}</span>
          <button class="btnSmall btnDanger" type="button" data-delstaff="${s.id}">åˆªé™¤</button>
        </div>
      `).join("");

      return `
        <details style="border:1px solid rgba(15,23,42,.10); border-radius:16px; padding:8px 10px; background:#fff; margin-top:8px;" open>
          <summary>
            <b>${esc(dept)}</b>
            <span class="tag" style="margin-left:8px">${list.length} äºº</span>
          </summary>
          <div style="margin-top:8px">
            ${peopleHtml || `<div class="muted mini">æ­¤éƒ¨é–€ç›®å‰æ²’æœ‰ä»»ä½•äººå“¡</div>`}
          </div>
        </details>
      `;
    }).join("");

    wrap.innerHTML = html || `<div class="muted">å°šæœªæ–°å¢ä»»ä½•äººå“¡ã€‚</div>`;

    // ç¶å®šåˆªé™¤æŒ‰éˆ•
    wrap.querySelectorAll("button[data-delstaff]").forEach(btn=>{
      btn.onclick = async ()=>{
        const id = btn.dataset.delstaff;
        if (!confirm("ç¢ºå®šåˆªé™¤æ­¤äººå“¡ï¼Ÿ")) return;
        try{
          await deleteDoc(doc(db,"staff",id));
          allStaffLoaded = false;         // è®“ä¸‹æ¬¡é‡æŠ“
          await refreshStaffList();
        }catch(err){
          console.error(err);
          alert("åˆªé™¤äººå“¡å¤±æ•—\n\n" + (err?.message || err));
        }
      };
    });

  }catch(err){
    console.error(err);
    wrap.innerHTML = `<div class="muted">è¼‰å…¥å¤±æ•—<br/>${esc(err?.message || err)}</div>`;
  }
}

// æ–°å¢äººå“¡
$("btnAddStaff").onclick = async ()=>{
  const dept = $("s_dept").value.trim();
  const name = $("s_name").value.trim();
  if (!dept) return alert("è«‹è¼¸å…¥éƒ¨é–€");
  if (!name) return alert("è«‹è¼¸å…¥äººå“¡åç¨±");

  try{
    await addDoc(colStaff,{
      dept,
      name,
      createdAt: Date.now()
    });
    $("s_name").value = "";
    allStaffLoaded = false;
    await refreshStaffList();
  }catch(err){
    console.error(err);
    alert("æ–°å¢äººå“¡å¤±æ•—\n\n" + (err?.message || err));
  }
};
$("btnClearStaff").onclick = ()=>{
  $("s_dept").value = "";
  $("s_name").value = "";
};
$("s_name").addEventListener("keydown",(e)=>{
  if (e.key === "Enter"){
    e.preventDefault();
    $("btnAddStaff").click();
  }
});

/* =========================================================
   ç­è¡¨ç®¡ç†ï¼ˆæš«æ™‚ç°¡åŒ–æˆæç¤ºï¼Œä¸æœƒå£æ‰ï¼‰
   ========================================================= */
$("btnScheduleToday").onclick = ()=>{
  const m = $("sch_month");
  if (m) m.value = todayISO().slice(0,7);
};

$("btnLoadSchedule").onclick = ()=>{
  const wrap = $("scheduleWrap");
  const month = $("sch_month").value || "";
  if (!wrap) return;
  if (!month) return alert("è«‹å…ˆé¸æœˆä»½");

  wrap.innerHTML = `
    <div class="schDayBlock">
      <div style="padding:10px">
        <b>ç­è¡¨åŠŸèƒ½ä¹‹å¾Œå†è£œå¼·</b>
        <p class="muted mini" style="margin-top:6px">
          ç›®å‰åªæ˜¯é ç•™ç•«é¢ï¼Œä¸æœƒå¯«å…¥ä»»ä½•è³‡æ–™ã€‚<br/>
          é€™æ¨£å¯ä»¥å…ˆç¢ºä¿ã€Œè¨‚é¤ç´€éŒ„ / é¤å»³ç®¡ç† / æ–°å¢äººå“¡ã€éƒ½æ­£å¸¸é‹ä½œã€‚
        </p>
      </div>
    </div>
  `;
};

/* =========================================================
   é¤å»³ç®¡ç†ï¼ˆå®‰å…¨ç‰ˆï¼šåªæ”¹é¤å»³æœ¬èº«æ¬„ä½ï¼Œä¸å‹• menuï¼‰
   ========================================================= */
let restaurantsCache = [];

function renderRestaurantsList(){
  const wrap = $("restaurantsWrap");
  const bar  = $("visibleRestBar");
  const searchInput = $("restSearchOpen");
  if (!wrap) return;

  const keyword = (searchInput?.value || "").trim().toLowerCase();

  let list = restaurantsCache.slice();
  if (keyword){
    list = list.filter(r=>{
      const text = [
        r.name, r.category, r.address, r.phone,
        r.businessHours, (Array.isArray(r.weeklyOff)?r.weeklyOff.join(","):"")
      ].join(" ").toLowerCase();
      return text.includes(keyword);
    });
  }

  // ç›®å‰æ­£åœ¨é¡¯ç¤ºçµ¦ä½¿ç”¨è€…çš„é¤å»³ï¼ˆisVisible !== falseï¼‰
  if (bar){
    const visible = list.filter(r => r.isVisible !== false);
    if (!visible.length){
      bar.style.display = "none";
    }else{
      bar.style.display = "";
      bar.className = "alertBar alertOk";
      bar.textContent = `ç›®å‰å…±æœ‰ ${visible.length} å®¶é¤å»³ã€Œä½¿ç”¨è€…çœ‹å¾—åˆ°ã€`;
    }
  }

  if (!list.length){
    wrap.innerHTML = `<div class="muted">æŸ¥ç„¡é¤å»³ï¼ˆå¯ä»¥å…ˆåˆ°ã€Œæ–°å¢é¤å»³ã€å»ºç«‹ï¼‰</div>`;
    return;
  }

  // ä¾åˆ†é¡åˆ†çµ„
  const map = new Map();
  for (const r of list){
    const cat = (r.category || "").trim() || "æœªåˆ†é¡";
    if (!map.has(cat)) map.set(cat, []);
    map.get(cat).push(r);
  }

  const categoryKeys = Array.from(map.keys()).sort((a,b)=>{
    if (a === "æœªåˆ†é¡" && b !== "æœªåˆ†é¡") return 1;
    if (b === "æœªåˆ†é¡" && a !== "æœªåˆ†é¡") return -1;
    return a.localeCompare(b,"zh-Hant");
  });

  const weekOptions = [
    "é€±ä¸€å…¬ä¼‘","é€±äºŒå…¬ä¼‘","é€±ä¸‰å…¬ä¼‘","é€±å››å…¬ä¼‘",
    "é€±äº”å…¬ä¼‘","é€±å…­å…¬ä¼‘","é€±æ—¥å…¬ä¼‘"
  ];

  const blocks = categoryKeys.map(cat=>{
    const arr = map.get(cat) || [];
    const inner = arr.map(r=>{
      const weeklyOffArr = Array.isArray(r.weeklyOff) ? r.weeklyOff : [];

      const weeklyOffChecks = weekOptions.map(label=>{
        const checked = weeklyOffArr.includes(label) ? "checked" : "";
        const text = label.replace("å…¬ä¼‘","");
        return `
          <label style="margin:0; display:flex; align-items:center; gap:6px;">
            <input type="checkbox" data-weeklyoff="${r.id}" data-weekday="${label}" ${checked}> ${esc(text)}
          </label>
        `;
      }).join("");

      const visibleTag = (r.isVisible !== false)
        ? `<span class="tag stateGood" style="margin-left:10px">ä½¿ç”¨è€…é¡¯ç¤º</span>`
        : `<span class="tag stateBad"  style="margin-left:10px">ä½¿ç”¨è€…éš±è—</span>`;

      const closedTag = (!!r.isClosed)
        ? `<span class="tag stateBad" style="margin-left:6px">å·²çµå–®</span>`
        : `<span class="tag stateGood" style="margin-left:6px">é–‹å–®ä¸­</span>`;

      const weeklyOffLabel = weeklyOffArr.length ? weeklyOffArr.join("ãƒ»") : "";
      const weeklyOffTag = weeklyOffLabel
        ? `<span class="tag stateBad" style="margin-left:6px">${esc(weeklyOffLabel)}</span>`
        : "";

      const hoursText = (r.businessHours || "").trim();
      const hoursTag = hoursText
        ? `<span class="tag" style="margin-left:6px">â° ${esc(hoursText)}</span>`
        : "";

      return `
        <details style="border:1px solid rgba(15,23,42,.10); border-radius:16px; padding:12px; background:#fff; margin-top:10px;">
          <summary>
            <span style="font-size:14.5px">${esc(r.name || "æœªå‘½å")}</span>
            ${visibleTag}
            ${closedTag}
            ${weeklyOffTag}
            ${hoursTag}
          </summary>

          <div class="kpi" style="margin-top:8px">
            ${r.phone   ? `<span class="tag">â˜ ${esc(r.phone)}</span>`   : ``}
            ${r.address ? `<span class="tag">ğŸ“ ${esc(r.address)}</span>` : ``}
            ${r.mapUrl  ? `<span class="tag"><a href="${esc(r.mapUrl)}" target="_blank" style="color:inherit;text-decoration:none">Google Map</a></span>` : ``}
          </div>

          <label>é¤å»³åˆ†é¡</label>
          <input data-rid="${r.id}" data-k="category" value="${esc(r.category || "")}" placeholder="ä¾‹ï¼šç‡’è‡˜ / ç²¥å“"/>

          <div class="row" style="margin-top:10px">
            <div>
              <label>é›»è©±</label>
              <input data-rid="${r.id}" data-k="phone" value="${esc(r.phone || "")}"/>
            </div>
            <div>
              <label>åœ°å€</label>
              <input data-rid="${r.id}" data-k="address" value="${esc(r.address || "")}"/>
            </div>
          </div>

          <div class="row">
            <div>
              <label>Google map é€£çµ</label>
              <input data-rid="${r.id}" data-k="mapUrl" value="${esc(r.mapUrl || "")}"/>
            </div>
            <div>
              <label>åœ–ç‰‡ç¶²å€</label>
              <input data-rid="${r.id}" data-k="imageUrl" value="${esc(r.imageUrl || "")}"/>
            </div>
          </div>

          <label>ç‡Ÿæ¥­æ™‚é–“</label>
          <input data-rid="${r.id}" data-k="businessHours" value="${esc(r.businessHours || "")}" placeholder="ä¾‹ï¼š11:00~14:30 / 16:30~19:30"/>

          <label>å…¬ä¼‘æ—¥ï¼ˆå¯å¤šé¸ï¼‰</label>
          <div class="chkline mini">
            ${weeklyOffChecks}
          </div>

          <div class="row">
            <div>
              <label>Line QR Code åœ–ç‰‡ç¶²å€</label>
              <input data-rid="${r.id}" data-k="lineQrUrl" value="${esc(r.lineQrUrl || "")}"/>
            </div>
            <div class="chkline" style="margin-top:12px">
              <input type="checkbox" data-rid="${r.id}" data-k="isVisible" ${(r.isVisible !== false) ? "checked" : ""}/>
              <span class="muted">ä½¿ç”¨è€…é¡¯ç¤º</span>
            </div>
          </div>

          <div class="chkline" style="margin-top:6px">
            <input type="checkbox" data-rid="${r.id}" data-k="isClosed" ${r.isClosed ? "checked" : ""}/>
            <span class="muted">çµå–®ï¼ˆä½¿ç”¨è€…ä¸å¯é€å–®ï¼‰</span>
          </div>

          ${r.imageUrl
            ? `<img src="${esc(r.imageUrl)}" class="imgPrev" style="margin-top:10px" alt="img" onerror="this.style.display='none'"/>`
            : `<div class="muted mini" style="margin-top:10px">ï¼ˆå°šç„¡é¤å»³åœ–ç‰‡ç¶²å€ï¼‰</div>`}

          <label>å‚™è¨»</label>
          <textarea data-rid="${r.id}" data-k="note">${esc(r.note || "")}</textarea>

          <div class="actions">
            <button class="btnSmall btnOk"     type="button" data-save-rest="${r.id}">å„²å­˜</button>
            <button class="btnSmall btnDanger" type="button" data-del-rest="${r.id}">åˆªé™¤</button>
          </div>
        </details>
      `;
    }).join("");

    return `
      <details style="border:1px solid rgba(15,23,42,.10); border-radius:16px; padding:12px; background:rgba(255,255,255,.9); margin-top:12px;">
        <summary>
          <span style="font-size:15px">${esc(cat)}</span>
          <span class="tag" style="margin-left:8px">${arr.length} å®¶</span>
        </summary>
        <div style="margin-top:10px">
          ${inner}
        </div>
      </details>
    `;
  }).join("");

  wrap.innerHTML = blocks;

  // ç¶å®šå„²å­˜ & åˆªé™¤
  wrap.querySelectorAll("button[data-save-rest]").forEach(btn=>{
    btn.onclick = async ()=>{
      const rid = btn.dataset.saveRest;
      const inputs = wrap.querySelectorAll(`[data-rid="${rid}"]`);
      const patch = {};

      inputs.forEach(el=>{
        const k = el.dataset.k;
        if (!k) return;
        if (el.type === "checkbox"){
          patch[k] = !!el.checked;
        }else{
          patch[k] = el.value.trim();
        }
      });

      // weeklyOff
      const weekInputs = wrap.querySelectorAll(`input[data-weeklyoff="${rid}"]`);
      const weeklyOff = [];
      weekInputs.forEach(ch=>{
        if (ch.checked) weeklyOff.push(ch.dataset.weekday);
      });
      patch.weeklyOff = weeklyOff;

      if (typeof patch.isVisible !== "boolean") patch.isVisible = true;
      if (typeof patch.isClosed  !== "boolean") patch.isClosed  = false;

      try{
        statusPill.textContent = "å„²å­˜é¤å»³ä¸­â€¦";
        await updateDoc(doc(db,"restaurants",rid), patch);
        statusPill.textContent = "å·²å„²å­˜ âœ…";
        restaurantsCache = restaurantsCache.map(r=> r.id === rid ? {...r, ...patch} : r);
        renderRestaurantsList();
      }catch(err){
        console.error(err);
        alert("å„²å­˜å¤±æ•—\n\n" + (err?.message || err));
        statusPill.textContent = "å„²å­˜å¤±æ•—ï¼ˆçœ‹ consoleï¼‰";
      }
    };
  });

  wrap.querySelectorAll("button[data-del-rest]").forEach(btn=>{
    btn.onclick = async ()=>{
      const rid = btn.dataset.delRest;
      if (!confirm("ç¢ºå®šåˆªé™¤é¤å»³ï¼Ÿï¼ˆä¸æœƒå‹•åˆ°å…¶ä»–é›†åˆï¼‰")) return;
      try{
        statusPill.textContent = "åˆªé™¤é¤å»³ä¸­â€¦";
        await deleteDoc(doc(db,"restaurants",rid));
        statusPill.textContent = "å·²åˆªé™¤ âœ…";
        restaurantsCache = restaurantsCache.filter(r=> r.id !== rid);
        renderRestaurantsList();
      }catch(err){
        console.error(err);
        alert("åˆªé™¤å¤±æ•—\n\n" + (err?.message || err));
        statusPill.textContent = "åˆªé™¤å¤±æ•—ï¼ˆçœ‹ consoleï¼‰";
      }
    };
  });
}

async function refreshRestaurantsManage(){
  const wrap = $("restaurantsWrap");
  if (!wrap) return;
  wrap.innerHTML = `<div class="muted">è¼‰å…¥ä¸­â€¦</div>`;

  try{
    const snap = await getDocs(colRestaurants);
    const arr  = [];
    snap.forEach(d=> arr.push({ id:d.id, ...(d.data() || {}) }));

    // å…ˆç…§åˆ†é¡ / åç¨±æ’åºä¸€ä¸‹
    arr.sort((a,b)=>{
      const ca = (a.category || "").trim();
      const cb = (b.category || "").trim();
      if (ca !== cb) return ca.localeCompare(cb,"zh-Hant");
      const na = (a.name || "").trim();
      const nb = (b.name || "").trim();
      return na.localeCompare(nb,"zh-Hant");
    });

    restaurantsCache = arr;
    renderRestaurantsList();
  }catch(err){
    console.error(err);
    wrap.innerHTML = `<div class="muted">è¼‰å…¥å¤±æ•—<br/>${esc(err?.message || err)}</div>`;
  }
}

// æœå°‹ & æ¸…é™¤
$("restSearchOpen").addEventListener("keydown",(e)=>{
  if (e.key === "Enter"){
    e.preventDefault();
    renderRestaurantsList();
  }
});
$("btnRestSearchClear").onclick = ()=>{
  $("restSearchOpen").value = "";
  renderRestaurantsList();
};

/* =========================================================
   è¨‚é¤ç´€éŒ„ï¼šè¼‰å…¥ / å½™ç¸½ / Excelï¼ˆç°¡åŒ–ç‰ˆï¼‰
   ========================================================= */
$("btnToday").onclick = ()=> $("o_date").value = todayISO();
$("o_date").value = todayISO();

function dayRangeMs(dateStr){
  const start = new Date(dateStr + "T00:00:00").getTime();
  const end   = new Date(dateStr + "T23:59:59.999").getTime();
  return { start, end };
}

function itemNoteText(it){
  return (it?.note ?? it?.remark ?? it?.itemNote ?? it?.memo ?? "").toString().trim();
}
function addonText(addons){
  const arr = Array.isArray(addons) ? addons : [];
  if (!arr.length) return "";
  return arr.map(a=>{
    const p = Number(a?.price || 0);
    const group = a?.group ? `(${a.group})` : "";
    return `${group}${a?.name || ""}${p ? ` +${p}` : ""}`;
  }).join(" / ");
}
function addonUnitSum(addons){
  const arr = Array.isArray(addons) ? addons : [];
  return arr.reduce((s,a)=> s + Number(a?.price || 0), 0);
}
function calcOrderTotal(items){
  const arr = Array.isArray(items) ? items : [];
  return arr.reduce((s,it)=>{
    const unitAddon = addonUnitSum(it.addons);
    return s + (Number(it.price||0) + unitAddon) * Number(it.qty||0);
  },0);
}

let lastLoadedOrders = [];

async function loadOrdersByDate(dateStr){
  const { start, end } = dayRangeMs(dateStr);
  const snap = await getDocs(query(
    colOrders,
    where("createdAt",">=",start),
    where("createdAt","<=",end),
    orderBy("createdAt","desc"),
    limit(5000)
  ));
  const arr = [];
  snap.forEach(d=> arr.push({ id:d.id, ...(d.data() || {}) }));
  return arr;
}

// è¨‚å–®è©³ç´°æ’åºï¼šéƒ¨é–€ â†’ å§“å â†’ é¤å»³ â†’ æ™‚é–“(æ–°â†’èˆŠ)
function sortOrdersForDetails(arr){
  const orders = Array.isArray(arr) ? [...arr] : [];
  orders.sort((a,b)=>{
    const da = (a.userDept || "").trim();
    const db = (b.userDept || "").trim();
    const ra = deptRank(da);
    const rb = deptRank(db);
    if (ra !== rb) return ra - rb;

    const na = (a.userName || "").trim();
    const nb = (b.userName || "").trim();
    if (na !== nb) return na.localeCompare(nb,"zh-Hant");

    const raName = (a.restaurantName || "").trim();
    const rbName = (b.restaurantName || "").trim();
    if (raName !== rbName) return raName.localeCompare(rbName,"zh-Hant");

    return toMs(b.createdAt||0) - toMs(a.createdAt||0);
  });
  return orders;
}

async function deleteWholeOrder(orderId){
  if (!confirm("ç¢ºå®šåˆªé™¤æ•´ç­†è¨‚å–®ï¼Ÿ")) return;
  try{
    statusPill.textContent = "åˆªé™¤è¨‚å–®ä¸­â€¦";
    await deleteDoc(doc(db,"orders",orderId));
    statusPill.textContent = "å·²åˆªé™¤è¨‚å–® âœ…";
  }catch(err){
    console.error(err);
    alert("åˆªé™¤è¨‚å–®å¤±æ•—\n\n" + (err?.message || err));
  }
}
async function deleteOrderItem(orderId, itemIndex){
  const o = lastLoadedOrders.find(x=> x.id === orderId);
  if (!o) return alert("æ‰¾ä¸åˆ°è©²è¨‚å–®ï¼ˆè«‹é‡æ–°è¼‰å…¥ï¼‰");

  const items = Array.isArray(o.items) ? [...o.items] : [];
  const it = items[itemIndex];
  if (!it) return;

  if (!confirm(`ç¢ºå®šåˆªé™¤é€™ä¸€é“ï¼Ÿ\n\n${it.name || ""}`)) return;

  items.splice(itemIndex,1);
  if (!items.length){
    if (confirm("æ­¤è¨‚å–®å·²ç„¡é¤é»ï¼Œè¦ç›´æ¥åˆªé™¤æ•´ç­†è¨‚å–®å—ï¼Ÿ")){
      await deleteWholeOrder(orderId);
      return;
    }
  }
  const newTotal = calcOrderTotal(items);

  try{
    statusPill.textContent = "æ›´æ–°è¨‚å–®ä¸­â€¦";
    await updateDoc(doc(db,"orders",orderId),{
      items,
      total:newTotal
    });
    statusPill.textContent = "å·²æ›´æ–°è¨‚å–® âœ…";
  }catch(err){
    console.error(err);
    alert("åˆªé™¤é¤é»å¤±æ•—ï¼ˆæ›´æ–°è¨‚å–®å¤±æ•—ï¼‰\n\n" + (err?.message || err));
  }
}

function renderOrdersSummaryAndDetail(orders){
  const sumOut = $("ordersSummaryOut");
  const detOut = $("ordersDetailOut");

  if (!orders.length){
    sumOut.innerHTML = `<div class="muted">æ­¤æ—¥æœŸæ²’æœ‰è¨‚å–®</div>`;
    detOut.innerHTML = `<div class="muted">æ­¤æ—¥æœŸæ²’æœ‰è¨‚å–®</div>`;
    return;
  }

  // ====== å·¦ï¼šåŒå“é …å½™ç¸½ ======
  const agg = new Map();
  let grandTotal = 0;

  for (const o of orders){
    const items = Array.isArray(o.items) ? o.items : [];
    let orderTotal = Number(o.total || 0);
    if (!orderTotal) orderTotal = calcOrderTotal(items);
    grandTotal += orderTotal;

    for (const it of items){
      const rName = o.restaurantName || "";
      const unit  = Number(it.price || 0);
      const addons= Array.isArray(it.addons) ? it.addons : [];
      const aKey  = addonText(addons);
      const note  = itemNoteText(it);
      const key   = `${rName}__${it.name||""}__${unit}__${aKey}__${note}`;

      if (!agg.has(key)){
        agg.set(key,{
          restaurant:rName,
          item:it.name || "",
          unit,
          addons,
          note,
          qty:0
        });
      }
      agg.get(key).qty += Number(it.qty || 0);
    }
  }

  const rows = Array.from(agg.values()).sort((a,b)=> b.qty - a.qty);
  const sumRowsHTML = rows.map(x=>{
    const unitAddon = addonUnitSum(x.addons);
    const addonAmt  = unitAddon * x.qty;
    const itemAmt   = x.unit * x.qty;
    const total     = (x.unit + unitAddon) * x.qty;
    return `
      <tr>
        <td>${esc(x.restaurant)}</td>
        <td>${esc(x.item)}</td>
        <td class="muted">${esc(addonText(x.addons))}</td>
        <td class="muted">${esc(x.note || "")}</td>
        <td>${x.qty}</td>
        <td>${x.unit}</td>
        <td>${addonAmt}</td>
        <td>${itemAmt}</td>
        <td>${total}</td>
      </tr>
    `;
  }).join("");

  sumOut.innerHTML = `
    <div class="inline" style="justify-content:space-between; margin-bottom:10px">
      <span class="tag">å…± ${orders.length} ç­†è¨‚å–®</span>
      <span class="tag">è¨‚å–®ç¸½åŠ ç¸½ï¼š${grandTotal}</span>
    </div>
    <table>
      <thead>
        <tr>
          <th>é¤å»³</th>
          <th>å“é …</th>
          <th>åŠ è³¼/æ“‡ä¸€</th>
          <th>é¤é»å‚™è¨»</th>
          <th>æ•¸é‡</th>
          <th>å–®åƒ¹</th>
          <th>åŠ è³¼é‡‘é¡</th>
          <th>å“é …é‡‘é¡</th>
          <th>å°è¨ˆ</th>
        </tr>
      </thead>
      <tbody>
        ${sumRowsHTML || `<tr><td colspan="9" class="muted">æ­¤æ—¥æœŸæ²’æœ‰è¨‚å–®</td></tr>`}
      </tbody>
    </table>
  `;

  // ====== å³ï¼šè¨‚å–®æ˜ç´°ï¼ˆä¾éƒ¨é–€åˆ†çµ„ï¼‰ ======
  const detailOrders = sortOrdersForDetails(orders);
  const deptMap = new Map();
  for (const o of detailOrders){
    const dept = (o.userDept || "æœªåˆ†éƒ¨é–€").trim() || "æœªåˆ†éƒ¨é–€";
    if (!deptMap.has(dept)) deptMap.set(dept, []);
    deptMap.get(dept).push(o);
  }

  const orderedDepts = [
    ...DEPT_ORDER.filter(d=> deptMap.has(d)),
    ...Array.from(deptMap.keys()).filter(d=> !DEPT_INDEX.has(d))
  ];

  const detHTML = orderedDepts.map(dept=>{
    const list = deptMap.get(dept) || [];

    const inner = list.map(o=>{
      const name   = o.userName || "";
      const rest   = o.restaurantName || "";
      const time   = toTWTime(o.createdAt);
      const orderNote = o.orderNote || o.remark || "";
      const items  = Array.isArray(o.items) ? o.items : [];
      const total  = Number(o.total || 0) || calcOrderTotal(items);

      const rows = items.map((it,idx)=>{
        const qty   = Number(it.qty || 0);
        const unit  = Number(it.price || 0);
        const unitAddon = addonUnitSum(it.addons);
        const sub   = (unit + unitAddon) * qty;
        return `
          <tr>
            <td><b>${esc(it.name || "")}</b></td>
            <td class="muted">${esc(addonText(it.addons))}</td>
            <td class="muted">${esc(itemNoteText(it))}</td>
            <td>${qty}</td>
            <td>${unit}</td>
            <td>${sub}</td>
            <td>
              <button class="btnSmall btnDanger" type="button"
                data-del-item="1" data-oid="${o.id}" data-idx="${idx}">åˆªæ­¤ä¸€é“</button>
            </td>
          </tr>
        `;
      }).join("");

      return `
        <details style="border:1px solid rgba(15,23,42,.10); border-radius:16px; padding:10px 12px; background:#fff; margin-top:10px;">
          <summary>
            <span style="font-size:14px">${esc(name)}ï½œ${esc(rest)}</span>
            <span class="tag" style="margin-left:8px">${items.length} é“</span>
            <span class="tag" style="margin-left:6px">ç¸½é¡ ${total}</span>
            <span class="tag" style="margin-left:6px">${esc(time)}</span>
          </summary>

          ${orderNote ? `<div class="muted mini" style="margin-top:8px">æ•´å–®å‚™è¨»ï¼š${esc(orderNote)}</div>` : ""}

          <div class="hr"></div>
          ${items.length
            ? `
              <table>
                <thead>
                  <tr>
                    <th>å“é …</th>
                    <th>åŠ è³¼/æ“‡ä¸€</th>
                    <th>é¤é»å‚™è¨»</th>
                    <th>æ•¸é‡</th>
                    <th>å–®åƒ¹</th>
                    <th>å°è¨ˆ</th>
                    <th>æ“ä½œ</th>
                  </tr>
                </thead>
                <tbody>${rows}</tbody>
              </table>
            `
            : `<div class="muted">ï¼ˆæ­¤è¨‚å–®æ²’æœ‰é¤é»ï¼‰</div>`
          }

          <div class="actions">
            <button class="btnSmall btnDanger" type="button" data-del-order="1" data-oid="${o.id}">åˆªæ•´ç­†è¨‚å–®</button>
          </div>
        </details>
      `;
    }).join("");

    return `
      <details style="border:1px solid rgba(15,23,42,.10); border-radius:16px; padding:10px 12px; background:rgba(255,255,255,.9); margin-top:10px;">
        <summary>
          <span style="font-size:14.5px">${esc(dept)}</span>
          <span class="tag" style="margin-left:8px">${list.length} ç­†è¨‚å–®</span>
        </summary>
        <div style="margin-top:10px">
          ${inner || `<div class="muted">ï¼ˆæ­¤éƒ¨é–€æ²’æœ‰è¨‚å–®ï¼‰</div>`}
        </div>
      </details>
    `;
  }).join("");

  detOut.innerHTML = detHTML;

  // ç¶å®šåˆªé™¤æŒ‰éˆ•
  detOut.querySelectorAll("[data-del-order]").forEach(btn=>{
    btn.onclick = async ()=>{
      const oid = btn.dataset.oid;
      await deleteWholeOrder(oid);
      $("btnLoadOrders").click();
    };
  });
  detOut.querySelectorAll("[data-del-item]").forEach(btn=>{
    btn.onclick = async ()=>{
      const oid = btn.dataset.oid;
      const idx = Number(btn.dataset.idx);
      await deleteOrderItem(oid, idx);
      $("btnLoadOrders").click();
    };
  });
}

// è¼‰å…¥è¨‚å–®
$("btnLoadOrders").onclick = async ()=>{
  const date = $("o_date").value;
  if (!date) return alert("è«‹é¸æ—¥æœŸ");

  try{
    statusPill.textContent = "è¼‰å…¥è¨‚å–®ä¸­â€¦";
    await loadAllStaffOnce(); // ä¹‹å¾Œå¦‚æœè¦åšã€Œæœªé»é¤æé†’ã€æœƒç”¨åˆ°

    const orders = await loadOrdersByDate(date);
    lastLoadedOrders = orders;
    renderOrdersSummaryAndDetail(orders);
    statusPill.textContent = "å·²è¼‰å…¥ âœ…";
  }catch(err){
    console.error(err);
    $("ordersSummaryOut").innerHTML = `<div class="muted">è®€å–è¨‚å–®å¤±æ•—<br/>${esc(err?.message || err)}</div>`;
    $("ordersDetailOut").innerHTML  = `<div class="muted">è®€å–è¨‚å–®å¤±æ•—<br/>${esc(err?.message || err)}</div>`;
    alert("è®€å–è¨‚å–®å¤±æ•—\n\n" + (err?.message || err));
    statusPill.textContent = "è®€å–å¤±æ•—ï¼ˆçœ‹ consoleï¼‰";
  }
};

// åŒ¯å‡º Excelï¼ˆç°¡åŒ–ï¼šé€å“é …ä¸€å¼µ Sheetï¼‰
$("btnExportExcel").onclick = async ()=>{
  const date = $("o_date").value;
  if (!date) return alert("è«‹é¸æ—¥æœŸ");

  try{
    statusPill.textContent = "æº–å‚™ Excelâ€¦";

    let orders = lastLoadedOrders;
    if (!Array.isArray(orders) || !orders.length){
      orders = await loadOrdersByDate(date);
      lastLoadedOrders = orders;
    }
    if (!orders.length) return alert("æ­¤æ—¥æœŸæ²’æœ‰è¨‚å–®å¯åŒ¯å‡º");

    const rows = [];
    for (const o of sortOrdersForDetails(orders)){
      const dept = (o.userDept || "æœªåˆ†éƒ¨é–€").trim() || "æœªåˆ†éƒ¨é–€";
      const name = (o.userName || "").trim();
      const rest = (o.restaurantName || "").trim();
      const items = Array.isArray(o.items) ? o.items : [];
      const time  = toTWTime(o.createdAt);

      if (!items.length){
        rows.push({
          éƒ¨é–€: dept,
          å§“å: name,
          é¤å»³: rest,
          å“é …: "",
          "åŠ è³¼/æ“‡ä¸€": "",
          é¤é»å‚™è¨»: "",
          æ•¸é‡: 0,
          å–®åƒ¹: 0,
          å°è¨ˆ: 0,
          æ•´å–®å‚™è¨»: o.orderNote || o.remark || "",
          ä¸‹å–®æ™‚é–“: time
        });
      }else{
        for (const it of items){
          const qty  = Number(it.qty || 0);
          const unit = Number(it.price || 0);
          const addonUnit = addonUnitSum(it.addons);
          const sub  = (unit + addonUnit) * qty;
          rows.push({
            éƒ¨é–€: dept,
            å§“å: name,
            é¤å»³: rest,
            å“é …: it.name || "",
            "åŠ è³¼/æ“‡ä¸€": addonText(it.addons),
            é¤é»å‚™è¨»: itemNoteText(it),
            æ•¸é‡: qty,
            å–®åƒ¹: unit,
            å°è¨ˆ: sub,
            æ•´å–®å‚™è¨»: o.orderNote || o.remark || "",
            ä¸‹å–®æ™‚é–“: time
          });
        }
      }
    }

    const ws = XLSX.utils.json_to_sheet(rows);
    const wb = XLSX.utils.book_new();
    XLSX.utils.book_append_sheet(wb, ws, "è¨‚å–®é€å“é …");
    XLSX.writeFile(wb, `GoldBricks_è¨‚å–®_${date}.xlsx`);
    statusPill.textContent = "Excel å·²åŒ¯å‡º âœ…";
  }catch(err){
    console.error(err);
    alert("åŒ¯å‡ºå¤±æ•—\n\n" + (err?.message || err));
    statusPill.textContent = "åŒ¯å‡ºå¤±æ•—ï¼ˆçœ‹ consoleï¼‰";
  }
};
</script>
</body>
</html>
