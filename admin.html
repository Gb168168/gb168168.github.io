<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <title>GoldBricks 訂餐系統 - 管理者</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <style>
    * { box-sizing: border-box; margin: 0; padding: 0; }
    body {
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      background: #f5f4fb;
      min-height: 100vh;
      display: flex;
    }
    .sidebar {
      width: 220px;
      background: #111827;
      color: #e5e7eb;
      padding: 20px 16px;
      display: flex;
      flex-direction: column;
      gap: 16px;
    }
    .sidebar h2 { font-size: 18px; margin-bottom: 4px; }
    .menu { list-style: none; margin-top: 8px; }
    .menu li {
      padding: 8px 10px;
      border-radius: 8px;
      font-size: 14px;
      cursor: pointer;
      margin-bottom: 4px;
    }
    .menu li.active {
      background: linear-gradient(90deg,#fb7185,#f97316);
      color: white;
    }
    .menu li:hover:not(.active) { background: #1f2937; }

    .main {
      flex: 1;
      padding: 20px 24px;
      overflow-y: auto;
    }
    .section { display: none; }
    .section.active { display: block; }

    h3 { font-size: 18px; margin-bottom: 12px; }
    .card {
      background: #fff;
      border-radius: 16px;
      padding: 16px 18px;
      box-shadow: 0 8px 25px rgba(15,23,42,0.08);
      margin-bottom: 16px;
    }
    .group {
      display: grid;
      grid-template-columns: repeat(auto-fit,minmax(180px,1fr));
      gap: 12px 16px;
      margin-bottom: 12px;
    }
    label {
      font-size: 13px;
      color: #374151;
      margin-bottom: 4px;
      display: block;
    }
    input, select, textarea {
      width: 100%;
      padding: 8px 10px;
      border-radius: 10px;
      border: 1px solid #d1d5db;
      font-size: 13px;
    }
    textarea { resize: vertical; min-height: 60px; }
    input:focus, select:focus, textarea:focus {
      outline: none;
      border-color: #fb7185;
      box-shadow: 0 0 0 2px rgba(251,113,133,0.2);
    }
    .btn {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      padding: 8px 14px;
      border-radius: 999px;
      border: none;
      background: linear-gradient(90deg,#fb7185,#f97316);
      color: white;
      font-size: 13px;
      font-weight: 600;
      cursor: pointer;
      margin-top: 4px;
    }
    .btn.secondary { background: #e5e7eb; color: #111827; }
    .btn.sm { padding: 4px 10px; font-size: 12px; }
    .btn.danger { background: #ef4444; color: #fff; }
    .flex { display: flex; gap: 8px; align-items: center; }
    .mt-8  { margin-top: 8px; }
    .mt-12 { margin-top: 12px; }
    .mt-16 { margin-top: 16px; }
    .list {
      margin-top: 8px;
      border-top: 1px solid #e5e7eb;
      padding-top: 8px;
      max-height: 260px;
      overflow-y: auto;
      font-size: 13px;
    }
    /* 1-1 新增人員列表不要捲動，直接展開 */
    #staff-list {
      max-height: none;
      overflow: visible;
    }

    .badge {
      display: inline-block;
      padding: 2px 8px;
      border-radius: 999px;
      font-size: 11px;
      background: #f3f4f6;
      color: #4b5563;
      margin-right: 4px;
    }
    details {
      border-radius: 10px;
      background: #f9fafb;
      padding: 6px 10px;
      margin-bottom: 6px;
    }
    summary { cursor: pointer; font-size: 13px; font-weight: 600; }
    .staff-pill {
      display: inline-flex;
      align-items: center;
      padding: 3px 8px;
      border-radius: 999px;
      background: #e5e7eb;
      margin: 4px 4px 0 0;
    }
    .staff-pill button {
      margin-left: 4px;
      border: none;
      background: transparent;
      cursor: pointer;
      font-size: 12px;
      color: #6b7280;
    }
    .topbar {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 16px;
    }
    .topbar .info { font-size: 13px; color: #6b7280; }

    /* 餐廳卡片 */
    .restaurant-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit,minmax(180px,1fr));
      gap: 16px;
      margin-top: 8px;
    }
    .restaurant-card {
      background: #f9fafb;
      border-radius: 14px;
      padding: 8px;
      cursor: pointer;
      transition: transform 0.1s ease, box-shadow 0.1s ease;
      box-shadow: 0 0 0 rgba(0,0,0,0);
    }
    .restaurant-card:hover {
      transform: translateY(-2px);
      box-shadow: 0 8px 18px rgba(15,23,42,0.12);
    }
    .restaurant-card img {
      width: 100%;
      height: 120px;
      object-fit: cover;
      border-radius: 10px;
      background: #e5e7eb;
    }
    .restaurant-card-name {
      margin-top: 6px;
      font-size: 14px;
      font-weight: 600;
      color: #111827;
    }
    .restaurant-card-sub {
      font-size: 12px;
      color: #6b7280;
    }

    /* 餐點表格（1-3） */
    table { border-collapse: collapse; width: 100%; }
    th, td {
      padding: 6px 8px;
      border-bottom: 1px solid #e5e7eb;
      text-align: left;
    }
    th {
      background:#f9fafb;
      font-size:12px;
      color:#6b7280;
    }
    td { font-size:13px; }

    /* 1-2 多筆餐點 block */
    .menu-item-block {
      background: #f9fafb;
      border-radius: 12px;
      padding: 10px 12px;
      margin-top: 10px;
    }
    .addon-row {
      display: flex;
      gap: 8px;
      align-items: center;
      margin-top: 8px;
      flex-wrap: wrap;
    }
    .addon-row input[type="text"] {
      flex: 1 1 120px;
    }
    .addon-row input[type="number"] {
      width: 80px;
    }
  </style>
</head>
<body>
  <!-- 左側選單 -->
  <aside class="sidebar">
    <div>
      <h2>管理者後台</h2>
      <div style="font-size:12px;color:#9ca3af;">GoldBricks 訂餐系統</div>
    </div>
    <ul class="menu" id="menu">
      <li data-target="section-add-staff">1-1 新增人員</li>
      <li data-target="section-add-restaurant" class="active">1-2 新增餐廳</li>
      <li data-target="section-restaurants">1-3 餐廳管理（總覽）</li>
      <li data-target="section-orders">1-4 訂餐紀錄</li>
      <li data-target="section-stats">1-5 訂單統計</li>
      <li id="switchToUser">1-6 切換使用者模式</li>
      <li id="logout">1-7 登出</li>
    </ul>
  </aside>

  <!-- 右側內容 -->
  <main class="main">
    <div class="topbar">
      <div>
        <h3>新增餐廳</h3>
        <div class="info">填完餐廳資料與多筆餐點後，按「新增店家」一次建立。</div>
      </div>
      <div class="info">目前身分：管理者</div>
    </div>

    <!-- 1-2 新增餐廳（一頁式 + 多筆餐點） -->
    <section id="section-add-restaurant" class="section active">
      <div class="card">
        <h3>1-2 新增餐廳</h3>

        <!-- 餐廳資料 -->
        <div class="group mt-8">
          <div>
            <label>餐廳名稱</label>
            <input id="rest-name" placeholder="例：小王便當" />
          </div>
          <div>
            <label>電話</label>
            <input id="rest-phone" placeholder="02-1234-5678" />
          </div>
          <div>
            <label>地址</label>
            <input id="rest-address" placeholder="台北市..." />
          </div>
          <div>
            <label>Google Map 連結</label>
            <input id="rest-map" placeholder="Google Map URL" />
          </div>
          <div>
            <label>店家圖片</label>
            <input type="file" id="rest-image" accept="image/*" />
          </div>
        </div>
        <div class="mt-8">
          <label>備註</label>
          <textarea id="rest-note" placeholder="例如：只收現金、可先電話預訂等..."></textarea>
        </div>

        <hr style="margin:16px 0;border:none;border-top:1px solid #e5e7eb;">

        <!-- 多筆餐點 -->
        <h4 style="font-size:15px;margin-bottom:6px;">餐點管理（可新增多筆）</h4>
        <div id="new-menu-items"></div>
        <button class="btn secondary sm mt-8" id="btn-add-menu-row">＋ 新增一筆餐點</button>

        <button class="btn mt-12" id="btn-create-restaurant">新增店家</button>

        <div class="mt-16">
          <div style="font-size:13px;color:#6b7280;margin-bottom:4px;">目前已建立店家</div>
          <div class="list" id="restaurant-list"></div>
        </div>
      </div>
    </section>

    <!-- 1-3 餐廳管理（總覽 & 編輯） -->
    <section id="section-restaurants" class="section">
      <div class="card">
        <h3>1-3 餐廳管理（點圖片可編輯）</h3>
        <div class="restaurant-grid" id="restaurant-cards"></div>
      </div>

      <div class="card" id="restaurant-edit-panel" style="display:none;">
        <h3>編輯餐廳資訊</h3>
        <div class="group mt-8">
          <div>
            <label>餐廳名稱</label>
            <input id="edit-rest-name" />
          </div>
          <div>
            <label>電話</label>
            <input id="edit-rest-phone" />
          </div>
          <div>
            <label>地址</label>
            <input id="edit-rest-address" />
          </div>
          <div>
            <label>Google Map 連結</label>
            <input id="edit-rest-map" />
          </div>
        </div>
        <div class="mt-8">
          <label>備註</label>
          <textarea id="edit-rest-note"></textarea>
        </div>
        <button class="btn mt-12" id="btn-save-rest">儲存餐廳修改</button>

        <!-- 餐點列表（表格 + 編輯 + 刪除） -->
        <div class="mt-16">
          <h4 style="font-size:15px;margin-bottom:6px;">餐點列表（可編輯 / 刪除）</h4>
          <div style="overflow-x:auto;">
            <table>
              <thead>
                <tr>
                  <th>#</th>
                  <th>類別</th>
                  <th>餐點名稱</th>
                  <th>價格</th>
                  <th>預設數量</th>
                  <th>加購</th>
                  <th>操作</th>
                </tr>
              </thead>
              <tbody id="edit-menu-table-body"></tbody>
            </table>
          </div>
        </div>

        <button class="btn danger mt-12" id="btn-delete-rest">刪除此店家</button>
      </div>
    </section>

    <!-- 1-4 訂餐紀錄 -->
    <section id="section-orders" class="section">
      <div class="card">
        <h3>1-4 訂餐紀錄</h3>
        <div class="group mt-8" style="max-width:320px;">
          <div>
            <label>訂單日期</label>
            <input type="date" id="order-date" />
          </div>
        </div>
        <div class="mt-8" style="font-size:13px;color:#6b7280;">
          之後會顯示彙整：排骨飯70+蛋10 數量2；排骨飯70 數量1；豬腳飯80+菜30 數量1 …  
          目前先預留版位。
        </div>
      </div>
    </section>

    <!-- 1-5 訂單統計 -->
    <section id="section-stats" class="section">
      <div class="card">
        <h3>1-5 訂單統計</h3>
        <div class="group mt-8" style="max-width:420px;">
          <div>
            <label>訂單日期</label>
            <input type="date" id="stats-date" />
          </div>
          <div>
            <label>統計模式</label>
            <select id="stats-mode">
              <option value="byMeal">依餐點統計</option>
              <option value="byPerson">依人員統計</option>
              <option value="byDept">依部門統計</option>
            </select>
          </div>
        </div>
        <div class="mt-8" style="font-size:13px;color:#6b7280;">
          之後可在這裡顯示各種統計圖表與報表。
        </div>
      </div>
    </section>

    <!-- 1-1 新增人員 -->
    <section id="section-add-staff" class="section">
      <div class="card">
        <h3>1-1 新增人員</h3>
        <div class="group mt-8" style="max-width:520px;">
          <div>
            <label>部門</label>
            <select id="staff-dept">
              <option value="管理部">管理部</option>
              <option value="FAE">FAE</option>
              <option value="TSE">TSE</option>
              <option value="新場">新場</option>
              <option value="倉管">倉管</option>
              <option value="數據分析">數據分析</option>
              <option value="RD">RD</option>
              <option value="線上客服">線上客服</option>
              <option value="維運">維運</option>
            </select>
          </div>
          <div>
            <label>人員名稱</label>
            <div class="flex">
              <input id="staff-name" placeholder="輸入人名" />
              <button class="btn sm" id="btn-add-staff">新增</button>
            </div>
          </div>
        </div>
        <div class="list" id="staff-list"></div>
      </div>
    </section>
  </main>

  <script>
    // 左側選單切換
    const menu = document.getElementById("menu");
    const sections = document.querySelectorAll(".section");
    menu.addEventListener("click", (e) => {
      const li = e.target.closest("li");
      if (!li) return;
      const target = li.dataset.target;
      if (!target) return;

      menu.querySelectorAll("li").forEach(item => item.classList.remove("active"));
      li.classList.add("active");

      sections.forEach(sec => {
        sec.classList.toggle("active", sec.id === target);
      });

      const titleMap = {
        "section-add-staff": "新增人員",
        "section-add-restaurant": "新增餐廳",
        "section-restaurants": "餐廳管理",
        "section-orders": "訂餐紀錄",
        "section-stats": "訂單統計"
      };
      const topTitle = document.querySelector(".topbar h3");
      if (titleMap[target]) topTitle.textContent = titleMap[target];
    });

    // 切換使用者 / 登出（帶確認）
    document.getElementById("switchToUser").addEventListener("click", () => {
      const confirmSwitch = window.confirm("要切換成使用者模式嗎？\n\n按「確定」：切換模式\n按「取消」：直接登出");
      if (confirmSwitch) {
        localStorage.setItem("role", "user");
        window.location.href = "user.html";
      } else {
        localStorage.removeItem("role");
        window.location.href = "index.html";
      }
    });

    document.getElementById("logout").addEventListener("click", () => {
      localStorage.removeItem("role");
      window.location.href = "index.html";
    });

    // ===== 全域資料結構（之後可換成 Firebase） =====
    const restaurants = [];   // {id,name,phone,address,map,note,image}
    const menus = [];         // {id,restaurantId,category,name,price,defaultQty,addons}
    const staffByDept = {};   // dept -> [name,...]
    const categoryHistory = []; // 餐點類別歷史（1-2 用）

    // ===== 1-2 新增餐廳 & 多筆餐點 =====
    const restNameInput = document.getElementById("rest-name");
    const restPhoneInput = document.getElementById("rest-phone");
    const restAddressInput = document.getElementById("rest-address");
    const restMapInput = document.getElementById("rest-map");
    const restNoteInput = document.getElementById("rest-note");
    const restImageInput = document.getElementById("rest-image");
    const restListDiv = document.getElementById("restaurant-list");
    const restCardsDiv = document.getElementById("restaurant-cards");

    const menuItemsContainer = document.getElementById("new-menu-items");
    const btnAddMenuRow = document.getElementById("btn-add-menu-row");
    const btnCreateRestaurant = document.getElementById("btn-create-restaurant");

    const categoryList = document.getElementById("category-list");

    function updateCategoryDatalist() {
      categoryList.innerHTML = "";
      categoryHistory.forEach(cat => {
        const opt = document.createElement("option");
        opt.value = cat;
        categoryList.appendChild(opt);
      });
    }

    function addCategoryToHistory(cat) {
      const c = (cat || "").trim();
      if (!c) return;
      if (!categoryHistory.includes(c)) {
        categoryHistory.push(c);
        updateCategoryDatalist();
      }
    }

    function renderRestaurantsList() {
      restListDiv.innerHTML = "";
      restaurants.forEach((r, idx) => {
        const row = document.createElement("div");
        row.textContent = `${idx + 1}. ${r.name} / ${r.phone || ""} / ${r.address || ""}`;
        restListDiv.appendChild(row);
      });
    }

    function renderRestaurantCards() {
      restCardsDiv.innerHTML = "";
      restaurants.forEach(r => {
        const card = document.createElement("div");
        card.className = "restaurant-card";
        card.dataset.id = r.id;

        const img = document.createElement("img");
        if (r.image) img.src = r.image;
        card.appendChild(img);

        const nameDiv = document.createElement("div");
        nameDiv.className = "restaurant-card-name";
        nameDiv.textContent = r.name || "未命名餐廳";
        card.appendChild(nameDiv);

        const subDiv = document.createElement("div");
        subDiv.className = "restaurant-card-sub";
        subDiv.textContent = r.address || "";
        card.appendChild(subDiv);

        card.addEventListener("click", () => openEditRestaurant(r.id));
        restCardsDiv.appendChild(card);
      });
    }

    // 建立一筆餐點 block（A：沿用上一筆內容）
    function createMenuItemBlock(prefill = null) {
      const block = document.createElement("div");
      block.className = "menu-item-block";

      const categoryVal = prefill?.category || "";
      const nameVal = prefill?.name || "";
      const priceVal = prefill?.price ?? "0";
      const qtyVal = prefill?.qty ?? "1";

      block.innerHTML = `
        <div class="group">
          <div>
            <label>餐點類別</label>
            <input class="mi-category" placeholder="輸入餐點類別，如：飯類 / 湯品 / 飲料" value="${categoryVal}"/>
          </div>
          <div>
            <label>餐點名稱</label>
            <input class="mi-name" placeholder="例：排骨飯" value="${nameVal}"/>
          </div>
          <div>
            <label>價格（單份）</label>
            <input class="mi-price" type="number" min="0" step="1" value="${priceVal}"/>
          </div>
          <div>
            <label>預設數量</label>
            <input class="mi-qty" type="number" min="1" step="1" value="${qtyVal}"/>
          </div>
        </div>
        <div class="mt-8">
          <label>加購項目</label>
          <div class="addons-container"></div>
          <button type="button" class="btn secondary sm mt-8 btn-add-addon">＋ 新增加購</button>
        </div>
        <div class="mt-8" style="text-align:right;">
          <button type="button" class="btn secondary sm btn-remove-menu">刪除此餐點</button>
        </div>
      `;

      const addonsContainer = block.querySelector(".addons-container");
      const btnAddAddonInBlock = block.querySelector(".btn-add-addon");
      const btnRemoveMenu = block.querySelector(".btn-remove-menu");

      function addAddonRow(prefillAddon = null) {
        const addonRow = document.createElement("div");
        addonRow.className = "addon-row";
        addonRow.innerHTML = `
          <input type="text" class="addon-name" placeholder="加購名稱，如：加蛋" value="${prefillAddon?.name || ""}">
          <input type="number" class="addon-price" min="0" step="1" value="${prefillAddon?.price ?? "0"}">
          <label class="flex" style="gap:4px;">
            <input type="checkbox" class="addon-free" ${prefillAddon?.free ? "checked" : ""}>
            免費
          </label>
          <button type="button" class="btn secondary sm btn-remove-addon">刪除</button>
        `;
        const freeCheckbox = addonRow.querySelector(".addon-free");
        const priceInput = addonRow.querySelector(".addon-price");
        const removeBtn = addonRow.querySelector(".btn-remove-addon");

        freeCheckbox.addEventListener("change", () => {
          if (freeCheckbox.checked) {
            priceInput.value = "0";
          }
        });

        removeBtn.addEventListener("click", () => {
          addonsContainer.removeChild(addonRow);
        });

        addonsContainer.appendChild(addonRow);
      }

      // 預設一列加購（空白）
      addAddonRow();

      btnAddAddonInBlock.addEventListener("click", () => {
        addAddonRow();
      });

      btnRemoveMenu.addEventListener("click", () => {
        if (menuItemsContainer.children.length > 1) {
          menuItemsContainer.removeChild(block);
        } else {
          // 若只剩一筆，就清空欄位
          block.querySelector(".mi-category").value = "";
          block.querySelector(".mi-name").value = "";
          block.querySelector(".mi-price").value = "0";
          block.querySelector(".mi-qty").value = "1";
          addonsContainer.innerHTML = "";
          addAddonRow();
        }
      });

      menuItemsContainer.appendChild(block);
    }

    // 一開始先有一筆空白餐點
    createMenuItemBlock();

    // ＋新增一筆餐點（沿用上一筆內容）
    btnAddMenuRow.addEventListener("click", () => {
      const last = menuItemsContainer.lastElementChild;
      let prefill = null;
      if (last) {
        prefill = {
          category: last.querySelector(".mi-category").value,
          name: last.querySelector(".mi-name").value,
          price: last.querySelector(".mi-price").value,
          qty: last.querySelector(".mi-qty").value
        };
      }
      createMenuItemBlock(prefill);
    });

    // 新增店家（建立餐廳＋多筆餐點）
    btnCreateRestaurant.addEventListener("click", () => {
      const name = restNameInput.value.trim();
      if (!name) {
        alert("請輸入餐廳名稱");
        return;
      }

      const menuBlocks = menuItemsContainer.querySelectorAll(".menu-item-block");
      if (!menuBlocks.length) {
        alert("請至少新增一筆餐點");
        return;
      }

      const newMenus = [];
      menuBlocks.forEach(block => {
        const mName = block.querySelector(".mi-name").value.trim();
        const mCat = block.querySelector(".mi-category").value.trim();
        const mPrice = Number(block.querySelector(".mi-price").value || "0");
        const mQty = Number(block.querySelector(".mi-qty").value || "1");

        if (!mName) return; // 沒填餐點名稱就略過

        const addons = [];
        block.querySelectorAll(".addon-row").forEach(row => {
          const aname = row.querySelector(".addon-name").value.trim();
          const free = row.querySelector(".addon-free").checked;
          let price = Number(row.querySelector(".addon-price").value || "0");
          if (free) price = 0;
          if (aname) addons.push({ name: aname, price, free });
        });

        newMenus.push({
          category: mCat,
          name: mName,
          price: mPrice,
          defaultQty: mQty,
          addons
        });

        addCategoryToHistory(mCat);
      });

      if (!newMenus.length) {
        alert("請至少輸入一筆完整餐點（需有餐點名稱）");
        return;
      }

      // 建立餐廳
      const restId = Date.now().toString();
      const restObj = {
        id: restId,
        name,
        phone: restPhoneInput.value.trim(),
        address: restAddressInput.value.trim(),
        map: restMapInput.value.trim(),
        note: restNoteInput.value.trim(),
        image: null
      };
      restaurants.push(restObj);

      // 處理圖片（非同步）
      const file = restImageInput.files[0];
      if (file) {
        const reader = new FileReader();
        reader.onload = (e) => {
          restObj.image = e.target.result;
          renderRestaurantCards();
        };
        reader.readAsDataURL(file);
      }

      // 加入多筆餐點
      newMenus.forEach(m => {
        menus.push({
          id: restId + "_" + Math.random().toString(36).slice(2, 8),
          restaurantId: restId,
          category: m.category,
          name: m.name,
          price: m.price,
          defaultQty: m.defaultQty,
          addons: m.addons
        });
      });

      renderRestaurantsList();
      renderRestaurantCards();

      // 清空餐廳與餐點輸入
      restNameInput.value = "";
      restPhoneInput.value = "";
      restAddressInput.value = "";
      restMapInput.value = "";
      restNoteInput.value = "";
      restImageInput.value = "";

      menuItemsContainer.innerHTML = "";
      createMenuItemBlock();

      alert("已新增店家與餐點");
    });

    // ===== 1-3 餐廳管理（點卡片可編輯 / 刪除餐點 / 刪除店家） =====
    const editPanel = document.getElementById("restaurant-edit-panel");
    const editNameInput = document.getElementById("edit-rest-name");
    const editPhoneInput = document.getElementById("edit-rest-phone");
    const editAddressInput = document.getElementById("edit-rest-address");
    const editMapInput = document.getElementById("edit-rest-map");
    const editNoteInput = document.getElementById("edit-rest-note");
    const editMenuTableBody = document.getElementById("edit-menu-table-body");
    const btnDeleteRest = document.getElementById("btn-delete-rest");
    let editingRestaurantId = null;

    function openEditRestaurant(id) {
      const r = restaurants.find(x => x.id === id);
      if (!r) return;
      editingRestaurantId = id;
      editNameInput.value = r.name || "";
      editPhoneInput.value = r.phone || "";
      editAddressInput.value = r.address || "";
      editMapInput.value = r.map || "";
      editNoteInput.value = r.note || "";
      editPanel.style.display = "block";
      renderEditMenusTable();

      // 左側選單切到 1-3
      menu.querySelectorAll("li").forEach(li => li.classList.remove("active"));
      const li = Array.from(menu.querySelectorAll("li")).find(li => li.dataset.target === "section-restaurants");
      if (li) li.classList.add("active");
      sections.forEach(sec => {
        sec.classList.toggle("active", sec.id === "section-restaurants");
      });
      document.querySelector(".topbar h3").textContent = "餐廳管理";
    }

    function renderEditMenusTable() {
      editMenuTableBody.innerHTML = "";
      if (!editingRestaurantId) return;
      const list = menus.filter(m => m.restaurantId === editingRestaurantId);

      list.forEach((m, idx) => {
        const tr = document.createElement("tr");
        const addonText = m.addons
          .map(a => `${a.name}${a.free ? "(免費)" : `+${a.price}`}`)
          .join("、") || "無";

        tr.innerHTML = `
          <td>${idx + 1}</td>
          <td><input data-field="category" data-id="${m.id}" value="${m.category || ""}" style="width:100%;"></td>
          <td><input data-field="name" data-id="${m.id}" value="${m.name}" style="width:100%;"></td>
          <td><input data-field="price" data-id="${m.id}" type="number" min="0" step="1" value="${m.price}"></td>
          <td><input data-field="defaultQty" data-id="${m.id}" type="number" min="1" step="1" value="${m.defaultQty}"></td>
          <td style="font-size:12px;color:#6b7280;">${addonText}</td>
          <td>
            <button class="btn secondary sm" data-action="save" data-id="${m.id}">儲存</button>
            <button class="btn secondary sm" data-action="delete" data-id="${m.id}">刪除</button>
          </td>
        `;
        editMenuTableBody.appendChild(tr);
      });

      // 綁定操作
      editMenuTableBody.querySelectorAll("button[data-action]").forEach(btn => {
        btn.addEventListener("click", () => {
          const id = btn.getAttribute("data-id");
          const action = btn.getAttribute("data-action");
          const index = menus.findIndex(x => x.id === id);
          if (index === -1) return;

          if (action === "delete") {
            menus.splice(index, 1);
          } else if (action === "save") {
            const rowInputs = editMenuTableBody.querySelectorAll(`input[data-id="${id}"]`);
            rowInputs.forEach(inp => {
              const field = inp.getAttribute("data-field");
              let val = inp.value;
              if (field === "price" || field === "defaultQty") {
                val = Number(val || "0");
              }
              menus[index][field] = val;
            });
            alert("已儲存餐點修改");
          }
          renderEditMenusTable();
        });
      });
    }

    document.getElementById("btn-save-rest").addEventListener("click", () => {
      if (!editingRestaurantId) return;
      const r = restaurants.find(x => x.id === editingRestaurantId);
      if (!r) return;
      r.name = editNameInput.value.trim();
      r.phone = editPhoneInput.value.trim();
      r.address = editAddressInput.value.trim();
      r.map = editMapInput.value.trim();
      r.note = editNoteInput.value.trim();
      renderRestaurantsList();
      renderRestaurantCards();
      alert("已儲存餐廳資訊");
    });

    btnDeleteRest.addEventListener("click", () => {
      if (!editingRestaurantId) return;
      const r = restaurants.find(x => x.id === editingRestaurantId);
      if (!r) return;
      const ok = window.confirm(`確定要刪除店家「${r.name}」以及所有餐點嗎？`);
      if (!ok) return;

      const idx = restaurants.findIndex(x => x.id === editingRestaurantId);
      if (idx !== -1) restaurants.splice(idx, 1);

      for (let i = menus.length - 1; i >= 0; i--) {
        if (menus[i].restaurantId === editingRestaurantId) menus.splice(i, 1);
      }

      editingRestaurantId = null;
      editPanel.style.display = "none";
      renderRestaurantsList();
      renderRestaurantCards();
    });

    // ===== 1-1 新增人員 =====
    const staffDeptSelect = document.getElementById("staff-dept");
    const staffNameInput = document.getElementById("staff-name");
    const staffListDiv = document.getElementById("staff-list");

    function renderStaff() {
      staffListDiv.innerHTML = "";
      const depts = ["管理部","FAE","TSE","新場","倉管","數據分析","RD","線上客服","維運"];
      depts.forEach(dept => {
        const people = staffByDept[dept] || [];
        const detailsEl = document.createElement("details");
        detailsEl.open = true;
        const summary = document.createElement("summary");
        summary.textContent = `${dept}（${people.length} 人）`;
        detailsEl.appendChild(summary);
        const inner = document.createElement("div");
        people.forEach((name, idx) => {
          const pill = document.createElement("div");
          pill.className = "staff-pill";
          pill.innerHTML = `
            <span>${name}</span>
            <button type="button" data-idx="${idx}" data-dept="${dept}">✕</button>`;
          inner.appendChild(pill);
        });
        detailsEl.appendChild(inner);
        staffListDiv.appendChild(detailsEl);
      });

      staffListDiv.querySelectorAll(".staff-pill button").forEach(btn => {
        btn.addEventListener("click", () => {
          const dept = btn.dataset.dept;
          const idx = Number(btn.dataset.idx);
          staffByDept[dept].splice(idx, 1);
          renderStaff();
        });
      });
    }

    function addStaff() {
      const dept = staffDeptSelect.value;
      const name = staffNameInput.value.trim();
      if (!name) {
        alert("請輸入人員名稱");
        return;
      }
      if (!staffByDept[dept]) staffByDept[dept] = [];
      staffByDept[dept].push(name);
      staffNameInput.value = "";
      renderStaff();
    }

    document.getElementById("btn-add-staff").addEventListener("click", addStaff);
    staffNameInput.addEventListener("keydown", (e) => {
      if (e.key === "Enter") {
        e.preventDefault();
        addStaff();
      }
    });

    renderStaff();

    // 簡單身分驗證
    (function checkRole() {
      const role = localStorage.getItem("role");
      if (role !== "admin") {
        window.location.href = "index.html";
      }
    })();
  </script>
</body>
</html>
