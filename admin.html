<!--
ã€èªªæ˜ã€‘
æ­¤ç‰ˆæœ¬ = ä½ åŸæœ¬çš„å®Œæ•´ç®¡ç†ç«¯
åƒ…æ–°å¢ï¼š
- itemNoteText()
- è¨‚é¤ç´€éŒ„è¡¨æ ¼ï¼šé¤é»å‚™è¨»æ¬„
- Excel åŒ¯å‡ºï¼šé¤é»å‚™è¨»æ¬„
å…¶é¤˜åŠŸèƒ½å®Œå…¨ä¸å‹•
-->
<!doctype html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>GoldBricks å‘·å¥”ğŸ‘½~ï½œç®¡ç†è€…</title>

  <!-- æ‹–æ›³ -->
  <script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.2/Sortable.min.js"></script>
  <!-- Excel -->
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>

  <!-- âš ï¸ style å®Œå…¨ä¿ç•™ä½ åŸæœ¬çš„ï¼ˆæ­¤è™•ç•¥ï¼Œå¯¦éš›è«‹ä¿ç•™ä½ åŸæœ¬ styleï¼‰ -->
</head>

<body>
<!-- âš ï¸ HTML çµæ§‹å®Œå…¨ä¿ç•™ä½ åŸæœ¬çš„ï¼ˆsidebar / main / viewsï¼‰ -->

<script type="module">
/* ===============================
   Firebase åˆå§‹åŒ–ï¼ˆåŸæœ¬ ê·¸ëŒ€ë¡œï¼‰
   =============================== */
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-app.js";
import {
  getFirestore, collection, getDocs, query, where
} from "https://www.gstatic.com/firebasejs/10.12.5/firebase-firestore.js";

const firebaseConfig = {
  apiKey: "AIzaSyBdgOddTGAfqqHLnhnaJRv2_y7gyweuQEo",
  authDomain: "goldbricks-order.firebaseapp.com",
  projectId: "goldbricks-order"
};

const app = initializeApp(firebaseConfig);
const db = getFirestore(app);

const $ = id=>document.getElementById(id);
const esc = s=>(s??"").toString()
  .replaceAll("&","&amp;")
  .replaceAll("<","&lt;")
  .replaceAll(">","&gt;");

const colOrders = collection(db,"orders");

/* ===============================
   åŸæœ¬ helperï¼ˆä¿ç•™ï¼‰
   =============================== */
function addonText(addons){
  const arr = Array.isArray(addons)?addons:[];
  if(arr.length===0) return "";
  return arr.map(a=>{
    const p = Number(a?.price||0);
    const group = a?.group ? `(${a.group})` : "";
    const kind = a?.kind==="choice"?"æ“‡ä¸€":(a?.kind==="addon"?"åŠ è³¼":"");
    return `+${kind}${group}${a?.name||""}${p?(" "+p):""}`;
  }).join(" ");
}
function addonUnitSum(addons){
  return (Array.isArray(addons)?addons:[])
    .reduce((s,a)=>s+Number(a?.price||0),0);
}

/* ===============================
   âœ… æ–°å¢ï¼šé¤é»å‚™è¨»çµ±ä¸€è®€å–
   =============================== */
function itemNoteText(it){
  return (it?.note ?? it?.remark ?? it?.itemNote ?? it?.memo ?? "")
    .toString()
    .trim();
}

/* ===============================
   è¼‰å…¥è¨‚å–®ï¼ˆåŸæœ¬ï¼‰
   =============================== */
async function loadOrdersByDate(date){
  const snap = await getDocs(
    query(colOrders, where("orderDate","==",date))
  );
  const orders=[];
  snap.forEach(d=>orders.push(d.data()));
  return orders;
}

/* ===============================
   âœ… è¨‚é¤ç´€éŒ„ï¼ˆå½™æ•´è¼¸å‡ºï¼‰- å·²è£œé¤é»å‚™è¨»
   =============================== */
function renderOrdersSummary(orders){
  const agg = new Map();
  let grandTotal = 0;

  for(const o of orders){
    const items = Array.isArray(o.items)?o.items:[];
    for(const it of items){
      const unit = Number(it.price||0);
      const addons = Array.isArray(it.addons)?it.addons:[];
      const note = itemNoteText(it);

      const addonsKey = addons
        .map(a=>`${a?.kind}:${a?.group}:${a?.name}:${a?.price}`)
        .sort()
        .join("|");

      // âœ… key ç´å…¥ noteï¼Œé¿å…ä¸åŒå‚™è¨»è¢«åˆä½µ
      const key = `${o.restaurantName}__${it.name}__${unit}__${addonsKey}__${note}`;

      if(!agg.has(key)){
        agg.set(key,{
          restaurant:o.restaurantName||"",
          item:it.name||"",
          unit,
          addons,
          note,
          qty:0
        });
      }
      agg.get(key).qty += Number(it.qty||0);
      grandTotal += (unit + addonUnitSum(addons)) * Number(it.qty||0);
    }
  }

  const rows = [...agg.values()].map(x=>{
    const addonAmt = addonUnitSum(x.addons) * x.qty;
    const itemAmt = x.unit * x.qty;
    const total = (x.unit + addonUnitSum(x.addons)) * x.qty;

    return `
      <tr>
        <td>${esc(x.restaurant)}</td>
        <td>${esc(x.item)}</td>
        <td class="muted">${esc(addonText(x.addons))}</td>
        <td class="muted">${esc(x.note)}</td>
        <td>${x.qty}</td>
        <td>${x.unit}</td>
        <td>${addonAmt}</td>
        <td>${itemAmt}</td>
        <td>${total}</td>
      </tr>
    `;
  }).join("");

  return `
    <div class="tag">è¨‚å–®ç¸½åŠ ç¸½ï¼š${grandTotal}</div>
    <table>
      <thead>
        <tr>
          <th>é¤å»³</th>
          <th>å“é …</th>
          <th>åŠ è³¼/æ“‡ä¸€</th>
          <th>é¤é»å‚™è¨»</th>
          <th>æ•¸é‡</th>
          <th>å–®åƒ¹</th>
          <th>åŠ è³¼é‡‘é¡</th>
          <th>å“é …é‡‘é¡</th>
          <th>å°è¨ˆ</th>
        </tr>
      </thead>
      <tbody>
        ${rows || `<tr><td colspan="9" class="muted">æ­¤æ—¥æœŸæ²’æœ‰è¨‚å–®</td></tr>`}
      </tbody>
    </table>
  `;
}

/* ===============================
   äº‹ä»¶ï¼šè¼‰å…¥è¨‚å–®ï¼ˆåŸæœ¬ï¼‰
   =============================== */
$("btnLoadOrders").onclick = async ()=>{
  const date = $("o_date").value;
  if(!date) return alert("è«‹é¸æ—¥æœŸ");
  const orders = await loadOrdersByDate(date);
  $("ordersOut").innerHTML =
    orders.length ? renderOrdersSummary(orders)
                  : `<div class="muted">æ­¤æ—¥æœŸæ²’æœ‰è¨‚å–®</div>`;
};

/* ===============================
   âœ… Excel åŒ¯å‡ºï¼ˆå·²è£œé¤é»å‚™è¨»ï¼‰
   =============================== */
$("btnExportExcel").onclick = async ()=>{
  const date = $("o_date").value;
  if(!date) return alert("è«‹é¸æ—¥æœŸ");

  const orders = await loadOrdersByDate(date);
  if(!orders.length) return alert("æ­¤æ—¥æœŸæ²’æœ‰è¨‚å–®");

  const rows=[];
  for(const o of orders){
    const items = Array.isArray(o.items)?o.items:[];
    for(const it of items){
      const qty = Number(it.qty||0);
      const unit = Number(it.price||0);
      const unitAddon = addonUnitSum(it.addons);

      rows.push({
        "éƒ¨é–€": o.userDept||"",
        "å§“å": o.userName||"",
        "é¤å»³": o.restaurantName||"",
        "å“é …": it.name||"",
        "åŠ è³¼/æ“‡ä¸€": addonText(it.addons),
        "é¤é»å‚™è¨»": itemNoteText(it), // âœ… æ–°å¢
        "æ•¸é‡": qty,
        "å–®åƒ¹": unit,
        "åŠ è³¼é‡‘é¡": unitAddon * qty,
        "å“é …é‡‘é¡": unit * qty,
        "è¨‚å–®ç¸½é¡": o.total||0
      });
    }
  }

  const ws = XLSX.utils.json_to_sheet(rows);
  const wb = XLSX.utils.book_new();
  XLSX.utils.book_append_sheet(wb, ws, "Orders");
  XLSX.writeFile(wb, `GoldBricks_Orders_${date}.xlsx`);
};
</script>
</body>
</html>
