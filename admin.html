<!doctype html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>GoldBricks å‘·å¥”å•Š~ï½œç®¡ç†è€…</title>
  <style>
    :root{
      --bg:#f5f4fb; --card:#fff; --text:#0f172a; --muted:#64748b;
      --primary:#fb7185; --primary2:#ff9a9e; --border:rgba(15,23,42,.10);
      --shadow:0 10px 30px rgba(15,23,42,.10);
      --radius:18px;
    }
    *{box-sizing:border-box}
    body{
      margin:0; font-family: ui-sans-serif, system-ui, -apple-system, "Segoe UI", Arial;
      background: radial-gradient(1200px 500px at 20% -10%, rgba(251,113,133,.22), transparent 60%),
                  radial-gradient(900px 500px at 100% 0%, rgba(255,154,158,.14), transparent 55%),
                  var(--bg);
      color:var(--text);
      min-height:100vh;
    }
    .layout{display:grid; grid-template-columns: 300px 1fr; gap:16px; padding:16px;}
    @media (max-width:980px){.layout{grid-template-columns:1fr}}
    .sidebar,.main{
      background: rgba(255,255,255,.78);
      border:1px solid var(--border);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      backdrop-filter: blur(10px);
    }
    .sidebar{padding:14px; position:sticky; top:16px; height: fit-content}
    .brand{display:flex; align-items:center; justify-content:space-between; gap:10px; padding:10px 10px 6px;}
    .brand h1{font-size:16px; margin:0}
    .brand small{color:var(--muted)}
    .nav{margin-top:10px; display:flex; flex-direction:column; gap:8px}
    .nav button{
      text-align:left; padding:11px 12px; border-radius:14px;
      border:1px solid var(--border); background:#fff; cursor:pointer;
      font-weight:800;
    }
    .nav button.active{
      border-color: rgba(251,113,133,.55);
      background: linear-gradient(90deg, rgba(251,113,133,.18), rgba(255,154,158,.10));
      box-shadow: 0 10px 22px rgba(251,113,133,.18);
    }

    .main{padding:14px}
    .topbar{display:flex; align-items:center; justify-content:space-between; gap:12px; padding:6px 6px 12px;}
    .topbar h2{margin:0; font-size:18px}
    .topbar .right{display:flex; gap:10px; align-items:center; flex-wrap:wrap}
    .pill{padding:8px 12px; border-radius:999px; border:1px solid var(--border); background:#fff; color:var(--muted); font-size:12.5px}
    .ghost{
      padding:9px 12px; border-radius:14px; border:1px solid var(--border);
      background:#fff; cursor:pointer; font-weight:800;
    }
    .primary{
      padding:9px 12px; border-radius:14px; border:none; cursor:pointer; font-weight:900;
      background: linear-gradient(90deg, var(--primary), var(--primary2));
      color:#fff; box-shadow: 0 14px 28px rgba(251,113,133,.22);
    }

    .grid{display:grid; grid-template-columns: 1fr 1fr; gap:14px}
    @media (max-width:980px){.grid{grid-template-columns:1fr}}
    .card{
      background:#fff; border:1px solid var(--border); border-radius:var(--radius);
      box-shadow: 0 8px 25px rgba(15,23,42,.07);
      padding:14px;
    }
    .card h3{margin:0 0 10px; font-size:15px}
    label{display:block; font-size:13px; color:var(--muted); margin:10px 0 6px;}
    input,select,textarea{
      width:100%; padding:11px 12px; border-radius:14px;
      border:1px solid var(--border); outline:none; background:#fff;
      font-size:14px;
    }
    textarea{min-height:92px; resize:vertical}
    input:focus,select:focus,textarea:focus{border-color: rgba(251,113,133,.7)}
    .row{display:grid; grid-template-columns: 1fr 1fr; gap:10px}
    .row3{display:grid; grid-template-columns: 1fr 1fr 1fr; gap:10px}
    .actions{display:flex; gap:10px; margin-top:12px; flex-wrap:wrap}
    .muted{color:var(--muted); font-size:12.5px; line-height:1.6}
    .hr{height:1px; background: var(--border); margin:12px 0}
    table{width:100%; border-collapse:collapse; font-size:13.5px}
    th,td{border-bottom:1px solid rgba(15,23,42,.08); padding:10px 8px; text-align:left; vertical-align:top}
    th{color:var(--muted); font-weight:900}
    .tag{display:inline-flex; padding:5px 10px; border-radius:999px; border:1px solid var(--border); background:#fff; color:var(--muted); font-size:12px}
    .btnSmall{
      padding:7px 10px; border-radius:12px; border:1px solid var(--border);
      background:#fff; cursor:pointer; font-weight:800; font-size:12.5px;
      white-space:nowrap;
    }
    .btnDanger{border-color: rgba(239,68,68,.35)}
    .btnDanger:hover{border-color: rgba(239,68,68,.60)}
    .btnOk:hover{border-color: rgba(16,185,129,.55)}
    details summary{cursor:pointer; font-weight:900}
    .inline{display:flex; gap:10px; align-items:center; flex-wrap:wrap}
    .imgPrev{width:100%; max-height:220px; object-fit:cover; border-radius:14px; border:1px solid var(--border)}
    .subcard{
      background: rgba(15,23,42,.02);
      border:1px dashed rgba(15,23,42,.18);
      border-radius:16px;
      padding:12px;
    }
    .kpi{display:flex; gap:10px; flex-wrap:wrap; margin-top:8px}
    .kpi .tag{font-weight:900}

    .stateGood{border-color: rgba(16,185,129,.35); color:#065f46; background:rgba(16,185,129,.08)}
    .stateBad{border-color: rgba(239,68,68,.35); color:#7f1d1d; background:rgba(239,68,68,.06)}

    .chkline{display:flex; align-items:center; gap:10px; flex-wrap:wrap}
    .chkline input[type="checkbox"]{width:18px; height:18px; margin:0}

    /* é¸é … Builder */
    .optWrap{margin-top:10px}
    .optGroupCard{
      border:1px solid rgba(15,23,42,.10);
      border-radius:16px;
      padding:10px 12px;
      background:#fff;
      margin-top:10px;
    }
    .optRow{
      display:flex; gap:10px; align-items:center; flex-wrap:wrap;
      margin-top:8px;
    }
    .optRow input[type="checkbox"]{width:18px;height:18px;margin:0}
    .mini{font-size:12px;color:var(--muted)}
    .jsonArea{min-height:90px;font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace; font-size:12.5px}
  </style>
</head>
<body>

  <div class="layout">
    <aside class="sidebar">
      <div class="brand">
        <div>
          <h1>ç®¡ç†è€…å¾Œå°</h1>
          <small>GoldBricks Order</small>
        </div>
        <span class="tag">admin</span>
      </div>

      <div class="nav">
        <button class="navBtn" data-view="staff">ç®¡ç†äººå“¡</button>
        <button class="navBtn" data-view="addRestaurant">æ–°å¢é¤å»³</button>
        <button class="navBtn" data-view="restaurants">é¤å»³ç®¡ç†</button>
        <button class="navBtn" data-view="orders">è¨‚é¤ç´€éŒ„</button>
        <div class="hr"></div>
        <button id="switchUser" class="navBtn">åˆ‡æ›ä½¿ç”¨è€…æ¨¡å¼</button>
        <button id="logout" class="navBtn">ç™»å‡º</button>
      </div>

      <p class="muted" style="margin:12px 8px 0;">
        âœ… Firestoreï¼ˆä¸ä½¿ç”¨ Storageï¼‰<br/>
        âœ… é¤å»³ï¼šå¯é¡¯ç¤º/éš±è—ã€å¯çµå–®/é–‹å–®<br/>
        âœ… è¨‚å–®ï¼šæ”¯æ´ Excel åŒ¯å‡º<br/>
        âœ… é¤é»ï¼šæ”¯æ´åŠ è³¼ + é¸é …(optionGroups)
      </p>
    </aside>

    <main class="main">
      <div class="topbar">
        <h2 id="pageTitle">æ–°å¢é¤å»³</h2>
        <div class="right">
          <span class="pill" id="statusPill">é€£ç·šä¸­â€¦</span>
          <button class="ghost" id="gotoIndex">ğŸ°</button>
        </div>
      </div>

      <!-- VIEW: æ–°å¢é¤å»³ -->
      <section class="view" id="view_addRestaurant">
        <div class="grid">
          <div class="card">
            <h3>é¤å»³è³‡æ–™ï¼ˆå¡«å®Œå¾Œç›´æ¥æ–°å¢ä¸Šï¼‰</h3>

            <label>é¤å»³åç¨±</label>
            <input id="r_name" name="r_name_no_autofill" autocomplete="off" placeholder="ä¾‹ï¼šé‡‘ç£šä¾¿ç•¶"/>

            <div class="row">
              <div>
                <label>é›»è©±</label>
                <input id="r_phone" autocomplete="off" placeholder="ä¾‹ï¼š02-1234-5678"/>
              </div>
              <div>
                <label>åœ°å€</label>
                <input id="r_addr" autocomplete="off" placeholder="ä¾‹ï¼šå°åŒ—å¸‚â€¦"/>
              </div>
            </div>

            <div class="row">
              <div>
                <label>Google map é€£çµ</label>
                <input id="r_map" autocomplete="off" placeholder="https://maps.google.com/..."/>
              </div>
              <div>
                <label>é¤å»³åœ–ç‰‡ç¶²å€ï¼ˆå¯ç©ºï¼‰</label>
                <input id="r_imgUrl" autocomplete="off" placeholder="https://...jpg / png"/>
              </div>
            </div>

            <div class="row">
              <div class="chkline" style="margin-top:12px">
                <input id="r_visible" type="checkbox" checked>
                <label style="margin:0; color:var(--muted)">ä½¿ç”¨è€…é¡¯ç¤º</label>
              </div>
              <div class="chkline" style="margin-top:12px">
                <input id="r_closed" type="checkbox">
                <label style="margin:0; color:var(--muted)">çµå–®ï¼ˆä½¿ç”¨è€…ä¸å¯é€å–®ï¼‰</label>
              </div>
            </div>

            <img id="r_imgPrev" class="imgPrev" style="display:none; margin-top:10px" alt="preview"/>

            <label>å‚™è¨»</label>
            <textarea id="r_note" autocomplete="off" placeholder="å¯å¡«ç‡Ÿæ¥­æ™‚é–“ã€ä»˜æ¬¾æ–¹å¼â€¦"></textarea>

            <div class="actions">
              <button class="primary" id="btnSubmitAll">ç›´æ¥æ–°å¢ä¸Šï¼ˆé¤å»³ + é¤é»æ¸…å–®ï¼‰</button>
              <button class="ghost" id="btnClearAll" type="button">æ¸…ç©º</button>
            </div>

            <p class="muted">å³é‚Šå¯å…ˆæŠŠé¤é»åŠ å…¥æ¸…å–®ï¼Œå†æŒ‰ä¸€æ¬¡ã€Œç›´æ¥æ–°å¢ä¸Šã€ã€‚</p>
          </div>

          <div class="card">
            <h3>é¤é»ï¼ˆå…ˆåŠ å…¥æ¸…å–®ï¼Œå¯å¤šç­†ï¼‰</h3>

            <div class="row">
              <div>
                <label>é¤é»é¡åˆ¥ï¼ˆç”¨è¼¸å…¥ï¼‰</label>
                <input id="m_cat" placeholder="ä¾‹ï¼šé£¯é¡ / éºµé¡ / å°èœ / é£²æ–™"/>
              </div>
              <div>
                <label>é¤é»åç¨±</label>
                <input id="m_name" placeholder="ä¾‹ï¼šæ’éª¨é£¯"/>
              </div>
            </div>

            <div class="row">
              <div>
                <label>åƒ¹æ ¼ï¼ˆå–®ä»½ï¼‰</label>
                <input id="m_price" type="number" min="0" placeholder="70"/>
              </div>
              <div>
                <label>é è¨­æ•¸é‡</label>
                <input id="m_defaultQty" type="number" min="1" value="1"/>
              </div>
            </div>

            <div class="hr"></div>
            <h3 style="margin-top:0">åŠ è³¼é …ç›®ï¼ˆå¯å¤šç­†ï¼‰</h3>

            <div class="subcard">
              <div class="row3">
                <div>
                  <label>åŠ è³¼åç¨±</label>
                  <input id="a_name" placeholder="ä¾‹ï¼šè›‹"/>
                </div>
                <div>
                  <label>åŠ è³¼é‡‘é¡</label>
                  <input id="a_price" type="number" min="0" placeholder="10"/>
                </div>
                <div style="display:flex; align-items:end; gap:10px">
                  <label style="display:flex; align-items:center; gap:8px; margin:0;">
                    <input id="a_free" type="checkbox" style="width:18px; height:18px;"/>
                    å…è²»
                  </label>
                  <button class="btnSmall btnOk" id="btnAddAddon" type="button">åŠ å…¥åŠ è³¼</button>
                </div>
              </div>
              <div id="addonList" style="margin-top:10px"></div>
            </div>

            <div class="hr"></div>
            <h3 style="margin-top:0">é¸é …ï¼ˆoptionGroupsï¼‰â€” ä¸‹æ‹‰/å¤šé¸</h3>
            <p class="muted" style="margin-top:6px">
              ä¾‹ï¼šç¾¤çµ„ã€Œè‚‰é¡ã€(å¿…é¸/å–®é¸)ï¼šè±¬ã€é›ã€ç¾Šï¼›æˆ–ç¾¤çµ„ã€Œéºµé¡ã€(å¿…é¸/å–®é¸)ï¼šçƒé¾ã€æ‹‰éºµâ€¦<br/>
              é€™è£¡æ–°å¢çš„å…§å®¹æœƒå­˜æˆ <b>optionGroups</b>ï¼Œçµ¦ user.html ç›´æ¥ä½¿ç”¨ã€‚
            </p>

            <div class="subcard">
              <div class="row3">
                <div>
                  <label>ç¾¤çµ„åç¨±</label>
                  <input id="og_name" placeholder="ä¾‹ï¼šè‚‰é¡ / éºµé¡ / ç”œåº¦"/>
                </div>
                <div>
                  <label>é¡å‹</label>
                  <select id="og_type">
                    <option value="single">å–®é¸ï¼ˆä¸‹æ‹‰ï¼‰</option>
                    <option value="multi">å¤šé¸ï¼ˆå‹¾é¸ï¼‰</option>
                  </select>
                </div>
                <div style="display:flex; align-items:end; gap:10px">
                  <label style="display:flex; align-items:center; gap:8px; margin:0;">
                    <input id="og_required" type="checkbox" style="width:18px; height:18px;"/>
                    å¿…é¸
                  </label>
                  <button class="btnSmall btnOk" id="btnAddOptGroup" type="button">åŠ å…¥ç¾¤çµ„</button>
                </div>
              </div>

              <div class="hr"></div>

              <div class="row3">
                <div>
                  <label>ç¾¤çµ„é¸é …åç¨±</label>
                  <input id="opt_name" placeholder="ä¾‹ï¼šè±¬ / é› / ç¾Š"/>
                </div>
                <div>
                  <label>åŠ åƒ¹ï¼ˆå¯ 0ï¼‰</label>
                  <input id="opt_price" type="number" min="0" placeholder="0"/>
                </div>
                <div style="display:flex; align-items:end; gap:10px">
                  <button class="btnSmall btnOk" id="btnAddOptItem" type="button">åŠ å…¥é¸é …</button>
                  <button class="btnSmall btnDanger" id="btnClearOptDraft" type="button">æ¸…ç©ºè‰ç¨¿</button>
                </div>
              </div>

              <div class="optWrap" id="optDraftWrap"></div>
              <div class="muted" style="margin-top:8px">å…ˆåŠ å…¥ç¾¤çµ„ï¼Œå†åŠ å…¥è©²ç¾¤çµ„çš„é¸é …ï¼›æˆ–å…ˆæ‰“é¸é …ï¼ŒåŠ å…¥ç¾¤çµ„å¾Œå†è£œã€‚</div>
            </div>

            <div class="actions">
              <button class="btnSmall btnOk" id="btnAddMenuToQueue" type="button">åŠ å…¥é¤é»æ¸…å–®</button>
              <button class="ghost" id="btnClearMenu" type="button">æ¸…ç©ºé¤é»æ¬„ä½</button>
            </div>

            <div class="hr"></div>
            <h3 style="margin-top:0">é¤é»æ¸…å–®ï¼ˆå°‡ä¸€èµ·æ–°å¢ï¼‰</h3>
            <div id="menuQueueWrap" class="muted">å°šæœªåŠ å…¥é¤é»ã€‚</div>
          </div>
        </div>
      </section>

      <!-- VIEW: æ–°å¢äººå“¡ -->
      <section class="view" id="view_staff" style="display:none">
        <div class="grid">
          <div class="card">
            <h3>æ–°å¢äººå“¡ï¼ˆå¯æ–°å¢éƒ¨é–€/äººå“¡åç¨±ï¼‰</h3>

            <label>éƒ¨é–€</label>
            <input id="s_dept" list="deptList" placeholder="ä¾‹ï¼šFAE"/>
            <datalist id="deptList">
              <option>ç®¡ç†éƒ¨</option><option>FAE</option><option>TSE</option><option>æ–°å ´</option>
              <option>å€‰ç®¡</option><option>æ•¸æ“šåˆ†æ</option><option>RD</option><option>ç·šä¸Šå®¢æœ</option><option>ç¶­é‹</option>
            </datalist>

            <label>äººå“¡åç¨±</label>
            <input id="s_name" placeholder="ä¾‹ï¼šå°æ˜ï¼ˆæŒ‰ Enter ä¹Ÿå¯æ–°å¢ï¼‰"/>

            <div class="actions">
              <button class="primary" id="btnAddStaff" type="button">æ–°å¢</button>
              <button class="ghost" id="btnClearStaff" type="button">æ¸…ç©º</button>
            </div>

            <p class="muted">ç›¸åŒéƒ¨é–€æœƒè‡ªå‹•æ”¶åˆé¡¯ç¤ºï¼Œä¸¦å¯åˆªé™¤äººå“¡ã€‚</p>
          </div>

          <div class="card">
            <h3>äººå“¡æ¸…å–®ï¼ˆéƒ¨é–€æ”¶åˆï¼‰</h3>
            <div id="staffWrap"></div>
          </div>
        </div>
      </section>

      <!-- VIEW: é¤å»³ç®¡ç† -->
      <section class="view" id="view_restaurants" style="display:none">

        <div class="card">
          <h3>é¤é»ç®¡ç†ï¼ˆä¾é¤å»³ï¼‰</h3>
          <div class="inline">
            <label style="margin:0; min-width:120px; color:var(--muted)">é¸æ“‡é¤å»³</label>
            <select id="rm_restaurant" style="min-width:260px"></select>
            <button class="btnSmall btnOk" id="btnReloadMenus" type="button">é‡æ–°è¼‰å…¥</button>
          </div>
          <div class="hr"></div>
          <div id="menuManageWrap" class="muted">è«‹å…ˆé¸æ“‡é¤å»³</div>
        </div>

        <div class="card" style="margin-top:14px">
          <h3>é¤å»³ç®¡ç†ï¼ˆæ”¶åˆé¡¯ç¤º + å¯é¡¯ç¤º/éš±è— + å¯çµå–®/é–‹å–®ï¼‰</h3>
          <p class="muted">âœ…ã€Œä½¿ç”¨è€…é¡¯ç¤ºã€é—œé–‰å¾Œï¼šä½¿ç”¨è€…é çœ‹ä¸åˆ°è©²åº—<br/>âœ…ã€Œçµå–®ã€é–‹å•Ÿå¾Œï¼šä½¿ç”¨è€…ä¸èƒ½é€å–®</p>
          <div id="restaurantsWrap"></div>
        </div>
      </section>

      <!-- VIEW: è¨‚é¤ç´€éŒ„ -->
      <section class="view" id="view_orders" style="display:none">
        <div class="grid">
          <div class="card">
            <h3>è¨‚å–®çµ±è¨ˆ</h3>
            <div class="row">
              <div>
                <label>è¨‚å–®æ—¥æœŸ</label>
                <input id="o_date" type="date"/>
              </div>
              <div>
                <label>é¡¯ç¤ºæ¨¡å¼</label>
                <select id="o_mode" disabled>
                  <option value="summary">åŒå“é …å½™ç¸½ï¼ˆè·¨æ‰€æœ‰äººï¼‰</option>
                </select>
              </div>
            </div>
            <div class="actions">
              <button class="primary" id="btnLoadOrders" type="button">è¼‰å…¥</button>
              <button class="ghost" id="btnToday" type="button">ä»Šå¤©</button>
              <button class="btnSmall btnOk" id="btnExportExcel" type="button">åŒ¯å‡º Excel</button>
            </div>
            <p class="muted">
              Excel æ¬„ä½ï¼šéƒ¨é–€ã€å§“åã€é¤å»³ã€å“é …ã€é¸é …ã€åŠ è³¼ã€æ•¸é‡ã€å–®åƒ¹ã€é¸é …åŠ åƒ¹ã€åŠ è³¼é‡‘é¡ã€å“é …é‡‘é¡ã€è¨‚å–®ç¸½é¡ã€ä¸‹å–®æ™‚é–“ã€æ•´å–®å‚™è¨»
            </p>
          </div>

          <div class="card">
            <h3>è¨‚é¤ç´€éŒ„ï¼ˆå½™æ•´è¼¸å‡ºï¼‰</h3>
            <div id="ordersOut" class="muted">è«‹é¸æ—¥æœŸå¾ŒæŒ‰ã€Œè¼‰å…¥ã€ã€‚</div>
          </div>
        </div>
      </section>

    </main>
  </div>

  <!-- âœ… Excel åŒ¯å‡ºç”¨ï¼ˆSheetJSï¼‰ -->
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>

  <script type="module">
    const roleKey = "gb_role";
    if (localStorage.getItem(roleKey) !== "admin") location.href = "./index.html";

    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-app.js";
    import {
      getFirestore, collection, addDoc, doc, updateDoc, deleteDoc, getDocs, getDoc,
      query, where, limit, writeBatch
    } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyBdgOddTGAfqqHLnhnaJRv2_y7gyweuQEo",
      authDomain: "goldbricks-order.firebaseapp.com",
      projectId: "goldbricks-order",
      storageBucket: "goldbricks-order.firebasestorage.app",
      messagingSenderId: "463709758954",
      appId: "1:463709758954:web:429dc920f2f812d51cbe93",
      measurementId: "G-YQK8ZCC26R"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    const $ = (id)=> document.getElementById(id);
    const esc = (s)=> (s??"").toString()
      .replaceAll("&","&amp;").replaceAll("<","&lt;").replaceAll(">","&gt;").replaceAll('"',"&quot;");

    const pad2 = (n)=> String(n).padStart(2,"0");
    const todayISO = ()=>{
      const d = new Date();
      return `${d.getFullYear()}-${pad2(d.getMonth()+1)}-${pad2(d.getDate())}`;
    };
    const toTWTime = (ms)=>{
      if(!ms) return "";
      try{ return new Date(ms).toLocaleString("zh-TW", { hour12:false }); }
      catch{ return String(ms); }
    };

    const statusPill = $("statusPill");
    statusPill.textContent = "å·²é€£ç·š Firestore";

    // âœ… å¼·åˆ¶ç§»é™¤ã€Œé¤å»³åç¨±é è¨­å€¼ã€ï¼ˆé¿å…ç€è¦½å™¨è¨˜ä½ï¼‰
    window.addEventListener("load", ()=>{
      const el = $("r_name");
      if (el) el.value = "";
    });

    // ====== optionGroupsï¼šæ­£è¦åŒ–ï¼ˆç¢ºä¿ user.html ä¸€å®šåƒå¾—åˆ°ï¼‰ ======
    function normalizeOptionGroups(v){
      const arr = Array.isArray(v) ? v : [];
      const out = [];
      for(const g of arr){
        if(!g || typeof g !== "object") continue;
        const name = String(g.name||"").trim();
        if(!name) continue;
        const type = (String(g.type||"single") === "multi") ? "multi" : "single";
        const required = !!g.required;
        const options = Array.isArray(g.options) ? g.options : [];
        const optOut = [];
        for(const o of options){
          if(!o || typeof o !== "object") continue;
          const on = String(o.name||"").trim();
          if(!on) continue;
          const price = Math.max(0, Number(o.price||0));
          optOut.push({ name:on, price });
        }
        out.push({ name, type, required, options: optOut });
      }
      return out;
    }

    function optionGroupsText(groups){
      const g = normalizeOptionGroups(groups);
      if(!g.length) return "â€”";
      return g.map(x=>{
        const req = x.required ? "å¿…é¸" : "å¯ä¸é¸";
        const t = x.type === "multi" ? "å¤šé¸" : "å–®é¸";
        const opts = (x.options||[]).map(o=> `${o.name}${o.price?`(+${o.price})`:""}`).join(" / ");
        return `${x.name}(${t},${req})ï¼š${opts || "ï¼ˆç„¡é¸é …ï¼‰"}`;
      }).join("ï¼›");
    }

    // ====== Views ======
    const pageTitle = $("pageTitle");
    const views = {
      staff: $("view_staff"),
      addRestaurant: $("view_addRestaurant"),
      restaurants: $("view_restaurants"),
      orders: $("view_orders"),
    };
    function show(viewKey){
      Object.entries(views).forEach(([k,el])=> el.style.display = (k===viewKey) ? "" : "none");
      document.querySelectorAll(".navBtn[data-view]").forEach(b=> b.classList.toggle("active", b.dataset.view===viewKey));
      pageTitle.textContent =
        viewKey==="staff" ? "æ–°å¢äººå“¡" :
        viewKey==="addRestaurant" ? "æ–°å¢é¤å»³" :
        viewKey==="restaurants" ? "é¤å»³ç®¡ç†" :
        "è¨‚é¤ç´€éŒ„";

      if(viewKey==="staff") refreshStaffList();
      if(viewKey==="restaurants"){
        refreshRestaurantSelects();
        refreshRestaurantsManage();
      }
    }
    document.querySelectorAll(".navBtn[data-view]").forEach(btn=>{
      btn.addEventListener("click", ()=> show(btn.dataset.view));
    });
    show("addRestaurant");

    $("logout").onclick = ()=>{ localStorage.removeItem(roleKey); location.href = "./index.html"; };
    $("switchUser").onclick = ()=>{ localStorage.setItem(roleKey, "user"); location.href = "./user.html"; };
    $("gotoIndex").onclick = ()=> location.href = "./index.html";

    const colRestaurants = collection(db, "restaurants");
    const colStaff = collection(db, "staff");
    const colOrders = collection(db, "orders");

    // ====== æ–°å¢é¤å»³ï¼šåœ–ç‰‡ç¶²å€é è¦½ ======
    const r_imgUrl = $("r_imgUrl");
    const r_imgPrev = $("r_imgPrev");
    r_imgUrl.addEventListener("input", ()=>{
      const url = r_imgUrl.value.trim();
      if(!url){ r_imgPrev.style.display="none"; return; }
      r_imgPrev.src = url;
      r_imgPrev.style.display="";
    });
    r_imgPrev.addEventListener("error", ()=>{ r_imgPrev.style.display="none"; });

    // ====== æ–°å¢é¤å»³ï¼šé¤é»æ¸…å–®ï¼ˆå«åŠ è³¼ + optionGroupsï¼‰ ======
    let currentAddons = [];
    let menuQueue = [];

    // optionGroups draft
    let draftGroups = [];      // å·²å»ºç«‹çš„ç¾¤çµ„
    let currentGroupIndex = -1; // ç›®å‰æ­£åœ¨ç·¨è¼¯çš„ç¾¤çµ„ index

    function renderAddonList(){
      const wrap = $("addonList");
      if(currentAddons.length===0){
        wrap.innerHTML = '<div class="muted">å°šæœªåŠ å…¥åŠ è³¼</div>';
        return;
      }
      wrap.innerHTML = currentAddons.map((a,i)=>`
        <div class="inline" style="justify-content:space-between; padding:8px 10px; border:1px solid rgba(15,23,42,.10); border-radius:14px; background:#fff; margin-top:8px;">
          <div>
            <b>${esc(a.name)}</b>
            <span class="tag" style="margin-left:8px">+${a.price}</span>
            ${a.free ? '<span class="tag" style="margin-left:6px">å…è²»</span>' : ''}
          </div>
          <button class="btnSmall btnDanger" data-del-addon="${i}" type="button">åˆªé™¤</button>
        </div>
      `).join("");
      wrap.querySelectorAll("button[data-del-addon]").forEach(b=>{
        b.onclick = ()=>{
          currentAddons.splice(Number(b.dataset.delAddon), 1);
          renderAddonList();
        };
      });
    }

    function renderOptDraft(){
      const wrap = $("optDraftWrap");
      const groups = normalizeOptionGroups(draftGroups);

      if(groups.length===0){
        wrap.innerHTML = `<div class="muted">å°šæœªåŠ å…¥ä»»ä½•ã€Œé¸é …ç¾¤çµ„ã€</div>`;
        return;
      }

      wrap.innerHTML = groups.map((g,gi)=>{
        const active = gi===currentGroupIndex;
        const head = `${g.name} Â· ${g.type==="multi"?"å¤šé¸":"å–®é¸"} Â· ${g.required?"å¿…é¸":"å¯ä¸é¸"}`;
        const opts = (g.options||[]);
        return `
          <div class="optGroupCard" style="${active ? 'border-color: rgba(251,113,133,.55); box-shadow: 0 10px 22px rgba(251,113,133,.12);' : ''}">
            <div class="inline" style="justify-content:space-between">
              <div>
                <b>${esc(head)}</b>
                <div class="mini" style="margin-top:6px">é¸é …ï¼š${esc(opts.map(o=>`${o.name}${o.price?`(+${o.price})`:''}`).join(" / ") || "ï¼ˆå°šç„¡ï¼‰")}</div>
              </div>
              <div class="inline">
                <button class="btnSmall" type="button" data-opt-pick="${gi}">${active?"ç›®å‰ç¾¤çµ„":"é¸å–"}</button>
                <button class="btnSmall btnDanger" type="button" data-opt-delg="${gi}">åˆªç¾¤çµ„</button>
              </div>
            </div>

            ${opts.length ? `
              <div class="hr"></div>
              <div class="mini">é»ã€Œåˆªå–®é …ã€å¯ç§»é™¤è©²é¸é …</div>
              ${(opts).map((o,oi)=>`
                <div class="optRow" style="justify-content:space-between; padding:8px 10px; border:1px solid rgba(15,23,42,.08); border-radius:14px; margin-top:8px">
                  <div><b>${esc(o.name)}</b> <span class="tag" style="margin-left:8px">+${Number(o.price||0)}</span></div>
                  <button class="btnSmall btnDanger" type="button" data-opt-delopt="${gi}" data-oi="${oi}">åˆªå–®é …</button>
                </div>
              `).join("")}
            ` : ``}
          </div>
        `;
      }).join("");

      wrap.querySelectorAll("button[data-opt-pick]").forEach(btn=>{
        btn.onclick = ()=>{
          currentGroupIndex = Number(btn.dataset.optPick);
          renderOptDraft();
        };
      });
      wrap.querySelectorAll("button[data-opt-delg]").forEach(btn=>{
        btn.onclick = ()=>{
          const gi = Number(btn.dataset.optDelg);
          draftGroups.splice(gi,1);
          if(currentGroupIndex===gi) currentGroupIndex = -1;
          if(currentGroupIndex>gi) currentGroupIndex -= 1;
          renderOptDraft();
        };
      });
      wrap.querySelectorAll("button[data-opt-delopt]").forEach(btn=>{
        btn.onclick = ()=>{
          const gi = Number(btn.dataset.optDelopt);
          const oi = Number(btn.dataset.oi);
          const g = draftGroups[gi];
          if(!g) return;
          g.options = Array.isArray(g.options) ? g.options : [];
          g.options.splice(oi,1);
          draftGroups[gi] = g;
          renderOptDraft();
        };
      });
    }

    // âœ… é¤é»æ¸…å–®ï¼ˆå°‡ä¸€èµ·æ–°å¢ï¼‰ï¼šä¾ã€Œé¤é»é¡åˆ¥ã€æ”¶åˆ
    function renderMenuQueue(){
      const wrap = $("menuQueueWrap");
      if(menuQueue.length===0){
        wrap.innerHTML = '<div class="muted">å°šæœªåŠ å…¥é¤é»ã€‚</div>';
        return;
      }

      const group = new Map();
      for(const m of menuQueue){
        const cat = (m.category||"æœªåˆ†é¡").trim() || "æœªåˆ†é¡";
        if(!group.has(cat)) group.set(cat, []);
        group.get(cat).push(m);
      }

      wrap.innerHTML = Array.from(group.entries()).map(([cat, list])=>{
        const rows = list.map((m)=>{
          const globalIndex = menuQueue.indexOf(m);
          const addons = (m.addons||[]).map(a=> `${a.name}+${a.free?0:Number(a.price||0)}${a.free?"(å…è²»)":""}`).join("ï¼›") || "â€”";
          const opts = optionGroupsText(m.optionGroups);

          return `
            <div style="margin-top:10px; padding:10px 12px; border:1px solid rgba(15,23,42,.10); border-radius:16px; background:#fff">
              <div class="inline" style="justify-content:space-between">
                <div>
                  <b>${esc(m.name)}</b>
                  <span class="tag" style="margin-left:6px">åƒ¹æ ¼ ${Number(m.price||0)}</span>
                  <span class="tag" style="margin-left:6px">é è¨­æ•¸é‡ ${Number(m.defaultQty||1)}</span>
                </div>
                <button class="btnSmall btnDanger" data-del-menu="${globalIndex}" type="button">åˆªé™¤</button>
              </div>
              <div class="muted" style="margin-top:8px">é¸é …ï¼š${esc(opts)}</div>
              <div class="muted" style="margin-top:6px">åŠ è³¼ï¼š${esc(addons)}</div>
            </div>
          `;
        }).join("");

        return `
          <details style="border:1px solid rgba(15,23,42,.10); border-radius:16px; padding:10px 12px; background:#fff; margin-top:10px;">
            <summary>${esc(cat)} <span class="tag" style="margin-left:8px">${list.length} é“</span></summary>
            <div style="margin-top:10px">${rows}</div>
          </details>
        `;
      }).join("");

      wrap.querySelectorAll("button[data-del-menu]").forEach(b=>{
        b.onclick = ()=>{
          menuQueue.splice(Number(b.dataset.delMenu), 1);
          renderMenuQueue();
        };
      });
    }

    renderAddonList(); renderMenuQueue(); renderOptDraft();

    $("btnAddAddon").onclick = ()=>{
      const name = $("a_name").value.trim();
      const free = $("a_free").checked;
      const price = free ? 0 : Number($("a_price").value||0);
      if(!name) return alert("è«‹è¼¸å…¥åŠ è³¼åç¨±");
      if(!free && (isNaN(price) || price<0)) return alert("åŠ è³¼é‡‘é¡ä¸æ­£ç¢º");
      currentAddons.push({ name, price, free });
      $("a_name").value=""; $("a_price").value=""; $("a_free").checked=false;
      renderAddonList();
    };

    // optionGroupsï¼šåŠ å…¥ç¾¤çµ„
    $("btnAddOptGroup").onclick = ()=>{
      const name = ($("og_name").value||"").trim();
      const type = ($("og_type").value||"single") === "multi" ? "multi" : "single";
      const required = !!$("og_required").checked;
      if(!name) return alert("è«‹è¼¸å…¥ç¾¤çµ„åç¨±ï¼ˆä¾‹å¦‚ï¼šè‚‰é¡ / éºµé¡ï¼‰");

      draftGroups = normalizeOptionGroups(draftGroups);
      draftGroups.push({ name, type, required, options: [] });
      currentGroupIndex = draftGroups.length - 1;

      $("og_name").value = "";
      $("og_required").checked = false;

      renderOptDraft();
    };

    // optionGroupsï¼šåŠ å…¥é¸é …ï¼ˆåŠ åˆ°ã€Œç›®å‰é¸å–çš„ç¾¤çµ„ã€ï¼‰
    $("btnAddOptItem").onclick = ()=>{
      const optName = ($("opt_name").value||"").trim();
      const optPrice = Math.max(0, Number($("opt_price").value||0));
      if(!optName) return alert("è«‹è¼¸å…¥é¸é …åç¨±ï¼ˆä¾‹å¦‚ï¼šè±¬ / é› / çƒé¾éºµï¼‰");
      if(currentGroupIndex < 0) return alert("è«‹å…ˆåŠ å…¥/é¸å–ä¸€å€‹ç¾¤çµ„ï¼Œå†åŠ å…¥é¸é …");

      draftGroups = normalizeOptionGroups(draftGroups);
      const g = draftGroups[currentGroupIndex];
      g.options = Array.isArray(g.options) ? g.options : [];
      g.options.push({ name: optName, price: optPrice });
      draftGroups[currentGroupIndex] = g;

      $("opt_name").value = "";
      $("opt_price").value = "";

      renderOptDraft();
    };

    $("btnClearOptDraft").onclick = ()=>{
      if(!confirm("ç¢ºå®šæ¸…ç©ºæ‰€æœ‰ã€Œé¸é …ç¾¤çµ„/é¸é …ã€è‰ç¨¿ï¼Ÿ")) return;
      draftGroups = [];
      currentGroupIndex = -1;
      $("og_name").value = "";
      $("opt_name").value = "";
      $("opt_price").value = "";
      $("og_required").checked = false;
      renderOptDraft();
    };

    $("btnClearMenu").onclick = ()=>{
      $("m_cat").value=""; $("m_name").value=""; $("m_price").value=""; $("m_defaultQty").value="1";
      currentAddons = [];
      $("a_name").value=""; $("a_price").value=""; $("a_free").checked=false;
      draftGroups = [];
      currentGroupIndex = -1;
      renderAddonList();
      renderOptDraft();
    };

    $("btnAddMenuToQueue").onclick = ()=>{
      const category = $("m_cat").value.trim();
      const name = $("m_name").value.trim();
      const price = Number($("m_price").value||0);
      const defaultQty = Math.max(1, Number($("m_defaultQty").value||1));
      if(!category) return alert("è«‹è¼¸å…¥é¤é»é¡åˆ¥");
      if(!name) return alert("è«‹è¼¸å…¥é¤é»åç¨±");
      if(isNaN(price) || price<0) return alert("åƒ¹æ ¼ä¸æ­£ç¢º");

      const optionGroups = normalizeOptionGroups(draftGroups);

      menuQueue.push({
        category,
        name,
        price,
        defaultQty,
        addons: currentAddons,
        optionGroups
      });

      $("btnClearMenu").click();
      renderMenuQueue();
    };

    // âœ… é¤é»æ¬„ä½æŒ‰ Enter ç›´æ¥åŠ å…¥é¤é»æ¸…å–®
    ["m_cat","m_name","m_price","m_defaultQty"].forEach(id=>{
      $(id).addEventListener("keydown",(e)=>{
        if(e.key==="Enter"){
          e.preventDefault();
          $("btnAddMenuToQueue").click();
        }
      });
    });

    $("btnClearAll").onclick = ()=>{
      $("r_name").value=""; $("r_phone").value=""; $("r_addr").value="";
      $("r_map").value=""; $("r_note").value="";
      $("r_imgUrl").value=""; r_imgPrev.style.display="none";
      $("r_visible").checked = true;
      $("r_closed").checked = false;
      menuQueue = [];
      $("btnClearMenu").click();
      renderMenuQueue();
    };

    $("btnSubmitAll").onclick = async ()=>{
      const name = $("r_name").value.trim();
      if(!name) return alert("è«‹è¼¸å…¥é¤å»³åç¨±");
      statusPill.textContent = "æ–°å¢é¤å»³ä¸­â€¦";

      try{
        const restaurantRef = await addDoc(colRestaurants, {
          name,
          phone: $("r_phone").value.trim(),
          address: $("r_addr").value.trim(),
          mapUrl: $("r_map").value.trim(),
          note: $("r_note").value.trim(),
          imageUrl: $("r_imgUrl").value.trim(),
          isVisible: $("r_visible").checked,
          isClosed: $("r_closed").checked,
          createdAt: Date.now()
        });

        if(menuQueue.length>0){
          statusPill.textContent = "æ–°å¢é¤é»æ¸…å–®ä¸­â€¦";
          const menuCol = collection(db, "restaurants", restaurantRef.id, "menu");
          for(const m of menuQueue){
            await addDoc(menuCol, {
              category: m.category,
              name: m.name,
              price: Math.max(0, Number(m.price||0)),
              defaultQty: Math.max(1, Number(m.defaultQty||1)),
              addons: Array.isArray(m.addons) ? m.addons : [],
              optionGroups: normalizeOptionGroups(m.optionGroups),
              createdAt: Date.now()
            });
          }
        }

        statusPill.textContent = "æ–°å¢å®Œæˆ âœ…";
        alert(menuQueue.length>0 ? "é¤å»³ + é¤é»å·²æ–°å¢ï¼" : "é¤å»³å·²æ–°å¢ï¼");
        $("btnClearAll").click();
        await refreshRestaurantSelects();
        await refreshRestaurantsManage();
      }catch(err){
        console.error(err);
        alert("æ–°å¢å¤±æ•—\n\n" + (err?.message || err));
        statusPill.textContent = "æ–°å¢å¤±æ•—ï¼ˆçœ‹ consoleï¼‰";
      }
    };

    // ====== äººå“¡ ======
    async function refreshStaffList(){
      const wrap = $("staffWrap");
      wrap.innerHTML = `<div class="muted">è¼‰å…¥ä¸­â€¦</div>`;

      try{
        const snap = await getDocs(colStaff);
        const arr = [];
        snap.forEach(d=> arr.push({ id:d.id, ...(d.data()||{}) }));

        arr.sort((a,b)=>{
          const da = (a.dept||"æœªåˆ†éƒ¨é–€").trim();
          const dbb = (b.dept||"æœªåˆ†éƒ¨é–€").trim();
          if(da === dbb) return (a.name||"").localeCompare((b.name||""), "zh-Hant");
          return da.localeCompare(dbb, "zh-Hant");
        });

        const map = new Map();
        for(const v of arr){
          const dept = (v.dept||"æœªåˆ†éƒ¨é–€").trim();
          if(!map.has(dept)) map.set(dept, []);
          map.get(dept).push(v);
        }

        if(map.size===0){
          wrap.innerHTML = `<div class="muted">å°šæœªæ–°å¢äººå“¡</div>`;
          return;
        }

        wrap.innerHTML = Array.from(map.entries()).map(([dept, list])=>`
          <details style="border:1px solid rgba(15,23,42,.10); border-radius:16px; padding:10px 12px; margin-bottom:10px; background:#fff">
            <summary>${esc(dept)} <span class="tag" style="margin-left:8px">${list.length}äºº</span></summary>
            <div style="margin-top:10px">
              ${list.map(p=>`
                <div class="inline" style="justify-content:space-between; padding:8px 10px; border:1px solid rgba(15,23,42,.08); border-radius:14px; margin-top:8px;">
                  <div><b>${esc(p.name||"")}</b></div>
                  <button class="btnSmall btnDanger" data-delstaff="${p.id}" type="button">åˆªé™¤</button>
                </div>
              `).join("")}
            </div>
          </details>
        `).join("");

        wrap.querySelectorAll("button[data-delstaff]").forEach(b=>{
          b.onclick = async ()=>{
            if(!confirm("ç¢ºå®šåˆªé™¤è©²äººå“¡ï¼Ÿ")) return;
            try{
              await deleteDoc(doc(db,"staff", b.dataset.delstaff));
              await refreshStaffList();
            }catch(err){
              console.error(err);
              alert("åˆªé™¤äººå“¡å¤±æ•—\n\n" + (err?.message || err));
            }
          };
        });

      }catch(err){
        console.error(err);
        wrap.innerHTML = `
          <div class="muted">
            è®€å–å¤±æ•—<br/>
            ${esc(err?.message || err)}
          </div>
        `;
      }
    }

    $("btnAddStaff").onclick = async ()=>{
      const dept = $("s_dept").value.trim();
      const name = $("s_name").value.trim();
      if(!dept) return alert("è«‹è¼¸å…¥éƒ¨é–€");
      if(!name) return alert("è«‹è¼¸å…¥äººå“¡åç¨±");
      try{
        await addDoc(colStaff, { dept, name, createdAt: Date.now() });
        $("s_name").value="";
        statusPill.textContent = "å·²æ–°å¢äººå“¡ âœ…";
        await refreshStaffList();
      }catch(err){
        console.error(err);
        alert("æ–°å¢äººå“¡å¤±æ•—\n\n" + (err?.message || err));
      }
    };
    $("btnClearStaff").onclick = ()=>{
      $("s_dept").value="";
      $("s_name").value="";
      statusPill.textContent = "å·²æ¸…ç©ºè¼¸å…¥";
    };
    $("s_name").addEventListener("keydown", (e)=>{
      if(e.key==="Enter"){
        e.preventDefault();
        $("btnAddStaff").click();
      }
    });

    // ====== é¤å»³ä¸‹æ‹‰ ======
    async function refreshRestaurantSelects(){
      const snap = await getDocs(query(colRestaurants, limit(1200)));
      const list = [];
      snap.forEach(d=> list.push({ id:d.id, ...d.data() }));

      list.sort((a,b)=>{
        const aa = Number(a.createdAt||0), bb = Number(b.createdAt||0);
        if(bb !== aa) return bb - aa;
        return (a.name||"").localeCompare((b.name||""),"zh-Hant");
      });

      $("rm_restaurant").innerHTML = list.length
        ? `<option value="">è«‹é¸æ“‡</option>` + list.map(r=> `<option value="${r.id}">${esc(r.name||"æœªå‘½å")}</option>`).join("")
        : `<option value="">ï¼ˆå°šç„¡é¤å»³ï¼‰</option>`;
      $("rm_restaurant").onchange = ()=> refreshMenuManage();
    }
    await refreshRestaurantSelects();

    $("btnReloadMenus").onclick = ()=>{
      refreshRestaurantSelects().then(()=> refreshMenuManage());
      refreshRestaurantsManage();
    };

    // ====== é¤é»ç®¡ç†ï¼ˆç½®é ‚ï¼šä¾é¤å»³ï¼‰ ======
    async function refreshMenuManage(){
      const rid = $("rm_restaurant").value;
      const wrap = $("menuManageWrap");
      if(!rid){ wrap.innerHTML = `<div class="muted">è«‹å…ˆé¸æ“‡é¤å»³</div>`; return; }

      try{
        const menuCol = collection(db, "restaurants", rid, "menu");
        const snap = await getDocs(query(menuCol, limit(2500)));
        const list = [];
        snap.forEach(d=> list.push({ id:d.id, ...d.data() }));

        list.sort((a,b)=> Number(b.createdAt||0) - Number(a.createdAt||0));

        if(list.length===0){ wrap.innerHTML = `<div class="muted">æ­¤é¤å»³å°šç„¡é¤é»</div>`; return; }

        wrap.innerHTML = `
          <table>
            <thead>
              <tr>
                <th>é¤é»é¡åˆ¥</th><th>é¤é»åç¨±</th><th>åƒ¹æ ¼</th><th>é è¨­æ•¸é‡</th>
                <th>åŠ è³¼</th><th>é¸é …(optionGroups)</th><th>æ“ä½œ</th>
              </tr>
            </thead>
            <tbody>
              ${list.map(m=>{
                const addons = (m.addons||[]).map(a=> `${a.name}+${a.free?0:Number(a.price||0)}${a.free?"(å…è²»)":""}`).join("ï¼›") || "â€”";
                const og = normalizeOptionGroups(m.optionGroups);
                const ogJson = esc(JSON.stringify(og, null, 2));
                return `
                  <tr>
                    <td><input data-mid="${m.id}" data-k="category" value="${esc(m.category||"")}"></td>
                    <td><input data-mid="${m.id}" data-k="name" value="${esc(m.name||"")}"></td>
                    <td><input data-mid="${m.id}" data-k="price" type="number" min="0" value="${Number(m.price||0)}"></td>
                    <td><input data-mid="${m.id}" data-k="defaultQty" type="number" min="1" value="${Number(m.defaultQty||1)}"></td>
                    <td class="muted" style="max-width:220px">${esc(addons)}</td>
                    <td style="min-width:320px">
                      <textarea class="jsonArea" data-mid="${m.id}" data-k="optionGroupsJson" placeholder='[]'>${ogJson}</textarea>
                      <div class="mini" style="margin-top:6px">${esc(optionGroupsText(og))}</div>
                    </td>
                    <td style="white-space:nowrap">
                      <button class="btnSmall btnOk" data-savem="${m.id}" type="button">å„²å­˜</button>
                      <button class="btnSmall btnDanger" data-delm="${m.id}" type="button">åˆªé™¤</button>
                    </td>
                  </tr>
                `;
              }).join("")}
            </tbody>
          </table>
        `;

        wrap.querySelectorAll("button[data-delm]").forEach(b=>{
          b.onclick = async ()=>{
            if(!confirm("ç¢ºå®šåˆªé™¤é¤é»ï¼Ÿ")) return;
            try{
              await deleteDoc(doc(db, "restaurants", rid, "menu", b.dataset.delm));
              await refreshMenuManage();
              await refreshRestaurantsManage();
            }catch(err){
              console.error(err);
              alert("åˆªé™¤é¤é»å¤±æ•—\n\n" + (err?.message || err));
            }
          };
        });

        wrap.querySelectorAll("button[data-savem]").forEach(b=>{
          b.onclick = async ()=>{
            const mid = b.dataset.savem;
            const els = wrap.querySelectorAll(`[data-mid="${mid}"]`);

            const patch = {};
            let optionGroups = [];
            els.forEach(el=>{
              const k = el.dataset.k;
              if(k === "optionGroupsJson"){
                try{
                  const raw = (el.value||"").trim() || "[]";
                  optionGroups = normalizeOptionGroups(JSON.parse(raw));
                }catch(e){
                  throw new Error("é¸é …JSON è§£æå¤±æ•—ï¼šè«‹ç¢ºèªæ˜¯åˆæ³• JSONï¼ˆä¾‹å¦‚ [] æˆ– [{...}]ï¼‰");
                }
              }else{
                patch[k] = (k==="price" || k==="defaultQty") ? Number(el.value||0) : el.value.trim();
              }
            });

            patch.defaultQty = Math.max(1, Number(patch.defaultQty||1));
            patch.price = Math.max(0, Number(patch.price||0));
            patch.optionGroups = optionGroups;

            try{
              await updateDoc(doc(db,"restaurants", rid, "menu", mid), patch);
              statusPill.textContent = "é¤é»å·²å„²å­˜ âœ…";
              await refreshRestaurantsManage();
              await refreshMenuManage();
            }catch(err){
              console.error(err);
              alert("å„²å­˜é¤é»å¤±æ•—\n\n" + (err?.message || err));
            }
          };
        });

      }catch(err){
        console.error(err);
        wrap.innerHTML = `<div class="muted">ç„¡æ³•è®€å–é¤é»<br/>${esc(err?.message || err)}</div>`;
      }
    }

    // ====== é¤å»³ç®¡ç†ï¼ˆæ”¶åˆ + é¡¯ç¤º/éš±è— + çµå–®/é–‹å–®ï¼‰ ======
    async function loadMenusOfRestaurant(rid){
      try{
        const menuCol = collection(db, "restaurants", rid, "menu");
        const snap = await getDocs(query(menuCol, limit(2500)));
        const list = [];
        snap.forEach(d=> list.push({ id:d.id, ...d.data() }));
        list.sort((a,b)=> Number(b.createdAt||0) - Number(a.createdAt||0));
        return list;
      }catch(err){
        console.error(err);
        return null;
      }
    }

    const draftAddonsByRid = {};
    const draftOptGroupsByRid = {}; // æ¯é–“é¤å»³æ–°å¢é¤é»ç”¨çš„ optionGroups è‰ç¨¿

    function renderDraftAddons(rid, wrapEl){
      const box = wrapEl.querySelector(`[data-draft-addon-list="${rid}"]`);
      if(!box) return;
      const arr = draftAddonsByRid[rid] || [];
      if(arr.length===0){
        box.innerHTML = `<div class="muted">å°šæœªåŠ å…¥åŠ è³¼</div>`;
        return;
      }
      box.innerHTML = arr.map((a,i)=>`
        <div class="inline" style="justify-content:space-between; padding:8px 10px; border:1px solid rgba(15,23,42,.10); border-radius:14px; background:#fff; margin-top:8px;">
          <div>
            <b>${esc(a.name)}</b>
            <span class="tag" style="margin-left:8px">+${a.free?0:Number(a.price||0)}</span>
            ${a.free ? '<span class="tag" style="margin-left:6px">å…è²»</span>' : ''}
          </div>
          <button class="btnSmall btnDanger" type="button" data-draft-del="${rid}" data-i="${i}">åˆªé™¤</button>
        </div>
      `).join("");

      box.querySelectorAll(`button[data-draft-del="${rid}"]`).forEach(btn=>{
        btn.onclick = ()=>{
          const idx = Number(btn.dataset.i);
          const list = draftAddonsByRid[rid] || [];
          list.splice(idx,1);
          draftAddonsByRid[rid] = list;
          renderDraftAddons(rid, wrapEl);
        };
      });
    }

    function renderDraftOptGroups(rid, wrapEl){
      const box = wrapEl.querySelector(`[data-draft-og-list="${rid}"]`);
      if(!box) return;
      const state = draftOptGroupsByRid[rid] || { groups:[], current:-1 };
      state.groups = normalizeOptionGroups(state.groups);

      if(state.groups.length===0){
        box.innerHTML = `<div class="muted">å°šæœªåŠ å…¥é¸é …ç¾¤çµ„</div>`;
        return;
      }

      box.innerHTML = state.groups.map((g,gi)=>{
        const active = gi===state.current;
        const head = `${g.name} Â· ${g.type==="multi"?"å¤šé¸":"å–®é¸"} Â· ${g.required?"å¿…é¸":"å¯ä¸é¸"}`;
        const opts = (g.options||[]).map(o=>`${o.name}${o.price?`(+${o.price})`:''}`).join(" / ");
        return `
          <div style="border:1px solid rgba(15,23,42,.10); border-radius:14px; padding:10px; background:#fff; margin-top:8px; ${active?'border-color:rgba(251,113,133,.55)':''}">
            <div class="inline" style="justify-content:space-between">
              <div>
                <b>${esc(head)}</b>
                <div class="mini" style="margin-top:6px">${esc(opts || "ï¼ˆå°šç„¡ï¼‰")}</div>
              </div>
              <div class="inline">
                <button class="btnSmall" type="button" data-og-pick="${rid}" data-gi="${gi}">${active?"ç›®å‰":"é¸å–"}</button>
                <button class="btnSmall btnDanger" type="button" data-og-delg="${rid}" data-gi="${gi}">åˆªç¾¤çµ„</button>
              </div>
            </div>
          </div>
        `;
      }).join("");

      box.querySelectorAll("button[data-og-pick]").forEach(btn=>{
        btn.onclick = ()=>{
          const r = btn.dataset.ogPick;
          const gi = Number(btn.dataset.gi);
          const st = draftOptGroupsByRid[r] || { groups:[], current:-1 };
          st.current = gi;
          draftOptGroupsByRid[r] = st;
          renderDraftOptGroups(r, wrapEl);
        };
      });
      box.querySelectorAll("button[data-og-delg]").forEach(btn=>{
        btn.onclick = ()=>{
          const r = btn.dataset.ogDelg;
          const gi = Number(btn.dataset.gi);
          const st = draftOptGroupsByRid[r] || { groups:[], current:-1 };
          st.groups.splice(gi,1);
          if(st.current===gi) st.current = -1;
          if(st.current>gi) st.current -= 1;
          draftOptGroupsByRid[r] = st;
          renderDraftOptGroups(r, wrapEl);
        };
      });
    }

    async function refreshRestaurantsManage(){
      const wrap = $("restaurantsWrap");
      wrap.innerHTML = `<div class="muted">è¼‰å…¥ä¸­â€¦</div>`;

      let restaurants = [];
      try{
        const snap = await getDocs(query(colRestaurants, limit(1200)));
        snap.forEach(d=> restaurants.push({ id:d.id, ...d.data() }));

        restaurants.sort((a,b)=>{
          const aa = Number(a.createdAt||0), bb = Number(b.createdAt||0);
          if(bb !== aa) return bb - aa;
          return (a.name||"").localeCompare((b.name||""),"zh-Hant");
        });
      }catch(err){
        console.error(err);
        wrap.innerHTML = `<div class="muted">ç„¡æ³•è®€å–é¤å»³<br/>${esc(err?.message || err)}</div>`;
        return;
      }

      if(restaurants.length===0){ wrap.innerHTML = `<div class="muted">å°šæœªæ–°å¢é¤å»³</div>`; return; }

      const blocks = [];
      for(const r of restaurants){
        const menus = await loadMenusOfRestaurant(r.id);

        const isVisible = (r.isVisible !== false);
        const isClosed = !!r.isClosed;

        const menuRows = (menus === null)
          ? `<div class="muted" style="margin-top:8px">ï¼ˆç„¡æ³•è®€å–é¤é»ï¼šè«‹ç¢ºèª Rules/ç¶²è·¯ï¼‰</div>`
          : (menus.length===0)
            ? `<div class="muted" style="margin-top:8px">ï¼ˆæ­¤é¤å»³å°šç„¡é¤é»ï¼‰</div>`
            : (()=> {
                const byCat = new Map();
                for(const m of menus){
                  const cat = (m.category||"æœªåˆ†é¡").trim() || "æœªåˆ†é¡";
                  if(!byCat.has(cat)) byCat.set(cat, []);
                  byCat.get(cat).push(m);
                }

                return Array.from(byCat.entries()).map(([cat, list])=>{
                  const table = `
                    <table style="margin-top:10px">
                      <thead>
                        <tr>
                          <th>é¤é»é¡åˆ¥</th><th>é¤é»åç¨±</th><th>åƒ¹æ ¼</th><th>é è¨­æ•¸é‡</th><th>åŠ è³¼</th><th>é¸é …JSON</th><th>æ“ä½œ</th>
                        </tr>
                      </thead>
                      <tbody>
                        ${list.map(m=>{
                          const addons = (m.addons||[]).map(a=> `${a.name}+${a.free?0:Number(a.price||0)}${a.free?"(å…è²»)":""}`).join("ï¼›") || "â€”";
                          const og = normalizeOptionGroups(m.optionGroups);
                          return `
                            <tr>
                              <td><input data-rid="${r.id}" data-mid="${m.id}" data-k="category" value="${esc(m.category||"")}"></td>
                              <td><input data-rid="${r.id}" data-mid="${m.id}" data-k="name" value="${esc(m.name||"")}"></td>
                              <td><input data-rid="${r.id}" data-mid="${m.id}" data-k="price" type="number" min="0" value="${Number(m.price||0)}"></td>
                              <td><input data-rid="${r.id}" data-mid="${m.id}" data-k="defaultQty" type="number" min="1" value="${Number(m.defaultQty||1)}"></td>
                              <td class="muted" style="max-width:220px">${esc(addons)}</td>
                              <td style="min-width:320px">
                                <textarea class="jsonArea" data-rid="${r.id}" data-mid="${m.id}" data-k="optionGroupsJson">${esc(JSON.stringify(og,null,2))}</textarea>
                              </td>
                              <td style="white-space:nowrap">
                                <button class="btnSmall btnOk" type="button" data-savem2="1" data-rid="${r.id}" data-mid="${m.id}">å„²å­˜</button>
                                <button class="btnSmall btnDanger" type="button" data-delm2="1" data-rid="${r.id}" data-mid="${m.id}">åˆªé™¤</button>
                              </td>
                            </tr>
                          `;
                        }).join("")}
                      </tbody>
                    </table>
                  `;

                  return `
                    <details style="border:1px solid rgba(15,23,42,.10); border-radius:16px; padding:10px 12px; background:rgba(15,23,42,.02); margin-top:10px;">
                      <summary>${esc(cat)} <span class="tag" style="margin-left:8px">${list.length} é“</span></summary>
                      ${table}
                    </details>
                  `;
                }).join("");
              })();

        const addForm = `
          <div class="hr"></div>
          <h3 style="margin:0">â• ç›´æ¥æ–°å¢é¤é»åˆ°ã€Œ${esc(r.name||"æœªå‘½å")}ã€</h3>

          <div class="row" style="margin-top:10px">
            <div>
              <label>é¤é»é¡åˆ¥ï¼ˆç”¨è¼¸å…¥ï¼‰</label>
              <input data-add-rid="${r.id}" data-add-k="category" placeholder="ä¾‹ï¼šé£¯é¡ / éºµé¡ / å°èœ / é£²æ–™">
            </div>
            <div>
              <label>é¤é»åç¨±</label>
              <input data-add-rid="${r.id}" data-add-k="name" placeholder="ä¾‹ï¼šæ’éª¨é£¯">
            </div>
          </div>

          <div class="row">
            <div>
              <label>åƒ¹æ ¼ï¼ˆå–®ä»½ï¼‰</label>
              <input data-add-rid="${r.id}" data-add-k="price" type="number" min="0" placeholder="70">
            </div>
            <div>
              <label>é è¨­æ•¸é‡</label>
              <input data-add-rid="${r.id}" data-add-k="defaultQty" type="number" min="1" value="1">
            </div>
          </div>

          <div class="hr"></div>
          <h3 style="margin:0">åŠ è³¼é …ç›®ï¼ˆå¯å¤šç­†ï¼‰</h3>
          <div class="subcard" style="margin-top:10px">
            <div class="row3">
              <div>
                <label>åŠ è³¼åç¨±</label>
                <input data-add-rid="${r.id}" data-addon-k="name" placeholder="ä¾‹ï¼šè›‹">
              </div>
              <div>
                <label>åŠ è³¼é‡‘é¡</label>
                <input data-add-rid="${r.id}" data-addon-k="price" type="number" min="0" placeholder="10">
              </div>
              <div style="display:flex; align-items:end; gap:10px">
                <label style="display:flex; align-items:center; gap:8px; margin:0;">
                  <input data-add-rid="${r.id}" data-addon-k="free" type="checkbox" style="width:18px; height:18px;"/>
                  å…è²»
                </label>
                <button class="btnSmall btnOk" type="button" data-addaddon="${r.id}">åŠ å…¥åŠ è³¼</button>
              </div>
            </div>
            <div style="margin-top:10px" data-draft-addon-list="${r.id}"></div>
          </div>

          <div class="hr"></div>
          <h3 style="margin:0">é¸é …ï¼ˆoptionGroupsï¼‰</h3>
          <div class="subcard" style="margin-top:10px">
            <div class="row3">
              <div>
                <label>ç¾¤çµ„åç¨±</label>
                <input data-add-rid="${r.id}" data-og-k="name" placeholder="ä¾‹ï¼šè‚‰é¡ / éºµé¡ / ç”œåº¦">
              </div>
              <div>
                <label>é¡å‹</label>
                <select data-add-rid="${r.id}" data-og-k="type">
                  <option value="single">å–®é¸ï¼ˆä¸‹æ‹‰ï¼‰</option>
                  <option value="multi">å¤šé¸ï¼ˆå‹¾é¸ï¼‰</option>
                </select>
              </div>
              <div style="display:flex; align-items:end; gap:10px">
                <label style="display:flex; align-items:center; gap:8px; margin:0;">
                  <input data-add-rid="${r.id}" data-og-k="required" type="checkbox" style="width:18px; height:18px;"/>
                  å¿…é¸
                </label>
                <button class="btnSmall btnOk" type="button" data-add-og="${r.id}">åŠ å…¥ç¾¤çµ„</button>
              </div>
            </div>

            <div class="hr"></div>

            <div class="row3">
              <div>
                <label>ç¾¤çµ„é¸é …åç¨±</label>
                <input data-add-rid="${r.id}" data-opt-k="name" placeholder="ä¾‹ï¼šè±¬ / é› / çƒé¾éºµ">
              </div>
              <div>
                <label>åŠ åƒ¹ï¼ˆå¯ 0ï¼‰</label>
                <input data-add-rid="${r.id}" data-opt-k="price" type="number" min="0" placeholder="0">
              </div>
              <div style="display:flex; align-items:end; gap:10px">
                <button class="btnSmall btnOk" type="button" data-add-opt="${r.id}">åŠ å…¥é¸é …</button>
                <button class="btnSmall btnDanger" type="button" data-clear-og="${r.id}">æ¸…ç©ºé¸é …è‰ç¨¿</button>
              </div>
            </div>

            <div style="margin-top:10px" data-draft-og-list="${r.id}"></div>
          </div>

          <div class="actions">
            <button class="btnSmall btnOk" type="button" data-addmenu="${r.id}">æ–°å¢é¤é»</button>
            <button class="btnSmall" type="button" data-clearadd="${r.id}">æ¸…ç©ºé¤é»æ¬„ä½</button>
            <button class="btnSmall btnDanger" type="button" data-clearaddons="${r.id}">æ¸…ç©ºåŠ è³¼</button>
          </div>
        `;

        const visibleTag = isVisible
          ? `<span class="tag stateGood">ä½¿ç”¨è€…é¡¯ç¤º</span>`
          : `<span class="tag stateBad">ä½¿ç”¨è€…éš±è—</span>`;

        const closedTag = isClosed
          ? `<span class="tag stateBad">å·²çµå–®</span>`
          : `<span class="tag stateGood">é–‹å–®ä¸­</span>`;

        blocks.push(`
          <details style="border:1px solid rgba(15,23,42,.10); border-radius:16px; padding:12px; background:#fff; margin-top:12px;">
            <summary>
              <span style="font-size:14.5px">${esc(r.name||"æœªå‘½å")}</span>
              <span class="tag" style="margin-left:8px">${menus===null ? "?" : menus.length} é“é¤é»</span>
              <span style="margin-left:10px">${visibleTag}</span>
              <span style="margin-left:6px">${closedTag}</span>
            </summary>

            <div class="kpi">
              ${r.phone ? `<span class="tag">â˜ ${esc(r.phone)}</span>` : ``}
              ${r.address ? `<span class="tag">ğŸ“ ${esc(r.address)}</span>` : ``}
              ${r.mapUrl ? `<span class="tag"><a target="_blank" href="${esc(r.mapUrl)}" style="color:inherit; text-decoration:none">Google Map</a></span>` : ``}
            </div>

            <div class="row" style="margin-top:10px">
              <div>
                <label>é›»è©±</label>
                <input data-r="${r.id}" data-k="phone" value="${esc(r.phone||"")}"/>
              </div>
              <div>
                <label>åœ°å€</label>
                <input data-r="${r.id}" data-k="address" value="${esc(r.address||"")}"/>
              </div>
            </div>

            <div class="row">
              <div>
                <label>Google map é€£çµ</label>
                <input data-r="${r.id}" data-k="mapUrl" value="${esc(r.mapUrl||"")}"/>
              </div>
              <div>
                <label>åœ–ç‰‡ç¶²å€</label>
                <div class="inline" style="gap:8px">
                  <input data-r="${r.id}" data-k="imageUrl" value="${esc(r.imageUrl||"")}"/>
                  <button class="btnSmall" type="button" data-openimg="${r.id}">é–‹å•Ÿ</button>
                </div>
              </div>
            </div>

            <div class="row" style="margin-top:10px">
              <div class="chkline">
                <input type="checkbox" data-r="${r.id}" data-k="isVisible" ${isVisible ? "checked":""}/>
                <span class="muted">ä½¿ç”¨è€…é¡¯ç¤º</span>
              </div>
              <div class="chkline">
                <input type="checkbox" data-r="${r.id}" data-k="isClosed" ${isClosed ? "checked":""}/>
                <span class="muted">çµå–®ï¼ˆä½¿ç”¨è€…ä¸å¯é€å–®ï¼‰</span>
              </div>
            </div>

            ${r.imageUrl ? `<img src="${esc(r.imageUrl)}" class="imgPrev" style="margin-top:10px" alt="img" onerror="this.style.display='none'"/>`
                        : `<div class="muted" style="margin-top:10px">ï¼ˆå°šç„¡åœ–ç‰‡ç¶²å€ï¼‰</div>`}

            <label>å‚™è¨»</label>
            <textarea data-r="${r.id}" data-k="note">${esc(r.note||"")}</textarea>

            <div class="actions">
              <button class="btnSmall btnOk" type="button" data-saver="${r.id}">å„²å­˜é¤å»³è³‡æ–™</button>
              <button class="btnSmall btnDanger" type="button" data-delr="${r.id}">åˆªé™¤é¤å»³</button>
            </div>

            <div class="hr"></div>
            <h3 style="margin:0">å·²è¨­å®šé¤é»ï¼ˆä¾é¡åˆ¥æ”¶åˆï¼‰</h3>
            ${menuRows}
            ${addForm}
          </details>
        `);
      }

      wrap.innerHTML = blocks.join("");

      // åˆå§‹åŒ–æ¯é–“é¤å»³çš„åŠ è³¼ & optionGroups è‰ç¨¿
      wrap.querySelectorAll(`button[data-addmenu]`).forEach(btn=>{
        const rid = btn.dataset.addmenu;
        if(!draftAddonsByRid[rid]) draftAddonsByRid[rid] = [];
        if(!draftOptGroupsByRid[rid]) draftOptGroupsByRid[rid] = { groups:[], current:-1 };
        renderDraftAddons(rid, wrap);
        renderDraftOptGroups(rid, wrap);
      });

      // åœ–ç‰‡ç¶²å€ï¼šé–‹å•Ÿæ–°åˆ†é 
      wrap.querySelectorAll("button[data-openimg]").forEach(btn=>{
        btn.onclick = ()=>{
          const rid = btn.dataset.openimg;
          const input = wrap.querySelector(`[data-r="${rid}"][data-k="imageUrl"]`);
          const url = (input?.value || "").trim();
          if(!url) return alert("ç›®å‰æ²’æœ‰åœ–ç‰‡ç¶²å€");
          const finalUrl = url.startsWith("http://") || url.startsWith("https://") ? url : ("https://" + url);
          window.open(finalUrl, "_blank");
        };
      });

      // å„²å­˜é¤å»³è³‡æ–™
      wrap.querySelectorAll("button[data-saver]").forEach(b=>{
        b.onclick = async ()=>{
          const rid = b.dataset.saver;
          const inputs = wrap.querySelectorAll(`[data-r="${rid}"]`);
          const patch = {};
          inputs.forEach(i=>{
            const k = i.dataset.k;
            if(i.type === "checkbox") patch[k] = !!i.checked;
            else patch[k] = i.value.trim();
          });

          if(typeof patch.isVisible !== "boolean") patch.isVisible = true;
          if(typeof patch.isClosed !== "boolean") patch.isClosed = false;

          try{
            statusPill.textContent = "å„²å­˜é¤å»³ä¸­â€¦";
            await updateDoc(doc(db,"restaurants", rid), patch);
            statusPill.textContent = "å·²å„²å­˜ âœ…";
            await refreshRestaurantSelects();
            await refreshRestaurantsManage();
          }catch(err){
            console.error(err);
            alert("å„²å­˜å¤±æ•—\n\n" + (err?.message || err));
            statusPill.textContent = "å„²å­˜å¤±æ•—ï¼ˆçœ‹ consoleï¼‰";
          }
        };
      });

      // åˆªé™¤é¤å»³ï¼ˆå…ˆåˆªå­é›†åˆ menu å†åˆªæœ¬é«”ï¼‰
      wrap.querySelectorAll("button[data-delr]").forEach(b=>{
        b.onclick = async ()=>{
          const rid = b.dataset.delr;
          if(!confirm("ç¢ºå®šåˆªé™¤é¤å»³ï¼Ÿï¼ˆæœƒé€£åŒè©²é¤å»³çš„é¤é»ä¸€èµ·åˆªé™¤ï¼‰")) return;

          try{
            statusPill.textContent = "åˆªé™¤é¤å»³ä¸­â€¦";

            const menuCol = collection(db, "restaurants", rid, "menu");
            const menuSnap = await getDocs(query(menuCol, limit(2500)));

            let batch = writeBatch(db);
            let count = 0;

            for (const d of menuSnap.docs){
              batch.delete(d.ref);
              count++;
              if(count % 450 === 0){
                await batch.commit();
                batch = writeBatch(db);
              }
            }
            await batch.commit();

            await deleteDoc(doc(db,"restaurants", rid));

            delete draftAddonsByRid[rid];
            delete draftOptGroupsByRid[rid];

            statusPill.textContent = "å·²åˆªé™¤ âœ…";
            await refreshRestaurantSelects();
            await refreshRestaurantsManage();
            await refreshMenuManage();
          }catch(err){
            console.error(err);
            alert("åˆªé™¤å¤±æ•—\n\n" + (err?.message || err));
            statusPill.textContent = "åˆªé™¤å¤±æ•—ï¼ˆçœ‹ consoleï¼‰";
          }
        };
      });

      // é¤é»å„²å­˜/åˆªé™¤ï¼ˆåœ¨é¤å»³æ”¶åˆå…§ï¼‰
      wrap.querySelectorAll("button[data-savem2]").forEach(b=>{
        b.onclick = async ()=>{
          try{
            const rid = b.dataset.rid;
            const mid = b.dataset.mid;
            const els = wrap.querySelectorAll(`[data-rid="${rid}"][data-mid="${mid}"]`);
            const patch = {};
            let optionGroups = [];
            els.forEach(el=>{
              const k = el.dataset.k;
              if(k === "optionGroupsJson"){
                const raw = (el.value||"").trim() || "[]";
                optionGroups = normalizeOptionGroups(JSON.parse(raw));
              }else{
                patch[k] = (k==="price" || k==="defaultQty") ? Number(el.value||0) : el.value.trim();
              }
            });
            patch.defaultQty = Math.max(1, Number(patch.defaultQty||1));
            patch.price = Math.max(0, Number(patch.price||0));
            patch.optionGroups = optionGroups;

            await updateDoc(doc(db,"restaurants", rid, "menu", mid), patch);
            statusPill.textContent = "é¤é»å·²å„²å­˜ âœ…";
            await refreshMenuManage();
          }catch(err){
            console.error(err);
            alert("å„²å­˜é¤é»å¤±æ•—\n\n" + (err?.message || err));
          }
        };
      });

      wrap.querySelectorAll("button[data-delm2]").forEach(b=>{
        b.onclick = async ()=>{
          const rid = b.dataset.rid;
          const mid = b.dataset.mid;
          if(!confirm("ç¢ºå®šåˆªé™¤é¤é»ï¼Ÿ")) return;
          try{
            await deleteDoc(doc(db,"restaurants", rid, "menu", mid));
            await refreshRestaurantsManage();
            await refreshMenuManage();
          }catch(err){
            console.error(err);
            alert("åˆªé™¤é¤é»å¤±æ•—\n\n" + (err?.message || err));
          }
        };
      });

      // åŠ å…¥åŠ è³¼ï¼ˆæ–°å¢é¤é»è¡¨å–®ï¼‰
      wrap.querySelectorAll("button[data-addaddon]").forEach(btn=>{
        btn.onclick = ()=>{
          const rid = btn.dataset.addaddon;

          const nameEl = wrap.querySelector(`[data-add-rid="${rid}"][data-addon-k="name"]`);
          const priceEl = wrap.querySelector(`[data-add-rid="${rid}"][data-addon-k="price"]`);
          const freeEl = wrap.querySelector(`[data-add-rid="${rid}"][data-addon-k="free"]`);

          const name = (nameEl?.value || "").trim();
          const free = !!freeEl?.checked;
          const price = free ? 0 : Number(priceEl?.value || 0);

          if(!name) return alert("è«‹è¼¸å…¥åŠ è³¼åç¨±");
          if(!free && (isNaN(price) || price<0)) return alert("åŠ è³¼é‡‘é¡ä¸æ­£ç¢º");

          if(!draftAddonsByRid[rid]) draftAddonsByRid[rid] = [];
          draftAddonsByRid[rid].push({ name, price, free });

          if(nameEl) nameEl.value = "";
          if(priceEl) priceEl.value = "";
          if(freeEl) freeEl.checked = false;

          renderDraftAddons(rid, wrap);
        };
      });

      // æ¸…ç©ºåŠ è³¼
      wrap.querySelectorAll("button[data-clearaddons]").forEach(btn=>{
        btn.onclick = ()=>{
          const rid = btn.dataset.clearaddons;
          draftAddonsByRid[rid] = [];
          const nameEl = wrap.querySelector(`[data-add-rid="${rid}"][data-addon-k="name"]`);
          const priceEl = wrap.querySelector(`[data-add-rid="${rid}"][data-addon-k="price"]`);
          const freeEl = wrap.querySelector(`[data-add-rid="${rid}"][data-addon-k="free"]`);
          if(nameEl) nameEl.value = "";
          if(priceEl) priceEl.value = "";
          if(freeEl) freeEl.checked = false;
          renderDraftAddons(rid, wrap);
        };
      });

      // optionGroupsï¼šåŠ å…¥ç¾¤çµ„ï¼ˆæ–°å¢é¤é»è¡¨å–®ï¼‰
      wrap.querySelectorAll("button[data-add-og]").forEach(btn=>{
        btn.onclick = ()=>{
          const rid = btn.dataset.addOg;
          const st = draftOptGroupsByRid[rid] || { groups:[], current:-1 };
          st.groups = normalizeOptionGroups(st.groups);

          const nameEl = wrap.querySelector(`[data-add-rid="${rid}"][data-og-k="name"]`);
          const typeEl = wrap.querySelector(`[data-add-rid="${rid}"][data-og-k="type"]`);
          const reqEl  = wrap.querySelector(`[data-add-rid="${rid}"][data-og-k="required"]`);

          const name = (nameEl?.value||"").trim();
          const type = (typeEl?.value||"single")==="multi" ? "multi" : "single";
          const required = !!reqEl?.checked;

          if(!name) return alert("è«‹è¼¸å…¥ç¾¤çµ„åç¨±ï¼ˆä¾‹å¦‚ï¼šè‚‰é¡ / éºµé¡ï¼‰");

          st.groups.push({ name, type, required, options: [] });
          st.current = st.groups.length - 1;
          draftOptGroupsByRid[rid] = st;

          if(nameEl) nameEl.value = "";
          if(reqEl) reqEl.checked = false;

          renderDraftOptGroups(rid, wrap);
        };
      });

      // optionGroupsï¼šåŠ å…¥é¸é …ï¼ˆåŠ åˆ°ç›®å‰ç¾¤çµ„ï¼‰
      wrap.querySelectorAll("button[data-add-opt]").forEach(btn=>{
        btn.onclick = ()=>{
          const rid = btn.dataset.addOpt;
          const st = draftOptGroupsByRid[rid] || { groups:[], current:-1 };
          st.groups = normalizeOptionGroups(st.groups);

          if(st.current < 0) return alert("è«‹å…ˆåŠ å…¥/é¸å–ä¸€å€‹ç¾¤çµ„ï¼Œå†åŠ å…¥é¸é …");

          const nameEl = wrap.querySelector(`[data-add-rid="${rid}"][data-opt-k="name"]`);
          const priceEl = wrap.querySelector(`[data-add-rid="${rid}"][data-opt-k="price"]`);
          const name = (nameEl?.value||"").trim();
          const price = Math.max(0, Number(priceEl?.value||0));
          if(!name) return alert("è«‹è¼¸å…¥é¸é …åç¨±ï¼ˆä¾‹å¦‚ï¼šè±¬ / é› / çƒé¾éºµï¼‰");

          const g = st.groups[st.current];
          g.options = Array.isArray(g.options) ? g.options : [];
          g.options.push({ name, price });
          st.groups[st.current] = g;
          draftOptGroupsByRid[rid] = st;

          if(nameEl) nameEl.value = "";
          if(priceEl) priceEl.value = "";

          renderDraftOptGroups(rid, wrap);
        };
      });

      // optionGroupsï¼šæ¸…ç©ºè‰ç¨¿
      wrap.querySelectorAll("button[data-clear-og]").forEach(btn=>{
        btn.onclick = ()=>{
          const rid = btn.dataset.clearOg;
          if(!confirm("ç¢ºå®šæ¸…ç©ºæ­¤é¤é»çš„ã€Œé¸é …ç¾¤çµ„/é¸é …ã€è‰ç¨¿ï¼Ÿ")) return;
          draftOptGroupsByRid[rid] = { groups:[], current:-1 };
          const nameEl = wrap.querySelector(`[data-add-rid="${rid}"][data-og-k="name"]`);
          const reqEl  = wrap.querySelector(`[data-add-rid="${rid}"][data-og-k="required"]`);
          const optNameEl = wrap.querySelector(`[data-add-rid="${rid}"][data-opt-k="name"]`);
          const optPriceEl = wrap.querySelector(`[data-add-rid="${rid}"][data-opt-k="price"]`);
          if(nameEl) nameEl.value="";
          if(reqEl) reqEl.checked=false;
          if(optNameEl) optNameEl.value="";
          if(optPriceEl) optPriceEl.value="";
          renderDraftOptGroups(rid, wrap);
        };
      });

      // æ–°å¢é¤é»ï¼ˆå«åŠ è³¼ + optionGroupsï¼‰
      wrap.querySelectorAll("button[data-addmenu]").forEach(btn=>{
        btn.onclick = async ()=>{
          const rid = btn.dataset.addmenu;

          const category = (wrap.querySelector(`[data-add-rid="${rid}"][data-add-k="category"]`)?.value || "").trim();
          const name = (wrap.querySelector(`[data-add-rid="${rid}"][data-add-k="name"]`)?.value || "").trim();
          const price = Number(wrap.querySelector(`[data-add-rid="${rid}"][data-add-k="price"]`)?.value || 0);
          const defaultQty = Math.max(1, Number(wrap.querySelector(`[data-add-rid="${rid}"][data-add-k="defaultQty"]`)?.value || 1));

          if(!category) return alert("è«‹è¼¸å…¥é¤é»é¡åˆ¥");
          if(!name) return alert("è«‹è¼¸å…¥é¤é»åç¨±");
          if(isNaN(price) || price<0) return alert("åƒ¹æ ¼ä¸æ­£ç¢º");

          const addons = (draftAddonsByRid[rid] || []).map(a=> ({
            name: a.name,
            price: Math.max(0, Number(a.price||0)),
            free: !!a.free
          }));

          const st = draftOptGroupsByRid[rid] || { groups:[], current:-1 };
          const optionGroups = normalizeOptionGroups(st.groups);

          try{
            statusPill.textContent = "æ–°å¢é¤é»ä¸­â€¦";
            const menuCol = collection(db, "restaurants", rid, "menu");
            await addDoc(menuCol, { category, name, price, defaultQty, addons, optionGroups, createdAt: Date.now() });

            statusPill.textContent = "å·²æ–°å¢é¤é» âœ…";

            const c1 = wrap.querySelector(`[data-add-rid="${rid}"][data-add-k="category"]`);
            const c2 = wrap.querySelector(`[data-add-rid="${rid}"][data-add-k="name"]`);
            const c3 = wrap.querySelector(`[data-add-rid="${rid}"][data-add-k="price"]`);
            const c4 = wrap.querySelector(`[data-add-rid="${rid}"][data-add-k="defaultQty"]`);
            if(c1) c1.value = "";
            if(c2) c2.value = "";
            if(c3) c3.value = "";
            if(c4) c4.value = "1";

            draftAddonsByRid[rid] = [];
            draftOptGroupsByRid[rid] = { groups:[], current:-1 };
            renderDraftAddons(rid, wrap);
            renderDraftOptGroups(rid, wrap);

            await refreshRestaurantsManage();
            await refreshMenuManage();
            await refreshRestaurantSelects();
          }catch(err){
            console.error(err);
            alert("æ–°å¢é¤é»å¤±æ•—\n\n" + (err?.message || err));
            statusPill.textContent = "æ–°å¢é¤é»å¤±æ•—ï¼ˆçœ‹ consoleï¼‰";
          }
        };
      });

      // æ¸…ç©ºï¼ˆé¤é»æ¬„ä½ï¼‰
      wrap.querySelectorAll("button[data-clearadd]").forEach(btn=>{
        btn.onclick = ()=>{
          const rid = btn.dataset.clearadd;
          const c1 = wrap.querySelector(`[data-add-rid="${rid}"][data-add-k="category"]`);
          const c2 = wrap.querySelector(`[data-add-rid="${rid}"][data-add-k="name"]`);
          const c3 = wrap.querySelector(`[data-add-rid="${rid}"][data-add-k="price"]`);
          const c4 = wrap.querySelector(`[data-add-rid="${rid}"][data-add-k="defaultQty"]`);
          if(c1) c1.value = "";
          if(c2) c2.value = "";
          if(c3) c3.value = "";
          if(c4) c4.value = "1";
        };
      });
    }

    // ====== è¨‚é¤ç´€éŒ„ï¼ˆå½™ç¸½è¼¸å‡º + Excelï¼‰ ======
    $("btnToday").onclick = ()=> $("o_date").value = todayISO();
    $("o_date").value = todayISO();

    let lastLoadedOrders = [];

    function addonText(addons){
      const arr = Array.isArray(addons) ? addons : [];
      if(arr.length===0) return "";
      return arr.map(a=>{
        const p = (a && a.free) ? 0 : Number(a?.price||0);
        return `+${a?.name||""}${p?(" "+p):""}${a?.free?"(å…è²»)":""}`;
      }).join("");
    }
    function addonUnitSum(addons){
      const arr = Array.isArray(addons) ? addons : [];
      return arr.reduce((s,a)=> s + ((a && a.free) ? 0 : Number(a?.price||0)), 0);
    }
    function pickedOptionsText(picked){
      const arr = Array.isArray(picked) ? picked : [];
      if(!arr.length) return "";
      return arr.map(x=>{
        const p = Math.max(0, Number(x?.price||0));
        return `${x?.group?`${x.group}:`:''}${x?.name||""}${p?`(+${p})`:''}`;
      }).join("ï¼›");
    }
    function pickedOptionsUnitSum(picked){
      const arr = Array.isArray(picked) ? picked : [];
      return arr.reduce((s,x)=> s + Math.max(0, Number(x?.price||0)), 0);
    }

    async function loadOrdersByDate(date){
      const snap = await getDocs(query(colOrders, where("orderDate","==", date), limit(5000)));
      const orders = [];
      snap.forEach(d=> orders.push({ id:d.id, ...d.data() }));
      orders.sort((a,b)=> Number(b.createdAt||0) - Number(a.createdAt||0));
      return orders;
    }

    function renderOrdersSummary(orders){
      const agg = new Map();
      let grandTotal = 0;

      for(const o of orders){
        const items = Array.isArray(o.items) ? o.items : [];
        let orderTotal = Number(o.total||0);
        if(!orderTotal){
          orderTotal = items.reduce((s,it)=>{
            const unitAddon = addonUnitSum(it.addons);
            const unitOpt = pickedOptionsUnitSum(it.pickedOptions);
            return s + (Number(it.price||0) + unitAddon + unitOpt) * Number(it.qty||0);
          }, 0);
        }
        grandTotal += orderTotal;

        for(const it of items){
          const rName = o.restaurantName || "";
          const unit = Number(it.price||0);
          const addons = Array.isArray(it.addons) ? it.addons : [];
          const pickedOptions = Array.isArray(it.pickedOptions) ? it.pickedOptions : [];
          const addonsKey = addons.map(a=> `${a?.name||""}:${(a&&a.free)?0:Number(a?.price||0)}:${a?.free?1:0}`).sort().join("|");
          const optKey = pickedOptions.map(x=> `${x?.group||""}:${x?.name||""}:${Number(x?.price||0)}`).sort().join("|");

          const key = `${rName}__${it.name||""}__${unit}__${optKey}__${addonsKey}`;
          if(!agg.has(key)){
            agg.set(key, {
              restaurant: rName,
              item: it.name||"",
              unit,
              pickedOptions,
              addons,
              qty: 0
            });
          }
          agg.get(key).qty += Number(it.qty||0);
        }
      }

      const rows = Array.from(agg.values()).sort((a,b)=> b.qty-a.qty).map(x=>{
        const unitAddon = addonUnitSum(x.addons);
        const unitOpt = pickedOptionsUnitSum(x.pickedOptions);
        const addonAmt = unitAddon * x.qty;
        const optAmt = unitOpt * x.qty;
        const itemAmt = x.unit * x.qty;
        const total = (x.unit + unitAddon + unitOpt) * x.qty;
        return `
          <tr>
            <td>${esc(x.restaurant)}</td>
            <td>${esc(x.item)}</td>
            <td class="muted">${esc(pickedOptionsText(x.pickedOptions))}</td>
            <td class="muted">${esc(addonText(x.addons))}</td>
            <td>${x.qty}</td>
            <td>${x.unit}</td>
            <td>${optAmt}</td>
            <td>${addonAmt}</td>
            <td>${itemAmt}</td>
            <td>${total}</td>
          </tr>
        `;
      }).join("");

      return `
        <div class="inline" style="justify-content:space-between; margin-bottom:10px">
          <span class="tag">å…± ${orders.length} ç­†è¨‚å–®</span>
          <span class="tag">è¨‚å–®ç¸½åŠ ç¸½ï¼š${grandTotal}</span>
        </div>
        <table>
          <thead>
            <tr>
              <th>é¤å»³</th><th>å“é …</th><th>é¸é …</th><th>åŠ è³¼</th><th>æ•¸é‡</th><th>å–®åƒ¹</th>
              <th>é¸é …åŠ åƒ¹</th><th>åŠ è³¼é‡‘é¡</th><th>å“é …é‡‘é¡</th><th>å°è¨ˆ</th>
            </tr>
          </thead>
          <tbody>
            ${rows || `<tr><td colspan="10" class="muted">æ­¤æ—¥æœŸæ²’æœ‰è¨‚å–®</td></tr>`}
          </tbody>
        </table>
      `;
    }

    $("btnLoadOrders").onclick = async ()=>{
      const date = $("o_date").value;
      if(!date) return alert("è«‹é¸æ—¥æœŸ");

      try{
        statusPill.textContent = "è¼‰å…¥è¨‚å–®ä¸­â€¦";
        const orders = await loadOrdersByDate(date);
        lastLoadedOrders = orders;

        if(orders.length===0){
          $("ordersOut").innerHTML = `<div class="muted">æ­¤æ—¥æœŸæ²’æœ‰è¨‚å–®</div>`;
          statusPill.textContent = "å·²è¼‰å…¥ âœ…";
          return;
        }

        $("ordersOut").innerHTML = renderOrdersSummary(orders);
        statusPill.textContent = "å·²è¼‰å…¥ âœ…";
      }catch(err){
        console.error(err);
        $("ordersOut").innerHTML = `<div class="muted">è®€å–è¨‚å–®å¤±æ•—<br/>${esc(err?.message || err)}</div>`;
        alert("è®€å–è¨‚å–®å¤±æ•—\n\n" + (err?.message || err));
        statusPill.textContent = "è®€å–å¤±æ•—ï¼ˆçœ‹ consoleï¼‰";
      }
    };

    // âœ… Excel åŒ¯å‡ºï¼ˆé€å“é …ä¸€åˆ—ï¼‰
    $("btnExportExcel").onclick = async ()=>{
      const date = $("o_date").value;
      if(!date) return alert("è«‹é¸æ—¥æœŸ");

      try{
        statusPill.textContent = "æº–å‚™ Excelâ€¦";

        let orders = lastLoadedOrders;
        if(!Array.isArray(orders) || orders.length===0 || (orders[0]?.orderDate && orders[0].orderDate !== date)){
          orders = await loadOrdersByDate(date);
          lastLoadedOrders = orders;
        }
        if(!orders || orders.length===0) return alert("æ­¤æ—¥æœŸæ²’æœ‰è¨‚å–®å¯åŒ¯å‡º");

        const rows = [];
        for(const o of orders){
          const dept = o.userDept || "";
          const name = o.userName || "";
          const restaurant = o.restaurantName || "";
          const orderTotal = Number(o.total||0) || 0;
          const time = toTWTime(o.createdAt);
          const orderNote = (o.orderNote || o.remark || "");

          const items = Array.isArray(o.items) ? o.items : [];
          for(const it of items){
            const qty = Number(it.qty||0);
            const unit = Number(it.price||0);
            const unitAddon = addonUnitSum(it.addons);
            const unitOpt = pickedOptionsUnitSum(it.pickedOptions);

            const optAmt = unitOpt * qty;
            const addonAmt = unitAddon * qty;
            const itemAmt = unit * qty;

            rows.push({
              "éƒ¨é–€": dept,
              "å§“å": name,
              "é¤å»³": restaurant,
              "å“é …": it.name || "",
              "é¸é …": pickedOptionsText(it.pickedOptions),
              "åŠ è³¼": addonText(it.addons),
              "æ•¸é‡": qty,
              "å–®åƒ¹": unit,
              "é¸é …åŠ åƒ¹": optAmt,
              "åŠ è³¼é‡‘é¡": addonAmt,
              "å“é …é‡‘é¡": itemAmt,
              "è¨‚å–®ç¸½é¡": orderTotal,
              "ä¸‹å–®æ™‚é–“": time,
              "æ•´å–®å‚™è¨»": orderNote
            });
          }

          if(items.length===0){
            rows.push({
              "éƒ¨é–€": dept,
              "å§“å": name,
              "é¤å»³": restaurant,
              "å“é …": "",
              "é¸é …": "",
              "åŠ è³¼": "",
              "æ•¸é‡": 0,
              "å–®åƒ¹": 0,
              "é¸é …åŠ åƒ¹": 0,
              "åŠ è³¼é‡‘é¡": 0,
              "å“é …é‡‘é¡": 0,
              "è¨‚å–®ç¸½é¡": orderTotal,
              "ä¸‹å–®æ™‚é–“": time,
              "æ•´å–®å‚™è¨»": orderNote
            });
          }
        }

        const ws = XLSX.utils.json_to_sheet(rows);
        const wb = XLSX.utils.book_new();
        XLSX.utils.book_append_sheet(wb, ws, "Orders");

        const fileName = `GoldBricks_Orders_${date}.xlsx`;
        XLSX.writeFile(wb, fileName);

        statusPill.textContent = "Excel å·²åŒ¯å‡º âœ…";
      }catch(err){
        console.error(err);
        alert("åŒ¯å‡ºå¤±æ•—\n\n" + (err?.message || err));
        statusPill.textContent = "åŒ¯å‡ºå¤±æ•—ï¼ˆçœ‹ consoleï¼‰";
      }
    };

  </script>
</body>
</html>
