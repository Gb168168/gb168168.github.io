<!doctype html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>é»é¤ç³»çµ± - ç®¡ç†è€…</title>

  <style>
    :root{
      --bg:#0b1220;
      --panel:#0a1430;
      --card:#0f1a33;
      --text:#e8eeff;
      --muted:#a9b4d6;
      --line:rgba(255,255,255,.10);
      --primary:#6ee7ff;
      --accent:#fb7185;
      --ok:#34d399;
      --warn:#fbbf24;
      --shadow: 0 10px 30px rgba(0,0,0,.35);

      --selectOptBg:#0b1630;
      --selectOptText:#e8eeff;
      --selectOptActive:rgba(110,231,255,.25);
    }

    /* âœ… ä¿®ç™½åº•ï¼šè®“ç€è¦½å™¨åŸç”Ÿè¡¨å–® UI èµ°æ·±è‰² */
    :root, body{ color-scheme: dark; }

    *{box-sizing:border-box}
    body{
      margin:0;
      font-family: ui-sans-serif, system-ui, -apple-system, "Segoe UI", Roboto, "Noto Sans TC", Arial;
      background:
        radial-gradient(1000px 600px at 15% 0%, rgba(110,231,255,.15), transparent 55%),
        radial-gradient(900px 600px at 100% 25%, rgba(251,113,133,.14), transparent 55%),
        var(--bg);
      color:var(--text);
    }

    .wrap{display:flex;min-height:100vh}
    aside{
      width:260px;
      padding:16px;
      border-right:1px solid var(--line);
      background:linear-gradient(180deg, rgba(255,255,255,.04), rgba(255,255,255,.02));
      backdrop-filter: blur(10px);
    }
    .brand{display:flex;flex-direction:column;gap:4px;margin-bottom:14px}
    .brand b{font-size:16px}
    .brand span{font-size:12px;color:var(--muted)}

    .menu{display:grid;gap:10px;margin-top:10px}
    .menu button{
      width:100%;
      text-align:left;
      padding:11px 12px;
      border-radius:14px;
      border:1px solid var(--line);
      background:rgba(255,255,255,.04);
      color:var(--text);
      cursor:pointer;
      transition:.15s;
    }
    .menu button:hover{transform:translateY(-1px);background:rgba(255,255,255,.07)}
    .menu button.active{
      border-color:rgba(110,231,255,.35);
      background:rgba(110,231,255,.12);
    }

    main{flex:1;padding:18px;max-width:1200px}
    header{
      display:flex;gap:10px;align-items:center;justify-content:space-between;
      padding:14px 16px;
      border:1px solid var(--line);
      border-radius:18px;
      background:linear-gradient(135deg, rgba(255,255,255,.06), rgba(255,255,255,.02));
      box-shadow: var(--shadow);
    }
    .row{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
    .pill{
      display:inline-flex;gap:8px;align-items:center;
      padding:7px 10px;border:1px solid var(--line);border-radius:999px;
      background:rgba(255,255,255,.03); color:var(--muted); font-size:12px;
    }
    .card{
      margin-top:14px;
      border:1px solid var(--line);
      border-radius:18px;
      background:linear-gradient(180deg, rgba(255,255,255,.05), rgba(255,255,255,.02));
      padding:14px;
      box-shadow: var(--shadow);
    }
    .hr{height:1px;background:var(--line);margin:12px 0}
    .hint{font-size:12px;color:var(--muted);line-height:1.5}
    .hint.ok{color:var(--ok)}
    .hint.warn{color:var(--warn)}
    .hint.bad{color:var(--accent)}

    input,select,textarea{
      padding:10px 12px;
      border-radius:12px;
      border:1px solid var(--line);
      background:rgba(255,255,255,.04);
      color:var(--text);
      outline:none;
    }
    textarea{width:100%;min-height:80px;resize:vertical}

    /* âœ… ä¿®ç™½åº•ï¼šoption æ·±è‰² */
    select option{
      background:var(--selectOptBg);
      color:var(--selectOptText);
    }
    select option[value=""]{ color: rgba(232,238,255,.55); }
    select option:checked{ background: var(--selectOptActive); color:var(--selectOptText); }

    .btn{
      border:1px solid var(--line);
      background:rgba(255,255,255,.06);
      color:var(--text);
      padding:10px 12px;
      border-radius:12px;
      cursor:pointer;
      transition:.15s;
      user-select:none;
      white-space:nowrap;
    }
    .btn:hover{transform:translateY(-1px);background:rgba(255,255,255,.09)}
    .btn.primary{border-color:rgba(110,231,255,.35);background:rgba(110,231,255,.10)}
    .btn.danger{border-color:rgba(251,113,133,.35);background:rgba(251,113,133,.10)}

    .grid2{display:grid;grid-template-columns:1fr 1fr;gap:12px}
    @media (max-width: 900px){ .grid2{grid-template-columns:1fr} }

    .list{display:grid;gap:10px}
    .sectionTitle{display:flex;justify-content:space-between;gap:10px;align-items:center}
    .sectionTitle b{font-size:14px}
    .tag{
      font-size:12px;color:var(--muted);
      border:1px solid var(--line);
      background:rgba(255,255,255,.03);
      padding:6px 10px;border-radius:999px;
    }

    .group{
      border:1px solid var(--line);
      border-radius:16px;
      background:rgba(255,255,255,.03);
      overflow:hidden;
    }
    .groupHead{
      padding:12px 12px;
      display:flex;align-items:center;justify-content:space-between;
      cursor:pointer;
      user-select:none;
      background:rgba(255,255,255,.02);
    }
    .groupHead:hover{background:rgba(255,255,255,.04)}
    .groupBody{padding:12px;display:grid;gap:10px}
    .hidden{display:none !important}

    .itemRow{
      border:1px solid var(--line);
      border-radius:14px;
      padding:10px;
      background:rgba(255,255,255,.02);
      display:flex;justify-content:space-between;gap:10px;align-items:flex-start;
    }
    .itemRow b{font-size:13px}
    .itemRow .meta{font-size:12px;color:var(--muted);line-height:1.5}
    .itemRow .actions{display:flex;gap:8px;align-items:center}

    .mono{font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;}

    .badge{
      display:inline-flex;align-items:center;gap:6px;
      border:1px solid var(--line);
      background:rgba(255,255,255,.03);
      padding:5px 10px;border-radius:999px;
      font-size:12px;color:var(--muted);
      margin-left:8px;
    }
    .badge.lunch{border-color:rgba(251,191,36,.35); background:rgba(251,191,36,.10); color:#ffd67a;}
    .badge.dinner{border-color:rgba(110,231,255,.35); background:rgba(110,231,255,.10); color:#b8f3ff;}
  </style>
</head>

<body>
<div class="wrap">

  <aside>
    <div class="brand">
      <b>é»é¤ç³»çµ±ï¼ˆç®¡ç†è€…ï¼‰</b>
      <span>äººå“¡ / é¤å»³ / è¨‚é¤ç´€éŒ„</span>
    </div>

    <div class="menu">
      <button class="active" data-tab="staff">äººå“¡ç®¡ç†</button>
      <button data-tab="restaurants">é¤å»³ç®¡ç†</button>
      <button data-tab="orders">è¨‚é¤ç´€éŒ„</button>
      <button id="btnGoUser">å›ä½¿ç”¨è€…é </button>
    </div>

    <div class="hr"></div>
    <div class="hint">
      âœ… æ­¤ç‰ˆæœ¬ç‚ºã€Œä¸éœ€è¦ Indexã€å¯«æ³•ï¼ˆæŠ“å…¨éƒ¨ â†’ å‰ç«¯ç¯©é¸/æ’åºï¼‰
    </div>
  </aside>

  <main>
    <header>
      <div>
        <b style="font-size:16px">ç®¡ç†è€…å¾Œå°</b>
        <div class="hint" id="topHint">è¼‰å…¥ä¸­â€¦</div>
      </div>
      <div class="row">
        <span class="pill" id="statPill">â€”</span>
        <button class="btn" id="btnReloadAll">é‡æ–°è¼‰å…¥</button>
      </div>
    </header>

    <!-- äººå“¡ç®¡ç† -->
    <section id="tab-staff" class="card">
      <div class="sectionTitle">
        <b>äººå“¡ç®¡ç†</b>
        <span class="tag">åŒéƒ¨é–€æ”¶åˆ</span>
      </div>

      <div class="hr"></div>

      <div class="grid2">
        <div>
          <div class="hint">æ–°å¢äººå“¡ï¼ˆéƒ¨é–€ + å§“åï¼‰</div>
          <div class="row" style="margin-top:8px">
            <input id="staffDept" placeholder="éƒ¨é–€" style="flex:1;min-width:140px">
            <input id="staffName" placeholder="å§“å" style="flex:1;min-width:140px">
            <button class="btn primary" id="btnAddStaff">æ–°å¢</button>
          </div>
          <div class="hint" id="staffHint"></div>
        </div>

        <div>
          <div class="hint">è³‡æ–™è¡¨ï¼š<span class="mono">staff</span>ï¼ˆæ¬„ä½ï¼šdeptã€nameï¼‰</div>
          <div class="hint">åˆªé™¤ï¼šåœ¨æ¸…å–®å…§é»ã€Œåˆªé™¤ã€</div>
        </div>
      </div>

      <div class="hr"></div>
      <div id="staffList" class="list"></div>
    </section>

    <!-- é¤å»³ç®¡ç† -->
    <section id="tab-restaurants" class="card hidden">
      <div class="sectionTitle">
        <b>é¤å»³ç®¡ç†</b>
        <span class="tag">æ”¶åˆé¡¯ç¤ºï¼‹å«é¤é»/åŠ è³¼</span>
      </div>

      <div class="hr"></div>

      <div class="grid2">
        <div>
          <div class="hint">æ–°å¢é¤å»³ï¼ˆåç¨±å¿…å¡«ã€ç¶²å€å¯ç©ºï¼‰</div>
          <div class="row" style="margin-top:8px">
            <input id="restName" placeholder="é¤å»³åç¨±" style="flex:1;min-width:180px">
            <input id="restUrl" placeholder="åº—å®¶ç¶²å€ï¼ˆå¯ç©ºï¼‰" style="flex:1;min-width:220px">
            <button class="btn primary" id="btnAddRest">æ–°å¢</button>
          </div>
          <div class="hint" id="restHint"></div>
        </div>

        <div>
          <div class="hint">è³‡æ–™è¡¨ï¼š<span class="mono">restaurants</span></div>
          <div class="hint">æ¬„ä½ï¼šnameã€urlã€imgï¼ˆå¯ç©ºï¼‰ã€menusï¼ˆé™£åˆ—ï¼‰ã€addonsï¼ˆé™£åˆ—ï¼‰</div>
        </div>
      </div>

      <div class="hr"></div>

      <!-- é¤é»æ–°å¢ -->
      <div class="group" style="margin-bottom:12px">
        <div class="groupHead">
          <b>æ–°å¢é¤é»ï¼ˆå…ˆé¸é¤å»³ï¼‰</b>
          <span class="tag" id="menuAddTag">å°šæœªé¸é¤å»³</span>
        </div>
        <div class="groupBody">
          <div class="row">
            <select id="restSelectForMenu" style="flex:1;min-width:240px">
              <option value="">è«‹é¸é¤å»³</option>
            </select>
          </div>

          <div class="grid2">
            <div class="row">
              <input id="menuCategory" placeholder="é¤é»é¡åˆ¥ï¼ˆä¾‹å¦‚ï¼šé£¯/éºµ/é£²æ–™ï¼‰" style="flex:1;min-width:180px">
              <input id="menuName" placeholder="é¤é»åç¨±" style="flex:1;min-width:180px">
            </div>
            <div class="row">
              <input id="menuPrice" placeholder="åƒ¹æ ¼ï¼ˆå–®ä»½ï¼‰" type="number" min="0" step="1" style="width:180px">
              <input id="menuDefaultQty" placeholder="é è¨­æ•¸é‡" type="number" min="0" step="1" style="width:160px">
            </div>
          </div>

          <div class="group" style="margin-top:10px">
            <div class="groupHead">
              <b>æ­¤é¤é»åŠ è³¼é …ç›®</b>
              <span class="hint">å¯æ–°å¢å¤šç­†ï¼ˆå…è²»/é‡‘é¡ï¼‰</span>
            </div>
            <div class="groupBody">
              <div class="row">
                <input id="addonName" placeholder="åŠ è³¼åç¨±ï¼ˆä¾‹å¦‚ï¼šåŠ è›‹ï¼‰" style="flex:1;min-width:200px">
                <input id="addonPrice" placeholder="é‡‘é¡ï¼ˆ0=å…è²»ï¼‰" type="number" min="0" step="1" style="width:180px">
                <button class="btn" id="btnAddAddon">åŠ å…¥åŠ è³¼</button>
              </div>
              <div class="hint" id="addonHint"></div>
              <div id="addonTempList" class="list"></div>
            </div>
          </div>

          <div class="row" style="justify-content:space-between;margin-top:10px">
            <div class="hint" id="menuHint"></div>
            <button class="btn primary" id="btnAddMenu">æ–°å¢é¤é»</button>
          </div>
        </div>
      </div>

      <div id="restaurantList" class="list"></div>
    </section>

    <!-- è¨‚é¤ç´€éŒ„ -->
    <section id="tab-orders" class="card hidden">
      <div class="sectionTitle">
        <b>è¨‚é¤ç´€éŒ„ï¼ˆå½™æ•´è¼¸å‡ºï¼‰</b>
        <span class="tag">å¯åˆªé™¤ / åŒ¯å‡º Excel</span>
      </div>

      <div class="hr"></div>

      <div class="grid2">
        <div>
          <div class="hint">ç¯©é¸ï¼ˆå‰ç«¯ç¯©é¸ï¼Œä¸éœ€è¦ indexï¼‰</div>

          <div class="row" style="margin-top:8px">
            <select id="fDept" style="min-width:180px">
              <option value="">å…¨éƒ¨éƒ¨é–€</option>
            </select>
            <select id="fName" style="min-width:180px">
              <option value="">å…¨éƒ¨å§“å</option>
            </select>
            <select id="fRest" style="min-width:220px">
              <option value="">å…¨éƒ¨é¤å»³</option>
            </select>
          </div>

          <div class="row" style="margin-top:8px">
            <span class="hint">æ—¥æœŸç¯„åœ</span>
            <input type="date" id="fDateStart">
            <span class="hint">ï½</span>
            <input type="date" id="fDateEnd">

            <select id="fPeriod" style="min-width:220px">
              <option value="">å…¨éƒ¨æ™‚æ®µ</option>
              <option value="lunch">ä¸­åˆï¼ˆ12:00 å‰ï¼‰</option>
              <option value="dinner">æ™šä¸Šï¼ˆ12:00(å«) å¾Œï¼‰</option>
            </select>

            <button class="btn" id="btnQuickToday">ä»Šå¤©</button>
            <button class="btn" id="btnQuickClearDate">æ¸…ç©ºæ—¥æœŸ</button>
            <button class="btn" id="btnClearFilter">æ¸…é™¤æ‰€æœ‰ç¯©é¸</button>
          </div>

          <div class="hint" id="orderHint"></div>
        </div>

        <div class="row" style="justify-content:flex-end;align-items:flex-end">
          <button class="btn primary" id="btnExportExcel">åŒ¯å‡º Excel</button>
          <button class="btn" id="btnReloadOrders">é‡æ–°è¼‰å…¥è¨‚å–®</button>
        </div>
      </div>

      <div class="hr"></div>
      <div id="orderList" class="list"></div>
    </section>

  </main>
</div>

<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
  import {
    getFirestore, collection, getDocs, addDoc, deleteDoc, doc, updateDoc
  } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

  /* âœ… æ›æˆä½ è‡ªå·±çš„ï¼ˆè¦è·Ÿ index/user ä¸€æ¨£ï¼‰ */
  const firebaseConfig = {
    apiKey: "YOUR_API_KEY",
    authDomain: "goldbricks-order.firebaseapp.com",
    projectId: "goldbricks-order",
    storageBucket: "goldbricks-order.appspot.com",
    messagingSenderId: "YOUR_SENDER_ID",
    appId: "YOUR_APP_ID"
  };

  const app = initializeApp(firebaseConfig);
  const db = getFirestore(app);

  const $ = (id)=>document.getElementById(id);
  const esc = (s)=>String(s??"").replace(/[&<>"']/g,m=>({ "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;" }[m]));
  const money = (n)=>(Number(n)||0).toLocaleString("zh-TW");

  function setHint(el, text, type=""){
    el.classList.remove("ok","warn","bad");
    if(type) el.classList.add(type);
    el.textContent = text || "";
  }

  // ========= ç®¡ç†è€…å¯†ç¢¼ =========
  (function guard(){
    const ok = sessionStorage.getItem("isAdmin") === "1";
    if(ok) return;
    const pin = prompt("è¼¸å…¥ 8520 é€²å…¥ç®¡ç†è€…å¾Œå°");
    if(pin === "8520"){
      sessionStorage.setItem("isAdmin","1");
      return;
    }
    alert("ç®¡ç†è€…å¯†ç¢¼éŒ¯èª¤");
    location.href = "index.html";
  })();

  // ========= Tabs =========
  document.querySelectorAll(".menu button[data-tab]").forEach(btn=>{
    btn.addEventListener("click", ()=>{
      document.querySelectorAll(".menu button").forEach(b=>b.classList.remove("active"));
      btn.classList.add("active");
      const tab = btn.dataset.tab;
      ["staff","restaurants","orders"].forEach(t=> $("tab-"+t).classList.toggle("hidden", t!==tab));
    });
  });
  $("btnGoUser").onclick=()=>location.href="user.html";

  // ========= æ™‚é–“å·¥å…· =========
  function toDate(createdAt){
    if(!createdAt?.seconds) return null;
    return new Date(createdAt.seconds * 1000);
  }
  function ymdLocal(d){
    const y = d.getFullYear();
    const m = String(d.getMonth()+1).padStart(2,"0");
    const dd = String(d.getDate()).padStart(2,"0");
    return `${y}-${m}-${dd}`;
  }
  function nowYMD(){
    return ymdLocal(new Date());
  }

  // è¦å‰‡ï¼š12:00 å‰ç‚ºä¸­åˆï¼›12:00(å«) å¾Œç‚ºæ™šä¸Š
  function getPeriod(createdAt){
    const d = toDate(createdAt);
    if(!d) return "";
    return d.getHours() < 12 ? "lunch" : "dinner";
  }
  function periodLabel(p){
    if(p==="lunch") return "ä¸­åˆ";
    if(p==="dinner") return "æ™šä¸Š";
    return "";
  }
  function periodBadgeHTML(p){
    if(p==="lunch") return `<span class="badge lunch">ğŸŸ¡ ä¸­åˆ</span>`;
    if(p==="dinner") return `<span class="badge dinner">ğŸ”µ æ™šä¸Š</span>`;
    return ``;
  }

  // ========= Data Cache =========
  let staff = [];        // {id,dept,name}
  let restaurants = [];  // {id,name,url,img,menus,addons}
  let orders = [];       // {id,...}

  // ========= äººå“¡ç®¡ç† =========
  async function loadStaff(){
    setHint($("topHint"), "è¼‰å…¥äººå“¡ä¸­â€¦");
    const snap = await getDocs(collection(db,"staff"));
    staff = snap.docs.map(d=>({ id:d.id, ...(d.data()||{}) }))
      .filter(x=>x.dept && x.name);

    staff.sort((a,b)=> String(a.dept).localeCompare(String(b.dept),"zh-Hant") || String(a.name).localeCompare(String(b.name),"zh-Hant"));
    renderStaff();
  }

  function renderStaff(){
    const box = $("staffList");
    box.innerHTML = "";
    if(!staff.length){
      box.innerHTML = `<div class="hint warn">å°šç„¡äººå“¡</div>`;
      return;
    }

    const map = new Map();
    for(const s of staff){
      if(!map.has(s.dept)) map.set(s.dept, []);
      map.get(s.dept).push(s);
    }

    for(const [dept, people] of map.entries()){
      const group = document.createElement("div");
      group.className = "group";

      const head = document.createElement("div");
      head.className = "groupHead";
      head.innerHTML = `<b>${esc(dept)}</b><span class="tag">${people.length} äºº</span>`;

      const body = document.createElement("div");
      body.className = "groupBody";

      head.addEventListener("click", ()=> body.classList.toggle("hidden"));

      for(const p of people){
        const row = document.createElement("div");
        row.className = "itemRow";
        row.innerHTML = `
          <div>
            <b>${esc(p.name)}</b>
            <div class="meta">éƒ¨é–€ï¼š${esc(p.dept)}</div>
          </div>
          <div class="actions">
            <button class="btn danger">åˆªé™¤</button>
          </div>
        `;
        row.querySelector("button").onclick = async ()=>{
          if(!confirm(`åˆªé™¤äººå“¡ï¼š${p.dept} / ${p.name}ï¼Ÿ`)) return;
          await deleteDoc(doc(db,"staff",p.id));
          await loadAll();
        };
        body.appendChild(row);
      }

      group.appendChild(head);
      group.appendChild(body);
      box.appendChild(group);
    }
  }

  $("btnAddStaff").onclick = async ()=>{
    const dept = ($("staffDept").value||"").trim();
    const name = ($("staffName").value||"").trim();
    if(!dept || !name){
      setHint($("staffHint"), "è«‹è¼¸å…¥éƒ¨é–€èˆ‡å§“å", "warn");
      return;
    }
    await addDoc(collection(db,"staff"), { dept, name });
    $("staffName").value = "";
    setHint($("staffHint"), "âœ… å·²æ–°å¢", "ok");
    await loadAll();
  };

  // ========= é¤å»³ç®¡ç† =========
  async function loadRestaurants(){
    const snap = await getDocs(collection(db,"restaurants"));
    restaurants = snap.docs.map(d=>{
      const v = d.data() || {};
      return {
        id:d.id,
        name:(v.name||"").trim(),
        url:(v.url||"").trim(),
        img:(v.img||"").trim(),
        menus:Array.isArray(v.menus)?v.menus:[],
        addons:Array.isArray(v.addons)?v.addons:[]
      };
    }).filter(r=>r.name);

    restaurants.sort((a,b)=>a.name.localeCompare(b.name,"zh-Hant"));

    $("restSelectForMenu").innerHTML =
      `<option value="">è«‹é¸é¤å»³</option>` +
      restaurants.map(r=>`<option value="${esc(r.id)}">${esc(r.name)}</option>`).join("");

    renderRestaurants();
  }

  function renderRestaurants(){
    const box = $("restaurantList");
    box.innerHTML = "";
    if(!restaurants.length){
      box.innerHTML = `<div class="hint warn">å°šç„¡é¤å»³</div>`;
      return;
    }

    restaurants.forEach(r=>{
      const group = document.createElement("div");
      group.className = "group";

      const head = document.createElement("div");
      head.className = "groupHead";
      head.innerHTML = `
        <div style="display:flex;flex-direction:column;gap:4px">
          <b>${esc(r.name)}</b>
          <span class="hint">${r.url ? "é»æ­¤å¯é–‹å•Ÿåº—å®¶ç¶²å€" : "ï¼ˆç„¡åº—å®¶ç¶²å€ï¼‰"}</span>
        </div>
        <div class="row">
          <span class="tag">${(r.menus||[]).length} é“é¤é»</span>
          <button class="btn danger" data-del>åˆªé™¤</button>
        </div>
      `;

      const body = document.createElement("div");
      body.className = "groupBody hidden";

      head.addEventListener("click", (e)=>{
        if(e.target?.closest?.("[data-del]")) return;
        body.classList.toggle("hidden");
      });

      head.querySelector("[data-del]").onclick = async (e)=>{
        e.stopPropagation();
        if(!confirm(`åˆªé™¤é¤å»³ï¼š${r.name}ï¼Ÿ`)) return;
        await deleteDoc(doc(db,"restaurants",r.id));
        await loadAll();
      };

      const menus = (r.menus||[]).map(m=>({
        id: m.id || m.itemId || crypto.randomUUID(),
        category: (m.category||m.type||"").trim(),
        name: (m.name||m.title||"").trim(),
        price: Number(m.price||0),
        defaultQty: Number(m.defaultQty||m.qty||0),
        addons: Array.isArray(m.addons)?m.addons:[]
      })).filter(m=>m.name);

      menus.sort((a,b)=> (a.category||"").localeCompare(b.category||"") || a.name.localeCompare(b.name,"zh-Hant"));

      if(!menus.length){
        const empty = document.createElement("div");
        empty.className = "hint warn";
        empty.textContent = "å°šæœªè¨­å®šé¤é»";
        body.appendChild(empty);
      }else{
        menus.forEach(m=>{
          const row = document.createElement("div");
          row.className = "itemRow";
          const addonText = (m.addons||[]).map(a=>{
            const n = (a?.name||a?.title||"").trim();
            const p = Number(a?.price||0);
            return n ? `${n}${p?`(+${p})`:"(å…è²»)"}` : "";
          }).filter(Boolean).join("ã€");

          row.innerHTML = `
            <div>
              <b>${m.category ? `ã€${esc(m.category)}ã€‘ ` : ""}${esc(m.name)}</b>
              <div class="meta">åƒ¹æ ¼ï¼š$ ${money(m.price)}ï½œé è¨­æ•¸é‡ï¼š${Number.isFinite(m.defaultQty)?m.defaultQty:0}</div>
              ${addonText ? `<div class="meta">åŠ è³¼ï¼š${esc(addonText)}</div>` : `<div class="meta">åŠ è³¼ï¼šâ€”</div>`}
            </div>
            <div class="actions">
              <button class="btn danger">åˆªé™¤æ­¤é¤é»</button>
            </div>
          `;

          row.querySelector("button").onclick = async ()=>{
            if(!confirm(`åˆªé™¤é¤é»ï¼š${m.name}ï¼ˆ${r.name}ï¼‰ï¼Ÿ`)) return;

            // ä»¥ id å„ªå…ˆåˆªï¼›è‹¥è³‡æ–™æ²’æœ‰ idï¼Œé€€å› name+price åˆª
            const before = Array.isArray(r.menus) ? r.menus : [];
            const byId = before.filter(x => (x.id||x.itemId) !== m.id);
            const fallback = (x)=> (String((x.name||x.title||"")).trim()===m.name && Number(x.price||0)===m.price);
            const filtered = byId.length !== before.length ? byId : before.filter(x=>!fallback(x));

            await updateDoc(doc(db,"restaurants",r.id), { menus: filtered });
            await loadAll();
          };

          body.appendChild(row);
        });
      }

      group.appendChild(head);
      group.appendChild(body);
      box.appendChild(group);
    });
  }

  $("btnAddRest").onclick = async ()=>{
    const name = ($("restName").value||"").trim();
    const url = ($("restUrl").value||"").trim();
    if(!name){
      setHint($("restHint"), "é¤å»³åç¨±å¿…å¡«", "warn");
      return;
    }
    await addDoc(collection(db,"restaurants"), { name, url, img:"", menus:[], addons:[] });
    $("restName").value = "";
    $("restUrl").value = "";
    setHint($("restHint"), "âœ… å·²æ–°å¢", "ok");
    await loadAll();
  };

  // ========= æ–°å¢é¤é»ï¼šæš«å­˜åŠ è³¼ =========
  let tempAddons = [];
  function renderTempAddons(){
    const box = $("addonTempList");
    box.innerHTML = "";
    if(!tempAddons.length){
      setHint($("addonHint"), "å°šæœªåŠ å…¥åŠ è³¼", "");
      return;
    }
    setHint($("addonHint"), `å·²åŠ å…¥ ${tempAddons.length} ç­†åŠ è³¼`, "ok");

    tempAddons.forEach((a, idx)=>{
      const row = document.createElement("div");
      row.className = "itemRow";
      row.innerHTML = `
        <div>
          <b>${esc(a.name)}</b>
          <div class="meta">${a.price ? `+ $ ${money(a.price)}` : "å…è²»"}</div>
        </div>
        <div class="actions">
          <button class="btn danger">ç§»é™¤</button>
        </div>
      `;
      row.querySelector("button").onclick = ()=>{
        tempAddons.splice(idx,1);
        renderTempAddons();
      };
      box.appendChild(row);
    });
  }

  $("btnAddAddon").onclick = ()=>{
    const name = ($("addonName").value||"").trim();
    const price = Number(($("addonPrice").value||"0").trim() || 0);
    if(!name) return setHint($("addonHint"), "è«‹è¼¸å…¥åŠ è³¼åç¨±", "warn");
    tempAddons.push({ name, price: Math.max(0, price|0) });
    $("addonName").value = "";
    $("addonPrice").value = "";
    renderTempAddons();
  };

  $("restSelectForMenu").addEventListener("change", ()=>{
    const rid = $("restSelectForMenu").value;
    const r = restaurants.find(x=>x.id===rid);
    $("menuAddTag").textContent = r ? r.name : "å°šæœªé¸é¤å»³";
  });

  $("btnAddMenu").onclick = async ()=>{
    const rid = $("restSelectForMenu").value;
    const r = restaurants.find(x=>x.id===rid);
    if(!r) return setHint($("menuHint"), "è«‹å…ˆé¸é¤å»³", "warn");

    const category = ($("menuCategory").value||"").trim();
    const name = ($("menuName").value||"").trim();
    const price = Number(($("menuPrice").value||"0").trim() || 0);
    const defaultQty = Number(($("menuDefaultQty").value||"0").trim() || 0);

    if(!name) return setHint($("menuHint"), "é¤é»åç¨±å¿…å¡«", "warn");

    const newItem = {
      id: crypto.randomUUID(),
      category,
      name,
      price: Math.max(0, price|0),
      defaultQty: Math.max(0, defaultQty|0),
      addons: tempAddons.map(a=>({ name:a.name, price:a.price }))
    };

    const before = Array.isArray(r.menus) ? r.menus : [];
    await updateDoc(doc(db,"restaurants",r.id), { menus: [...before, newItem] });

    $("menuCategory").value = "";
    $("menuName").value = "";
    $("menuPrice").value = "";
    $("menuDefaultQty").value = "";
    tempAddons = [];
    renderTempAddons();
    setHint($("menuHint"), "âœ… å·²æ–°å¢é¤é»", "ok");

    await loadAll();
  };

  // ========= è¨‚å–®ç´€éŒ„ =========
  async function loadOrders(){
    const snap = await getDocs(collection(db,"orders")); // ä¸ç”¨ where/orderByï¼Œé¿å… index
    orders = snap.docs.map(d=>({ id:d.id, ...(d.data()||{}) }));

    // å‰ç«¯æ’åºï¼šcreatedAt desc
    orders.sort((a,b)=> (b.createdAt?.seconds||0) - (a.createdAt?.seconds||0));

    buildOrderFilters();
    renderOrders();
  }

  function buildOrderFilters(){
    const depts = new Set();
    const names = new Set();
    const rests = new Set();

    orders.forEach(o=>{
      if(o.dept) depts.add(o.dept);
      if(o.name) names.add(o.name);
      if(o.restaurantName) rests.add(o.restaurantName);
    });

    const setOptions = (sel, items, label)=>{
      const cur = sel.value;
      sel.innerHTML = `<option value="">${label}</option>` + [...items].sort((a,b)=>String(a).localeCompare(String(b),"zh-Hant"))
        .map(x=>`<option value="${esc(x)}">${esc(x)}</option>`).join("");
      sel.value = cur && [...items].includes(cur) ? cur : "";
    };

    setOptions($("fDept"), depts, "å…¨éƒ¨éƒ¨é–€");
    setOptions($("fName"), names, "å…¨éƒ¨å§“å");
    setOptions($("fRest"), rests, "å…¨éƒ¨é¤å»³");
  }

  function getFilteredOrders(){
    const fd = $("fDept").value;
    const fn = $("fName").value;
    const fr = $("fRest").value;

    const ds = $("fDateStart").value;  // YYYY-MM-DD
    const de = $("fDateEnd").value;    // YYYY-MM-DD
    const fp = $("fPeriod").value;     // lunch/dinner

    return orders.filter(o=>{
      if(fd && o.dept !== fd) return false;
      if(fn && o.name !== fn) return false;
      if(fr && o.restaurantName !== fr) return false;

      // æ—¥æœŸç¯„åœ
      if(ds || de){
        const d = toDate(o.createdAt);
        if(!d) return false;
        const ymd = ymdLocal(d);
        if(ds && ymd < ds) return false;
        if(de && ymd > de) return false;
      }

      // æ™‚æ®µ
      if(fp){
        const p = getPeriod(o.createdAt);
        if(p !== fp) return false;
      }

      return true;
    });
  }

  function renderOrders(){
    const box = $("orderList");
    box.innerHTML = "";

    const list = getFilteredOrders();

    let sum = 0;
    list.forEach(o=> sum += Number(o.total||0));

    // é¡¯ç¤ºç¯©é¸æ‘˜è¦
    const fd = $("fDept").value || "å…¨éƒ¨éƒ¨é–€";
    const fn = $("fName").value || "å…¨éƒ¨å§“å";
    const fr = $("fRest").value || "å…¨éƒ¨é¤å»³";
    const ds = $("fDateStart").value || "â€”";
    const de = $("fDateEnd").value || "â€”";
    const fp = $("fPeriod").value ? ( $("fPeriod").value==="lunch" ? "ä¸­åˆ" : "æ™šä¸Š" ) : "å…¨éƒ¨æ™‚æ®µ";

    setHint($("orderHint"),
      `å…± ${list.length} ç­†ï½œåˆè¨ˆ $ ${money(sum)} ï½œ ${fd} / ${fn} / ${fr} ï½œ æ—¥æœŸï¼š${ds}ï½${de} ï½œ æ™‚æ®µï¼š${fp}`,
      list.length ? "ok" : "warn"
    );

    $("statPill").textContent = `è¨‚å–® ${list.length}ï½œ$ ${money(sum)}`;

    if(!list.length){
      box.innerHTML = `<div class="hint warn">ç›®å‰æ²’æœ‰è¨‚å–®</div>`;
      return;
    }

    list.forEach(o=>{
      const items = Array.isArray(o.items) ? o.items : [];
      const itemsText = items.map(it=>{
        const qty = Number(it.qty||0);
        const price = Number(it.price||0);
        const addonsSum = (it.addons||[]).reduce((s,a)=>s+(Number(a?.price||0)),0);
        const lineTotal = (price + addonsSum) * qty;

        const addons = (it.addons||[]).map(a=>{
          const n = (a?.name||"").trim();
          const p = Number(a?.price||0);
          return n ? `${n}${p?`(+${p})`:"(å…è²»)"}` : "";
        }).filter(Boolean).join("ã€");

        return `â€¢ ${esc(it.name||"")} x${qty} ï½œå–®åƒ¹$${money(price)}`
          + (addons ? ` ï½œåŠ è³¼ï¼š${esc(addons)}` : ``)
          + ` ï½œå“é …é‡‘é¡ï¼š$${money(lineTotal)}`;
      }).join("<br>");

      const d = toDate(o.createdAt);
      const createdText = d ? d.toLocaleString("zh-TW") : "";
      const p = getPeriod(o.createdAt);

      const row = document.createElement("div");
      row.className = "itemRow";
      row.innerHTML = `
        <div>
          <b>
            ${esc(o.restaurantName||"ï¼ˆæœªçŸ¥é¤å»³ï¼‰")}
            <span class="tag">${esc(o.dept||"")}/${esc(o.name||"")}</span>
            ${periodBadgeHTML(p)}
          </b>
          <div class="meta">æ™‚é–“ï¼š${esc(createdText)}ï½œè¨‚å–®ç¸½é¡ï¼š$ ${money(o.total||0)}</div>
          <div class="meta" style="margin-top:6px">${itemsText || "ï¼ˆç„¡å“é …ï¼‰"}</div>
          ${o.note ? `<div class="meta" style="margin-top:6px">æ•´å–®å‚™è¨»ï¼š${esc(o.note)}</div>` : ``}
        </div>
        <div class="actions">
          <button class="btn danger">åˆªé™¤</button>
        </div>
      `;

      row.querySelector("button").onclick = async ()=>{
        if(!confirm(`åˆªé™¤é€™ç­†è¨‚å–®ï¼Ÿ\n${o.dept||""}/${o.name||""} - ${o.restaurantName||""}`)) return;
        await deleteDoc(doc(db,"orders",o.id));
        await loadAll();
      };

      box.appendChild(row);
    });
  }

  // ç¯©é¸äº‹ä»¶
  $("fDept").onchange = renderOrders;
  $("fName").onchange = renderOrders;
  $("fRest").onchange = renderOrders;
  $("fDateStart").onchange = renderOrders;
  $("fDateEnd").onchange = renderOrders;
  $("fPeriod").onchange = renderOrders;

  $("btnClearFilter").onclick = ()=>{
    $("fDept").value = "";
    $("fName").value = "";
    $("fRest").value = "";
    $("fDateStart").value = "";
    $("fDateEnd").value = "";
    $("fPeriod").value = "";
    renderOrders();
  };

  // âœ… å¿«æ·ï¼šä»Šå¤©ï¼ˆèµ·æ—¥=è¿„æ—¥=ä»Šå¤©ï¼‰
  $("btnQuickToday").onclick = ()=>{
    const t = nowYMD();
    $("fDateStart").value = t;
    $("fDateEnd").value = t;
    renderOrders();
  };

  // âœ… å¿«æ·ï¼šæ¸…ç©ºæ—¥æœŸï¼ˆä¿ç•™å…¶ä»–ç¯©é¸ï¼‰
  $("btnQuickClearDate").onclick = ()=>{
    $("fDateStart").value = "";
    $("fDateEnd").value = "";
    renderOrders();
  };

  $("btnReloadOrders").onclick = async ()=>{ await loadOrders(); };

  // ========= åŒ¯å‡º Excelï¼ˆCSVï¼ŒExcel å¯é–‹ï½œåŒ¯å‡ºç¯©é¸å¾Œï¼‰ =========
  $("btnExportExcel").onclick = ()=>{
    const list = getFilteredOrders();

    const rows = [[
      "éƒ¨é–€","å§“å","é¤å»³","æ™‚æ®µ","å“é …","åŠ è³¼","æ•¸é‡","å–®åƒ¹","åŠ è³¼é‡‘é¡","å“é …é‡‘é¡","è¨‚å–®ç¸½é¡","ä¸‹å–®æ™‚é–“","æ•´å–®å‚™è¨»"
    ]];

    list.forEach(o=>{
      const d = toDate(o.createdAt);
      const createdText = d ? d.toLocaleString("zh-TW") : "";
      const period = periodLabel(getPeriod(o.createdAt)) || "";

      const items = Array.isArray(o.items) ? o.items : [];
      if(!items.length){
        rows.push([
          o.dept||"", o.name||"", o.restaurantName||"", period,
          "", "", "", "", "", "",
          Number(o.total||0), createdText, o.note||""
        ]);
        return;
      }

      items.forEach(it=>{
        const qty = Number(it.qty||0);
        const price = Number(it.price||0);

        const addonsArr = (it.addons||[]).map(a=>{
          const n = (a?.name||"").trim();
          const p = Number(a?.price||0);
          return n ? `${n}${p?`(+${p})`:"(å…è²»)"}` : "";
        }).filter(Boolean);

        const addonsText = addonsArr.join("ã€");
        const addonsSum = (it.addons||[]).reduce((s,a)=>s+(Number(a?.price||0)),0);
        const lineTotal = (price + addonsSum) * qty;

        rows.push([
          o.dept||"", o.name||"", o.restaurantName||"", period,
          it.name||"", addonsText,
          qty, price, addonsSum, lineTotal,
          Number(o.total||0), createdText, o.note||""
        ]);
      });
    });

    // CSVï¼ˆå« BOMï¼Œé¿å… Excel äº‚ç¢¼ï¼‰
    const csv = "\uFEFF" + rows.map(r=>r.map(v=>{
      const s = String(v ?? "");
      return /[,"\n]/.test(s) ? `"${s.replace(/"/g,'""')}"` : s;
    }).join(",")).join("\n");

    const a = document.createElement("a");
    a.href = URL.createObjectURL(new Blob([csv], { type:"text/csv;charset=utf-8" }));
    a.download = `orders_${new Date().toISOString().slice(0,10)}.csv`;
    a.click();
  };

  // ========= Reload =========
  $("btnReloadAll").onclick = async ()=>{ await loadAll(); };

  async function loadAll(){
    try{
      setHint($("topHint"), "è¼‰å…¥è³‡æ–™ä¸­â€¦");
      await loadStaff();
      await loadRestaurants();
      await loadOrders();
      setHint($("topHint"), "âœ… å·²æ›´æ–°", "ok");
    }catch(err){
      console.error(err);
      setHint($("topHint"), "è®€å–å¤±æ•—ï¼š" + String(err?.message||err), "bad");
    }
  }

  // initï¼šé è¨­å¸¶ä»Šå¤©æ—¥æœŸï¼ˆèµ·æ—¥=è¿„æ—¥=ä»Šå¤©ï¼‰
  (function initFilters(){
    const t = nowYMD();
    $("fDateStart").value = t;
    $("fDateEnd").value = t;
  })();

  // init
  renderTempAddons();
  loadAll();

</script>
</body>
</html>
