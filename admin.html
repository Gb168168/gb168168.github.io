<!doctype html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>GoldBricks Order｜管理者</title>
  <style>
    :root{
      --bg:#f5f4fb; --card:#fff; --text:#0f172a; --muted:#64748b;
      --primary:#fb7185; --primary2:#ff9a9e; --border:rgba(15,23,42,.10);
      --shadow:0 10px 30px rgba(15,23,42,.10);
      --radius:18px;
    }
    *{box-sizing:border-box}
    body{
      margin:0; font-family: ui-sans-serif, system-ui, -apple-system, "Segoe UI", Arial;
      background: radial-gradient(1200px 500px at 20% -10%, rgba(251,113,133,.22), transparent 60%),
                  radial-gradient(900px 500px at 100% 0%, rgba(255,154,158,.14), transparent 55%),
                  var(--bg);
      color:var(--text);
      min-height:100vh;
    }
    .layout{display:grid; grid-template-columns: 300px 1fr; gap:16px; padding:16px;}
    @media (max-width:980px){.layout{grid-template-columns:1fr}}
    .sidebar,.main{
      background: rgba(255,255,255,.78);
      border:1px solid var(--border);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      backdrop-filter: blur(10px);
    }
    .sidebar{padding:14px; position:sticky; top:16px; height: fit-content}
    .brand{display:flex; align-items:center; justify-content:space-between; gap:10px; padding:10px 10px 6px;}
    .brand h1{font-size:16px; margin:0}
    .brand small{color:var(--muted)}
    .nav{margin-top:10px; display:flex; flex-direction:column; gap:8px}
    .nav button{
      text-align:left; padding:11px 12px; border-radius:14px;
      border:1px solid var(--border); background:#fff; cursor:pointer;
      font-weight:800;
    }
    .nav button.active{
      border-color: rgba(251,113,133,.55);
      background: linear-gradient(90deg, rgba(251,113,133,.18), rgba(255,154,158,.10));
      box-shadow: 0 10px 22px rgba(251,113,133,.18);
    }

    .main{padding:14px}
    .topbar{display:flex; align-items:center; justify-content:space-between; gap:12px; padding:6px 6px 12px;}
    .topbar h2{margin:0; font-size:18px}
    .topbar .right{display:flex; gap:10px; align-items:center; flex-wrap:wrap}
    .pill{padding:8px 12px; border-radius:999px; border:1px solid var(--border); background:#fff; color:var(--muted); font-size:12.5px}
    .ghost{
      padding:9px 12px; border-radius:14px; border:1px solid var(--border);
      background:#fff; cursor:pointer; font-weight:800;
    }
    .primary{
      padding:9px 12px; border-radius:14px; border:none; cursor:pointer; font-weight:900;
      background: linear-gradient(90deg, var(--primary), var(--primary2));
      color:#fff; box-shadow: 0 14px 28px rgba(251,113,133,.22);
    }

    .grid{display:grid; grid-template-columns: 1fr 1fr; gap:14px}
    @media (max-width:980px){.grid{grid-template-columns:1fr}}
    .card{
      background:#fff; border:1px solid var(--border); border-radius:var(--radius);
      box-shadow: 0 8px 25px rgba(15,23,42,.07);
      padding:14px;
    }
    .card h3{margin:0 0 10px; font-size:15px}
    label{display:block; font-size:13px; color:var(--muted); margin:10px 0 6px;}
    input,select,textarea{
      width:100%; padding:11px 12px; border-radius:14px;
      border:1px solid var(--border); outline:none; background:#fff;
      font-size:14px;
    }
    textarea{min-height:92px; resize:vertical}
    input:focus,select:focus,textarea:focus{border-color: rgba(251,113,133,.7)}
    .row{display:grid; grid-template-columns: 1fr 1fr; gap:10px}
    .row3{display:grid; grid-template-columns: 1fr 1fr 1fr; gap:10px}
    .actions{display:flex; gap:10px; margin-top:12px; flex-wrap:wrap}
    .muted{color:var(--muted); font-size:12.5px; line-height:1.6}
    .hr{height:1px; background: var(--border); margin:12px 0}
    table{width:100%; border-collapse:collapse; font-size:13.5px}
    th,td{border-bottom:1px solid rgba(15,23,42,.08); padding:10px 8px; text-align:left; vertical-align:top}
    th{color:var(--muted); font-weight:900}
    .tag{display:inline-flex; padding:5px 10px; border-radius:999px; border:1px solid var(--border); background:#fff; color:var(--muted); font-size:12px}
    .btnSmall{
      padding:7px 10px; border-radius:12px; border:1px solid var(--border);
      background:#fff; cursor:pointer; font-weight:800; font-size:12.5px;
    }
    .btnDanger{border-color: rgba(239,68,68,.35)}
    .btnDanger:hover{border-color: rgba(239,68,68,.60)}
    .btnOk:hover{border-color: rgba(16,185,129,.55)}
    details summary{cursor:pointer; font-weight:900}
    .inline{display:flex; gap:10px; align-items:center; flex-wrap:wrap}
    .imgPrev{width:100%; max-height:220px; object-fit:cover; border-radius:14px; border:1px solid var(--border)}
    .subcard{
      background: rgba(15,23,42,.02);
      border:1px dashed rgba(15,23,42,.18);
      border-radius:16px;
      padding:12px;
    }
  </style>
</head>
<body>

  <div class="layout">
    <aside class="sidebar">
      <div class="brand">
        <div>
          <h1>管理者後台</h1>
          <small>GoldBricks Order</small>
        </div>
        <span class="tag">admin</span>
      </div>

      <div class="nav">
        <button class="navBtn" data-view="addRestaurant">新增餐廳（預設）</button>
        <button class="navBtn" data-view="staff">新增人員</button>
        <button class="navBtn" data-view="restaurants">餐廳管理（可編輯）</button>
        <button class="navBtn" data-view="orders">訂餐紀錄（彙整）</button>
        <div class="hr"></div>
        <button id="switchUser" class="navBtn">切換使用者模式</button>
        <button id="logout" class="navBtn">登出</button>
      </div>

      <p class="muted" style="margin:12px 8px 0;">
        ✅ 已接 Firestore<br/>
        ✅ 圖片改用「圖片網址」欄位（不使用 Storage）
      </p>
    </aside>

    <main class="main">
      <div class="topbar">
        <h2 id="title">新增餐廳</h2>
        <div class="right">
          <span class="pill" id="statusPill">連線中…</span>
          <button class="ghost" id="gotoIndex">回登入頁</button>
        </div>
      </div>

      <!-- VIEW: 新增餐廳（餐廳+餐點一次新增） -->
      <section class="view" id="view_addRestaurant">
        <div class="grid">
          <div class="card">
            <h3>餐廳資料（填完後直接新增上）</h3>

            <label>餐廳名稱</label>
            <input id="r_name" placeholder="例：金磚便當"/>

            <div class="row">
              <div>
                <label>電話</label>
                <input id="r_phone" placeholder="例：02-1234-5678"/>
              </div>
              <div>
                <label>地址</label>
                <input id="r_addr" placeholder="例：台北市…"/>
              </div>
            </div>

            <div class="row">
              <div>
                <label>網址</label>
                <input id="r_web" placeholder="https://..."/>
              </div>
              <div>
                <label>Google map 連結</label>
                <input id="r_map" placeholder="https://maps.google.com/..."/>
              </div>
            </div>

            <label>餐廳圖片網址（可空）</label>
            <input id="r_imgUrl" placeholder="https://...jpg / png"/>
            <img id="r_imgPrev" class="imgPrev" style="display:none; margin-top:10px" alt="preview"/>

            <label>備註</label>
            <textarea id="r_note" placeholder="可填營業時間、付款方式…"></textarea>

            <div class="actions">
              <button class="primary" id="btnSubmitAll">直接新增上（餐廳 + 餐點清單）</button>
              <button class="ghost" id="btnClearAll">清空</button>
            </div>

            <p class="muted">
              你可以先在右邊把餐點加入「餐點清單」，再按一次「直接新增上」。<br/>
              若不加餐點也可以，只會新增餐廳。
            </p>
          </div>

          <div class="card">
            <h3>餐點（先加入清單，可多筆）</h3>

            <div class="row">
              <div>
                <label>餐點類別（用輸入）</label>
                <input id="m_cat" placeholder="例：飯類 / 麵類 / 小菜 / 飲料"/>
              </div>
              <div>
                <label>預設數量</label>
                <input id="m_defaultQty" type="number" min="1" value="1"/>
              </div>
            </div>

            <label>餐點名稱</label>
            <input id="m_name" placeholder="例：排骨飯"/>

            <label>價格（單份）</label>
            <input id="m_price" type="number" min="0" placeholder="70"/>

            <div class="hr"></div>
            <h3 style="margin-top:0">加購項目（可多筆）</h3>

            <div class="subcard">
              <div class="row3">
                <div>
                  <label>加購名稱</label>
                  <input id="a_name" placeholder="例：蛋"/>
                </div>
                <div>
                  <label>加購金額</label>
                  <input id="a_price" type="number" min="0" placeholder="10"/>
                </div>
                <div style="display:flex; align-items:end; gap:10px">
                  <label style="display:flex; align-items:center; gap:8px; margin:0;">
                    <input id="a_free" type="checkbox" style="width:18px; height:18px;"/>
                    免費
                  </label>
                  <button class="btnSmall btnOk" id="btnAddAddon" type="button">加入加購</button>
                </div>
              </div>
              <div id="addonList" style="margin-top:10px"></div>
            </div>

            <div class="actions">
              <button class="btnSmall btnOk" id="btnAddMenuToQueue" type="button">加入餐點清單</button>
              <button class="ghost" id="btnClearMenu" type="button">清空餐點欄位</button>
            </div>

            <div class="hr"></div>
            <h3 style="margin-top:0">餐點清單（將一起新增）</h3>
            <div id="menuQueueWrap" class="muted">尚未加入餐點。</div>
          </div>
        </div>
      </section>

      <!-- VIEW: 新增人員 -->
      <section class="view" id="view_staff" style="display:none">
        <div class="grid">
          <div class="card">
            <h3>新增人員（可新增部門/人員名稱）</h3>

            <label>部門</label>
            <input id="s_dept" list="deptList" placeholder="例：FAE"/>
            <datalist id="deptList">
              <option>管理部</option><option>FAE</option><option>TSE</option><option>新場</option>
              <option>倉管</option><option>數據分析</option><option>RD</option><option>線上客服</option><option>維運</option>
            </datalist>

            <label>人員名稱</label>
            <input id="s_name" placeholder="例：小明（按 Enter 也可新增）"/>

            <div class="actions">
              <button class="primary" id="btnAddStaff">新增</button>
              <button class="ghost" id="btnClearStaff">清空</button>
            </div>

            <p class="muted">相同部門會自動收合顯示，並可刪除人員。</p>
          </div>

          <div class="card">
            <h3>人員清單（部門收合）</h3>
            <div id="staffWrap"></div>
          </div>
        </div>
      </section>

      <!-- VIEW: 餐廳管理（可編輯） -->
      <section class="view" id="view_restaurants" style="display:none">
        <div class="card">
          <h3>餐廳管理（所有訊息皆可編輯）</h3>
          <p class="muted">可直接改欄位後按「儲存」。圖片改成填「圖片網址」。</p>
          <div id="restaurantsWrap"></div>
        </div>

        <div class="card" style="margin-top:14px">
          <h3>餐點管理（依餐廳）</h3>
          <div class="inline">
            <label style="margin:0; min-width:120px; color:var(--muted)">選擇餐廳</label>
            <select id="rm_restaurant" style="min-width:260px"></select>
            <span class="muted">（下方可編輯 / 刪除餐點）</span>
          </div>
          <div class="hr"></div>
          <div id="menuManageWrap"></div>
        </div>
      </section>

      <!-- VIEW: 訂餐紀錄（彙整） -->
      <section class="view" id="view_orders" style="display:none">
        <div class="grid">
          <div class="card">
            <h3>訂單統計（預留版位）</h3>
            <div class="row">
              <div>
                <label>訂單日期</label>
                <input id="o_date" type="date"/>
              </div>
              <div>
                <label>統計模式</label>
                <select id="o_mode">
                  <option value="summary">同品項彙總</option>
                  <option value="raw">逐筆顯示</option>
                </select>
              </div>
            </div>
            <div class="actions">
              <button class="primary" id="btnLoadOrders">載入</button>
              <button class="ghost" id="btnToday">今天</button>
            </div>
            <p class="muted">彙整格式例：排骨飯70+蛋10 數量2；排骨飯70 數量1…</p>
          </div>

          <div class="card">
            <h3>訂餐紀錄（彙整輸出）</h3>
            <div id="ordersOut" class="muted">請選日期後按「載入」。</div>
          </div>
        </div>
      </section>

    </main>
  </div>

  <script type="module">
    // ====== 角色檢查 ======
    const roleKey = "gb_role";
    if (localStorage.getItem(roleKey) !== "admin") location.href = "./index.html";

    // ====== Firebase（你提供的 config） ======
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-app.js";
    import {
      getFirestore, collection, addDoc, doc, updateDoc, deleteDoc, getDocs,
      query, where, orderBy, limit
    } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyBdgOddTGAfqqHLnhnaJRv2_y7gyweuQEo",
      authDomain: "goldbricks-order.firebaseapp.com",
      projectId: "goldbricks-order",
      storageBucket: "goldbricks-order.firebasestorage.app",
      messagingSenderId: "463709758954",
      appId: "1:463709758954:web:429dc920f2f812d51cbe93",
      measurementId: "G-YQK8ZCC26R"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    const statusPill = document.getElementById("statusPill");
    statusPill.textContent = "已連線 Firestore";

    // ====== 工具 ======
    const $ = (id)=> document.getElementById(id);
    const esc = (s)=> (s??"").toString()
      .replaceAll("&","&amp;").replaceAll("<","&lt;").replaceAll(">","&gt;").replaceAll('"',"&quot;");
    const todayISO = ()=>{
      const d = new Date(); const pad = (n)=> String(n).padStart(2,"0");
      return `${d.getFullYear()}-${pad(d.getMonth()+1)}-${pad(d.getDate())}`;
    };

    // ====== 左側導覽切換 ======
    const title = $("title");
    const views = {
      addRestaurant: $("view_addRestaurant"),
      staff: $("view_staff"),
      restaurants: $("view_restaurants"),
      orders: $("view_orders"),
    };
    function show(viewKey){
      Object.entries(views).forEach(([k,el])=> el.style.display = (k===viewKey) ? "" : "none");
      document.querySelectorAll(".navBtn[data-view]").forEach(b=> b.classList.toggle("active", b.dataset.view===viewKey));
      title.textContent =
        viewKey==="addRestaurant" ? "新增餐廳" :
        viewKey==="staff" ? "新增人員" :
        viewKey==="restaurants" ? "餐廳管理" :
        "訂餐紀錄";
      if(viewKey==="restaurants"){ refreshRestaurantsManage(); refreshRestaurantSelects(); }
    }
    document.querySelectorAll(".navBtn[data-view]").forEach(btn=>{
      btn.addEventListener("click", ()=> show(btn.dataset.view));
    });
    show("addRestaurant");

    // ====== 登出 / 切換 ======
    $("logout").onclick = ()=>{
      localStorage.removeItem(roleKey);
      location.href = "./index.html";
    };
    $("switchUser").onclick = ()=>{
      localStorage.setItem(roleKey, "user");
      location.href = "./user.html";
    };
    $("gotoIndex").onclick = ()=> location.href = "./index.html";

    // ====== Firestore collections ======
    const colRestaurants = collection(db, "restaurants");
    const colStaff = collection(db, "staff");
    const colOrders = collection(db, "orders");

    // ====== 新增餐廳：圖片網址預覽 ======
    const r_imgUrl = $("r_imgUrl");
    const r_imgPrev = $("r_imgPrev");
    r_imgUrl.addEventListener("input", ()=>{
      const url = r_imgUrl.value.trim();
      if(!url){ r_imgPrev.style.display="none"; return; }
      r_imgPrev.src = url;
      r_imgPrev.style.display="";
    });
    r_imgPrev.addEventListener("error", ()=>{
      // 破圖就先隱藏，避免嚇到
      r_imgPrev.style.display="none";
    });

    // ====== 餐點清單：加購 + 餐點隊列 ======
    let currentAddons = [];     // 當前餐點的加購
    let menuQueue = [];         // 要一起新增的餐點清單（多筆）

    function renderAddonList(){
      const wrap = $("addonList");
      if(currentAddons.length===0){
        wrap.innerHTML = '<div class="muted">尚未加入加購</div>';
        return;
      }
      wrap.innerHTML = currentAddons.map((a,i)=>`
        <div class="inline" style="justify-content:space-between; padding:8px 10px; border:1px solid rgba(15,23,42,.10); border-radius:14px; background:#fff; margin-top:8px;">
          <div>
            <b>${esc(a.name)}</b>
            <span class="tag" style="margin-left:8px">+${a.price}</span>
            ${a.free ? '<span class="tag" style="margin-left:6px">免費</span>' : ''}
          </div>
          <button class="btnSmall btnDanger" data-del-addon="${i}">刪除</button>
        </div>
      `).join("");
      wrap.querySelectorAll("button[data-del-addon]").forEach(b=>{
        b.onclick = ()=>{
          currentAddons.splice(Number(b.dataset.delAddon), 1);
          renderAddonList();
        };
      });
    }

    function renderMenuQueue(){
      const wrap = $("menuQueueWrap");
      if(menuQueue.length===0){
        wrap.innerHTML = '<div class="muted">尚未加入餐點。</div>';
        return;
      }
      wrap.innerHTML = menuQueue.map((m,i)=>{
        const addons = (m.addons||[]).map(a=> `${a.name}+${a.price}${a.free?"(免費)":""}`).join("；") || "—";
        return `
          <div style="margin-top:10px; padding:10px 12px; border:1px solid rgba(15,23,42,.10); border-radius:16px; background:#fff">
            <div class="inline" style="justify-content:space-between">
              <div>
                <b>${esc(m.name)}</b>
                <span class="tag" style="margin-left:8px">${esc(m.category||"")}</span>
                <span class="tag" style="margin-left:6px">價格 ${Number(m.price||0)}</span>
                <span class="tag" style="margin-left:6px">預設數量 ${Number(m.defaultQty||1)}</span>
              </div>
              <button class="btnSmall btnDanger" data-del-menu="${i}">刪除</button>
            </div>
            <div class="muted" style="margin-top:8px">加購：${esc(addons)}</div>
          </div>
        `;
      }).join("");
      wrap.querySelectorAll("button[data-del-menu]").forEach(b=>{
        b.onclick = ()=>{
          menuQueue.splice(Number(b.dataset.delMenu), 1);
          renderMenuQueue();
        };
      });
    }

    renderAddonList();
    renderMenuQueue();

    $("btnAddAddon").onclick = ()=>{
      const name = $("a_name").value.trim();
      const free = $("a_free").checked;
      const price = free ? 0 : Number($("a_price").value||0);
      if(!name) return alert("請輸入加購名稱");
      if(!free && (isNaN(price) || price<0)) return alert("加購金額不正確");

      currentAddons.push({ name, price, free });
      $("a_name").value=""; $("a_price").value=""; $("a_free").checked=false;
      renderAddonList();
    };

    $("btnClearMenu").onclick = ()=>{
      $("m_cat").value="";
      $("m_name").value="";
      $("m_price").value="";
      $("m_defaultQty").value="1";
      currentAddons = [];
      $("a_name").value=""; $("a_price").value=""; $("a_free").checked=false;
      renderAddonList();
    };

    $("btnAddMenuToQueue").onclick = ()=>{
      const category = $("m_cat").value.trim();
      const name = $("m_name").value.trim();
      const price = Number($("m_price").value||0);
      const defaultQty = Math.max(1, Number($("m_defaultQty").value||1));

      if(!name) return alert("請輸入餐點名稱");
      if(!category) return alert("請輸入餐點類別");
      if(isNaN(price) || price<0) return alert("價格不正確");

      menuQueue.push({
        category,
        name,
        price,
        defaultQty,
        addons: currentAddons
      });

      // reset menu inputs for next
      $("btnClearMenu").click();
      renderMenuQueue();
      alert("已加入餐點清單");
    };

    $("btnClearAll").onclick = ()=>{
      $("r_name").value=""; $("r_phone").value=""; $("r_addr").value="";
      $("r_web").value=""; $("r_map").value=""; $("r_note").value="";
      $("r_imgUrl").value=""; r_imgPrev.style.display="none";
      menuQueue = [];
      $("btnClearMenu").click();
      renderMenuQueue();
    };

    // ====== 一鍵：新增餐廳 +（餐點清單一起新增） ======
    $("btnSubmitAll").onclick = async ()=>{
      const name = $("r_name").value.trim();
      if(!name) return alert("請輸入餐廳名稱");

      const imageUrl = $("r_imgUrl").value.trim();

      statusPill.textContent = "新增餐廳中…";
      const restaurantRef = await addDoc(colRestaurants, {
        name,
        phone: $("r_phone").value.trim(),
        address: $("r_addr").value.trim(),
        website: $("r_web").value.trim(),
        mapUrl: $("r_map").value.trim(),
        note: $("r_note").value.trim(),
        imageUrl,           // ✅ 只存網址，不用 Storage
        createdAt: Date.now()
      });

      // 把餐點清單寫入子集合
      if(menuQueue.length>0){
        statusPill.textContent = "新增餐點清單中…";
        const menuCol = collection(db, "restaurants", restaurantRef.id, "menu");
        for(const m of menuQueue){
          await addDoc(menuCol, {
            category: m.category,
            name: m.name,
            price: Number(m.price||0),
            defaultQty: Math.max(1, Number(m.defaultQty||1)),
            addons: m.addons || [],
            createdAt: Date.now()
          });
        }
      }

      statusPill.textContent = "新增完成 ✅";
      alert(menuQueue.length>0 ? "餐廳 + 餐點已新增！" : "餐廳已新增！");
      $("btnClearAll").click();
      await refreshRestaurantSelects();
    };

    // ====== 下拉（餐廳管理頁） ======
    async function refreshRestaurantSelects(){
      const snap = await getDocs(query(colRestaurants, orderBy("createdAt","desc"), limit(300)));
      const list = [];
      snap.forEach(d=> list.push({ id:d.id, ...d.data() }));

      const opts = list.map(r=> `<option value="${r.id}">${esc(r.name||"未命名")}</option>`).join("");
      $("rm_restaurant").innerHTML = opts ? `<option value="">請選擇</option>${opts}` : `<option value="">（尚無餐廳）</option>`;
    }
    await refreshRestaurantSelects();

    // ====== 新增人員 + 部門收合列表 ======
    async function refreshStaffList(){
      const snap = await getDocs(query(colStaff, orderBy("dept","asc"), orderBy("name","asc"), limit(500)));
      const map = new Map();
      snap.forEach(d=>{
        const v = d.data();
        const dept = (v.dept||"未分部門").trim();
        if(!map.has(dept)) map.set(dept, []);
        map.get(dept).push({ id:d.id, ...v });
      });

      const wrap = $("staffWrap");
      if(map.size===0){
        wrap.innerHTML = `<div class="muted">尚未新增人員</div>`;
        return;
      }

      wrap.innerHTML = Array.from(map.entries()).map(([dept, arr])=>`
        <details open style="border:1px solid rgba(15,23,42,.10); border-radius:16px; padding:10px 12px; margin-bottom:10px; background:#fff">
          <summary>${esc(dept)} <span class="tag" style="margin-left:8px">${arr.length}人</span></summary>
          <div style="margin-top:10px">
            ${arr.map(p=>`
              <div class="inline" style="justify-content:space-between; padding:8px 10px; border:1px solid rgba(15,23,42,.08); border-radius:14px; margin-top:8px;">
                <div><b>${esc(p.name||"")}</b></div>
                <button class="btnSmall btnDanger" data-delstaff="${p.id}">刪除</button>
              </div>
            `).join("")}
          </div>
        </details>
      `).join("");

      wrap.querySelectorAll("button[data-delstaff]").forEach(b=>{
        b.onclick = async ()=>{
          if(!confirm("確定刪除該人員？")) return;
          await deleteDoc(doc(db,"staff", b.dataset.delstaff));
          await refreshStaffList();
        };
      });
    }
    await refreshStaffList();

    $("btnAddStaff").onclick = async ()=>{
      const dept = $("s_dept").value.trim();
      const name = $("s_name").value.trim();
      if(!dept) return alert("請輸入部門");
      if(!name) return alert("請輸入人員名稱");
      await addDoc(colStaff, { dept, name, createdAt: Date.now() });
      $("s_name").value="";
      await refreshStaffList();
    };
    $("btnClearStaff").onclick = ()=>{ $("s_dept").value=""; $("s_name").value=""; };
    $("s_name").addEventListener("keydown", (e)=>{
      if(e.key==="Enter"){ e.preventDefault(); $("btnAddStaff").click(); }
    });

    // ====== 餐廳管理（可編輯） ======
    async function refreshRestaurantsManage(){
      const snap = await getDocs(query(colRestaurants, orderBy("createdAt","desc"), limit(300)));
      const list = [];
      snap.forEach(d=> list.push({ id:d.id, ...d.data() }));

      const wrap = $("restaurantsWrap");
      if(list.length===0){
        wrap.innerHTML = `<div class="muted">尚未新增餐廳</div>`;
        return;
      }

      wrap.innerHTML = list.map(r=>`
        <div class="card" style="margin-top:12px">
          <div class="inline" style="justify-content:space-between">
            <div>
              <b style="font-size:15px">${esc(r.name||"未命名")}</b>
              <span class="tag" style="margin-left:8px">${esc(r.id)}</span>
            </div>
            <button class="btnSmall btnDanger" data-delr="${r.id}">刪除餐廳</button>
          </div>

          <div class="row" style="margin-top:10px">
            <div>
              <label>餐廳名稱</label>
              <input data-r="${r.id}" data-k="name" value="${esc(r.name||"")}"/>
            </div>
            <div>
              <label>電話</label>
              <input data-r="${r.id}" data-k="phone" value="${esc(r.phone||"")}"/>
            </div>
          </div>

          <div class="row">
            <div>
              <label>地址</label>
              <input data-r="${r.id}" data-k="address" value="${esc(r.address||"")}"/>
            </div>
            <div>
              <label>網址</label>
              <input data-r="${r.id}" data-k="website" value="${esc(r.website||"")}"/>
            </div>
          </div>

          <div class="row">
            <div>
              <label>Google map 連結</label>
              <input data-r="${r.id}" data-k="mapUrl" value="${esc(r.mapUrl||"")}"/>
            </div>
            <div>
              <label>圖片網址</label>
              <input data-r="${r.id}" data-k="imageUrl" value="${esc(r.imageUrl||"")}"/>
            </div>
          </div>

          ${r.imageUrl ? `<img src="${esc(r.imageUrl)}" class="imgPrev" style="margin-top:10px" alt="img"
            onerror="this.style.display='none'"/>`
            : `<div class="muted" style="margin-top:10px">（尚無圖片網址）</div>`}

          <label>備註</label>
          <textarea data-r="${r.id}" data-k="note">${esc(r.note||"")}</textarea>

          <div class="actions">
            <button class="btnSmall btnOk" data-saver="${r.id}">儲存</button>
          </div>
        </div>
      `).join("");

      wrap.querySelectorAll("button[data-delr]").forEach(b=>{
        b.onclick = async ()=>{
          if(!confirm("刪除餐廳會連同餐點子集合一起失去（子集合需你在 Firebase Console 手動清理）。確定刪除？")) return;
          await deleteDoc(doc(db,"restaurants", b.dataset.delr));
          await refreshRestaurantSelects();
          await refreshRestaurantsManage();
        };
      });

      wrap.querySelectorAll("button[data-saver]").forEach(b=>{
        b.onclick = async ()=>{
          const rid = b.dataset.saver;
          const inputs = wrap.querySelectorAll(`[data-r="${rid}"]`);
          const patch = {};
          inputs.forEach(i=> patch[i.dataset.k] = i.value.trim());
          statusPill.textContent = "儲存中…";
          await updateDoc(doc(db,"restaurants", rid), patch);
          statusPill.textContent = "已儲存 ✅";
          await refreshRestaurantSelects();
          await refreshRestaurantsManage();
        };
      });

      $("rm_restaurant").onchange = ()=> refreshMenuManage();
    }

    // ====== 餐點管理（編輯/刪除）— 類別改輸入 ======
    async function refreshMenuManage(){
      const rid = $("rm_restaurant").value;
      const wrap = $("menuManageWrap");
      if(!rid){
        wrap.innerHTML = `<div class="muted">請先選擇餐廳</div>`;
        return;
      }
      const menuCol = collection(db, "restaurants", rid, "menu");
      const snap = await getDocs(query(menuCol, orderBy("createdAt","desc"), limit(600)));
      const list = [];
      snap.forEach(d=> list.push({ id:d.id, ...d.data() }));

      if(list.length===0){
        wrap.innerHTML = `<div class="muted">此餐廳尚無餐點</div>`;
        return;
      }

      wrap.innerHTML = `
        <table>
          <thead>
            <tr>
              <th>類別（輸入）</th>
              <th>餐點名稱</th>
              <th>價格</th>
              <th>預設數量</th>
              <th>加購項目</th>
              <th>操作</th>
            </tr>
          </thead>
          <tbody>
            ${list.map(m=>{
              const addons = (m.addons||[]).map(a=> `${a.name}+${a.price}${a.free?"(免費)":""}`).join("；") || "—";
              return `
                <tr>
                  <td><input data-mid="${m.id}" data-k="category" value="${esc(m.category||"")}"></td>
                  <td><input data-mid="${m.id}" data-k="name" value="${esc(m.name||"")}"></td>
                  <td><input data-mid="${m.id}" data-k="price" type="number" min="0" value="${Number(m.price||0)}"></td>
                  <td><input data-mid="${m.id}" data-k="defaultQty" type="number" min="1" value="${Number(m.defaultQty||1)}"></td>
                  <td class="muted" style="max-width:280px">${esc(addons)}</td>
                  <td style="white-space:nowrap">
                    <button class="btnSmall btnOk" data-savem="${m.id}">儲存</button>
                    <button class="btnSmall btnDanger" data-delm="${m.id}">刪除</button>
                  </td>
                </tr>
              `;
            }).join("")}
          </tbody>
        </table>
        <p class="muted" style="margin:10px 2px 0">※ 加購項目目前僅顯示；要做「編輯加購」我可以再加 UI。</p>
      `;

      wrap.querySelectorAll("button[data-delm]").forEach(b=>{
        b.onclick = async ()=>{
          if(!confirm("確定刪除餐點？")) return;
          await deleteDoc(doc(db, "restaurants", rid, "menu", b.dataset.delm));
          await refreshMenuManage();
        };
      });

      wrap.querySelectorAll("button[data-savem]").forEach(b=>{
        b.onclick = async ()=>{
          const mid = b.dataset.savem;
          const els = wrap.querySelectorAll(`[data-mid="${mid}"]`);
          const patch = {};
          els.forEach(el=>{
            const k = el.dataset.k;
            if(k==="price" || k==="defaultQty") patch[k] = Number(el.value||0);
            else patch[k] = el.value.trim();
          });
          patch.defaultQty = Math.max(1, Number(patch.defaultQty||1));
          patch.price = Math.max(0, Number(patch.price||0));
          await updateDoc(doc(db,"restaurants", rid, "menu", mid), patch);
          statusPill.textContent = "餐點已儲存 ✅";
        };
      });
    }

    // ====== 訂餐紀錄（彙整） ======
    $("btnToday").onclick = ()=> $("o_date").value = todayISO();
    $("o_date").value = todayISO();

    $("btnLoadOrders").onclick = async ()=>{
      const date = $("o_date").value;
      if(!date) return alert("請選日期");
      const mode = $("o_mode").value;

      const snap = await getDocs(query(colOrders, where("orderDate","==", date), limit(800)));
      const orders = [];
      snap.forEach(d=> orders.push({ id:d.id, ...d.data() }));

      if(orders.length===0){
        $("ordersOut").innerHTML = `<div class="muted">此日期沒有訂單</div>`;
        return;
      }

      if(mode==="raw"){
        $("ordersOut").innerHTML = orders.map(o=>`
          <div style="padding:10px 12px; border:1px solid rgba(15,23,42,.10); border-radius:14px; margin-top:10px; background:#fff">
            <div><b>${esc(o.userDept||"")}</b> / <b>${esc(o.userName||"")}</b> — <span class="tag">${esc(o.restaurantName||"")}</span></div>
            <div class="muted" style="margin-top:8px">
              ${(o.items||[]).map(it=>{
                const addonTxt = (it.addons||[]).map(a=> `+${a.name}${a.price?(" "+a.price):""}`).join("");
                const noteTxt = it.note ? `（備註：${esc(it.note)}）` : "";
                return `• ${esc(it.name)} ${it.price} ${addonTxt} × ${it.qty} ${noteTxt}`;
              }).join("<br/>")}
            </div>
          </div>
        `).join("");
        return;
      }

      const agg = new Map();
      for(const o of orders){
        for(const it of (o.items||[])){
          const addonKey = (it.addons||[]).map(a=> `${a.name}:${a.price||0}`).sort().join("|");
          const key = `${it.name}__${it.price}__${addonKey}`;
          if(!agg.has(key)){
            agg.set(key, { name: it.name, price: it.price, addons: it.addons||[], qty: 0 });
          }
          agg.get(key).qty += Number(it.qty||0);
        }
      }

      const lines = Array.from(agg.values()).sort((a,b)=> b.qty-a.qty).map(x=>{
        const addonTxt = (x.addons||[]).map(a=> `+${a.name}${a.price?(" "+a.price):""}`).join("");
        return `${x.name}${x.price}${addonTxt} 數量${x.qty}`;
      });

      $("ordersOut").innerHTML = `
        <div style="padding:12px 12px; border:1px solid rgba(15,23,42,.10); border-radius:14px; background:#fff">
          ${lines.join("；")}
        </div>
      `;
    };
  </script>
</body>
</html>
