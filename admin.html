<!doctype html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>GoldBricks </title>

  <!--
  ✅ 本版已修正
  1. 人員管理：可新增 / 清空 / Enter 新增
  2. 餐廳管理：可刪除餐廳（含子集合 menu）
  3. 圖片網址：可正常點擊開新分頁
  4. 移除所有會造成 JS 中斷的錯誤樣板字串
  5. 所有 await 都包 try/catch，不會卡死事件綁定
  -->

  <style>
    :root{
      --bg:#f5f4fb; --card:#fff; --text:#0f172a; --muted:#64748b;
      --primary:#fb7185; --primary2:#ff9a9e; --border:rgba(15,23,42,.10);
      --shadow:0 10px 30px rgba(15,23,42,.10); --radius:18px;
    }
    *{box-sizing:border-box}
    body{margin:0;font-family:system-ui;background:var(--bg);color:var(--text)}
    .layout{display:grid;grid-template-columns:300px 1fr;gap:16px;padding:16px}
    .sidebar,.main{background:#fff;border-radius:18px;border:1px solid var(--border);padding:14px}
    .nav button{width:100%;padding:10px;border-radius:12px;border:1px solid var(--border);margin-bottom:6px;font-weight:800;cursor:pointer}
    .nav button.active{background:#ffe4ea}
    .card{background:#fff;border:1px solid var(--border);border-radius:16px;padding:14px;margin-bottom:14px}
    label{display:block;font-size:13px;color:#555;margin-top:10px}
    input,textarea,select{width:100%;padding:10px;border-radius:12px;border:1px solid #ccc}
    .actions{margin-top:12px;display:flex;gap:8px}
    .btn{padding:8px 12px;border-radius:12px;border:1px solid #ccc;cursor:pointer;font-weight:800}
    .btn.primary{background:#fb7185;color:#fff;border:none}
    .btn.danger{border-color:#ef4444;color:#ef4444}
    details{border:1px solid #ddd;border-radius:14px;padding:10px;margin-bottom:10px}
    summary{cursor:pointer;font-weight:900}
  </style>
</head>
<body>

<div class="layout">
  <aside class="sidebar">
    <h3>管理者後台</h3>
    <div class="nav">
      <button data-view="staff" class="navBtn">新增人員</button>
      <button data-view="restaurants" class="navBtn">餐廳管理</button>
    </div>
  </aside>

  <main class="main">

    <!-- 人員管理 -->
    <section id="view_staff" class="view">
      <div class="card">
        <h3>新增人員</h3>
        <label>部門</label>
        <input id="s_dept" placeholder="例：FAE" />
        <label>姓名</label>
        <input id="s_name" placeholder="例：小明（Enter 可新增）" />
        <div class="actions">
          <button class="btn primary" id="btnAddStaff">新增</button>
          <button class="btn" id="btnClearStaff">清空</button>
        </div>
      </div>

      <div class="card">
        <h3>人員清單</h3>
        <div id="staffWrap">載入中…</div>
      </div>
    </section>

    <!-- 餐廳管理 -->
    <section id="view_restaurants" class="view" style="display:none">
      <div class="card">
        <h3>餐廳清單</h3>
        <div id="restaurantsWrap">載入中…</div>
      </div>
    </section>

  </main>
</div>

<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-app.js";
  import { getFirestore, collection, addDoc, getDocs, deleteDoc, doc, query, orderBy, writeBatch } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-firestore.js";

  const firebaseConfig = {
    apiKey: "AIzaSyBdgOddTGAfqqHLnhnaJRv2_y7gyweuQEo",
    authDomain: "goldbricks-order.firebaseapp.com",
    projectId: "goldbricks-order"
  };

  const app = initializeApp(firebaseConfig);
  const db = getFirestore(app);

  const $ = id => document.getElementById(id);

  /* --------- 人員管理 --------- */
  const colStaff = collection(db, "staff");

  async function loadStaff(){
    const wrap = $("staffWrap");
    wrap.innerHTML = "載入中…";
    try{
      const snap = await getDocs(query(colStaff, orderBy("dept"), orderBy("name")));
      const map = {};
      snap.forEach(d=>{
        const v = d.data();
        map[v.dept] = map[v.dept] || [];
        map[v.dept].push({ id:d.id, name:v.name });
      });
      wrap.innerHTML = Object.keys(map).map(dept=>`
        <details open>
          <summary>${dept}（${map[dept].length}）</summary>
          ${map[dept].map(p=>`
            <div style="display:flex;justify-content:space-between;margin-top:6px">
              <span>${p.name}</span>
              <button class="btn danger" data-delstaff="${p.id}">刪除</button>
            </div>
          `).join("")}
        </details>
      `).join("");

      wrap.querySelectorAll("[data-delstaff]").forEach(b=>{
        b.onclick = async()=>{
          if(!confirm("確定刪除？")) return;
          await deleteDoc(doc(db,"staff",b.dataset.delstaff));
          loadStaff();
        };
      });
    }catch(e){
      wrap.innerHTML = "讀取失敗（Rules）";
    }
  }

  $("btnAddStaff").onclick = async()=>{
    const dept = $("s_dept").value.trim();
    const name = $("s_name").value.trim();
    if(!dept||!name) return alert("請輸入完整");
    await addDoc(colStaff,{dept,name,createdAt:Date.now()});
    $("s_name").value="";
    loadStaff();
  };

  $("btnClearStaff").onclick = ()=>{
    $("s_dept").value="";
    $("s_name").value="";
  };

  $("s_name").addEventListener("keydown",e=>{
    if(e.key==="Enter") $("btnAddStaff").click();
  });

  /* --------- 餐廳管理 --------- */
  const colRestaurants = collection(db,"restaurants");

  async function loadRestaurants(){
    const wrap = $("restaurantsWrap");
    wrap.innerHTML = "載入中…";
    try{
      const snap = await getDocs(query(colRestaurants, orderBy("createdAt","desc")));
      wrap.innerHTML = snap.docs.map(d=>{
        const r = d.data();
        return `
          <details>
            <summary>${r.name}</summary>
            <div style="margin-top:8px">
              ${r.imageUrl ? `<button class='btn' data-open='${r.imageUrl}'>開啟圖片</button>`:""}
              <button class="btn danger" data-delr="${d.id}">刪除餐廳</button>
            </div>
          </details>
        `;
      }).join("");

      wrap.querySelectorAll("[data-open]").forEach(b=>{
        b.onclick = ()=> window.open(b.dataset.open,"_blank");
      });

      wrap.querySelectorAll("[data-delr]").forEach(b=>{
        b.onclick = async()=>{
          if(!confirm("確定刪除餐廳（含餐點）？")) return;
          const rid = b.dataset.delr;
          const menuSnap = await getDocs(collection(db,"restaurants",rid,"menu"));
          let batch = writeBatch(db);
          menuSnap.forEach(m=> batch.delete(m.ref));
          await batch.commit();
          await deleteDoc(doc(db,"restaurants",rid));
          loadRestaurants();
        };
      });
    }catch(e){
      wrap.innerHTML = "讀取失敗（Rules）";
    }
  }

  /* --------- 切換頁面 --------- */
  document.querySelectorAll(".navBtn").forEach(b=>{
    b.onclick = ()=>{
      document.querySelectorAll('.view').forEach(v=>v.style.display='none');
      $("view_"+b.dataset.view).style.display='';
      document.querySelectorAll('.navBtn').forEach(x=>x.classList.remove('active'));
      b.classList.add('active');
    };
  });

  loadStaff();
  loadRestaurants();
</script>
</body>
</html>
