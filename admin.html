<!doctype html>
<html lang="zh-Hant">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>點餐系統 - 管理者</title>

<style>
:root{
  --bg:#0b1220;--card:#0f1a33;--text:#e8eeff;--muted:#9fb0ff;
  --line:rgba(255,255,255,.12);--primary:#6ee7ff;--danger:#fb7185;
}
*{box-sizing:border-box}
body{
  margin:0;font-family:system-ui,"Noto Sans TC";
  background:var(--bg);color:var(--text);
}
.wrap{display:flex;min-height:100vh}
aside{
  width:240px;padding:14px;border-right:1px solid var(--line);
  background:#0a1430;
}
aside h2{margin:0 0 12px;font-size:16px}
.menu{display:grid;gap:8px}
.menu button{
  width:100%;padding:10px;border-radius:10px;
  background:rgba(255,255,255,.05);
  border:1px solid var(--line);color:var(--text);
  cursor:pointer;
}
.menu button.active{background:rgba(110,231,255,.18)}
main{flex:1;padding:16px}
.card{
  border:1px solid var(--line);
  border-radius:16px;
  padding:14px;
  background:rgba(255,255,255,.04);
  margin-bottom:14px;
}
.row{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
input,select,textarea{
  padding:8px 10px;border-radius:10px;
  border:1px solid var(--line);
  background:rgba(255,255,255,.06);
  color:var(--text);
}
button{cursor:pointer}
.btn{padding:8px 12px;border-radius:10px;border:1px solid var(--line)}
.btn.primary{background:rgba(110,231,255,.18)}
.btn.danger{background:rgba(251,113,133,.18)}
.hint{font-size:12px;color:var(--muted)}
.list{display:grid;gap:8px}
.hidden{display:none}
.hr{height:1px;background:var(--line);margin:10px 0}
.tag{font-size:12px;border:1px solid var(--line);padding:4px 8px;border-radius:999px}
</style>
</head>

<body>
<div class="wrap">

<!-- 左側 -->
<aside>
  <h2>管理者後台</h2>
  <div class="menu">
    <button data-tab="staff" class="active">人員管理</button>
    <button data-tab="restaurants">餐廳管理</button>
    <button data-tab="orders">訂餐紀錄</button>
    <button id="btnGoUser">回使用者頁</button>
  </div>
</aside>

<!-- 主區 -->
<main>

<!-- 人員管理 -->
<section id="tab-staff" class="card">
  <h3>人員管理</h3>
  <div class="row">
    <input id="staffDept" placeholder="部門">
    <input id="staffName" placeholder="姓名">
    <button class="btn primary" id="btnAddStaff">新增</button>
  </div>
  <div class="hr"></div>
  <div id="staffList" class="list"></div>
</section>

<!-- 餐廳管理 -->
<section id="tab-restaurants" class="card hidden">
  <h3>餐廳管理</h3>
  <div class="row">
    <input id="restName" placeholder="餐廳名稱">
    <input id="restUrl" placeholder="店家網址（可空）">
    <button class="btn primary" id="btnAddRest">新增餐廳</button>
  </div>
  <div class="hr"></div>
  <div id="restaurantList" class="list"></div>
</section>

<!-- 訂餐紀錄 -->
<section id="tab-orders" class="card hidden">
  <h3>訂餐紀錄（彙整）</h3>
  <div class="row">
    <button class="btn primary" id="btnExport">匯出 Excel</button>
    <span class="hint" id="orderHint"></span>
  </div>
  <div class="hr"></div>
  <div id="orderList" class="list"></div>
</section>

</main>
</div>

<script type="module">
/* Firebase */
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
import {
  getFirestore, collection, getDocs, addDoc, deleteDoc, doc
} from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

/* ⚠️ 換成你自己的 */
const firebaseConfig = {
  apiKey:"YOUR_API_KEY",
  authDomain:"goldbricks-order.firebaseapp.com",
  projectId:"goldbricks-order",
  storageBucket:"goldbricks-order.appspot.com",
  messagingSenderId:"YOUR_ID",
  appId:"YOUR_APP_ID"
};

const app = initializeApp(firebaseConfig);
const db = getFirestore(app);
const $ = id=>document.getElementById(id);

/* Tabs */
document.querySelectorAll(".menu button[data-tab]").forEach(b=>{
  b.onclick=()=>{
    document.querySelectorAll(".menu button").forEach(x=>x.classList.remove("active"));
    b.classList.add("active");
    document.querySelectorAll("section").forEach(s=>s.classList.add("hidden"));
    $("tab-"+b.dataset.tab).classList.remove("hidden");
  };
});
$("btnGoUser").onclick=()=>location.href="user.html";

/* 人員管理 */
async function loadStaff(){
  const box=$("staffList"); box.innerHTML="載入中…";
  const snap=await getDocs(collection(db,"staff"));
  const map={};
  snap.forEach(d=>{
    const v=d.data(); if(!map[v.dept]) map[v.dept]=[];
    map[v.dept].push({id:d.id,name:v.name});
  });
  box.innerHTML="";
  Object.keys(map).forEach(dept=>{
    const div=document.createElement("div");
    div.innerHTML=`<b>${dept}</b>`;
    map[dept].forEach(p=>{
      const r=document.createElement("div");
      r.className="row";
      r.innerHTML=`<span>${p.name}</span>
        <button class="btn danger">刪除</button>`;
      r.querySelector("button").onclick=async()=>{
        await deleteDoc(doc(db,"staff",p.id));
        loadStaff();
      };
      div.appendChild(r);
    });
    box.appendChild(div);
  });
}
$("btnAddStaff").onclick=async()=>{
  const d=$("staffDept").value.trim();
  const n=$("staffName").value.trim();
  if(!d||!n) return alert("請填完整");
  await addDoc(collection(db,"staff"),{dept:d,name:n});
  $("staffName").value="";
  loadStaff();
};

/* 餐廳管理 */
async function loadRestaurants(){
  const box=$("restaurantList"); box.innerHTML="";
  const snap=await getDocs(collection(db,"restaurants"));
  snap.forEach(d=>{
    const v=d.data();
    const div=document.createElement("div");
    div.className="card";
    div.innerHTML=`<b>${v.name}</b>
      <div class="hint">${v.url||""}</div>
      <button class="btn danger">刪除</button>`;
    div.querySelector("button").onclick=async()=>{
      await deleteDoc(doc(db,"restaurants",d.id));
      loadRestaurants();
    };
    box.appendChild(div);
  });
}
$("btnAddRest").onclick=async()=>{
  const n=$("restName").value.trim();
  if(!n) return;
  await addDoc(collection(db,"restaurants"),{name:n,url:$("restUrl").value});
  $("restName").value="";
  loadRestaurants();
};

/* 訂單紀錄（不需要 index） */
async function loadOrders(){
  const box=$("orderList"); box.innerHTML="";
  const snap=await getDocs(collection(db,"orders"));
  let total=0;
  snap.forEach(d=>{
    const o=d.data(); total+=o.total||0;
    const div=document.createElement("div");
    div.className="card";
    div.innerHTML=`
      <b>${o.restaurantName}</b>
      <div class="hint">${o.dept} / ${o.name}</div>
      <div>$ ${o.total||0}</div>
      <button class="btn danger">刪除</button>`;
    div.querySelector("button").onclick=async()=>{
      await deleteDoc(doc(db,"orders",d.id));
      loadOrders();
    };
    box.appendChild(div);
  });
  $("orderHint").textContent=`總金額：$ ${total}`;
}

$("btnExport").onclick=async()=>{
  const snap=await getDocs(collection(db,"orders"));
  let rows=[["部門","姓名","餐廳","品項","數量","單價","金額"]];
  snap.forEach(d=>{
    const o=d.data();
    (o.items||[]).forEach(i=>{
      rows.push([o.dept,o.name,o.restaurantName,i.name,i.qty,i.price,(i.qty*i.price)]);
    });
  });
  const csv=rows.map(r=>r.join(",")).join("\n");
  const a=document.createElement("a");
  a.href=URL.createObjectURL(new Blob([csv],{type:"text/csv"}));
  a.download="orders.csv"; a.click();
};

/* Init */
loadStaff(); loadRestaurants(); loadOrders();
</script>
</body>
</html>
