<!doctype html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>GoldBricks å‘·å¥”ğŸšï½œç®¡ç†è€…å¾Œå°</title>

  <!-- âœ… Excelï¼ˆSheetJSï¼‰ -->
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.19.3/dist/xlsx.full.min.js"></script>

  <style>
    :root{
      --bg:#f5f4fb; --card:#fff; --text:#0f172a; --muted:#64748b;
      --primary:#fb7185; --primary2:#ff9a9e; --border:rgba(15,23,42,.10);
      --shadow:0 10px 30px rgba(15,23,42,.10);
      --radius:18px;
    }
    *{box-sizing:border-box}
    body{
      margin:0; font-family: ui-sans-serif, system-ui, -apple-system, "Segoe UI", Arial;
      background: radial-gradient(1200px 500px at 20% -10%, rgba(251,113,133,.22), transparent 60%),
                  radial-gradient(900px 500px at 100% 0%, rgba(255,154,158,.14), transparent 55%),
                  var(--bg);
      color:var(--text);
      min-height:100vh;
    }
    .wrap{max-width:1300px; margin:0 auto; padding:16px;}
    .topbar{
      background: rgba(255,255,255,.78);
      border:1px solid var(--border);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      backdrop-filter: blur(10px);
      padding:12px 14px;
      display:flex; align-items:center; justify-content:space-between; gap:12px;
    }
    .topbar h1{font-size:18px; margin:0}
    .topbar .right{display:flex; gap:10px; align-items:center; flex-wrap:wrap}
    .pill{padding:8px 12px; border-radius:999px; border:1px solid var(--border); background:#fff; color:var(--muted); font-size:12.5px}
    .btn{
      padding:9px 12px; border-radius:14px; border:1px solid var(--border);
      background:#fff; cursor:pointer; font-weight:900;
    }
    .primary{
      padding:9px 12px; border-radius:14px; border:none; cursor:pointer; font-weight:900;
      background: linear-gradient(90deg, var(--primary), var(--primary2));
      color:#fff; box-shadow: 0 14px 28px rgba(251,113,133,.22);
    }
    .btn:disabled,.primary:disabled{opacity:.55; cursor:not-allowed}
    .grid{display:grid; grid-template-columns: 280px 1fr; gap:14px; margin-top:14px}
    @media (max-width:980px){.grid{grid-template-columns:1fr}}
    .card{
      background:#fff; border:1px solid var(--border); border-radius:var(--radius);
      box-shadow: 0 8px 25px rgba(15,23,42,.07);
      padding:14px;
    }
    .card h2{margin:0 0 10px; font-size:15px}
    label{display:block; font-size:13px; color:var(--muted); margin:10px 0 6px;}
    input,select,textarea{
      width:100%; padding:11px 12px; border-radius:14px;
      border:1px solid var(--border); outline:none; background:#fff;
      font-size:14px;
    }
    textarea{min-height:92px; resize:vertical}
    input:focus,select:focus,textarea:focus{border-color: rgba(251,113,133,.7)}
    .row{display:grid; grid-template-columns: 1fr 1fr; gap:10px}
    .muted{color:var(--muted); font-size:12.5px; line-height:1.6}
    .hr{height:1px; background: var(--border); margin:12px 0}
    .tag{display:inline-flex; padding:5px 10px; border-radius:999px; border:1px solid var(--border); background:#fff; color:var(--muted); font-size:12px}
    .inline{display:flex; gap:10px; align-items:center; flex-wrap:wrap}
    .danger{border-color: rgba(239,68,68,.35)}
    .navBtn{width:100%; text-align:left; padding:10px 12px; border-radius:14px; border:1px solid var(--border); background:#fff; cursor:pointer; font-weight:900;}
    .navBtn.active{border-color: rgba(251,113,133,.55); box-shadow:0 10px 22px rgba(251,113,133,.18);}
    .section{display:none;}
    .section.active{display:block;}

    .optGroup{
      margin-top:10px;
      border:1px solid rgba(15,23,42,.08);
      border-radius:14px;
      padding:10px;
      background:#fff;
    }
    .optHead{display:flex; align-items:center; justify-content:space-between; gap:10px; flex-wrap:wrap}
    .optHead b{font-size:13.5px}

    .box{
      border:1px solid rgba(15,23,42,.10);
      border-radius:16px;
      padding:12px;
      background:#fff;
      margin-top:10px;
    }
    .miniRow{display:grid; grid-template-columns: 1.1fr .7fr .6fr; gap:10px}
    @media (max-width:980px){.miniRow{grid-template-columns:1fr}}
    table{width:100%; border-collapse:collapse; font-size:13.5px}
    th,td{border-bottom:1px solid rgba(15,23,42,.08); padding:10px 8px; text-align:left; vertical-align:top}
    th{color:var(--muted); font-weight:900}
    .listLine{
      border:1px solid rgba(15,23,42,.10);
      border-radius:14px;
      padding:10px 12px;
      background:#fff;
      margin-top:10px;
    }
  </style>
</head>

<body>
  <div class="wrap">
    <div class="topbar">
      <div>
        <h1>ç®¡ç†è€…å¾Œå°</h1>
        <div class="muted" id="whoLine">å°šæœªé¸æ“‡é¤å»³</div>
      </div>
      <div class="right">
        <span class="pill" id="statusPill">é€£ç·šä¸­â€¦</span>
        <button class="btn" id="btnGoUser">å›ä½¿ç”¨è€…</button>
        <button class="btn" id="btnLogout">ç™»å‡º</button>
      </div>
    </div>

    <div class="grid">
      <!-- LEFT NAV -->
      <div class="card">
        <div class="inline" style="justify-content:space-between">
          <b>åŠŸèƒ½</b>
          <span class="tag">Admin</span>
        </div>
        <div class="hr"></div>
        <button class="navBtn active" data-tab="tabRestaurants">é»é¤ç®¡ç†</button>
        <button class="navBtn" data-tab="tabStaff">äººå“¡ç®¡ç†</button>
        <button class="navBtn" data-tab="tabOrders">æ­·å²ç´€éŒ„ / åŒ¯å‡º</button>
        <div class="hr"></div>
        <div class="muted">
          æç¤ºï¼šå¦‚æœè®€å–å¤±æ•—ï¼Œå¤šåŠæ˜¯ Rules / ç¶²è·¯ / Firebase è¨­å®šã€‚
        </div>
      </div>

      <!-- RIGHT CONTENT -->
      <div>

        <!-- TAB: RESTAURANTS / MENU -->
        <div class="section active" id="tabRestaurants">

          <div class="card">
            <h2>1ï¼‰é¤å»³æ¸…å–®ï¼ˆå¯é¸æ“‡å¾Œç®¡ç†é¤é»/é¡åˆ¥/ç‹€æ…‹ï¼‰</h2>

            <div class="row">
              <div>
                <label>é¸æ“‡é¤å»³</label>
                <select id="restaurantSelect">
                  <option value="">è¼‰å…¥ä¸­â€¦</option>
                </select>
              </div>
              <div class="inline" style="align-self:end; justify-content:flex-end">
                <button class="btn" id="btnReloadRestaurants">é‡æ–°è¼‰å…¥</button>
                <button class="btn danger" id="btnDeleteRestaurant">åˆªé™¤é¤å»³</button>
              </div>
            </div>

            <div class="hr"></div>

            <div class="row">
              <div>
                <label>é¡¯ç¤ºçµ¦ä½¿ç”¨è€…ï¼ˆisVisibleï¼‰</label>
                <select id="rVisible">
                  <option value="true">é¡¯ç¤º</option>
                  <option value="false">éš±è—</option>
                </select>
              </div>
              <div>
                <label>çµå–®ï¼ˆisClosedï¼‰</label>
                <select id="rClosed">
                  <option value="false">é–‹å–®ä¸­</option>
                  <option value="true">å·²çµå–®</option>
                </select>
              </div>
            </div>

            <div class="inline" style="margin-top:10px">
              <button class="primary" id="btnSaveRestaurantFlags">å„²å­˜ç‹€æ…‹</button>
              <span class="muted" id="restaurantFlagHint"></span>
            </div>
          </div>

          <div class="card" style="margin-top:14px">
            <h2>2ï¼‰æ–°å¢é¤å»³</h2>

            <div class="row">
              <div>
                <label>é¤å»³åç¨±</label>
                <input id="newRName" placeholder="ä¾‹ï¼šXXä¾¿ç•¶"/>
              </div>
              <div>
                <label>é¤å»³åœ–ç‰‡ URLï¼ˆå¯ç©ºï¼‰</label>
                <input id="newRImg" placeholder="https://..."/>
              </div>
            </div>

            <div class="row">
              <div>
                <label>åœ°å€ï¼ˆå¯ç©ºï¼‰</label>
                <input id="newRAddr" placeholder="ä¾‹ï¼šå°ä¸­å¸‚..."/>
              </div>
              <div>
                <label>é›»è©±ï¼ˆå¯ç©ºï¼‰</label>
                <input id="newRPhone" placeholder="ä¾‹ï¼š04-..."/>
              </div>
            </div>

            <label>Google Map é€£çµï¼ˆå¯ç©ºï¼‰</label>
            <input id="newRMap" placeholder="https://maps.google.com/..."/>

            <div class="inline" style="margin-top:12px">
              <button class="primary" id="btnAddRestaurant">æ–°å¢é¤å»³</button>
              <span class="muted">æ–°å¢å¾Œæœƒè‡ªå‹•å»ºç«‹ã€Œé¤é»é¡åˆ¥ã€ä¸‹æ‹‰ç¾¤çµ„ã€‚</span>
            </div>
          </div>

          <div class="card" style="margin-top:14px">
            <h2>3ï¼‰é¡åˆ¥ç®¡ç†ï¼ˆcategoryGroupsï¼šä¸‹æ‹‰é¸å–®é¸é …ï¼‰</h2>
            <div id="catMgrWrap" class="muted">è«‹å…ˆé¸æ“‡é¤å»³ã€‚</div>
          </div>

          <div class="card" style="margin-top:14px">
            <h2>4ï¼‰æ–°å¢é¤é»ï¼ˆé¡åˆ¥æ”¹ç”¨ä¸‹æ‹‰/ç¾¤çµ„ï¼‰</h2>

            <div id="menuAddWrap" class="muted">è«‹å…ˆé¸æ“‡é¤å»³ã€‚</div>

            <div class="hr"></div>
            <h2 style="margin-top:0">5ï¼‰é¤é»æ¸…å–®ï¼ˆå¯åˆªé™¤ï¼‰</h2>
            <div id="menuList" class="muted">å°šæœªé¸æ“‡é¤å»³ã€‚</div>
          </div>

        </div>

        <!-- TAB: STAFF -->
        <div class="section" id="tabStaff">
          <div class="card">
            <h2>äººå“¡ç®¡ç†ï¼ˆéƒ¨é–€ / äººå“¡ï¼‰</h2>

            <div class="row">
              <div>
                <label>éƒ¨é–€</label>
                <input id="staffDept" placeholder="ä¾‹ï¼šå·¥ç¨‹éƒ¨"/>
              </div>
              <div>
                <label>äººå“¡å§“å</label>
                <input id="staffName" placeholder="ä¾‹ï¼šå°æ˜ï¼ˆEnter ç›´æ¥æ–°å¢ï¼‰"/>
              </div>
            </div>

            <div class="inline" style="margin-top:12px">
              <button class="primary" id="btnAddStaff">æ–°å¢äººå“¡</button>
              <button class="btn" id="btnReloadStaff">é‡æ–°è¼‰å…¥</button>
            </div>

            <div class="hr"></div>
            <div id="staffWrap" class="muted">è¼‰å…¥ä¸­â€¦</div>
          </div>
        </div>

        <!-- TAB: ORDERS -->
        <div class="section" id="tabOrders">
          <div class="card">
            <h2>æ­·å²ç´€éŒ„ï¼ˆæŸ¥è©¢ / Excel åŒ¯å‡ºï¼‰</h2>
            <div class="row">
              <div>
                <label>æ—¥æœŸ</label>
                <input id="qDate" type="date"/>
              </div>
              <div>
                <label>åº—å®¶</label>
                <select id="qRestaurant">
                  <option value="">å…¨éƒ¨</option>
                </select>
              </div>
            </div>

            <label>è¼¸å…¥åç¨±ï¼ˆäººå“¡ï¼‰</label>
            <input id="qName" placeholder="ä¾‹ï¼šå°æ˜"/>

            <div class="inline" style="margin-top:12px">
              <button class="primary" id="btnQuery">æŸ¥è©¢</button>
              <button class="btn" id="btnToday">ğŸ²</button>

              <select id="qPeriod" style="width:auto; min-width:140px">
                <option value="">å…¨éƒ¨æ™‚æ®µ</option>
                <option value="noon">ä¸­åˆï¼ˆ12:00å‰ï¼‰</option>
                <option value="night">æ™šä¸Šï¼ˆ12:00å¾Œï¼‰</option>
              </select>

              <button class="btn" id="btnExportExcel">åŒ¯å‡º Excel</button>
            </div>

            <div class="hr"></div>
            <div id="ordersWrap" class="muted">å°šç„¡è³‡æ–™ã€‚</div>
          </div>
        </div>

      </div>
    </div>
  </div>

  <script type="module">
    // ===== Role Gate =====
    const roleKey = "gb_role";
    if (!localStorage.getItem(roleKey)) localStorage.setItem(roleKey, "admin");
    if (localStorage.getItem(roleKey) !== "admin") location.href = "./index.html";

    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-app.js";
    import {
      getFirestore, collection, addDoc, doc, getDocs, getDoc, updateDoc,
      deleteDoc, query, where, limit
    } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyBdgOddTGAfqqHLnhnaJRv2_y7gyweuQEo",
      authDomain: "goldbricks-order.firebaseapp.com",
      projectId: "goldbricks-order",
      storageBucket: "goldbricks-order.firebasestorage.app",
      messagingSenderId: "463709758954",
      appId: "1:463709758954:web:429dc920f2f812d51cbe93",
      measurementId: "G-YQK8ZCC26R"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    const $ = (id)=> document.getElementById(id);
    const statusPill = $("statusPill");
    const esc = (s)=> (s??"").toString()
      .replaceAll("&","&amp;").replaceAll("<","&lt;").replaceAll(">","&gt;").replaceAll('"',"&quot;");

    const todayISO = ()=>{
      const d = new Date(); const pad = (n)=> String(n).padStart(2,"0");
      return `${d.getFullYear()}-${pad(d.getMonth()+1)}-${pad(d.getDate())}`;
    };

    statusPill.textContent = "å·²é€£ç·š Firestore";

    // ===== Collections =====
    const colStaff = collection(db, "staff");
    const colRestaurants = collection(db, "restaurants");
    const colOrders = collection(db, "orders");

    // ===== State =====
    let restaurants = [];
    let selectedRestaurantId = "";
    let selectedRestaurant = null;   // restaurants/{rid} doc
    let menuCache = [];             // restaurants/{rid}/menu list

    function setWhoLine(){
      $("whoLine").innerHTML = selectedRestaurantId
        ? `<span class="tag">åº—å®¶</span> <b style="margin-left:6px">${esc(selectedRestaurant?.name || "")}</b>`
        : `å°šæœªé¸æ“‡é¤å»³`;
    }

    // ===== Tabs =====
    document.querySelectorAll(".navBtn").forEach(btn=>{
      btn.onclick = ()=>{
        document.querySelectorAll(".navBtn").forEach(b=> b.classList.remove("active"));
        btn.classList.add("active");
        const tab = btn.dataset.tab;
        document.querySelectorAll(".section").forEach(s=> s.classList.remove("active"));
        document.getElementById(tab).classList.add("active");
      };
    });

    // ===== Restaurants =====
    async function loadRestaurants(){
      try{
        statusPill.textContent = "è¼‰å…¥é¤å»³ä¸­â€¦";
        const snap = await getDocs(colRestaurants);
        const list = [];
        snap.forEach(d=> list.push({ id:d.id, ...d.data() }));

        list.sort((a,b)=>{
          const aa = Number(a.createdAt||0), bb = Number(b.createdAt||0);
          if(bb !== aa) return bb - aa;
          return (a.name||"").localeCompare((b.name||""),"zh-Hant");
        });

        restaurants = list;

        const sel = $("restaurantSelect");
        sel.innerHTML = `<option value="">è«‹é¸æ“‡</option>` + restaurants.map(r=>{
          const vis = (r.isVisible !== false);
          const closed = !!r.isClosed;
          const hint = `${vis ? "é¡¯ç¤º" : "éš±è—"} / ${closed ? "å·²çµå–®" : "é–‹å–®ä¸­"}`;
          return `<option value="${esc(r.id)}">${esc(r.name||"æœªå‘½å")}ï¼ˆ${esc(hint)}ï¼‰</option>`;
        }).join("");

        // Orders tab restaurant filter
        $("qRestaurant").innerHTML = `<option value="">å…¨éƒ¨</option>` + restaurants.map(r=>
          `<option value="${esc(r.id)}">${esc(r.name||"æœªå‘½å")}</option>`
        ).join("");

        // keep selected
        if(selectedRestaurantId && restaurants.find(r=> r.id===selectedRestaurantId)){
          sel.value = selectedRestaurantId;
        }else{
          selectedRestaurantId = "";
          selectedRestaurant = null;
          menuCache = [];
        }

        setWhoLine();
        renderRestaurantFlags();
        renderCategoryManager();
        renderMenuAdd();
        renderMenuList();

        statusPill.textContent = "é¤å»³è¼‰å…¥å®Œæˆ âœ…";
      }catch(err){
        console.error("loadRestaurants failed:", err);
        statusPill.textContent = "é¤å»³è®€å–å¤±æ•—ï¼ˆçœ‹ consoleï¼‰";
        alert("é¤å»³è®€å–å¤±æ•—ï¼ˆRules/ç¶²è·¯ï¼‰\n\n" + (err?.message || err));
      }
    }

    async function loadRestaurantDoc(rid){
      if(!rid){
        selectedRestaurantId = "";
        selectedRestaurant = null;
        menuCache = [];
        setWhoLine();
        renderRestaurantFlags();
        renderCategoryManager();
        renderMenuAdd();
        renderMenuList();
        return;
      }
      try{
        statusPill.textContent = "è®€å–é¤å»³è³‡æ–™â€¦";
        const snap = await getDoc(doc(db, "restaurants", rid));
        selectedRestaurantId = rid;
        selectedRestaurant = snap.exists() ? snap.data() : null;

        setWhoLine();
        renderRestaurantFlags();
        renderCategoryManager();

        await loadMenu(rid);
        renderMenuAdd();
        renderMenuList();

        statusPill.textContent = "å·²é¸æ“‡é¤å»³ âœ…";
      }catch(err){
        console.error("loadRestaurantDoc failed:", err);
        statusPill.textContent = "è®€å–é¤å»³å¤±æ•—ï¼ˆçœ‹ consoleï¼‰";
        alert("è®€å–é¤å»³å¤±æ•—ï¼ˆRules/ç¶²è·¯ï¼‰\n\n" + (err?.message || err));
      }
    }

    function ensureDefaultCategoryGroups(obj){
      const cur = Array.isArray(obj?.categoryGroups) ? obj.categoryGroups : [];
      if(cur.length > 0) return cur;
      return [{
        name: "é¤é»é¡åˆ¥",
        type: "single",
        required: true,
        options: [
          { name: "éºµé¡" },
        ]
      }];
    }

    async function addRestaurant(){
      const name = ($("newRName").value || "").trim();
      const imageUrl = ($("newRImg").value || "").trim();
      const address = ($("newRAddr").value || "").trim();
      const phone = ($("newRPhone").value || "").trim();
      const mapUrl = ($("newRMap").value || "").trim();

      if(!name) return alert("è«‹è¼¸å…¥é¤å»³åç¨±");

      try{
        statusPill.textContent = "æ–°å¢é¤å»³ä¸­â€¦";
        const payload = {
          name,
          imageUrl,
          address,
          phone,
          mapUrl,
          isVisible: true,
          isClosed: false,
          createdAt: Date.now(),
          categoryGroups: ensureDefaultCategoryGroups({})
        };
        const ref = await addDoc(colRestaurants, payload);

        $("newRName").value = "";
        $("newRImg").value = "";
        $("newRAddr").value = "";
        $("newRPhone").value = "";
        $("newRMap").value = "";

        await loadRestaurants();
        $("restaurantSelect").value = ref.id;
        await loadRestaurantDoc(ref.id);

        statusPill.textContent = "æ–°å¢é¤å»³å®Œæˆ âœ…";
      }catch(err){
        console.error("addRestaurant failed:", err);
        statusPill.textContent = "æ–°å¢é¤å»³å¤±æ•—ï¼ˆçœ‹ consoleï¼‰";
        alert("æ–°å¢é¤å»³å¤±æ•—ï¼ˆRules/ç¶²è·¯ï¼‰\n\n" + (err?.message || err));
      }
    }

    function renderRestaurantFlags(){
      const hint = $("restaurantFlagHint");
      if(!selectedRestaurantId || !selectedRestaurant){
        $("rVisible").disabled = true;
        $("rClosed").disabled = true;
        $("btnSaveRestaurantFlags").disabled = true;
        hint.textContent = "è«‹å…ˆé¸æ“‡é¤å»³";
        return;
      }
      $("rVisible").disabled = false;
      $("rClosed").disabled = false;
      $("btnSaveRestaurantFlags").disabled = false;

      $("rVisible").value = (selectedRestaurant.isVisible !== false) ? "true" : "false";
      $("rClosed").value = (!!selectedRestaurant.isClosed) ? "true" : "false";
      hint.textContent = "";
    }

    async function saveRestaurantFlags(){
      if(!selectedRestaurantId) return;
      try{
        statusPill.textContent = "å„²å­˜é¤å»³ç‹€æ…‹â€¦";
        const isVisible = $("rVisible").value === "true";
        const isClosed = $("rClosed").value === "true";
        await updateDoc(doc(db, "restaurants", selectedRestaurantId), { isVisible, isClosed });
        await loadRestaurantDoc(selectedRestaurantId);
        await loadRestaurants();
        statusPill.textContent = "å„²å­˜å®Œæˆ âœ…";
      }catch(err){
        console.error("saveRestaurantFlags failed:", err);
        statusPill.textContent = "å„²å­˜å¤±æ•—ï¼ˆçœ‹ consoleï¼‰";
        alert("å„²å­˜å¤±æ•—ï¼ˆRules/ç¶²è·¯ï¼‰\n\n" + (err?.message || err));
      }
    }

    async function deleteRestaurant(){
      if(!selectedRestaurantId) return alert("è«‹å…ˆé¸æ“‡é¤å»³");
      if(!confirm("ç¢ºå®šåˆªé™¤æ­¤é¤å»³ï¼Ÿ\nï¼ˆæ³¨æ„ï¼šå­é›†åˆ menu ä¸æœƒè‡ªå‹•åˆªï¼ŒFirestore éœ€è¦å¦å¤–æ¸…é™¤ï¼‰")) return;
      try{
        await deleteDoc(doc(db, "restaurants", selectedRestaurantId));
        selectedRestaurantId = "";
        selectedRestaurant = null;
        menuCache = [];
        await loadRestaurants();
        statusPill.textContent = "åˆªé™¤é¤å»³å®Œæˆ âœ…";
      }catch(err){
        console.error("deleteRestaurant failed:", err);
        alert("åˆªé™¤é¤å»³å¤±æ•—ï¼ˆRules/ç¶²è·¯ï¼‰\n\n" + (err?.message || err));
      }
    }

    // ===== Category Manager (categoryGroups) =====
    function getCategoryGroup(){
      const groups = ensureDefaultCategoryGroups(selectedRestaurant || {});
      return { groups, g0: groups[0] };
    }

    async function saveCategoryGroups(groups){
      if(!selectedRestaurantId) return;
      await updateDoc(doc(db, "restaurants", selectedRestaurantId), { categoryGroups: groups });
      await loadRestaurantDoc(selectedRestaurantId);
      await loadRestaurants();
    }

    function renderCategoryManager(){
      const wrap = $("catMgrWrap");
      if(!selectedRestaurantId || !selectedRestaurant){
        wrap.innerHTML = `<div class="muted">è«‹å…ˆé¸æ“‡é¤å»³ã€‚</div>`;
        return;
      }

      const { groups, g0 } = getCategoryGroup();
      const opts = Array.isArray(g0.options) ? g0.options : [];

      wrap.innerHTML = `
        <div class="inline" style="justify-content:space-between">
          <div>
            <span class="tag">ç¾¤çµ„</span>
            <b style="margin-left:8px">${esc(g0.name || "é¤é»é¡åˆ¥")}</b>
          </div>
          <span class="muted">ï¼ˆæ­¤ç¾¤çµ„ç”¨æ–¼ã€Œæ–°å¢é¤é»ã€çš„é¡åˆ¥ä¸‹æ‹‰ï¼‰</span>
        </div>

        <div class="box" style="margin-top:10px">
          <div class="row">
            <div>
              <label>æ–°å¢é¡åˆ¥</label>
              <input id="catNewName" placeholder="ä¾‹ï¼šéºµé¡ / é£¯é¡ / å°èœ"/>
            </div>
            <div class="inline" style="align-self:end; justify-content:flex-end">
              <button class="primary" id="btnAddCategory" type="button">æ–°å¢</button>
              <button class="btn" id="btnResetCategoryDefault" type="button">å¥—ç”¨é è¨­</button>
            </div>
          </div>

          <div class="hr"></div>
          <div class="muted">ç›®å‰é¡åˆ¥ï¼ˆ${opts.length}ï¼‰</div>
          <div id="catList"></div>
        </div>
      `;

      const listWrap = document.getElementById("catList");
      if(opts.length === 0){
        listWrap.innerHTML = `<div class="muted" style="margin-top:8px">å°šç„¡é¡åˆ¥ï¼Œè«‹å…ˆæ–°å¢ã€‚</div>`;
      }else{
        listWrap.innerHTML = opts.map((o,idx)=>`
          <div class="listLine">
            <div class="inline" style="justify-content:space-between">
              <div><b>${esc(o.name||"")}</b></div>
              <button class="btn danger" data-del-cat="${idx}" type="button">åˆªé™¤</button>
            </div>
          </div>
        `).join("");

        listWrap.querySelectorAll("button[data-del-cat]").forEach(btn=>{
          btn.onclick = async ()=>{
            const idx = Number(btn.dataset.delCat);
            if(!confirm("ç¢ºå®šåˆªé™¤æ­¤é¡åˆ¥ï¼Ÿ")) return;
            const { groups, g0 } = getCategoryGroup();
            const cur = Array.isArray(g0.options) ? g0.options : [];
            g0.options = cur.filter((_,i)=> i!==idx);
            groups[0] = g0;
            try{
              statusPill.textContent = "åˆªé™¤é¡åˆ¥ä¸­â€¦";
              await saveCategoryGroups(groups);
              statusPill.textContent = "åˆªé™¤é¡åˆ¥å®Œæˆ âœ…";
            }catch(err){
              console.error(err);
              alert("åˆªé™¤é¡åˆ¥å¤±æ•—ï¼ˆRules/ç¶²è·¯ï¼‰\n\n" + (err?.message || err));
            }
          };
        });
      }

      document.getElementById("btnAddCategory").onclick = async ()=>{
        const name = (document.getElementById("catNewName").value || "").trim();
        if(!name) return alert("è«‹è¼¸å…¥é¡åˆ¥åç¨±");
        const { groups, g0 } = getCategoryGroup();
        const cur = Array.isArray(g0.options) ? g0.options : [];
        if(cur.some(x => (x.name||"") === name)) return alert("æ­¤é¡åˆ¥å·²å­˜åœ¨");
        g0.options = [...cur, { name }];
        groups[0] = g0;

        try{
          statusPill.textContent = "æ–°å¢é¡åˆ¥ä¸­â€¦";
          await saveCategoryGroups(groups);
          statusPill.textContent = "æ–°å¢é¡åˆ¥å®Œæˆ âœ…";
        }catch(err){
          console.error(err);
          alert("æ–°å¢é¡åˆ¥å¤±æ•—ï¼ˆRules/ç¶²è·¯ï¼‰\n\n" + (err?.message || err));
        }
      };

      document.getElementById("btnResetCategoryDefault").onclick = async ()=>{
        if(!confirm("ç¢ºå®šå¥—ç”¨é è¨­é¡åˆ¥ï¼ˆæœƒè¦†è“‹ç›®å‰é¡åˆ¥ï¼‰ï¼Ÿ")) return;
        const groups = ensureDefaultCategoryGroups({});
        try{
          statusPill.textContent = "å¥—ç”¨é è¨­é¡åˆ¥ä¸­â€¦";
          await saveCategoryGroups(groups);
          statusPill.textContent = "å¥—ç”¨å®Œæˆ âœ…";
        }catch(err){
          console.error(err);
          alert("å¥—ç”¨å¤±æ•—ï¼ˆRules/ç¶²è·¯ï¼‰\n\n" + (err?.message || err));
        }
      };
    }

    // ===== Menu =====
    async function loadMenu(rid){
      try{
        statusPill.textContent = "è¼‰å…¥é¤é»ä¸­â€¦";
        const menuCol = collection(db, "restaurants", rid, "menu");
        const snap = await getDocs(menuCol);
        const list = [];
        snap.forEach(d=> list.push({ id:d.id, ...d.data() }));

        list.sort((a,b)=>{
          const aa = Number(a.createdAt||0), bb = Number(b.createdAt||0);
          if(bb !== aa) return bb - aa;
          const ca = (a.category||"").localeCompare((b.category||""),"zh-Hant");
          if(ca !== 0) return ca;
          return (a.name||"").localeCompare((b.name||""),"zh-Hant");
        });

        menuCache = list;
        statusPill.textContent = "é¤é»è¼‰å…¥å®Œæˆ âœ…";
      }catch(err){
        console.error("loadMenu failed:", err);
        statusPill.textContent = "é¤é»è®€å–å¤±æ•—ï¼ˆçœ‹ consoleï¼‰";
        menuCache = [];
      }
    }

    function renderCategoryPickerHTML(){
      const { g0 } = getCategoryGroup();
      const opts = Array.isArray(g0.options) ? g0.options : [];
      const req = (g0.required !== false);

      if(opts.length === 0){
        return `
          <div class="optGroup">
            <div class="optHead">
              <b>${esc(g0.name || "é¤é»é¡åˆ¥")}</b>
              <span class="tag">${req ? "å¿…é¸" : "å¯ä¸é¸"}</span>
            </div>
            <div class="muted" style="margin-top:6px">å°šç„¡é¡åˆ¥ï¼Œè«‹å…ˆåˆ°ä¸Šæ–¹ã€Œé¡åˆ¥ç®¡ç†ã€æ–°å¢ã€‚</div>
          </div>
        `;
      }

      return `
        <div class="optGroup">
          <div class="optHead">
            <b>${esc(g0.name || "é¤é»é¡åˆ¥")}</b>
            <span class="tag">${req ? "å¿…é¸" : "å¯ä¸é¸"}</span>
          </div>
          <select id="menuCategorySelect" data-cat-gi="0">
            ${req ? "" : `<option value="-1">ä¸é¸æ“‡</option>`}
            ${opts.map((o,oi)=>`<option value="${oi}">${esc(o.name||"")}</option>`).join("")}
          </select>
          <div class="muted" style="margin-top:6px">â€» æ–°å¢é¤é»æ™‚æœƒæŠŠé¸åˆ°çš„é¡åˆ¥å­˜åˆ° menu.categoryï¼ˆå­—ä¸²ï¼‰</div>
        </div>
      `;
    }

    function getPickedCategoryValue(){
      const sel = document.getElementById("menuCategorySelect");
      if(!sel) return "";
      const idx = Number(sel.value);
      const { g0 } = getCategoryGroup();
      const req = (g0.required !== false);
      if(req && (!Number.isFinite(idx) || idx < 0)) return "";
      const opt = (Array.isArray(g0.options) ? g0.options : [])[idx];
      return (opt?.name || "").trim();
    }

    function renderMenuAdd(){
      const wrap = $("menuAddWrap");
      if(!selectedRestaurantId || !selectedRestaurant){
        wrap.innerHTML = `<div class="muted">è«‹å…ˆé¸æ“‡é¤å»³ã€‚</div>`;
        return;
      }

      wrap.innerHTML = `
        ${renderCategoryPickerHTML()}

        <div class="row" style="margin-top:10px">
          <div>
            <label>é¤é»åç¨±</label>
            <input id="mName" placeholder="ä¾‹ï¼šæ³•å¼ç‚’éºµ"/>
          </div>
          <div>
            <label>åƒ¹æ ¼ï¼ˆå–®ä»½ï¼‰</label>
            <input id="mPrice" type="number" min="0" value="0"/>
          </div>
        </div>

        <div class="row">
          <div>
            <label>é è¨­æ•¸é‡ï¼ˆdefaultQtyï¼‰</label>
            <input id="mDefaultQty" type="number" min="1" value="1"/>
          </div>
          <div>
            <label>å‚™è¨»ï¼ˆå¯ç©ºï¼‰</label>
            <input id="mNote" placeholder="ä¾‹ï¼šå¯èª¿è¾£åº¦"/>
          </div>
        </div>

        <div class="box">
          <div class="inline" style="justify-content:space-between">
            <b>åŠ è³¼é …ç›® addonsï¼ˆå¯å¤šç­†ï¼‰</b>
            <button class="btn" id="btnAddAddonRow" type="button">ï¼‹æ–°å¢ä¸€åˆ—</button>
          </div>
          <div id="addonRows" class="muted" style="margin-top:8px"></div>
        </div>

        <div class="box">
          <div class="inline" style="justify-content:space-between">
            <b>é¸é … optionGroupsï¼ˆä¸‹æ‹‰ / å¯åŠ åƒ¹ï¼‰</b>
            <button class="btn" id="btnAddOptionGroup" type="button">ï¼‹æ–°å¢ä¸€çµ„</button>
          </div>
          <div id="optGroupsWrap" class="muted" style="margin-top:8px"></div>
        </div>

        <div class="inline" style="margin-top:12px">
          <button class="primary" id="btnAddMenu" type="button">æ–°å¢é¤é»</button>
          <span class="muted">æ–°å¢å¾Œæœƒå‡ºç¾åœ¨ä¸‹æ–¹æ¸…å–®</span>
        </div>
      `;

      // init addons rows
      const addonRows = document.getElementById("addonRows");
      addonRows.innerHTML = `<div class="muted">ï¼ˆå°šç„¡åŠ è³¼ï¼ŒæŒ‰ã€Œæ–°å¢ä¸€åˆ—ã€åŠ å…¥ï¼‰</div>`;

      let addonRowCount = 0;
      document.getElementById("btnAddAddonRow").onclick = ()=>{
        addonRowCount++;
        if(addonRowCount === 1) addonRows.innerHTML = "";
        const rid = `addon_${Date.now()}_${Math.random().toString(16).slice(2)}`;
        const el = document.createElement("div");
        el.className = "box";
        el.style.marginTop = "10px";
        el.innerHTML = `
          <div class="miniRow">
            <div>
              <label>åç¨±</label>
              <input data-addon-name placeholder="ä¾‹ï¼šåŠ è›‹"/>
            </div>
            <div>
              <label>åƒ¹æ ¼</label>
              <input data-addon-price type="number" min="0" value="0"/>
            </div>
            <div>
              <label>å…è²»</label>
              <select data-addon-free>
                <option value="false">å¦</option>
                <option value="true">æ˜¯</option>
              </select>
            </div>
          </div>
          <div class="inline" style="justify-content:flex-end; margin-top:10px">
            <button class="btn danger" data-del-addon="${rid}" type="button">åˆªé™¤æ­¤åˆ—</button>
          </div>
        `;
        el.dataset.rowId = rid;
        addonRows.appendChild(el);

        el.querySelector(`button[data-del-addon="${rid}"]`).onclick = ()=>{
          el.remove();
          if(addonRows.querySelectorAll(".box").length === 0){
            addonRowCount = 0;
            addonRows.innerHTML = `<div class="muted">ï¼ˆå°šç„¡åŠ è³¼ï¼ŒæŒ‰ã€Œæ–°å¢ä¸€åˆ—ã€åŠ å…¥ï¼‰</div>`;
          }
        };
      };

      // option groups builder
      const optWrap = document.getElementById("optGroupsWrap");
      optWrap.innerHTML = `<div class="muted">ï¼ˆå°šç„¡é¸é …ï¼ŒæŒ‰ã€Œæ–°å¢ä¸€çµ„ã€åŠ å…¥ï¼‰</div>`;
      let groupCount = 0;

      document.getElementById("btnAddOptionGroup").onclick = ()=>{
        groupCount++;
        if(groupCount === 1) optWrap.innerHTML = "";
        const gid = `g_${Date.now()}_${Math.random().toString(16).slice(2)}`;
        const groupEl = document.createElement("div");
        groupEl.className = "box";
        groupEl.dataset.gid = gid;
        groupEl.innerHTML = `
          <div class="row">
            <div>
              <label>ç¾¤çµ„åç¨±</label>
              <input data-g-name placeholder="ä¾‹ï¼šè‚‰é¡é¸æ“‡"/>
            </div>
            <div>
              <label>å¿…é¸</label>
              <select data-g-required>
                <option value="true">å¿…é¸</option>
                <option value="false">å¯ä¸é¸</option>
              </select>
            </div>
          </div>

          <div class="inline" style="justify-content:space-between; margin-top:8px">
            <b>é¸é …ï¼ˆoptionsï¼‰</b>
            <button class="btn" data-add-opt type="button">ï¼‹æ–°å¢é¸é …</button>
          </div>
          <div class="muted" style="margin-top:6px">ï¼ˆæ¯å€‹é¸é …å¯åŠ åƒ¹ priceï¼‰</div>
          <div data-opt-list style="margin-top:8px"></div>

          <div class="inline" style="justify-content:flex-end; margin-top:10px">
            <button class="btn danger" data-del-group type="button">åˆªé™¤æ­¤ç¾¤çµ„</button>
          </div>
        `;

        optWrap.appendChild(groupEl);

        const optList = groupEl.querySelector("[data-opt-list]");
        optList.innerHTML = `<div class="muted">ï¼ˆå°šç„¡é¸é …ï¼Œè«‹æ–°å¢ï¼‰</div>`;
        let optCount = 0;

        groupEl.querySelector("[data-add-opt]").onclick = ()=>{
          optCount++;
          if(optCount === 1) optList.innerHTML = "";
          const optEl = document.createElement("div");
          optEl.className = "box";
          optEl.style.marginTop = "10px";
          optEl.innerHTML = `
            <div class="miniRow">
              <div>
                <label>é¸é …åç¨±</label>
                <input data-opt-name placeholder="ä¾‹ï¼šè±¬è‚‰"/>
              </div>
              <div>
                <label>åŠ åƒ¹</label>
                <input data-opt-price type="number" min="0" value="0"/>
              </div>
              <div class="inline" style="align-self:end; justify-content:flex-end">
                <button class="btn danger" data-del-opt type="button">åˆªé™¤</button>
              </div>
            </div>
          `;
          optList.appendChild(optEl);
          optEl.querySelector("[data-del-opt]").onclick = ()=>{
            optEl.remove();
            if(optList.querySelectorAll(".box").length === 0){
              optCount = 0;
              optList.innerHTML = `<div class="muted">ï¼ˆå°šç„¡é¸é …ï¼Œè«‹æ–°å¢ï¼‰</div>`;
            }
          };
        };

        groupEl.querySelector("[data-del-group]").onclick = ()=>{
          groupEl.remove();
          if(optWrap.querySelectorAll(".box[data-gid]").length === 0){
            groupCount = 0;
            optWrap.innerHTML = `<div class="muted">ï¼ˆå°šç„¡é¸é …ï¼ŒæŒ‰ã€Œæ–°å¢ä¸€çµ„ã€åŠ å…¥ï¼‰</div>`;
          }
        };
      };

      document.getElementById("btnAddMenu").onclick = addMenuItem;
    }

    function collectAddons(){
      const rows = document.querySelectorAll("#addonRows .box");
      const out = [];
      rows.forEach(r=>{
        const name = (r.querySelector("[data-addon-name]")?.value || "").trim();
        if(!name) return;
        const price = Number(r.querySelector("[data-addon-price]")?.value || 0);
        const free = (r.querySelector("[data-addon-free]")?.value || "false") === "true";
        out.push({ name, price: Number.isFinite(price)?price:0, free });
      });
      return out;
    }

    function collectOptionGroups(){
      const groups = [];
      const groupEls = document.querySelectorAll("#optGroupsWrap .box[data-gid]");
      groupEls.forEach(gel=>{
        const name = (gel.querySelector("[data-g-name]")?.value || "").trim();
        const required = (gel.querySelector("[data-g-required]")?.value || "true") === "true";

        const optList = gel.querySelectorAll("[data-opt-list] .box");
        const options = [];
        optList.forEach(oel=>{
          const oname = (oel.querySelector("[data-opt-name]")?.value || "").trim();
          if(!oname) return;
          const price = Number(oel.querySelector("[data-opt-price]")?.value || 0);
          options.push({ name: oname, price: Number.isFinite(price)?price:0 });
        });

        if(!name && options.length===0) return;

        groups.push({
          name: name || "é¸é …",
          type: "single",
          required,
          options
        });
      });
      return groups;
    }

    async function addMenuItem(){
      if(!selectedRestaurantId) return alert("è«‹å…ˆé¸æ“‡é¤å»³");

      const category = getPickedCategoryValue();
      if(!category) return alert("è«‹å…ˆåœ¨ã€Œé¡åˆ¥ç®¡ç†ã€æ–°å¢é¡åˆ¥ï¼Œä¸¦é¸æ“‡é¤é»é¡åˆ¥");

      const name = ($("mName")?.value || "").trim();
      const price = Number($("mPrice")?.value || 0);
      const defaultQty = Math.max(1, Number($("mDefaultQty")?.value || 1));
      const note = ($("mNote")?.value || "").trim();

      if(!name) return alert("è«‹è¼¸å…¥é¤é»åç¨±");
      if(!Number.isFinite(price) || price < 0) return alert("åƒ¹æ ¼ä¸æ­£ç¢º");

      const addons = collectAddons();
      const optionGroups = collectOptionGroups();

      for(const g of optionGroups){
        if((g.required !== false) && (!Array.isArray(g.options) || g.options.length===0)){
          return alert(`é¸é …ç¾¤çµ„ã€Œ${g.name}ã€æ˜¯å¿…é¸ï¼Œä½†æ²’æœ‰ä»»ä½•é¸é …`);
        }
      }

      try{
        statusPill.textContent = "æ–°å¢é¤é»ä¸­â€¦";
        const menuCol = collection(db, "restaurants", selectedRestaurantId, "menu");
        await addDoc(menuCol, {
          category,
          name,
          price,
          defaultQty,
          note,
          addons,
          optionGroups,
          createdAt: Date.now()
        });

        $("mName").value = "";
        $("mPrice").value = "0";
        $("mDefaultQty").value = "1";
        $("mNote").value = "";

        await loadMenu(selectedRestaurantId);
        renderMenuAdd();
        renderMenuList();
        statusPill.textContent = "æ–°å¢é¤é»å®Œæˆ âœ…";
      }catch(err){
        console.error("addMenuItem failed:", err);
        statusPill.textContent = "æ–°å¢é¤é»å¤±æ•—ï¼ˆçœ‹ consoleï¼‰";
        alert("æ–°å¢é¤é»å¤±æ•—ï¼ˆRules/ç¶²è·¯ï¼‰\n\n" + (err?.message || err));
      }
    }

    function renderMenuList(){
      const wrap = $("menuList");
      if(!selectedRestaurantId){
        wrap.innerHTML = `<div class="muted">å°šæœªé¸æ“‡é¤å»³ã€‚</div>`;
        return;
      }
      if(menuCache.length === 0){
        wrap.innerHTML = `<div class="muted">æ­¤é¤å»³å°šç„¡é¤é»ã€‚</div>`;
        return;
      }

      const map = new Map();
      for(const m of menuCache){
        const cat = (m.category || "æœªåˆ†é¡").trim();
        if(!map.has(cat)) map.set(cat, []);
        map.get(cat).push(m);
      }

      wrap.innerHTML = Array.from(map.entries()).map(([cat, items])=>`
        <details open class="box" style="padding:10px 12px">
          <summary><b>${esc(cat)}</b> <span class="tag" style="margin-left:8px">${items.length} é …</span></summary>
          <div style="margin-top:10px">
            ${items.map(m=>{
              const addons = Array.isArray(m.addons) ? m.addons : [];
              const og = Array.isArray(m.optionGroups) ? m.optionGroups : [];
              return `
                <div class="listLine">
                  <div class="inline" style="justify-content:space-between">
                    <div>
                      <b>${esc(m.name||"")}</b>
                      <span class="tag" style="margin-left:8px">åƒ¹æ ¼ï¼š${Number(m.price||0)}</span>
                      <span class="tag" style="margin-left:6px">é è¨­ï¼š${Number(m.defaultQty||1)}</span>
                    </div>
                    <div class="inline">
                      <button class="btn danger" data-del-menu="${esc(m.id)}" type="button">åˆªé™¤</button>
                    </div>
                  </div>

                  ${m.note ? `<div class="muted" style="margin-top:6px">å‚™è¨»ï¼š${esc(m.note)}</div>` : ``}

                  ${og.length ? `
                    <div class="muted" style="margin-top:8px">
                      é¸é …ç¾¤çµ„ï¼š${esc(og.map(g=> `${g.name}ï¼ˆ${(g.required!==false)?"å¿…é¸":"å¯ä¸é¸"} / ${Array.isArray(g.options)?g.options.length:0}é …ï¼‰`).join("ï¼›"))}
                    </div>
                  ` : ``}

                  ${addons.length ? `
                    <div class="muted" style="margin-top:8px">
                      åŠ è³¼ï¼š${esc(addons.map(a=> `${a.name}${a.free?"(å…è²»)":(" +"+Number(a.price||0))}`).join("ï¼›"))}
                    </div>
                  ` : ``}
                </div>
              `;
            }).join("")}
          </div>
        </details>
      `).join("");

      wrap.querySelectorAll("button[data-del-menu]").forEach(btn=>{
        btn.onclick = async ()=>{
          const mid = btn.dataset.delMenu;
          if(!confirm("ç¢ºå®šåˆªé™¤æ­¤é¤é»ï¼Ÿ")) return;
          try{
            await deleteDoc(doc(db, "restaurants", selectedRestaurantId, "menu", mid));
            await loadMenu(selectedRestaurantId);
            renderMenuList();
          }catch(err){
            console.error("delete menu failed:", err);
            alert("åˆªé™¤é¤é»å¤±æ•—ï¼ˆRules/ç¶²è·¯ï¼‰\n\n" + (err?.message || err));
          }
        };
      });
    }

    // ===== Staff =====
    async function loadStaff(){
      try{
        statusPill.textContent = "è¼‰å…¥äººå“¡ä¸­â€¦";
        const snap = await getDocs(colStaff);
        const map = {};
        snap.forEach(d=>{
          const v = d.data() || {};
          const dept = (v.dept || "æœªåˆ†éƒ¨é–€").trim();
          const name = (v.name || "").trim();
          if(!name) return;
          if(!map[dept]) map[dept] = [];
          map[dept].push({ id:d.id, name });
        });

        Object.keys(map).forEach(k=> map[k].sort((a,b)=> a.name.localeCompare(b.name,"zh-Hant")));
        const depts = Object.keys(map).sort((a,b)=> a.localeCompare(b,"zh-Hant"));

        const wrap = $("staffWrap");
        if(depts.length===0){
          wrap.innerHTML = `<div class="muted">å°šç„¡äººå“¡ã€‚</div>`;
        }else{
          wrap.innerHTML = depts.map(dept=>`
            <details open class="box">
              <summary><b>${esc(dept)}</b> <span class="tag" style="margin-left:8px">${map[dept].length} äºº</span></summary>
              <div style="margin-top:10px">
                ${map[dept].map(p=>`
                  <div class="listLine">
                    <div class="inline" style="justify-content:space-between">
                      <div><b>${esc(p.name)}</b></div>
                      <button class="btn danger" data-del-staff="${esc(p.id)}" type="button">åˆªé™¤</button>
                    </div>
                  </div>
                `).join("")}
              </div>
            </details>
          `).join("");

          wrap.querySelectorAll("button[data-del-staff]").forEach(btn=>{
            btn.onclick = async ()=>{
              const id = btn.dataset.delStaff;
              if(!confirm("ç¢ºå®šåˆªé™¤æ­¤äººå“¡ï¼Ÿ")) return;
              try{
                await deleteDoc(doc(db, "staff", id));
                await loadStaff();
              }catch(err){
                console.error(err);
                alert("åˆªé™¤äººå“¡å¤±æ•—ï¼ˆRules/ç¶²è·¯ï¼‰\n\n" + (err?.message || err));
              }
            };
          });
        }

        statusPill.textContent = "äººå“¡è¼‰å…¥å®Œæˆ âœ…";
      }catch(err){
        console.error("loadStaff failed:", err);
        statusPill.textContent = "äººå“¡è®€å–å¤±æ•—ï¼ˆçœ‹ consoleï¼‰";
        alert("äººå“¡è®€å–å¤±æ•—ï¼ˆRules/ç¶²è·¯ï¼‰\n\n" + (err?.message || err));
      }
    }

    async function addStaff(){
      const dept = ($("staffDept").value || "").trim();
      const name = ($("staffName").value || "").trim();
      if(!dept) return alert("è«‹è¼¸å…¥éƒ¨é–€");
      if(!name) return alert("è«‹è¼¸å…¥äººå“¡å§“å");

      try{
        statusPill.textContent = "æ–°å¢äººå“¡ä¸­â€¦";
        await addDoc(colStaff, { dept, name, createdAt: Date.now() });
        $("staffName").value = "";
        await loadStaff();
        statusPill.textContent = "æ–°å¢äººå“¡å®Œæˆ âœ…";
      }catch(err){
        console.error("addStaff failed:", err);
        statusPill.textContent = "æ–°å¢äººå“¡å¤±æ•—ï¼ˆçœ‹ consoleï¼‰";
        alert("æ–°å¢äººå“¡å¤±æ•—ï¼ˆRules/ç¶²è·¯ï¼‰\n\n" + (err?.message || err));
      }
    }

    // ===== Orders (Query + Excel) =====
    function fmtTime(ms){
      if(!ms) return "";
      const d = new Date(ms);
      const pad = (n)=> String(n).padStart(2,"0");
      return `${d.getFullYear()}-${pad(d.getMonth()+1)}-${pad(d.getDate())} ${pad(d.getHours())}:${pad(d.getMinutes())}`;
    }
    function periodOf(ms){
      const d = new Date(ms||0);
      return d.getHours() < 12 ? "noon" : "night"; // 12:00(å«) å¾Œç®—æ™šä¸Š
    }

    function optionText(optionGroups, chosen){
      const groups = Array.isArray(optionGroups) ? optionGroups : [];
      const pick = chosen || {};
      const out = [];
      for (let gi=0; gi<groups.length; gi++){
        const g = groups[gi] || {};
        if ((g.type || "single") !== "single") continue;
        const idx = Number(pick[gi]);
        const name = (g.name || "").trim();
        if (!Number.isFinite(idx) || idx < 0) continue;
        const opt = (Array.isArray(g.options) ? g.options : [])[idx];
        if (!opt) continue;
        const p = Number(opt.price || 0);
        out.push(`${name ? (name+"ï¼š") : ""}${opt.name || ""}${p ? (" +"+p) : ""}`);
      }
      return out.join("ï¼›");
    }
    function addonText(addons){
      const list = Array.isArray(addons) ? addons : [];
      return list.map(a=>{
        const p = (a && a.free) ? 0 : Number(a.price||0);
        return `+${a.name||""}${(a && a.free) ? "(å…è²»)" : (p?(" "+p):"")}`;
      }).join("ï¼›");
    }
    function calcItemLine(it){
      const base = Number(it.price||0);
      const addonSum = (it.addons||[]).reduce((s,a)=> s + ((a && a.free) ? 0 : Number(a.price||0)), 0);
      const og = Array.isArray(it.optionGroups) ? it.optionGroups : [];
      const chosen = it.chosenOptions || {};
      let optSum = 0;
      for(let gi=0; gi<og.length; gi++){
        const g = og[gi] || {};
        if((g.type||"single") !== "single") continue;
        const idx = Number(chosen[gi]);
        if(!Number.isFinite(idx) || idx < 0) continue;
        const opt = (Array.isArray(g.options)?g.options:[])[idx];
        if(!opt) continue;
        optSum += Number(opt.price||0);
      }
      const qty = Number(it.qty||0);
      const unit = base + addonSum + optSum;
      const lineTotal = unit * qty;
      return { unit, lineTotal, addonSum, optSum };
    }

    async function queryOrders(){
      const qDate = ($("qDate").value || "").trim();
      const qRid = ($("qRestaurant").value || "").trim();
      const qName = ($("qName").value || "").trim();
      const qPeriod = ($("qPeriod").value || "").trim();

      try{
        statusPill.textContent = "æŸ¥è©¢ä¸­â€¦";
        let snap;
        if(qDate){
          snap = await getDocs(query(colOrders, where("orderDate","==", qDate), limit(3000)));
        }else{
          snap = await getDocs(query(colOrders, limit(3000)));
        }

        const rows = [];
        snap.forEach(d=> rows.push({ id:d.id, ...d.data() }));

        const filtered = rows.filter(o=>{
          if(qRid && o.restaurantId !== qRid) return false;
          if(qName && !(String(o.userName||"").includes(qName))) return false;
          if(qPeriod){
            if(periodOf(Number(o.createdAt||0)) !== qPeriod) return false;
          }
          return true;
        }).sort((a,b)=> Number(b.createdAt||0) - Number(a.createdAt||0));

        renderOrders(filtered);
        statusPill.textContent = "å·²æŸ¥è©¢ âœ…";
      }catch(err){
        console.error("queryOrders failed:", err);
        statusPill.textContent = "æŸ¥è©¢å¤±æ•—ï¼ˆçœ‹ consoleï¼‰";
        alert("æŸ¥è©¢å¤±æ•—ï¼ˆRules/ç¶²è·¯ï¼‰\n\n" + (err?.message || err));
      }
    }

    function renderOrders(list){
      const wrap = $("ordersWrap");
      if(list.length===0){
        wrap.innerHTML = `<div class="muted">å°šç„¡è³‡æ–™ã€‚</div>`;
        return;
      }
      wrap.innerHTML = list.map(o=>{
        const items = Array.isArray(o.items) ? o.items : [];
        const lines = items.map(it=>{
          const optTxt = optionText(it.optionGroups, it.chosenOptions);
          const addTxt = addonText(it.addons);
          const calc = calcItemLine(it);
          return `
            â€¢ <b>${esc(it.name||"")}</b>ã€€
            å–®åƒ¹ï¼š${Number(it.price||0)}
            ${optTxt?`ï¼ˆé¸é … +${calc.optSum}ï¼‰`:``}
            ${addTxt?`ï¼ˆåŠ è³¼ +${calc.addonSum}ï¼‰`:``}
            Ã— ${Number(it.qty||0)}
            â†’ å°è¨ˆï¼š${calc.lineTotal}
            ${it.note?`ï¼ˆå‚™è¨»ï¼š${esc(it.note)}ï¼‰`:``}
            ${optTxt?`<div class="muted" style="margin-top:4px">ã€€ã€€é¸é …ï¼š${esc(optTxt)}</div>`:``}
            ${addTxt?`<div class="muted" style="margin-top:4px">ã€€ã€€åŠ è³¼ï¼š${esc(addTxt)}</div>`:``}
          `;
        }).join("<br/>");

        return `
          <div class="listLine">
            <div class="inline" style="justify-content:space-between">
              <div>
                <b>${esc(o.userDept||"")}</b> / <b>${esc(o.userName||"")}</b>
                â€” <span class="tag">${esc(o.restaurantName||"")}</span>
                ${o.orderDate ? `<span class="tag" style="margin-left:6px">${esc(o.orderDate)}</span>` : ``}
                <span class="tag" style="margin-left:6px">${periodOf(Number(o.createdAt||0))==="noon"?"ä¸­åˆ":"æ™šä¸Š"}</span>
              </div>
              <span class="tag">ç¸½é¡ï¼š${Number(o.total||0)}</span>
            </div>
            <div class="muted" style="margin-top:8px">${lines}</div>
            ${(o.orderNote||o.remark) ? `<div class="muted" style="margin-top:8px">æ•´ç­†å‚™è¨»ï¼š${esc(o.orderNote||o.remark)}</div>` : ``}
            <div class="muted" style="margin-top:8px">å»ºç«‹æ™‚é–“ï¼š${esc(fmtTime(Number(o.createdAt||0)))}</div>
          </div>
        `;
      }).join("");
    }

    async function exportOrdersExcel(){
      if(!window.XLSX) return alert("Excel åŒ¯å‡ºå…ƒä»¶æœªè¼‰å…¥ï¼ˆXLSXï¼‰");

      const qDate = ($("qDate").value || "").trim();
      const qRid = ($("qRestaurant").value || "").trim();
      const qName = ($("qName").value || "").trim();
      const qPeriod = ($("qPeriod")?.value || "").trim();

      try{
        statusPill.textContent = "åŒ¯å‡ºä¸­â€¦";

        let snap;
        if(qDate){
          snap = await getDocs(query(colOrders, where("orderDate","==", qDate), limit(3000)));
        }else{
          snap = await getDocs(query(colOrders, limit(3000)));
        }

        const rows = [];
        snap.forEach(d=> rows.push({ id:d.id, ...d.data() }));

        const filtered = rows.filter(o=>{
          if(qRid && o.restaurantId !== qRid) return false;
          if(qName && !(String(o.userName||"").includes(qName))) return false;
          if(qPeriod){
            if(periodOf(Number(o.createdAt||0)) !== qPeriod) return false;
          }
          return true;
        }).sort((a,b)=> Number(a.createdAt||0) - Number(b.createdAt||0));

        if(filtered.length === 0){
          statusPill.textContent = "ç„¡è³‡æ–™å¯åŒ¯å‡º";
          return alert("ç›®å‰ç¯©é¸æ¢ä»¶ä¸‹æ²’æœ‰è³‡æ–™å¯åŒ¯å‡º");
        }

        const detail = [];
        for(const o of filtered){
          const items = Array.isArray(o.items) ? o.items : [];
          for(const it of items){
            const optTxt = optionText(it.optionGroups, it.chosenOptions);
            const addTxt = addonText(it.addons);
            const calc = calcItemLine(it);

            detail.push({
              "è¨‚å–®æ—¥æœŸ": o.orderDate || "",
              "å»ºç«‹æ™‚é–“": fmtTime(Number(o.createdAt||0)),
              "æ™‚æ®µ": periodOf(Number(o.createdAt||0)) === "noon" ? "ä¸­åˆ" : "æ™šä¸Š",
              "éƒ¨é–€": o.userDept || "",
              "å§“å": o.userName || "",
              "åº—å®¶": o.restaurantName || "",
              "å“é …": it.name || "",
              "é¸é …": optTxt || "",
              "åŠ è³¼": addTxt || "",
              "å–®å“å‚™è¨»": it.note || "",
              "æ•¸é‡": Number(it.qty||0),
              "åŸå–®åƒ¹": Number(it.price||0),
              "é¸é …åŠ åƒ¹": Number(calc.optSum||0),
              "åŠ è³¼åŠ åƒ¹": Number(calc.addonSum||0),
              "å°è¨ˆå–®åƒ¹": Number(calc.unit||0),
              "å“é …å°è¨ˆ": Number(calc.lineTotal||0),
              "æ•´ç­†å‚™è¨»": (o.orderNote || o.remark) ? (o.orderNote || o.remark) : "",
              "è¨‚å–®ç¸½é¡": Number(o.total||0),
            });
          }
        }

        const sumMap = new Map();
        for(const r of detail){
          const key = `${r["éƒ¨é–€"]}__${r["å§“å"]}`;
          if(!sumMap.has(key)) sumMap.set(key, { "éƒ¨é–€": r["éƒ¨é–€"], "å§“å": r["å§“å"], "é‡‘é¡å°è¨ˆ": 0 });
          sumMap.get(key)["é‡‘é¡å°è¨ˆ"] += Number(r["å“é …å°è¨ˆ"]||0);
        }
        const byPerson = Array.from(sumMap.values())
          .sort((a,b)=> (a["éƒ¨é–€"]+a["å§“å"]).localeCompare(b["éƒ¨é–€"]+b["å§“å"], "zh-Hant"));

        const deptMap = new Map();
        for(const p of byPerson){
          const d = p["éƒ¨é–€"] || "æœªåˆ†éƒ¨é–€";
          if(!deptMap.has(d)) deptMap.set(d, { "éƒ¨é–€": d, "é‡‘é¡å°è¨ˆ": 0 });
          deptMap.get(d)["é‡‘é¡å°è¨ˆ"] += Number(p["é‡‘é¡å°è¨ˆ"]||0);
        }
        const byDept = Array.from(deptMap.values())
          .sort((a,b)=> a["éƒ¨é–€"].localeCompare(b["éƒ¨é–€"], "zh-Hant"));

        const grandTotal = byPerson.reduce((s,x)=> s + Number(x["é‡‘é¡å°è¨ˆ"]||0), 0);
        byDept.push({ "éƒ¨é–€": "â€”", "é‡‘é¡å°è¨ˆ": "" });
        byDept.push({ "éƒ¨é–€": "ç¸½è¨ˆ", "é‡‘é¡å°è¨ˆ": grandTotal });

        const wb = XLSX.utils.book_new();
        XLSX.utils.book_append_sheet(wb, XLSX.utils.json_to_sheet(detail), "æ˜ç´°");
        XLSX.utils.book_append_sheet(wb, XLSX.utils.json_to_sheet(byPerson), "äººå“¡åŠ ç¸½");
        XLSX.utils.book_append_sheet(wb, XLSX.utils.json_to_sheet(byDept), "éƒ¨é–€åŠ ç¸½");

        const shopName = qRid ? ($("qRestaurant").selectedOptions?.[0]?.textContent || "Shop") : "AllShops";
        const filename = `Orders_${qDate||"AllDates"}_${shopName}_${qPeriod?(qPeriod==="noon"?"Noon":"Night"):"AllDay"}`.replace(/[\\/:*?"<>|]/g, "-") + ".xlsx";
        XLSX.writeFile(wb, filename);

        statusPill.textContent = "åŒ¯å‡ºå®Œæˆ âœ…";
      }catch(err){
        console.error("exportOrdersExcel failed:", err);
        statusPill.textContent = "åŒ¯å‡ºå¤±æ•—ï¼ˆçœ‹ consoleï¼‰";
        alert("åŒ¯å‡ºå¤±æ•—ï¼ˆRules/ç¶²è·¯ï¼‰\n\n" + (err?.message || err));
      }
    }

    // ===== Events / Buttons =====
    $("restaurantSelect").onchange = async ()=>{
      const rid = $("restaurantSelect").value;
      await loadRestaurantDoc(rid);
    };
    $("btnReloadRestaurants").onclick = loadRestaurants;
    $("btnSaveRestaurantFlags").onclick = saveRestaurantFlags;
    $("btnAddRestaurant").onclick = addRestaurant;
    $("btnDeleteRestaurant").onclick = deleteRestaurant;

    $("btnAddStaff").onclick = addStaff;
    $("btnReloadStaff").onclick = loadStaff;
    $("staffName").addEventListener("keydown", (e)=>{
      if(e.key === "Enter") addStaff();
    });

    $("btnQuery").onclick = queryOrders;
    $("btnToday").onclick = ()=>{
      $("qDate").value = todayISO();
      queryOrders();
    };
    $("btnExportExcel").onclick = exportOrdersExcel;

    $("btnGoUser").onclick = ()=>{
      localStorage.setItem(roleKey, "user");
      location.href = "./user.html";
    };
    $("btnLogout").onclick = ()=>{
      localStorage.removeItem(roleKey);
      location.href = "./index.html";
    };

    // ===== Init =====
    $("qDate").value = todayISO();
    await loadRestaurants();
    await loadStaff();
    await queryOrders();

    document.addEventListener("visibilitychange", async ()=>{
      if(document.visibilityState === "visible"){
        await loadRestaurants();
        if(selectedRestaurantId) await loadRestaurantDoc(selectedRestaurantId);
      }
    });
  </script>
</body>
</html>
