<!doctype html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>ç®¡ç†è€…å¾Œå°ï½œé¤å»³ç®¡ç†ï¼‹é¤é»ç®¡ç†ï¼‹äººå“¡</title>
  <style>
    :root{
      --bg:#f5f4fb;
      --card:#ffffff;
      --text:#0f172a;
      --muted:#64748b;
      --line:#e8eaf3;
      --primary:#fb7185;
      --danger:#ef4444;
      --ok:#22c55e;
      --shadow:0 10px 30px rgba(15,23,42,.08);
      --r:20px;
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      font-family: ui-sans-serif, system-ui, -apple-system, "Segoe UI", "Noto Sans TC", Arial;
      background:linear-gradient(135deg,#fff1f2 0%, #f5f4fb 40%, #eef2ff 100%);
      color:var(--text);
    }
    header{
      position:sticky; top:0; z-index:50;
      backdrop-filter: blur(10px);
      background:rgba(245,244,251,.7);
      border-bottom:1px solid rgba(232,234,243,.8);
    }
    .wrap{max-width:1150px;margin:0 auto;padding:16px}
    .topbar{display:flex; gap:12px; align-items:center; justify-content:space-between; flex-wrap:wrap;}
    .brand{display:flex; gap:10px; align-items:center;}
    .logo{
      width:42px;height:42px;border-radius:14px;
      background:linear-gradient(135deg,var(--primary),#ffd5c2);
      box-shadow: 0 10px 18px rgba(251,113,133,.25);
    }
    h1{margin:0;font-size:18px;letter-spacing:.5px}
    .sub{font-size:12px;color:var(--muted);margin-top:2px}
    .pill{
      font-size:12px;
      padding:8px 10px;
      border-radius:999px;
      border:1px solid rgba(232,234,243,.9);
      background:rgba(255,255,255,.6);
      display:flex; gap:8px; align-items:center;
      white-space:nowrap;
    }
    .pill b{color:var(--primary)}
    main{padding:16px 0 40px}
    .grid{
      display:grid;
      grid-template-columns: 420px 1fr;
      gap:16px;
      align-items:start;
    }
    @media (max-width: 980px){ .grid{grid-template-columns:1fr} }

    .card{
      background:rgba(255,255,255,.9);
      border:1px solid rgba(232,234,243,.9);
      box-shadow:var(--shadow);
      border-radius:var(--r);
      overflow:hidden;
    }
    .cardHead{
      padding:14px 16px;
      border-bottom:1px solid rgba(232,234,243,.9);
      display:flex; align-items:center; justify-content:space-between; gap:10px;
      background:linear-gradient(90deg, rgba(251,113,133,.09), rgba(99,102,241,.04));
      flex-wrap:wrap;
    }
    .cardHead h2{margin:0;font-size:14px}
    .cardBody{padding:14px 16px}
    label{display:block;font-size:12px;color:var(--muted);margin:10px 0 6px}
    input, textarea, select{
      width:100%;
      border:1px solid rgba(232,234,243,.95);
      background:#fff;
      border-radius:14px;
      padding:10px 12px;
      outline:none;
      font-size:14px;
    }
    textarea{min-height:80px;resize:vertical}
    input:focus, textarea:focus, select:focus{
      border-color: rgba(251,113,133,.55);
      box-shadow: 0 0 0 4px rgba(251,113,133,.12);
    }
    .row{display:flex; gap:10px}
    .row > *{flex:1}
    .btns{display:flex; gap:10px; flex-wrap:wrap; margin-top:12px}
    button{
      border:none;
      border-radius:14px;
      padding:10px 12px;
      cursor:pointer;
      font-weight:800;
      font-size:14px;
    }
    .btnPrimary{
      background:linear-gradient(135deg,var(--primary),#ff9aa6);
      color:#fff;
      box-shadow: 0 10px 18px rgba(251,113,133,.22);
    }
    .btnGhost{
      background:rgba(255,255,255,.8);
      border:1px solid rgba(232,234,243,.95);
      color:var(--text);
    }
    .btnDanger{
      background:rgba(239,68,68,.1);
      color:var(--danger);
      border:1px solid rgba(239,68,68,.25);
    }
    .btnOk{
      background:rgba(34,197,94,.12);
      color:#15803d;
      border:1px solid rgba(34,197,94,.25);
    }
    .hint{font-size:12px;color:var(--muted);line-height:1.5}
    .badge{
      display:inline-flex; align-items:center; gap:6px;
      padding:6px 10px;
      font-size:12px;
      border-radius:999px;
      border:1px solid rgba(232,234,243,.95);
      background:rgba(255,255,255,.75);
    }

    /* restaurant list */
    .list{
      display:grid;
      grid-template-columns: repeat(2, minmax(0,1fr));
      gap:12px;
    }
    @media (max-width: 520px){ .list{grid-template-columns:1fr} }
    .rCard{
      border:1px solid rgba(232,234,243,.95);
      background:rgba(255,255,255,.85);
      border-radius:18px;
      overflow:hidden;
      cursor:pointer;
      transition:transform .12s ease, box-shadow .12s ease;
    }
    .rCard:hover{ transform: translateY(-1px); box-shadow: 0 16px 30px rgba(15,23,42,.10); }
    .thumb{
      height:120px; background:#f8fafc;
      border-bottom:1px solid rgba(232,234,243,.95);
      display:flex; align-items:center; justify-content:center;
      color:var(--muted); font-size:12px;
    }
    .thumb img{width:100%;height:100%;object-fit:cover;display:block}
    .rInfo{padding:10px 12px}
    .rTitle{font-weight:900;font-size:14px;margin:0 0 4px}
    .rMeta{margin:0;color:var(--muted);font-size:12px;line-height:1.4}

    /* detail view */
    .detailTop{display:flex; align-items:center; justify-content:space-between; gap:10px; flex-wrap:wrap;}
    .detailTitle{display:flex; flex-direction:column; gap:2px;}
    .detailTitle b{font-size:16px}
    .split{display:grid; grid-template-columns:1fr 1fr; gap:12px;}
    @media (max-width: 980px){ .split{grid-template-columns:1fr} }

    .menuList{display:grid; grid-template-columns: repeat(2, minmax(0,1fr)); gap:12px;}
    @media (max-width: 560px){ .menuList{grid-template-columns:1fr} }

    .mCard{border:1px solid rgba(232,234,243,.95); background:rgba(255,255,255,.9); border-radius:18px; overflow:hidden;}
    .mHead{
      padding:10px 12px;
      border-bottom:1px solid rgba(232,234,243,.95);
      display:flex; align-items:center; justify-content:space-between; gap:10px;
      background:linear-gradient(90deg, rgba(99,102,241,.06), rgba(251,113,133,.06));
    }
    .mName{font-weight:900;font-size:14px}
    .mCat{font-size:12px;color:var(--muted)}
    .mBody{padding:10px 12px}
    .mLine{display:flex;justify-content:space-between;gap:10px;font-size:13px}
    .mDesc{margin:8px 0 0;color:var(--muted);font-size:12px;line-height:1.5}
    .empty{
      padding:14px 16px;
      border:1px dashed rgba(148,163,184,.6);
      border-radius:18px;
      color:var(--muted);
      background:rgba(255,255,255,.5);
      font-size:13px;
      line-height:1.6;
    }
    .toast{
      position:fixed; left:50%; bottom:18px; transform:translateX(-50%);
      background:rgba(15,23,42,.92);
      color:#fff;
      padding:10px 12px;
      border-radius:999px;
      font-size:13px;
      opacity:0; pointer-events:none;
      transition:opacity .18s ease, transform .18s ease;
    }
    .toast.show{ opacity:1; transform:translateX(-50%) translateY(-4px); }

    /* staff list */
    .staffList{display:grid; gap:10px; margin-top:10px;}
    .sItem{
      border:1px solid rgba(232,234,243,.95);
      border-radius:16px;
      background:rgba(255,255,255,.85);
      padding:10px 12px;
      display:flex;
      justify-content:space-between;
      gap:10px;
      align-items:flex-start;
    }
    .sLeft b{display:block;font-size:14px}
    .sLeft .meta{font-size:12px;color:var(--muted);margin-top:2px;line-height:1.5}
    .inline{display:flex; gap:10px; align-items:center; flex-wrap:wrap;}
    .mutedSmall{font-size:12px;color:var(--muted)}
  </style>
</head>

<body>
<header>
  <div class="wrap">
    <div class="topbar">
      <div class="brand">
        <div class="logo"></div>
        <div>
          <h1>ç®¡ç†è€…å¾Œå°</h1>
          <div class="sub">é¤å»³ç®¡ç†ï¼ˆé»é¤å»³é€²å…¥é¤é»ç®¡ç†ï¼‰ï½œäººå“¡ç®¡ç†</div>
        </div>
      </div>
      <div class="inline">
        <div class="pill">ç‹€æ…‹ï¼š<b id="saveState">å·²è¼‰å…¥</b> <span class="mutedSmall" id="counts">0 é¤å»³ / 0 é¤é» / 0 äººå“¡</span></div>
        <button class="btnGhost" id="btnGoUser">åˆ‡å›ä½¿ç”¨è€…</button>
      </div>
    </div>
  </div>
</header>

<main class="wrap">
  <div class="grid">
    <!-- å·¦ï¼šæ–°å¢é¤å»³ + äººå“¡ç®¡ç† -->
    <section class="card">
      <div class="cardHead">
        <h2>æ–°å¢é¤å»³ï¼ˆåº—å®¶åœ–ç‰‡æ”¹ã€Œä¸Šå‚³ã€ï¼‰</h2>
        <span class="badge">Admin</span>
      </div>
      <div class="cardBody">
        <div class="hint">æ–°å¢/ä¿®æ”¹éƒ½æœƒè¨˜éŒ„åœ¨ localStorageï¼Œé‡æ•´ä¸æœƒæ¶ˆå¤±ã€‚</div>

        <label>é¤å»³åç¨± *</label>
        <input id="rName" placeholder="ä¾‹ï¼šå‘·å¥”å˜ä¾¿ç•¶åº—" />

        <div class="row">
          <div>
            <label>é›»è©±</label>
            <input id="rPhone" placeholder="ä¾‹ï¼š04-1234-5678" />
          </div>
          <div>
            <label>åº—å®¶åœ–ç‰‡ï¼ˆä¸Šå‚³ï¼‰</label>
            <input id="rPhotoFile" type="file" accept="image/*" />
            <div class="mutedSmall" id="rPhotoHint" style="margin-top:6px;">å°šæœªé¸æ“‡åœ–ç‰‡</div>
          </div>
        </div>

        <label>åœ°å€</label>
        <input id="rAddress" placeholder="ä¾‹ï¼šå°ä¸­å¸‚..." />

        <label>Google map é€£çµ</label>
        <input id="rMap" placeholder="https://maps.google.com/..." />

        <label>å‚™è¨»</label>
        <textarea id="rNote" placeholder="ä¾‹ï¼šé€±æ—¥å…¬ä¼‘ / å¤–é€é–€æª»..."></textarea>

        <div class="btns">
          <button class="btnPrimary" id="btnAddRestaurant">æ–°å¢é¤å»³</button>
          <button class="btnDanger" id="btnResetAll">æ¸…ç©ºå…¨éƒ¨è³‡æ–™</button>
        </div>

        <hr style="border:none;border-top:1px solid rgba(232,234,243,.95);margin:16px 0;">

        <div class="card" style="box-shadow:none">
          <div class="cardHead">
            <h2>äººå“¡ç®¡ç†ï¼ˆå¯æ–°å¢ï¼‰</h2>
            <span class="badge" id="staffCountBadge">0 äººå“¡</span>
          </div>
          <div class="cardBody">
            <div class="row">
              <div>
                <label>äººå“¡å§“å *</label>
                <input id="staffName" placeholder="ä¾‹ï¼šå°ç¾" />
              </div>
              <div>
                <label>éƒ¨é–€</label>
                <select id="staffDept">
                  <option value="å…§å ´">å…§å ´</option>
                  <option value="å¤–å ´">å¤–å ´</option>
                  <option value="æ«ƒå°">æ«ƒå°</option>
                  <option value="å¤–é€">å¤–é€</option>
                  <option value="å…¶ä»–">å…¶ä»–</option>
                </select>
              </div>
            </div>

            <label>å‚™è¨»</label>
            <input id="staffNote" placeholder="ä¾‹ï¼šé€±ä¸€ï½äº”æ—©ç­" />

            <div class="btns">
              <button class="btnPrimary" id="btnAddStaff">æ–°å¢äººå“¡</button>
            </div>

            <div class="staffList" id="staffList"></div>
          </div>
        </div>
      </div>
    </section>

    <!-- å³ï¼šé¤å»³æ¸…å–® / é¤é»ç®¡ç† -->
    <section class="card">
      <div class="cardHead">
        <h2 id="rightTitle">é¤å»³ç®¡ç†ï¼ˆé»ä»»ä¸€é¤å»³é€²å…¥é¤é»ç®¡ç†ï¼‰</h2>
        <div class="inline">
          <button class="btnGhost" id="btnBack" style="display:none;">â† è¿”å›é¤å»³æ¸…å–®</button>
        </div>
      </div>

      <!-- åˆ—è¡¨è¦–åœ– -->
      <div class="cardBody" id="listView">
        <div class="hint" style="margin-bottom:10px;">é»é¤å»³å¡ç‰‡é€²å…¥å¾Œï¼Œå³å´æœƒå‡ºç¾é¤é»ç®¡ç†ï¼Œå¯æ–°å¢é¤é»ï¼ˆæœƒè¨˜éŒ„ï¼‰ã€‚</div>
        <div class="list" id="restaurantList"></div>
        <div id="emptyRestaurants" class="empty" style="display:none;margin-top:12px;">
          ç›®å‰æ²’æœ‰é¤å»³ã€‚è«‹å…ˆåœ¨å·¦å´æ–°å¢é¤å»³ï¼ˆé¤å»³åç¨±å¿…å¡«ï¼‰ã€‚
        </div>
      </div>

      <!-- è©³ç´°è¦–åœ–ï¼ˆé¤é»ç®¡ç†ï¼‰ -->
      <div class="cardBody" id="detailView" style="display:none;">
        <div class="detailTop">
          <div class="detailTitle">
            <b id="dName">â€”</b>
            <span class="mutedSmall" id="dMeta">â€”</span>
          </div>
          <div class="inline">
            <span class="badge" id="dMenuCount">0 é¤é»</span>
            <span class="badge" id="dCatCount">0 é¡åˆ¥</span>
            <button class="btnDanger" id="btnDeleteRestaurant">åˆªé™¤æ­¤é¤å»³</button>
          </div>
        </div>

        <div style="height:12px"></div>

        <div class="split">
          <!-- æ–°å¢é¡åˆ¥/é¤é» -->
          <div class="card" style="box-shadow:none">
            <div class="cardHead">
              <h2>é¤é»ç®¡ç†ï¼ˆåœ–ç‰‡ç§»é™¤â†’æ”¹é è¨­æ•¸é‡ï¼‰</h2>
              <span class="badge">æœƒè‡ªå‹•è¨˜éŒ„</span>
            </div>
            <div class="cardBody">
              <label>æ–°å¢é¤é»é¡åˆ¥ï¼ˆè¼¸å…¥ï¼‰</label>
              <div class="row">
                <input id="catInput" placeholder="ä¾‹ï¼šä¾¿ç•¶ / é£²æ–™ / å°èœ..." />
                <button class="btnPrimary" id="btnAddCat" style="flex:0 0 auto;min-width:110px;">æ–°å¢é¡åˆ¥</button>
              </div>

              <label style="margin-top:14px;">é¸æ“‡é¤é»é¡åˆ¥</label>
              <select id="dishCategory"></select>

              <label>é¤é»åç¨± *</label>
              <input id="dishName" placeholder="ä¾‹ï¼šæ‹›ç‰Œé›è…¿ä¾¿ç•¶" />

              <div class="row">
                <div>
                  <label>åƒ¹æ ¼</label>
                  <input id="dishPrice" type="number" min="0" step="1" placeholder="ä¾‹ï¼š100" />
                </div>
                <div>
                  <label>é è¨­æ•¸é‡ï¼ˆæ–°å¢åˆ°è¨‚å–®æ™‚çš„é è¨­ï¼‰</label>
                  <input id="dishDefaultQty" type="number" min="1" step="1" value="1" />
                </div>
              </div>

              <label>é¤é»æè¿° / å‚™è¨»</label>
              <textarea id="dishDesc" placeholder="ä¾‹ï¼šå¯åŠ è¾£ / ä¸è¦è”¥..."></textarea>

              <div class="inline" style="margin-top:10px;">
                <input type="checkbox" id="dishEnabled" checked style="width:auto" />
                <span style="font-size:13px;">æ­¤é¤é»å¯è²©å”®ï¼ˆé¡¯ç¤ºåœ¨ä½¿ç”¨è€…ç«¯ï¼‰</span>
              </div>

              <div class="btns">
                <button class="btnPrimary" id="btnAddDish">æ–°å¢é¤é»</button>
                <button class="btnGhost" id="btnClearDish">æ¸…ç©ºè¼¸å…¥</button>
              </div>

              <div class="hint" style="margin-top:10px;">
                ä½ ä¹‹å‰çš„å•é¡Œã€Œé»å·²æœ‰é¤å»³ç„¡æ³•å†æ–°å¢é¤é»ã€ï¼šé€™ç‰ˆé»å¡ç‰‡é€²ä¾†ä¸€å®šæœƒç¶å®š selectedRestaurantIdï¼Œæ–°å¢é¤é»æœƒç›´æ¥ save()ã€‚
              </div>
            </div>
          </div>

          <!-- é¤é»æ¸…å–® -->
          <div class="card" style="box-shadow:none">
            <div class="cardHead">
              <h2>æ­¤é¤å»³çš„é¤é»æ¸…å–®</h2>
              <span class="badge">å¯ä¸‹æ¶/åˆªé™¤</span>
            </div>
            <div class="cardBody">
              <div id="emptyMenu" class="empty" style="display:none;">
                é€™é–“é¤å»³ç›®å‰æ²’æœ‰é¤é»ã€‚è«‹åœ¨å·¦å´æ–°å¢é¤é»ã€‚
              </div>
              <div class="menuList" id="menuList"></div>
            </div>
          </div>
        </div>
      </div>
    </section>
  </div>
</main>

<div class="toast" id="toast">å·²å„²å­˜</div>

<script>
  /***********************
   * å…±ç”¨å„²å­˜ Keyï¼ˆuser/admin éƒ½ç”¨åŒä¸€ä»½ï¼‰
   ***********************/
  const STORE_KEY = "jabenlo_data_v2";
  const ADMIN_FLAG_KEY = "jabenlo_is_admin";

  const uid = () => Math.random().toString(36).slice(2, 10) + Date.now().toString(36);

  function defaultData(){
    return { restaurants: [], staff: [] };
  }

  function load(){
    try{
      const raw = localStorage.getItem(STORE_KEY);
      const data = raw ? JSON.parse(raw) : defaultData();

      data.restaurants = Array.isArray(data.restaurants) ? data.restaurants : [];
      data.staff = Array.isArray(data.staff) ? data.staff : [];

      data.restaurants.forEach(r=>{
        r.id = r.id || uid();
        r.name = r.name || "";
        r.phone = r.phone || "";
        r.address = r.address || "";
        r.map = r.map || "";
        r.photo = r.photo || "";   // base64 dataURL
        r.note = r.note || "";
        r.categories = Array.isArray(r.categories) ? r.categories : [];
        r.menu = Array.isArray(r.menu) ? r.menu : [];
        r.menu.forEach(d=>{
          d.id = d.id || uid();
          d.category = d.category || "æœªåˆ†é¡";
          d.name = d.name || "";
          d.price = Number(d.price || 0);
          d.defaultQty = Number(d.defaultQty || 1);
          d.desc = d.desc || "";
          d.enabled = (d.enabled === false) ? false : true;
        });
      });

      data.staff.forEach(s=>{
        s.id = s.id || uid();
        s.name = s.name || "";
        s.dept = s.dept || "å…¶ä»–";
        s.note = s.note || "";
      });

      return data;
    }catch(e){
      console.error(e);
      return defaultData();
    }
  }

  const state = {
    data: load(),
    selectedRestaurantId: null,
    toastTimer: null,
    newRestaurantPhotoDataUrl: ""
  };

  function save(){
    localStorage.setItem(STORE_KEY, JSON.stringify(state.data));
    setSaveState("å·²å„²å­˜");
    toast("å·²å„²å­˜");
    refreshCounts();
  }

  function setSaveState(txt){ document.getElementById("saveState").textContent = txt; }

  function toast(msg){
    const el = document.getElementById("toast");
    el.textContent = msg;
    el.classList.add("show");
    clearTimeout(state.toastTimer);
    state.toastTimer = setTimeout(()=> el.classList.remove("show"), 1200);
  }

  const $ = (id)=> document.getElementById(id);

  function refreshCounts(){
    const rCount = state.data.restaurants.length;
    const mCount = state.data.restaurants.reduce((acc,r)=> acc + (r.menu?.length || 0), 0);
    const sCount = state.data.staff.length;
    $("counts").textContent = `${rCount} é¤å»³ / ${mCount} é¤é» / ${sCount} äººå“¡`;
    $("staffCountBadge").textContent = `${sCount} äººå“¡`;
  }

  /***********************
   * åˆ‡å›ä½¿ç”¨è€…
   ***********************/
  $("btnGoUser").addEventListener("click", ()=>{
    localStorage.setItem(ADMIN_FLAG_KEY, "0");
    location.href = "user.html";
  });

  /***********************
   * æ–°å¢é¤å»³ï¼šåœ–ç‰‡ä¸Šå‚³â†’base64
   ***********************/
  $("rPhotoFile").addEventListener("change", (e)=>{
    const file = e.target.files && e.target.files[0];
    if(!file){
      state.newRestaurantPhotoDataUrl = "";
      $("rPhotoHint").textContent = "å°šæœªé¸æ“‡åœ–ç‰‡";
      return;
    }
    const reader = new FileReader();
    reader.onload = () => {
      state.newRestaurantPhotoDataUrl = String(reader.result || "");
      $("rPhotoHint").textContent = `å·²é¸æ“‡ï¼š${file.name}`;
    };
    reader.readAsDataURL(file);
  });

  $("btnAddRestaurant").addEventListener("click", ()=>{
    const name = $("rName").value.trim();
    if(!name){ toast("è«‹è¼¸å…¥é¤å»³åç¨±"); $("rName").focus(); return; }

    const r = {
      id: uid(),
      name,
      phone: $("rPhone").value.trim(),
      address: $("rAddress").value.trim(),
      map: $("rMap").value.trim(),
      photo: state.newRestaurantPhotoDataUrl || "",
      note: $("rNote").value.trim(),
      categories: [],
      menu: []
    };

    state.data.restaurants.unshift(r);
    save();
    clearRestaurantForm();
    renderRestaurants();
  });

  function clearRestaurantForm(){
    $("rName").value = "";
    $("rPhone").value = "";
    $("rAddress").value = "";
    $("rMap").value = "";
    $("rNote").value = "";
    $("rPhotoFile").value = "";
    state.newRestaurantPhotoDataUrl = "";
    $("rPhotoHint").textContent = "å°šæœªé¸æ“‡åœ–ç‰‡";
  }

  /***********************
   * äººå“¡ç®¡ç†ï¼šæ–°å¢/åˆªé™¤ï¼ˆæœƒè¨˜éŒ„ï¼‰
   ***********************/
  $("btnAddStaff").addEventListener("click", ()=>{
    const name = $("staffName").value.trim();
    if(!name){ toast("è«‹è¼¸å…¥äººå“¡å§“å"); $("staffName").focus(); return; }

    state.data.staff.unshift({
      id: uid(),
      name,
      dept: $("staffDept").value || "å…¶ä»–",
      note: $("staffNote").value.trim()
    });
    save();
    $("staffName").value = "";
    $("staffNote").value = "";
    renderStaff();
  });

  function renderStaff(){
    const box = $("staffList");
    box.innerHTML = "";
    state.data.staff.forEach(s=>{
      const item = document.createElement("div");
      item.className = "sItem";

      const left = document.createElement("div");
      left.className = "sLeft";
      const b = document.createElement("b");
      b.textContent = s.name;
      const meta = document.createElement("div");
      meta.className = "meta";
      meta.textContent = `éƒ¨é–€ï¼š${s.dept}${s.note ? " Â· " + s.note : ""}`;
      left.appendChild(b);
      left.appendChild(meta);

      const del = document.createElement("button");
      del.className = "btnDanger";
      del.style.padding = "8px 10px";
      del.textContent = "åˆªé™¤";
      del.onclick = ()=>{
        const ok = confirm(`ç¢ºå®šåˆªé™¤äººå“¡ã€Œ${s.name}ã€ï¼Ÿ`);
        if(!ok) return;
        state.data.staff = state.data.staff.filter(x=> x.id !== s.id);
        save();
        renderStaff();
      };

      item.appendChild(left);
      item.appendChild(del);
      box.appendChild(item);
    });
    refreshCounts();
  }

  /***********************
   * é¤å»³åˆ—è¡¨
   ***********************/
  function renderRestaurants(){
    const list = $("restaurantList");
    list.innerHTML = "";

    const restaurants = state.data.restaurants;
    $("emptyRestaurants").style.display = restaurants.length ? "none" : "block";

    restaurants.forEach(r=>{
      const card = document.createElement("div");
      card.className = "rCard";
      card.onclick = () => openRestaurant(r.id);

      const thumb = document.createElement("div");
      thumb.className = "thumb";
      if(r.photo){
        const img = document.createElement("img");
        img.src = r.photo;
        img.alt = r.name;
        img.onerror = () => { thumb.textContent = "åœ–ç‰‡è¼‰å…¥å¤±æ•—"; };
        thumb.appendChild(img);
      }else{
        thumb.textContent = "å°šæœªè¨­å®šåº—å®¶åœ–ç‰‡";
      }

      const info = document.createElement("div");
      info.className = "rInfo";

      const title = document.createElement("p");
      title.className = "rTitle";
      title.textContent = r.name || "(æœªå‘½å)";

      const meta = document.createElement("p");
      meta.className = "rMeta";
      const phone = r.phone ? `â˜ ${r.phone}` : "";
      const addr = r.address ? `ğŸ“ ${r.address}` : "";
      const menuN = `ğŸ± ${r.menu?.length || 0} é¤é»`;
      meta.textContent = [phone, addr, menuN].filter(Boolean).join("  Â·  ");

      info.appendChild(title);
      info.appendChild(meta);

      card.appendChild(thumb);
      card.appendChild(info);

      list.appendChild(card);
    });

    refreshCounts();
  }

  /***********************
   * é€²å…¥é¤é»ç®¡ç†ï¼ˆé»å·²æœ‰é¤å»³ä¸€å®šèƒ½æ–°å¢é¤é»ï¼‰
   ***********************/
  const listView = $("listView");
  const detailView = $("detailView");
  const btnBack = $("btnBack");
  const rightTitle = $("rightTitle");

  function openRestaurant(id){
    state.selectedRestaurantId = id;
    const r = getSelectedRestaurant();
    if(!r) return;

    listView.style.display = "none";
    detailView.style.display = "block";
    btnBack.style.display = "inline-flex";
    rightTitle.textContent = "é¤é»ç®¡ç†ï¼ˆé»è¿”å›å›é¤å»³æ¸…å–®ï¼‰";

    $("dName").textContent = r.name;
    $("dMeta").textContent = [
      r.phone ? `â˜ ${r.phone}` : "",
      r.address ? `ğŸ“ ${r.address}` : "",
      r.map ? `ğŸ—º å·²æœ‰åœ°åœ–é€£çµ` : ""
    ].filter(Boolean).join("  Â·  ") || "â€”";

    ensureDefaultCategories(r);
    renderCategorySelect();
    renderMenuList();
    refreshBadges();
  }

  function closeRestaurant(){
    state.selectedRestaurantId = null;
    listView.style.display = "block";
    detailView.style.display = "none";
    btnBack.style.display = "none";
    rightTitle.textContent = "é¤å»³ç®¡ç†ï¼ˆé»ä»»ä¸€é¤å»³é€²å…¥é¤é»ç®¡ç†ï¼‰";
    renderRestaurants();
  }

  btnBack.addEventListener("click", closeRestaurant);

  function getSelectedRestaurant(){
    return state.data.restaurants.find(x=> x.id === state.selectedRestaurantId);
  }

  function ensureDefaultCategories(r){
    if(!Array.isArray(r.categories)) r.categories = [];
    if(r.categories.length === 0){
      r.categories.push("æœªåˆ†é¡");
      save();
    }
  }

  function refreshBadges(){
    const r = getSelectedRestaurant();
    if(!r) return;
    $("dMenuCount").textContent = `${r.menu.length} é¤é»`;
    $("dCatCount").textContent = `${r.categories.length} é¡åˆ¥`;
  }

  /***********************
   * é¡åˆ¥ï¼šæ–°å¢
   ***********************/
  $("btnAddCat").addEventListener("click", ()=>{
    const r = getSelectedRestaurant();
    if(!r) return;

    const cat = $("catInput").value.trim();
    if(!cat){ toast("è«‹è¼¸å…¥é¡åˆ¥åç¨±"); $("catInput").focus(); return; }
    if(r.categories.includes(cat)){ toast("æ­¤é¡åˆ¥å·²å­˜åœ¨"); return; }

    r.categories.push(cat);
    $("catInput").value = "";
    save();
    renderCategorySelect(cat);
    refreshBadges();
  });

  function renderCategorySelect(selectValue){
    const r = getSelectedRestaurant();
    if(!r) return;

    const sel = $("dishCategory");
    sel.innerHTML = "";

    r.categories.forEach(cat=>{
      const opt = document.createElement("option");
      opt.value = cat;
      opt.textContent = cat;
      sel.appendChild(opt);
    });

    if(selectValue && r.categories.includes(selectValue)) sel.value = selectValue;
  }

  /***********************
   * é¤é»ï¼šæ–°å¢ï¼ˆåœ–ç‰‡ç§»é™¤â†’defaultQtyï¼‰
   ***********************/
  $("btnAddDish").addEventListener("click", ()=>{
    const r = getSelectedRestaurant();
    if(!r) return;

    const name = $("dishName").value.trim();
    if(!name){ toast("è«‹è¼¸å…¥é¤é»åç¨±"); $("dishName").focus(); return; }

    const dish = {
      id: uid(),
      category: $("dishCategory").value || "æœªåˆ†é¡",
      name,
      price: Number($("dishPrice").value || 0),
      defaultQty: Math.max(1, Number($("dishDefaultQty").value || 1)),
      desc: $("dishDesc").value.trim(),
      enabled: $("dishEnabled").checked
    };

    r.menu.unshift(dish);
    save();

    clearDishForm(false);
    renderMenuList();
    refreshBadges();
  });

  $("btnClearDish").addEventListener("click", ()=> clearDishForm(true));

  function clearDishForm(clearCategory){
    $("dishName").value = "";
    $("dishPrice").value = "";
    $("dishDefaultQty").value = "1";
    $("dishDesc").value = "";
    $("dishEnabled").checked = true;
    if(clearCategory) $("dishCategory").selectedIndex = 0;
  }

  function renderMenuList(){
    const r = getSelectedRestaurant();
    if(!r) return;

    const box = $("menuList");
    box.innerHTML = "";

    $("emptyMenu").style.display = r.menu.length ? "none" : "block";

    r.menu.forEach(d=>{
      const card = document.createElement("div");
      card.className = "mCard";

      const head = document.createElement("div");
      head.className = "mHead";

      const left = document.createElement("div");
      left.style.display = "flex";
      left.style.flexDirection = "column";

      const name = document.createElement("div");
      name.className = "mName";
      name.textContent = d.name;

      const cat = document.createElement("div");
      cat.className = "mCat";
      cat.textContent = `${d.category || "æœªåˆ†é¡"} Â· ${d.enabled ? "ä¸Šæ¶ä¸­" : "å·²ä¸‹æ¶"}`;

      left.appendChild(name);
      left.appendChild(cat);

      const actions = document.createElement("div");
      actions.className = "inline";

      const toggleBtn = document.createElement("button");
      toggleBtn.className = d.enabled ? "btnGhost" : "btnOk";
      toggleBtn.style.padding = "8px 10px";
      toggleBtn.textContent = d.enabled ? "ä¸‹æ¶" : "ä¸Šæ¶";
      toggleBtn.onclick = (ev)=>{
        ev.stopPropagation();
        d.enabled = !d.enabled;
        save();
        renderMenuList();
        refreshBadges();
      };

      const delBtn = document.createElement("button");
      delBtn.className = "btnDanger";
      delBtn.style.padding = "8px 10px";
      delBtn.textContent = "åˆªé™¤";
      delBtn.onclick = (ev)=>{
        ev.stopPropagation();
        const ok = confirm(`ç¢ºå®šåˆªé™¤é¤é»ã€Œ${d.name}ã€ï¼Ÿ`);
        if(!ok) return;
        r.menu = r.menu.filter(x=> x.id !== d.id);
        save();
        renderMenuList();
        refreshBadges();
      };

      actions.appendChild(toggleBtn);
      actions.appendChild(delBtn);

      head.appendChild(left);
      head.appendChild(actions);

      const body = document.createElement("div");
      body.className = "mBody";

      const line1 = document.createElement("div");
      line1.className = "mLine";
      const p1 = document.createElement("div");
      p1.textContent = `åƒ¹æ ¼ï¼š$${Number(d.price||0)}`;
      const p2 = document.createElement("div");
      p2.style.color = "var(--muted)";
      p2.textContent = `é è¨­æ•¸é‡ï¼š${Number(d.defaultQty||1)}`;
      line1.appendChild(p1);
      line1.appendChild(p2);

      const desc = document.createElement("div");
      desc.className = "mDesc";
      desc.textContent = d.desc || "ï¼ˆç„¡æè¿°ï¼‰";

      body.appendChild(line1);
      body.appendChild(desc);

      card.appendChild(head);
      card.appendChild(body);

      box.appendChild(card);
    });
  }

  /***********************
   * åˆªé™¤é¤å»³
   ***********************/
  $("btnDeleteRestaurant").addEventListener("click", ()=>{
    const r = getSelectedRestaurant();
    if(!r) return;
    const ok = confirm(`ç¢ºå®šåˆªé™¤é¤å»³ã€Œ${r.name}ã€ï¼Ÿï¼ˆé¤é»ä¹Ÿæœƒä¸€èµ·åˆªé™¤ï¼‰`);
    if(!ok) return;

    state.data.restaurants = state.data.restaurants.filter(x=> x.id !== r.id);
    save();
    closeRestaurant();
  });

  /***********************
   * æ¸…ç©ºå…¨éƒ¨
   ***********************/
  $("btnResetAll").addEventListener("click", ()=>{
    const ok = confirm("ç¢ºå®šæ¸…ç©ºå…¨éƒ¨è³‡æ–™ï¼Ÿï¼ˆä¸å¯å¾©åŸï¼‰");
    if(!ok) return;
    state.data = defaultData();
    localStorage.removeItem(STORE_KEY);
    toast("å·²æ¸…ç©º");
    closeRestaurant();
    renderStaff();
    renderRestaurants();
    refreshCounts();
  });

  /***********************
   * åˆå§‹åŒ–
   ***********************/
  // è‹¥ä¸æ˜¯ admin é€²ä¾†ï¼Œç›´æ¥å°å› user
  if(localStorage.getItem(ADMIN_FLAG_KEY) !== "1"){
    location.href = "user.html";
  }

  setSaveState("å·²è¼‰å…¥");
  renderStaff();
  renderRestaurants();
  refreshCounts();
</script>
</body>
</html>

    }
  ]
}
