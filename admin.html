<!doctype html>
<html lang="zh-Hant">

<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>GoldBricks å‘·å¥”ğŸ‘½ï½œç®¡ç†è€…</title>

  <!-- SortableJSï¼ˆæ‹–æ›³ï¼‰ -->
  <script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.2/Sortable.min.js"></script>

  <!-- Excelï¼ˆSheetJSï¼‰ -->
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.19.3/dist/xlsx.full.min.js"></script>

  <!-- Firebase -->
  <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>

  <!--ï¼ˆCSS æœƒåœ¨ B/5 æä¾›ï¼‰-->
  <style>
    /* B/5 æä¾›å®Œæ•´æ·±ç° C3 + æŸ”ç²‰ A ä¸»é¡Œ */
  </style>
</head>

<body>

  <!-- ====================================================== -->
  <!-- ğŸŸ¦ Sidebar å´æ¬„ -->
  <!-- ====================================================== -->
  <aside id="sidebar">
    <div class="logo">GoldBricks å‘·å¥”ğŸ‘½ï½œç®¡ç†è€…</div>

    <nav>
      <button data-target="view_restaurants">é¤å»³ç®¡ç†</button>
      <button data-target="view_menu">é¤é»ç®¡ç†</button>
      <button data-target="view_staff">äººå“¡æ¸…å–®</button>
      <button data-target="view_orders">è¨‚å–®ç´€éŒ„</button>
      <button data-target="view_stats">è¨‚å–®çµ±è¨ˆ</button>
    </nav>
  </aside>

  <!-- ====================================================== -->
  <!-- ğŸŸ© Main ä¸»å…§å®¹ -->
  <!-- ====================================================== -->
  <main id="main">

    <!-- ============================== -->
    <!-- ğŸ“Œ 1. é¤å»³ç®¡ç† -->
    <!-- ============================== -->
    <section id="view_restaurants" class="page">
      <h2>é¤å»³ç®¡ç†</h2>

      <!-- ğŸ” æœå°‹ -->
      <input id="search_restaurant" placeholder="æœå°‹é¤å»³â€¦">

      <!-- â• æ–°å¢é¤å»³ -->
      <button id="btnAddRestaurant" class="primary">æ–°å¢é¤å»³</button>

      <!-- é¤å»³åˆ—è¡¨ -->
      <div id="restaurantList"></div>
    </section>

    <!-- ============================== -->
    <!-- ğŸ“Œ 2. é¤é»ç®¡ç† -->
    <!-- ============================== -->
    <section id="view_menu" class="page">
      <h2>é¤é»ç®¡ç†</h2>

      <!-- ğŸ” æœå°‹ -->
      <input id="search_menu" placeholder="æœå°‹é¤é»â€¦">

      <!-- â• æ–°å¢é¤é» -->
      <button id="btnAddDish" class="primary">æ–°å¢é¤é»</button>

      <!-- é¤é»åˆ—è¡¨ -->
      <div id="menuList"></div>
    </section>

    <!-- ============================== -->
    <!-- ğŸ“Œ 3. äººå“¡æ¸…å–® -->
    <!-- ============================== -->
    <section id="view_staff" class="page">
      <h2>äººå“¡æ¸…å–®</h2>

      <button id="btnAddStaff" class="primary">æ–°å¢äººå“¡</button>

      <div id="staffDeptList"></div>
    </section>

    <!-- ============================== -->
    <!-- ğŸ“Œ 4. è¨‚å–®ç´€éŒ„ -->
    <!-- ============================== -->
    <section id="view_orders" class="page">
      <h2>è¨‚å–®ç´€éŒ„ï¼ˆå½™æ•´è¼¸å‡ºï¼‰</h2>

      <input type="date" id="o_date">
      <button id="btnLoadOrders" class="primary">è¼‰å…¥è¨‚å–®</button>

      <div id="orderList"></div>
    </section>

    <!-- ============================== -->
    <!-- ğŸ“Œ 5. è¨‚å–®çµ±è¨ˆ -->
    <!-- ============================== -->
    <section id="view_stats" class="page">
      <h2>è¨‚å–®çµ±è¨ˆ</h2>

      <input type="date" id="s_date">
      <button id="btnLoadStats" class="primary">è¼‰å…¥çµ±è¨ˆ</button>

      <div id="statsTable"></div>
    </section>

  </main>

  <!-- ====================================================== -->
  <!-- ğŸŸ§ Drawerï¼ˆå³å´æ“ä½œé¢æ¿ï¼‰ -->
  <!-- ====================================================== -->
  <div id="drawer">
    <div id="drawerContent">
      <!-- å‹•æ…‹æ’å…¥ -->
    </div>
  </div>

  <!-- JSï¼ˆC/5ï½E/5 æœƒä¾åºè£œä¸Šï¼‰ -->
  <script>
    /* C/5 é–‹å§‹è£œ JS */
  </script>

</body>
</html>
<style>
/* =========================================================
   ğŸ¨ C3 æ·±ç°ä¸»é¡Œ + æŸ”ç²‰ A
   ========================================================= */
:root{
  --bg:#1e1e1e;
  --card:#2b2b2b;
  --text:#f3f4f6;
  --muted:#a1a1aa;

  --primary:#fb7185;
  --primary-light:#fda4af;

  --border:rgba(255,255,255,.08);
  --border2:rgba(255,255,255,.15);

  --shadow:0 10px 30px rgba(0,0,0,.55);
  --radius:18px;
}

*{
  box-sizing:border-box;
  font-family: ui-sans-serif, system-ui, -apple-system, "Segoe UI", Arial;
}

body{
  margin:0;
  background:var(--bg);
  color:var(--text);
  display:flex;
  height:100vh;
  overflow:hidden;
}

/* ======================
   ğŸŸ¦ Sidebar
   ====================== */
#sidebar{
  width:240px;
  background:#151515;
  color:var(--text);
  padding:24px 20px;
  border-right:1px solid var(--border);
  display:flex;
  flex-direction:column;
}

#sidebar .logo{
  font-size:18px;
  font-weight:700;
  margin-bottom:24px;
  color:var(--primary);
}

#sidebar nav button{
  width:100%;
  padding:12px 10px;
  margin-bottom:8px;
  border-radius:10px;
  border:1px solid transparent;
  background:#222;
  color:var(--text);
  text-align:left;
  cursor:pointer;
  transition:.2s;
}

#sidebar nav button:hover{
  background:#333;
  border-color:var(--border2);
}

#sidebar nav button.active{
  background:var(--primary);
  color:#1e1e1e;
  font-weight:700;
}

/* ======================
   ğŸŸ© Main
   ====================== */
#main{
  flex:1;
  overflow-y:auto;
  padding:30px;
}

h2{
  margin:0 0 20px;
  font-size:24px;
  font-weight:600;
  letter-spacing:.5px;
}

/* ======================
   Input / Select / Button
   ====================== */
input, select, textarea{
  width:100%;
  padding:12px 14px;
  border-radius:12px;
  border:1px solid var(--border2);
  background:#262626;
  color:var(--text);
  margin-bottom:12px;
  font-size:15px;
}

input::placeholder{
  color:#777;
}

button{
  padding:10px 20px;
  border-radius:12px;
  border:none;
  font-size:15px;
  cursor:pointer;
  transition:.2s;
}

button.primary{
  background:var(--primary);
  color:#1e1e1e;
  font-weight:700;
}

button.primary:hover{
  background:var(--primary-light);
}

button.secondary{
  background:#333;
  color:var(--text);
  border:1px solid var(--border2);
}

button.secondary:hover{
  background:#444;
}

/* ======================
   card
   ====================== */
.card{
  background:var(--card);
  padding:20px;
  border-radius:var(--radius);
  box-shadow:var(--shadow);
  border:1px solid var(--border);
  margin-bottom:18px;
}

/* ======================
   details
   ====================== */
details{
  background:var(--card);
  padding:16px;
  border-radius:var(--radius);
  border:1px solid var(--border);
  margin-bottom:14px;
}

details summary{
  cursor:pointer;
  font-size:16px;
  font-weight:600;
  color:var(--primary-light);
}

/* ======================
   table
   ====================== */
table{
  width:100%;
  border-collapse:collapse;
  background:var(--card);
  border-radius:var(--radius);
  overflow:hidden;
}

table th{
  background:#383838;
  color:var(--primary-light);
  padding:12px 10px;
  text-align:left;
  border-bottom:1px solid var(--border2);
}

table td{
  padding:12px 10px;
  border-bottom:1px solid var(--border);
  color:var(--text);
}

table tr:hover td{
  background:#333;
}

/* ======================
   Drawer
   ====================== */
#drawer{
  position:fixed;
  top:0;
  right:-420px;
  width:420px;
  height:100%;
  background:var(--card);
  box-shadow:var(--shadow);
  transition:.3s;
  z-index:50;
  padding:22px;
  border-left:1px solid var(--border2);
  overflow-y:auto;
}

#drawer.open{
  right:0;
}

#drawer h3{
  margin-top:0;
  margin-bottom:16px;
  color:var(--primary-light);
}

/* ======================
   é¸é …ç¾¤çµ„æ¨¡çµ„
   ====================== */
.option-group{
  background:#262626;
  padding:16px;
  border-radius:14px;
  border:1px solid var(--border2);
  margin-bottom:14px;
}

.option-group-title{
  color:var(--primary-light);
  font-weight:600;
  margin-bottom:10px;
}

.option-item{
  display:flex;
  gap:10px;
  margin-bottom:10px;
}

.option-item input{
  flex:1;
}

.delete-btn{
  background:#3b3b3b;
  color:#f87171;
  border:1px solid #f87171;
}

.delete-btn:hover{
  background:#4b4b4b;
}

/* ======================
   ã€ŒğŸ‘ï¸ ä½¿ç”¨è€…å¯è¦‹ã€å¼·èª¿å€å¡Š
   ====================== */
.user-visible-label{
  display:block;
  margin-top:8px;
  margin-bottom:3px;
  font-weight:600;
  color:var(--primary-light);
}

.user-visible-block{
  background:#2a2a2a;
  border-left:4px solid var(--primary);
  padding:10px 12px;
  border-radius:10px;
  margin-bottom:18px;
}

/* ======================
   scrollbar
   ====================== */
::-webkit-scrollbar{
  width:8px;
}
::-webkit-scrollbar-thumb{
  background:#555;
  border-radius:4px;
}
::-webkit-scrollbar-thumb:hover{
  background:#777;
}
</style>
<script>
// ======================================================
// Firebase åˆå§‹åŒ–ï¼ˆè«‹æ›¿æ›ä½ çš„è¨­å®šï¼‰
// ======================================================
const firebaseConfig = {
  apiKey: "YOUR-API-KEY",
  authDomain: "YOUR-DOMAIN",
  projectId: "YOUR-PROJECT",
};
firebase.initializeApp(firebaseConfig);
const db = firebase.firestore();

// ======================================================
// é é¢åˆ‡æ›ï¼ˆSidebarï¼‰
// ======================================================
const pages = document.querySelectorAll(".page");
const navBtns = document.querySelectorAll("#sidebar nav button");

navBtns.forEach(btn=>{
  btn.addEventListener("click",()=>{
    navBtns.forEach(b=>b.classList.remove("active"));
    btn.classList.add("active");

    const target = btn.dataset.target;
    pages.forEach(p=>p.style.display="none");
    document.getElementById(target).style.display="block";
  });
});

// é è¨­é¡¯ç¤ºé¤å»³ç®¡ç†
document.querySelector("#sidebar nav button").click();


// ======================================================
// Drawer æ§åˆ¶
// ======================================================
const drawer = document.getElementById("drawer");
const drawerContent = document.getElementById("drawerContent");

function openDrawer(html){
  drawerContent.innerHTML = html;
  drawer.classList.add("open");
}

function closeDrawer(){
  drawer.classList.remove("open");
}

// ESC key é—œé–‰ drawer
document.addEventListener("keydown", e=>{
  if(e.key==="Escape") closeDrawer();
});


// ======================================================
// å…¨åŸŸï¼šé¸é …ç¾¤çµ„æš«å­˜
// ======================================================
let currentGroups = [];

function createOptionGroup(){
  return {
    id: "grp_"+Date.now(),
    name: "",
    type: "single",   // single æ“‡ä¸€ / multi åŠ è³¼
    required: false,
    options: []
  };
}


// ======================================================
// æ¸²æŸ“é¸é …ç¾¤çµ„
// ======================================================
function renderGroups(){
  const box = document.getElementById("dishGroupsBox");
  if(!box) return;
  box.innerHTML = "";

  currentGroups.forEach(group=>{
    const div = document.createElement("div");
    div.className = "option-group";

    div.innerHTML = `
      <div class="option-group-title">é¸é …ç¾¤çµ„</div>

      <label class="user-visible-label">ğŸ‘ï¸ ç¾¤çµ„åç¨±ï¼ˆä½¿ç”¨è€…å¯è¦‹ï¼‰</label>
      <input data-id="${group.id}" data-field="name" value="${group.name}" placeholder="ä¾‹å¦‚ï¼šè¾£åº¦ / åŠ è³¼é£²æ–™">

      <label>ç¾¤çµ„é¡å‹</label>
      <select data-id="${group.id}" data-field="type">
        <option value="single" ${group.type==="single"?"selected":""}>æ“‡ä¸€ï¼ˆsingleï¼‰</option>
        <option value="multi"  ${group.type==="multi"?"selected":""}>åŠ è³¼ï¼ˆmultiï¼‰</option>
      </select>

      <label>
        <input type="checkbox" data-id="${group.id}" data-field="required" ${group.required?"checked":""}>
        å¿…é¸ï¼ˆåƒ…æ“‡ä¸€æœ‰æ•ˆï¼‰
      </label>

      <div class="option-group-title" style="margin-top:12px;">é¸é …å…§å®¹</div>

      <div id="opt_${group.id}">
        ${group.options.map((opt,i)=>`
          <div class="option-item">
            <input data-id="${group.id}" data-opt-index="${i}" data-opt-field="name" value="${opt.name}" placeholder="é¸é …åç¨±ï¼ˆä½¿ç”¨è€…å¯è¦‹ï¼‰">
            <input data-id="${group.id}" data-opt-index="${i}" data-opt-field="price" value="${opt.price}" type="number" placeholder="+å¤šå°‘å…ƒ">
            <button class="delete-btn" data-id="${group.id}" data-opt-index="${i}">åˆª</button>
          </div>
        `).join("")}
      </div>

      <button class="secondary" data-add-option="${group.id}">æ–°å¢é¸é …</button>

      <button class="delete-btn" data-del-group="${group.id}" style="margin-top:10px">åˆªé™¤æ­¤ç¾¤çµ„</button>
    `;

    box.appendChild(div);
  });

  attachGroupEvents();
}


// ======================================================
// ç¶å®šç¾¤çµ„å…§éƒ¨äº‹ä»¶
// ======================================================
function attachGroupEvents(){
  // ç¾¤çµ„æ¬„ä½è®Šæ›´
  document.querySelectorAll("[data-field]").forEach(input=>{
    input.oninput = ()=>{
      const id = input.dataset.id;
      const field = input.dataset.field;
      const grp = currentGroups.find(g=>g.id===id);

      if(input.type==="checkbox"){
        grp[field] = input.checked;
      } else {
        grp[field] = input.value;
      }
    };
  });

  // æ–°å¢é¸é …
  document.querySelectorAll("[data-add-option]").forEach(btn=>{
    btn.onclick = ()=>{
      const id = btn.dataset.addOption;
      const grp = currentGroups.find(g=>g.id===id);
      grp.options.push({name:"", price:0});
      renderGroups();
    };
  });

  // åˆªé™¤é¸é …
  document.querySelectorAll(".delete-btn[data-opt-index]").forEach(btn=>{
    btn.onclick = ()=>{
      const id = btn.dataset.id;
      const idx = btn.dataset.optIndex;
      const grp = currentGroups.find(g=>g.id===id);
      grp.options.splice(idx,1);
      renderGroups();
    };
  });

  // åˆªæ•´å€‹ç¾¤çµ„
  document.querySelectorAll("[data-del-group]").forEach(btn=>{
    btn.onclick = ()=>{
      const id = btn.dataset.delGroup;
      currentGroups = currentGroups.filter(g=>g.id!==id);
      renderGroups();
    };
  });
}


// ======================================================
// ã€Œæ–°å¢é¤é»ã€Drawerï¼ˆå«ï¼šä½¿ç”¨è€…å¯è¦‹æ¬„ä½æ¨™ç¤ºï¼‰
// ======================================================
function showAddDishForm(restId=null){
  currentGroups = [];
  
  openDrawer(`
    <h3>æ–°å¢é¤é»</h3>

    <div class="user-visible-block">
      <label class="user-visible-label">ğŸ‘ï¸ é¤é»åç¨±ï¼ˆä½¿ç”¨è€…å¯è¦‹ï¼‰</label>
      <input id="d_name" placeholder="ä¾‹å¦‚ï¼šé›è…¿é£¯">

      <label class="user-visible-label">ğŸ‘ï¸ é¤é»åˆ†é¡ï¼ˆä½¿ç”¨è€…å¯è¦‹ï¼‰</label>
      <input id="d_category" list="dishCategoryList">

      <label class="user-visible-label">ğŸ‘ï¸ åƒ¹æ ¼ï¼ˆä½¿ç”¨è€…å¯è¦‹ï¼‰</label>
      <input id="d_price" type="number" placeholder="åƒ¹æ ¼">

      <label class="user-visible-label">ğŸ‘ï¸ é è¨­æ•¸é‡ï¼ˆä½¿ç”¨è€…å¯è¦‹ï¼‰</label>
      <input id="d_qty" type="number" value="1">
    </div>

    <h3>é¸é …ç¾¤çµ„ï¼ˆä½¿ç”¨è€…å¯è¦‹ï¼‰</h3>
    <div id="dishGroupsBox"></div>

    <button class="secondary" onclick="addGroup()">æ–°å¢é¸é …ç¾¤çµ„</button>

    <hr style="margin:20px 0; border:1px solid var(--border2);">

    <button class="primary" id="btnSaveDish">æ–°å¢é¤é»</button>
    <button class="secondary" onclick="closeDrawer()">å–æ¶ˆ</button>
  `);

  renderGroups();

  document.getElementById("btnSaveDish").onclick = ()=>saveDish(restId);
}


// ======================================================
// å„²å­˜å‰è­¦å‘Šï¼ˆä½ é¸ Bï¼‰
// ======================================================
function confirmSave(){
  return confirm("âš ï¸ çœŸçš„è¦å„²å­˜å—ï¼Ÿä½¿ç”¨è€…é é¢æœƒé¦¬ä¸Šçœ‹åˆ°é€™äº›è®Šæ›´ã€‚");
}
</script>
<script>
/* ======================================================
   ğŸª é¤å»³ç®¡ç†ï¼ˆè¼‰å…¥åˆ—è¡¨ï¼‰
   ====================================================== */
async function loadRestaurants(){
  const list = document.getElementById("restaurantList");
  list.innerHTML = `<div class="card">è¼‰å…¥ä¸­â€¦</div>`;

  const snap = await db.collection("restaurants").orderBy("name").get();

  let html = "";
  snap.forEach(doc=>{
    const d = doc.data();

    html += `
      <details>
        <summary>${d.name}</summary>

        <div class="card" style="margin-top:10px;">
          
          <div class="user-visible-block">
            <label class="user-visible-label">ğŸ‘ï¸ åº—åï¼ˆä½¿ç”¨è€…å¯è¦‹ï¼‰</label>
            <input value="${d.name}" data-rest-id="${doc.id}" data-rest-field="name">

            <label class="user-visible-label">ğŸ‘ï¸ åˆ†é¡ï¼ˆä½¿ç”¨è€…å¯è¦‹ï¼‰</label>
            <input value="${d.category||""}" list="restCategoryList" data-rest-id="${doc.id}" data-rest-field="category">

            <label class="user-visible-label">ğŸ‘ï¸ é»é¤é€£çµ orderLinkï¼ˆä½¿ç”¨è€…å¯è¦‹ï¼‰</label>
            <input value="${d.orderLink||""}" data-rest-id="${doc.id}" data-rest-field="orderLink" placeholder="https://...">
          </div>

          <button class="primary" onclick="saveRestaurant('${doc.id}')">å„²å­˜</button>
        </div>
      </details>
    `;
  });

  list.innerHTML = html;

  generateRestaurantCategoryList();
}


/* ======================================================
   ğŸª å„²å­˜é¤å»³
   ====================================================== */
async function saveRestaurant(id){
  if(!confirmSave()) return;  // ğŸ”¥ ä½ é¸ B çš„å¼·èª¿ç‰ˆè­¦å‘Š

  const inputs = document.querySelectorAll(`[data-rest-id="${id}"]`);

  let data = {};
  inputs.forEach(inp=>{
    const field = inp.dataset.restField;
    data[field] = inp.value;
  });

  await db.collection("restaurants").doc(id).update(data);

  alert("å·²å„²å­˜");
}


/* ======================================================
   â• æ–°å¢é¤å»³ Drawer
   ====================================================== */
document.getElementById("btnAddRestaurant").onclick = ()=>{
  openDrawer(`
    <h3>æ–°å¢é¤å»³</h3>

    <div class="user-visible-block">
      <label class="user-visible-label">ğŸ‘ï¸ åº—åï¼ˆä½¿ç”¨è€…å¯è¦‹ï¼‰</label>
      <input id="r_name">

      <label class="user-visible-label">ğŸ‘ï¸ åˆ†é¡ï¼ˆä½¿ç”¨è€…å¯è¦‹ï¼‰</label>
      <input id="r_category" list="restCategoryList">

      <label class="user-visible-label">ğŸ‘ï¸ é»é¤é€£çµ orderLinkï¼ˆä½¿ç”¨è€…å¯è¦‹ï¼‰</label>
      <input id="r_orderLink" placeholder="https://...">
    </div>

    <button class="primary" id="btnCreateRestaurant">æ–°å¢</button>
    <button class="secondary" onclick="closeDrawer()">å–æ¶ˆ</button>
  `);

  document.getElementById("btnCreateRestaurant").onclick = createRestaurant;
};

async function createRestaurant(){
  if(!confirmSave()) return;

  const data = {
    name: document.getElementById("r_name").value,
    category: document.getElementById("r_category").value,
    orderLink: document.getElementById("r_orderLink").value,
    createdAt: Date.now()
  };

  await db.collection("restaurants").add(data);
  closeDrawer();
  loadRestaurants();
}


/* ======================================================
   ğŸ± é¤é»ç®¡ç†ï¼ˆè¼‰å…¥ï¼‰
   ====================================================== */
async function loadMenu(){
  const list = document.getElementById("menuList");
  list.innerHTML = `<div class="card">è¼‰å…¥ä¸­â€¦</div>`;

  const snap = await db.collection("menu").orderBy("category").get();

  let html="";
  snap.forEach(doc=>{
    const d = doc.data();

    html += `
      <details>
        <summary>${d.name}ï¼ˆ${d.price} å…ƒï¼‰</summary>

        <div class="card" style="margin-top:10px;">

          <div class="user-visible-block">
            <label class="user-visible-label">ğŸ‘ï¸ é¤é»åç¨±ï¼ˆä½¿ç”¨è€…å¯è¦‹ï¼‰</label>
            <input value="${d.name}" data-dish-id="${doc.id}" data-dish-field="name">

            <label class="user-visible-label">ğŸ‘ï¸ åˆ†é¡ï¼ˆä½¿ç”¨è€…å¯è¦‹ï¼‰</label>
            <input value="${d.category}" list="dishCategoryList" data-dish-id="${doc.id}" data-dish-field="category">

            <label class="user-visible-label">ğŸ‘ï¸ åƒ¹æ ¼ï¼ˆä½¿ç”¨è€…å¯è¦‹ï¼‰</label>
            <input type="number" value="${d.price}" data-dish-id="${doc.id}" data-dish-field="price">

            <label class="user-visible-label">ğŸ‘ï¸ é è¨­æ•¸é‡ï¼ˆä½¿ç”¨è€…å¯è¦‹ï¼‰</label>
            <input type="number" value="${d.qty||1}" data-dish-id="${doc.id}" data-dish-field="qty">
          </div>

          <button class="primary" onclick="saveDishOnly('${doc.id}')">å„²å­˜</button>
        </div>
      </details>
    `;
  });

  list.innerHTML = html;

  generateDishCategoryList();
}


/* ======================================================
   ğŸ± å„²å­˜é¤é»ï¼ˆåŸºæœ¬æ¬„ä½ï¼‰
   ====================================================== */
async function saveDishOnly(id){
  if(!confirmSave()) return;

  const inputs = document.querySelectorAll(`[data-dish-id="${id}"]`);
  let data = {};

  inputs.forEach(inp=>{
    const f = inp.dataset.dishField;
    data[f] = (inp.type==="number") ? Number(inp.value) : inp.value;
  });

  await db.collection("menu").doc(id).update(data);
  alert("å·²å„²å­˜");
}


/* ======================================================
   â• æ–°å¢é¤é»ï¼ˆå«é¸é …ç¾¤çµ„ï¼‰
   ====================================================== */
document.getElementById("btnAddDish").onclick = ()=>showAddDishForm();

async function saveDish(){
  if(!confirmSave()) return;

  const name = document.getElementById("d_name").value;
  const cat = document.getElementById("d_category").value;
  const price = Number(document.getElementById("d_price").value);
  const qty = Number(document.getElementById("d_qty").value);

  const data = {
    name,
    category: cat,
    price,
    qty,
    groups: currentGroups,  // â­ ç¾¤çµ„
    createdAt: Date.now()
  };

  await db.collection("menu").add(data);
  closeDrawer();
  loadMenu();
}


/* ======================================================
   ğŸ“‹ é¤å»³åˆ†é¡ datalist
   ====================================================== */
async function generateRestaurantCategoryList(){
  const snap = await db.collection("restaurants").get();
  const set = new Set();

  snap.forEach(doc=>{
    const d = doc.data();
    if(d.category) set.add(d.category);
  });

  const dl = document.getElementById("restCategoryList");
  if(dl){
    dl.innerHTML = "";
    set.forEach(c=>{
      dl.innerHTML += `<option value="${c}">`;
    });
  }
}


/* ======================================================
   ğŸ“‹ é¤é»åˆ†é¡ datalist
   ====================================================== */
async function generateDishCategoryList(){
  const snap = await db.collection("menu").get();
  const set = new Set();

  snap.forEach(doc=>{
    const d = doc.data();
    if(d.category) set.add(d.category);
  });

  const dl = document.getElementById("dishCategoryList");
  if(dl){
    dl.innerHTML = "";
    set.forEach(c=>{
      dl.innerHTML += `<option value="${c}">`;
    });
  }
}


/* ======================================================
   åˆå§‹åŒ–
   ====================================================== */
loadRestaurants();
loadMenu();
</script>
<script>
/* ======================================================
   ğŸ‘¥ äººå“¡æ¸…å–®ï¼ˆéƒ¨é–€â†’æ”¶åˆï¼‰
   ====================================================== */
async function loadStaff(){
  const box = document.getElementById("staffDeptList");
  box.innerHTML = `<div class="card">è¼‰å…¥ä¸­â€¦</div>`;

  const snap = await db.collection("staff").orderBy("dept").get();

  // ä¾éƒ¨é–€åˆ†çµ„
  const deptMap = new Map();
  snap.forEach(doc=>{
    const d = doc.data();
    if(!deptMap.has(d.dept)) deptMap.set(d.dept, []);
    deptMap.get(d.dept).push({ id:doc.id, ...d });
  });

  let html = "";
  deptMap.forEach((arr, dept)=>{
    html += `
      <details>
        <summary>${dept}</summary>

        <div class="card" style="margin-top:10px;">
          ${arr.map(st=>`
            <div style="display:flex; gap:10px; margin-bottom:12px;">
              <input data-stf-id="${st.id}" data-stf-field="name" value="${st.name}">
              <input data-stf-id="${st.id}" data-stf-field="dept" value="${st.dept}">
              <button class="primary" onclick="saveStaff('${st.id}')">å„²å­˜</button>
            </div>
          `).join("")}
        </div>
      </details>
    `;
  });

  box.innerHTML = html;
}

async function saveStaff(id){
  if(!confirmSave()) return;

  const inputs = document.querySelectorAll(`[data-stf-id="${id}"]`);
  let data = {};

  inputs.forEach(inp=>{
    data[inp.dataset.stfField] = inp.value;
  });

  await db.collection("staff").doc(id).update(data);
  alert("å·²å„²å­˜");
}

document.getElementById("btnAddStaff").onclick = ()=>{
  openDrawer(`
    <h3>æ–°å¢äººå“¡</h3>

    <label>å§“å</label>
    <input id="s_name">

    <label>éƒ¨é–€</label>
    <input id="s_dept">

    <button class="primary" id="btnCreateStaff">æ–°å¢äººå“¡</button>
    <button class="secondary" onclick="closeDrawer()">å–æ¶ˆ</button>
  `);

  document.getElementById("btnCreateStaff").onclick = async ()=>{
    if(!confirmSave()) return;

    await db.collection("staff").add({
      name: document.getElementById("s_name").value,
      dept: document.getElementById("s_dept").value,
      createdAt: Date.now()
    });

    closeDrawer();
    loadStaff();
  };
};


/* ======================================================
   ğŸ§¾ è¨‚å–®ç´€éŒ„ï¼ˆå½™æ•´è¼¸å‡ºï¼‰
   ====================================================== */
document.getElementById("btnLoadOrders").onclick = loadOrdersByDate;

async function loadOrdersByDate(){
  const date = document.getElementById("o_date").value;
  if(!date) return alert("è«‹é¸æ—¥æœŸ");

  const snap = await db.collection("orders")
    .where("date","==",date)
    .orderBy("createdAt")
    .get();

  const box = document.getElementById("orderList");

  if(snap.empty){
    box.innerHTML = `<div class="card">æ­¤æ—¥æœŸæ²’æœ‰è¨‚å–®</div>`;
    return;
  }

  let html = `
    <div class="card">
      <table>
        <tr>
          <th>å§“å</th>
          <th>é¤é»</th>
          <th>é‡‘é¡</th>
          <th>æ™‚é–“</th>
        </tr>
  `;

  snap.forEach(doc=>{
    const o = doc.data();
    html += `
      <tr>
        <td>${o.userName}</td>
        <td>${o.itemName}</td>
        <td>${o.price}</td>
        <td>${new Date(o.createdAt).toLocaleTimeString()}</td>
      </tr>
    `;
  });

  html += `</table></div>`;
  box.innerHTML = html;
}


/* ======================================================
   ğŸ“Š è¨‚å–®çµ±è¨ˆï¼ˆä¾åº—å®¶å½™æ•´ï¼‰
   ====================================================== */
document.getElementById("btnLoadStats").onclick = loadStatsByDate;

async function loadStatsByDate(){
  const date = document.getElementById("s_date").value;
  if(!date) return alert("è«‹é¸æ—¥æœŸ");

  const snap = await db.collection("orders")
    .where("date","==",date)
    .get();

  const box = document.getElementById("statsTable");

  if(snap.empty){
    box.innerHTML = `<div class="card">æ­¤æ—¥æœŸæ²’æœ‰è¨‚å–®</div>`;
    return;
  }

  const map = new Map();

  snap.forEach(doc=>{
    const o = doc.data();
    if(!map.has(o.restaurant)) map.set(o.restaurant, 0);
    map.set(o.restaurant, map.get(o.restaurant) + o.price);
  });

  let html = `
    <div class="card">
      <table>
        <tr>
          <th>é¤å»³</th>
          <th>ç¸½é‡‘é¡</th>
        </tr>
  `;

  map.forEach((amt, name)=>{
    html += `<tr><td>${name}</td><td>${amt}</td></tr>`;
  });

  html += `</table></div>`;
  box.innerHTML = html;
}


/* ======================================================
   ğŸ” æœå°‹åŠŸèƒ½ï¼ˆé¤å»³ / é¤é»ï¼‰
   ====================================================== */
document.getElementById("search_restaurant").oninput = function(){
  const q = this.value.trim();
  const items = document.querySelectorAll("#restaurantList details");
  items.forEach(it=>{
    it.style.display = it.querySelector("summary").innerText.includes(q) ? "" : "none";
  });
};

document.getElementById("search_menu").oninput = function(){
  const q = this.value.trim();
  const items = document.querySelectorAll("#menuList details");
  items.forEach(it=>{
    it.style.display = it.querySelector("summary").innerText.includes(q) ? "" : "none";
  });
};


/* ======================================================
   ğŸš€ å…¨éƒ¨åˆå§‹åŒ–
   ====================================================== */
loadRestaurants();
loadMenu();
loadStaff();

</script>
