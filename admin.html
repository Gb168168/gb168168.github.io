<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>GoldBricks 呷奔👽｜管理777</title>

  <!-- ✅ 類別拖曳排序用 -->
  <script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.2/Sortable.min.js"></script>

  <style>
    :root{
      --bg:#f5f4fb; --card:#fff; --text:#0f172a; --muted:#64748b;
      --primary:#fb7185; --primary2:#ff9a9e; --border:rgba(15,23,42,.10);
      --shadow:0 10px 30px rgba(15,23,42,.10);
      --radius:18px;
    }
    *{box-sizing:border-box}
    body{
      margin:0; font-family: ui-sans-serif, system-ui, -apple-system, "Segoe UI", Arial;
      background: radial-gradient(1200px 500px at 20% -10%, rgba(251,113,133,.22), transparent 60%),
                  radial-gradient(900px 500px at 100% 0%, rgba(255,154,158,.14), transparent 55%),
                  var(--bg);
      color:var(--text);
      min-height:100vh;
    }
     body.is-locked{
      overflow:hidden;
    }
    body.is-locked .layout{
      display:none;
    }
    .adminGate{
      position:fixed;
      inset:0;
      display:flex;
      align-items:center;
      justify-content:center;
      background:
        linear-gradient(135deg, rgba(255,255,255,.85), rgba(255,255,255,.65)),
        url("./assets/admin-gate.svg");
      background-size:cover;
      background-position:center;
      padding:24px;
      z-index:9999;
    }
    .adminGate[hidden]{
      display:none;
    }
    .adminGate__card{
      width:min(420px, 92vw);
      background:rgba(255,255,255,.9);
      border-radius:24px;
      border:1px solid var(--border);
      box-shadow:0 24px 60px rgba(15,23,42,.2);
      padding:22px;
      text-align:center;
      backdrop-filter: blur(10px);
    }
    .adminGate__title{
      font-size:18px;
      margin:0 0 10px;
      font-weight:900;
    }
    .adminGate__hint{
      margin:6px 0 0;
      font-size:12.5px;
      color:var(--muted);
    }
    .adminGate__error{
      min-height:20px;
      margin:10px 0 0;
      color:#dc2626;
      font-size:12.5px;
      font-weight:700;
    }
    .adminGate__actions{
      display:flex;
      gap:10px;
      margin-top:14px;
      justify-content:center;
      flex-wrap:wrap;
    }
.layout{
  display:grid;
  grid-template-columns: 300px 1fr;
  gap:16px;
  padding:0 16px 16px;

   align-items: stretch;
}

    @media (max-width:980px){.layout{grid-template-columns:1fr}}
    .sidebar,.main{
      background: rgba(255,255,255,.78);
      border:1px solid var(--border);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      backdrop-filter: blur(10px);
    }
 .sidebar{
  padding:14px;
  position:sticky;
  top:0;

  align-self: start;   /* ⭐ 關鍵：不要撐高 grid row */
}

    .brand{display:flex; align-items:center; justify-content:space-between; gap:10px; padding:10px 10px 6px;}
    .brand h1{font-size:16px; margin:0}
    .brand small{color:var(--muted)}
    .nav{margin-top:10px; display:flex; flex-direction:column; gap:8px}
    .nav button{
      text-align:left; padding:11px 12px; border-radius:14px;
      border:1px solid var(--border); background:#fff; cursor:pointer;
      font-weight:800;
    }
    .nav button.active{
      border-color: rgba(251,113,133,.55);
      background: linear-gradient(90deg, rgba(251,113,133,.18), rgba(255,154,158,.10));
      box-shadow: 0 10px 22px rgba(251,113,133,.18);
    }

.main{
  width: 100%;
  max-width: none;   /* 🔥 解除任何上限（最重要） */
  margin: 0;         /* 🔥 不要 0 auto，避免被置中 */
  padding: 0 16px;

  display: flex;
  flex-direction: column;
  align-items: stretch;  /* 讓裡面的 view / card 全寬 */
}
    
 .topbar{
  display:flex;
  align-items:center;
  justify-content:space-between;
  gap:12px;
  padding:0 6px 6px;   /* ↓ 減少下面空白 */
}

    .topbar h2{margin:0; font-size:18px}
    .topbar .right{display:flex; gap:10px; align-items:center; flex-wrap:wrap}
    .pill{padding:8px 12px; border-radius:999px; border:1px solid var(--border); background:#fff; color:var(--muted); font-size:12.5px}
    .ghost{
      padding:9px 12px; border-radius:14px; border:1px solid var(--border);
      background:#fff; cursor:pointer; font-weight:800;
    }
    .primary{
      padding:9px 12px; border-radius:14px; border:none; cursor:pointer; font-weight:900;
      background: linear-gradient(90deg, var(--primary), var(--primary2));
      color:#fff; box-shadow: 0 14px 28px rgba(251,113,133,.22);
    }

    .grid{display:grid; grid-template-columns: 1fr 1fr; gap:14px}
    @media (max-width:980px){.grid{grid-template-columns:1fr}}

       .restaurant-status-grid{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap:12px;
      margin-top:10px;
    }
    @media (max-width:980px){
      .restaurant-status-grid{grid-template-columns:1fr}
    }

    /* ✅ 訂餐紀錄：左小右大（只影響 view_orders） */
    #view_orders .grid{ grid-template-columns: 360px 1fr; }
    @media (max-width:980px){ #view_orders .grid{ grid-template-columns: 1fr; } }

/* ✅ 只加寬 管理人員 */
#view_staff .grid{
  grid-template-columns: 640px minmax(360px, 1fr);
  gap: 18px;
}

/* ✅ 小螢幕單欄（也只影響管理人員） */
@media (max-width:980px){
  #view_staff .grid{ grid-template-columns: 1fr; }
}
}

    .card{
      background:#fff; border:1px solid var(--border); border-radius:var(--radius);
      box-shadow: 0 8px 25px rgba(15,23,42,.07);
      padding:14px;
    }
    .card h3{margin:0 0 10px; font-size:15px}
    label{display:block; font-size:13px; color:var(--muted); margin:10px 0 6px;}
    input,select,textarea{
      width:100%; padding:11px 12px; border-radius:14px;
      border:1px solid var(--border); outline:none; background:#fff;
      font-size:14px;
    }
    textarea{min-height:92px; resize:vertical}
    input:focus,select:focus,textarea:focus{border-color: rgba(251,113,133,.7)}
    .row{display:grid; grid-template-columns: 1fr 1fr; gap:10px}
    .row3{display:grid; grid-template-columns: 1fr 1fr 1fr; gap:10px}
    .actions{display:flex; gap:10px; margin-top:12px; flex-wrap:wrap}
    .muted{color:var(--muted); font-size:12.5px; line-height:1.6}
    .hr{height:1px; background: var(--border); margin:12px 0}
    table{width:100%; border-collapse:collapse; font-size:13.5px}
    th,td{border-bottom:1px solid rgba(15,23,42,.08); padding:10px 8px; text-align:left; vertical-align:top}
    th{color:var(--muted); font-weight:900}
    .tag{display:inline-flex; align-items:center; gap:8px; padding:5px 10px; border-radius:999px; border:1px solid var(--border); background:#fff; color:var(--muted); font-size:12px}
    .tag{display:inline-flex; align-items:center; gap:8px; padding:5px 10px; border-radius:999px; border:1px solid var(--border); background:#fff; color:var(--muted); font-size:12px }
    .tag.exceedTag{border-color: rgba(239,68,68,.45); color:#b91c1c; background: rgba(239,68,68,.08); font-weight:900}
/* === 未點餐：長條＋框框（像「開單中的餐廳」） === */
.missStrip{
  border:1px dashed rgba(15,23,42,.18);
  border-radius:18px;
  background:#fff;
  padding:12px 14px;
}

.missStripHead{
  display:flex;
  align-items:flex-start;
  justify-content:space-between;
  gap:12px;
}

.missTitle{
  font-weight:900;
  font-size:14px;
}

.missSub{
  margin-top:4px;
  color:var(--muted);
  font-size:12.5px;
}

.missPills{
  margin-top:10px;
  display:flex;
  flex-wrap:wrap;
  gap:10px;
}

.missPill{
  display:inline-flex;
  align-items:center;
  gap:8px;
  padding:7px 10px;
  border-radius:999px;
  border:1px solid rgba(15,23,42,.14);
  background:#fff;
  font-size:13px;
  white-space:nowrap;
}

.missDept{
  font-weight:900;
  color:#0f172a;
}

  .missCount{
  padding:4px 8px;
  border-radius:999px;
  border:1px solid rgba(15,23,42,.12);
  background:rgba(15,23,42,.03);
  color:var(--muted);
  font-size:12px;
  font-weight:900;
}

  .randomResult{
  border:1px dashed rgba(15,23,42,.18);
  border-radius:18px;
  background:#fff;
  padding:14px;
  margin-top:12px;
}
.randomResultTitle{
  font-size:15px;
  font-weight:900;
}
.randomResultMeta{
  margin-top:6px;
  color:var(--muted);
  font-size:12.5px;
}
    .randomResultActions{
  margin-top:10px;
  display:flex;
  flex-wrap:wrap;
  gap:8px;
}

    .missNames{
  color:#0f172a;
}

    /* === 隨機挑餐廳（放大 + 科技感 + 遊戲感） === */
#view_randomPick .card{
  padding:24px;
  border:1px solid rgba(99,102,241,.35);
  background:
    linear-gradient(135deg, rgba(15,23,42,.02), rgba(99,102,241,.06)),
    rgba(255,255,255,.92);
  box-shadow:
    0 12px 30px rgba(15,23,42,.12),
    0 0 0 1px rgba(99,102,241,.15),
    0 0 24px rgba(99,102,241,.12);
}
#view_randomPick h3{
  font-size:22px;
  letter-spacing:.8px;
}
#view_randomPick label{
  font-size:14px;
  letter-spacing:.4px;
}
#view_randomPick select{
  font-size:15px;
  padding:12px 14px;
  background: linear-gradient(180deg, #fff, rgba(99,102,241,.06));
  border-color: rgba(99,102,241,.3);
}
#view_randomPick .primary,
#view_randomPick .ghost{
  padding:12px 20px;
  font-size:15px;
  border-radius:18px;
}
#view_randomPick .primary{
  background: linear-gradient(90deg, #6366f1, #f472b6);
  box-shadow:
    0 0 0 1px rgba(99,102,241,.35),
    0 16px 30px rgba(99,102,241,.28),
    0 0 20px rgba(244,114,182,.25);
}
#view_randomPick .ghost{
  border-color: rgba(99,102,241,.3);
  }
#view_randomPick .randomResult{
  border-radius:22px;
  padding:18px;
  background:
  radial-gradient(600px 200px at 0% 0%, rgba(34,211,238,.18), transparent 60%),
    radial-gradient(500px 220px at 100% 0%, rgba(99,102,241,.22), transparent 60%),
    linear-gradient(180deg, rgba(255,255,255,.96), rgba(255,255,255,.9));
  box-shadow:
    0 14px 30px rgba(15,23,42,.14),
    inset 0 0 0 1px rgba(99,102,241,.15);
}
#view_randomPick .randomResultTitle{
  font-size:22px;
  letter-spacing:1px;
}
#view_randomPick .randomResultMeta{
   font-size:14px;
}
#view_randomPick .randomResultActions .tag{
  border-color: rgba(34,211,238,.4);
  color:#0f172a;
  font-weight:900;
}

    .btnSmall{
      padding:7px 10px; border-radius:12px; border:1px solid var(--border);
      background:#fff; cursor:pointer; font-weight:800; font-size:12.5px;
      white-space:nowrap;
    }
    .btnDanger{border-color: rgba(239,68,68,.35)}
    .btnDanger:hover{border-color: rgba(239,68,68,.60)}
    .btnOk:hover{border-color: rgba(16,185,129,.55)}
    details summary{cursor:pointer; font-weight:900}
    .inline{display:flex; gap:10px; align-items:center; flex-wrap:wrap}
    .saveFeedback{
      font-size:12.5px;
      color:var(--muted);
      font-weight:700;
    }
    .saveFeedback.success{color:#16a34a}
    .saveFeedback.error{color:#ef4444}
    button:disabled{opacity:.6; cursor:not-allowed}
    .shiftGroup{display:flex; align-items:center; gap:8px; flex-wrap:wrap}
    .shiftToggle{
      display:inline-flex;
      align-items:center;
      gap:6px;
      padding:4px 8px;
      border-radius:999px;
      border:1px solid rgba(15,23,42,.12);
      background:#fff;
      font-size:12px;
    }
    .shiftToggle input{width:auto}
    .imgPrev{width:100%; max-height:220px; object-fit:cover; border-radius:14px; border:1px solid var(--border)}
    .qrPrev{width:100%; max-height:220px; object-fit:contain; border-radius:14px; border:1px solid var(--border); background:rgba(15,23,42,.02)}
    .subcard{
      background: rgba(15,23,42,.02);
      border:1px dashed rgba(15,23,42,.18);
      border-radius:16px;
      padding:12px;
    }
    .kpi{display:flex; gap:10px; flex-wrap:wrap; margin-top:8px}
    .kpi .tag{font-weight:900}

    .stateGood{border-color: rgba(16,185,129,.35); color:#065f46; background:rgba(16,185,129,.08)}
    .stateBad{border-color: rgba(239,68,68,.35); color:#7f1d1d; background:rgba(239,68,68,.06)}

    .chkline{display:flex; align-items:center; gap:10px; flex-wrap:wrap}
    .chkline input[type="checkbox"]{width:18px; height:18px; margin:0}

    .mini{font-size:12px}
    .optBox{border:1px solid rgba(15,23,42,.10); border-radius:16px; padding:10px 12px; background:#fff}
    .optRow{display:grid; grid-template-columns: 1fr 140px 120px; gap:10px}
    @media (max-width:980px){.optRow{grid-template-columns:1fr}}

    /* STEP1：訂餐紀錄-上方橫條 */
    #view_orders .ordersTopBar{
      display:flex;
      align-items:flex-end;
      justify-content:space-between;
      gap:12px;
      flex-wrap:wrap;
    }
    #view_orders .ordersTopBar .leftCtl{
      display:flex;
      gap:12px;
      align-items:flex-end;
      flex-wrap:wrap;
    }
    #view_orders .ordersTopBar .dateBox{
      min-width:260px;
    }
    @media (max-width:980px){
      #view_orders .ordersTopBar .dateBox{ min-width:100%; }
    }
    #view_orders .ordersTopBar .rightCtl{
      display:flex;
      align-items:flex-end;
      gap:12px;
      flex-wrap:wrap;
      margin-left:auto;
    }
    #view_orders .ordersTopBar .notifyToggle{
      border:1px solid var(--border);
      border-radius:14px;
      padding:8px 10px;
      background:#fff;
      display:flex;
      align-items:center;
      gap:8px;
      font-size:13px;
    }
    #view_orders .ordersTopBar .notifyToggle input{
      width:18px;
      height:18px;
      margin:0;
      accent-color: var(--primary);
    }
    .orderNoticeWrap{
      position:fixed;
      top:16px;
      right:16px;
      z-index:9999;
      display:flex;
      flex-direction:column;
      gap:10px;
      pointer-events:none;
    }
    .orderNotice{
      background:#fff;
      border:1px solid rgba(251,113,133,.45);
      border-radius:16px;
      padding:10px 12px;
      box-shadow: 0 12px 24px rgba(15,23,42,.12);
      min-width:220px;
      max-width:320px;
      font-size:13px;
      animation: noticePop 0.25s ease-out;
    }
    .orderNotice strong{display:block; margin-bottom:2px}
    @keyframes noticePop{
      from{transform:translateY(-6px); opacity:0;}
      to{transform:translateY(0); opacity:1;}
    }

    /* 🔔 未點餐提醒條 */
    .alertBar{
      margin-top:8px;
      padding:8px 10px;
      border-radius:12px;
      font-size:13px;
      line-height:1.5;
    }
    .alertWarn{
      background:rgba(248,113,113,.06);
      border:1px solid rgba(248,113,113,.45);
      color:#7f1d1d;
    }
    .alertOk{
      background:rgba(16,185,129,.06);
      border:1px solid rgba(16,185,129,.45);
      color:#064e3b;
    }

     .alertTitle{
      font-weight:600;
      margin-bottom:4px;
    }
    .noOrderDeptList{
      list-style:none;
      margin:6px 0 0;
      padding:0;
      display:grid;
      gap:6px;
    }
    .noOrderDeptList li{
      display:flex;
      flex-wrap:wrap;
      align-items:center;
      gap:6px;
    }
    .deptTag{
      font-size:12px;
      font-weight:700;
      padding:2px 8px;
      border-radius:999px;
      background:rgba(248,113,113,.12);
      border:1px solid rgba(248,113,113,.4);
      color:#991b1b;
      white-space:nowrap;
    }
    .deptNames{
      font-weight:600;
      color:#7f1d1d;
    }
    
    /* 🔔 未點餐彈跳視窗 */
    .modalMask{
      position:fixed;
      inset:0;
      background:rgba(15,23,42,.35);
      display:flex;
      align-items:center;
      justify-content:center;
      z-index:50;
    }
    .modalBox{
      background:#fff;
      border-radius:18px;
      padding:18px 18px 14px;
      max-width:420px;
      width:90%;
      box-shadow:0 20px 40px rgba(15,23,42,.35);
    }

 /* =============== 結單 Modal 動畫 =============== */

/* 黑背景淡入 */
.modalMask.fadeIn {
  animation: fadeInBg 0.25s ease forwards;
}

@keyframes fadeInBg {
  from { background: rgba(0,0,0,0); }
  to   { background: rgba(0,0,0,0.35); }
}

/* 內容微縮放彈出 */
.modalBox.popIn {
  animation: popIn 0.28s cubic-bezier(0.15, 1.30, 0.40, 1) forwards;
}

@keyframes popIn {
  0%   { transform: scale(0.85); opacity: 0; }
  60%  { transform: scale(1.05); opacity: 1; }
  100% { transform: scale(1.00); opacity: 1; }
}

    /* 📅 班表樣式 */
    .schDayBlock{
      border:1px solid var(--border);
      border-radius:16px;
      background:#fff;
      margin-top:10px;
      padding:8px 10px 10px;
    }
    .schDaySummary{
      list-style:none;
      font-size:14px;
      font-weight:700;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:8px;
    }
    .schDayInner{
      margin-top:8px;
    }
    .schDeptBlock{
      padding:8px 4px;
      border-top:1px dashed rgba(15,23,42,.12);
    }
    .schDeptBlock:first-of-type{
      border-top:none;
    }
    .schDeptTitle{
      font-size:12.5px;
      font-weight:800;
      color:var(--muted);
      margin-bottom:4px;
    }
    .schStaffGrid{
      display:flex;
      flex-wrap:wrap;
      gap:6px 14px;
    }
    .schStaff{
      font-size:13px;
      display:flex;
      align-items:center;
      gap:4px;
    }
    .tag.miniTag{
      font-size:11px;
      padding:3px 7px;
    }
    .schMonthPanel{
      border:1px solid var(--border);
      border-radius:16px;
      background:#fff;
      padding:10px 12px 12px;
      margin-top:8px;
      --staff-bg: rgba(251,113,133,.18);
      --staff-border: rgba(251,113,133,.6);
      --staff-text: #be123c;
      --staff-shadow: rgba(251,113,133,.18);
    }
    .schMonthHeader{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      font-size:14px;
      font-weight:800;
      margin-bottom:8px;
    }
    .schMonthMeta{
      color:var(--muted);
      font-size:12px;
      font-weight:600;
    }
    .schCalendarGrid{
      display:grid;
      grid-template-columns: repeat(7, 1fr);
      gap:6px;
    }
    .schCalWeekday{
      text-align:center;
      font-size:12px;
      color:var(--muted);
      font-weight:700;
      padding:4px 0;
    }
     .schCalWeekday.is-weekend{
      color:#94a3b8;
    }
    .schCalCell{
      min-height:42px;
      border-radius:12px;
      border:1px solid rgba(15,23,42,.08);
      background:#fff;
      font-size:13px;
      font-weight:700;
      display:flex;
      align-items:center;
      justify-content:center;
      gap:4px;
      cursor:pointer;
      transition: all .15s ease;
    }
    .schCalCell.is-empty{
      border:1px dashed rgba(15,23,42,.08);
      background:rgba(15,23,42,.02);
      cursor:default;
    }
    .schCalCell.is-selected{
       border-color: var(--staff-border);
      background: var(--staff-bg);
      color:var(--staff-text);
      box-shadow: 0 8px 18px var(--staff-shadow);
    }
     .schCalCell.is-weekend:not(.is-selected):not(.is-holiday){
      background:#f1f5f9;
    }
    .schCalCell.is-holiday{
      border-color: rgba(245,158,11,.45);
      background: rgba(254,243,199,.65);
      color:#92400e;
    }
    .schCalCell.is-selected.is-holiday{
      box-shadow: 0 8px 18px var(--staff-shadow), inset 0 0 0 2px rgba(245,158,11,.35);
    }
    .schHolidayDot{
      width:6px;
      height:6px;
      border-radius:999px;
      background:#f59e0b;
      box-shadow: 0 0 0 2px rgba(245,158,11,.25);
    }
    .schLegend{
      display:flex;
      flex-wrap:wrap;
      gap:8px 12px;
      margin-top:6px;
      font-size:12px;
      color:var(--muted);
      align-items:center;
    }
    .schLegendItem{
      display:flex;
      align-items:center;
      gap:6px;
      padding:4px 8px;
      border-radius:999px;
      border:1px solid rgba(15,23,42,.08);
      background:#fff;
    }
    .schLegendColor{
      width:12px;
      height:12px;
      border-radius:4px;
      border:1px solid currentColor;
      background: var(--legend-bg, #fff);
    }
    .schCalCell span{
      pointer-events:none;
    }
    
.view{
  align-self: stretch;
  margin-top: 0;
  width: 100%;
}

.view > .card{
  width: 100%;
}

.view > .grid{
  width: 100%;
}

/* ✅ 這段你現在一定要有 */
.main{
  width: 100%;
  max-width: none;
  margin: 0;
}

  </style>
</head>
<body class="is-locked">
  <div id="adminGate" class="adminGate" hidden aria-hidden="true">
    <div class="adminGate__card" role="dialog" aria-labelledby="adminGateTitle" aria-describedby="adminGateHint">
      <p class="adminGate__title" id="adminGateTitle">請輸入管理密碼</p>
      <input id="adminGateInput" type="password" inputmode="numeric" autocomplete="one-time-code" placeholder="輸入密碼"/>
      <div class="adminGate__actions">
        <button class="primary" type="button" id="adminGateBtn">進入管理畫面</button>
        <button class="ghost" type="button" id="adminGateBack">返回首頁</button>
      </div>
      <p class="adminGate__hint" id="adminGateHint">輸入正確後才會進入管理者畫面</p>
      <p class="adminGate__error" id="adminGateError" role="alert"></p>
    </div>
  </div>

  <div class="layout">
    <aside class="sidebar">
      <div class="brand">
        <div>
          <h1>管理者後台</h1>
          <small>GoldBricks Order</small>
        </div>
        <span class="tag">admin</span>
      </div>

      <div class="nav">
        <button class="navBtn" data-view="staff">管理人員</button>
        <button class="navBtn" data-view="schedule">班表管理</button>
        <button class="navBtn" data-view="addRestaurant">新增餐廳</button>
        <button class="navBtn" data-view="restaurants">餐廳管理</button>
        <button class="navBtn" data-view="randomPick">幫我想要吃啥</button>
        <button class="navBtn" data-view="orders">訂餐紀錄</button>
        <div class="hr"></div>
        <button id="switchUser" class="navBtn">切換使用者模式</button>
        <button id="logout" class="navBtn">登出</button>
      </div>

      <p class="muted" style="margin:12px 8px 0;">
        ✅ 餐廳：可顯示/隱藏、可結單/開單、可設定營業時間/公休日<br/>
        ✅ 訂單：支援 Excel 匯出、支援刪整筆/刪單一道<br/>
        ✅ 餐點：支援「擇一(下拉) / 加購(多選)」選項<br/>
        ✅ 新增餐點：餐點類別支援「群組新增 + 拖曳排序」<br/>
        ✅ 班表：選日期勾選休假人員，訂餐頁會提醒未點餐名單<br/>
      </p>
    </aside>

    <main class="main">
      <div class="topbar">
        <h2 id="pageTitle">新增餐廳</h2>
        <div class="right">
          <span class="pill" id="statusPill">連線中…</span>
          <button class="ghost" id="gotoIndex">🎰</button>
        </div>
      </div>

      <!-- VIEW: 新增餐廳 -->
      <section class="view" id="view_addRestaurant">
        <div class="grid">
          <div class="card">
             <h3>餐廳資料</h3>

          <label>餐廳分類（可輸入或快速選擇）</label>
<div class="row">
  <div>
    <input id="r_category" autocomplete="off" placeholder="例：燒臘 / 粥品 / 麵類 / 便當"/>
  </div>

  <div>
    <select id="r_category_select">
      <option value="">選擇已使用過的分類</option>
    </select>
  </div>
</div>

            <label>餐廳名稱</label>
            <input id="r_name" name="r_name_no_autofill" autocomplete="off" placeholder="例：金磚便當"/>

            <div class="row">
              <div>
                <label>電話</label>
                <input id="r_phone" autocomplete="off" placeholder="例：02-1234-5678"/>
              </div>
              <div>
                <label>地址</label>
                <input id="r_addr" autocomplete="off" placeholder="例：台中市…"/>
              </div>
            </div>

             <div class="row">
              <div>
                <label>Google map 連結</label>
                <input id="r_map" autocomplete="off" placeholder="https://maps.google.com/..."/>
              </div>
              <div>
                <label>餐廳圖片網址</label>
                <input id="r_imgUrl" autocomplete="off" placeholder="https://...jpg / png"/>
              </div>
            </div>

            <label>營業時間</label>
            <input id="r_hours" autocomplete="off" placeholder="例：11:00~14:30 / 16:30~19:30"/>

            <label>公休日</label>
            <div class="chkline mini" id="r_weeklyOffWrap">
              <label style="margin:0; display:flex; align-items:center; gap:6px;">
                <input type="checkbox" data-weekday="週一公休"> 週一
              </label>
              <label style="margin:0; display:flex; align-items:center; gap:6px;">
                <input type="checkbox" data-weekday="週二公休"> 週二
              </label>
              <label style="margin:0; display:flex; align-items:center; gap:6px;">
                <input type="checkbox" data-weekday="週三公休"> 週三
              </label>
              <label style="margin:0; display:flex; align-items:center; gap:6px;">
                <input type="checkbox" data-weekday="週四公休"> 週四
              </label>
              <label style="margin:0; display:flex; align-items:center; gap:6px;">
                <input type="checkbox" data-weekday="週五公休"> 週五
              </label>
              <label style="margin:0; display:flex; align-items:center; gap:6px;">
                <input type="checkbox" data-weekday="週六公休"> 週六
              </label>
              <label style="margin:0; display:flex; align-items:center; gap:6px;">
                <input type="checkbox" data-weekday="週日公休"> 週日
              </label>
            </div>

            <div class="row">
              <div>
                <label>Line QR Code 圖片網址</label>
                <input id="r_lineQrUrl" autocomplete="off" placeholder="https://...png（QR code 圖）"/>
              </div>
               <div>
                <label>線上點餐連結</label>
                <input id="r_onlineOrderUrl" autocomplete="off" placeholder="https://..."/>
              </div>
            </div>
            <div class="muted" style="margin-top:6px">（貼 QR code 圖片網址或線上點餐連結即可）</div>

            <img id="r_imgPrev" class="imgPrev" style="display:none; margin-top:10px" alt="preview"/>
            <img id="r_lineQrPrev" class="qrPrev" style="display:none; margin-top:10px" alt="Line QR preview"/>

            <div class="row">
              <div class="chkline" style="margin-top:12px">
                <input id="r_visible" type="checkbox" checked>
                <label style="margin:0; color:var(--muted)">使用者顯示</label>
              </div>
              <div class="chkline" style="margin-top:12px">
                <input id="r_closed" type="checkbox">
                <label style="margin:0; color:var(--muted)">結單（使用者不可送單）</label>
              </div>
            </div>

            <label>備註</label>
            <textarea id="r_note" autocomplete="off" placeholder="可填營業時間補充、付款方式…"></textarea>

            <div class="actions">
              <button class="primary" id="btnSubmitAll">新增（餐廳 + 餐點清單）</button>
              <button class="ghost" id="btnClearAll" type="button">清空</button>
            </div>

            <p class="muted">右邊可先把餐點加入清單，再按一次「直接新增上」。</p>
          </div>

          <div class="card">
            <h3>餐點（先加入清單，可多筆）</h3>

            <!-- ✅ 餐點類別（群組制 + 拖曳排序） -->
            <h3 style="margin-top:0">餐點類別（需先建立群組）</h3>
            <div class="subcard">
              <div class="inline">
                <input id="cat_input" placeholder="例：飯類 / 麵類 / 小菜 / 飲料"/>
                <button class="btnSmall btnOk" id="btnAddCatGroup" type="button">新增類別</button>
              </div>

              <div id="catGroupWrap" class="kpi" style="margin-top:10px"></div>
              <div class="muted mini">可拖曳調整顯示順序（☰ 位置按住拖拉）</div>
            </div>

            <label style="margin-top:12px">餐點類別（從已建立群組選擇）</label>
            <select id="m_cat">
              <option value="">請先選擇餐點類別</option>
            </select>

            <div class="row" style="margin-top:10px">
              <div>
                <label>餐點名稱</label>
                <input id="m_name" placeholder="例：法式炒麵"/>
              </div>
              <div>
                <label>價格（單份）</label>
                <input id="m_price" type="number" min="0" placeholder="120"/>
              </div>
            </div>

             <label>餐點內容</label>
            <input id="m_content" placeholder="例：雞腿、蔬菜、滷蛋"/>

            <div class="row">
              <div>
                    <label>數量規則</label>
                <select id="m_qtyType">
                  <option value="normal">正常份量（1,2,3...）</option>
                  <option value="multiple">倍數份量（固定倍數）</option>
                </select>
              </div>
              <div>
                <label>倍數基準數</label>
                <input id="m_defaultQty" type="number" min="1" value="1"/>
             <div class="muted mini" id="m_qtyHint" style="margin-top:6px">數量會以此倍數遞增（例：5 → 5、10、15）</div>
            </div>
           </div>
            
           <div class="hr"></div>

<details id="secOptionGroups" class="fold">
  
  <summary>
    ✅ 選項群組
  </summary>

             <div class="subcard">
              <div class="row3">
                <div>
                  <label>群組名稱</label>
                  <input id="og_name" placeholder="例：肉類 / 醬料 / 麵體"/>
                </div>
                <div>
                  <label>類型</label>
                  <select id="og_type">
                    <option value="single">擇一（下拉）</option>
                    <option value="addon">加購（多選）</option>
                  </select>
                </div>
                <div style="display:flex; align-items:end; gap:10px">
                  <label style="display:flex; align-items:center; gap:8px; margin:0;">
                    <input id="og_required" type="checkbox" style="width:18px; height:18px;" checked/>
                    必選（擇一用）
                  </label>
                  <button class="btnSmall btnOk" id="btnStartGroup" type="button">新增群組</button>
                </div>
              </div>

              <div id="groupDraftArea" style="margin-top:10px; display:none">
                <div class="optBox">
                  <div class="inline" style="justify-content:space-between; align-items:flex-start">
                    <div>
                      <b id="draftGroupTitle">群組</b>
                      <div class="muted mini" id="draftGroupDesc"></div>
                    </div>
                    <button class="btnSmall btnDanger" id="btnCancelGroup" type="button">取消群組</button>
                  </div>

                  <div class="hr"></div>

                  <div class="optRow">
                    <div>
                      <label>選項名稱</label>
                      <input id="opt_name" placeholder="例：豬肉 / 雞肉 / 加蛋"/>
                    </div>
                    <div>
                      <label>加價（可為 0）</label>
                      <input id="opt_price" type="number" min="0" placeholder="0"/>
                    </div>
                    <div style="display:flex; align-items:end; gap:10px">
                      <button class="btnSmall btnOk" id="btnAddChoice" type="button">加入選項</button>
                    </div>
                  </div>

                  <div id="choiceDraftList" style="margin-top:10px"></div>

                  <div class="actions">
                    <button class="btnSmall btnOk" id="btnCommitGroup" type="button">完成此群組（加入到餐點）</button>
                  </div>
                </div>
              </div>

              <div class="muted mini" style="margin-top:10px">已建立的選項群組（可刪除）</div>
              <div id="menuOptionGroupsList" style="margin-top:10px"></div>
              
              <div class="hr"></div>

              <div class="muted mini" style="margin-bottom:6px">此餐點支援哪些選項（勾選）</div>
              <div id="menuOptionGroupPickList" class="kpi"></div>
              </div>

             </details>

<!-- ✅ 預設收合：不要加 open -->
<details id="secSetMeal" class="fold">
  <summary>
   ✅ 套餐選項
  </summary>

  <div class="subcard">
    <div class="row3">
      <div>
        <label>套餐名稱</label>
        <input id="sm_name" placeholder="例：A餐 / 超值套餐"/>
      </div>
      <div>
        <label>套餐價格（基礎）</label>
        <input id="sm_price" type="number" min="0" placeholder="例：59"/>
      </div>
      <div style="display:flex; align-items:end; gap:10px">
        <button class="btnSmall btnOk" id="btnStartSetMeal" type="button">新增套餐</button>
      </div>
    </div>

    <!-- 套餐編輯區（草稿） -->
    <div id="setMealDraftArea" style="margin-top:10px; display:none">
      <div class="optBox">
        <div class="inline" style="justify-content:space-between; align-items:flex-start">
          <div>
            <b id="draftSetMealTitle">套餐</b>
            <div class="muted mini" id="draftSetMealDesc"></div>
          </div>
          <button class="btnSmall btnDanger" id="btnCancelSetMeal" type="button">取消套餐</button>
        </div>

        <div class="hr"></div>

        <div class="row3">
          <div>
            <label>套餐類別</label>
            <input id="sm_catName" placeholder="例：小點 / 湯品 / 飲品"/>
          </div>
          <div>
            <label>此類別要選幾樣</label>
            <select id="sm_pickCount">
              <option value="1">選 1</option>
              <option value="2">選 2</option>
            </select>
          </div>
          <div style="display:flex; align-items:end; gap:10px">
            <button class="btnSmall btnOk" id="btnAddSetMealCategory" type="button">加入類別</button>
          </div>
        </div>

        <div id="setMealCategoryList" style="margin-top:10px"></div>

        <div class="actions">
          <button class="btnSmall btnOk" id="btnCommitSetMeal" type="button">完成此套餐（加入到模板清單）</button>
        </div>
      </div>
    </div>

    <!-- 已建立的套餐模板 -->
    <div style="margin-top:10px">
      <div class="muted mini" style="margin-bottom:6px">已建立的套餐模板（可刪除）</div>
      <div id="setMealTemplatesList"></div>
    </div>

    <div class="hr"></div>

    <!-- 此餐點支援哪些套餐（勾選） -->
    <div>
      <div class="muted mini" style="margin-bottom:6px">此餐點支援哪些套餐（勾選）</div>
      <div id="setMealPickList" class="kpi"></div>
    </div>
  </div>
</details>

<div class="hr"></div>

<!-- ✅ 這兩顆按鈕放在「套餐」下面 -->
<div class="actions">
  <button class="btnSmall btnOk" id="btnAddMenuToQueue" type="button">加入餐點清單</button>
  <button class="ghost" id="btnClearMenu" type="button">清空餐點欄位（含選項群組）</button>
</div>

</div> <!-- ✅ 結束：右側「餐點」card -->

<!-- ✅ 滿版（grid 兩欄跨欄）的餐點清單 -->
<div style="grid-column: 1 / -1">
  <div class="hr"></div>
  <h3 style="margin-top:0">餐點清單（將一起新增）</h3>
  <div id="menuQueueWrap" class="muted">尚未加入餐點。</div>
</div>
          
      </section>

      <!-- VIEW: 新增人員 -->
      <section class="view" id="view_staff" style="display:none">
        <div class="grid">
          <div class="card">
            <h3>新增人員</h3>

            <label>部門</label>
            <input id="s_dept" list="dept_list" placeholder="請選或輸入部門"/>
            <datalist id="dept_list">
              <option value="管理部"></option>
              <option value="TSE"></option>
              <option value="FAE"></option>
              <option value="倉管"></option>
              <option value="新場"></option>
              <option value="工程師"></option>
              <option value="教育訓練"></option>
              <option value="線上客服"></option>
            </datalist>

            <label>人員名稱</label>
            <input id="s_name" placeholder="例：小明（按 Enter 也可新增）"/>

            <div class="actions">
              <button class="primary" id="btnAddStaff" type="button">新增</button>
              <button class="ghost" id="btnClearStaff" type="button">清空</button>
            </div>

            <p class="muted">相同部門會自動收合顯示，並可刪除人員。</p>
          </div>

          <div class="card">
            <h3>人員清單</h3>
            <div id="staffWrap"></div>
          </div>
        </div>
      </section>

      <!-- VIEW: 班表管理 -->
      <section class="view" id="view_schedule" style="display:none">
        <div class="card">
          <h3>班表管理</h3>
          <p class="muted mini" style="margin-top:6px;">
             ✅ 「年月日」改為查看指定日期的上班名單（依部門顯示）；休假仍透過下方部門/人員月曆勾選。
          </p>

         <div class="row3" style="margin-top:4px;">
            <div>
              <label>年</label>
              <select id="sch_year"></select>
            </div>
            <div>
              <label>月</label>
              <select id="sch_month"></select>
            </div>
            <div>
             <label>日</label>
              <select id="sch_day"></select>
            </div>
          </div>
          <div class="actions" style="margin-top:8px;">
            <button class="primary" id="btnLoadSchedule" type="button">顯示上班名單</button>
            <button class="ghost" id="btnScheduleToday" type="button">跳到今天</button>
          </div>

           <div class="hr"></div>

             <div class="row3" style="margin-top:8px;">
            <div>
              <label>班別</label>
              <select id="sch_shift">
                <option value="">請選班別</option>
                <option value="morning">早班</option>
                <option value="evening">晚班</option>
              </select>
            </div>
            <div>
              <label>部門</label>
              <select id="sch_dept"></select>
            </div>
            <div>
              <label>人員</label>
              <select id="sch_staff"></select>
            </div>
          </div>
          <p class="muted mini" style="margin-top:8px;">
          選擇部門與人員後，會顯示當月月曆，點選日期即可切換該人員是否休假（未勾選日期視為上班日）。國定假日會以金色提示。
          </p>
          <div id="scheduleMonthWrap"></div>

          <div class="hr"></div>
          
          <div id="scheduleWrap" style="margin-top:10px"></div>
        </div>
      </section>

      <!-- VIEW: 餐廳管理 -->
      <section class="view" id="view_restaurants" style="display:none">
  <div class="card">
             <div class="inline" style="justify-content:space-between; align-items:center;">
            <h3 style="margin:0;">餐廳管理</h3>
            <span class="tag" id="restTotalCount">0 家</span>
          </div>
<!-- 🔵 顯示中的餐廳 -->
<div class="restaurant-status-grid">
  <div class="subcard" style="margin-bottom:10px;">
    <div class="inline" style="justify-content:space-between; align-items:center;">
      <div>
        <div style="font-size:13px; font-weight:800;">顯示中的餐廳</div>
        <div class="muted mini">使用者端可見的店家</div>
      </div>
      <span class="tag" id="restShowCount">0 家</span>
    </div>
     <select id="restShowList" style="margin-top:8px;">
      <option value="">載入中…</option>
    </select>
  </div>

<!-- 🔵 開單中的餐廳 -->
  <div class="subcard" style="margin-bottom:10px;">
    <div class="inline" style="justify-content:space-between; align-items:center;">
      <div>
        <div style="font-size:13px; font-weight:800;">開單中的餐廳</div>
        <div class="muted mini">目前可供訂單送出的店家</div>
      </div>
      <span class="tag" id="restOpenCount">0 家</span>
    </div>
  <select id="restOpenList" style="margin-top:8px;">
      <option value="">載入中…</option>
    </select>
  </div>
</div>
          <!-- 🔵 🔵 🔵 總覽卡片結束 🔵 🔵 🔵 -->

          <!-- 🔸 搜尋區塊 -->
          <div class="inline" style="margin-top:10px">
            <label style="margin:0; min-width:120px; color:var(--muted)">搜尋餐廳</label>
            <input id="restSearchOpen" placeholder="輸入關鍵字後按 Enter (可搜店名/分類/公休日/營業時間)" style="min-width:340px">
            <button class="btnSmall" type="button" id="btnRestSearchClear">清除</button>
          </div>

          <div class="hr"></div>
          <div id="restaurantsWrap"></div>
        </div>
      </section>

       <!-- VIEW: 幫我想要吃啥 -->
      <section class="view" id="view_randomPick" style="display:none">
        <div class="card">
          <h3>幫我想要吃啥</h3>
          <p class="muted">
               只會從「營業中」的餐廳隨機幫你挑一家。可先選擇餐廳分類或全選。
          </p>

          <div class="inline" style="margin-top:10px">
            <div style="min-width:220px">
              <label style="margin:0; color:var(--muted)">餐廳分類</label>
              <select id="randomCategorySelect">
                <option value="all">全部分類</option>
              </select>
            </div>
            <div style="display:flex; gap:8px; align-items:flex-end;">
              <button class="primary" id="btnRandomPick" type="button">隨機決定</button>
              <button class="ghost" id="btnRandomReload" type="button">重新載入</button>
            </div>
          </div>

          <div class="randomResult" id="randomResult">
            <div class="muted">尚未抽選。</div>
          </div>
        </div>
      </section>

      <!-- VIEW: 訂餐紀錄 -->
      <section class="view" id="view_orders" style="display:none">
        <!-- ✅ 上：控制橫條 ；下：左右兩欄 -->
        <div style="display:grid; gap:14px">

          <!-- ✅ 上方橫條：訂單統計（控制列） -->
          <div class="card">
            <h3>訂單統計</h3>

            <!-- 🔔 未點餐提醒條 -->
            <div id="noOrderBanner" class="alertBar" style="display:none"></div>

            <div class="ordersTopBar">
              <div class="leftCtl">
                <div class="dateBox">
                  <label>訂單日期</label>
                  <input id="o_date" type="date"/>
                </div>

                <div>
                  <label>顯示模式</label>
                  <div class="pill" style="height:42px; display:flex; align-items:center;">
                    同品項彙總（跨所有人）
                  </div>
                </div>

                <div>
                  <label>餐別顯示</label>
                  <select id="ordersMealFilter" style="min-width:140px">
                     <option value="lunch">午餐</option>
                    <option value="dinner">晚餐</option>
                  </select>
                </div>

                <div>
                  <label>操作</label>
                  <div class="inline">
                    <button class="primary" id="btnLoadOrders" type="button">載入</button>
                    <button class="ghost" id="btnToday" type="button">今天</button>
                    <button class="btnSmall btnOk" id="btnExportExcel" type="button">匯出 Excel</button>
                  </div>
                </div>
              </div>
               <div class="rightCtl">
                <div>
                  <label>新單通知</label>
                  <div class="notifyToggle">
                    <input id="toggleOrderSound" type="checkbox" checked/>
                    <span id="orderSoundLabel" class="muted mini">音效開啟</span>
                  </div>
                </div>
              </div>
            </div>

            <p class="muted" style="margin-top:10px">
                Excel 欄位：部門、姓名、共同點餐部門、共同點餐人員、品項、加購/擇一、餐點備註、金額、應收
            </p>
          </div>

          <!-- ✅ 下方左右：左統計表 / 右訂單明細 -->
          <div style="display:grid; grid-template-columns: 1fr 1fr; gap:14px" id="ordersTwoCol">
            <!-- 左：同品項彙總 -->
            <div class="card">
              <h3>訂單統計（同品項彙總）</h3>
              <div id="ordersSummaryOut" class="muted">請選日期後按「載入」。</div>
            </div>

            <!-- 右：訂單明細 -->
            <div class="card">
              <h3>訂單明細（可刪整筆 / 刪一道）</h3>
              <div id="ordersDetailOut" class="muted">請選日期後按「載入」。</div>
            </div>
          </div>

        </div>
      </section>

      <script>
        // ✅ 小螢幕自動改成單欄（不影響你原本全域 @media）
        (function(){
          const mq = window.matchMedia("(max-width:980px)");
          const apply = ()=>{
            const el = document.getElementById("ordersTwoCol");
            if(!el) return;
            el.style.gridTemplateColumns = mq.matches ? "1fr" : "1fr 1fr";
          };
          apply();
          mq.addEventListener?.("change", apply);
        })();
      </script>

    </main>
  </div>

  <!-- 🔔 未點餐彈跳視窗 -->
  <div id="noOrderModal" class="modalMask" style="display:none">
    <div class="modalBox">
      <h3 style="margin-top:0; margin-bottom:8px;">今日未點餐紀錄</h3>
      <div id="noOrderList" class="muted mini">
        （尚無資料）
      </div>
      <div class="actions" style="margin-top:12px; justify-content:flex-end;">
        <button class="ghost" type="button" id="btnCloseNoOrder">關閉</button>
      </div>
    </div>
  </div>
  
  <!-- ⚠️ 結單確認彈跳視窗 -->
<div id="closeConfirmModal" class="modalMask" style="display:none;">
  <div class="modalBox">
    <h3 style="margin-top:0; margin-bottom:8px;">⚠️ 確定要結單嗎？</h3>
    <p class="muted mini" style="line-height:1.5; margin-bottom:8px;">
      結單後，使用者將無法再送單。<br/>
      點擊「確定結單」後，要記得儲存餐廳資料喔。
    </p>

      <!-- 🔍 本日上班未點餐的紀錄（動態填入） -->
    <div id="closeConfirmNoOrder" class="muted mini" style="margin-bottom:12px;">
      本日上班未點餐紀錄：計算中…
    </div>

  <div class="actions" style="justify-content:flex-end; gap:12px;">
      <button class="ghost" type="button" id="btnCancelClose">先不要</button>
      <button class="primary" type="button" id="btnConfirmClose">確定結單</button>
    </div>
  </div>
</div>

  <div id="orderNoticeWrap" class="orderNoticeWrap" aria-live="polite"></div>


  <!-- ✅ Excel 匯出用（SheetJS） -->
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>

  <script type="module">
    const roleKey = "gb_role";
   const adminCode = "777";
    const adminGate = document.getElementById("adminGate");
    const adminInput = document.getElementById("adminGateInput");
    const adminBtn = document.getElementById("adminGateBtn");
    const adminBack = document.getElementById("adminGateBack");
    const adminError = document.getElementById("adminGateError");
    const showGate = () => {
      document.body.classList.add("is-locked");
      adminGate?.removeAttribute("hidden");
      adminGate?.setAttribute("aria-hidden", "false");
      adminError.textContent = "";
      adminInput.value = "";
      adminInput.focus();
    };
    const hideGate = () => {
      document.body.classList.remove("is-locked");
      adminGate?.setAttribute("hidden", "");
      adminGate?.setAttribute("aria-hidden", "true");
    };
    const storedRole = localStorage.getItem(roleKey);
    if (storedRole !== "admin") {
      const params = new URLSearchParams(window.location.search);
      const queryCode = params.get("admin");
      if (queryCode === adminCode) {
        localStorage.setItem(roleKey, "admin");
        window.history.replaceState({}, "", window.location.pathname);
        hideGate();
      } else {
     showGate();
      }
      } else {
      hideGate();
    }
const verifyAdminCode = () => {
      if (adminInput.value.trim() === adminCode) {
        localStorage.setItem(roleKey, "admin");
        hideGate();
      } else {
        adminError.textContent = "密碼錯誤，請再試一次。";
        adminInput.value = "";
        adminInput.focus();
      }
    };
    adminBtn?.addEventListener("click", verifyAdminCode);
    adminInput?.addEventListener("keydown", (event) => {
      if (event.key === "Enter") {
        verifyAdminCode();
      }
    });
    adminBack?.addEventListener("click", () => {
      window.location.href = "./index.html";
    });
    
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-app.js";
    import {
      getFirestore, collection, addDoc, doc, updateDoc, deleteDoc, getDocs, getDoc,
      query, where, limit, writeBatch, orderBy, setDoc, onSnapshot
    } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyBdgOddTGAfqqHLnhnaJRv2_y7gyweuQEo",
      authDomain: "goldbricks-order.firebaseapp.com",
      projectId: "goldbricks-order",
      storageBucket: "goldbricks-order.firebasestorage.app",
      messagingSenderId: "463709758954",
      appId: "1:463709758954:web:429dc920f2f812d51cbe93",
      measurementId: "G-YQK8ZCC26R"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    const $ = (id)=> document.getElementById(id);
    const esc = (s)=> (s??"").toString()
      .replaceAll("&","&amp;").replaceAll("<","&lt;").replaceAll(">","&gt;").replaceAll('"',"&quot;");

    const pad2 = (n)=> String(n).padStart(2,"0");
    const todayISO = ()=>{
      const d = new Date();
      return `${d.getFullYear()}-${pad2(d.getMonth()+1)}-${pad2(d.getDate())}`;
    };
    const WEEKDAY_LABEL = ["日","一","二","三","四","五","六"];

    // ✅ 相容：createdAt 可能是 number(ms) 或 Firestore Timestamp
    const toMs = (v)=>{
      if(v==null) return 0;
      if(typeof v === "number") return v;
      if(typeof v?.toMillis === "function") return v.toMillis();
      if(typeof v?.seconds === "number") return Math.floor(v.seconds*1000);
      return 0;
    };
    const toTWTime = (v)=>{
      const ms = toMs(v);
      if(!ms) return "";
      try{ return new Date(ms).toLocaleString("zh-TW", { hour12:false }); }
      catch{ return String(ms); }
    };

    /* =========================================================
       ✅ 部門排序：固定順序（訂單明細/Excel/人員清單 共用）
       ========================================================= */
    const DEPT_ORDER = [
     "管理部",
      "TSE",
      "FAE",
      "倉管",
      "新場",
      "工程師",
      "教育訓練",
      "線上客服"
    ];
    const DEPT_INDEX = new Map(DEPT_ORDER.map((d,i)=>[d,i]));
    function deptRank(dept){
      return DEPT_INDEX.has(dept) ? DEPT_INDEX.get(dept) : 999;
    }

    const statusPill = $("statusPill");
    statusPill.textContent = "已連線 Firestore";

    // ✅ 強制移除「餐廳名稱預設值」（避免瀏覽器記住）
    window.addEventListener("load", ()=>{
      const el = $("r_name");
      if (el) el.value = "";
      buildScheduleSelects();
    });

    // ====== Views ======



    const pageTitle = $("pageTitle");
    const views = {
      staff: $("view_staff"),
      schedule: $("view_schedule"),
      addRestaurant: $("view_addRestaurant"),
      restaurants: $("view_restaurants"),
      randomPick: $("view_randomPick"),
      orders: $("view_orders"),
    };
   function show(viewKey){
  Object.entries(views).forEach(([k,el])=> 
    el.style.display = (k===viewKey) ? "" : "none"
  );

  // 🔥 強制把主內容捲軸拉回最上
  document.querySelector(".main").scrollTop = 0;
  window.scrollTo(0, 0);
      document.querySelectorAll(".navBtn[data-view]").forEach(b=> b.classList.toggle("active", b.dataset.view===viewKey));
      pageTitle.textContent =
        viewKey==="staff" ? "新增人員" :
        viewKey==="schedule" ? "班表管理" :
        viewKey==="addRestaurant" ? "新增餐廳" :
        viewKey==="restaurants" ? "餐廳管理" :
        viewKey==="randomPick" ? "幫我想要吃啥" :
        "訂餐紀錄";

      if(viewKey==="staff") refreshStaffList();
      if(viewKey==="schedule") initSchedulePeopleSelectors();
      if(viewKey==="restaurants") refreshRestaurantsManage();
      if(viewKey==="randomPick") refreshRandomPick();
    }
    document.querySelectorAll(".navBtn[data-view]").forEach(btn=>{
      btn.addEventListener("click", ()=> show(btn.dataset.view));
    });
    show("addRestaurant");

    $("btnRandomPick")?.addEventListener("click", ()=> pickRandomRestaurant());
    $("btnRandomReload")?.addEventListener("click", ()=> refreshRandomPick(true));
    
    $("logout").onclick = ()=>{ localStorage.removeItem(roleKey); location.href = "./index.html"; };
    $("switchUser").onclick = ()=>{ localStorage.setItem(roleKey, "user"); location.href = "./user.html"; };
    $("gotoIndex").onclick = ()=> location.href = "./index.html";

    const colRestaurants = collection(db, "restaurants");
    const colStaff = collection(db, "staff");
    const colOrders = collection(db, "orders");
    const colSchedules = collection(db, "schedules");

      let randomPickRestaurants = [];

    const normalizeRestaurantCategory = (value)=> (value || "").trim() || "未分類";

    const buildRandomCategoryOptions = (list, selectEl)=>{
      if(!selectEl) return;
      const prevValue = selectEl.value || "all";
      const set = new Set();
      list.forEach(r => set.add(normalizeRestaurantCategory(r.category)));
      const options = Array.from(set).sort((a,b)=>{
        if(a === "未分類" && b !== "未分類") return 1;
        if(b === "未分類" && a !== "未分類") return -1;
        return a.localeCompare(b, "zh-Hant");
      });
      selectEl.innerHTML = `
        <option value="all">全部分類</option>
        ${options.map(c => `<option value="${esc(c)}">${esc(c)}</option>`).join("")}
      `;
      if(options.includes(prevValue)) selectEl.value = prevValue;
    };

     const getWeekdayOffLabel = (date)=>{
      const labels = ["週日公休", "週一公休", "週二公休", "週三公休", "週四公休", "週五公休", "週六公休"];
      return labels[date.getDay()];
    };

    const parseTimeToMinutes = (timeText)=>{
      const [h, m] = (timeText || "").split(":").map(Number);
      if(Number.isNaN(h) || Number.isNaN(m)) return null;
      return h * 60 + m;
    };

    const parseBusinessHoursRanges = (hoursText)=>{
      if(!hoursText) return [];
      const ranges = [];
      const regex = /(\d{1,2}:\d{2})\s*[~\-–—]\s*(\d{1,2}:\d{2})/g;
      let match;
      while((match = regex.exec(hoursText)) !== null){
        const start = parseTimeToMinutes(match[1]);
        const end = parseTimeToMinutes(match[2]);
        if(start === null || end === null) continue;
        ranges.push({ start, end });
      }
      return ranges;
    };

    const isNowWithinRange = (start, end, nowMinutes)=>{
      if(start === end) return true;
      if(end < start){
        return nowMinutes >= start || nowMinutes <= end;
      }
      return nowMinutes >= start && nowMinutes <= end;
    };

    const isRestaurantOpenNow = (restaurant, now = new Date())=>{
      if(restaurant?.isClosed) return false;
      const weeklyOff = Array.isArray(restaurant?.weeklyOff) ? restaurant.weeklyOff : [];
      if(weeklyOff.includes(getWeekdayOffLabel(now))) return false;
      const hoursText = (restaurant?.businessHours || "").trim();
      const ranges = parseBusinessHoursRanges(hoursText);
      if(ranges.length === 0) return true;
      const nowMinutes = now.getHours() * 60 + now.getMinutes();
      return ranges.some(({ start, end }) => isNowWithinRange(start, end, nowMinutes));
    };

     const getRandomPickCandidates = (category)=>{
      let list = randomPickRestaurants.filter(r => isRestaurantOpenNow(r));
      if(category && category !== "all"){
        list = list.filter(r => normalizeRestaurantCategory(r.category) === category);
      }
      return list;
    };

    async function refreshRandomPick(force = false){
      const selectEl = $("randomCategorySelect");
      const resultEl = $("randomResult");
      if(!selectEl || !resultEl) return;

      if(!force && randomPickRestaurants.length){
        const available = getRandomPickCandidates("all");
        buildRandomCategoryOptions(available, selectEl);
        resultEl.innerHTML = `<div class="muted">請按「隨機決定」開始抽選。</div>`;
        return;
      }

      resultEl.innerHTML = `<div class="muted">載入中…</div>`;
      try{
        const snap = await getDocs(query(colRestaurants, limit(1200)));
        randomPickRestaurants = [];
        snap.forEach(d => randomPickRestaurants.push({ id: d.id, ...(d.data() || {}) }));

        const available = getRandomPickCandidates("all");
        buildRandomCategoryOptions(available, selectEl);
        resultEl.innerHTML = available.length
          ? `<div class="muted">目前可抽選 ${available.length} 家餐廳。</div>`
          : `<div class="muted">目前沒有符合營業時間的餐廳。</div>`;
      }catch(err){
        console.error(err);
        resultEl.innerHTML = `<div class="muted">無法載入餐廳清單<br/>${esc(err?.message || err)}</div>`;
      }
    }

    async function pickRandomRestaurant(){
      const selectEl = $("randomCategorySelect");
      const resultEl = $("randomResult");
      if(!selectEl || !resultEl) return;

      if(!randomPickRestaurants.length){
        await refreshRandomPick(true);
      }

      const category = selectEl.value || "all";
      const list = getRandomPickCandidates(category);

      if(!list.length){
        resultEl.innerHTML = `<div class="muted">目前沒有符合條件的餐廳。</div>`;
        return;
      }

      const pick = list[Math.floor(Math.random() * list.length)];
      const cat = normalizeRestaurantCategory(pick.category);
      const address = (pick.address || "").trim();
      const mapUrl = (pick.mapUrl || "").trim();
      const phone = (pick.phone || "").trim();
      const hours = (pick.businessHours || "").trim();
      const weeklyOff = Array.isArray(pick.weeklyOff) ? pick.weeklyOff : [];
      const weeklyOffText = weeklyOff.length ? weeklyOff.join("・") : "";
      const onlineUrl = (pick.onlineOrderUrl || "").trim();
      const lineQrUrl = (pick.lineQrUrl || "").trim();
      const isVisible = pick.isVisible !== false;

      resultEl.innerHTML = `
        <div class="randomResultTitle">🎯 ${esc(pick.name || "未命名餐廳")}</div>
        <div class="randomResultMeta">分類：${esc(cat)}</div>
        ${phone ? `<div class="randomResultMeta">電話：${esc(phone)}</div>` : ""}
        ${address ? `<div class="randomResultMeta">地址：${esc(address)}</div>` : ""}
        ${hours ? `<div class="randomResultMeta">營業時間：${esc(hours)}</div>` : ""}
        ${weeklyOffText ? `<div class="randomResultMeta">公休日：${esc(weeklyOffText)}</div>` : ""}
        <div class="randomResultActions">
          ${mapUrl ? `<a class="btnSmall" href="${esc(mapUrl)}" target="_blank" rel="noopener">查看地圖</a>` : ""}
          ${onlineUrl ? `<a class="btnSmall btnOk" href="${esc(onlineUrl)}" target="_blank" rel="noopener">線上點餐</a>` : ""}
          ${lineQrUrl ? `<a class="btnSmall" href="${esc(lineQrUrl)}" target="_blank" rel="noopener">Line QR</a>` : ""}
          <span class="tag">可抽選 ${list.length} 家</span>
        </div>
         <div class="chkline mini" style="margin-top:10px;">
          <label style="margin:0; display:flex; align-items:center; gap:6px;">
            <input id="randomVisibleToggle" type="checkbox" ${isVisible ? "checked" : ""}>
            <span>使用者顯示</span>
          </label>
        </div>
      `;
      
      const toggle = resultEl.querySelector("#randomVisibleToggle");
      if(toggle){
        toggle.addEventListener("change", async (event)=>{
          const nextVisible = event.target.checked;
          try{
            statusPill.textContent = "更新使用者顯示中…";
            await updateDoc(doc(db, "restaurants", pick.id), { isVisible: nextVisible });
            const target = randomPickRestaurants.find(r => r.id === pick.id);
            if(target) target.isVisible = nextVisible;
            statusPill.textContent = "使用者顯示已更新 ✅";
          }catch(err){
            console.error(err);
            event.target.checked = !nextVisible;
            alert("更新使用者顯示失敗\n\n" + (err?.message || err));
            statusPill.textContent = "更新失敗（看 console）";
          }
        });
      }
    }

   // ✅ 餐廳管理：快取每個餐點的 optionGroups，給 inline 編輯用
let menuOptionCache = new Map();
let menuSetMealCache = new Map();
let addMenuOptionCache = new Map();
let addMenuSetMealSelected = new Map();
let addMenuSetMealTemplatesCache = new Map();
let addMenuSetMealDraft = new Map();
    
// 深拷貝成乾淨的 optionGroups 結構（寫回 Firestore 用）
function cloneOptionGroups(src){
  const arr = Array.isArray(src) ? src : [];
  return arr.map(g => ({
    name: g.name || "",
    type: g.type === "addon" ? "addon" : "single",
    required: !!g.required,
    enabled: g.enabled === false ? false : true,
    useInOptionName: !!g.useInOptionName,
    choices: Array.isArray(g.choices)
      ? g.choices.map(c => ({
          name: c.name || "",
          price: Number(c.price || 0)
        }))
      : []
  }));
}
  function getAddMenuOptionGroups(rid){
  if(!addMenuOptionCache.has(rid)) addMenuOptionCache.set(rid, []);
  return addMenuOptionCache.get(rid);
}

  function getAddMenuSetMealSelected(rid){
  if(!addMenuSetMealSelected.has(rid)) addMenuSetMealSelected.set(rid, new Set());
  return addMenuSetMealSelected.get(rid);
}

 function getAddMenuSetMealTemplates(rid, templates){
  const normalized = normalizeSetMealTemplates(templates);
  addMenuSetMealTemplatesCache.set(rid, normalized);
  return addMenuSetMealTemplatesCache.get(rid);
}
    
    // ====== 新增餐廳：圖片網址預覽 ======


    const r_imgUrl = $("r_imgUrl");
    const r_imgPrev = $("r_imgPrev");
    r_imgUrl.addEventListener("input", ()=>{
      const url = r_imgUrl.value.trim();
      if(!url){ r_imgPrev.style.display="none"; return; }
      r_imgPrev.src = url;
      r_imgPrev.style.display="";
    });
    r_imgPrev.addEventListener("error", ()=>{ r_imgPrev.style.display="none"; });

    
    // 取得所有既有餐廳分類
async function loadExistingCategories() {
  const snap = await getDocs(collection(db, "restaurants"));
  const set = new Set();

  snap.forEach(doc => {
    const c = doc.data().category;
    if (c && typeof c === "string") {
      set.add(c.trim());
    }
  });

  return Array.from(set);
}

// 初始化分類下拉
async function initCategoryDropdown() {
  const input = $("r_category");
  const select = $("r_category_select");

  const list = await loadExistingCategories();

  list.forEach(cat => {
    const opt = document.createElement("option");
    opt.value = cat;
    opt.textContent = cat;
    select.appendChild(opt);
  });

  select.onchange = () => {
    if (select.value) {
      input.value = select.value;
    }
  };
}

initCategoryDropdown();

    // ✅ 新增餐廳：Line QR 預覽
    const r_lineQrUrl = $("r_lineQrUrl");
    const r_lineQrPrev = $("r_lineQrPrev");
    r_lineQrUrl.addEventListener("input", ()=>{
      const url = r_lineQrUrl.value.trim();
      if(!url){ r_lineQrPrev.style.display="none"; return; }
      r_lineQrPrev.src = url;
      r_lineQrPrev.style.display="";
    });
    r_lineQrPrev.addEventListener("error", ()=>{ r_lineQrPrev.style.display="none"; });

    // ✅ 公休日：新增餐廳表單收集/清空
    function getWeeklyOffFromCreateForm(){
      const arr = [];
      document.querySelectorAll('#r_weeklyOffWrap input[type="checkbox"]').forEach(ch=>{
        if(ch.checked) arr.push(ch.dataset.weekday);
      });
      return arr;
    }
    function clearWeeklyOffCreateForm(){
      document.querySelectorAll('#r_weeklyOffWrap input[type="checkbox"]').forEach(ch=>{
        ch.checked = false;
      });
    }

    /* ===============================
       ✅ 新增餐廳：餐點類別（群組制 + 拖曳排序）
       =============================== */
    let catGroups = []; // 只存已建立的餐點類別

    const catInput = $("cat_input");
    const catWrap  = $("catGroupWrap");
    const catSelect = $("m_cat");

    function renderCatGroups(){
      if(catGroups.length === 0){
        catWrap.innerHTML = `<div class="muted mini">尚未建立餐點類別</div>`;
      }else{
        catWrap.innerHTML = catGroups.map((c,i)=>`
          <span class="tag" data-cat-index="${i}" style="cursor:grab">
            ☰ ${esc(c)}
            <button class="btnSmall btnDanger" data-del-cat="${i}" type="button">×</button>
          </span>
        `).join("");
      }

      catSelect.innerHTML = `
        <option value="">請選擇餐點類別</option>
        ${catGroups.map(c=> `<option value="${esc(c)}">${esc(c)}</option>`).join("")}
      `;

      catWrap.querySelectorAll("[data-del-cat]").forEach(btn=>{
        btn.onclick = ()=>{
          catGroups.splice(Number(btn.dataset.delCat), 1);
          renderCatGroups();
        };
      });

      Sortable.create(catWrap, {
        animation: 150,
        onEnd(){
          const newOrder = [];
          catWrap.querySelectorAll("[data-cat-index]").forEach(el=>{
            newOrder.push(catGroups[Number(el.dataset.catIndex)]);
          });
          catGroups = newOrder;
          renderCatGroups();
        }
      });
    }

    $("btnAddCatGroup").onclick = ()=>{
      const v = (catInput?.value || "").trim();
      if(!v) return alert("請輸入餐點類別名稱");
      if(catGroups.includes(v)) return alert("此類別已存在");
      catGroups.push(v);
      catInput.value = "";
      renderCatGroups();
    };
    catInput?.addEventListener("keydown", e=>{
      if(e.key==="Enter"){
        e.preventDefault();
        $("btnAddCatGroup").click();
      }
    });

    renderCatGroups();

    // ====== ✅ 餐點「選項群組」：擇一/加購（可選要不要用） ======
    let draftGroups = [];
    let activeGroupDraft = null;
    let menuOptionGroupSelected = new Set();

    const ogUid = () => `og_${Date.now()}_${Math.random().toString(16).slice(2)}`;
    
    function renderGroups(){
      const wrap = $("menuOptionGroupsList");
      const pickWrap = $("menuOptionGroupPickList");
      draftGroups.forEach(g=>{
        if(!g.id) g.id = ogUid();
      });
      if(draftGroups.length===0){
        wrap.innerHTML = `<div class="muted">（尚未加入任何選項群組：可不使用）</div>`;
         if(pickWrap){
          pickWrap.innerHTML = `<div class="muted">（尚未建立可勾選的選項群組）</div>`;
        }
        return;
      }
      wrap.innerHTML = draftGroups.map((g,gi)=>{
        const choices = (g.choices||[]).map(c=> `${c.name}${Number(c.price||0)?`(+${Number(c.price||0)})`:``}`).join("、") || "—";
        return `
          <div class="inline" style="justify-content:space-between; padding:10px 12px; border:1px solid rgba(15,23,42,.10); border-radius:16px; background:#fff; margin-top:10px;">
            <div>
           <div style="font-weight:700">${esc(g.name)}</div>
              <span class="tag" style="margin-left:8px">${g.type==="single" ? "擇一(下拉)" : "加購(多選)"}</span>
              ${g.type==="single" ? `<span class="tag" style="margin-left:6px">${g.required ? "必選" : "非必選"}</span>` : ``}
              <div class="muted mini" style="margin-top:6px">選項：${esc(choices)}</div>
            </div>
            <button class="btnSmall btnDanger" type="button" data-delg="${gi}">刪除</button>
          </div>
        `;
      }).join("");

      wrap.querySelectorAll("button[data-delg]").forEach(b=>{
        b.onclick = ()=>{
        const removed = draftGroups.splice(Number(b.dataset.delg), 1)[0];
          if(removed?.id) menuOptionGroupSelected.delete(removed.id);
          renderGroups();
        };
      });
      
       if(pickWrap){
        pickWrap.innerHTML = draftGroups.map(g=>{
          const checked = menuOptionGroupSelected.has(g.id) ? "checked" : "";
          return `
            <label class="tag" style="cursor:pointer; gap:6px;">
              <input type="checkbox" data-og-pick="${g.id}" ${checked} style="width:14px; height:14px; margin:0;">
              ${esc(g.name)}
            </label>
          `;
        }).join("");

        pickWrap.querySelectorAll("input[data-og-pick]").forEach(box=>{
          box.addEventListener("change", ()=>{
            const id = box.dataset.ogPick;
            if(!id) return;
            if(box.checked){
              menuOptionGroupSelected.add(id);
            }else{
              menuOptionGroupSelected.delete(id);
            }
          });
        });
      }
    }

    function showGroupDraftUI(on){ $("groupDraftArea").style.display = on ? "" : "none"; }

    function renderChoiceDraft(){
      const wrap = $("choiceDraftList");
      const g = activeGroupDraft;
      if(!g || !Array.isArray(g.choices) || g.choices.length===0){
        wrap.innerHTML = `<div class="muted">尚未加入選項</div>`;
        return;
      }
      wrap.innerHTML = g.choices.map((c,ci)=>`
        <div class="inline" style="justify-content:space-between; padding:8px 10px; border:1px solid rgba(15,23,42,.10); border-radius:14px; background:#fff; margin-top:8px;">
          <div>
            <b>${esc(c.name)}</b>
            <span class="tag" style="margin-left:8px">+${Number(c.price||0)}</span>
          </div>
          <button class="btnSmall btnDanger" type="button" data-delc="${ci}">刪除</button>
        </div>
      `).join("");
      wrap.querySelectorAll("button[data-delc]").forEach(b=>{
        b.onclick = ()=>{
          g.choices.splice(Number(b.dataset.delc), 1);
          renderChoiceDraft();
        };
      });
    }

    /* =========================================================
   ✅ 套餐模板（可選要不要用）
   ========================================================= */

const uid = () =>
  (crypto?.randomUUID?.() ||
   `sm_${Date.now()}_${Math.random().toString(16).slice(2)}`);

let setMealTemplates = [];          // 已建立的套餐模板（全店）
let activeSetMealDraft = null;      // 正在編輯中的套餐
let menuSetMealSelected = new Set();// 此餐點勾選的套餐 id
    
function normalizeSetMealTemplates(raw){
  if(!Array.isArray(raw)) return [];
  return raw.map(t=>({
    id: String(t?.id || "").trim(),
    name: String(t?.name || "").trim(),
    price: Number(t?.price || 0),
    categories: Array.isArray(t?.categories)
      ? t.categories.map(c=>({
          name: String(c?.name || "").trim(),
          pickCount: Math.max(1, Number(c?.pickCount || 1)),
          options: Array.isArray(c?.options)
            ? c.options.map(o=>({
                name: String(o?.name || "").trim(),
                addPrice: Number(o?.addPrice || 0),
                optionGroups: cloneOptionGroups(o?.optionGroups)
              }))
            : []
        }))
      : []
  })).filter(t=> t.id && t.name);
}

  function setMealOptionDisplayName(option){
  const base = (option?.name || "").toString().trim();
  const groups = (Array.isArray(option?.optionGroups) ? option.optionGroups : [])
    .filter(g => g?.useInOptionName)
    .map(g => (g?.name || "").toString().trim())
    .filter(Boolean);
  if(!groups.length) return base;
  const suffix = groups.join(" / ");
  return `${base}${base ? " " : ""}(${suffix})`;
}

function ensureSetMealOptionGroups(option){
  if(!option) return [];
  if(!Array.isArray(option.optionGroups)) option.optionGroups = [];
  return option.optionGroups;
}

function buildSetMealOptionGroupEditor(prefix, option, ci, oi){
  const groups = ensureSetMealOptionGroups(option);
  const attr = name => `data-${prefix}-${name}`;
  const groupRows = groups.map((g,gi)=>{
    const choiceRows = (Array.isArray(g.choices) ? g.choices : []).map((c,coi)=>`
      <div class="inline" style="justify-content:space-between; gap:10px; margin-top:6px">
        <div>${esc(c.name || "—")} <span class="tag">+${Number(c.price||0)}</span></div>
        <button class="btnSmall btnDanger" type="button" ${attr("og-cdel")}="${ci}|${oi}|${gi}|${coi}">刪除</button>
      </div>
    `).join("") || `<div class="muted mini" style="margin-top:6px">尚未加入選項</div>`;

    return `
      <div style="margin-top:10px; padding:10px; border:1px solid rgba(15,23,42,.08); border-radius:12px; background:#fff">
        <div class="inline" style="justify-content:space-between; gap:10px; align-items:flex-start">
          <div>
            <b>${esc(g.name || "子選項群組")}</b>
            <span class="tag" style="margin-left:6px">${g.type==="addon" ? "加購" : "擇一"}</span>
            ${g.type==="single" ? `<span class="tag" style="margin-left:6px">${g.required===false ? "可不選" : "必選"}</span>` : ""}
          </div>
          <button class="btnSmall btnDanger" type="button" ${attr("og-del")}="${ci}|${oi}|${gi}">刪除群組</button>
        </div>
        <label class="inline" style="margin-top:8px; gap:6px;">
          <input type="checkbox" style="width:16px; height:16px;" ${g.useInOptionName ? "checked" : ""} ${attr("og-toggle")}="${ci}|${oi}|${gi}">
          套用在選項名稱內
        </label>
        <div class="optRow" style="margin-top:8px">
          <input ${attr("og-cname")}="${ci}|${oi}|${gi}" placeholder="子選項名稱">
          <input ${attr("og-cprice")}="${ci}|${oi}|${gi}" type="number" min="0" placeholder="加價">
          <button class="btnSmall btnOk" type="button" ${attr("og-cadd")}="${ci}|${oi}|${gi}">加入子選項</button>
        </div>
        ${choiceRows}
      </div>
    `;
  }).join("");

  return `
    <details style="margin-top:8px">
      <summary>子選項群組 ${groups.length ? `（${groups.length}）` : ""}</summary>
      <div class="muted mini" style="margin-top:6px">勾選「套用在選項名稱內」會顯示在套餐類別的選項名稱內。</div>
      <div class="optRow" style="margin-top:8px; align-items:flex-end">
        <input ${attr("og-name")}="${ci}|${oi}" placeholder="群組名稱">
        <select ${attr("og-type")}="${ci}|${oi}">
          <option value="single">擇一（下拉）</option>
          <option value="addon">加購（多選）</option>
        </select>
        <label class="inline" style="gap:6px; margin:0;">
          <input type="checkbox" style="width:16px; height:16px;" ${attr("og-required")}="${ci}|${oi}" checked>
          必選
        </label>
        <label class="inline" style="gap:6px; margin:0;">
          <input type="checkbox" style="width:16px; height:16px;" ${attr("og-use")}="${ci}|${oi}">
          套用在選項名稱內
        </label>
        <button class="btnSmall btnOk" type="button" ${attr("og-add")}="${ci}|${oi}">新增群組</button>
      </div>
      ${groupRows || `<div class="muted mini" style="margin-top:8px">尚無子選項群組</div>`}
    </details>
  `;
}

function bindSetMealOptionGroupEditor(container, getOption, prefix, rerender){
  const attr = name => `data-${prefix}-${name}`;

  container.querySelectorAll(`[${attr("og-add")}]`).forEach(btn=>{
    btn.onclick = ()=>{
      const key = btn.getAttribute(attr("og-add")) || "";
      const [ci,oi] = key.split("|").map(Number);
      const option = getOption(ci, oi);
      if(!option) return;
      const nameEl = container.querySelector(`[${attr("og-name")}="${key}"]`);
      const typeEl = container.querySelector(`[${attr("og-type")}="${key}"]`);
      const requiredEl = container.querySelector(`[${attr("og-required")}="${key}"]`);
      const useEl = container.querySelector(`[${attr("og-use")}="${key}"]`);
      const name = (nameEl?.value || "").trim();
      if(!name) return alert("請輸入群組名稱");
      const type = typeEl?.value === "addon" ? "addon" : "single";
      const required = type === "single" ? !!requiredEl?.checked : false;
      const useInOptionName = !!useEl?.checked;
      ensureSetMealOptionGroups(option).push({
        name,
        type,
        required,
        enabled: true,
        useInOptionName,
        choices: []
      });
      if(nameEl) nameEl.value = "";
      if(typeEl) typeEl.value = "single";
      if(requiredEl) requiredEl.checked = true;
      if(useEl) useEl.checked = false;
      rerender();
    };
  });

  container.querySelectorAll(`[${attr("og-del")}]`).forEach(btn=>{
    btn.onclick = ()=>{
      const key = btn.getAttribute(attr("og-del")) || "";
      const [ci,oi,gi] = key.split("|").map(Number);
      const option = getOption(ci, oi);
      if(!option) return;
      const groups = ensureSetMealOptionGroups(option);
      groups.splice(gi,1);
      rerender();
    };
  });

  container.querySelectorAll(`[${attr("og-toggle")}]`).forEach(box=>{
    box.onchange = ()=>{
      const key = box.getAttribute(attr("og-toggle")) || "";
      const [ci,oi,gi] = key.split("|").map(Number);
      const option = getOption(ci, oi);
      if(!option) return;
      const groups = ensureSetMealOptionGroups(option);
      if(!groups[gi]) return;
      groups[gi].useInOptionName = box.checked;
      rerender();
    };
  });

  container.querySelectorAll(`[${attr("og-cadd")}]`).forEach(btn=>{
    btn.onclick = ()=>{
      const key = btn.getAttribute(attr("og-cadd")) || "";
      const [ci,oi,gi] = key.split("|").map(Number);
      const option = getOption(ci, oi);
      if(!option) return;
      const nameEl = container.querySelector(`[${attr("og-cname")}="${key}"]`);
      const priceEl = container.querySelector(`[${attr("og-cprice")}="${key}"]`);
      const name = (nameEl?.value || "").trim();
      const price = Number(priceEl?.value || 0);
      if(!name) return alert("請輸入子選項名稱");
      const groups = ensureSetMealOptionGroups(option);
      if(!groups[gi]) return;
      if(!Array.isArray(groups[gi].choices)) groups[gi].choices = [];
      groups[gi].choices.push({ name, price });
      if(nameEl) nameEl.value = "";
      if(priceEl) priceEl.value = "";
      rerender();
    };
  });

  container.querySelectorAll(`[${attr("og-cdel")}]`).forEach(btn=>{
    btn.onclick = ()=>{
      const key = btn.getAttribute(attr("og-cdel")) || "";
      const [ci,oi,gi,coi] = key.split("|").map(Number);
      const option = getOption(ci, oi);
      if(!option) return;
      const groups = ensureSetMealOptionGroups(option);
      if(!groups[gi] || !Array.isArray(groups[gi].choices)) return;
      groups[gi].choices.splice(coi,1);
      rerender();
    };
  });
}

/* ===== UI helpers ===== */
function showSetMealDraftUI(on){
  $("setMealDraftArea").style.display = on ? "" : "none";
}

/* ===== 套餐模板列表 ===== */
function renderSetMealTemplates(){
  const wrap = $("setMealTemplatesList");
  if(!wrap) return;

  if(setMealTemplates.length === 0){
    wrap.innerHTML = `<div class="muted">（尚未建立任何套餐）</div>`;
    return;
  }

  wrap.innerHTML = setMealTemplates.map((t, i)=>{
    const cats = (t.categories||[]).map(c=>{
      const opts = (c.options||[])
        .map(o=>{
          const displayName = setMealOptionDisplayName(o);
          return `${esc(displayName || o.name || "—")}${Number(o.addPrice||0) ? `(+${o.addPrice})` : ""}`;
        })
        .join("、") || "—";
      return `${c.name}（選${c.pickCount}）：${opts}`;
    }).join("<br/>");

    return `
      <div style="margin-top:10px; padding:10px 12px; border:1px solid rgba(15,23,42,.12); border-radius:14px; background:#fff">
        <div class="inline" style="justify-content:space-between">
          <div>
            <b>${esc(t.name)}</b>
            <span class="tag" style="margin-left:6px">套餐 ${t.price}</span>
            <div class="muted mini" style="margin-top:6px">${cats}</div>
          </div>
          <button class="btnSmall btnDanger" data-sm-del="${i}">刪除</button>
        </div>
      </div>
    `;
  }).join("");

  wrap.querySelectorAll("[data-sm-del]").forEach(btn=>{
    btn.onclick = ()=>{
      const idx = Number(btn.dataset.smDel);
      const removed = setMealTemplates[idx];
      setMealTemplates.splice(idx,1);
      if(removed?.id) menuSetMealSelected.delete(removed.id);
      renderSetMealTemplates();
      renderSetMealPickList();
    };
  });
}

/* ===== 套餐勾選（此餐點） ===== */
function renderSetMealPickList(){
  const wrap = $("setMealPickList");
  if(!wrap) return;

  if(setMealTemplates.length === 0){
    wrap.innerHTML = `<div class="muted mini">（沒有套餐可選）</div>`;
    return;
  }

  wrap.innerHTML = setMealTemplates.map(t=>{
    const checked = menuSetMealSelected.has(t.id) ? "checked" : "";
    return `
      <label class="tag" style="cursor:pointer">
        <input type="checkbox" data-sm-pick="${t.id}" ${checked}
               style="width:16px; height:16px; margin:0;">
        ${esc(t.name)} <span class="muted mini">(${t.price})</span>
      </label>
    `;
  }).join("");

  wrap.querySelectorAll("[data-sm-pick]").forEach(ch=>{
    ch.onchange = ()=>{
      const id = ch.dataset.smPick;
      ch.checked ? menuSetMealSelected.add(id)
                 : menuSetMealSelected.delete(id);
    };
  });
}

/* ===== 套餐草稿（類別 / 選項） ===== */
function renderSetMealCategoryList(){
  const wrap = $("setMealCategoryList");
  const t = activeSetMealDraft;
  if(!wrap) return;

  if(!t || !t.categories.length){
    wrap.innerHTML = `<div class="muted">尚未加入類別</div>`;
    return;
  }

  wrap.innerHTML = t.categories.map((c,ci)=>{
     const opts = c.options.map((o,oi)=>{
      const editor = buildSetMealOptionGroupEditor("sm", o, ci, oi);
      return `
        <div style="margin-top:6px">
        <div class="inline" style="justify-content:space-between">
            <div>${esc(setMealOptionDisplayName(o) || o.name || "—")} <span class="tag">+${Number(o.addPrice||0)}</span></div>
            <button class="btnSmall btnDanger" data-sm-delopt="${ci}|${oi}">刪除</button>
          </div>
          ${editor}
        </div>
      `;
    }).join("");

    return `
      <div style="margin-top:10px; padding:10px; border:1px dashed rgba(15,23,42,.2); border-radius:12px">
        <b>${esc(c.name)}</b>
        <span class="tag">選 ${c.pickCount}</span>

        <div class="optRow" style="margin-top:8px">
          <input data-sm-optname="${ci}" placeholder="選項名稱">
          <input data-sm-optprice="${ci}" type="number" min="0" placeholder="加價">
          <button class="btnSmall btnOk" data-sm-addopt="${ci}">加入</button>
        </div>

        ${opts || `<div class="muted mini">尚無選項</div>`}
      </div>
    `;
  }).join("");

  wrap.querySelectorAll("[data-sm-addopt]").forEach(btn=>{
    btn.onclick = ()=>{
      const ci = Number(btn.dataset.smAddopt);
      const nameEl = wrap.querySelector(`[data-sm-optname="${ci}"]`);
      const priceEl = wrap.querySelector(`[data-sm-optprice="${ci}"]`);
      const n = nameEl.value.trim();
      const p = Number(priceEl.value||0);
      if(!n) return alert("請輸入選項名稱");
      activeSetMealDraft.categories[ci].options.push({name:n, addPrice:p, optionGroups: []});
      nameEl.value = "";
      priceEl.value = "";
      renderSetMealCategoryList();
    };
  });

  wrap.querySelectorAll("[data-sm-optname]").forEach(input=>{
    input.addEventListener("keydown",(e)=>{
      if(e.key!=="Enter") return;
      e.preventDefault();
      const ci = Number(input.dataset.smOptname);
      wrap.querySelector(`[data-sm-addopt="${ci}"]`)?.click();
    });
  });

  wrap.querySelectorAll("[data-sm-optprice]").forEach(input=>{
    input.addEventListener("keydown",(e)=>{
      if(e.key!=="Enter") return;
      e.preventDefault();
      const ci = Number(input.dataset.smOptprice);
      wrap.querySelector(`[data-sm-addopt="${ci}"]`)?.click();
    });
  });

  wrap.querySelectorAll("[data-sm-delopt]").forEach(btn=>{
    btn.onclick = ()=>{
      const [ci,oi] = btn.dataset.smDelopt.split("|").map(Number);
      activeSetMealDraft.categories[ci].options.splice(oi,1);
      renderSetMealCategoryList();
    };
  });
  
  bindSetMealOptionGroupEditor(
    wrap,
    (ci,oi)=> activeSetMealDraft?.categories?.[ci]?.options?.[oi],
    "sm",
    renderSetMealCategoryList
  );
}

/* ===== 事件 ===== */
$("btnStartSetMeal").onclick = ()=>{
  const name = $("sm_name").value.trim();
  const price = Number($("sm_price").value||0);
  if(!name) return alert("請輸入套餐名稱");

  activeSetMealDraft = { id: uid(), name, price, categories: [] };
  $("draftSetMealTitle").textContent = `套餐：${name}`;
  $("draftSetMealDesc").textContent = `套餐價 ${price}`;
  showSetMealDraftUI(true);
  renderSetMealCategoryList();
};

$("sm_name").addEventListener("keydown",(e)=>{
  if(e.key==="Enter"){
    e.preventDefault();
    $("btnStartSetMeal").click();
  }
});

$("sm_price").addEventListener("keydown",(e)=>{
  if(e.key==="Enter"){
    e.preventDefault();
    $("btnStartSetMeal").click();
  }
});
    
$("btnCancelSetMeal").onclick = ()=>{
  activeSetMealDraft = null;
  showSetMealDraftUI(false);
};

$("btnAddSetMealCategory").onclick = ()=>{
  if(!activeSetMealDraft) return;
  const n = $("sm_catName").value.trim();
  const p = Number($("sm_pickCount").value||1);
  if(!n) return alert("請輸入類別名稱");
  activeSetMealDraft.categories.push({name:n, pickCount:p, options:[]});
  $("sm_catName").value = "";
  renderSetMealCategoryList();
};

 $("sm_catName").addEventListener("keydown",(e)=>{
  if(e.key==="Enter"){
    e.preventDefault();
    $("btnAddSetMealCategory").click();
  }
});

$("btnCommitSetMeal").onclick = ()=>{
  const t = activeSetMealDraft;
  if(!t || !t.categories.length) return alert("至少要一個類別");
  for(const c of t.categories){
    if(!c.options.length) return alert(`類別「${c.name}」沒有選項`);
  }
  setMealTemplates.push(t);
  activeSetMealDraft = null;
  showSetMealDraftUI(false);
  $("sm_name").value = "";
  $("sm_price").value = "";
  renderSetMealTemplates();
  renderSetMealPickList();
};

/* ===== 初始化 ===== */
renderSetMealTemplates();
renderSetMealPickList();

    $("btnStartGroup").onclick = ()=>{
      const name = $("og_name").value.trim();
      const type = $("og_type").value;
      const required = !!$("og_required").checked;

      if(!name) return alert("請輸入群組名稱");
     activeGroupDraft = { id: ogUid(), name, type, required: (type==="single" ? required : false), choices: [] };

      $("draftGroupTitle").textContent = `群組：${name}`;
      $("draftGroupDesc").textContent = type==="single"
        ? `類型：擇一（下拉）｜${required ? "必選" : "非必選"}`
        : `類型：加購（多選）`;

      $("opt_name").value = "";
      $("opt_price").value = "";
      showGroupDraftUI(true);
      renderChoiceDraft();
    };

    $("btnCancelGroup").onclick = ()=>{
      activeGroupDraft = null;
      showGroupDraftUI(false);
      renderChoiceDraft();
    };

    $("btnAddChoice").onclick = ()=>{
      if(!activeGroupDraft) return;
      const n = $("opt_name").value.trim();
      const p = Number($("opt_price").value || 0);
      if(!n) return alert("請輸入選項名稱");
      if(isNaN(p) || p < 0) return alert("加價不正確");

      activeGroupDraft.choices.push({ name: n, price: p });
      $("opt_name").value = "";
      $("opt_price").value = "";
      renderChoiceDraft();
    };

    $("opt_price").addEventListener("keydown",(e)=>{
      if(e.key==="Enter"){ e.preventDefault(); $("btnAddChoice").click(); }
    });
    $("opt_name").addEventListener("keydown",(e)=>{
      if(e.key==="Enter"){ e.preventDefault(); $("btnAddChoice").click(); }
    });

    $("btnCommitGroup").onclick = ()=>{
      const g = activeGroupDraft;
      if(!g) return;
      if(!Array.isArray(g.choices) || g.choices.length===0) return alert("請至少加入 1 個選項");
      draftGroups.push(g);
      if(g.id) menuOptionGroupSelected.add(g.id);

      activeGroupDraft = null;
      $("og_name").value = "";
      $("og_type").value = "single";
      $("og_required").checked = true;
      showGroupDraftUI(false);
      renderGroups();
    };

    renderGroups();

    // ====== 新增餐廳：餐點清單（含選項群組） ======
    let menuQueue = [];

    function summarizeGroups(groups){
      const gs = Array.isArray(groups) ? groups : [];
      if(gs.length===0) return "（無）";
      return gs.map(g=>{
        const t = g.type==="single" ? "擇一" : "加購";
        return `${g.name}-${t}`;
      }).join("、");
    }

    function renderMenuQueue(){
  const wrap = $("menuQueueWrap");
  if(!wrap) return;

  if(menuQueue.length===0){
    wrap.innerHTML = '<div class="muted">尚未加入餐點。</div>';
    return;
  }

  const group = new Map();
  for(const m of menuQueue){
    const cat = (m.category||"未分類").trim() || "未分類";
    if(!group.has(cat)) group.set(cat, []);
    group.get(cat).push(m);
  }

  wrap.innerHTML = Array.from(group.entries()).map(([cat, list])=>{
    const rows = list.map((m)=>{
      const globalIndex = menuQueue.indexOf(m);

      // ✅ 取出這道餐勾選的套餐名稱
      let setMealNames = [];
      if(Array.isArray(m.setMealTemplateIds) && Array.isArray(setMealTemplates)){
        setMealNames = setMealTemplates
          .filter(t => m.setMealTemplateIds.includes(t.id))
          .map(t => t.name);
      }
      const setMealText = setMealNames.length ? setMealNames.join("、") : "無";

      return `
        <div style="margin-top:10px; padding:10px 12px; border:1px solid rgba(15,23,42,.10); border-radius:16px; background:#fff">
          <div class="inline" style="justify-content:space-between">
            <div>
              <b>${esc(m.name)}</b>
              <span class="tag" style="margin-left:6px">價格 ${Number(m.price||0)}</span>
              <span class="tag" style="margin-left:6px">${Number(m.defaultQty||1) > 1 ? `倍數 ${Number(m.defaultQty||1)}` : "正常份量"}</span>
            </div>
            <button class="btnSmall btnDanger" data-del-menu="${globalIndex}" type="button">刪除</button>
          </div>

          ${m.content ? `<div class="muted mini" style="margin-top:6px">內容：${esc(m.content)}</div>` : ``}
          <div class="muted mini" style="margin-top:8px">套餐：${esc(setMealText)}</div>
          <div class="muted mini" style="margin-top:4px">選項群組：${esc(summarizeGroups(m.optionGroups))}</div>
        </div>
      `;
    }).join("");

    return `
      <details style="border:1px solid rgba(15,23,42,.10); border-radius:16px; padding:10px 12px; background:#fff; margin-top:10px;">
        <summary>${esc(cat)} <span class="tag" style="margin-left:8px">${list.length} 道</span></summary>
        <div style="margin-top:10px">${rows}</div>
      </details>
    `;
  }).join("");

  wrap.querySelectorAll("button[data-del-menu]").forEach(b=>{
    b.onclick = ()=>{
      menuQueue.splice(Number(b.dataset.delMenu), 1);
      renderMenuQueue();
    };
  });
}
    renderMenuQueue();

    function syncQtyMode(selectEl, qtyInput, hintEl){
    if(!selectEl || !qtyInput) return;
    const isMultiple = (selectEl.value || "normal") === "multiple";
    qtyInput.disabled = !isMultiple;
    if(!isMultiple){
      qtyInput.value = "1";
    }else if(Number(qtyInput.value || 0) < 1){
      qtyInput.value = "1";
    }
    if(hintEl) hintEl.style.display = isMultiple ? "block" : "none";
  }

  const mainQtyType = $("m_qtyType");
  const mainQtyInput = $("m_defaultQty");
  const mainQtyHint = $("m_qtyHint");
  if(mainQtyType){
    mainQtyType.addEventListener("change", ()=>syncQtyMode(mainQtyType, mainQtyInput, mainQtyHint));
    syncQtyMode(mainQtyType, mainQtyInput, mainQtyHint);
  }

  $("btnClearMenu").onclick = ()=>{
  $("m_cat").value="";
  $("m_name").value="";
  $("m_content").value="";
  $("m_price").value="";
  $("m_defaultQty").value="1";
  $("m_qtyType").value="normal";
  syncQtyMode(mainQtyType, mainQtyInput, mainQtyHint);

  draftGroups = [];
  activeGroupDraft = null;
  menuOptionGroupSelected = new Set();
  showGroupDraftUI(false);
  $("og_name").value="";
  $("og_type").value="single";
  $("og_required").checked=true;
  $("opt_name").value="";
  $("opt_price").value="";
  renderGroups();
  renderChoiceDraft();

  // ✅ 清掉「本餐點勾選的套餐」（模板保留）
  menuSetMealSelected = new Set();
  renderSetMealPickList();
};

   $("btnAddMenuToQueue").onclick = ()=>{
  const category = $("m_cat").value;
  if(!category) return alert("請先建立並選擇餐點類別（需使用新增類別群組）");

  const name = $("m_name").value.trim();
  const content = $("m_content").value.trim();
  const price = Number($("m_price").value||0);
  const qtyType = $("m_qtyType").value || "normal";
  const defaultQty = qtyType === "multiple"
    ? Math.max(1, Number($("m_defaultQty").value||1))
    : 1;

  if(!name) return alert("請輸入餐點名稱");
  if(isNaN(price) || price<0) return alert("價格不正確");

   const optionGroups = (draftGroups||[])
    .filter(g=> menuOptionGroupSelected.has(g.id))
    .map(g=> ({
    id: g.id,
    name: g.name,
    type: g.type,
    required: !!g.required,
    choices: (g.choices||[]).map(c=> ({ name:c.name, price:Number(c.price||0) }))
  }));

  // ✅ 套餐：把勾選的套餐 id 一起帶進餐點
  const setMealTemplateIds = Array.from(menuSetMealSelected);

  menuQueue.push({ category, name, content, price, defaultQty, optionGroups, setMealTemplateIds });

  // ✅ 只清空餐點欄位（保留選項群組）
  $("m_name").value = "";
  $("m_content").value = "";
  $("m_price").value = "";
  $("m_defaultQty").value = "1";
  $("m_qtyType").value = "normal";
  syncQtyMode(mainQtyType, mainQtyInput, mainQtyHint);
     
  // ✅ 清掉「本餐點勾選的套餐」，避免下一道沿用
  menuSetMealSelected = new Set();
  renderSetMealPickList();

  renderMenuQueue();
};

    ["m_name","m_content","m_price","m_defaultQty"].forEach(id=>{
      $(id).addEventListener("keydown",(e)=>{
        if(e.key==="Enter"){
          e.preventDefault();
          $("btnAddMenuToQueue").click();
        }
      });
    });

    $("btnClearAll").onclick = ()=>{
      $("r_category").value="";
      $("r_name").value=""; $("r_phone").value=""; $("r_addr").value="";
      $("r_map").value=""; $("r_note").value="";
      $("r_hours").value="";
      $("r_imgUrl").value=""; r_imgPrev.style.display="none";
      $("r_lineQrUrl").value=""; r_lineQrPrev.style.display="none";
      $("r_onlineOrderUrl").value="";
      $("r_visible").checked = true;
      $("r_closed").checked = false;
      clearWeeklyOffCreateForm();

      catGroups = [];
      if(catInput) catInput.value = "";
      renderCatGroups();

      // ✅【這一段是你要加的】
  setMealTemplates = [];
  activeSetMealDraft = null;
  menuSetMealSelected = new Set();
  showSetMealDraftUI(false);
  renderSetMealTemplates();
  renderSetMealPickList();
      
      menuQueue = [];
      $("btnClearMenu").click();
      renderMenuQueue();
    };

    $("btnSubmitAll").onclick = async ()=>{
  const name = $("r_name").value.trim();
  if(!name) return alert("請輸入餐廳名稱");
  statusPill.textContent = "新增餐廳中…";

  try{
   const setMealPayload = setMealTemplates.map(t=>({
        id: t.id,
        name: t.name,
        price: Number(t.price || 0),
        categories: Array.isArray(t.categories)
          ? t.categories.map(c=>({
              name: c.name,
              pickCount: Math.max(1, Number(c.pickCount || 1)),
              options: Array.isArray(c.options)
                ? c.options.map(o=>({
                    name: o.name,
                    addPrice: Number(o.addPrice || 0),
                    optionGroups: cloneOptionGroups(o?.optionGroups)
                  }))
                : []
            }))
          : []
      }));

      const restaurantRef = await addDoc(colRestaurants, {
        category: $("r_category").value.trim(),
        name,
        phone: $("r_phone").value.trim(),
        address: $("r_addr").value.trim(),
        mapUrl: $("r_map").value.trim(),
        note: $("r_note").value.trim(),
        businessHours: $("r_hours").value.trim(),
        weeklyOff: getWeeklyOffFromCreateForm(),
        imageUrl: $("r_imgUrl").value.trim(),
        lineQrUrl: $("r_lineQrUrl").value.trim(),
        onlineOrderUrl: $("r_onlineOrderUrl").value.trim(),
        isVisible: $("r_visible").checked,
        isClosed: $("r_closed").checked,
        setMealTemplates: setMealPayload,
        createdAt: Date.now()
      });

    if(menuQueue.length>0){
      statusPill.textContent = "新增餐點清單中…";
      const menuCol = collection(db, "restaurants", restaurantRef.id, "menu");

      for(const m of menuQueue){
        await addDoc(menuCol, {
          category: m.category,
          name: m.name,
          content: m.content || "",
          price: Number(m.price||0),
          defaultQty: Math.max(1, Number(m.defaultQty||1)),
          optionGroups: Array.isArray(m.optionGroups) ? m.optionGroups : [],
          // ✅ 套餐 id 一起寫入
          setMealTemplateIds: Array.isArray(m.setMealTemplateIds) ? m.setMealTemplateIds : [],
          createdAt: Date.now()
        });
      }
    }

    statusPill.textContent = "新增完成 ✅";
    alert(menuQueue.length>0 ? "餐廳 + 餐點已新增！" : "餐廳已新增！");
    $("btnClearAll").click();
    await refreshRestaurantsManage();

  }catch(err){
    console.error(err);
    alert("新增失敗\n\n" + (err?.message || err));
    statusPill.textContent = "新增失敗（看 console）";
  }
};

    /* ===== staff / restaurants / 班表 ===== */

    // 供班表/未點餐使用的全域人員快取
let allStaffBase = [];
let allStaffLoaded = false;

// ✅ 只抓一次 staff，並照「部門順序 + 新增順序」排好
async function loadAllStaffOnce(){
  if(allStaffLoaded && allStaffBase.length) return;

    const snap = await getDocs(colStaff);
  const arr = [];
  snap.forEach(d=>{
    const v = d.data() || {};
    arr.push({
      id: d.id,
      ...v
    });
  });

  // ✅ 依自訂部門順序 +「新增順序」（同部門內照你新增順序）
  arr.sort((a,b)=>{
  const da = (a.dept || "").trim();
  const db = (b.dept || "").trim();

  const ra = deptRank(da);
  const rb = deptRank(db);
  if(ra !== rb) return ra - rb;

  const oa = Number(a.order || 0);
  const ob = Number(b.order || 0);
  if(oa !== ob) return oa - ob;

  const ta = Number(a.createdAt || 0);
  const tb = Number(b.createdAt || 0);
  if(ta !== tb) return ta - tb;

  return (a.name || "").localeCompare((b.name || ""), "zh-Hant");
});

  allStaffBase = arr;
  allStaffLoaded = true;
}

  function getStaffShiftKeySet(shift){
  const set = new Set();
  allStaffBase.forEach(s=>{
    const dept = (s.dept || "").trim();
    const name = (s.name || "").trim();
    if(!dept && !name) return;
    const key = `${dept}||${name}`;
    if(shift === "morning" && s.shiftMorning) set.add(key);
    if(shift === "evening" && s.shiftEvening) set.add(key);
  });
  return set;
}

/* ✅ 人員清單：依指定部門順序（管理部→新場→…→教育訓練） */
async function refreshStaffList(){
  const wrap = $("staffWrap");
  wrap.innerHTML = `<div class="muted">載入中…</div>`;

  try{
    // 用共用的快取 + 排序
    await loadAllStaffOnce();
    const arr = allStaffBase;

    // 分組
    const map = new Map();
    for(const v of arr){
      const dept = (v.dept||"未分部門").trim();
      if(!map.has(dept)) map.set(dept, []);
      map.get(dept).push(v);
    }

    if(map.size===0){
      wrap.innerHTML = `<div class="muted">尚未新增人員</div>`;
      return;
    }

    // 依 DEPT_ORDER 輸出，未定義的排最後
    const orderedDepts = [
      ...DEPT_ORDER.filter(d => map.has(d)),
      ...Array.from(map.keys()).filter(d => !DEPT_INDEX.has(d))
    ];

    wrap.innerHTML = orderedDepts.map(dept=>{
      const list = map.get(dept) || [];
      return `
        <details style="border:1px solid rgba(15,23,42,.10); border-radius:16px; padding:10px 12px; margin-bottom:10px; background:#fff">
          <summary>${esc(dept)} <span class="tag" style="margin-left:8px">${list.length}人</span></summary>
          <div style="margin-top:10px">
            ${list.map(p=>`
              <div class="inline" style="justify-content:space-between; padding:8px 10px; border:1px solid rgba(15,23,42,.08); border-radius:14px; margin-top:8px;">
                <div><b>${esc(p.name||"")}</b></div>
                 <div class="shiftGroup">
                  <label class="shiftToggle">
                    <input type="checkbox" data-staff-id="${p.id}" data-staff-shift="morning" ${p.shiftMorning ? "checked" : ""}/>
                    <span>早班</span>
                  </label>
                  <label class="shiftToggle">
                    <input type="checkbox" data-staff-id="${p.id}" data-staff-shift="evening" ${p.shiftEvening ? "checked" : ""}/>
                    <span>晚班</span>
                  </label>
                  <button class="btnSmall btnDanger" data-delstaff="${p.id}" type="button">刪除</button>
                </div>
              </div>
            `).join("")}
          </div>
        </details>
      `;
    }).join("");

    // 刪除人員
    wrap.querySelectorAll("[data-delstaff]").forEach(b=>{
      b.onclick = async ()=>{
        if(!confirm("確定刪除該人員？")) return;
        try{
          await deleteDoc(doc(db,"staff", b.dataset.delstaff));
          // 讓快取失效，下次重抓
          allStaffLoaded = false;
          await refreshStaffList();
        }catch(err){
          console.error(err);
          alert("刪除人員失敗\n\n" + (err?.message || err));
        }
      };
    });

    // 班別勾選
    wrap.querySelectorAll("[data-staff-shift]").forEach(cb=>{
      cb.addEventListener("change", async ()=>{
        const staffId = cb.dataset.staffId;
        const shift = cb.dataset.staffShift;
        const field = shift === "morning" ? "shiftMorning" : "shiftEvening";
        const nextValue = cb.checked;
        try{
          await updateDoc(doc(db,"staff", staffId), {
            [field]: nextValue
          });
          const target = allStaffBase.find(s=>s.id === staffId);
          if(target) target[field] = nextValue;
          statusPill.textContent = "班別已更新 ✅";
        }catch(err){
          console.error(err);
          cb.checked = !nextValue;
          alert("更新班別失敗\n\n" + (err?.message || err));
        }
      });
    });

  }catch(err){
    console.error(err);
    wrap.innerHTML = `<div class="muted">載入失敗（看 console）</div>`;
  }
}

    $("btnAddStaff").onclick = async ()=>{
      const dept = $("s_dept").value.trim();
      const name = $("s_name").value.trim();
      if(!dept) return alert("請輸入部門");
      if(!name) return alert("請輸入人員名稱");
      try{
      await addDoc(colStaff, {
          dept,
          name,
          shiftMorning: false,
          shiftEvening: false,
          createdAt: Date.now()
        });
        $("s_name").value="";
        statusPill.textContent = "已新增人員 ✅";
        allStaffLoaded = false;          // 👈 讓快取下次重抓
        await refreshStaffList();
      }catch(err){
        console.error(err);
        alert("新增人員失敗\n\n" + (err?.message || err));
      }
    };
    $("btnClearStaff").onclick = ()=>{
      $("s_dept").value="";
      $("s_name").value="";
      statusPill.textContent = "已清空輸入";
    };
    $("s_name").addEventListener("keydown", (e)=>{
      if(e.key==="Enter"){
        e.preventDefault();
        $("btnAddStaff").click();
      }
    });

    /* ===============================
      ✅ 班表管理：當日休假人員勾選（依部門分段）
       =============================== */
    const scheduleMonthCache = new Map();
    const HOLIDAY_FIXED_DATES = [
      { month: 1, day: 1, name: "元旦" },
      { month: 2, day: 28, name: "和平紀念日" },
      { month: 4, day: 4, name: "兒童節" },
      { month: 4, day: 5, name: "清明節" },
      { month: 5, day: 1, name: "勞動節" },
      { month: 9, day: 28, name: "教師節" },
      { month: 10, day: 10, name: "國慶日" },
      { month: 10, day: 25, name: "台灣光復節" },
      { month: 12, day: 25, name: "行憲紀念日" }
    ];
      const HOLIDAYS_BY_YEAR = {
      // 如遇到政府公告補班/調整假日，可在這裡以西元日期補充或覆寫
      // 例如：{ date: "2027-02-05", name: "彈性放假" }
    };
    const LUNAR_MONTH_MAP = {
      正月: 1,
      二月: 2,
      三月: 3,
      四月: 4,
      五月: 5,
      六月: 6,
      七月: 7,
      八月: 8,
      九月: 9,
      十月: 10,
      十一月: 11,
      冬月: 11,
      十二月: 12,
      臘月: 12
    };
    const holidayMapCache = new Map();
    const lunarHolidayCache = new Map();
    const lunarFormatter = new Intl.DateTimeFormat("zh-Hant-u-ca-chinese", {
      month: "long",
      day: "numeric"
    });

    const formatDateKey = (date)=>
      `${date.getFullYear()}-${pad2(date.getMonth()+1)}-${pad2(date.getDate())}`;

    function getLunarHolidayMapByYear(year){
      if(lunarHolidayCache.has(year)) return lunarHolidayCache.get(year);
      const map = new Map();
      try{
        const start = new Date(year, 0, 1);
        const end = new Date(year, 11, 31);
        let newYearDate = null;
        for(let d = new Date(start); d <= end; d.setDate(d.getDate() + 1)){
          const parts = lunarFormatter.formatToParts(d);
          const monthLabel = parts.find(p=>p.type==="month")?.value;
          const dayLabel = parts.find(p=>p.type==="day")?.value;
          if(!monthLabel || !dayLabel) continue;
          if(monthLabel.includes("閏")) continue;
          const month = LUNAR_MONTH_MAP[monthLabel];
          const day = Number(dayLabel);
          if(!month || Number.isNaN(day)) continue;
          if(month === 1 && day === 1) newYearDate = new Date(d);
          if(month === 1 && day <= 4) map.set(formatDateKey(d), "春節");
          if(month === 5 && day === 5) map.set(formatDateKey(d), "端午節");
          if(month === 8 && day === 15) map.set(formatDateKey(d), "中秋節");
        }
        if(newYearDate){
          const eve = new Date(newYearDate);
          eve.setDate(eve.getDate() - 1);
          if(eve.getFullYear() === year){
            map.set(formatDateKey(eve), "除夕");
          }
          const smallEve = new Date(newYearDate);
          smallEve.setDate(smallEve.getDate() - 2);
          if(smallEve.getFullYear() === year){
            map.set(formatDateKey(smallEve), "小年夜");
          }
        }
      }catch(err){
        console.warn("無法解析農曆假日，僅顯示固定國定假日。", err);
      }
      lunarHolidayCache.set(year, map);
      return map;
    }
    function getHolidayMapByYear(year){
      if(holidayMapCache.has(year)) return holidayMapCache.get(year);
      const map = new Map();
      HOLIDAY_FIXED_DATES.forEach(item=>{
        const date = `${year}-${pad2(item.month)}-${pad2(item.day)}`;
        map.set(date, item.name);
      });
      const lunarMap = getLunarHolidayMapByYear(year);
      lunarMap.forEach((name, date)=> map.set(date, name));
      const yearSpecific = HOLIDAYS_BY_YEAR[year] || [];
      yearSpecific.forEach(item=> map.set(item.date, item.name));
      holidayMapCache.set(year, map);
      return map;
    }
    const WORKDAY_COLOR = {
      bg: "rgba(16,185,129,.22)",
      border: "rgba(16,185,129,.6)",
      text: "#047857",
      shadow: "rgba(16,185,129,.22)"
    };

      function getStaffCalendarColors(){
      return WORKDAY_COLOR;
    }
    
    function buildScheduleSelects(){
      const yearSel = $("sch_year");
      const monthSel = $("sch_month");
      const daySel = $("sch_day");
      if(!yearSel || !monthSel || !daySel) return;

      const now = new Date();
      const yearStart = now.getFullYear() - 1;
      const yearEnd = now.getFullYear() + 2;

      yearSel.innerHTML = "";
      for(let y = yearStart; y <= yearEnd; y++){
        const opt = document.createElement("option");
        opt.value = String(y);
        opt.textContent = `${y}年`;
        yearSel.appendChild(opt);
      }

      monthSel.innerHTML = "";
      for(let m = 1; m <= 12; m++){
        const opt = document.createElement("option");
        opt.value = pad2(m);
        opt.textContent = `${m}月`;
        monthSel.appendChild(opt);
      }

      yearSel.value = String(now.getFullYear());
      monthSel.value = pad2(now.getMonth() + 1);
      syncScheduleDayOptions();
      daySel.value = pad2(now.getDate());
    }

    function syncScheduleDayOptions(){
      const year = Number($("sch_year")?.value);
      const month = Number($("sch_month")?.value);
      const daySel = $("sch_day");
      if(!year || !month || !daySel) return;

      const days = new Date(year, month, 0).getDate();
      const current = Number(daySel.value) || 1;
      daySel.innerHTML = "";
      for(let d = 1; d <= days; d++){
        const opt = document.createElement("option");
        opt.value = pad2(d);
        opt.textContent = `${d}日`;
        daySel.appendChild(opt);
      }
        daySel.value = pad2(Math.min(current, days));
    }

    function getSelectedScheduleDate(){
      const y = $("sch_year")?.value;
      const m = $("sch_month")?.value;
      const d = $("sch_day")?.value;
      if(!y || !m || !d) return "";
      return `${y}-${m}-${d}`;
    }

       function getSelectedScheduleMonth(){
      const y = $("sch_year")?.value;
      const m = $("sch_month")?.value;
      if(!y || !m) return "";
      return `${y}-${m}`;
    }

    function getSelectedScheduleWorkerKey(){
      const dept = ($("sch_dept")?.value || "").trim();
      const name = ($("sch_staff")?.value || "").trim();
      if(!dept || !name) return "";
      return `${dept}||${name}`;
    }

    async function loadScheduleKeysForDate(dateStr){
      const snap = await getDoc(doc(db,"schedules", dateStr));
      if(!snap.exists()) return [];
      const data = snap.data() || {};
      return Array.isArray(data.workerKeys) ? data.workerKeys : [];
    }

     function updateScheduleMonthCache(dateStr, workerKeys){
      const monthStr = dateStr.slice(0,7);
      if(!scheduleMonthCache.has(monthStr)) return;
      const entry = scheduleMonthCache.get(monthStr);
      entry.set(dateStr, workerKeys);
    }

     async function loadScheduleMapForMonth(monthStr){
      if(scheduleMonthCache.has(monthStr)) return scheduleMonthCache.get(monthStr);
      const map = new Map();
      const snap = await getDocs(query(colSchedules, where("month","==", monthStr)));
      snap.forEach(docSnap=>{
        const data = docSnap.data() || {};
        const date = data.date || docSnap.id;
        const keys = Array.isArray(data.workerKeys) ? data.workerKeys : [];
        map.set(date, keys);
      });
      scheduleMonthCache.set(monthStr, map);
      return map;
    }

    async function renderScheduleMonthCalendar(){
      const wrap = $("scheduleMonthWrap");
      if(!wrap) return;
      const monthStr = getSelectedScheduleMonth();
      const workerKey = getSelectedScheduleWorkerKey();
      if(!monthStr){
        wrap.innerHTML = `<div class="muted">請先選擇年月。</div>`;
        return;
      }
      if(!workerKey){
        wrap.innerHTML = `<div class="muted">請先選擇部門與人員。</div>`;
        return;
      }
      wrap.innerHTML = `<div class="muted">載入中…</div>`;

      try{
        const map = await loadScheduleMapForMonth(monthStr);
        const [yy, mm] = monthStr.split("-").map(Number);
        const daysInMonth = new Date(yy, mm, 0).getDate();
        const firstDay = new Date(yy, mm-1, 1).getDay();
        const weekdayLabels = WEEKDAY_LABEL.map((l, idx)=>
          `<div class="schCalWeekday ${idx===0 || idx===6 ? "is-weekend" : ""}">${l}</div>`
        ).join("");
        let selectedCount = 0;
        const staffColors = getStaffCalendarColors(workerKey);
        
        const cells = [];
        for(let i=0; i<firstDay; i++){
          cells.push(`<div class="schCalCell is-empty"></div>`);
        }
        for(let d=1; d<=daysInMonth; d++){
          const dateStr = `${yy}-${pad2(mm)}-${pad2(d)}`;
          const keys = map.get(dateStr) || [];
          const isSelected = keys.includes(workerKey);
          const holidayName = getHolidayMapByYear(yy).get(dateStr);
          const dayIndex = (firstDay + d - 1) % 7;
          const isWeekend = dayIndex === 0 || dayIndex === 6;
          if(isSelected) selectedCount += 1;
          cells.push(`
            <button class="schCalCell ${isSelected ? "is-selected" : ""} ${holidayName ? "is-holiday" : ""} ${isWeekend ? "is-weekend" : ""}" type="button"
              data-schcal-date="${dateStr}" aria-pressed="${isSelected ? "true" : "false"}"
              ${holidayName ? `title="${esc(holidayName)}（國定假日）"` : ""}>
              <span>${d}</span>
              ${holidayName ? `<span class="schHolidayDot" aria-hidden="true"></span>` : ""}
            </button>
          `);
        }

        const [deptLabel, nameLabel] = workerKey.split("||");
        wrap.innerHTML = `
           <div class="schMonthPanel" style="--staff-bg:${staffColors.bg}; --staff-border:${staffColors.border}; --staff-text:${staffColors.text}; --staff-shadow:${staffColors.shadow};">
            <div class="schMonthHeader">
              <span>${yy}年 ${mm}月（${esc(deptLabel)} - ${esc(nameLabel)}）</span>
              <span class="tag miniTag">已選 ${selectedCount} 天</span>
            </div>
            <div class="schMonthMeta">點選日期可切換該人員是否休假（未勾選日期視為上班日）。</div>
             <div class="schLegend">
              <span class="schLegendItem" style="color:${staffColors.text}; --legend-bg:${staffColors.bg};">
                <span class="schLegendColor"></span>
              休假日
              </span>
              <span class="schLegendItem" style="color:#b45309; --legend-bg:rgba(254,243,199,.9);">
                <span class="schLegendColor"></span>
                國定假日
              </span>
            </div>
            <div class="schCalendarGrid" style="margin-top:10px">
              ${weekdayLabels}
              ${cells.join("")}
            </div>
          </div>
        `;

        const countTag = wrap.querySelector(".schMonthHeader .miniTag");
        wrap.querySelectorAll("[data-schcal-date]").forEach(btn=>{
          btn.addEventListener("click", async ()=>{
            const dateStr = btn.dataset.schcalDate;
            const monthMap = scheduleMonthCache.get(monthStr) || new Map();
            const keys = monthMap.get(dateStr) ? [...monthMap.get(dateStr)] : [];
            const exists = keys.includes(workerKey);
            const next = !exists;
            const nextKeys = next ? [...keys, workerKey] : keys.filter(k=>k!==workerKey);
            btn.classList.toggle("is-selected", next);
            btn.setAttribute("aria-pressed", next ? "true" : "false");
            if(countTag){
              const current = Number(countTag.textContent.replace(/[^\d]/g,"")) || 0;
              const nextCount = Math.max(0, current + (next ? 1 : -1));
              countTag.textContent = `已選 ${nextCount} 天`;
            }
            monthMap.set(dateStr, nextKeys);
            scheduleMonthCache.set(monthStr, monthMap);
            await setDoc(doc(db,"schedules", dateStr), {
              date: dateStr,
              month: monthStr,
              workerKeys: nextKeys,
              updatedAt: Date.now()
            }, { merge:true });
            statusPill.textContent = "班表已儲存 ✅";
          });
        });
      }catch(err){
        console.error(err);
        wrap.innerHTML = `<div class="muted">班表載入失敗<br/>${esc(err?.message || err)}</div>`;
      }
    }

    function getSelectedScheduleShift(){
      const shift = ($("sch_shift")?.value || "").trim();
      if(shift === "morning" || shift === "evening") return shift;
      return "";
    }

    function filterScheduleStaffByShift(list){
      const shift = getSelectedScheduleShift();
      if(!shift) return list;
      return list.filter(s=> shift === "morning" ? s.shiftMorning : s.shiftEvening);
    }

    function buildScheduleDeptOptions(){
      const deptSel = $("sch_dept");
      if(!deptSel) return;
      const prevValue = deptSel.value || "";
      const deptMap = new Map();
      filterScheduleStaffByShift(allStaffBase).forEach(s=>{
        const dept = (s.dept||"未分部門").trim() || "未分部門";
        if(!deptMap.has(dept)) deptMap.set(dept, []);
        deptMap.get(dept).push(s);
      });
      const orderedDepts = [
        ...DEPT_ORDER.filter(d=>deptMap.has(d)),
        ...Array.from(deptMap.keys()).filter(d=>!DEPT_INDEX.has(d))
      ];
      deptSel.innerHTML = `
        <option value="">請選部門</option>
        ${orderedDepts.map(d=>`<option value="${esc(d)}">${esc(d)}</option>`).join("")}
      `;
      if(orderedDepts.includes(prevValue)) deptSel.value = prevValue;
    }

    function buildScheduleStaffOptions(){
      const deptSel = $("sch_dept");
      const staffSel = $("sch_staff");
      if(!deptSel || !staffSel) return;
      const dept = (deptSel.value || "").trim();
      const prevValue = staffSel.value || "";
      const list = filterScheduleStaffByShift(allStaffBase).filter(s=>{
          const d = (s.dept||"未分部門").trim() || "未分部門";
          return dept && d === dept;
        });
      staffSel.innerHTML = `
        <option value="">請選人員</option>
        ${list.map(s=>`<option value="${esc(s.name||"")}">${esc(s.name||"")}</option>`).join("")}
      `;
      if(list.some(s=>s.name === prevValue)) staffSel.value = prevValue;
    }

    async function initSchedulePeopleSelectors(){
      await loadAllStaffOnce();
      buildScheduleDeptOptions();
      buildScheduleStaffOptions();
      renderScheduleMonthCalendar();
    }

      async function renderScheduleDate(){
      const wrap = $("scheduleWrap");
      if(!wrap) return;
    const dateStr = getSelectedScheduleDate();
      if(!dateStr){
        wrap.innerHTML = `<div class="muted">請先選擇日期</div>`;
        return;
      }

      wrap.innerHTML = `<div class="muted">載入中…</div>`;

      try{
        await loadAllStaffOnce();
        if(allStaffBase.length===0){
          wrap.innerHTML = `<div class="muted">尚未新增任何人員，無法建立班表。</div>`;
          return;
        }

        const workerKeys = await loadScheduleKeysForDate(dateStr);
        const workerSet = new Set(workerKeys);

        const [yy, mm, dd] = dateStr.split("-").map(Number);
        const weekday = WEEKDAY_LABEL[new Date(yy, mm-1, dd).getDay()];

        // 人員依部門分組
        const deptMap = new Map();
        for(const s of allStaffBase){
          const dept = (s.dept||"未分部門").trim() || "未分部門";
          if(!deptMap.has(dept)) deptMap.set(dept, []);
          deptMap.get(dept).push(s);
        }
        const orderedDepts = [
          ...DEPT_ORDER.filter(d=>deptMap.has(d)),
          ...Array.from(deptMap.keys()).filter(d=>!DEPT_INDEX.has(d))
        ];

         let totalWorking = 0;
          const deptHtml = orderedDepts.map(dept=>{
          const list = deptMap.get(dept) || [];
          const people = list.filter(p=>{
            const key = `${(p.dept||"").trim()}||${(p.name||"").trim()}`;
              return !workerSet.has(key);
          });
          totalWorking += people.length;
          const peopleHtml = people.map(p=>`
            <span class="tag" style="border-style:dashed;">${esc(p.name||"")}</span>
          `).join("") || `<div class="muted mini">（本部門當日無上班人員）</div>`;

          return `
            <div class="schDeptBlock">
              <div class="schDeptTitle">${esc(dept)}</div>
              <div class="schStaffGrid">${peopleHtml}</div>
            </div>
         `;
        }).join("");

           wrap.innerHTML = `
          <div class="schDayBlock">
            <div class="schDaySummary">
              <span>${mm}/${dd}（${weekday}）</span>
             <span class="tag miniTag">上班 ${totalWorking} 人</span>
            </div>
            <div class="schDayInner" data-sch-day="${dateStr}">
              ${deptHtml}
            </div>
          </div>
        `;;

      }catch(err){
        console.error(err);
        wrap.innerHTML = `<div class="muted">班表載入失敗<br/>${esc(err?.message || err)}</div>`;
      }
    }

     $("sch_year")?.addEventListener("change", ()=>{
      syncScheduleDayOptions();
      renderScheduleDate();
      renderScheduleMonthCalendar();
    });

    $("sch_month")?.addEventListener("change", ()=>{
      syncScheduleDayOptions();
      renderScheduleDate();
      renderScheduleMonthCalendar();
    });

    $("sch_day")?.addEventListener("change", ()=>{
      renderScheduleDate();
    });

     $("sch_shift")?.addEventListener("change", ()=>{
      buildScheduleDeptOptions();
      buildScheduleStaffOptions();
      renderScheduleMonthCalendar();
    });

    $("sch_dept")?.addEventListener("change", ()=>{
      buildScheduleStaffOptions();
      renderScheduleMonthCalendar();
    });

    $("sch_staff")?.addEventListener("change", ()=>{
      renderScheduleMonthCalendar();
    });

    $("btnLoadSchedule")?.addEventListener("click", ()=>{
    renderScheduleDate();
    });

    $("btnScheduleToday")?.addEventListener("click", ()=>{
      const today = todayISO();
       const [yy, mm, dd] = today.split("-");
      const ySel = $("sch_year");
      const mSel = $("sch_month");
      const dSel = $("sch_day");
      if(ySel) ySel.value = yy;
      if(mSel) mSel.value = mm;
      syncScheduleDayOptions();
      if(dSel) dSel.value = dd;
      renderScheduleDate();
    });

    /* ===============================
       ✅ 餐廳管理：搜尋 Enter 才展開定位（分類收合也找得到）
       =============================== */
    function openRestaurantByKeyword(keyword){
      const kw = (keyword||"").trim().toLowerCase();
      if(!kw) return false;

      const wrap = $("restaurantsWrap");
      if(!wrap) return false;

      const allDetails = Array.from(wrap.querySelectorAll(`details`)).filter(d=>{
        const s = d.querySelector("summary");
        return s && (s.textContent||"").trim();
      });

      const hit = allDetails.find(d=>{
        const t = (d.querySelector("summary")?.textContent || "").toLowerCase();
        return t.includes(kw);
      });

      if(!hit) return false;

      hit.open = true;
      let p = hit.parentElement;
      while(p){
        if(p.tagName === "DETAILS") p.open = true;
        p = p.parentElement;
      }

      hit.scrollIntoView({ behavior:"smooth", block:"start" });
      return true;
    }

    $("restSearchOpen")?.addEventListener("keydown", (e)=>{
      if(e.key==="Enter"){
        e.preventDefault();
        const v = $("restSearchOpen").value;
        const ok = openRestaurantByKeyword(v);
        if(!ok) alert("找不到符合的餐廳（可能尚未載入或關鍵字不符）");
      }
    });

    $("btnRestSearchClear")?.addEventListener("click", ()=>{
      const inp = $("restSearchOpen");
      if(inp) inp.value = "";
    });

   // 讀取某餐廳的所有餐點
async function loadMenusOfRestaurant(rid){
  try{
    const menuCol = collection(db, "restaurants", rid, "menu");
    const snap = await getDocs(query(menuCol, limit(2500)));

    const list = [];
    snap.forEach(d => {
      list.push({
        id: d.id,
        ...(d.data() || {})
      });
    });

    // 排序：order → createdAt → category → name
    list.sort((a,b)=>{
      const ao = Number(a.order || 0);
      const bo = Number(b.order || 0);
      if (ao !== bo) return ao - bo;

      const aa = Number(a.createdAt || 0);
      const bb = Number(b.createdAt || 0);
      if (aa !== bb) return aa - bb;

      const ca = (a.category || "").localeCompare((b.category || ""),"zh-Hant");
      if (ca !== 0) return ca;

      return (a.name || "").localeCompare((b.name || ""),"zh-Hant");
    });

    return list;
  }catch(err){
    console.error(err);
    return null;
  }
}

      function setMealTemplatesSummary(templateIds, templates){
      const ids = Array.isArray(templateIds)
        ? templateIds.map(id=> String(id || "").trim()).filter(Boolean)
        : [];
      if(ids.length===0) return "—";
     const pool = Array.isArray(templates) && templates.length ? templates : setMealTemplates;
      if(!Array.isArray(pool) || pool.length===0) return "—";
      const names = pool
        .filter(t => ids.includes(String(t.id || "").trim()))
        .map(t => t.name)
        .filter(Boolean);
      return names.length ? names.join("、") : "—";
    }

  function optionGroupsSummary(groups){
      const gs = (Array.isArray(groups) ? groups : []).filter(g => g?.enabled !== false);
      if(gs.length===0) return "—";
      return gs.map(g=>{
        const t = g.type==="single" ? "擇一" : "加購";
        const req = (g.type==="single" && g.required) ? "必選" : "";
        const c = (g.choices||[]).map(x=> `${x.name}${Number(x.price||0)?`(+${Number(x.price||0)})`:``}`).join("、");
        return `${g.name}(${t}${req?`/${req}`:""}): ${c}`;
      }).join("｜");
    }
    
function normalizeSetMealIds(ids){
  return Array.isArray(ids)
    ? ids.map(id=> String(id || "").trim()).filter(Boolean)
    : [];
}

function renderMenuSetMealEditor(rid, mid, templates, container){
  if(!container) return;
  const key = `${rid}__${mid}`;
  const selected = menuSetMealCache.get(key) || new Set();
  const list = Array.isArray(templates) ? templates : [];

  let html = `
    <div class="muted mini" style="margin-bottom:6px">
      在此可勾選此餐點支援的「套餐群組」，完成後請按上方「儲存」該餐點。
    </div>
  `;

  if(list.length === 0){
    html += `<div class="muted mini">（此餐廳尚未建立套餐模板）</div>`;
    container.innerHTML = html;
    return;
  }

  html += `
    <div class="kpi">
      ${list.map(t=>{
        const checked = selected.has(String(t.id || "").trim()) ? "checked" : "";
        return `
          <label class="tag" style="cursor:pointer">
            <input type="checkbox" data-setmeal-pick="${esc(t.id)}"
                   style="width:16px; height:16px; margin:0;" ${checked}>
            ${esc(t.name)} <span class="muted mini">(${Number(t.price||0)})</span>
          </label>
        `;
      }).join("")}
    </div>
  `;

  container.innerHTML = html;

  container.querySelectorAll("[data-setmeal-pick]").forEach(ch=>{
    ch.onchange = ()=>{
      const id = String(ch.dataset.setmealPick || "").trim();
      ch.checked ? selected.add(id) : selected.delete(id);
      menuSetMealCache.set(key, selected);
    };
  });
}
// ✅ 餐廳管理：每道餐點 inline 編輯 optionGroups 用
function renderMenuOptionEditor(rid, mid, container){
  if(!container) return;

  const key = `${rid}__${mid}`;
  let groups = menuOptionCache.get(key) || [];
  // 正規化一下，避免舊資料缺欄位
  groups = cloneOptionGroups(groups);
  menuOptionCache.set(key, groups);

  let html = `
    <div class="muted mini" style="margin-bottom:6px">
      在此可直接設定「擇一 / 加購」選項群組（不會跳視窗）。<br/>
      ✏ 編輯完成後記得按上方「儲存」該餐點，才會寫回 Firestore。
    </div>
    <div class="actions" style="margin:4px 0 10px; justify-content:flex-start;">
      <button class="btnSmall btnOk" type="button" data-role="add-group">新增群組</button>
    </div>
  `;

  if(groups.length===0){
    html += `<div class="muted mini">目前沒有任何選項群組。</div>`;
  }else{
    html += groups.map((g,gi)=>{
      const choices = Array.isArray(g.choices) ? g.choices : [];
      const rows = choices.length
        ? choices.map((c,ci)=>`
            <tr data-ci="${ci}">
              <td><input data-role="c-name" value="${esc(c.name||"")}"></td>
              <td><input data-role="c-price" type="number" min="0" value="${Number(c.price||0)}"></td>
              <td style="width:1%; white-space:nowrap;">
                <button class="btnSmall btnDanger" type="button" data-role="del-choice">刪除</button>
              </td>
            </tr>
          `).join("")
        : `<tr><td colspan="3" class="muted mini">尚未加入任何選項</td></tr>`;

      return `
        <div class="optBox" data-gi="${gi}" style="margin-bottom:10px;">
          <div class="row3">
            <div>
              <label>群組名稱
                <input data-role="g-name" value="${esc(g.name||"")}">
              </label>
            </div>
            <div>
              <label>類型
                <select data-role="g-type">
                  <option value="single" ${g.type==="addon"?"":"selected"}>擇一（下拉）</option>
                  <option value="addon" ${g.type==="addon"?"selected":""}>加購（多選）</option>
                </select>
              </label>
            </div>
            <div style="display:flex; align-items:flex-end; gap:10px;">
              <label style="margin:0; display:flex; align-items:center; gap:6px;">
                <input type="checkbox" data-role="g-required"
                  style="width:18px; height:18px;" ${(g.type==="single" && g.required) ? "checked":""}>
                必選（擇一用）
              </label>
              <button class="btnSmall btnDanger" type="button" data-role="del-group">刪除此群組</button>
            </div>
          </div>

          <div class="hr"></div>

          <table style="width:100%; border-collapse:collapse; font-size:12.5px;">
            <thead>
              <tr>
                <th>選項名稱</th>
                <th>加價</th>
                <th style="width:1%;">操作</th>
              </tr>
            </thead>
            <tbody>
              ${rows}
              <tr>
                <td><input data-role="new-c-name" placeholder="例：豬肉 / 加麵"></td>
                <td><input data-role="new-c-price" type="number" min="0" placeholder="0"></td>
                <td>
                  <button class="btnSmall btnOk" type="button" data-role="add-choice">新增選項</button>
                </td>
              </tr>
            </tbody>
          </table>
        </div>
      `;
    }).join("");
  }

  container.innerHTML = html;

  // ➕ 新增群組
  const addGroupBtn = container.querySelector('[data-role="add-group"]');
  if(addGroupBtn){
    addGroupBtn.onclick = ()=>{
      groups.push({ name:"", type:"single", required:true, choices:[] });
      menuOptionCache.set(key, groups);
      renderMenuOptionEditor(rid, mid, container);
    };
  }

  // 綁定每個群組內的事件
  container.querySelectorAll(".optBox").forEach(box=>{
    const gi = Number(box.dataset.gi);
    const g = groups[gi];
    if(!g) return;

    const nameInp = box.querySelector('[data-role="g-name"]');
    if(nameInp){
      nameInp.addEventListener("input", e=>{
        g.name = e.target.value;
        menuOptionCache.set(key, groups);
      });
    }

    const typeSel = box.querySelector('[data-role="g-type"]');
    if(typeSel){
      typeSel.addEventListener("change", e=>{
        const v = e.target.value === "addon" ? "addon" : "single";
        g.type = v;
        if(v !== "single") g.required = false;
        menuOptionCache.set(key, groups);
        renderMenuOptionEditor(rid, mid, container);
      });
    }

    const reqChk = box.querySelector('[data-role="g-required"]');
    if(reqChk){
      reqChk.addEventListener("change", e=>{
        g.required = !!e.target.checked;
        menuOptionCache.set(key, groups);
      });
    }

    const delGroupBtn = box.querySelector('[data-role="del-group"]');
    if(delGroupBtn){
      delGroupBtn.onclick = ()=>{
        groups.splice(gi,1);
        menuOptionCache.set(key, groups);
        renderMenuOptionEditor(rid, mid, container);
      };
    }

    // 既有選項
    box.querySelectorAll("tr[data-ci]").forEach(row=>{
      const ci = Number(row.dataset.ci);
      const c = g.choices[ci];
      if(!c) return;

      const nInp = row.querySelector('[data-role="c-name"]');
      const pInp = row.querySelector('[data-role="c-price"]');
      const delBtn = row.querySelector('[data-role="del-choice"]');

      if(nInp){
        nInp.addEventListener("input", e=>{
          c.name = e.target.value;
          menuOptionCache.set(key, groups);
        });
      }
      if(pInp){
        pInp.addEventListener("input", e=>{
          let v = Number(e.target.value || 0);
          if(isNaN(v) || v < 0) v = 0;
          c.price = v;
          menuOptionCache.set(key, groups);
        });
      }
      if(delBtn){
        delBtn.addEventListener("click", ()=>{
          g.choices.splice(ci,1);
          menuOptionCache.set(key, groups);
          renderMenuOptionEditor(rid, mid, container);
        });
      }
    });

    // 新增選項
    const newName = box.querySelector('[data-role="new-c-name"]');
    const newPrice = box.querySelector('[data-role="new-c-price"]');
    const addChoiceBtn = box.querySelector('[data-role="add-choice"]');

    if(addChoiceBtn){
      const submitNew = ()=>{
        const name = (newName?.value || "").trim();
        const price = Number(newPrice?.value || 0);
        if(!name) return alert("請輸入選項名稱");
        if(isNaN(price) || price < 0) return alert("加價需為 0 或正數");
        if(!Array.isArray(g.choices)) g.choices = [];
        g.choices.push({ name, price });
        menuOptionCache.set(key, groups);
        renderMenuOptionEditor(rid, mid, container);
      };
      addChoiceBtn.addEventListener("click", submitNew);
      newName?.addEventListener("keydown", e=>{ if(e.key==="Enter"){ e.preventDefault(); submitNew(); }});
      newPrice?.addEventListener("keydown", e=>{ if(e.key==="Enter"){ e.preventDefault(); submitNew(); }});
    }
  });
}

    // ✅ 餐廳管理：新增餐點用的 optionGroups 編輯
function renderAddMenuOptionEditor(rid, container){
  if(!container) return;
  let groups = cloneOptionGroups(getAddMenuOptionGroups(rid));
  addMenuOptionCache.set(rid, groups);

  let html = `
    <div class="actions" style="margin:4px 0 10px; justify-content:flex-start;">
      <button class="btnSmall btnOk" type="button" data-role="add-group">新增群組</button>
    </div>
  `;

  if(groups.length===0){
    html += `<div class="muted mini">目前沒有任何選項群組。</div>`;
  }else{
    html += groups.map((g,gi)=>{
      const choices = Array.isArray(g.choices) ? g.choices : [];
      const rows = choices.length
        ? choices.map((c,ci)=>`
            <tr data-ci="${ci}">
              <td><input data-role="c-name" value="${esc(c.name||"")}"></td>
              <td><input data-role="c-price" type="number" min="0" value="${Number(c.price||0)}"></td>
              <td style="width:1%; white-space:nowrap;">
                <button class="btnSmall btnDanger" type="button" data-role="del-choice">刪除</button>
              </td>
            </tr>
          `).join("")
        : `<tr><td colspan="3" class="muted mini">尚未加入任何選項</td></tr>`;

      return `
        <div class="optBox" data-gi="${gi}" style="margin-bottom:10px;">
          <div class="row3">
            <div>
              <label>群組名稱
                <input data-role="g-name" value="${esc(g.name||"")}">
              </label>
            </div>
            <div>
              <label>類型
                <select data-role="g-type">
                  <option value="single" ${g.type==="addon"?"":"selected"}>擇一（下拉）</option>
                  <option value="addon" ${g.type==="addon"?"selected":""}>加購（多選）</option>
                </select>
              </label>
            </div>
            <div style="display:flex; align-items:flex-end; gap:10px;">
              <label style="margin:0; display:flex; align-items:center; gap:6px;">
                <input type="checkbox" data-role="g-required"
                  style="width:18px; height:18px;" ${(g.type==="single" && g.required) ? "checked":""}>
                必選（擇一用）
              </label>
              <button class="btnSmall btnDanger" type="button" data-role="del-group">刪除此群組</button>
            </div>
          </div>

          <div class="hr"></div>

          <table style="width:100%; border-collapse:collapse; font-size:12.5px;">
            <thead>
              <tr>
                <th>選項名稱</th>
                <th>加價</th>
                <th style="width:1%;">操作</th>
              </tr>
            </thead>
            <tbody>
              ${rows}
              <tr>
                <td><input data-role="new-c-name" placeholder="例：豬肉 / 加麵"></td>
                <td><input data-role="new-c-price" type="number" min="0" placeholder="0"></td>
                <td>
                  <button class="btnSmall btnOk" type="button" data-role="add-choice">新增選項</button>
                </td>
              </tr>
            </tbody>
          </table>
        </div>
      `;
    }).join("");
  }

  container.innerHTML = html;

  const addGroupBtn = container.querySelector('[data-role="add-group"]');
  if(addGroupBtn){
    addGroupBtn.onclick = ()=>{
      groups.push({ name:"", type:"single", required:true, choices:[] });
      addMenuOptionCache.set(rid, groups);
      renderAddMenuOptionEditor(rid, container);
    };
  }

  container.querySelectorAll(".optBox").forEach(box=>{
    const gi = Number(box.dataset.gi);
    const g = groups[gi];
    if(!g) return;

    const nameInp = box.querySelector('[data-role="g-name"]');
    if(nameInp){
      nameInp.addEventListener("input", e=>{
        g.name = e.target.value;
        addMenuOptionCache.set(rid, groups);
      });
    }

    const typeSel = box.querySelector('[data-role="g-type"]');
    if(typeSel){
      typeSel.addEventListener("change", e=>{
        const v = e.target.value === "addon" ? "addon" : "single";
        g.type = v;
        if(v !== "single") g.required = false;
        addMenuOptionCache.set(rid, groups);
        renderAddMenuOptionEditor(rid, container);
      });
    }

    const reqChk = box.querySelector('[data-role="g-required"]');
    if(reqChk){
      reqChk.addEventListener("change", e=>{
        g.required = !!e.target.checked;
        addMenuOptionCache.set(rid, groups);
      });
    }

    const delGroupBtn = box.querySelector('[data-role="del-group"]');
    if(delGroupBtn){
      delGroupBtn.onclick = ()=>{
        groups.splice(gi,1);
        addMenuOptionCache.set(rid, groups);
        renderAddMenuOptionEditor(rid, container);
      };
    }

    box.querySelectorAll("tr[data-ci]").forEach(row=>{
      const ci = Number(row.dataset.ci);
      const c = g.choices[ci];
      if(!c) return;

      const nInp = row.querySelector('[data-role="c-name"]');
      const pInp = row.querySelector('[data-role="c-price"]');
      const delBtn = row.querySelector('[data-role="del-choice"]');

      if(nInp){
        nInp.addEventListener("input", e=>{
          c.name = e.target.value;
          addMenuOptionCache.set(rid, groups);
        });
      }
      if(pInp){
        pInp.addEventListener("input", e=>{
          let v = Number(e.target.value || 0);
          if(isNaN(v) || v < 0) v = 0;
          c.price = v;
          addMenuOptionCache.set(rid, groups);
        });
      }
      if(delBtn){
        delBtn.addEventListener("click", ()=>{
          g.choices.splice(ci,1);
          addMenuOptionCache.set(rid, groups);
          renderAddMenuOptionEditor(rid, container);
        });
      }
    });

    const newName = box.querySelector('[data-role="new-c-name"]');
    const newPrice = box.querySelector('[data-role="new-c-price"]');
    const addChoiceBtn = box.querySelector('[data-role="add-choice"]');

    if(addChoiceBtn){
      const submitNew = ()=>{
        const name = (newName?.value || "").trim();
        const price = Number(newPrice?.value || 0);
        if(!name) return alert("請輸入選項名稱");
        if(isNaN(price) || price < 0) return alert("加價需為 0 或正數");
        if(!Array.isArray(g.choices)) g.choices = [];
        g.choices.push({ name, price });
        addMenuOptionCache.set(rid, groups);
        renderAddMenuOptionEditor(rid, container);
      };
      addChoiceBtn.addEventListener("click", submitNew);
      newName?.addEventListener("keydown", e=>{ if(e.key==="Enter"){ e.preventDefault(); submitNew(); }});
      newPrice?.addEventListener("keydown", e=>{ if(e.key==="Enter"){ e.preventDefault(); submitNew(); }});
    }
  });
}

function renderAddMenuSetMealPickList(rid, templates, container){
  if(!container) return;
  const selected = getAddMenuSetMealSelected(rid);
  const list = Array.isArray(templates) ? templates : [];

  if(list.length === 0){
    container.innerHTML = `<div class="muted mini">（此餐廳尚未建立套餐模板）</div>`;
    return;
  }

  container.innerHTML = list.map(t=>{
    const checked = selected.has(t.id) ? "checked" : "";
    return `
      <label class="tag" style="cursor:pointer">
        <input type="checkbox" data-add-sm-pick="${esc(t.id)}"
               style="width:16px; height:16px; margin:0;" ${checked}>
        ${esc(t.name)} <span class="muted mini">(${Number(t.price||0)})</span>
      </label>
    `;
  }).join("");

  container.querySelectorAll("[data-add-sm-pick]").forEach(ch=>{
    ch.onchange = ()=>{
      const id = ch.dataset.addSmPick;
      ch.checked ? selected.add(id) : selected.delete(id);
      addMenuSetMealSelected.set(rid, selected);
    };
  });
}

    function renderAddMenuSetMealTemplates(rid, templates, container, pickListEl){
  if(!container) return;
  if(!Array.isArray(templates) || templates.length === 0){
    container.innerHTML = `<div class="muted">（尚未建立任何套餐）</div>`;
    if(pickListEl) renderAddMenuSetMealPickList(rid, templates, pickListEl);
    return;
  }

  container.innerHTML = templates.map((t, i)=>{
    const cats = (t.categories||[]).map(c=>{
      const opts = (c.options||[])
          .map(o=>{
          const displayName = setMealOptionDisplayName(o);
          return `${esc(displayName || o.name || "—")}${Number(o.addPrice||0) ? `(+${o.addPrice})` : ""}`;
        })
        .join("、") || "—";
      return `${esc(c.name)}（選${Number(c.pickCount||1)}）：${opts}`;
    }).join("<br/>");

    return `
      <div style="margin-top:10px; padding:10px 12px; border:1px solid rgba(15,23,42,.12); border-radius:14px; background:#fff">
        <div class="inline" style="justify-content:space-between">
          <div>
            <b>${esc(t.name)}</b>
            <span class="tag" style="margin-left:6px">套餐 ${Number(t.price||0)}</span>
            <div class="muted mini" style="margin-top:6px">${cats}</div>
          </div>
          <button class="btnSmall btnDanger" type="button" data-add-sm-del="${i}">刪除</button>
        </div>
      </div>
    `;
  }).join("");

  container.querySelectorAll("[data-add-sm-del]").forEach(btn=>{
    btn.onclick = async ()=>{
      const idx = Number(btn.dataset.addSmDel);
      const removed = templates[idx];
      templates.splice(idx,1);
      if(removed?.id){
        const selected = getAddMenuSetMealSelected(rid);
        selected.delete(removed.id);
        addMenuSetMealSelected.set(rid, selected);
      }
      renderAddMenuSetMealTemplates(rid, templates, container, pickListEl);
      if(pickListEl) renderAddMenuSetMealPickList(rid, templates, pickListEl);
      await saveAddMenuSetMealTemplates(rid, templates);
    };
  });
}

function renderAddMenuSetMealCategoryList(rid, container){
  const t = addMenuSetMealDraft.get(rid);
  if(!container) return;
  if(!t || !t.categories.length){
    container.innerHTML = `<div class="muted">尚未加入類別</div>`;
    return;
  }

  container.innerHTML = t.categories.map((c,ci)=>{
   const opts = c.options.map((o,oi)=>{
      const editor = buildSetMealOptionGroupEditor("add-sm", o, ci, oi);
      return `
        <div style="margin-top:6px">
          <div class="inline" style="justify-content:space-between">
            <div>${esc(setMealOptionDisplayName(o) || o.name || "—")} <span class="tag">+${Number(o.addPrice||0)}</span></div>
            <button class="btnSmall btnDanger" type="button" data-add-sm-delopt="${ci}|${oi}">刪除</button>
          </div>
          ${editor}
        </div>
      `;
    }).join("");

    return `
      <div style="margin-top:10px; padding:10px; border:1px dashed rgba(15,23,42,.2); border-radius:12px">
        <b>${esc(c.name)}</b>
        <span class="tag">選 ${Number(c.pickCount||1)}</span>

        <div class="optRow" style="margin-top:8px">
          <input data-add-sm-optname="${ci}" placeholder="選項名稱">
          <input data-add-sm-optprice="${ci}" type="number" min="0" placeholder="加價">
          <button class="btnSmall btnOk" type="button" data-add-sm-addopt="${ci}">加入</button>
        </div>

        ${opts || `<div class="muted mini">尚無選項</div>`}
      </div>
    `;
  }).join("");

  container.querySelectorAll("[data-add-sm-addopt]").forEach(btn=>{
    btn.onclick = ()=>{
      const ci = Number(btn.dataset.addSmAddopt);
      const nameEl = container.querySelector(`[data-add-sm-optname="${ci}"]`);
      const priceEl = container.querySelector(`[data-add-sm-optprice="${ci}"]`);
      const n = nameEl?.value.trim() || "";
      const p = Number(priceEl?.value || 0);
      if(!n) return alert("請輸入選項名稱");
      t.categories[ci].options.push({ name: n, addPrice: p, optionGroups: [] });
      if(nameEl) nameEl.value = "";
      if(priceEl) priceEl.value = "";
      renderAddMenuSetMealCategoryList(rid, container);
    };
  });

  container.querySelectorAll("[data-add-sm-optname]").forEach(input=>{
    input.addEventListener("keydown",(e)=>{
      if(e.key!=="Enter") return;
      e.preventDefault();
      const ci = Number(input.dataset.addSmOptname);
      container.querySelector(`[data-add-sm-addopt="${ci}"]`)?.click();
    });
  });

  container.querySelectorAll("[data-add-sm-optprice]").forEach(input=>{
    input.addEventListener("keydown",(e)=>{
      if(e.key!=="Enter") return;
      e.preventDefault();
      const ci = Number(input.dataset.addSmOptprice);
      container.querySelector(`[data-add-sm-addopt="${ci}"]`)?.click();
    });
  });

  container.querySelectorAll("[data-add-sm-delopt]").forEach(btn=>{
    btn.onclick = ()=>{
      const [ci,oi] = btn.dataset.addSmDelopt.split("|").map(Number);
      t.categories[ci].options.splice(oi,1);
      renderAddMenuSetMealCategoryList(rid, container);
    };
  });
  
  bindSetMealOptionGroupEditor(
    container,
    (ci,oi)=> t?.categories?.[ci]?.options?.[oi],
    "add-sm",
    ()=> renderAddMenuSetMealCategoryList(rid, container)
  );
}

async function saveAddMenuSetMealTemplates(rid, templates){
  try{
    const payload = (templates || []).map(t=>({
      id: String(t.id || ""),
      name: String(t.name || ""),
      price: Number(t.price || 0),
      categories: Array.isArray(t.categories)
        ? t.categories.map(c=>({
            name: String(c.name || ""),
            pickCount: Math.max(1, Number(c.pickCount || 1)),
             options: Array.isArray(c.options)
                  ? c.options.map(o=>({
                      name: String(o.name || ""),
                      addPrice: Number(o.addPrice || 0),
                      optionGroups: cloneOptionGroups(o?.optionGroups)
                    }))
                  : []
          }))
        : []
    })).filter(t=> t.id && t.name);

    await updateDoc(doc(db,"restaurants", rid), { setMealTemplates: payload });
    addMenuSetMealTemplatesCache.set(rid, normalizeSetMealTemplates(payload));
  }catch(err){
    console.error(err);
    alert("儲存套餐模板失敗\n\n" + (err?.message || err));
  }
}
    
    function buildCatDatalistForRestaurant(rid, menus){
      const set = new Set();
      (menus||[]).forEach(m=>{
        const c = (m.category||"").trim();
        if(c) set.add(c);
      });
      const dlId = `catList_${rid}`;
      const html = `<datalist id="${dlId}">${
        Array.from(set).sort((a,b)=>a.localeCompare(b,"zh-Hant")).map(c=>`<option value="${esc(c)}"></option>`).join("")
      }</datalist>`;
      return { dlId, html };
    }

    async function refreshRestaurantsManage(){
  const wrap = $("restaurantsWrap");

  // ✅ 記錄目前有展開的餐廳（以 data-saver 的 rid 為主）
  const openRids = new Set();
  wrap.querySelectorAll('details[data-restaurant-card="true"]').forEach(d=>{
    if(!d.open) return;
    const rid = d.dataset.rid;
    if(rid) openRids.add(rid);
  });

  wrap.innerHTML = `<div class="muted">載入中…</div>`;

      let restaurants = [];
      let setMealByRid = new Map();
      try{
        const snap = await getDocs(query(colRestaurants, limit(1200)));
        snap.forEach(d => restaurants.push({ id: d.id, ...(d.data() || {}) }));
        restaurants.forEach(r=>{
          r._setMealTemplates = normalizeSetMealTemplates(r.setMealTemplates);
        });
        
        restaurants.sort((a,b)=>{
          const aa = toMs(a.createdAt||0), bb = toMs(b.createdAt||0);
          if(bb !== aa) return bb - aa;
          return (a.name||"").localeCompare((b.name||""),"zh-Hant");
        });

        setMealByRid = new Map();
        restaurants.forEach(r=> setMealByRid.set(r.id, r._setMealTemplates || []));
        restaurants.forEach(r=>{
          addMenuSetMealTemplatesCache.set(r.id, normalizeSetMealTemplates(r._setMealTemplates || []));
        });
        
      }catch(err){
        console.error(err);
        wrap.innerHTML = `<div class="muted">無法讀取餐廳<br/>${esc(err?.message || err)}</div>`;
        return;
      }

      /* 🔵 更新上方統計卡片：全部 / 顯示中的 / 開單中的 */
      const totalCountEl = $("restTotalCount");
      const showCountEl = $("restShowCount");
      const showListEl  = $("restShowList");
      const openCountEl = $("restOpenCount");
      const openListEl  = $("restOpenList");

       if (totalCountEl && showCountEl && showListEl && openCountEl && openListEl) {
        if (restaurants.length === 0) {
          totalCountEl.textContent = "0 家";
          showCountEl.textContent = "0 家";
          openCountEl.textContent = "0 家";
          showListEl.innerHTML = `<option value="">目前尚未新增餐廳</option>`;
          openListEl.innerHTML = `<option value="">目前尚未新增餐廳</option>`;
        } else {
          const visibleList = restaurants.filter(r => (r.isVisible !== false));
          const openListArr = restaurants.filter(r => !r.isClosed);

          const sortByCatName = (arr)=>{
            return [...arr].sort((a,b)=>{
              const ca = (a.category || "").trim();
              const cb = (b.category || "").trim();
              const c = ca.localeCompare(cb, "zh-Hant");
              if (c !== 0) return c;
              return (a.name||"").localeCompare((b.name||""), "zh-Hant");
            });
          };

          totalCountEl.textContent = `${restaurants.length} 家`;
          showCountEl.textContent = `${visibleList.length} 家`;
          openCountEl.textContent = `${openListArr.length} 家`;

         if (visibleList.length) {
            const showGroups = new Map();
            sortByCatName(visibleList).forEach(r => {
              const cat = (r.category || "").trim() || "未分類";
              if (!showGroups.has(cat)) showGroups.set(cat, []);
              showGroups.get(cat).push(r);
            });

            const showCategoryOrder = Array.from(showGroups.keys()).sort((a,b)=> {
              if (a === "未分類" && b !== "未分類") return 1;
              if (b === "未分類" && a !== "未分類") return -1;
              return a.localeCompare(b, "zh-Hant");
            });

            const showOptionHtml = [
              `<option value="">選擇餐廳…</option>`,
              ...showCategoryOrder.map(cat => {
                const items = showGroups.get(cat) || [];
                const options = items.map(r =>
                  `<option value="${esc(r.id)}">${esc(r.name || "未命名")}</option>`
                ).join("");
                return `<optgroup label="${esc(cat)}">${options}</optgroup>`;
              })
            ].join("");

            showListEl.innerHTML = showOptionHtml;
          } else {
            showListEl.innerHTML = `<option value="">目前沒有符合條件的餐廳</option>`;
          }

          if (openListArr.length) {
            const openGroups = new Map();
            sortByCatName(openListArr).forEach(r => {
              const cat = (r.category || "").trim() || "未分類";
              if (!openGroups.has(cat)) openGroups.set(cat, []);
              openGroups.get(cat).push(r);
            });

            const categoryOrder = Array.from(openGroups.keys()).sort((a,b)=> {
              if (a === "未分類" && b !== "未分類") return 1;
              if (b === "未分類" && a !== "未分類") return -1;
              return a.localeCompare(b, "zh-Hant");
            });

            const optionHtml = [
              `<option value="">選擇餐廳…</option>`,
              ...categoryOrder.map(cat => {
                const items = openGroups.get(cat) || [];
                const options = items.map(r =>
                  `<option value="${esc(r.id)}">${esc(r.name || "未命名")}</option>`
                ).join("");
                return `<optgroup label="${esc(cat)}">${options}</optgroup>`;
              })
            ].join("");

            openListEl.innerHTML = optionHtml;
          } else {
            openListEl.innerHTML = `<option value="">目前沒有符合條件的餐廳</option>`;
          }
           showListEl.onchange = () => {
            const rid = showListEl.value;
            if (!rid) return;
            const wrap = $("restaurantsWrap");
            if (!wrap) return;

            const btn = wrap.querySelector(`button[data-saver="${rid}"]`);
            const detail = btn?.closest("details");
            if (detail) {
              detail.open = true;
              let p = detail.parentElement;
              while (p) {
                if (p.tagName === "DETAILS") p.open = true;
                p = p.parentElement;
              }
          detail.scrollIntoView({ behavior:"smooth", block:"start" });
            }
          };
                                                                
          openListEl.onchange = () => {
            const rid = openListEl.value;
            if (!rid) return;
            const wrap = $("restaurantsWrap");
            if (!wrap) return;

            const btn = wrap.querySelector(`button[data-saver="${rid}"]`);
            const detail = btn?.closest("details");
            if (detail) {
              detail.open = true;
              let p = detail.parentElement;
              while (p) {
                if (p.tagName === "DETAILS") p.open = true;
                p = p.parentElement;
              }
              detail.scrollIntoView({ behavior:"smooth", block:"start" });
            }
          };
      }
      }
      /* 🔵 總覽卡片更新結束 */

      if(restaurants.length===0){
        wrap.innerHTML = `<div class="muted">尚未新增餐廳</div>`;
        return;
      }

      // ✅ 依餐廳的 category 欄位分組
      const map = new Map();
      for(const r of restaurants){
        const cat = (r.category||"").trim() || "未分類";
        if(!map.has(cat)) map.set(cat, []);
        map.get(cat).push(r);
      }

      const categoryKeys = Array.from(map.keys()).sort((a,b)=>{
        if(a==="未分類" && b!=="未分類") return 1;
        if(b==="未分類" && a!=="未分類") return -1;
        return a.localeCompare(b,"zh-Hant");
      });

      const blocks = [];

      for(const cat of categoryKeys){
        const list = map.get(cat) || [];
        const inner = [];

        for(const r of list){
          const menus = await loadMenusOfRestaurant(r.id);

          const isVisible = (r.isVisible !== false);
          const isClosed = !!r.isClosed;

          const visibleTag = isVisible
            ? `<span class="tag stateGood" style="margin-left:10px">使用者顯示</span>`
            : `<span class="tag stateBad" style="margin-left:10px">使用者隱藏</span>`;

          const closedTag = isClosed
            ? `<span class="tag stateBad" style="margin-left:6px">已結單</span>`
            : `<span class="tag stateGood" style="margin-left:6px">開單中</span>`;

          // ✅ weeklyOff + 營業時間：summary 直接顯示
          const weeklyOffArr = Array.isArray(r.weeklyOff) ? r.weeklyOff : [];
          const weeklyOffLabel = weeklyOffArr.length ? weeklyOffArr.join("・") : "";
          const weeklyOffTag = weeklyOffLabel
            ? `<span class="tag stateBad" style="margin-left:6px">${esc(weeklyOffLabel)}</span>`
            : "";

          const hoursText = (r.businessHours || "").trim();
          const hoursTag = hoursText
            ? `<span class="tag" style="margin-left:6px">⏰ ${esc(hoursText)}</span>`
            : "";

          const menuRows = (menus === null)
            ? `<div class="muted" style="margin-top:8px">（無法讀取餐點：請確認 Rules/網路）</div>`
            : (menus.length===0)
              ? `<div class="muted" style="margin-top:8px">（此餐廳尚無餐點）</div>`
              : (()=>{
                  const byCat = new Map();
                  for(const m of menus){
                    const mc = (m.category||"未分類").trim() || "未分類";
                    if(!byCat.has(mc)) byCat.set(mc, []);
                    byCat.get(mc).push(m);
                  }

                   const menuGroupTables = Array.from(byCat.entries()).map(([mc, mlist])=>{
                    const table = `
                      <table style="margin-top:10px">
                        <thead>
                          <tr>
                             <th>排序</th><th>餐點類別</th><th>餐點名稱</th><th>餐點內容</th><th>價格</th><th>預設數量</th><th>選項群組</th><th>操作</th>
                          </tr>
                        </thead>
                        <tbody>
                          ${mlist.map(m=>{
  const optText = optionGroupsSummary(m.optionGroups);
  const optKey = `${r.id}__${m.id}`;
  if(!menuOptionCache.has(optKey)){
    menuOptionCache.set(optKey, cloneOptionGroups(m.optionGroups));
  }

  return `
    <tr>
      <td><input data-rid="${r.id}" data-mid="${m.id}" data-k="order" type="number" min="0" value="${Number(m.order||0)}"></td>
      <td><input data-rid="${r.id}" data-mid="${m.id}" data-k="category" value="${esc(m.category||"")}"></td>
      <td><input data-rid="${r.id}" data-mid="${m.id}" data-k="name" value="${esc(m.name||"")}"></td>
      <td><input data-rid="${r.id}" data-mid="${m.id}" data-k="content" value="${esc(m.content||"")}"></td>
      <td><input data-rid="${r.id}" data-mid="${m.id}" data-k="price" type="number" min="0" value="${Number(m.price||0)}"></td>
      <td><input data-rid="${r.id}" data-mid="${m.id}" data-k="defaultQty" type="number" min="1" value="${Number(m.defaultQty||1)}"></td>
      <td class="muted" style="max-width:340px">${esc(optText)}</td>
      <td style="white-space:nowrap">
        <button class="btnSmall" type="button" data-editopt="1" data-rid="${r.id}" data-mid="${m.id}">選項群組</button>
        <button class="btnSmall btnOk" type="button" data-savem2="1" data-rid="${r.id}" data-mid="${m.id}">儲存</button>
        <button class="btnSmall btnDanger" type="button" data-delm2="1" data-rid="${r.id}" data-mid="${m.id}">刪除</button>
      </td>
    </tr>
   <tr class="menuOptEditorRow" data-opt-row="${r.id}__${m.id}" style="display:none;">
    <td colspan="7">
    <div class="muted mini" style="margin-bottom:6px">
      可在這裡編輯「擇一 / 加購」選項群組，編輯完成後請按上方「儲存」。
    </div>
    <!-- ✅ 真正渲染選項群組編輯 UI 的容器 -->
    <div class="optEditorBox" data-opt-editor="${r.id}__${m.id}"></div>
  </td>
</tr>

  `;
}).join("")}
                        </tbody>
                      </table>
                    `;

                    return `
                      <details style="border:1px solid rgba(15,23,42,.10); border-radius:16px; padding:10px 12px; background:rgba(15,23,42,.02); margin-top:10px;">
                        <summary>${esc(mc)} <span class="tag" style="margin-left:8px">${mlist.length} 道</span></summary>
                        ${table}
                      </details>
                    `;
                  }).join("");
                
                  return `
                    <div class="inline" style="justify-content:space-between; align-items:center; gap:10px; margin-top:6px;">
                      <div class="muted mini">可先編輯多筆餐點後再一次儲存</div>
                            <div class="inline" style="gap:8px;">
                        <span class="saveFeedback" data-saveallmenu-status="${r.id}">尚未儲存</span>
                        <button class="btnSmall btnOk" type="button" data-saveallmenu="${r.id}">一次編輯全儲存</button>
                      </div>
                    </div>
                    ${menuGroupTables}
                  `;
                })();

          const catDl = buildCatDatalistForRestaurant(r.id, menus===null?[]:menus);

          const weekOptions = [
            "週一公休","週二公休","週三公休","週四公休",
            "週五公休","週六公休","週日公休"
          ];
          const weeklyOffChecks = weekOptions.map(label=>{
            const checked = weeklyOffArr.includes(label) ? "checked" : "";
            return `
              <label class="chkline mini">
                <input type="checkbox" data-r="${r.id}" data-weekly="${esc(label)}" ${checked}/>
                <span>${esc(label)}</span>
              </label>
            `;
          }).join("");

                    const addForm = `
            <div class="hr"></div>
            <h3 style="margin:0">➕ 直接新增餐點到「${esc(r.name||"未命名")}」</h3>

            ${catDl.html}

           <div style="margin-top:10px">
              <label>餐點類別（輸入 + 下拉建議）</label>
              <input list="${catDl.dlId}" data-add-rid="${r.id}" data-add-k="category" placeholder="例：飯類 / 麵類 / 小菜 / 飲料">
            </div>

           <label>餐點名稱</label>
            <input data-add-rid="${r.id}" data-add-k="name" placeholder="例：法式炒麵">

             <label>餐點內容</label>
            <textarea data-add-rid="${r.id}" data-add-k="content" placeholder="例：雞腿、蔬菜、滷蛋"></textarea>

            <div class="row">
              <div>
                <label>價格（單份）</label>
                <input data-add-rid="${r.id}" data-add-k="price" type="number" min="0" placeholder="120">
              </div>
              <div>
                <label>數量規則</label>
                <select data-add-rid="${r.id}" data-add-k="qtyType">
                  <option value="normal">正常份量（1,2,3...）</option>
                  <option value="multiple">倍數份量（固定倍數）</option>
                </select>
              </div>
            </div>

           <div style="margin-top:10px">
              <label>倍數基準數</label>
              <input data-add-rid="${r.id}" data-add-k="defaultQty" type="number" min="1" value="1">
              <div class="muted mini" data-add-qty-hint="${r.id}" style="margin-top:6px">數量會以此倍數遞增（例：5 → 5、10、15）</div>
            </div>

           <details class="fold" style="margin-top:10px">
              <summary>
                ✅ 選項群組
              </summary>
              <div class="optEditorBox" data-add-og="${r.id}"></div>
            </details>

            <details class="fold" style="margin-top:10px">
              <summary>
                 ✅ 套餐選項
              </summary>
           <div class="subcard" data-add-sm-editor="${r.id}">
                <div class="row3">
                  <div>
                    <label>套餐名稱</label>
                    <input data-add-sm-name="${r.id}" placeholder="例：A餐 / 超值套餐">
                  </div>
                  <div>
                    <label>套餐價格（基礎）</label>
                    <input data-add-sm-price="${r.id}" type="number" min="0" placeholder="例：59">
                  </div>
                  <div style="display:flex; align-items:end; gap:10px">
                    <button class="btnSmall btnOk" type="button" data-add-sm-start="${r.id}">新增套餐</button>
                  </div>
                </div>

                <!-- 套餐編輯區（草稿） -->
                <div data-add-sm-draft="${r.id}" style="margin-top:10px; display:none">
                  <div class="optBox">
                    <div class="inline" style="justify-content:space-between; align-items:flex-start">
                      <div>
                        <b data-add-sm-title="${r.id}">套餐</b>
                        <div class="muted mini" data-add-sm-desc="${r.id}"></div>
                      </div>
                      <button class="btnSmall btnDanger" type="button" data-add-sm-cancel="${r.id}">取消套餐</button>
                    </div>

                    <div class="hr"></div>

                    <div class="row3">
                      <div>
                        <label>套餐類別</label>
                        <input data-add-sm-catname="${r.id}" placeholder="例：小點 / 湯品 / 飲品">
                      </div>
                      <div>
                        <label>此類別要選幾樣</label>
                        <select data-add-sm-pickcount="${r.id}">
                          <option value="1">選 1</option>
                          <option value="2">選 2</option>
                        </select>
                      </div>
                      <div style="display:flex; align-items:end; gap:10px">
                        <button class="btnSmall btnOk" type="button" data-add-sm-addcat="${r.id}">加入類別</button>
                      </div>
                    </div>

                    <div data-add-sm-categorylist="${r.id}" style="margin-top:10px"></div>

                    <div class="actions">
                      <button class="btnSmall btnOk" type="button" data-add-sm-commit="${r.id}">完成此套餐（加入到模板清單）</button>
                    </div>
                  </div>
                </div>

                <!-- 已建立的套餐模板 -->
                <div style="margin-top:10px">
                  <div class="muted mini" style="margin-bottom:6px">已建立的套餐模板（可刪除）</div>
                  <div data-add-sm-templates="${r.id}"></div>
                </div>

                <div class="hr"></div>

                <!-- 此餐點支援哪些套餐（勾選） -->
                <div>
                  <div class="muted mini" style="margin-bottom:6px">此餐點支援哪些套餐（勾選）</div>
                  <div data-add-sm-picklist="${r.id}" class="kpi"></div>
                </div>
              </div>
            </details>

            <div class="actions">
              <button class="btnSmall btnOk" type="button" data-addmenu="${r.id}">新增餐點</button>
              <button class="btnSmall" type="button" data-clearadd="${r.id}">清空欄位</button>
            </div>
          `;

          // 🔽🔽🔽 這整段 inner.push 改成新的 🔽🔽🔽
          inner.push(`
              <details data-restaurant-card="true" data-rid="${r.id}" style="border:1px solid rgba(15,23,42,.14); border-radius:16px; padding:12px; background:#ffffff; margin-top:12px;">
              <summary class="inline" style="cursor:pointer; justify-content:space-between; align-items:center; gap:8px;">
                <div>
                  <span style="font-size:15px; font-weight:700;">${esc(r.name||"未命名")}</span>
                  ${visibleTag}
                  ${closedTag}
                  ${weeklyOffTag}
                  ${hoursTag}
                </div>
                <div class="muted mini">
                  分類：${esc((r.category||"").trim() || "未分類")}
                </div>
              </summary>

              <!-- 🟦 餐廳資訊（藍底，可收合） -->
              <details style="margin-top:10px; border-radius:12px; padding:10px; background:#f0f9ff; border-left:4px solid #38bdf8;">
                <summary style="cursor:pointer; font-size:14px; font-weight:700;">
                  餐廳資訊
                </summary>
                <div style="margin-top:8px">

                                   <div class="kpi">
                    ${r.phone ? `<span class="tag">☎ ${esc(r.phone)}</span>` : ``}
                    ${r.address ? `<span class="tag">📍 ${esc(r.address)}</span>` : ``}
                    ${r.mapUrl ? `<span class="tag"><a target="_blank" href="${esc(r.mapUrl)}" style="color:inherit; text-decoration:none">Google Map</a></span>` : ``}
                    ${r.imageUrl ? `<span class="tag"><a target="_blank" href="${esc(r.imageUrl)}" style="color:inherit; text-decoration:none">餐廳圖片</a></span>` : ``}
                    ${r.menuImageUrl ? `<span class="tag"><a target="_blank" href="${esc(r.menuImageUrl)}" style="color:inherit; text-decoration:none">菜單圖片</a></span>` : ``}
                    ${r.lineQrUrl ? `<span class="tag"><a target="_blank" href="${esc(r.lineQrUrl)}" style="color:inherit; text-decoration:none">Line QR</a></span>` : ``}
                    ${r.onlineOrderUrl ? `<span class="tag"><a target="_blank" href="${esc(r.onlineOrderUrl)}" style="color:inherit; text-decoration:none">線上點餐</a></span>` : ``}
                  </div>

                  <!-- ✅ 使用者顯示 / 結單 勾選 -->
                  <div class="row" style="margin:10px 0; gap:16px;">
                    <label style="margin:0; display:flex; align-items:center; gap:6px;">
                      <input
                        type="checkbox"
                        data-r="${r.id}"
                        data-k="isVisible"
                        style="width:18px; height:18px;"
                        ${r.isVisible === false ? "" : "checked"}
                      />
                      <span>使用者顯示</span>
                    </label>

                    <label style="margin:0; display:flex; align-items:center; gap:6px;">
                      <input
                        type="checkbox"
                        data-r="${r.id}"
                        data-k="isClosed"
                        style="width:18px; height:18px;"
                        ${r.isClosed ? "checked" : ""}
                      />
                      <span>結單（使用者不可送單）</span>
                    </label>
                  </div>

                  <label>餐廳類別分類</label>
                  <input data-r="${r.id}" data-k="category" value="${esc((r.category||"").trim())}" placeholder="例：燒臘 / 粥品"/>

                  <div class="row" style="margin-top:10px">
                    <div>
                      <label>電話</label>
                      <input data-r="${r.id}" data-k="phone" value="${esc(r.phone||"")}"/>
                    </div>
                    <div>
                      <label>地址</label>
                      <input data-r="${r.id}" data-k="address" value="${esc(r.address||"")}"/>
                    </div>
                  </div>

                  <label>Google Map 連結</label>
                  <input data-r="${r.id}" data-k="mapUrl" value="${esc(r.mapUrl||"")}"/>

                  <div class="row" style="margin-top:10px">
                    <div>
                      <label>餐廳圖片網址</label>
                      <div class="inline" style="gap:8px">
                        <input data-r="${r.id}" data-k="imageUrl" value="${esc(r.imageUrl||"")}"/>
                        <button class="btnSmall" type="button" data-openimg="${r.id}">開啟</button>
                      </div>
                    </div>
                    <div>
                      <label>餐廳菜單圖片網址</label>
                      <div class="inline" style="gap:8px">
                        <input data-r="${r.id}" data-k="menuImageUrl" value="${esc(r.menuImageUrl||"")}"/>
                        <button class="btnSmall" type="button" data-openmenuimg="${r.id}">開啟</button>
                      </div>
                    </div>
                  </div>
                  
                  <label>營業時間</label>
                  <input data-r="${r.id}" data-k="businessHours"
                         value="${esc(r.businessHours || "")}"
                         placeholder="例：11:00~14:30 / 16:30~19:30"/>

                  <label>公休日（可多選）</label>
                  <div class="chkline mini">
                    ${weeklyOffChecks}
                  </div>

                  <div class="row">
                    <div>
                      <label>Line QR Code 圖片網址</label>
                      <div class="inline" style="gap:8px">
                        <input data-r="${r.id}" data-k="lineQrUrl" value="${esc(r.lineQrUrl||"")}"/>
                        <button class="btnSmall" type="button" data-openqr="${r.id}">開啟</button>
                      </div>
                    </div>
                    <div>
                      <label>線上點餐連結</label>
                      <div class="inline" style="gap:8px">
                        <input data-r="${r.id}" data-k="onlineOrderUrl" value="${esc(r.onlineOrderUrl||"")}"/>
                        <button class="btnSmall" type="button" data-openorder="${r.id}">開啟</button>
                      </div>
                    </div>
                  </div>
                  <div class="muted" style="margin-top:6px">（貼 QR code 圖片網址或線上點餐連結即可）</div>
                    </div>
                  </div>

                  ${r.imageUrl ? `<img src="${esc(r.imageUrl)}" class="previewImg" style="max-width:160px; border-radius:12px; margin-top:10px" alt="img" onerror="this.style.display='none'"/>`
                               : `<div class="muted" style="margin-top:10px">（尚無餐廳圖片網址）</div>`}

                 ${r.menuImageUrl ? `<img src="${esc(r.menuImageUrl)}" class="previewImg" style="max-width:160px; border-radius:12px; margin-top:10px" alt="menu-img" onerror="this.style.display='none'"/>`
                                : `<div class="muted" style="margin-top:10px">（尚無餐廳菜單圖片網址）</div>`}

                  ${r.lineQrUrl ? `<img src="${esc(r.lineQrUrl)}" class="previewImg" style="max-width:160px; border-radius:12px; margin-top:10px" alt="line-qr" onerror="this.style.display='none'"/>`
                                : `<div class="muted" style="margin-top:10px">（尚無 Line QR code）</div>`}

                  <label>備註</label>
                  <textarea data-r="${r.id}" data-k="note">${esc(r.note||"")}</textarea>

                  <div class="actions">
                    <button class="btnSmall btnOk" type="button" data-saver="${r.id}">儲存餐廳資料</button>
                    <button class="btnSmall btnDanger" type="button" data-delr="${r.id}">刪除餐廳</button>
                  </div>

                </div>
              </details>

              <!-- 🟩 已設定餐點（綠底，可收合） -->
              <details style="margin-top:10px; border-radius:12px; padding:10px; background:#ecfdf3; border-left:4px solid #22c55e;">
                <summary style="cursor:pointer; font-size:14px; font-weight:700;">
                  已設定餐點（依類別收合）
                </summary>
                <div style="margin-top:8px">
                  ${menuRows}
                </div>
              </details>

              <!-- 🟣 新增餐點（紫底，可收合） -->
              <details style="margin-top:10px; border-radius:12px; padding:10px; background:#faf5ff; border-left:4px solid #c084fc;">
                <summary style="cursor:pointer; font-size:14px; font-weight:700;">
                  新增餐點
                </summary>
                <div style="margin-top:8px">
                  ${addForm}
                </div>
              </details>

            </details>
          `);
          // 🔼🔼🔼 inner.push 到這裡結束 🔼🔼🔼
        }

        blocks.push(`
          <details style="border:1px solid rgba(15,23,42,.10); border-radius:16px; padding:12px; background:rgba(255,255,255,.9); margin-top:12px;">
            <summary>
              <span style="font-size:15px">${esc(cat)}</span>
              <span class="tag" style="margin-left:8px">${list.length} 家</span>
            </summary>
            ${inner.join("")}
          </details>
        `);
      }

      wrap.innerHTML = blocks.join("");

        wrap.querySelectorAll("[data-add-og]").forEach(box=>{
        const rid = box.dataset.addOg;
        renderAddMenuOptionEditor(rid, box);
      });

      wrap.querySelectorAll("[data-add-sm-editor]").forEach(editor=>{
        const rid = editor.dataset.addSmEditor;
        const templates = getAddMenuSetMealTemplates(rid, setMealByRid.get(rid) || []);

        const pickListEl = editor.querySelector(`[data-add-sm-picklist="${rid}"]`);
        const templatesListEl = editor.querySelector(`[data-add-sm-templates="${rid}"]`);
        const draftAreaEl = editor.querySelector(`[data-add-sm-draft="${rid}"]`);
        const categoryListEl = editor.querySelector(`[data-add-sm-categorylist="${rid}"]`);
        const titleEl = editor.querySelector(`[data-add-sm-title="${rid}"]`);
        const descEl = editor.querySelector(`[data-add-sm-desc="${rid}"]`);
        const nameEl = editor.querySelector(`[data-add-sm-name="${rid}"]`);
        const priceEl = editor.querySelector(`[data-add-sm-price="${rid}"]`);
        const startBtn = editor.querySelector(`[data-add-sm-start="${rid}"]`);
        const cancelBtn = editor.querySelector(`[data-add-sm-cancel="${rid}"]`);
        const catNameEl = editor.querySelector(`[data-add-sm-catname="${rid}"]`);
        const pickCountEl = editor.querySelector(`[data-add-sm-pickcount="${rid}"]`);
        const addCatBtn = editor.querySelector(`[data-add-sm-addcat="${rid}"]`);
        const commitBtn = editor.querySelector(`[data-add-sm-commit="${rid}"]`);

        const showDraft = (on)=>{
          if(draftAreaEl) draftAreaEl.style.display = on ? "" : "none";
        };

        renderAddMenuSetMealTemplates(rid, templates, templatesListEl, pickListEl);
        renderAddMenuSetMealPickList(rid, templates, pickListEl);
        renderAddMenuSetMealCategoryList(rid, categoryListEl);

        if(startBtn){
          startBtn.onclick = ()=>{
            const name = nameEl?.value.trim() || "";
            const price = Number(priceEl?.value || 0);
            if(!name) return alert("請輸入套餐名稱");
            const draft = { id: uid(), name, price, categories: [] };
            addMenuSetMealDraft.set(rid, draft);
            if(titleEl) titleEl.textContent = `套餐：${name}`;
            if(descEl) descEl.textContent = `套餐價 ${price}`;
            showDraft(true);
            renderAddMenuSetMealCategoryList(rid, categoryListEl);
          };
        }

        nameEl?.addEventListener("keydown",(e)=>{
          if(e.key==="Enter"){
            e.preventDefault();
            startBtn?.click();
          }
        });

        priceEl?.addEventListener("keydown",(e)=>{
          if(e.key==="Enter"){
            e.preventDefault();
            startBtn?.click();
          }
        });

        if(cancelBtn){
          cancelBtn.onclick = ()=>{
            addMenuSetMealDraft.set(rid, null);
            showDraft(false);
            renderAddMenuSetMealCategoryList(rid, categoryListEl);
          };
        }

        if(addCatBtn){
          addCatBtn.onclick = ()=>{
            const draft = addMenuSetMealDraft.get(rid);
            if(!draft) return;
            const n = catNameEl?.value.trim() || "";
            const p = Number(pickCountEl?.value || 1);
            if(!n) return alert("請輸入類別名稱");
            draft.categories.push({ name: n, pickCount: p, options: [] });
            if(catNameEl) catNameEl.value = "";
            renderAddMenuSetMealCategoryList(rid, categoryListEl);
          };
        }

        catNameEl?.addEventListener("keydown",(e)=>{
          if(e.key==="Enter"){
            e.preventDefault();
            addCatBtn?.click();
          }
        });

        if(commitBtn){
          commitBtn.onclick = async ()=>{
            const draft = addMenuSetMealDraft.get(rid);
            if(!draft || !draft.categories.length) return alert("至少要一個類別");
            for(const c of draft.categories){
              if(!c.options.length) return alert(`類別「${c.name}」沒有選項`);
            }
            templates.push(draft);
            addMenuSetMealDraft.set(rid, null);
            showDraft(false);
            if(nameEl) nameEl.value = "";
            if(priceEl) priceEl.value = "";
            renderAddMenuSetMealTemplates(rid, templates, templatesListEl, pickListEl);
            renderAddMenuSetMealPickList(rid, templates, pickListEl);
            await saveAddMenuSetMealTemplates(rid, templates);
          };
        }
      });

      // ✅ 把剛剛已經展開的餐廳再打開
       openRids.forEach(rid=>{
        const card = wrap.querySelector(`details[data-restaurant-card="true"][data-rid="${rid}"]`);
        if(!card) return;
        let d = card;
        while(d){
          if(d.tagName === "DETAILS") d.open = true;
          d = d.parentElement?.closest("details");
        }
      });

      // ===== 綁定餐廳管理內各種按鈕 =====
      wrap.querySelectorAll("button[data-openimg]").forEach(btn=>{
        btn.onclick = ()=>{
          const rid = btn.dataset.openimg;
          const input = wrap.querySelector(`[data-r="${rid}"][data-k="imageUrl"]`);
          const url = (input?.value || "").trim();
          if(!url) return alert("目前沒有圖片網址");
          const finalUrl = url.startsWith("http://") || url.startsWith("https://") ? url : ("https://" + url);
          window.open(finalUrl, "_blank");
        };
      });

       wrap.querySelectorAll("button[data-openmenuimg]").forEach(btn=>{
        btn.onclick = ()=>{
          const rid = btn.dataset.openmenuimg;
          const input = wrap.querySelector(`[data-r="${rid}"][data-k="menuImageUrl"]`);
          const url = (input?.value || "").trim();
          if(!url) return alert("目前沒有菜單圖片網址");
          const finalUrl = url.startsWith("http://") || url.startsWith("https://") ? url : ("https://" + url);
          window.open(finalUrl, "_blank");
        };
      });

      wrap.querySelectorAll("button[data-openqr]").forEach(btn=>{
        btn.onclick = ()=>{
          const rid = btn.dataset.openqr;
          const input = wrap.querySelector(`[data-r="${rid}"][data-k="lineQrUrl"]`);
          const url = (input?.value || "").trim();
          if(!url) return alert("目前沒有 Line QR 連結");
          const finalUrl = url.startsWith("http://") || url.startsWith("https://") ? url : ("https://" + url);
          window.open(finalUrl, "_blank");
        };
      });

        wrap.querySelectorAll("button[data-openorder]").forEach(btn=>{
        btn.onclick = ()=>{
          const rid = btn.dataset.openorder;
          const input = wrap.querySelector(`[data-r="${rid}"][data-k="onlineOrderUrl"]`);
          const url = (input?.value || "").trim();
          if(!url) return alert("目前沒有線上點餐連結");
          const finalUrl = url.startsWith("http://") || url.startsWith("https://") ? url : ("https://" + url);
          window.open(finalUrl, "_blank");
        };
      });
      
      wrap.querySelectorAll("button[data-saver]").forEach(b=>{
        b.onclick = async ()=>{
          const rid = b.dataset.saver;
          const inputs = wrap.querySelectorAll(`[data-r="${rid}"]`);
          const patch = {};
          inputs.forEach(i=>{
            const k = i.dataset.k;
            if(i.type === "checkbox") patch[k] = !!i.checked;
            else patch[k] = i.value.trim();
          });

          // 公休日：checkbox 收集
          const weeklyChecked = [];
          wrap.querySelectorAll(`[data-r="${rid}"][data-weekly]`).forEach(ch=>{
            if(ch.checked) weeklyChecked.push(ch.dataset.weekly || "");
          });
          patch.weeklyOff = weeklyChecked;

          try{
            statusPill.textContent = "儲存中…";
            await updateDoc(doc(db,"restaurants", rid), patch);
            statusPill.textContent = "儲存完成 ✅";
            await refreshRestaurantsManage();
          }catch(err){
            console.error(err);
            alert("儲存失敗\n\n" + (err?.message || err));
            statusPill.textContent = "儲存失敗（看 console）";
          }
        };
      });

      wrap.querySelectorAll("button[data-delr]").forEach(b=>{
        b.onclick = async ()=>{
          const rid = b.dataset.delr;
          if(!confirm("確定刪除餐廳？（會連同該餐廳的餐點一起刪除）")) return;

          try{
            statusPill.textContent = "刪除餐廳中…";

            const menuCol = collection(db, "restaurants", rid, "menu");
            const menuSnap = await getDocs(query(menuCol, limit(2500)));

            let batch = writeBatch(db);
            let count = 0;

            for (const d of menuSnap.docs){
              batch.delete(d.ref);
              count++;
              if(count % 450 === 0){
                await batch.commit();
                batch = writeBatch(db);
              }
            }

            if(count > 0){
              await batch.commit();
            }

            await deleteDoc(doc(db,"restaurants", rid));
            statusPill.textContent = "刪除完成 ✅";
            await refreshRestaurantsManage();
          }catch(err){
            console.error(err);
            alert("刪除失敗\n\n" + (err?.message || err));
            statusPill.textContent = "刪除失敗（看 console）";
          }
        };
      });

      // ===== 餐點：選項群組編輯 & 儲存 / 刪除 =====
      wrap.querySelectorAll("button[data-editopt]").forEach(btn=>{
        btn.onclick = async ()=>{
          const rid = btn.dataset.rid;
          const mid = btn.dataset.mid;
          const rowKey = `${rid}__${mid}`;

          const row = wrap.querySelector(`.menuOptEditorRow[data-opt-row="${rowKey}"]`);
          if(!row) return;

          const box = row.querySelector(".optEditorBox");
          if(!box) return;

          const isOpen = row.style.display === "" || row.style.display === "table-row";
          if(isOpen){
            row.style.display = "none";
            box.innerHTML = "";
            return;
          }

          const menuSnap = await getDoc(doc(db,"restaurants", rid, "menu", mid));
          const menuData = menuSnap.exists() ? menuSnap.data() : {};

          let groups = Array.isArray(menuData.optionGroups) ? menuData.optionGroups : [];
          groups = cloneOptionGroups(groups);

          const cacheKey = `${rid}__${mid}`;
          menuOptionCache.set(cacheKey, groups);

          renderMenuOptionEditor(rid, mid, box);
          row.style.display = "table-row";
        };
      });

       wrap.querySelectorAll("button[data-saveallmenu]").forEach(btn=>{
        btn.onclick = async ()=>{
          const rid = btn.dataset.saveallmenu;
          const feedback = wrap.querySelector(`[data-saveallmenu-status="${rid}"]`);
          const originalText = btn.textContent;
          const setFeedback = (text, tone)=>{
            if(!feedback) return;
            feedback.textContent = text;
            feedback.classList.remove("success", "error");
            if(tone){
              feedback.classList.add(tone);
            }
          };
          const rowInputs = wrap.querySelectorAll(`[data-rid="${rid}"][data-mid]`);
          const mids = new Set();
          rowInputs.forEach(el=>{
            const mid = el.dataset.mid;
            if(mid) mids.add(mid);
          });
          if(mids.size === 0){
            alert("沒有可儲存的餐點");
            return;
          }

          try{
            btn.disabled = true;
            btn.textContent = "儲存中…";
            setFeedback("批次儲存中…");
            statusPill.textContent = "餐點批次儲存中…";
            let batch = writeBatch(db);
            let count = 0;

            for(const mid of mids){
              const els = wrap.querySelectorAll(`[data-rid="${rid}"][data-mid="${mid}"]`);
              const patch = {};
              els.forEach(el=>{
                const k = el.dataset.k;
                patch[k] = (k==="price" || k==="defaultQty" || k==="order")
                  ? Number(el.value||0)
                  : el.value.trim();
              });
              patch.defaultQty = Math.max(1, Number(patch.defaultQty||1));
              patch.price = Math.max(0, Number(patch.price||0));
              patch.order = Math.max(0, Number(patch.order||0));

              const ogKey = `${rid}__${mid}`;
              const og = menuOptionCache.get(ogKey);
              if(Array.isArray(og)){
                patch.optionGroups = cloneOptionGroups(og);
              }

              batch.update(doc(db,"restaurants", rid, "menu", mid), patch);
              count++;
              if(count % 450 === 0){
                await batch.commit();
                batch = writeBatch(db);
              }
            }

            if(count % 450 !== 0){
              await batch.commit();
            }

            mids.forEach(mid=>{
              const td = wrap.querySelector(`button[data-savem2][data-rid="${rid}"][data-mid="${mid}"]`)?.closest("tr")?.querySelector("td:nth-child(7)");
              const og = menuOptionCache.get(`${rid}__${mid}`);
              if(td && Array.isArray(og)){
                td.textContent = optionGroupsSummary(og);
              }
            });

            statusPill.textContent = "餐點已全數儲存 ✅";
            setFeedback("已儲存 ✅", "success");
          }catch(err){
            console.error(err);
            alert("批次儲存餐點失敗\n\n" + (err?.message || err));
            statusPill.textContent = "批次儲存失敗（看 console）";
            setFeedback("儲存失敗", "error");
          }finally{
            btn.disabled = false;
            btn.textContent = originalText;
          }
        };
      });

    wrap.querySelectorAll("button[data-savem2]").forEach(b=>{
  b.onclick = async ()=>{
    const rid = b.dataset.rid;
    const mid = b.dataset.mid;

    // 讀這一列餐點欄位
    const els = wrap.querySelectorAll(`[data-rid="${rid}"][data-mid="${mid}"]`);
    const patch = {};
    els.forEach(el=>{
      const k = el.dataset.k;
      patch[k] = (k==="price" || k==="defaultQty" || k==="order")
        ? Number(el.value||0)
        : el.value.trim();
    });
    patch.defaultQty = Math.max(1, Number(patch.defaultQty||1));
    patch.price = Math.max(0, Number(patch.price||0));
    patch.order = Math.max(0, Number(patch.order||0));
    
    // 🔍 看看快取裡有沒有群組（除錯用）
    const ogKey = `${rid}__${mid}`;
    const og = menuOptionCache.get(ogKey);
    console.log("儲存時的選項群組快取：", ogKey, og);

    // ✅ 有的話一起寫回 optionGroups
    if(Array.isArray(og)){
      patch.optionGroups = cloneOptionGroups(og);
    }

    try{
      statusPill.textContent = "餐點儲存中…";
      await updateDoc(doc(db,"restaurants", rid, "menu", mid), patch);
      statusPill.textContent = "餐點已儲存 ✅";

      // ✅ 順便更新「已設定餐點」那一格 summary，馬上看到結果
    const td = b.closest("tr")?.querySelector("td:nth-child(7)");
      if(td && Array.isArray(patch.optionGroups)){
        td.textContent = optionGroupsSummary(patch.optionGroups);
      }

      await refreshRestaurantsManage();
    }catch(err){
      console.error(err);
      alert("儲存餐點失敗\n\n" + (err?.message || err));
      statusPill.textContent = "餐點儲存失敗（看 console）";
    }
  };
});

      wrap.querySelectorAll("button[data-delm2]").forEach(b=>{
        b.onclick = async ()=>{
          const rid = b.dataset.rid;
          const mid = b.dataset.mid;
          if(!confirm("確定刪除餐點？")) return;
          try{
            await deleteDoc(doc(db,"restaurants", rid, "menu", mid));
            await refreshRestaurantsManage();
          }catch(err){
            console.error(err);
            alert("刪除餐點失敗\n\n" + (err?.message || err));
          }
        };
      });

      wrap.querySelectorAll('select[data-add-k="qtyType"]').forEach(sel=>{
        const rid = sel.dataset.addRid;
        const qtyInput = wrap.querySelector(`[data-add-rid="${rid}"][data-add-k="defaultQty"]`);
        const hintEl = wrap.querySelector(`[data-add-qty-hint="${rid}"]`);
        const apply = ()=>syncQtyMode(sel, qtyInput, hintEl);
        sel.addEventListener("change", apply);
        apply();
      });

      // ===== 餐廳管理：新增餐點 / 清空 =====
      wrap.querySelectorAll("button[data-addmenu]").forEach(btn=>{
        btn.onclick = async ()=>{
          const rid = btn.dataset.addmenu;

          const category = (wrap.querySelector(`[data-add-rid="${rid}"][data-add-k="category"]`)?.value || "").trim();
          const name = (wrap.querySelector(`[data-add-rid="${rid}"][data-add-k="name"]`)?.value || "").trim();
          const content = (wrap.querySelector(`[data-add-rid="${rid}"][data-add-k="content"]`)?.value || "").trim();
          const price = Number(
            wrap.querySelector(`[data-add-rid="${rid}"][data-add-k="price"]`)?.value || 0
          );
            const qtyType = (wrap.querySelector(`[data-add-rid="${rid}"][data-add-k="qtyType"]`)?.value || "normal").trim();
          const defaultQty = qtyType === "multiple"
            ? Math.max(
              1,
              Number(wrap.querySelector(`[data-add-rid="${rid}"][data-add-k="defaultQty"]`)?.value || 1)
            )
            : 1;
          
          if(!category) return alert("請輸入餐點類別");
          if(!name) return alert("請輸入餐點名稱");
          if(isNaN(price) || price<0) return alert("價格不正確");

          try{
            statusPill.textContent = "新增餐點中…";

            const optionGroups = cloneOptionGroups(getAddMenuOptionGroups(rid));
            const setMealTemplateIds = Array.from(getAddMenuSetMealSelected(rid));
            
            const menuCol = collection(db, "restaurants", rid, "menu");
            await addDoc(menuCol, {
              category,
              name,
              content,
              price,
              defaultQty,
              optionGroups,
              setMealTemplateIds,
              createdAt: Date.now()
            });

            statusPill.textContent = "已新增餐點 ✅";

            const c1 = wrap.querySelector(`[data-add-rid="${rid}"][data-add-k="category"]`);
            const c2 = wrap.querySelector(`[data-add-rid="${rid}"][data-add-k="name"]`);
            const c3 = wrap.querySelector(`[data-add-rid="${rid}"][data-add-k="content"]`);
            const c4 = wrap.querySelector(`[data-add-rid="${rid}"][data-add-k="price"]`);
            const c5 = wrap.querySelector(`[data-add-rid="${rid}"][data-add-k="defaultQty"]`);
            const c6 = wrap.querySelector(`[data-add-rid="${rid}"][data-add-k="qtyType"]`);
            if(c1) c1.value = "";
            if(c2) c2.value = "";
            if(c3) c3.value = "";
            if(c4) c4.value = "";
            if(c5) c5.value = "1";
            if(c6) c6.value = "normal";
            if(c6) syncQtyMode(c6, c5, wrap.querySelector(`[data-add-qty-hint="${rid}"]`));

            addMenuOptionCache.set(rid, []);
            addMenuSetMealSelected.set(rid, new Set());
            
            await refreshRestaurantsManage();
          }catch(err){
            console.error(err);
            alert("新增餐點失敗\n\n" + (err?.message || err));
            statusPill.textContent = "新增餐點失敗（看 console）";
          }
        };
      });

      // ✅ 清空「新增餐點」輸入欄位
      wrap.querySelectorAll("button[data-clearadd]").forEach(btn=>{
        btn.onclick = ()=>{
          const rid = btn.dataset.clearadd;
          const c1 = wrap.querySelector(`[data-add-rid="${rid}"][data-add-k="category"]`);
          const c2 = wrap.querySelector(`[data-add-rid="${rid}"][data-add-k="name"]`);
          const c3 = wrap.querySelector(`[data-add-rid="${rid}"][data-add-k="content"]`);
          const c4 = wrap.querySelector(`[data-add-rid="${rid}"][data-add-k="price"]`);
          const c5 = wrap.querySelector(`[data-add-rid="${rid}"][data-add-k="defaultQty"]`);
          const c6 = wrap.querySelector(`[data-add-rid="${rid}"][data-add-k="qtyType"]`);
          if(c1) c1.value = "";
          if(c2) c2.value = "";
          if(c3) c3.value = "";
          if(c4) c4.value = "";
          if(c5) c5.value = "1";
          if(c6) c6.value = "normal";
          if(c6) syncQtyMode(c6, c5, wrap.querySelector(`[data-add-qty-hint="${rid}"]`));
          addMenuOptionCache.set(rid, []);
          addMenuSetMealSelected.set(rid, new Set());

          const ogBox = wrap.querySelector(`[data-add-og="${rid}"]`);
          if(ogBox) renderAddMenuOptionEditor(rid, ogBox);
            const smBox = wrap.querySelector(`[data-add-sm-picklist="${rid}"]`);
          if(smBox){
            const templates = getAddMenuSetMealTemplates(rid, setMealByRid.get(rid) || []);
            renderAddMenuSetMealPickList(rid, templates, smBox);
          }
        };
      });

}

    // ====== 訂餐紀錄（彙整輸出 + Excel + 刪單/刪一道 + 未點餐提醒） ======
    $("btnToday").onclick = ()=> $("o_date").value = todayISO();
    $("o_date").value = todayISO();

    let lastLoadedOrders = [];
    let ordersUnsub = null;
    let ordersLiveReady = false;

    const orderSoundToggle = $("toggleOrderSound");
    const orderSoundLabel = $("orderSoundLabel");
    const orderNoticeWrap = $("orderNoticeWrap");
    let orderAudioCtx = null;

    const getOrderAudioContext = ()=>{
      const AudioCtx = window.AudioContext || window.webkitAudioContext;
      if(!AudioCtx) return null;
      if(!orderAudioCtx) orderAudioCtx = new AudioCtx();
      return orderAudioCtx;
    };

    const unlockOrderAudio = ()=>{
      const ctx = getOrderAudioContext();
      if(!ctx) return;
      if(ctx.state === "suspended") ctx.resume().catch(()=>{});
    };
    
    const loadOrderSoundPref = ()=>{
      const saved = localStorage.getItem("gb_order_sound");
      return saved === null ? true : saved === "1";
    };
    const setOrderSoundPref = (enabled)=>{
      localStorage.setItem("gb_order_sound", enabled ? "1" : "0");
      if(orderSoundToggle) orderSoundToggle.checked = enabled;
      if(orderSoundLabel) orderSoundLabel.textContent = enabled ? "音效開啟" : "音效關閉";
    };
    setOrderSoundPref(loadOrderSoundPref());
    orderSoundToggle?.addEventListener("change", (e)=>{
      setOrderSoundPref(e.target.checked);
      if(e.target.checked) unlockOrderAudio();
    });

    const unlockOnce = ()=>{
      unlockOrderAudio();
      document.removeEventListener("click", unlockOnce);
      document.removeEventListener("keydown", unlockOnce);
    };
    document.addEventListener("click", unlockOnce);
    document.addEventListener("keydown", unlockOnce);

    function pushOrderNotice(title, detail){
      if(!orderNoticeWrap) return;
      const notice = document.createElement("div");
      notice.className = "orderNotice";
      notice.innerHTML = `<strong>${esc(title)}</strong>${esc(detail || "")}`;
      orderNoticeWrap.prepend(notice);
      setTimeout(()=> notice.remove(), 10000);
    }

    function playOrderSound(){
    if(!orderSoundToggle?.checked) return;
      const ctx = getOrderAudioContext();
      if(!ctx) return;
      if(ctx.state === "suspended") ctx.resume().catch(()=>{});

      const scheduleBeep = (startTime, frequency, duration)=>{
        const osc = ctx.createOscillator();
        const gain = ctx.createGain();
        osc.type = "sine";
        osc.frequency.setValueAtTime(frequency, startTime);
        gain.gain.setValueAtTime(0, startTime);
        gain.gain.linearRampToValueAtTime(0.2, startTime + 0.02);
        gain.gain.exponentialRampToValueAtTime(0.0001, startTime + duration);
        osc.connect(gain);
        gain.connect(ctx.destination);
        osc.start(startTime);
        osc.stop(startTime + duration + 0.05);
      };

      const base = ctx.currentTime + 0.02;
      const pattern = [
        { frequency: 880, duration: 0.12, gap: 0.05 },
        { frequency: 660, duration: 0.12, gap: 0.05 },
        { frequency: 990, duration: 0.14, gap: 0.08 },
      ];

      let t = base;
      pattern.forEach(({ frequency, duration, gap })=>{
        scheduleBeep(t, frequency, duration);
        t += duration + gap;
      });
    }
    
    function dayRangeMs(dateStr){
      const start = new Date(dateStr + "T00:00:00").getTime();
      const end   = new Date(dateStr + "T23:59:59.999").getTime();
      return { start, end };
    }

    function itemNoteText(it){
      return (it?.note ?? it?.remark ?? it?.itemNote ?? it?.memo ?? "").toString().trim();
    }

     function formatSetMealText(it){
      const upgrade = it?.upgrade || null;
      if(!upgrade) return "";
      const lines = [];
      const setMealName = (it?.setMeal?.name || "").toString().trim();
      if(setMealName) lines.push(`套餐：${setMealName}`);

      const picks = Array.isArray(upgrade.picks) ? upgrade.picks : [];
      picks.forEach(pick=>{
        const catName = (pick?.categoryName || "類別").toString().trim() || "類別";
        const items = Array.isArray(pick?.items) ? pick.items : [];
        const itemText = items.map(item=>{
          const name = (item?.itemName || "").toString().trim();
          const price = Number(item?.price || 0);
          const childSelections = Array.isArray(item?.childSelections) ? item.childSelections : [];
          const childText = childSelections.map(sel=>{
            const g = (sel?.groupName || "").toString().trim();
            const c = (sel?.choiceName || "").toString().trim();
            const p = Number(sel?.price || 0);
            const base = [g, c].filter(Boolean).join("：");
            return `${base}${p ? `+${p}` : ""}`;
          }).filter(Boolean).join("、");
          const priceText = price ? `+${price}` : "";
          const childBlock = childText ? `（${childText}）` : "";
          return `${name}${priceText}${childBlock}`;
        }).filter(Boolean).join("、");
        if(itemText){
          lines.push(`${catName}：${itemText}`);
        }
      });

      return lines.join("\n").trim();
    }

    function normalizeOrderCoPartners(order){
      const list = Array.isArray(order?.coPartners) ? order.coPartners : [];
      if(list.length) return list;
      if(order?.coDept || order?.coName){
        return [{ dept: order.coDept || "", name: order.coName || "" }];
      }
      return [];
    }

    function formatCoPartnerList(partners = []){
      return partners
        .filter(p=>p?.dept && p?.name)
        .map(p=> `${esc(p.dept)} / ${esc(p.name)}`)
        .join("、");
    }

    function addonText(addons, options = {}){
      const arr = Array.isArray(addons) ? addons : [];
      if(arr.length===0) return "";
      const { hideChoiceTag = false, namesOnly = false } = options;
      return arr.map(a=>{
        const p = Number(a?.price||0);
        if(namesOnly){
         return `${a?.name||""}${p?(" "+p):""}`;
        }
        const group = a?.group ? `(${a.group})` : "";
        const isChoice = a?.kind === "choice";
        const isAddon = a?.kind === "addon";
        if(isChoice && hideChoiceTag){
          return `${group}${a?.name||""}${p?(" "+p):""}`;
        }
        const kind = isChoice ? "擇一" : (isAddon ? "加購" : "");
        const kindTxt = kind ? `[${kind}]` : "";
        return `+${kindTxt}${group}${a?.name||""}${p?(" "+p):""}`;
      }).join(" ");
    }

    function addonUnitSum(addons){
      const arr = Array.isArray(addons) ? addons : [];
      return arr.reduce((s,a)=> s + Number(a?.price||0), 0);
    }

    function addonsKey(addons){
      const arr = Array.isArray(addons) ? addons : [];
      const norm = arr.map(a=>({
        name: (a?.name ?? "").toString(),
        price: Number(a?.price ?? 0),
        kind: (a?.kind ?? "").toString(),
        group: (a?.group ?? "").toString(),
      }));
      norm.sort((x,y)=>{
        const a = `${x.kind}|${x.group}|${x.name}|${x.price}`;
        const b = `${y.kind}|${y.group}|${y.name}|${y.price}`;
        return a.localeCompare(b, "zh-Hant");
      });
      return JSON.stringify(norm);
    }

    function calcOrderTotal(items){
      const arr = Array.isArray(items) ? items : [];
      return arr.reduce((s,it)=>{
        const unitAddon = addonUnitSum(it.addons);
        return s + (Number(it.price||0) + unitAddon) * Number(it.qty||0);
      }, 0);
    }

    // ✅ 訂單排序（畫面與 Excel 共用）：依指定部門順序 + 姓名 + 餐廳 + 時間(新→舊)
    function sortOrdersForDetails(arr){
      const orders = Array.isArray(arr) ? [...arr] : [];
      orders.sort((a,b)=>{
        const da = (a.userDept || "").trim();
        const dbb = (b.userDept || "").trim();

        const ra = deptRank(da);
        const rb = deptRank(dbb);
        if(ra !== rb) return ra - rb;

        const na = (a.userName || "").trim();
        const nb = (b.userName || "").trim();
        if(na !== nb) return na.localeCompare(nb, "zh-Hant");

        const raName = (a.restaurantName || "").trim();
        const rbName = (b.restaurantName || "").trim();
        if(raName !== rbName) return raName.localeCompare(rbName, "zh-Hant");

        return toMs(b.createdAt||0) - toMs(a.createdAt||0);
      });
      return orders;
    }

    // ✅ createdAt 日期區間查詢（給 getDocs 用）
async function loadOrdersByDate(dateStr){
  const { start, end } = dayRangeMs(dateStr);

  const snap = await getDocs(query(
    colOrders,
    where("createdAt", ">=", start),
    where("createdAt", "<=", end),
    orderBy("createdAt", "desc"),
    limit(5000)
  ));

  const orders = [];
  snap.forEach(d => {
    orders.push({
      id: d.id,
      ...(d.data() || {})
    });
  });

  return orders;
}

    async function deleteWholeOrder(orderId){
      if(!confirm("確定刪除整筆訂單？")) return;
      try{
        statusPill.textContent = "刪除訂單中…";
        await deleteDoc(doc(db, "orders", orderId));
        statusPill.textContent = "已刪除訂單 ✅";
      }catch(err){
        console.error(err);
        alert("刪除訂單失敗\n\n" + (err?.message || err));
      }
    }

    async function deleteOrderItem(orderId, itemIndex){
      const o = lastLoadedOrders.find(x=> x.id === orderId);
      if(!o) return alert("找不到該訂單（請重新載入）");

      const items = Array.isArray(o.items) ? [...o.items] : [];
      const it = items[itemIndex];
      if(!it) return;

      if(!confirm(`確定刪除這一道？\n\n${it.name || ""}`)) return;

      items.splice(itemIndex, 1);

      if(items.length === 0){
        if(confirm("此訂單已無餐點，要直接刪除整筆訂單嗎？")){
          await deleteWholeOrder(orderId);
          return;
        }
      }

      const newTotal = calcOrderTotal(items);

      try{
        statusPill.textContent = "更新訂單中…";
        await updateDoc(doc(db,"orders", orderId), {
          items,
          total: newTotal
        });
        statusPill.textContent = "已更新訂單 ✅";
      }catch(err){
        console.error(err);
        alert("刪除餐點失敗（更新訂單失敗）\n\n" + (err?.message || err));
      }
    }

     function getSelectedOrdersMealFilter(){
      const raw = ($("ordersMealFilter")?.value || "lunch").toLowerCase();
      return raw === "dinner" ? "dinner" : "lunch";
    }

    function renderOrdersSummaryAndList(orders){
   const MEAL_SECTIONS = [
        { key: "lunch", label: "午餐" },
        { key: "dinner", label: "晚餐" }
      ];
      const mealFilter = getSelectedOrdersMealFilter();
      const visibleSections = MEAL_SECTIONS.filter(section => section.key === mealFilter);
      
      const getMealPeriod = (order)=>{
        const raw = String(
          order.mealType || order.meal || order.mealPeriod || order.period || ""
        ).trim().toLowerCase();
        if(raw){
          if(raw.includes("晚") || raw.includes("dinner") || raw.includes("evening")) return "dinner";
          if(raw.includes("午") || raw.includes("lunch") || raw.includes("noon")) return "lunch";
        }
         const createdAt = Number(order.createdAt || 0);
        if(createdAt){
          const hour = new Date(createdAt).getHours();
          return hour >= 15 ? "dinner" : "lunch";
        }
        return "lunch";
      };

      const groupOrders = new Map(MEAL_SECTIONS.map(section=>[section.key, []]));
      for(const order of orders){
        const key = getMealPeriod(order);
        (groupOrders.get(key) || groupOrders.get("lunch")).push(order);
      }

      const buildSummarySection = (section, list)=>{
        const agg = new Map();
        let grandTotal = 0;

     for(const o of list){
          const items = Array.isArray(o.items) ? o.items : [];
          let orderTotal = Number(o.total||0);
          if(!orderTotal) orderTotal = calcOrderTotal(items);
          grandTotal += orderTotal;
       
       for(const it of items){
            const rName = o.restaurantName || "";
            const unit = Number(it.price||0);
            const addons = Array.isArray(it.addons) ? it.addons : [];
            const aKey = addonsKey(addons);
            const note = itemNoteText(it);
            const key = `${rName}__${it.name||""}__${unit}__${aKey}__note:${note}`;

            if(!agg.has(key)){
              agg.set(key, { restaurant: rName, item: it.name||"", unit, addons, note, qty: 0 });
            }
            agg.get(key).qty += Number(it.qty||0);
          }
        }

       const summaryRows = Array.from(agg.values())
          .sort((a,b)=> b.qty-a.qty)
          .map(x=>{
            const unitAddon = addonUnitSum(x.addons);
            const addonAmt = unitAddon * x.qty;
            const itemAmt = x.unit * x.qty;
            const total = (x.unit + unitAddon) * x.qty;
            return `
              <tr>
                <td>${esc(x.restaurant)}</td>
                <td>${esc(x.item)}</td>
                <td class="muted">${esc(addonText(x.addons, { namesOnly: true }))}</td>
                <td class="muted">${esc(x.note || "")}</td>
                <td>${x.qty}</td>
                <td>${x.unit}</td>
                <td>${addonAmt}</td>
                <td>${itemAmt}</td>
                <td>${total}</td>
              </tr>
            `;
          }).join("");

      return `
          <div style="margin-top:12px">
            <div class="inline" style="justify-content:space-between; margin-bottom:10px">
              <span class="tag">${esc(section.label)}</span>
              <span class="tag">共 ${list.length} 筆訂單</span>
              <span class="tag">訂單總加總：${grandTotal}</span>
            </div>
            
     <table>
              <thead>
                <tr>
                  <th>餐廳</th>
                  <th>品項</th>
                  <th>加購/擇一</th>
                  <th>餐點備註</th>
                  <th>數量</th>
                  <th>單價</th>
                  <th>加購金額</th>
                  <th>品項金額</th>
                  <th>小計</th>
                </tr>
              </thead>
              <tbody>
                ${summaryRows || `<tr><td colspan="9" class="muted">此日期沒有${esc(section.label)}訂單</td></tr>`}
              </tbody>
            </table>
          </div>
        `;
      };

       const summaryHTML = visibleSections.map(section=>{
        const list = groupOrders.get(section.key) || [];
        return buildSummarySection(section, list);
      }).join("");

      const buildDetailSection = (section, list)=>{
        const detailOrders = sortOrdersForDetails(list);
        const deptMap = new Map();
        for (const o of detailOrders) {
          const dept = (o.userDept || "未分部門").trim() || "未分部門";
          if (!deptMap.has(dept)) deptMap.set(dept, []);
          deptMap.get(dept).push(o);
        }

        const orderedDepts = [
          ...DEPT_ORDER.filter(d => deptMap.has(d)),
          ...Array.from(deptMap.keys()).filter(d => !DEPT_INDEX.has(d))
        ];

        if(orderedDepts.length === 0){
          return `
            <div style="margin-top:12px">
              <div class="inline" style="justify-content:space-between; margin-bottom:10px">
                <span class="tag">${esc(section.label)}</span>
                <span class="tag">共 0 筆訂單</span>
              </div>
              <div class="muted">此日期沒有${esc(section.label)}訂單</div>
            </div>
          `;
        }

        const detailHTML = orderedDepts.map(dept=>{
          const list = deptMap.get(dept) || [];

        const deptInner = list.map(o=>{
          const name = o.userName || "";
          const restaurant = o.restaurantName || "";
          const time = toTWTime(o.createdAt);
          const orderNote = (o.orderNote || o.remark || "");
          const items = Array.isArray(o.items) ? o.items : [];
          const total = Number(o.total||0) || calcOrderTotal(items);
          const budgetLimit = o.coOrderEnabled ? 280 : 140;
          const exceed = total - budgetLimit;
          const totalLabel = exceed > 0 ? `總額 ${total}（超出 ${exceed}）` : `總額 ${total}`;
          const totalTagClass = exceed > 0 ? "tag exceedTag" : "tag";
          const coOrderEnabled = Boolean(o.coOrderEnabled);
          const coPartners = coOrderEnabled ? normalizeOrderCoPartners(o) : [];
          const coText = formatCoPartnerList(coPartners);
          const coCount = coOrderEnabled ? Number(o.coOrderCount || coPartners.length || 2) : 0;
          const coLine = coOrderEnabled && coText
            ? `<div class="muted mini" style="margin-top:6px">共同點餐（${coCount}人）：${coText}</div>`
            : "";
          const coTag = coOrderEnabled && coText
            ? `<span class="tag" style="margin-left:6px">共同點餐 ${coCount}人：${coText}</span>`
            : "";
          
          return `
            <details style="border:1px solid rgba(15,23,42,.10); border-radius:16px; padding:10px 12px; background:#fff; margin-top:10px;">
              <summary>
                <span style="font-size:14px">${esc(name)}｜${esc(restaurant)}</span>
                <span class="tag" style="margin-left:8px">${items.length} 道</span>
                <span class="${totalTagClass}" style="margin-left:6px">${totalLabel}</span>
                <span class="tag" style="margin-left:6px">${esc(time)}</span>
                ${coTag}
              </summary>

              ${orderNote ? `<div class="muted mini" style="margin-top:8px">整單備註：${esc(orderNote)}</div>` : ``}
              ${coLine}
 
              <div class="hr"></div>

              ${items.length===0 ? `<div class="muted">（此訂單沒有餐點）</div>` : `
                <table>
                  <thead>
                    <tr>
                      <th>品項</th>
                      <th>加購/擇一</th>
                      <th>套餐選項</th>
                      <th>餐點備註</th>
                      <th>數量</th>
                      <th>單價</th>
                      <th>小計</th>
                      <th>操作</th>
                    </tr>
                  </thead>
                  <tbody>
                    ${items.map((it,idx)=>{
                      const qty = Number(it.qty||0);
                      const unit = Number(it.price||0);
                      const unitAddon = addonUnitSum(it.addons);
                      const sub = (unit + unitAddon) * qty;
                      const setMealText = formatSetMealText(it);
                      return `
                        <tr>
                          <td><b>${esc(it.name||"")}</b></td>
                          <td class="muted">${esc(addonText(it.addons))}</td>
                          <td class="muted">${setMealText ? esc(setMealText).replace(/\n/g,"<br/>") : ""}</td>
                          <td class="muted">${esc(itemNoteText(it))}</td>
                          <td>${qty}</td>
                          <td>${unit}</td>
                          <td>${sub}</td>
                          <td>
                            <button class="btnSmall btnDanger" type="button"
                              data-del-item="1" data-oid="${o.id}" data-idx="${idx}">刪此一道</button>
                          </td>
                        </tr>
                      `;
                    }).join("")}
                  </tbody>
                </table>
              `}

              <div class="actions">
                <button class="btnSmall btnDanger" type="button" data-del-order="1" data-oid="${o.id}">刪整筆訂單</button>
              </div>
            </details>
          `;
        }).join("");

          return `
            <details style="border:1px solid rgba(15,23,42,.10); border-radius:16px; padding:10px 12px; background:rgba(255,255,255,.9); margin-top:10px;">
              <summary>
                <span style="font-size:14.5px">${esc(dept)}</span>
                <span class="tag" style="margin-left:8px">${list.length} 筆訂單</span>
              </summary>
              <div style="margin-top:10px">
                ${deptInner || `<div class="muted">（此部門沒有訂單）</div>`}
              </div>
            </details>
          `;
        }).join("");
        
        return `
        <div style="margin-top:12px">
            <div class="inline" style="justify-content:space-between; margin-bottom:10px">
              <span class="tag">${esc(section.label)}</span>
              <span class="tag">共 ${list.length} 筆訂單</span>
            </div>
          ${detailHTML}
          </div>
        `;
         };

      const detailHTML = visibleSections.map(section=>{
        const list = groupOrders.get(section.key) || [];
        return buildDetailSection(section, list);
      }).join("");

      return { summaryHTML, detailHTML };
    }

    function bindOrderDeleteButtons(){
      const out = $("ordersDetailOut");
      if(!out) return;

      out.querySelectorAll("[data-del-order]").forEach(btn=>{
        btn.onclick = async ()=>{
          const oid = btn.dataset.oid;
          await deleteWholeOrder(oid);
        };
      });

      out.querySelectorAll("[data-del-item]").forEach(btn=>{
        btn.onclick = async ()=>{
          const oid = btn.dataset.oid;
          const idx = Number(btn.dataset.idx);
          await deleteOrderItem(oid, idx);
        };
      });
    }

    const noOrderBanner = $("noOrderBanner");
    const noOrderModal = $("noOrderModal");
    const noOrderList = $("noOrderList");

    async function checkNotOrderedForDate(dateStr, orders, showModal){
      try{
        if(!Array.isArray(orders)){
          orders = await loadOrdersByDate(dateStr);
        }
        await loadAllStaffOnce();

        if(!noOrderBanner) return;

        const schSnap = await getDoc(doc(db,"schedules", dateStr));
        if(!schSnap.exists()){
          noOrderBanner.className = "alertBar alertWarn";
          noOrderBanner.textContent = "⚠ 今日尚未設定班表，無法判斷誰未點餐（請到「班表管理」設定）。";
          noOrderBanner.style.display = "";
          if(showModal && noOrderModal && noOrderList){
            noOrderList.textContent = "尚未設定今日班表。請先到「班表管理」為此日期勾選休假人員。";
            noOrderModal.style.display = "flex";
          }
          return;
        }

        const data = schSnap.data()||{};
        const restKeys = Array.isArray(data.workerKeys) ? data.workerKeys : [];
        const restSet = new Set(restKeys);
        const allStaffKeys = allStaffBase.map(s=>`${(s.dept||"").trim()}||${(s.name||"").trim()}`)
          .filter(k=>k !== "||");
        const workingKeys = allStaffKeys.filter(k=>!restSet.has(k));
        const workingSet = new Set(workingKeys);
        const morningShiftKeys = getStaffShiftKeySet("morning");
        const filteredWorkerKeys = morningShiftKeys.size
          ? workingKeys.filter(k=>morningShiftKeys.has(k))
          : workingKeys;
        const shiftLabel = morningShiftKeys.size ? "（早班）" : "";
        const orderedSet = new Set();
        
        for(const o of orders){
          const dept = (o.userDept || "").trim();
          const name = (o.userName || "").trim();
          if(!name) continue;
          orderedSet.add(`${dept}||${name}`);
        }

        const missingKeys = [];
        filteredWorkerKeys.forEach(k=>{
          if(!orderedSet.has(k)) missingKeys.push(k);
        });

     const unscheduledKeys = [];
        orderedSet.forEach(k=>{
          if(!workingSet.has(k)) unscheduledKeys.push(k);
        });

        const groupByDept = (keys)=> {
          const byDept = new Map();
          keys.forEach(k=>{
            const [dept,name] = k.split("||");
            const d = (dept || "未分部門");
            if(!byDept.has(d)) byDept.set(d,[]);
            if(name) byDept.get(d).push(name);
          });
          return Array.from(byDept.entries()).map(([dept,names])=>({
            dept,
            names,
          }));
        };
        const renderDeptList = (entries)=> entries.map(({dept, names})=>{
          const nameText = names.join("、");
          return `
            <li>
              <span class="deptTag">${esc(dept)}</span>
              <span class="deptNames">${esc(nameText)}</span>
            </li>
          `;
        }).join("");

        if(missingKeys.length===0 && unscheduledKeys.length===0){
          if(morningShiftKeys.size > 0 && filteredWorkerKeys.length === 0){
            noOrderBanner.className = "alertBar alertWarn";
            noOrderBanner.textContent = "⚠ 今日班表沒有早班人員（已勾選早班）。";
            noOrderBanner.style.display = "";
            if(showModal && noOrderModal && noOrderList){
              noOrderList.textContent = "今日班表沒有早班人員（已勾選早班）。";
              noOrderModal.style.display = "flex";
            }
            }else if(workingKeys.length === 0){
            noOrderBanner.className = "alertBar alertWarn";
            noOrderBanner.textContent = "⚠ 今日班表沒有上班人員（皆為休假）。";
            noOrderBanner.style.display = "";
            if(showModal && noOrderModal && noOrderList){
              noOrderList.textContent = "今日班表沒有上班人員（皆為休假）。";
              noOrderModal.style.display = "flex";
            }
          }else{
            noOrderBanner.className = "alertBar alertOk";
            noOrderBanner.textContent = "✅ 今日所有應上班人員皆已點餐";
            noOrderBanner.style.display = "";
            if(showModal && noOrderModal && noOrderList){
              noOrderList.textContent = "今日所有應上班人員皆已點餐。";
              noOrderModal.style.display = "flex";
            }
          }
          return;
        }

        const bannerParts = [];
        const modalParts = [];
         if(allStaffKeys.length===0){
          bannerParts.push(`<div class="alertTitle">⚠ 尚未建立人員清單，無法統計未點餐。</div>`);
        }else if(workingKeys.length===0){
          bannerParts.push(`<div class="alertTitle">⚠ 今日班表沒有上班人員（皆為休假）。</div>`);
        }
         if(morningShiftKeys.size > 0 && filteredWorkerKeys.length === 0){
          bannerParts.push(`<div class="alertTitle">⚠ 今日班表沒有早班人員（已勾選早班）。</div>`);
        }
        if(missingKeys.length>0){
          const deptListHtml = renderDeptList(groupByDept(missingKeys));
          bannerParts.push(`
           <div class="alertTitle">🔔 今日尚有 <b>${missingKeys.length}</b> 人未點餐${shiftLabel}</div>
            <ul class="noOrderDeptList">
              ${deptListHtml}
            </ul>
          `);
           modalParts.push(`
            <p class="muted">今日尚有 <b>${missingKeys.length}</b> 人未點餐${shiftLabel}：</p>
            <ul class="noOrderDeptList mini">
              ${deptListHtml}
            </ul>
            <p class="muted mini">提醒：名單來源為「班表管理」中此日期未勾選休假的人${shiftLabel ? "，且需在「人員清單」勾選早班" : ""}。</p>
          `);
        }

          if(unscheduledKeys.length>0){
          const deptListHtml = renderDeptList(groupByDept(unscheduledKeys));
          bannerParts.push(`
            <div class="alertTitle">⛔ 有 <b>${unscheduledKeys.length}</b> 位點餐人員不在班表</div>
            <ul class="noOrderDeptList">
              ${deptListHtml}
            </ul>
            `);
              modalParts.push(`
            <p class="muted">有 <b>${unscheduledKeys.length}</b> 位點餐人員不在班表：</p>
            <ul class="noOrderDeptList mini">
              ${deptListHtml}
            </ul>
          `);
        }
        
        noOrderBanner.className = "alertBar alertWarn";
        noOrderBanner.innerHTML = bannerParts.join("");
        noOrderBanner.style.display = "";
         if(showModal && noOrderModal && noOrderList && modalParts.length>0){
          noOrderList.innerHTML = modalParts.join("");
          noOrderModal.style.display = "flex";
        }
      }catch(err){
        console.error(err);
        if(noOrderBanner){
          noOrderBanner.className = "alertBar alertWarn";
          noOrderBanner.textContent = "無法取得班表或訂單資料（請查看 console）。";
          noOrderBanner.style.display = "";
        }
      }
    }
    
// ✅ 結單視窗用：計算「你打勾但尚未點餐的人」
async function updateCloseConfirmNoOrder(){
  const box = $("closeConfirmNoOrder");
  if(!box) return;

  box.textContent = "本日上班未點餐紀錄：計算中…";

  try{
    const dateStr = todayISO();

    // 取得今天所有訂單
    const orders = await loadOrdersByDate(dateStr);
    const orderedSet = new Set();
    for(const o of orders){
      const dept = (o.userDept || "").trim();
      const name = (o.userName || "").trim();
      if(name) orderedSet.add(`${dept}||${name}`);
    }

    // 取得你勾選的上班人員（data-k="isClosed"）
    const workingKeys = [];
    document.querySelectorAll('input[data-k="isClosed"]').forEach(cb=>{
      if(cb.checked){
        const dept = cb.dataset.dept || "";
        const name = cb.dataset.name || "";
        if(name) workingKeys.push(`${dept}||${name}`);
      }
    });

    if(workingKeys.length === 0){
      box.textContent = "尚未勾選今日上班人員。";
      return;
    }

    // 計算未點餐
    const missing = [];
    workingKeys.forEach(k=>{
      if(!orderedSet.has(k)) missing.push(k);
    });

    if(missing.length === 0){
      box.textContent = "✅ 今日所有上班人員皆已點餐。";
      return;
    }

    // 依部門分組
    const byDept = new Map();
    missing.forEach(k=>{
      const [dept,name] = k.split("||");
      const d = dept || "未分部門";
      if(!byDept.has(d)) byDept.set(d, []);
      byDept.get(d).push(name);
    });

    const lines = Array.from(byDept.entries())
      .map(([dept,names]) => `${dept}：${names.join("、")}`);

    box.innerHTML = `
      <div style="margin-bottom:4px;">本日上班未點餐紀錄：</div>
      <ul class="mini">${lines.map(l=>`<li>${esc(l)}</li>`).join("")}</ul>
    `;

  }catch(err){
    console.error(err);
    box.textContent = "⚠ 無法取得資料（請查看 console）。";
  }
}

    $("btnCloseNoOrder")?.addEventListener("click", ()=>{
      if(noOrderModal) noOrderModal.style.display = "none";
    });
    noOrderModal?.addEventListener("click", (e)=>{
      if(e.target.id === "noOrderModal"){
        noOrderModal.style.display = "none";
      }
    });

   // ✅ 訂單即時監聽（管理者後台）
async function setupOrdersLive(dateStr){
  // 先把舊的監聽關掉
  if (ordersUnsub) {
    ordersUnsub();
    ordersUnsub = null;
  }
  ordersLiveReady = false;

  const { start, end } = dayRangeMs(dateStr);

  const qOrders = query(
    colOrders,
    where("createdAt", ">=", start),
    where("createdAt", "<=", end),
    orderBy("createdAt", "desc"),
    limit(5000)
  );

  statusPill.textContent = "讀取訂單中…";

  ordersUnsub = onSnapshot(
    qOrders,
    (snap)=>{
      (async ()=>{
         const addedOrders = snap.docChanges()
          .filter(change=> change.type === "added")
          .map(change=> ({ id: change.doc.id, data: change.doc.data() || {} }));

        const orders = [];
        snap.forEach(d=>{
          const v = d.data() || {};
          orders.push({
            id: d.id,
            ...v
          });
        });

        // 快取
        lastLoadedOrders = orders;

        // 畫面輸出
        if (!orders.length) {
          $("ordersSummaryOut").innerHTML = `<div class="muted">此日期沒有訂單</div>`;
          $("ordersDetailOut").innerHTML = `<div class="muted">此日期沒有訂單</div>`;
          statusPill.textContent = "已載入（目前無訂單）";
        } else {
          const { summaryHTML, detailHTML } = renderOrdersSummaryAndList(orders);
          $("ordersSummaryOut").innerHTML = summaryHTML;
          $("ordersDetailOut").innerHTML = detailHTML;
          bindOrderDeleteButtons();
          statusPill.textContent = "已載入 ✅";
        }

        // 檢查「未點餐的人員」
        await checkNotOrderedForDate(dateStr, orders, false);
        
        const shouldNotify = ordersLiveReady && addedOrders.length > 0;
        if(shouldNotify){
          addedOrders.forEach(({ data })=>{
            const user = (data.userName || "").trim();
            const rest = (data.restaurantName || "").trim();
            const info = [user, rest].filter(Boolean).join(" / ") || "有新訂單";
            pushOrderNotice("🔔 新訂單", info);
          });
          playOrderSound();
        }
        ordersLiveReady = true;
      })().catch(console.error);
    },
    (err)=>{
      console.error(err);
      $("ordersSummaryOut").innerHTML =
        `<div class="muted">讀取訂單失敗<br/>${esc(err?.message || err)}</div>`;
      $("ordersDetailOut").innerHTML =
        `<div class="muted">讀取訂單失敗<br/>${esc(err?.message || err)}</div>`;
      alert("讀取訂單失敗\n\n" + (err?.message || err));
      statusPill.textContent = "讀取失敗（看 console）";
    }
  );
}

    // ✅ 進入後台即啟用：確保任何頁面都能收到新訂單通知
    (async ()=>{
      try{
        await loadAllStaffOnce();
        await setupOrdersLive(todayISO());
      }catch(err){
        console.error(err);
      }
    })();

    $("btnLoadOrders").onclick = async ()=>{
      const date = $("o_date").value;
      if(!date) return alert("請選日期");

      try{
        statusPill.textContent = "載入訂單中…";
        await loadAllStaffOnce(); // 讓未點餐提示有 staff 名單
        await setupOrdersLive(date); // 會自動更新畫面 + 未點餐提醒（B）
      }catch(err){
        console.error(err);
        $("ordersSummaryOut").innerHTML = `<div class="muted">讀取訂單失敗<br/>${esc(err?.message || err)}</div>`;
        $("ordersDetailOut").innerHTML = `<div class="muted">讀取訂單失敗<br/>${esc(err?.message || err)}</div>`;
        alert("讀取訂單失敗\n\n" + (err?.message || err));
        statusPill.textContent = "讀取失敗（看 console）";
      }
    };

     $("ordersMealFilter")?.addEventListener("change", ()=>{
      if(!Array.isArray(lastLoadedOrders) || lastLoadedOrders.length === 0) return;
      const { summaryHTML, detailHTML } = renderOrdersSummaryAndList(lastLoadedOrders);
      $("ordersSummaryOut").innerHTML = summaryHTML;
      $("ordersDetailOut").innerHTML = detailHTML;
      bindOrderDeleteButtons();
    });

    $("btnExportExcel").onclick = async ()=>{
      const date = $("o_date").value;
      if(!date) return alert("請選日期");

      try{
        await loadAllStaffOnce();
        // 匯出前先做一次強提醒（A）
        await checkNotOrderedForDate(date, lastLoadedOrders, true);

        statusPill.textContent = "準備 Excel…";

        let orders = lastLoadedOrders;
        if(!Array.isArray(orders) || orders.length===0){
          orders = await loadOrdersByDate(date);
          lastLoadedOrders = orders;
        }
        if(!orders || orders.length===0) return alert("此日期沒有訂單可匯出");

        // ✅ 依你原本排序（部門順序 + 姓名 + 餐廳 + 時間）
        const sorted = sortOrdersForDetails(orders);

        // ✅ Person Map：key=dept||name
        const personMap = new Map();

        for(const o of sorted){
          const dept = (o.userDept || "未分部門").trim() || "未分部門";
          const name = (o.userName || "").trim();
          const restaurant = (o.restaurantName || "").trim();
          if(!name) continue;

          const pKey = `${dept}||${name}`;
          if(!personMap.has(pKey)){
            personMap.set(pKey, { dept, name, restMap: new Map(), totalAmountAll: 0 });
          }
          const p = personMap.get(pKey);

          if(!p.restMap.has(restaurant)){
            p.restMap.set(restaurant, { total: 0, items: [] });
          }
          const rObj = p.restMap.get(restaurant);

          const items = Array.isArray(o.items) ? o.items : [];
          const coOrderEnabled = Boolean(o.coOrderEnabled);
          const coPartners = coOrderEnabled ? normalizeOrderCoPartners(o) : [];
          const coDept = coPartners.map(p=> (p?.dept || "").trim()).filter(Boolean).join("、");
          const coName = coPartners.map(p=> (p?.name || "").trim()).filter(Boolean).join("、");
          for(const it of items){
            const qty = Number(it.qty || 0);
            const unit = Number(it.price || 0);
            const addonUnit = addonUnitSum(it.addons);
            const amount = (unit + addonUnit) * qty;

            const rowItem = {
              itemName: it.name || "",
              addonText: addonText(it.addons, { namesOnly: true }),
              setMealText: formatSetMealText(it),
              note: itemNoteText(it),
              amount,
              coDept,
              coName,
            };

            rObj.items.push(rowItem);
            rObj.total += amount;

            p.totalAmountAll += amount;
          }
        }

        // ✅ 排序人員：部門順序 → 姓名
        const persons = Array.from(personMap.values());
        persons.sort((a,b)=>{
          const ra = deptRank(a.dept), rb = deptRank(b.dept);
          if(ra !== rb) return ra - rb;
          return (a.name||"").localeCompare((b.name||""), "zh-Hant");
        });

        // ========= Sheet 1：總表（每人一列） =========
        const summaryRows = [];
        let personNo = 0;
        let lastDeptSummary = null;

        for(const p of persons){
          personNo += 1;

          // ✅ 應收：每家餐廳各扣一次 140
          let receivableAll = 0;
          for(const [rest, rObj] of p.restMap.entries()){
            receivableAll += Math.max(Number(rObj.total || 0) - 140, 0);
          }

          const showDept = p.dept !== lastDeptSummary;

          summaryRows.push({
            "人數": personNo,
            "部門": showDept ? p.dept : "",
            "姓名": p.name,
            "總金額": Number(p.totalAmountAll || 0),
            "總應收": Number(receivableAll || 0),
          });

          lastDeptSummary = p.dept;
        }

        const summaryHeader = ["人數","部門","姓名","總金額","總應收"];
        const wsSummary = XLSX.utils.json_to_sheet(summaryRows, { header: summaryHeader });
        wsSummary["!freeze"] = { xSplit: 0, ySplit: 1 };
        const rangeS = XLSX.utils.decode_range(wsSummary["!ref"]);
        wsSummary["!autofilter"] = { ref: XLSX.utils.encode_range({ s:{r:0,c:0}, e:{r:rangeS.e.r,c:rangeS.e.c} }) };
        wsSummary["!cols"] = [
          { wch: 6 },
          { wch: 10 },
          { wch: 12 },
          { wch: 10 },
          { wch: 10 },
        ];

        // ========= Sheet 2：明細（逐品項） =========
        const detailRows = [];
        personNo = 0;
        let lastDeptDetail = null;

        for(const p of persons){
          personNo += 1;

          const showDept = p.dept !== lastDeptDetail;

          const rests = Array.from(p.restMap.entries()).sort((a,b)=>{
            return (a[0]||"").localeCompare((b[0]||""), "zh-Hant");
          });

          let firstLineOfPerson = true;

          for(const [restName, rObj] of rests){
            const receivableThisRest = Math.max(Number(rObj.total || 0) - 140, 0);
            const list = Array.isArray(rObj.items) ? rObj.items : [];

            if(list.length === 0){
              detailRows.push({
                "人數": firstLineOfPerson ? personNo : "",
                "部門": (firstLineOfPerson && showDept) ? p.dept : "",
                "姓名": firstLineOfPerson ? p.name : "",
                "共同點餐部門": "",
                "共同點餐人員": "",
                "品項": "",
                "加購/擇一": "",
                "套餐選項": "",
                "餐點備註": "",
                "金額": 0,
                "應收": receivableThisRest
              });
              firstLineOfPerson = false;
              continue;
            }

            list.forEach((it, idx)=>{
              detailRows.push({
                "人數": (firstLineOfPerson && idx===0) ? personNo : "",
                "部門": (firstLineOfPerson && idx===0 && showDept) ? p.dept : "",
                "姓名": (firstLineOfPerson && idx===0) ? p.name : "",
                "共同點餐部門": it.coDept || "",
                "共同點餐人員": it.coName || "",
                "品項": it.itemName,
                "加購/擇一": it.addonText,
                "套餐選項": it.setMealText || "",
                "餐點備註": it.note,
                "金額": it.amount,
                "應收": idx === 0 ? receivableThisRest : ""
              });
            });

            firstLineOfPerson = false;
          }

          lastDeptDetail = p.dept;
        }

        const detailHeader = ["人數","部門","姓名","共同點餐部門","共同點餐人員","品項","加購/擇一","套餐選項","餐點備註","金額","應收"];
        const wsDetail = XLSX.utils.json_to_sheet(detailRows, { header: detailHeader });
        wsDetail["!freeze"] = { xSplit: 0, ySplit: 1 };
        const rangeD = XLSX.utils.decode_range(wsDetail["!ref"]);
        wsDetail["!autofilter"] = { ref: XLSX.utils.encode_range({ s:{r:0,c:0}, e:{r:rangeD.e.r,c:rangeD.e.c} }) };
        wsDetail["!cols"] = [
          { wch: 6 },
          { wch: 10 },
          { wch: 12 },
          { wch: 14 },
          { wch: 16 },
          { wch: 24 },
          { wch: 28 },
          { wch: 28 },
          { wch: 18 },
          { wch: 10 },
          { wch: 10 },
        ];

        const wb = XLSX.utils.book_new();
        XLSX.utils.book_append_sheet(wb, wsSummary, "總表(每人一列)");
        XLSX.utils.book_append_sheet(wb, wsDetail, "明細(逐品項)");

        XLSX.writeFile(wb, `GoldBricks_應收_${date}.xlsx`);
        statusPill.textContent = "Excel 已匯出 ✅";

      }catch(err){
        console.error(err);
        alert("匯出失敗\n\n" + (err?.message || err));
        statusPill.textContent = "匯出失敗（看 console）";
      }
    };
    
// ========= 結單確認（簡單版） =========

// 暫存剛剛被勾選的「結單」 checkbox
let pendingCloseCheckbox = null;

// 監聽所有變更事件，抓到 data-k="isClosed" 的勾勾
document.addEventListener("change", (e) => {
  const cb = e.target;
  if (!(cb instanceof HTMLInputElement)) return; // 不是 input 就掰
  if (cb.type !== "checkbox") return;            // 不是 checkbox 掰
  if (cb.dataset.k !== "isClosed") return;       // 只處理 結單 的勾勾

  // 只有「勾起來」時要跳視窗，取消勾選就直接放過
  if (!cb.checked) return;

  pendingCloseCheckbox = cb;

  const modal = document.getElementById("closeConfirmModal");
  if (!modal) return;

  // 顯示彈跳窗在畫面正中央
  modal.style.display = "flex";

  // 加上動畫 class（對應你上面 CSS 的 .modalMask.fadeIn / .modalBox.popIn）
  modal.classList.add("fadeIn");
  const box = modal.querySelector(".modalBox");
  if (box) box.classList.add("popIn");
});

// 「先不要」→ 關閉視窗 + 把勾勾取消
document.getElementById("btnCancelClose")?.addEventListener("click", () => {
  const modal = document.getElementById("closeConfirmModal");
  if (modal) {
    modal.style.display = "none";
    modal.classList.remove("fadeIn");
    const box = modal.querySelector(".modalBox");
    if (box) box.classList.remove("popIn");
  }

  if (pendingCloseCheckbox) {
    pendingCloseCheckbox.checked = false; // 還原成沒結單
    pendingCloseCheckbox = null;
  }
});

// 「確定結單」→ 關閉視窗，但保留勾勾（真的結單）
document.getElementById("btnConfirmClose")?.addEventListener("click", () => {
  const modal = document.getElementById("closeConfirmModal");
  if (modal) {
    modal.style.display = "none";
    modal.classList.remove("fadeIn");
    const box = modal.querySelector(".modalBox");
    if (box) box.classList.remove("popIn");
  }

  // 保留 checked 狀態就好
  pendingCloseCheckbox = null;
});

</script>
</body>
</html>
