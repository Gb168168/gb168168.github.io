<!doctype html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>GoldBricks å‘·å¥”ğŸš 2ï½œä½¿ç”¨è€…</title>

  <style>
    :root{
      /* âœ… æ¸…çˆ½ï¼šé™ä½æ¼¸å±¤ã€æé«˜ç™½åº•å±¤æ¬¡ã€æ¸›å°‘é™°å½± */
      --bg:#f3f5f9;
      --panel:#f7f8fc;
      --card:#ffffff;
      --text:#0b1220;
      --muted:#5b6678;

      --accent:#fb7185;
      --accent2:#ff9a9e;
      --accentSoft:rgba(251,113,133,.10);

      --border:rgba(15,23,42,.10);
      --border2:rgba(15,23,42,.16);
      --shadow:0 10px 22px rgba(2,6,23,.07);
      --radius:18px;

      --ok:#16a34a;
      --warn:#f59e0b;
      --danger:#ef4444;

      --focus:rgba(251,113,133,.55);
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      font-family: ui-sans-serif, system-ui, -apple-system, "Segoe UI", Arial;
      background:
        radial-gradient(1000px 520px at 20% -12%, rgba(251,113,133,.10), transparent 60%),
        radial-gradient(900px 520px at 110% 0%, rgba(99,102,241,.08), transparent 55%),
        linear-gradient(180deg, var(--panel) 0%, var(--bg) 60%, var(--bg) 100%);
      color:var(--text);
      min-height:100vh;
    }
    .wrap{max-width:1300px; margin:0 auto; padding:16px;}

    /* âœ… topbar sticky */
    .topbar{
      position:sticky; top:0; z-index:999;
      background: rgba(255,255,255,.92);
      border:1px solid var(--border);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      backdrop-filter: blur(10px);
      padding:12px 14px;
      display:flex; align-items:center; justify-content:space-between; gap:12px;
      margin-bottom:14px;
    }
    .topbar h1{font-size:16.5px; margin:0}
    .right{display:flex; gap:10px; align-items:center; flex-wrap:wrap}

    .pill{
      padding:8px 12px; border-radius:999px;
      border:1px solid var(--border2);
      background:#fff; color:var(--muted);
      font-size:12.5px;
    }
    .tag{
      display:inline-flex; padding:5px 10px; border-radius:999px;
      border:1px solid var(--border2);
      background:#fff; color:var(--muted);
      font-size:12px;
      white-space:nowrap;
    }
    .muted{color:var(--muted); font-size:12.5px; line-height:1.6}
    .hr{height:1px; background: var(--border); margin:12px 0}

    .btn{
      padding:9px 12px; border-radius:14px; border:1px solid var(--border2);
      background:#fff; cursor:pointer; font-weight:900;
    }
    .btn:hover{filter:brightness(.99)}
    .primary{
      padding:9px 12px; border-radius:14px; border:none; cursor:pointer; font-weight:900;
      background: linear-gradient(90deg, var(--accent), var(--accent2));
      color:#fff; box-shadow: 0 12px 22px rgba(251,113,133,.15);
    }
    .primary:hover{filter:saturate(1.03)}
    .danger{border-color: rgba(239,68,68,.42)}
    .btn:disabled,.primary:disabled{opacity:.55; cursor:not-allowed}

    .grid{display:grid; grid-template-columns: 360px 1fr; gap:14px}
    @media (max-width:980px){.grid{grid-template-columns:1fr}}

    .card{
      background:var(--card);
      border:1px solid var(--border);
      border-radius:var(--radius);
      box-shadow: 0 8px 18px rgba(2,6,23,.06);
      padding:14px;
    }
    .card h2{margin:0 0 10px; font-size:15px}

    label{display:block; font-size:13px; color:var(--muted); margin:10px 0 6px;}
    input,select,textarea{
      width:100%; padding:11px 12px; border-radius:14px;
      border:1px solid var(--border2); outline:none; background:#fff;
      font-size:14px;
    }
    textarea{min-height:86px; resize:vertical}
    input:focus,select:focus,textarea:focus{
      border-color: var(--focus);
      box-shadow:0 0 0 4px rgba(251,113,133,.10)
    }

    details > summary{
      cursor:pointer;
      list-style:none;
      user-select:none;
    }
    details > summary::-webkit-details-marker{display:none}

    .box{
      border:1px solid rgba(15,23,42,.10);
      border-radius:16px;
      padding:12px;
      background:#fff;
      margin-top:10px;
    }
    .listLine{
      border:1px solid rgba(15,23,42,.10);
      border-radius:14px;
      padding:10px 12px;
      background:#fff;
      margin-top:10px;
    }
    .menuItem{
      border:1px solid rgba(15,23,42,.10);
      border-radius:14px;
      padding:10px 12px;
      background:#fff;
      margin-top:10px;
    }
    .inline{display:flex; gap:10px; align-items:center; flex-wrap:wrap}
    .row{display:grid; grid-template-columns: 1fr 1fr; gap:10px}
    @media (max-width:980px){.row{grid-template-columns:1fr}}

    .priceTag{color:#fff; background:linear-gradient(90deg,var(--accent),var(--accent2)); border:none}
    .lockTag{color:#92400e; background:rgba(245,158,11,.16); border:1px solid rgba(245,158,11,.32)}
    .okTag{color:#065f46; background:rgba(16,185,129,.12); border:1px solid rgba(16,185,129,.26)}

    /* ===== âœ… Restaurant Cards (æ¸…çˆ½ list style) ===== */
    .rGrid{
      display:grid;
      grid-template-columns: 1fr;
      gap:10px;
      margin-top:10px;
    }

    .rCard{
      border:1px solid rgba(15,23,42,.10);
      border-radius:16px;
      background:#fff;
      box-shadow: 0 8px 18px rgba(2,6,23,.05);
      overflow:hidden;

      display:grid;
      grid-template-columns: 108px 1fr;
      gap:12px;

      padding:10px;
      cursor:pointer;
    }
    .rCard:hover{ filter:brightness(.995); }

    .rThumb{
      position:relative;
      width:108px;
      height:92px;
      border-radius:14px;
      overflow:hidden;
      background: linear-gradient(120deg, rgba(251,113,133,.08), rgba(99,102,241,.08));
      flex:0 0 auto;
    }
    .rThumb img{
      width:100%;
      height:100%;
      object-fit:cover;
      display:block;
    }

    /* âœ… ç‹€æ…‹åªé¡¯ç¤ºä¸€æ¬¡ï¼šåªç•™ badgeï¼ˆä¸å†é‡è¤‡æ”¾ tagï¼‰ */
    .rBadge{
      position:absolute;
      left:8px; top:8px;
      padding:5px 9px;
      border-radius:999px;
      font-size:12px;
      font-weight:900;
      border:1px solid rgba(15,23,42,.12);
      background:#fff;
    }
    .rBadge.ok{
      color:#065f46;
      background:rgba(16,185,129,.12);
      border-color:rgba(16,185,129,.26);
    }
    .rBadge.lock{
      color:#92400e;
      background:rgba(245,158,11,.16);
      border-color:rgba(245,158,11,.32);
    }

    .rBody{ padding:0; }
    .rTitleRow{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:8px;
    }
    .rName{ font-size:15px; }
    .rMeta{ margin-top:6px; }
    .rMeta .muted{ margin-top:4px; }

    .rMap{
      display:inline-block;
      margin-top:6px;
      font-size:12.5px;
      color:#334155;
      text-decoration:none;
    }
    .rMap:hover{ text-decoration:underline; }

    .rActions{
      margin-top:8px;
      display:flex;
      justify-content:flex-end;
      gap:8px;
    }

    @media (max-width:420px){
      .rCard{ grid-template-columns: 92px 1fr; }
      .rThumb{ width:92px; height:84px; }
    }
  </style>
</head>

<body>
  <div class="wrap">

    <div class="topbar">
      <div>
        <h1>ä½¿ç”¨è€…é»é¤</h1>
        <div class="muted" id="whoLine">å°šæœªé¸æ“‡ä½¿ç”¨è€…</div>
      </div>

      <div class="right">
        <span class="pill" id="statusPill">é€£ç·šä¸­â€¦</span>

        <div class="inline">
          <input id="adminPin" placeholder="è¼¸å…¥ 8520 åˆ‡åˆ°ç®¡ç†è€…" style="width:220px"/>
          <button class="btn" id="btnGoAdmin">åˆ‡æ›ç®¡ç†è€…</button>
        </div>

        <button class="btn" id="btnLogout">ç™»å‡º</button>
      </div>
    </div>

    <div class="grid">

      <!-- LEFT -->
      <div>

        <div class="card">
          <h2>1ï¼‰é¸æ“‡ä½¿ç”¨è€…ï¼ˆå¿…å¡«ï¼‰</h2>

          <label>éƒ¨é–€</label>
          <select id="deptSelect">
            <option value="">è¼‰å…¥ä¸­â€¦</option>
          </select>

          <label>å§“å</label>
          <select id="nameSelect" disabled>
            <option value="">è«‹å…ˆé¸éƒ¨é–€</option>
          </select>

          <div class="hr"></div>
          <div class="muted">æç¤ºï¼šå¿…é ˆå…ˆé¸ã€Œéƒ¨é–€ + å§“åã€æ‰èƒ½é»é¤ã€‚</div>
        </div>

        <div class="card" style="margin-top:14px">
          <h2>2ï¼‰åº—å®¶åˆ—è¡¨ï¼ˆå¡ç‰‡å¼ / æ”¶åˆï¼‰</h2>

          <!-- âœ… é è¨­æ”¶åˆ -->
          <details class="box">
            <summary>
              <b>å¯é»é¤åº—å®¶</b>
              <span class="tag" id="rCount" style="margin-left:8px">0 é–“</span>
            </summary>
            <div id="restaurantGrid" class="rGrid"></div>
          </details>

          <div class="hr"></div>

          <div class="inline">
            <span class="tag">ç›®å‰åº—å®¶</span>
            <b id="pickedRestaurantName">å°šæœªé¸æ“‡</b>
            <span id="pickedRestaurantState" class="tag" style="display:none"></span>
          </div>
        </div>

        <div class="card" style="margin-top:14px">
          <h2>3ï¼‰è³¼ç‰©è»Šï¼ˆé€å‡ºå‰å¯åˆªï¼‰</h2>
          <div id="cartWrap" class="muted">å°šæœªåŠ å…¥é¤é»ã€‚</div>

          <label style="margin-top:12px">æ•´ç­†å‚™è¨»ï¼ˆEnter ç›´æ¥é€å‡ºï¼‰</label>
          <input id="orderNote" placeholder="ä¾‹ï¼šè«‹ä¸€èµ·è£è¢‹ / ä¸è¦é¤å…·"/>

          <div class="inline" style="margin-top:12px">
            <button class="primary" id="btnSubmit" disabled>é€å‡ºè¨‚å–®</button>
            <button class="btn danger" id="btnClearCart" disabled>æ¸…ç©ºè³¼ç‰©è»Š</button>
            <span class="tag priceTag" id="cartTotal">ç¸½é¡ï¼š0</span>
          </div>
          <div class="muted" style="margin-top:8px">â€» é€å‡ºå¾Œï¼Œæœƒå‡ºç¾åœ¨å³å´ã€Œæˆ‘çš„è¨‚é¤ç´€éŒ„ã€ã€‚</div>
        </div>

      </div>

      <!-- RIGHT -->
      <div>

        <div class="card">
          <h2>4ï¼‰é¤é»æ¸…å–®ï¼ˆé¡åˆ¥æ”¶åˆï¼‰</h2>
          <div id="menuWrap" class="muted">è«‹å…ˆé¸æ“‡åº—å®¶ã€‚</div>
        </div>

        <div class="card" style="margin-top:14px">
          <h2>5ï¼‰æˆ‘çš„è¨‚é¤ç´€éŒ„ï¼ˆå¯åˆªï¼šæœªçµå–®æ‰å¯ï¼‰</h2>
          <div class="inline">
            <button class="btn" id="btnReloadMy">é‡æ–°è¼‰å…¥</button>
            <button class="btn" id="btnToday">ğŸ²</button>
            <input id="myDate" type="date" style="width:auto; min-width:170px"/>
          </div>
          <div class="hr"></div>
          <div id="myOrdersWrap" class="muted">å°šç„¡è³‡æ–™ã€‚</div>
        </div>

      </div>

    </div>
  </div>

  <script type="module">
    // ===== Role Gate =====
    const roleKey = "gb_role";
    if (!localStorage.getItem(roleKey)) localStorage.setItem(roleKey, "user");
    if (localStorage.getItem(roleKey) !== "user") location.href = "./index.html";

    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-app.js";
    import {
      getFirestore, collection, addDoc, doc, getDocs, getDoc, deleteDoc,
      query, where, limit
    } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyBdgOddTGAfqqHLnhnaJRv2_y7gyweuQEo",
      authDomain: "goldbricks-order.firebaseapp.com",
      projectId: "goldbricks-order",
      storageBucket: "goldbricks-order.firebasestorage.app",
      messagingSenderId: "463709758954",
      appId: "1:463709758954:web:429dc920f2f812d51cbe93",
      measurementId: "G-YQK8ZCC26R"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    const $ = (id)=> document.getElementById(id);
    const statusPill = $("statusPill");
    const esc = (s)=> (s??"").toString()
      .replaceAll("&","&amp;").replaceAll("<","&lt;").replaceAll(">","&gt;").replaceAll('"',"&quot;");

    const todayISO = ()=>{
      const d = new Date(); const pad = (n)=> String(n).padStart(2,"0");
      return `${d.getFullYear()}-${pad(d.getMonth()+1)}-${pad(d.getDate())}`;
    };

    function setWhoLine(){
      const dept = $("deptSelect").value || "";
      const name = $("nameSelect").value || "";
      $("whoLine").innerHTML = (dept && name)
        ? `<span class="tag">ä½¿ç”¨è€…</span> <b style="margin-left:6px">${esc(dept)} / ${esc(name)}</b>`
        : `å°šæœªé¸æ“‡ä½¿ç”¨è€…`;
    }

    statusPill.textContent = "å·²é€£ç·š Firestore âœ…";

    // ===== Collections =====
    const colStaff = collection(db, "staff");
    const colRestaurants = collection(db, "restaurants");
    const colOrders = collection(db, "orders");

    // ===== State =====
    let staffByDept = {};
    let restaurants = [];
    let selectedRestaurantId = "";
    let selectedRestaurant = null;
    let menuCache = [];
    let cart = [];

    // ===== âœ… Helpers: group enabled/disabled =====
    // æ”¯æ´ç®¡ç†ç«¯å¸¸è¦‹æ¬„ä½ï¼šenabled / isEnabled / use / isUse
    function groupEnabled(g){
      if(!g) return false;
      const v =
        (g.enabled ?? g.isEnabled ?? g.use ?? g.isUse ?? true);
      return v !== false; // åªè¦ä¸æ˜¯ false å°±è¦–ç‚ºå•Ÿç”¨
    }

    // ===== Staff =====
    async function loadStaff(){
      try{
        statusPill.textContent = "è¼‰å…¥äººå“¡ä¸­â€¦";
        const snap = await getDocs(colStaff);
        const map = {};
        snap.forEach(d=>{
          const v = d.data() || {};
          const dept = (v.dept || "æœªåˆ†éƒ¨é–€").trim();
          const name = (v.name || "").trim();
          if(!name) return;
          if(!map[dept]) map[dept] = [];
          map[dept].push({ id:d.id, name, order: Number(v.order||0), createdAt:Number(v.createdAt||0) });
        });

        Object.keys(map).forEach(dept=>{
          map[dept].sort((a,b)=>{
            const ao=a.order||0, bo=b.order||0;
            if(ao!==bo) return ao-bo;
            return (a.name||"").localeCompare((b.name||""),"zh-Hant");
          });
        });

        staffByDept = map;

        const depts = Object.keys(map).sort((a,b)=> a.localeCompare(b,"zh-Hant"));
        const deptSel = $("deptSelect");
        deptSel.innerHTML = `<option value="">è«‹é¸æ“‡</option>` + depts.map(d=>`<option value="${esc(d)}">${esc(d)}</option>`).join("");

        const savedDept = localStorage.getItem("gb_user_dept") || "";
        const savedName = localStorage.getItem("gb_user_name") || "";
        if(savedDept && staffByDept[savedDept]){
          deptSel.value = savedDept;
          renderNameSelect(savedDept);
          if(savedName && staffByDept[savedDept].some(x=>x.name===savedName)){
            $("nameSelect").value = savedName;
          }
        }else{
          renderNameSelect("");
        }

        setWhoLine();
        statusPill.textContent = "äººå“¡è¼‰å…¥å®Œæˆ âœ…";
      }catch(err){
        console.error(err);
        statusPill.textContent = "äººå“¡è®€å–å¤±æ•—";
        alert("äººå“¡è®€å–å¤±æ•—ï¼ˆRules/ç¶²è·¯ï¼‰\n\n" + (err?.message || err));
      }
    }

    function renderNameSelect(dept){
      const nameSel = $("nameSelect");
      if(!dept || !staffByDept[dept]){
        nameSel.disabled = true;
        nameSel.innerHTML = `<option value="">è«‹å…ˆé¸éƒ¨é–€</option>`;
        return;
      }
      nameSel.disabled = false;
      nameSel.innerHTML = `<option value="">è«‹é¸æ“‡</option>` + staffByDept[dept].map(p=>
        `<option value="${esc(p.name)}">${esc(p.name)}</option>`
      ).join("");
    }

    // ===== Restaurants =====
    async function loadRestaurants(){
      try{
        statusPill.textContent = "è¼‰å…¥åº—å®¶ä¸­â€¦";
        const snap = await getDocs(colRestaurants);
        const list = [];
        snap.forEach(d=> list.push({ id:d.id, ...d.data() }));

        restaurants = list
          .filter(r=> r.isVisible !== false)
          .sort((a,b)=>{
            const ao=Number(a.order||0), bo=Number(b.order||0);
            if(ao!==bo) return ao-bo;
            const aa=Number(a.createdAt||0), bb=Number(b.createdAt||0);
            if(aa!==bb) return aa-bb;
            return (a.name||"").localeCompare((b.name||""),"zh-Hant");
          });

        $("rCount").textContent = `${restaurants.length} é–“`;
        renderRestaurantCards();

        const savedRid = localStorage.getItem("gb_user_rid") || "";
        if(savedRid && restaurants.some(r=> r.id===savedRid)){
          await pickRestaurant(savedRid, {silent:true});
        }

        statusPill.textContent = "åº—å®¶è¼‰å…¥å®Œæˆ âœ…";
      }catch(err){
        console.error(err);
        statusPill.textContent = "åº—å®¶è®€å–å¤±æ•—";
        alert("åº—å®¶è®€å–å¤±æ•—ï¼ˆRules/ç¶²è·¯ï¼‰\n\n" + (err?.message || err));
      }
    }

    // âœ… åº—å®¶å¡ç‰‡ï¼ˆæ¸…çˆ½ç‰ˆï¼šæ•´å¼µå¯é» + é¸å®Œè‡ªå‹•æ”¶åˆ + ç‹€æ…‹ä¸é‡è¤‡ï¼‰
    function renderRestaurantCards(){
      const wrap = $("restaurantGrid");
      if(restaurants.length===0){
        wrap.innerHTML = `<div class="muted">ç›®å‰æ²’æœ‰å¯é»é¤åº—å®¶ã€‚</div>`;
        return;
      }

      const placeholder =
        "data:image/svg+xml;charset=UTF-8," +
        encodeURIComponent(`<svg xmlns='http://www.w3.org/2000/svg' width='800' height='450'>
          <defs><linearGradient id='g' x1='0' y1='0' x2='1' y2='1'>
            <stop offset='0' stop-color='#fb7185' stop-opacity='.14'/>
            <stop offset='1' stop-color='#6366f1' stop-opacity='.10'/>
          </linearGradient></defs>
          <rect width='100%' height='100%' fill='url(#g)'/>
          <text x='50%' y='52%' dominant-baseline='middle' text-anchor='middle'
            font-family='system-ui' font-size='28' fill='#0f172a' opacity='.55'>No Image</text>
        </svg>`);

      wrap.innerHTML = restaurants.map(r=>{
        const closed = !!r.isClosed;
        const img = (r.imageUrl||"").trim() || placeholder;

        return `
          <div class="rCard" data-pick-card="${esc(r.id)}" role="button" tabindex="0" aria-label="é¸æ“‡åº—å®¶ ${esc(r.name||"")}">
            <div class="rThumb">
              <img src="${esc(img)}" alt="${esc(r.name||"")}"
                onerror="this.onerror=null; this.src='${placeholder}'"/>
              <div class="rBadge ${closed?'lock':'ok'}">${closed?'å·²çµå–®':'é–‹å–®ä¸­'}</div>
            </div>

            <div class="rBody">
              <div class="rTitleRow">
                <b class="rName">${esc(r.name||"æœªå‘½å")}</b>
              </div>

              <div class="rMeta">
                ${(r.address||"").trim() ? `<div class="muted">ğŸ“ ${esc(r.address)}</div>` : ``}
                ${(r.phone||"").trim() ? `<div class="muted">â˜ ${esc(r.phone)}</div>` : ``}
                ${(r.mapUrl||"").trim()
                  ? `<a class="rMap" href="${esc(r.mapUrl)}" target="_blank" rel="noopener noreferrer">ğŸ—º é–‹å•Ÿ Google Map</a>`
                  : ``}
              </div>

              <div class="rActions">
                <button class="btn" data-pick-r="${esc(r.id)}" ${closed?'disabled':''} type="button">
                  ${closed?'ä¸å¯é¸':'é¸æ“‡'}
                </button>
              </div>
            </div>
          </div>
        `;
      }).join("");

      // âœ… æŒ‰éˆ•é»é¸ï¼ˆé¿å…é»æ•´å¼µå¡é‡è¤‡è§¸ç™¼ï¼‰
      wrap.querySelectorAll("button[data-pick-r]").forEach(btn=>{
        btn.onclick = async (e)=>{
          e.stopPropagation();
          const rid = btn.dataset.pickR;
          await pickRestaurant(rid);
          const d = btn.closest("details");
          if(d) d.open = false; // âœ… é¸å®Œè‡ªå‹•æ”¶åˆ
        };
      });

      // âœ… æ•´å¼µå¡å¯é»ï¼ˆçµå–®é˜»æ“‹ï¼‰
      wrap.querySelectorAll(".rCard[data-pick-card]").forEach(card=>{
        const rid = card.dataset.pickCard;
        const r = restaurants.find(x=> x.id===rid);
        const closed = !!r?.isClosed;

        const go = async ()=>{
          if(closed) return alert("æ­¤åº—å®¶å·²çµå–®ï¼Œç„¡æ³•é¸æ“‡");
          await pickRestaurant(rid);
          const d = card.closest("details");
          if(d) d.open = false; // âœ… é¸å®Œè‡ªå‹•æ”¶åˆ
        };

        card.addEventListener("click", go);
        card.addEventListener("keydown",(e)=>{
          if(e.key==="Enter") go();
        });
      });
    }

    async function pickRestaurant(rid, opt={}){
      try{
        statusPill.textContent = "è®€å–åº—å®¶â€¦";
        const snap = await getDoc(doc(db,"restaurants",rid));
        selectedRestaurantId = rid;
        selectedRestaurant = snap.exists() ? snap.data() : null;

        localStorage.setItem("gb_user_rid", rid);

        $("pickedRestaurantName").textContent = selectedRestaurant?.name || "æœªå‘½å";
        const st = $("pickedRestaurantState");
        st.style.display = "inline-flex";
        if(selectedRestaurant?.isClosed){
          st.textContent = "å·²çµå–®ï¼ˆä¸å¯é€å‡º/ä¸å¯åˆªé™¤ç´€éŒ„ï¼‰";
          st.className = "tag lockTag";
        }else{
          st.textContent = "é–‹å–®ä¸­";
          st.className = "tag okTag";
        }

        await loadMenu(rid);
        renderMenu();
        renderCart();

        if(!opt.silent){
          statusPill.textContent = "å·²é¸æ“‡åº—å®¶ âœ…";
        }
      }catch(err){
        console.error(err);
        statusPill.textContent = "è®€å–åº—å®¶å¤±æ•—";
        alert("è®€å–åº—å®¶å¤±æ•—ï¼ˆRules/ç¶²è·¯ï¼‰\n\n" + (err?.message || err));
      }
    }

    // ===== Menu =====
    async function loadMenu(rid){
      try{
        statusPill.textContent = "è¼‰å…¥é¤é»ä¸­â€¦";
        const menuCol = collection(db, "restaurants", rid, "menu");
        const snap = await getDocs(menuCol);
        const list = [];
        snap.forEach(d=> list.push({ id:d.id, ...d.data() }));

        list.sort((a,b)=>{
          const ao = Number(a.order||0), bo = Number(b.order||0);
          if(ao !== bo) return ao - bo;
          const aa = Number(a.createdAt||0), bb = Number(b.createdAt||0);
          if(aa !== bb) return aa - bb;
          const ca = (a.category||"").localeCompare((b.category||""),"zh-Hant");
          if(ca !== 0) return ca;
          return (a.name||"").localeCompare((b.name||""),"zh-Hant");
        });

        menuCache = list;
        statusPill.textContent = "é¤é»è¼‰å…¥å®Œæˆ âœ…";
      }catch(err){
        console.error(err);
        statusPill.textContent = "é¤é»è®€å–å¤±æ•—";
        menuCache = [];
      }
    }

    function isUserReady(){
      return !!($("deptSelect").value && $("nameSelect").value && selectedRestaurantId);
    }

    function renderMenu(){
      const wrap = $("menuWrap");
      if(!selectedRestaurantId){
        wrap.innerHTML = `<div class="muted">è«‹å…ˆé¸æ“‡åº—å®¶ã€‚</div>`;
        return;
      }
      if(menuCache.length === 0){
        wrap.innerHTML = `<div class="muted">æ­¤åº—å®¶å°šç„¡é¤é»ã€‚</div>`;
        return;
      }

      const map = new Map();
      for(const m of menuCache){
        const cat = (m.category || "æœªåˆ†é¡").trim();
        if(!map.has(cat)) map.set(cat, []);
        map.get(cat).push(m);
      }

      // âœ… é¡åˆ¥é è¨­æ”¶åˆï¼ˆdetails ä¸åŠ  openï¼‰
      wrap.innerHTML = Array.from(map.entries()).map(([cat, items])=>`
        <details class="box" style="padding:10px 12px">
          <summary>
            <b>${esc(cat)}</b>
            <span class="tag" style="margin-left:8px">${items.length} é …</span>
          </summary>
          <div style="margin-top:10px">
            ${items.map(m=> renderMenuItem(m)).join("")}
          </div>
        </details>
      `).join("");

      // âœ… åŠ å…¥æŒ‰éˆ•
      wrap.querySelectorAll("[data-add-mid]").forEach(btn=>{
        btn.onclick = ()=>{
          const mid = btn.dataset.addMid;
          addToCart(mid);
        };
      });

      // âœ… Enter ç›´æ¥åŠ å…¥
      wrap.querySelectorAll("[data-mid-note]").forEach(inp=>{
        inp.addEventListener("keydown",(e)=>{
          if(e.key==="Enter"){
            e.preventDefault();
            const mid = inp.dataset.midNote;
            addToCart(mid);
          }
        });
      });

      // âœ… é—œéµä¿®æ­£ï¼šé¿å… details/summary æˆ–å…¶ä»–é»æ“Šäº‹ä»¶å½±éŸ¿ select/checkbox/radio æ“ä½œ
      wrap.querySelectorAll("select, input[type='checkbox'], input[type='radio']").forEach(el=>{
        const stop = (e)=> e.stopPropagation();
        el.addEventListener("pointerdown", stop, {passive:true});
        el.addEventListener("mousedown", stop);
        el.addEventListener("click", stop);
        el.addEventListener("touchstart", stop, {passive:true});
      });
    }

    function renderMenuItem(m){
      // âœ… åªæ¸²æŸ“ã€Œå•Ÿç”¨ã€çš„ç¾¤çµ„ï¼ˆæ”¯æ´ enabled/isEnabled/use/isUseï¼‰
      const ogRaw = Array.isArray(m.optionGroups) ? m.optionGroups : [];
      const agRaw = Array.isArray(m.addonGroups) ? m.addonGroups : [];
      const og = ogRaw.filter(groupEnabled);
      const ag = agRaw.filter(groupEnabled);

      const userOK = !!($("deptSelect").value && $("nameSelect").value);
      const closed = !!selectedRestaurant?.isClosed;
      const lock = closed ? "disabled" : "";
      const disabled = (!userOK || closed) ? "disabled" : "";

      const optionHTML = og.map((g,gi)=>{
        const opts = Array.isArray(g.options)?g.options:[];
        return `
          <div class="box" style="margin-top:10px">
            <div class="inline" style="justify-content:space-between">
              <b>${esc(g.name||"é¸é …")}</b>
              <span class="tag">${(g.required!==false)?"å¿…é¸":"å¯ä¸é¸"}</span>
            </div>
            <select data-mid-opt="${esc(m.id)}" data-gi="${gi}" ${lock}>
              ${(g.required!==false) ? `` : `<option value="-1">ä¸é¸æ“‡</option>`}
              ${opts.map((o,oi)=>`<option value="${oi}">${esc(o.name||"")}${Number(o.price||0)?` (+${Number(o.price||0)})`:``}</option>`).join("")}
            </select>
          </div>
        `;
      }).join("");

      const addonHTML = ag.map((g,gi)=>{
        const opts = Array.isArray(g.options)?g.options:[];
        const isSingle = (g.type==="single");
        return `
          <div class="box" style="margin-top:10px">
            <div class="inline" style="justify-content:space-between">
              <b>${esc(g.name||"åŠ è³¼")}</b>
              <span class="tag">${isSingle?"å–®é¸":"å¤šé¸"} / ${(g.required===true)?"å¿…é¸":"å¯ä¸é¸"}</span>
            </div>
            <div style="margin-top:8px">
              ${opts.map((o,oi)=>{
                const price = (o.free===true) ? 0 : Number(o.price||0);
                const label = `${esc(o.name||"")}${(o.free===true)?"ï¼ˆå…è²»ï¼‰":(price?`ï¼ˆ+${price}ï¼‰`:"")}`;
                const type = isSingle ? "radio" : "checkbox";
                const name = `ag_${m.id}_${gi}`;
                return `
                  <label class="inline" style="margin:8px 0; cursor:pointer">
                    <input type="${type}" name="${esc(name)}"
                      data-mid-addon="${esc(m.id)}" data-gi="${gi}" data-oi="${oi}"
                      style="width:auto" ${lock}/>
                    <span>${label}</span>
                  </label>
                `;
              }).join("")}
            </div>
          </div>
        `;
      }).join("");

      return `
        <div class="menuItem" data-mid="${esc(m.id)}">
          <div class="inline" style="justify-content:space-between">
            <div>
              <b>${esc(m.name||"")}</b>
              <span class="tag priceTag" style="margin-left:8px">å–®åƒ¹ï¼š${Number(m.price||0)}</span>
              <span class="tag" style="margin-left:6px">é è¨­ï¼š${Number(m.defaultQty||1)}</span>
            </div>
            <div class="inline">
              ${closed ? `<span class="tag lockTag">å·²çµå–®</span>` : ``}
              <button class="primary" data-add-mid="${esc(m.id)}" ${disabled} type="button">åŠ å…¥</button>
            </div>
          </div>

          ${m.note ? `<div class="muted" style="margin-top:6px">æç¤ºï¼š${esc(m.note)}</div>` : ``}

          <div class="row" style="margin-top:10px">
            <div>
              <label>æ•¸é‡</label>
              <input type="number" min="1" value="${Math.max(1,Number(m.defaultQty||1))}" data-mid-qty="${esc(m.id)}" ${lock}/>
            </div>
            <div>
              <label>å–®å“å‚™è¨»ï¼ˆEnter ç›´æ¥åŠ å…¥ï¼‰</label>
              <input placeholder="ä¾‹ï¼šä¸è¦è”¥" data-mid-note="${esc(m.id)}" ${lock}/>
            </div>
          </div>

          ${optionHTML}
          ${addonHTML}
        </div>
      `;
    }

    function readChosenOptions(mid){
      const m = menuCache.find(x=> x.id===mid);
      const ogRaw = Array.isArray(m?.optionGroups) ? m.optionGroups : [];
      const og = ogRaw.filter(groupEnabled);

      const chosenOptions = {};
      let optSum = 0;

      for(let gi=0; gi<og.length; gi++){
        const sel = document.querySelector(`select[data-mid-opt="${CSS.escape(mid)}"][data-gi="${gi}"]`);
        const idx = sel ? Number(sel.value) : -1;
        chosenOptions[gi] = idx;

        if(Number.isFinite(idx) && idx >= 0){
          const opt = (Array.isArray(og[gi].options)?og[gi].options:[])[idx];
          if(opt) optSum += Number(opt.price||0);
        }
      }
      return { chosenOptions, optSum };
    }

    function readChosenAddons(mid){
      const m = menuCache.find(x=> x.id===mid);
      const agRaw = Array.isArray(m?.addonGroups) ? m.addonGroups : [];
      const ag = agRaw.filter(groupEnabled);

      const addons = [];
      let addonSum = 0;

      for(let gi=0; gi<ag.length; gi++){
        const g = ag[gi] || {};
        const opts = Array.isArray(g.options)?g.options:[];
        const els = document.querySelectorAll(`input[data-mid-addon="${CSS.escape(mid)}"][data-gi="${gi}"]`);
        els.forEach(el=>{
          if(!el.checked) return;
          const oi = Number(el.dataset.oi);
          const o = opts[oi];
          if(!o) return;
          const free = (o.free===true);
          const price = free ? 0 : Number(o.price||0);
          addons.push({ name:o.name||"", price: Number.isFinite(price)?price:0, free });
          addonSum += price;
        });
      }
      return { addons, addonSum };
    }

    function validateRequired(mid){
      const m = menuCache.find(x=> x.id===mid);
      if(!m) return "æ‰¾ä¸åˆ°é¤é»";

      const og = (Array.isArray(m.optionGroups)?m.optionGroups:[]).filter(groupEnabled);
      for(let gi=0; gi<og.length; gi++){
        const g = og[gi]||{};
        const req = (g.required!==false);
        if(!req) continue;
        const sel = document.querySelector(`select[data-mid-opt="${CSS.escape(mid)}"][data-gi="${gi}"]`);
        const idx = sel ? Number(sel.value) : -1;
        if(!Number.isFinite(idx) || idx < 0) return `è«‹å…ˆé¸æ“‡ã€Œ${g.name||"é¸é …"}ã€`;
        const opt = (Array.isArray(g.options)?g.options:[])[idx];
        if(!opt) return `è«‹å…ˆé¸æ“‡ã€Œ${g.name||"é¸é …"}ã€`;
      }

      const ag = (Array.isArray(m.addonGroups)?m.addonGroups:[]).filter(groupEnabled);
      for(let gi=0; gi<ag.length; gi++){
        const g = ag[gi]||{};
        if(g.required!==true) continue;
        const els = document.querySelectorAll(`input[data-mid-addon="${CSS.escape(mid)}"][data-gi="${gi}"]`);
        let any = false;
        els.forEach(el=>{ if(el.checked) any = true; });
        if(!any) return `è«‹å…ˆé¸æ“‡ã€Œ${g.name||"åŠ è³¼"}ã€`;
      }

      return "";
    }

    function addToCart(mid){
      if(!($("deptSelect").value && $("nameSelect").value)){
        return alert("è«‹å…ˆé¸æ“‡éƒ¨é–€èˆ‡å§“å");
      }
      if(!selectedRestaurantId) return alert("è«‹å…ˆé¸æ“‡åº—å®¶");
      if(selectedRestaurant?.isClosed) return alert("æ­¤åº—å®¶å·²çµå–®ï¼Œç„¡æ³•é€å‡º/åŠ å…¥");

      const m = menuCache.find(x=> x.id===mid);
      if(!m) return alert("æ‰¾ä¸åˆ°é¤é»");

      const err = validateRequired(mid);
      if(err) return alert(err);

      const qtyEl = document.querySelector(`input[data-mid-qty="${CSS.escape(mid)}"]`);
      const noteEl = document.querySelector(`input[data-mid-note="${CSS.escape(mid)}"]`);
      const qty = Math.max(1, Number(qtyEl?.value || 1));
      const note = (noteEl?.value || "").trim();

      const { chosenOptions, optSum } = readChosenOptions(mid);
      const { addons, addonSum } = readChosenAddons(mid);

      const base = Number(m.price||0);
      const unit = base + optSum + addonSum;
      const lineTotal = unit * qty;

      cart.push({
        mid: m.id,
        name: m.name || "",
        category: m.category || "",
        qty,
        note,
        price: base,
        optionGroups: (Array.isArray(m.optionGroups)?m.optionGroups:[]).filter(groupEnabled),
        chosenOptions,
        addons,
        unit,
        lineTotal,
        createdAt: Date.now()
      });

      if(noteEl) noteEl.value = "";
      renderCart();
    }

    function renderCart(){
      const wrap = $("cartWrap");
      const total = cart.reduce((s,x)=> s + Number(x.lineTotal||0), 0);
      $("cartTotal").textContent = `ç¸½é¡ï¼š${total}`;

      const canSubmit = isUserReady() && cart.length>0 && !selectedRestaurant?.isClosed;
      $("btnSubmit").disabled = !canSubmit;
      $("btnClearCart").disabled = cart.length===0;

      if(cart.length===0){
        wrap.innerHTML = `<div class="muted">å°šæœªåŠ å…¥é¤é»ã€‚</div>`;
        return;
      }

      wrap.innerHTML = cart.map((it,idx)=>`
        <div class="listLine">
          <div class="inline" style="justify-content:space-between">
            <div>
              <b>${esc(it.name)}</b>
              <span class="tag" style="margin-left:8px">Ã— ${Number(it.qty)}</span>
              <span class="tag priceTag" style="margin-left:6px">å°è¨ˆï¼š${Number(it.lineTotal)}</span>
            </div>
            <button class="btn danger" data-del-cart="${idx}" type="button">åˆªé™¤</button>
          </div>
          ${it.note ? `<div class="muted" style="margin-top:6px">å‚™è¨»ï¼š${esc(it.note)}</div>`:``}
          ${(it.addons && it.addons.length) ? `<div class="muted" style="margin-top:6px">åŠ è³¼ï¼š${esc(it.addons.map(a=>a.free?`${a.name}(å…è²»)`: `${a.name}${a.price?`(+${a.price})`:``}`).join("ï¼›"))}</div>`:``}
        </div>
      `).join("");

      wrap.querySelectorAll("button[data-del-cart]").forEach(btn=>{
        btn.onclick = ()=>{
          const idx = Number(btn.dataset.delCart);
          cart.splice(idx,1);
          renderCart();
        };
      });
    }

    // ===== Submit Order =====
    async function submitOrder(){
      if(!isUserReady()) return alert("è«‹å…ˆé¸æ“‡éƒ¨é–€ / å§“å / åº—å®¶");
      if(cart.length===0) return alert("è³¼ç‰©è»Šæ˜¯ç©ºçš„");
      if(selectedRestaurant?.isClosed) return alert("æ­¤åº—å®¶å·²çµå–®ï¼Œç„¡æ³•é€å‡º");

      const userDept = $("deptSelect").value;
      const userName = $("nameSelect").value;
      const orderDate = todayISO();

      const total = cart.reduce((s,x)=> s + Number(x.lineTotal||0), 0);
      const payload = {
        userDept,
        userName,
        restaurantId: selectedRestaurantId,
        restaurantName: selectedRestaurant?.name || "",
        orderDate,
        createdAt: Date.now(),
        orderNote: ($("orderNote").value || "").trim(),
        items: cart.map(it=>({
          name: it.name,
          qty: it.qty,
          note: it.note,
          price: it.price,
          optionGroups: it.optionGroups || [],
          chosenOptions: it.chosenOptions || {},
          addons: it.addons || []
        })),
        total
      };

      try{
        statusPill.textContent = "é€å‡ºä¸­â€¦";
        await addDoc(colOrders, payload);

        cart = [];
        $("orderNote").value = "";
        renderCart();

        statusPill.textContent = "é€å‡ºå®Œæˆ âœ…";
        await loadMyOrders();
      }catch(err){
        console.error(err);
        statusPill.textContent = "é€å‡ºå¤±æ•—";
        alert("é€å‡ºå¤±æ•—ï¼ˆRules/ç¶²è·¯ï¼‰\n\n" + (err?.message || err));
      }
    }

    // ===== My Orders =====
    function fmtTime(ms){
      if(!ms) return "";
      const d = new Date(ms);
      const pad = (n)=> String(n).padStart(2,"0");
      return `${d.getFullYear()}-${pad(d.getMonth()+1)}-${pad(d.getDate())} ${pad(d.getHours())}:${pad(d.getMinutes())}`;
    }

    async function loadMyOrders(){
      const dept = $("deptSelect").value || "";
      const name = $("nameSelect").value || "";
      if(!dept || !name){
        $("myOrdersWrap").innerHTML = `<div class="muted">è«‹å…ˆé¸æ“‡éƒ¨é–€èˆ‡å§“åã€‚</div>`;
        return;
      }

      const date = ($("myDate").value || "").trim();
      try{
        statusPill.textContent = "è¼‰å…¥æˆ‘çš„è¨‚å–®â€¦";

        let snap;
        if(date){
          snap = await getDocs(query(colOrders, where("orderDate","==", date), limit(3000)));
        }else{
          snap = await getDocs(query(colOrders, limit(3000)));
        }

        const rows = [];
        snap.forEach(d=> rows.push({ id:d.id, ...d.data() }));

        const mine = rows.filter(o=> o.userDept===dept && o.userName===name)
          .sort((a,b)=> Number(b.createdAt||0) - Number(a.createdAt||0));

        renderMyOrders(mine);
        statusPill.textContent = "å·²è¼‰å…¥ âœ…";
      }catch(err){
        console.error(err);
        statusPill.textContent = "è¼‰å…¥å¤±æ•—";
        alert("è¼‰å…¥å¤±æ•—ï¼ˆRules/ç¶²è·¯ï¼‰\n\n" + (err?.message || err));
      }
    }

    async function canDeleteOrderByRestaurantId(rid){
      try{
        const snap = await getDoc(doc(db,"restaurants", rid));
        const r = snap.exists() ? snap.data() : null;
        return !(r && r.isClosed);
      }catch(e){
        return false;
      }
    }

    function renderMyOrders(list){
      const wrap = $("myOrdersWrap");
      if(list.length===0){
        wrap.innerHTML = `<div class="muted">å°šç„¡è³‡æ–™ã€‚</div>`;
        return;
      }

      wrap.innerHTML = list.map(o=>{
        const items = Array.isArray(o.items)?o.items:[];
        return `
          <div class="listLine" data-oid="${esc(o.id)}" data-rid="${esc(o.restaurantId||"")}">
            <div class="inline" style="justify-content:space-between">
              <div>
                <b>${esc(o.restaurantName||"")}</b>
                <span class="tag" style="margin-left:8px">${esc(o.orderDate||"")}</span>
              </div>
              <div class="inline">
                <span class="tag priceTag">ç¸½é¡ï¼š${Number(o.total||0)}</span>
                <button class="btn danger" data-del-order="${esc(o.id)}" type="button">åˆªé™¤</button>
              </div>
            </div>

            ${o.orderNote ? `<div class="muted" style="margin-top:6px">æ•´ç­†å‚™è¨»ï¼š${esc(o.orderNote)}</div>`:``}

            <div class="muted" style="margin-top:8px">
              ${items.map(it=>`â€¢ <b>${esc(it.name||"")}</b> Ã— ${Number(it.qty||0)} ${it.note?`ï¼ˆå‚™è¨»ï¼š${esc(it.note)}ï¼‰`:``}`).join("<br/>")}
            </div>

            <div class="muted" style="margin-top:8px">å»ºç«‹æ™‚é–“ï¼š${esc(fmtTime(Number(o.createdAt||0)))}</div>
            <div class="muted" style="margin-top:6px" id="lockHint_${esc(o.id)}"></div>
          </div>
        `;
      }).join("");

      wrap.querySelectorAll("button[data-del-order]").forEach(btn=>{
        btn.onclick = async ()=>{
          const oid = btn.dataset.delOrder;
          const box = wrap.querySelector(`[data-oid="${CSS.escape(oid)}"]`);
          const rid = box?.dataset.rid || "";

          if(!confirm("ç¢ºå®šåˆªé™¤é€™ç­†è¨‚å–®ï¼Ÿ\nï¼ˆçµå–®å¾Œå°‡ç„¡æ³•åˆªé™¤ï¼‰")) return;

          try{
            const ok = await canDeleteOrderByRestaurantId(rid);
            if(!ok){
              const hint = document.getElementById(`lockHint_${oid}`);
              if(hint) hint.innerHTML = `<span class="tag lockTag">æ­¤åº—å®¶å·²çµå–®ï¼Œç„¡æ³•åˆªé™¤</span>`;
              return alert("æ­¤åº—å®¶å·²çµå–®ï¼Œç„¡æ³•åˆªé™¤é€™ç­†è¨‚å–®");
            }
            await deleteDoc(doc(db,"orders", oid));
            await loadMyOrders();
          }catch(err){
            console.error(err);
            alert("åˆªé™¤å¤±æ•—ï¼ˆRules/ç¶²è·¯ï¼‰\n\n" + (err?.message || err));
          }
        };
      });
    }

    // ===== Events =====
    $("deptSelect").onchange = ()=>{
      const dept = $("deptSelect").value || "";
      renderNameSelect(dept);
      setWhoLine();

      $("nameSelect").value = "";
      localStorage.setItem("gb_user_dept", dept);
      localStorage.removeItem("gb_user_name");

      renderCart();
      loadMyOrders();
      renderMenu();
    };

    $("nameSelect").onchange = ()=>{
      const name = $("nameSelect").value || "";
      localStorage.setItem("gb_user_name", name);
      setWhoLine();

      renderCart();
      loadMyOrders();
      renderMenu();
    };

    $("btnSubmit").onclick = submitOrder;
    $("btnClearCart").onclick = ()=>{
      if(!confirm("ç¢ºå®šæ¸…ç©ºè³¼ç‰©è»Šï¼Ÿ")) return;
      cart = [];
      renderCart();
    };

    // âœ… Enter on order note => submit
    $("orderNote").addEventListener("keydown",(e)=>{
      if(e.key==="Enter"){
        e.preventDefault();
        if(!$("btnSubmit").disabled) submitOrder();
      }
    });

    $("btnReloadMy").onclick = loadMyOrders;
    $("btnToday").onclick = ()=>{
      $("myDate").value = todayISO();
      loadMyOrders();
    };

    // ===== Switch admin =====
    function goAdmin(){
      const pin = ($("adminPin").value || "").trim();
      if(pin !== "8520") return alert("PIN ä¸æ­£ç¢º");
      localStorage.setItem(roleKey, "admin");
      location.href = "./admin.html";
    }
    $("btnGoAdmin").onclick = goAdmin;
    $("adminPin").addEventListener("keydown",(e)=>{
      if(e.key==="Enter") goAdmin();
    });

    $("btnLogout").onclick = ()=>{
      localStorage.removeItem(roleKey);
      location.href = "./index.html";
    };

    // ===== Init =====
    $("myDate").value = todayISO();

    await loadStaff();
    await loadRestaurants();
    setWhoLine();
    renderCart();
    await loadMyOrders();

    document.addEventListener("visibilitychange", async ()=>{
      if(document.visibilityState === "visible"){
        await loadRestaurants();
        if(selectedRestaurantId) await pickRestaurant(selectedRestaurantId, {silent:true});
        await loadMyOrders();
      }
    });
  </script>
</body>
</html>
