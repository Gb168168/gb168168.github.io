<!doctype html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>GoldBricks å‘·å¥”ğŸš~ï½œä½¿ç”¨è€…</title>

  <style>
    :root{
      --bg-main:#eef1f7;
      --bg-panel:#f6f7fb;

      --card-main:#ffffff;
      --card-sub:#fafbff;

      --text:#0b1220;
      --muted:#516074;

      --accent:#fb7185;
      --accent2:#ff9a9e;
      --accent-soft:rgba(251,113,133,.12);

      --border-soft:rgba(15,23,42,.10);
      --border-strong:rgba(15,23,42,.18);

      --shadow:0 12px 34px rgba(2,6,23,.10);
      --shadow2:0 10px 26px rgba(2,6,23,.08);
      --radius:18px;

      --danger:#ef4444;
      --ok:#22c55e;
      --warn:#f59e0b;

      --focus:rgba(251,113,133,.65);
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      font-family: ui-sans-serif, system-ui, -apple-system, "Segoe UI", Arial;
      background:
        radial-gradient(1200px 520px at 18% -12%, rgba(251,113,133,.14), transparent 60%),
        radial-gradient(900px 520px at 110% 0%, rgba(99,102,241,.10), transparent 55%),
        linear-gradient(180deg, var(--bg-panel) 0%, var(--bg-main) 60%, var(--bg-main) 100%);
      color:var(--text);
      min-height:100vh;
    }
    .wrap{max-width:1200px; margin:0 auto; padding:16px;}

    /* âœ… sticky topbar */
    .topbar{
      position: sticky;
      top:0;
      z-index:1000;
      background: rgba(255,255,255,.90);
      border:1px solid var(--border-soft);
      border-radius: var(--radius);
      box-shadow: 0 6px 20px rgba(15,23,42,.12);
      backdrop-filter: blur(12px);
      padding:12px 14px;
      display:flex; align-items:center; justify-content:space-between; gap:12px;
    }
    .topbar h1{font-size:18px; margin:0}
    .right{display:flex; gap:10px; align-items:center; flex-wrap:wrap}

    .pill{
      padding:8px 12px;
      border-radius:999px;
      border:1px solid var(--border-strong);
      background:#fff;
      color:var(--muted);
      font-size:12.5px
    }
    .btn{
      padding:9px 12px; border-radius:14px;
      border:1px solid var(--border-strong);
      background:#fff; cursor:pointer; font-weight:900;
    }
    .btn:hover{filter:brightness(.98)}
    .primary{
      padding:9px 12px;
      border-radius:14px;
      border:none;
      cursor:pointer;
      font-weight:900;
      background: linear-gradient(90deg, var(--accent), var(--accent2));
      color:#fff;
      box-shadow: 0 14px 28px rgba(251,113,133,.20);
    }
    .primary:disabled{opacity:.55; cursor:not-allowed}
    .danger{border-color: rgba(239,68,68,.42)}

    .grid{display:grid; grid-template-columns: 360px 1fr; gap:14px; margin-top:14px}
    @media (max-width:980px){.grid{grid-template-columns:1fr}}

    .card{
      background:var(--card-main);
      border:1px solid var(--border-soft);
      border-radius:var(--radius);
      box-shadow: var(--shadow2);
      padding:14px;
    }
    .cardSub{
      background:var(--card-sub);
      border:1px solid var(--border-soft);
      border-radius:var(--radius);
      padding:12px;
    }
    .card h2{margin:0 0 10px; font-size:15px}

    label{display:block; font-size:13px; color:var(--muted); margin:10px 0 6px;}
    input,select,textarea{
      width:100%;
      padding:11px 12px;
      border-radius:14px;
      border:1px solid var(--border-strong);
      outline:none;
      background:#fff;
      font-size:14px;
    }
    textarea{min-height:86px; resize:vertical}
    input:focus,select:focus,textarea:focus{
      border-color: var(--focus);
      box-shadow:0 0 0 4px rgba(251,113,133,.10)
    }

    .muted{color:var(--muted); font-size:12.5px; line-height:1.6}
    .hr{height:1px; background: var(--border-soft); margin:12px 0}
    .tag{
      display:inline-flex;
      padding:5px 10px;
      border-radius:999px;
      border:1px solid var(--border-strong);
      background:#fff;
      color:var(--muted);
      font-size:12px
    }
    .inline{display:flex; gap:10px; align-items:center; flex-wrap:wrap}
    .row{display:grid; grid-template-columns:1fr 1fr; gap:10px}

    .shopGrid{
      display:grid;
      grid-template-columns: repeat(2, minmax(0, 1fr));
      gap:12px;
    }
    @media (max-width:980px){.shopGrid{grid-template-columns:1fr}}

    .shopCard{
      border:1px solid var(--border-soft);
      border-radius:16px;
      background:#fff;
      overflow:hidden;
      cursor:pointer;
      box-shadow: 0 10px 22px rgba(2,6,23,.06);
    }
    .shopCard:hover{
      border-color: rgba(251,113,133,.35);
      box-shadow: 0 12px 24px rgba(251,113,133,.10);
    }
    .shopImg{
      height:110px;
      background: linear-gradient(135deg, rgba(251,113,133,.18), rgba(99,102,241,.10));
      display:flex; align-items:center; justify-content:center;
      overflow:hidden;
    }
    .shopImg img{width:100%; height:100%; object-fit:cover; display:block}
    .shopBody{padding:10px 12px}
    .shopName{font-weight:900}
    .shopMeta{margin-top:6px}

    details > summary{cursor:pointer; list-style:none; user-select:none}
    details > summary::-webkit-details-marker{display:none}

    .listLine{
      border:1px solid var(--border-soft);
      border-radius:14px;
      padding:10px 12px;
      background:#fff;
      margin-top:10px;
    }

    .qtyRow{
      display:grid;
      grid-template-columns: 1fr 110px;
      gap:10px;
      align-items:end;
    }

    .disabledMask{
      opacity:.55;
      pointer-events:none;
      filter: grayscale(.1);
    }
  </style>
</head>

<body>
  <div class="wrap">
    <div class="topbar">
      <div>
        <h1>ä½¿ç”¨è€…é»é¤</h1>
        <div class="muted" id="whoLine">è«‹å…ˆé¸æ“‡éƒ¨é–€èˆ‡å§“å</div>
      </div>
      <div class="right">
        <span class="pill" id="statusPill">é€£ç·šä¸­â€¦</span>

        <input id="adminPin" placeholder="è¼¸å…¥ 8520 åˆ‡åˆ°ç®¡ç†è€…" style="width:220px"/>
        <button class="btn" id="btnLogout">ç™»å‡º</button>
      </div>
    </div>

    <div class="grid">
      <!-- LEFT -->
      <div>
        <div class="card">
          <h2>1ï¼‰é¸æ“‡èº«ä»½</h2>

          <label>éƒ¨é–€</label>
          <select id="deptSelect">
            <option value="">è¼‰å…¥ä¸­â€¦</option>
          </select>

          <label>å§“å</label>
          <select id="nameSelect" disabled>
            <option value="">è«‹å…ˆé¸éƒ¨é–€</option>
          </select>

          <div class="hr"></div>
          <div class="muted">â€» å¿…é ˆã€Œéƒ¨é–€ + å§“åã€éƒ½é¸å¥½æ‰æœƒé–‹æ”¾é»é¤ã€‚</div>
        </div>

        <div class="card" style="margin-top:14px">
          <h2>2ï¼‰æˆ‘çš„è¨‚é¤ç´€éŒ„</h2>
          <div class="muted">é»éŒ¯å¯åˆªé™¤ï¼›ä½†åº—å®¶çµå–®å¾Œä¸å¯è®Šæ›´ã€‚</div>
          <div id="myOrdersWrap" class="muted" style="margin-top:10px">å°šæœªè¼‰å…¥</div>
        </div>
      </div>

      <!-- RIGHT -->
      <div>
        <div class="card">
          <h2>3ï¼‰é¸æ“‡é¤å»³</h2>
          <div class="muted">é¤å»³ä¾ç®¡ç†ç«¯æ‹–æ›³æ’åºé¡¯ç¤ºï¼›éš±è—çš„åº—å®¶ä¸æœƒå‡ºç¾ã€‚</div>
          <div id="shopsWrap" class="muted" style="margin-top:10px">è¼‰å…¥ä¸­â€¦</div>
        </div>

        <div class="card" style="margin-top:14px">
          <h2>4ï¼‰é»é¤</h2>
          <div id="orderWrap" class="muted">è«‹å…ˆé¸é¤å»³</div>
        </div>
      </div>
    </div>
  </div>

  <script type="module">
    // ===== Role Gate =====
    const roleKey = "gb_role";
    if (!localStorage.getItem(roleKey)) localStorage.setItem(roleKey, "user");
    if (localStorage.getItem(roleKey) !== "user") location.href = "./index.html";

    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-app.js";
    import {
      getFirestore, collection, addDoc, doc, getDocs, getDoc, updateDoc,
      deleteDoc, query, where, limit
    } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-firestore.js";

    // âœ… ä½ çš„ Firebase è¨­å®šï¼ˆæ²¿ç”¨ï¼‰
    const firebaseConfig = {
      apiKey: "AIzaSyBdgOddTGAfqqHLnhnaJRv2_y7gyweuQEo",
      authDomain: "goldbricks-order.firebaseapp.com",
      projectId: "goldbricks-order",
      storageBucket: "goldbricks-order.firebasestorage.app",
      messagingSenderId: "463709758954",
      appId: "1:463709758954:web:429dc920f2f812d51cbe93",
      measurementId: "G-YQK8ZCC26R"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    const $ = (id)=> document.getElementById(id);
    const statusPill = $("statusPill");
    const esc = (s)=> (s??"").toString()
      .replaceAll("&","&amp;").replaceAll("<","&lt;").replaceAll(">","&gt;").replaceAll('"',"&quot;");

    function setStatus(txt, ok=true){
      statusPill.textContent = txt;
      statusPill.style.borderColor = ok ? "rgba(15,23,42,.18)" : "rgba(239,68,68,.42)";
    }

    // âœ… Enter/Blur Auto Saveï¼ˆåŒä¸€å¥—äº’å‹•è¦å‰‡ï¼‰
    function bindEnterSave(el, saveFn){
      if(!el) return;
      el.addEventListener("keydown", (e)=>{
        if(e.key === "Enter"){
          e.preventDefault();
          saveFn();
          el.blur();
        }
      });
      el.addEventListener("blur", ()=>{
        saveFn();
      });
    }

    const colStaff = collection(db, "staff");
    const colRestaurants = collection(db, "restaurants");
    const colOrders = collection(db, "orders");

    let staff = [];          // [{id,dept,name,order}]
    let restaurants = [];    // [{id,name,imageUrl,isVisible,isClosed,order,...}]
    let selectedRid = "";
    let selectedRestaurant = null;
    let menuCache = [];      // restaurants/{rid}/menu

    let userDept = "";
    let userName = "";

    function todayISO(){
      const d = new Date(); const pad = (n)=> String(n).padStart(2,"0");
      return `${d.getFullYear()}-${pad(d.getMonth()+1)}-${pad(d.getDate())}`;
    }

    function setWho(){
      $("whoLine").textContent = (userDept && userName)
        ? `å·²é¸æ“‡ï¼š${userDept} / ${userName}`
        : "è«‹å…ˆé¸æ“‡éƒ¨é–€èˆ‡å§“å";
    }

    // ===== Load Staff =====
    async function loadStaff(){
      try{
        setStatus("è¼‰å…¥äººå“¡ä¸­â€¦");
        const snap = await getDocs(colStaff);
        let list = [];
        snap.forEach(d=>{
          const v = d.data() || {};
          const dept = (v.dept||"").trim();
          const name = (v.name||"").trim();
          if(!dept || !name) return;
          const order = Number.isFinite(Number(v.order)) ? Number(v.order) : (Number(v.createdAt||0) || 0);
          list.push({ id:d.id, dept, name, order });
        });

        // ä¾ dept + order
        list.sort((a,b)=>{
          const da = a.dept.localeCompare(b.dept,"zh-Hant");
          if(da!==0) return da;
          if(a.order!==b.order) return a.order-b.order;
          return a.name.localeCompare(b.name,"zh-Hant");
        });

        staff = list;

        // dept options
        const deptSet = Array.from(new Set(staff.map(s=> s.dept)));
        $("deptSelect").innerHTML = `<option value="">è«‹é¸æ“‡</option>` + deptSet.map(d=>`<option value="${esc(d)}">${esc(d)}</option>`).join("");

        $("nameSelect").innerHTML = `<option value="">è«‹å…ˆé¸éƒ¨é–€</option>`;
        $("nameSelect").disabled = true;

        setStatus("äººå“¡è¼‰å…¥å®Œæˆ âœ…");
      }catch(err){
        console.error(err);
        setStatus("äººå“¡è¼‰å…¥å¤±æ•—", false);
        alert("äººå“¡è®€å–å¤±æ•—ï¼ˆRules/ç¶²è·¯ï¼‰\n\n"+(err?.message||err));
      }
    }

    function renderNamesByDept(dept){
      const list = staff.filter(s=> s.dept===dept);
      $("nameSelect").innerHTML = `<option value="">è«‹é¸æ“‡</option>` + list.map(s=>`<option value="${esc(s.name)}">${esc(s.name)}</option>`).join("");
      $("nameSelect").disabled = false;
    }

    // ===== Load Restaurants =====
    async function loadRestaurants(){
      try{
        setStatus("è¼‰å…¥é¤å»³ä¸­â€¦");
        const snap = await getDocs(colRestaurants);
        let list = [];
        snap.forEach(d=> list.push({ id:d.id, ...d.data() }));

        list = list.map((r,idx)=> ({
          ...r,
          order: Number.isFinite(Number(r.order)) ? Number(r.order) : idx*10
        }));

        // âœ… åªé¡¯ç¤º isVisible !== false
        list = list.filter(r=> r.isVisible !== false);

        list.sort((a,b)=>{
          if(a.order!==b.order) return a.order-b.order;
          const ta = Number(a.createdAt||0), tb = Number(b.createdAt||0);
          if(tb!==ta) return tb-ta;
          return (a.name||"").localeCompare((b.name||""),"zh-Hant");
        });

        restaurants = list;
        renderShops();
        setStatus("é¤å»³è¼‰å…¥å®Œæˆ âœ…");
      }catch(err){
        console.error(err);
        setStatus("é¤å»³è¼‰å…¥å¤±æ•—", false);
        alert("é¤å»³è®€å–å¤±æ•—ï¼ˆRules/ç¶²è·¯ï¼‰\n\n"+(err?.message||err));
      }
    }

    function renderShops(){
      const wrap = $("shopsWrap");
      if(restaurants.length===0){
        wrap.innerHTML = `<div class="muted">ç›®å‰æ²’æœ‰å¯é¡¯ç¤ºçš„é¤å»³ã€‚</div>`;
        return;
      }

      wrap.innerHTML = `
        <div class="shopGrid">
          ${restaurants.map(r=>{
            const closed = !!r.isClosed;
            const img = (r.imageUrl||"").trim();
            return `
              <div class="shopCard" data-rid="${esc(r.id)}">
                <div class="shopImg">
                  ${img ? `<img src="${esc(img)}" alt="shop"/>` : `<div class="muted">No Image</div>`}
                </div>
                <div class="shopBody">
                  <div class="shopName">${esc(r.name||"æœªå‘½å")}</div>
                  <div class="shopMeta">
                    ${closed ? `<span class="tag">å·²çµå–®</span>` : `<span class="tag">é–‹å–®ä¸­</span>`}
                    ${(r.address||"").trim() ? `<span class="tag" style="margin-left:6px">æœ‰åœ°å€</span>` : ``}
                  </div>
                </div>
              </div>
            `;
          }).join("")}
        </div>
      `;

      wrap.querySelectorAll(".shopCard").forEach(card=>{
        card.onclick = async ()=>{
          if(!userDept || !userName) return alert("è«‹å…ˆé¸æ“‡éƒ¨é–€èˆ‡å§“å");
          const rid = card.dataset.rid;
          await pickRestaurant(rid);
        };
      });
    }

    async function pickRestaurant(rid){
      try{
        setStatus("è®€å–é¤å»³/èœå–®â€¦");
        const snap = await getDoc(doc(db, "restaurants", rid));
        if(!snap.exists()) return alert("æ­¤é¤å»³ä¸å­˜åœ¨æˆ–å·²åˆªé™¤");
        selectedRid = rid;
        selectedRestaurant = snap.data();

        // load menu
        const menuCol = collection(db, "restaurants", rid, "menu");
        const msnap = await getDocs(menuCol);
        let list = [];
        msnap.forEach(d=> list.push({ id:d.id, ...d.data() }));

        list = list.map((m,idx)=> ({
          ...m,
          order: Number.isFinite(Number(m.order)) ? Number(m.order) : (Number(m.createdAt||0) || idx*10)
        }));

        // âœ… ä¾ category + order
        list.sort((a,b)=>{
          const ca = (a.category||"").localeCompare((b.category||""),"zh-Hant");
          if(ca!==0) return ca;
          if(a.order!==b.order) return a.order-b.order;
          return (a.name||"").localeCompare((b.name||""),"zh-Hant");
        });

        menuCache = list;
        renderOrderUI();
        setStatus("å¯é–‹å§‹é»é¤ âœ…");
      }catch(err){
        console.error(err);
        setStatus("è®€å–é¤å»³å¤±æ•—", false);
        alert("è®€å–é¤å»³å¤±æ•—ï¼ˆRules/ç¶²è·¯ï¼‰\n\n"+(err?.message||err));
      }
    }

    // ===== Order UI =====
    function calcItemTotal(basePrice, qty, optionGroups, chosenOptions, addons){
      let optSum = 0;
      const og = Array.isArray(optionGroups)?optionGroups:[];
      for(let gi=0;gi<og.length;gi++){
        const g = og[gi]||{};
        const idx = Number((chosenOptions||{})[gi]);
        if(!Number.isFinite(idx) || idx<0) continue;
        const opt = (Array.isArray(g.options)?g.options:[])[idx];
        if(!opt) continue;
        optSum += Number(opt.price||0);
      }
      const addonSum = (addons||[]).reduce((s,a)=> s + ((a && a.free) ? 0 : Number(a.price||0)), 0);
      const unit = Number(basePrice||0) + optSum + addonSum;
      return { unit, total: unit * Number(qty||0), optSum, addonSum };
    }

    function renderOrderUI(){
      const wrap = $("orderWrap");
      if(!selectedRid || !selectedRestaurant){
        wrap.innerHTML = `<div class="muted">è«‹å…ˆé¸é¤å»³</div>`;
        return;
      }
      const closed = !!selectedRestaurant.isClosed;

      const map = new Map();
      for(const m of menuCache){
        const cat = (m.category||"æœªåˆ†é¡").trim();
        if(!map.has(cat)) map.set(cat, []);
        map.get(cat).push(m);
      }

      wrap.innerHTML = `
        <div class="${closed ? "disabledMask":""}">
          <div class="inline" style="justify-content:space-between">
            <div>
              <span class="tag">åº—å®¶</span>
              <b style="margin-left:6px">${esc(selectedRestaurant.name||"")}</b>
              ${closed ? `<span class="tag" style="margin-left:8px">å·²çµå–®ï¼ˆä¸å¯è®Šæ›´ï¼‰</span>` : `<span class="tag" style="margin-left:8px">é–‹å–®ä¸­</span>`}
            </div>
            <button class="btn" id="btnReloadMenu" type="button">é‡æ–°è¼‰å…¥èœå–®</button>
          </div>

          <div class="hr"></div>

          ${Array.from(map.entries()).map(([cat, items])=>`
            <details class="cardSub" style="margin-top:10px">
              <summary>
                <b>${esc(cat)}</b>
                <span class="tag" style="margin-left:8px">${items.length} é …</span>
              </summary>
              <div style="margin-top:10px">
                ${items.map(m=> renderMenuItemCard(m)).join("")}
              </div>
            </details>
          `).join("")}

          <div class="hr"></div>

          <div class="cardSub">
            <label>æ•´ç­†å‚™è¨»ï¼ˆå¯ç©ºï¼ŒEnter é€å‡ºï¼‰</label>
            <textarea id="orderNote" placeholder="ä¾‹ï¼šè«‹å¹«æˆ‘åˆ†è¢‹"></textarea>

            <div class="inline" style="margin-top:10px; justify-content:flex-end">
              <button class="primary" id="btnSubmitOrder" ${closed ? "disabled":""}>é€å‡ºè¨‚å–®</button>
            </div>
            <div class="muted" style="margin-top:6px">
              â€» Enter ä¹Ÿå¯ä»¥ç›´æ¥é€å‡ºï¼ˆç„¦é»åœ¨å‚™è¨»æ™‚ï¼‰
            </div>
          </div>
        </div>
      `;

      $("btnReloadMenu").onclick = async ()=>{
        await pickRestaurant(selectedRid);
      };

      // Enter é€å‡ºï¼ˆç„¦é»åœ¨å‚™è¨»ï¼‰
      const noteEl = document.getElementById("orderNote");
      noteEl.addEventListener("keydown",(e)=>{
        if(e.key==="Enter" && !e.shiftKey){
          e.preventDefault();
          if(!closed) submitOrder();
        }
      });

      $("btnSubmitOrder").onclick = submitOrder;

      // ç¶å®šæ¯å€‹å“é …çš„ qty / é¸é … / åŠ è³¼è®Šæ›´
      menuCache.forEach(m=>{
        // qty Enter/blur æ›´æ–°
        const qtyEl = document.getElementById(`qty_${m.id}`);
        if(qtyEl){
          bindEnterSave(qtyEl, ()=> updatePreviewForItem(m.id));
        }

        // option selects change æ›´æ–°
        const og = Array.isArray(m.optionGroups)?m.optionGroups:[];
        for(let gi=0; gi<og.length; gi++){
          const sel = document.getElementById(`opt_${m.id}_${gi}`);
          if(sel) sel.onchange = ()=> updatePreviewForItem(m.id);
        }

        // addon checkboxes change æ›´æ–°
        const ag = Array.isArray(m.addonGroups)?m.addonGroups:[];
        ag.forEach((g, gi)=>{
          const opts = Array.isArray(g.options)?g.options:[];
          opts.forEach((o, oi)=>{
            const cb = document.getElementById(`ag_${m.id}_${gi}_${oi}`);
            if(cb) cb.onchange = ()=> updatePreviewForItem(m.id);
          });
        });
      });
    }

    function renderMenuItemCard(m){
      const og = Array.isArray(m.optionGroups) ? m.optionGroups : [];
      const ag = Array.isArray(m.addonGroups) ? m.addonGroups : [];

      return `
        <div class="listLine" style="margin-top:10px">
          <div class="inline" style="justify-content:space-between">
            <div>
              <b>${esc(m.name||"")}</b>
              <span class="tag" style="margin-left:8px">å–®åƒ¹ï¼š${Number(m.price||0)}</span>
            </div>
            <span class="tag" id="pv_${esc(m.id)}">å°è¨ˆï¼š0</span>
          </div>

          ${m.note ? `<div class="muted" style="margin-top:6px">å‚™è¨»ï¼š${esc(m.note)}</div>` : ``}

          <div class="row" style="margin-top:10px">
            <div>
              <label>æ•¸é‡ï¼ˆEnter å³æ›´æ–°ï¼‰</label>
              <input id="qty_${esc(m.id)}" type="number" min="0" value="${Number(m.defaultQty||1)}"/>
            </div>
            <div>
              <label>å–®å“å‚™è¨»ï¼ˆå¯ç©ºï¼‰</label>
              <input id="note_${esc(m.id)}" placeholder="ä¾‹ï¼šä¸è¦è¾£"/>
            </div>
          </div>

          ${og.length ? `
            <div class="cardSub" style="margin-top:10px">
              <b>é¸é …ï¼ˆä¸‹æ‹‰ï¼‰</b>
              ${og.map((g,gi)=>{
                const req = (g.required!==false);
                const options = Array.isArray(g.options)?g.options:[];
                return `
                  <label style="margin-top:10px">${esc(g.name||"é¸é …")} ${req ? `<span class="tag" style="margin-left:6px">å¿…é¸</span>` : `<span class="tag" style="margin-left:6px">å¯ä¸é¸</span>`}</label>
                  <select id="opt_${esc(m.id)}_${gi}">
                    ${req ? `` : `<option value="-1">ä¸é¸æ“‡</option>`}
                    ${options.map((o,oi)=>`<option value="${oi}">${esc(o.name||"")}${Number(o.price||0)?` +${Number(o.price||0)}`:""}</option>`).join("")}
                  </select>
                `;
              }).join("")}
            </div>
          `:``}

          ${ag.length ? `
            <div class="cardSub" style="margin-top:10px">
              <b>åŠ è³¼</b>
              ${ag.map((g,gi)=>{
                const req = (g.required===true);
                const single = (g.type==="single");
                const options = Array.isArray(g.options)?g.options:[];
                return `
                  <details class="cardSub" style="margin-top:10px; background:#fff">
                    <summary>
                      <b>${esc(g.name||"åŠ è³¼")}</b>
                      <span class="tag" style="margin-left:8px">${single?"å–®é¸":"å¤šé¸"}</span>
                      <span class="tag" style="margin-left:6px">${req?"å¿…é¸":"å¯ä¸é¸"}</span>
                    </summary>
                    <div style="margin-top:10px">
                      ${options.map((o,oi)=>{
                        const p = (o.free===true) ? 0 : Number(o.price||0);
                        return `
                          <label class="inline" style="margin:8px 0">
                            <input type="checkbox" id="ag_${esc(m.id)}_${gi}_${oi}" style="width:18px; height:18px"/>
                            <span>${esc(o.name||"")}</span>
                            <span class="tag">${(o.free===true) ? "å…è²»" : (p?("+"+p):"+0")}</span>
                          </label>
                        `;
                      }).join("")}
                      <div class="muted">${req ? "â€» æ­¤ç¾¤çµ„ç‚ºå¿…é¸" : ""}</div>
                    </div>
                  </details>
                `;
              }).join("")}
            </div>
          `:``}
        </div>
      `;
    }

    function getItemState(m){
      const qty = Math.max(0, Number(document.getElementById(`qty_${m.id}`)?.value || 0));
      const note = (document.getElementById(`note_${m.id}`)?.value || "").trim();

      // chosen options
      const chosenOptions = {};
      const og = Array.isArray(m.optionGroups)?m.optionGroups:[];
      for(let gi=0; gi<og.length; gi++){
        const sel = document.getElementById(`opt_${m.id}_${gi}`);
        if(!sel) continue;
        chosenOptions[gi] = Number(sel.value);
      }

      // addons picked
      const addons = [];
      const ag = Array.isArray(m.addonGroups)?m.addonGroups:[];
      ag.forEach((g,gi)=>{
        const options = Array.isArray(g.options)?g.options:[];
        const picked = [];
        options.forEach((o,oi)=>{
          const cb = document.getElementById(`ag_${m.id}_${gi}_${oi}`);
          if(cb && cb.checked){
            picked.push({ name:o.name||"", price:Number(o.price||0), free: (o.free===true) });
          }
        });

        // è‹¥æ˜¯å–®é¸ï¼Œå¼·åˆ¶åªç•™ä¸€å€‹ï¼ˆæœ€å¾Œå‹¾åˆ°çš„å„ªå…ˆï¼‰
        if(g.type==="single" && picked.length>1){
          const last = picked[picked.length-1];
          // æ¸…æ‰å…¶ä»– checkbox
          options.forEach((o,oi)=>{
            const cb = document.getElementById(`ag_${m.id}_${gi}_${oi}`);
            if(cb) cb.checked = (o.name===last.name);
          });
          addons.push(last);
        }else{
          picked.forEach(x=> addons.push(x));
        }
      });

      return { qty, note, chosenOptions, addons };
    }

    function updatePreviewForItem(mid){
      const m = menuCache.find(x=> x.id===mid);
      if(!m) return;
      const st = getItemState(m);
      const calc = calcItemTotal(m.price, st.qty, m.optionGroups, st.chosenOptions, st.addons);
      const pv = document.getElementById(`pv_${mid}`);
      if(pv) pv.textContent = `å°è¨ˆï¼š${calc.total}`;
    }

    function validateRequiredSelections(m, st){
      // optionGroups required
      const og = Array.isArray(m.optionGroups)?m.optionGroups:[];
      for(let gi=0; gi<og.length; gi++){
        const g = og[gi]||{};
        const req = (g.required!==false);
        const idx = Number((st.chosenOptions||{})[gi]);
        if(req && (!Number.isFinite(idx) || idx < 0)) return `ã€Œ${m.name}ã€é¸é …ã€Œ${g.name||"é¸é …"}ã€ç‚ºå¿…é¸`;
      }

      // addonGroups required
      const ag = Array.isArray(m.addonGroups)?m.addonGroups:[];
      for(let gi=0; gi<ag.length; gi++){
        const g = ag[gi]||{};
        if(g.required!==true) continue;
        const opts = Array.isArray(g.options)?g.options:[];
        const anyPicked = opts.some((o,oi)=>{
          const cb = document.getElementById(`ag_${m.id}_${gi}_${oi}`);
          return cb && cb.checked;
        });
        if(!anyPicked) return `ã€Œ${m.name}ã€åŠ è³¼ç¾¤çµ„ã€Œ${g.name||"åŠ è³¼"}ã€ç‚ºå¿…é¸`;
      }
      return "";
    }

    async function submitOrder(){
      if(!userDept || !userName) return alert("è«‹å…ˆé¸æ“‡éƒ¨é–€èˆ‡å§“å");
      if(!selectedRestaurant) return alert("è«‹å…ˆé¸é¤å»³");

      // æœ€æ–°ç‹€æ…‹å†ç¢ºèªï¼ˆé¿å…å‰›çµå–®é‚„èƒ½é€ï¼‰
      const rsnap = await getDoc(doc(db, "restaurants", selectedRid));
      if(rsnap.exists() && rsnap.data()?.isClosed){
        alert("æ­¤é¤å»³å·²çµå–®ï¼Œç„¡æ³•é€å‡º/è®Šæ›´");
        selectedRestaurant = rsnap.data();
        renderOrderUI();
        return;
      }

      const items = [];
      let total = 0;

      for(const m of menuCache){
        const st = getItemState(m);
        if(!st.qty) continue;

        const requiredMsg = validateRequiredSelections(m, st);
        if(requiredMsg) return alert(requiredMsg);

        const calc = calcItemTotal(m.price, st.qty, m.optionGroups, st.chosenOptions, st.addons);
        total += calc.total;

        items.push({
          menuId: m.id,
          category: m.category || "",
          name: m.name || "",
          price: Number(m.price||0),
          qty: Number(st.qty||0),
          note: st.note || "",
          optionGroups: Array.isArray(m.optionGroups)?m.optionGroups:[],
          chosenOptions: st.chosenOptions || {},
          addons: st.addons || []
        });
      }

      if(items.length===0) return alert("è«‹è‡³å°‘é¸ä¸€å€‹å“é …ï¼ˆæ•¸é‡å¤§æ–¼ 0ï¼‰");

      const orderNote = (document.getElementById("orderNote")?.value || "").trim();

      try{
        setStatus("é€å‡ºè¨‚å–®ä¸­â€¦");
        await addDoc(colOrders, {
          orderDate: todayISO(),
          createdAt: Date.now(),
          userDept,
          userName,
          restaurantId: selectedRid,
          restaurantName: selectedRestaurant.name || "",
          total,
          orderNote,
          items,
          // âœ… å­˜ä¸€ä»½ç‹€æ…‹å¿«ç…§ï¼šå¾ŒçºŒåˆªé™¤æ™‚ä¹Ÿå¯åˆ¤æ–·
          restaurantClosedAtSubmit: false
        });

        setStatus("é€å‡ºå®Œæˆ âœ…");
        alert("å·²é€å‡ºï¼");
        await loadMyOrders();
      }catch(err){
        console.error(err);
        setStatus("é€å‡ºå¤±æ•—", false);
        alert("é€å‡ºå¤±æ•—ï¼ˆRules/ç¶²è·¯ï¼‰\n\n"+(err?.message||err));
      }
    }

    // ===== My Orders =====
    async function loadMyOrders(){
      if(!userDept || !userName){
        $("myOrdersWrap").innerHTML = `<div class="muted">è«‹å…ˆé¸æ“‡éƒ¨é–€èˆ‡å§“åã€‚</div>`;
        return;
      }
      try{
        setStatus("è¼‰å…¥æˆ‘çš„è¨‚å–®â€¦");
        const snap = await getDocs(query(colOrders, where("orderDate","==", todayISO()), limit(3000)));
        const rows = [];
        snap.forEach(d=> rows.push({ id:d.id, ...d.data() }));

        const mine = rows
          .filter(o=> o.userDept===userDept && o.userName===userName)
          .sort((a,b)=> Number(b.createdAt||0)-Number(a.createdAt||0));

        renderMyOrders(mine);
        setStatus("å·²æ›´æ–° âœ…");
      }catch(err){
        console.error(err);
        setStatus("è¼‰å…¥æˆ‘çš„è¨‚å–®å¤±æ•—", false);
        $("myOrdersWrap").innerHTML = `<div class="muted">è®€å–å¤±æ•—ï¼ˆRules/ç¶²è·¯ï¼‰</div>`;
      }
    }

    function renderMyOrders(list){
      const wrap = $("myOrdersWrap");
      if(list.length===0){
        wrap.innerHTML = `<div class="muted">ä»Šå¤©å°šç„¡è¨‚å–®ã€‚</div>`;
        return;
      }

      wrap.innerHTML = list.map(o=>{
        const items = Array.isArray(o.items)?o.items:[];
        const lines = items.map(it=>{
          const addTxt = (it.addons||[]).map(a=>{
            const p = (a && a.free) ? 0 : Number(a.price||0);
            return `+${a.name||""}${(a && a.free) ? "(å…è²»)" : (p?(" "+p):"")}`;
          }).join("ï¼›");

          // option text
          const og = Array.isArray(it.optionGroups)?it.optionGroups:[];
          const pick = it.chosenOptions || {};
          const optTxt = og.map((g,gi)=>{
            const idx = Number(pick[gi]);
            if(!Number.isFinite(idx) || idx<0) return "";
            const opt = (Array.isArray(g.options)?g.options:[])[idx];
            if(!opt) return "";
            const p = Number(opt.price||0);
            return `${g.name? (g.name+"ï¼š"):""}${opt.name||""}${p?(" +"+p):""}`;
          }).filter(Boolean).join("ï¼›");

          return `
            â€¢ <b>${esc(it.name||"")}</b> Ã— ${Number(it.qty||0)}
            ${optTxt?`<div class="muted">ã€€ã€€é¸é …ï¼š${esc(optTxt)}</div>`:""}
            ${addTxt?`<div class="muted">ã€€ã€€åŠ è³¼ï¼š${esc(addTxt)}</div>`:""}
            ${it.note?`<div class="muted">ã€€ã€€å‚™è¨»ï¼š${esc(it.note)}</div>`:""}
          `;
        }).join("");

        return `
          <div class="listLine">
            <div class="inline" style="justify-content:space-between">
              <div>
                <b>${esc(o.restaurantName||"")}</b>
                <span class="tag" style="margin-left:8px">${esc(o.orderDate||"")}</span>
              </div>
              <span class="tag">ç¸½é¡ï¼š${Number(o.total||0)}</span>
            </div>

            <div class="muted" style="margin-top:8px">${lines}</div>
            ${o.orderNote ? `<div class="muted" style="margin-top:8px">æ•´ç­†å‚™è¨»ï¼š${esc(o.orderNote)}</div>`:""}

            <div class="inline" style="justify-content:flex-end; margin-top:10px">
              <button class="btn danger" data-del-order="${esc(o.id)}">åˆªé™¤æ­¤ç­†</button>
            </div>
          </div>
        `;
      }).join("");

      wrap.querySelectorAll("button[data-del-order]").forEach(btn=>{
        btn.onclick = async ()=>{
          const oid = btn.dataset.delOrder;
          if(!confirm("ç¢ºå®šåˆªé™¤æ­¤ç­†è¨‚å–®ï¼Ÿ")) return;

          try{
            // âœ… åˆªé™¤å‰ç¢ºèªåº—å®¶æ˜¯å¦çµå–®
            const odoc = await getDoc(doc(db,"orders",oid));
            if(!odoc.exists()) return alert("è¨‚å–®ä¸å­˜åœ¨æˆ–å·²åˆªé™¤");
            const o = odoc.data() || {};
            const rid = o.restaurantId;

            if(rid){
              const rsnap = await getDoc(doc(db,"restaurants",rid));
              if(rsnap.exists() && rsnap.data()?.isClosed){
                return alert("åº—å®¶å·²çµå–®ï¼Œç„¡æ³•åˆªé™¤/è®Šæ›´è¨‚å–®");
              }
            }

            await deleteDoc(doc(db, "orders", oid));
            await loadMyOrders();
            alert("å·²åˆªé™¤");
          }catch(err){
            console.error(err);
            alert("åˆªé™¤å¤±æ•—ï¼ˆRules/ç¶²è·¯ï¼‰\n\n"+(err?.message||err));
          }
        };
      });
    }

    // ===== Events =====
    $("deptSelect").onchange = ()=>{
      userDept = $("deptSelect").value || "";
      userName = "";
      setWho();

      if(userDept){
        renderNamesByDept(userDept);
      }else{
        $("nameSelect").innerHTML = `<option value="">è«‹å…ˆé¸éƒ¨é–€</option>`;
        $("nameSelect").disabled = true;
      }

      $("myOrdersWrap").innerHTML = `<div class="muted">è«‹å…ˆé¸æ“‡å§“åã€‚</div>`;
      $("orderWrap").innerHTML = `<div class="muted">è«‹å…ˆé¸é¤å»³</div>`;
    };

    $("nameSelect").onchange = async ()=>{
      userName = $("nameSelect").value || "";
      setWho();
      if(userDept && userName){
        await loadMyOrders();
      }
    };

    // âœ… 8520 åˆ‡ç®¡ç†è€…ï¼ˆEnter ç›´æ¥åˆ‡ï¼‰
    $("adminPin").addEventListener("keydown",(e)=>{
      if(e.key==="Enter"){
        e.preventDefault();
        const pin = ($("adminPin").value||"").trim();
        if(pin === "8520"){
          localStorage.setItem(roleKey, "admin");
          location.href = "./admin.html";
        }else{
          alert("å¯†ç¢¼éŒ¯èª¤");
        }
      }
    });

    $("btnLogout").onclick = ()=>{
      localStorage.removeItem(roleKey);
      location.href = "./index.html";
    };

    // ===== Init =====
    setStatus("å·²é€£ç·š Firestore âœ…");
    setWho();
    await loadStaff();
    await loadRestaurants();
  </script>
</body>
</html>
