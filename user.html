<!doctype html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>GoldBricks å‘·å¥”ğŸš~ ï½œä½¿ç”¨è€…</title>
  <style>
    :root{
      --bg:#f5f4fb; --card:#fff; --text:#0f172a; --muted:#64748b;
      --primary:#fb7185; --primary2:#ff9a9e; --border:rgba(15,23,42,.10);
      --shadow:0 10px 30px rgba(15,23,42,.10);
      --radius:18px;
    }
    *{box-sizing:border-box}
    body{
      margin:0; font-family: ui-sans-serif, system-ui, -apple-system, "Segoe UI", Arial;
      background: radial-gradient(1200px 500px at 20% -10%, rgba(251,113,133,.22), transparent 60%),
                  radial-gradient(900px 500px at 100% 0%, rgba(255,154,158,.14), transparent 55%),
                  var(--bg);
      color:var(--text);
      min-height:100vh;
    }
    .wrap{max-width:1200px; margin:0 auto; padding:16px;}
    .topbar{
      background: rgba(255,255,255,.78);
      border:1px solid var(--border);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      backdrop-filter: blur(10px);
      padding:12px 14px;
      display:flex; align-items:center; justify-content:space-between; gap:12px;
    }
    .topbar h1{font-size:18px; margin:0}
    .topbar .right{display:flex; gap:10px; align-items:center; flex-wrap:wrap}
    .pill{padding:8px 12px; border-radius:999px; border:1px solid var(--border); background:#fff; color:var(--muted); font-size:12.5px}
    .btn{
      padding:9px 12px; border-radius:14px; border:1px solid var(--border);
      background:#fff; cursor:pointer; font-weight:900;
    }
    .primary{
      padding:9px 12px; border-radius:14px; border:none; cursor:pointer; font-weight:900;
      background: linear-gradient(90deg, var(--primary), var(--primary2));
      color:#fff; box-shadow: 0 14px 28px rgba(251,113,133,.22);
    }
    .btn:disabled,.primary:disabled{opacity:.55; cursor:not-allowed}
    .grid{display:grid; grid-template-columns: 1.25fr .85fr; gap:14px; margin-top:14px}
    @media (max-width:980px){.grid{grid-template-columns:1fr}}
    .card{
      background:#fff; border:1px solid var(--border); border-radius:var(--radius);
      box-shadow: 0 8px 25px rgba(15,23,42,.07);
      padding:14px;
    }
    .card h2{margin:0 0 10px; font-size:15px}
    label{display:block; font-size:13px; color:var(--muted); margin:10px 0 6px;}
    input,select,textarea{
      width:100%; padding:11px 12px; border-radius:14px;
      border:1px solid var(--border); outline:none; background:#fff;
      font-size:14px;
    }
    textarea{min-height:92px; resize:vertical}
    input:focus,select:focus,textarea:focus{border-color: rgba(251,113,133,.7)}
    .row{display:grid; grid-template-columns: 1fr 1fr; gap:10px}
    .muted{color:var(--muted); font-size:12.5px; line-height:1.6}
    .hr{height:1px; background: var(--border); margin:12px 0}
    .tag{display:inline-flex; padding:5px 10px; border-radius:999px; border:1px solid var(--border); background:#fff; color:var(--muted); font-size:12px}
    .inline{display:flex; gap:10px; align-items:center; flex-wrap:wrap}
    .restaurantGrid{display:grid; grid-template-columns: repeat(2, minmax(0, 1fr)); gap:12px}
    @media (max-width:980px){.restaurantGrid{grid-template-columns:1fr}}
    .rCard{
      border:1px solid rgba(15,23,42,.10);
      border-radius:16px;
      overflow:hidden;
      background:#fff;
      cursor:pointer;
      transition:.12s transform;
    }
    .rCard:hover{transform: translateY(-1px)}
    .rImg{width:100%; height:160px; object-fit:cover; background:rgba(15,23,42,.04); display:block}
    .rBody{padding:10px 12px}
    .rBody h3{margin:0; font-size:15px}
    .rBody .muted{margin-top:6px}
    .rCard.active{
      border-color: rgba(251,113,133,.55);
      box-shadow: 0 10px 22px rgba(251,113,133,.18);
    }
    .menuItem{
      border:1px solid rgba(15,23,42,.10);
      border-radius:16px;
      padding:12px;
      background:#fff;
      margin-top:10px;
    }
    .menuItem h4{margin:0; font-size:14.5px}
    .addonBox{
      background: rgba(15,23,42,.02);
      border:1px dashed rgba(15,23,42,.18);
      border-radius:16px;
      padding:10px;
      margin-top:10px;
    }
    .addonRow{display:flex; align-items:center; justify-content:space-between; gap:10px; padding:8px 10px; border:1px solid rgba(15,23,42,.08); border-radius:14px; margin-top:8px}
    .addonRow input{width:18px; height:18px; margin:0}
    .qtyRow{display:flex; gap:10px; align-items:center; flex-wrap:wrap; margin-top:10px}
    .qtyRow input[type="number"]{width:140px}
    .cartLine{
      border:1px solid rgba(15,23,42,.10);
      border-radius:14px;
      padding:10px 12px;
      margin-top:10px;
      background:#fff;
    }
    .cartLine .top{display:flex; justify-content:space-between; gap:10px; flex-wrap:wrap}
    .danger{border-color: rgba(239,68,68,.35)}
    table{width:100%; border-collapse:collapse; font-size:13.5px}
    th,td{border-bottom:1px solid rgba(15,23,42,.08); padding:10px 8px; text-align:left; vertical-align:top}
    th{color:var(--muted); font-weight:900}

    /* âœ… çµå–®æç¤º */
    .banner{
      margin-top:10px;
      padding:10px 12px;
      border-radius:14px;
      border:1px solid rgba(239,68,68,.35);
      background: rgba(239,68,68,.06);
      color:#7f1d1d;
      font-weight:900;
      display:none;
    }

    /* âœ… åªè®“ã€Œç‹€æ…‹æ¨™ç±¤ã€ä¸åƒé»æ“Šï¼ˆé¿å…æ“‹ä½å¡ç‰‡é»æ“Šï¼‰ */
    .statusTag{ pointer-events:none !important; }

    /* âœ… é¸é …ç¾¤çµ„ UI */
    .optGroup{
      margin-top:10px;
      border:1px solid rgba(15,23,42,.08);
      border-radius:14px;
      padding:10px;
      background:#fff;
    }
    .optHead{display:flex; align-items:center; justify-content:space-between; gap:10px; flex-wrap:wrap}
    .optHead b{font-size:13.5px}
  </style>
</head>

<body>
  <div class="wrap">
    <div class="topbar">
      <div>
        <h1>ä½¿ç”¨è€…é»é¤</h1>
        <div class="muted" id="whoLine">å°šæœªé¸æ“‡ä½¿ç”¨è€…</div>
      </div>
      <div class="right">
        <span class="pill" id="statusPill">é€£ç·šä¸­â€¦</span>
        <button class="btn" id="btnSwitchAdmin">â¤ï¸</button>
        <button class="btn" id="btnLogout">ç™»å‡º</button>
      </div>
    </div>

    <div class="grid">
      <!-- LEFT -->
      <div>
        <div class="card">
          <h2>1ï¼‰ä½¿ç”¨è€…è³‡è¨Šï¼ˆéœ€å…ˆé¸æ“‡æ‰èƒ½é»é¤ï¼‰</h2>
          <div class="row">
            <div>
              <label>é¸æ“‡éƒ¨é–€</label>
              <select id="userDept">
                <option value="">è¼‰å…¥ä¸­â€¦</option>
              </select>
            </div>
            <div>
              <label>é¸æ“‡äººå“¡</label>
              <select id="userName" disabled>
                <option value="">è«‹å…ˆé¸éƒ¨é–€</option>
              </select>
            </div>
          </div>
          <p class="muted">æç¤ºï¼šè‹¥çœ‹ä¸åˆ°éƒ¨é–€/äººå“¡ï¼Œé€šå¸¸æ˜¯è³‡æ–™å°šæœªæ–°å¢ï¼Œæˆ– Rules/ç¶²è·¯å•é¡Œã€‚</p>
        </div>

        <div class="card" style="margin-top:14px">
          <h2>2ï¼‰é¸æ“‡é¤å»³ï¼ˆåªé¡¯ç¤ºã€Œç®¡ç†è€…é–‹æ”¾ã€çš„åº—å®¶ï¼‰</h2>
          <div id="restaurantList" class="restaurantGrid">
            <div class="muted">è¼‰å…¥ä¸­â€¦</div>
          </div>
        </div>

        <div class="card" style="margin-top:14px">
          <h2>3ï¼‰é¸æ“‡é¤é»</h2>
          <div id="closedBanner" class="banner">æ­¤åº—å®¶å·²çµå–®ï¼Œæš«åœæ¥å–®ã€‚</div>
          <div id="menuWrap" class="muted">è«‹å…ˆé¸æ“‡éƒ¨é–€ã€äººå“¡èˆ‡é¤å»³ã€‚</div>
        </div>
      </div>

      <!-- RIGHT -->
      <div>
        <div class="card">
          <h2>è³¼ç‰©è»Š</h2>
          <div id="cartWrap" class="muted">å°šæœªåŠ å…¥é¤é»ã€‚</div>

          <div class="hr"></div>

          <div class="row">
            <div>
              <label>è¨‚å–®æ—¥æœŸ</label>
              <input id="orderDate" type="date"/>
            </div>
            <div>
              <label>ç¸½é‡‘é¡</label>
              <input id="totalPrice" disabled value="0"/>
            </div>
          </div>

          <label>é€å‡ºå‰å‚™è¨»ï¼ˆæ•´ç­†è¨‚å–®ï¼‰</label>
          <textarea id="orderRemark" placeholder="ä¾‹ï¼šéƒ½ä¸è¦è¾£ã€å°‘é£¯â€¦"></textarea>

          <div class="inline" style="margin-top:12px">
            <button class="primary" id="btnSubmit" disabled>é€å‡º</button>
            <button class="btn" id="btnClearCart">æ¸…ç©º</button>
          </div>

          <p class="muted" style="margin-top:10px">é€å‡ºå¾Œæœƒè‡ªå‹•é¡¯ç¤ºåœ¨ä¸‹æ–¹ã€Œè¨‚è³¼ç´€éŒ„ã€ã€‚</p>

          <div class="hr"></div>
          <div class="inline">
            <span class="tag">ç®¡ç†è€…</span>
            <input id="adminPin" placeholder="è¼¸å…¥" style="flex:1; min-width:220px"/>
            <button class="btn" id="btnGoAdmin">é€å‡º</button>
          </div>
        </div>

        <div class="card" style="margin-top:14px">
          <h2>3ï¼‰è¨‚è³¼ç´€éŒ„ï¼ˆæŸ¥è©¢ï¼šæ—¥æœŸ / åº—å®¶ / è¼¸å…¥åç¨±ï¼‰</h2>

          <div class="row">
            <div>
              <label>è¨‚è³¼æ—¥æœŸ</label>
              <input id="qDate" type="date"/>
            </div>
            <div>
              <label>åº—å®¶</label>
              <select id="qRestaurant">
                <option value="">å…¨éƒ¨</option>
              </select>
            </div>
          </div>

          <label>è¼¸å…¥åç¨±ï¼ˆäººå“¡ï¼‰</label>
          <input id="qName" placeholder="ä¾‹ï¼šå°æ˜"/>

          <div class="inline" style="margin-top:12px">
            <button class="primary" id="btnQuery">æŸ¥è©¢</button>
            <button class="btn" id="btnMine">æŸ¥æˆ‘çš„</button>
            <button class="btn" id="btnToday">ğŸ²</button>
          </div>

          <div class="hr"></div>
          <div id="recordsWrap" class="muted">å°šç„¡è³‡æ–™ã€‚</div>
        </div>
      </div>
    </div>
  </div>

  <script type="module">
    const roleKey = "gb_role";
    if (!localStorage.getItem(roleKey)) localStorage.setItem(roleKey, "user");
    if (localStorage.getItem(roleKey) !== "user") location.href = "./index.html";

    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-app.js";
    import {
      getFirestore, collection, addDoc, doc, getDocs, getDoc,
      query, where, limit, deleteDoc
    } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyBdgOddTGAfqqHLnhnaJRv2_y7gyweuQEo",
      authDomain: "goldbricks-order.firebaseapp.com",
      projectId: "goldbricks-order",
      storageBucket: "goldbricks-order.firebasestorage.app",
      messagingSenderId: "463709758954",
      appId: "1:463709758954:web:429dc920f2f812d51cbe93",
      measurementId: "G-YQK8ZCC26R"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    const $ = (id)=> document.getElementById(id);
    const statusPill = $("statusPill");
    const esc = (s)=> (s??"").toString()
      .replaceAll("&","&amp;").replaceAll("<","&lt;").replaceAll(">","&gt;").replaceAll('"',"&quot;");

    const todayISO = ()=>{
      const d = new Date(); const pad = (n)=> String(n).padStart(2,"0");
      return `${d.getFullYear()}-${pad(d.getMonth()+1)}-${pad(d.getDate())}`;
    };

    statusPill.textContent = "å·²é€£ç·š Firestore";

    const colStaff = collection(db, "staff");
    const colRestaurants = collection(db, "restaurants");
    const colOrders = collection(db, "orders");

    let staffDeptMap = {};
    let restaurants = [];
    let selectedRestaurantId = "";
    let selectedRestaurantName = "";
    let selectedRestaurantClosed = false;
    let menuCache = {};
    let cart = [];
    let currentUserDept = "";
    let currentUserName = "";

    function setWhoLine(){
      const ok = currentUserDept && currentUserName;
      $("whoLine").innerHTML = ok
        ? `<span class="tag">${esc(currentUserDept)}</span> <span class="tag">${esc(currentUserName)}</span>`
        : `å°šæœªé¸æ“‡ä½¿ç”¨è€…`;
    }
    function canOrder(){
      return !!(currentUserDept && currentUserName && selectedRestaurantId);
    }
    function refreshClosedUI(){
      $("closedBanner").style.display = selectedRestaurantId && selectedRestaurantClosed ? "block" : "none";
    }
    function refreshSubmitState(){
      $("btnSubmit").disabled = !(canOrder() && cart.length>0 && !selectedRestaurantClosed);
    }

    async function loadStaff(){
      try{
        const snap = await getDocs(colStaff);
        const map = {};
        snap.forEach(d=>{
          const v = d.data() || {};
          const dept = (v.dept || "æœªåˆ†éƒ¨é–€").trim();
          const name = (v.name || "").trim();
          if(!name) return;
          if(!map[dept]) map[dept] = [];
          map[dept].push(name);
        });

        Object.keys(map).forEach(k=> map[k].sort((a,b)=> a.localeCompare(b,"zh-Hant")));
        staffDeptMap = map;

        const deptSel = $("userDept");
        const depts = Object.keys(staffDeptMap).sort((a,b)=> a.localeCompare(b,"zh-Hant"));
        deptSel.innerHTML = `<option value="">è«‹é¸æ“‡</option>` + depts.map(d=>`<option value="${esc(d)}">${esc(d)}</option>`).join("");

        deptSel.onchange = ()=>{
          currentUserDept = deptSel.value;
          currentUserName = "";
          const nameSel = $("userName");
          if(!currentUserDept){
            nameSel.disabled = true;
            nameSel.innerHTML = `<option value="">è«‹å…ˆé¸éƒ¨é–€</option>`;
          }else{
            nameSel.disabled = false;
            const list = staffDeptMap[currentUserDept] || [];
            nameSel.innerHTML = `<option value="">è«‹é¸æ“‡äººå“¡</option>` + list.map(n=>`<option value="${esc(n)}">${esc(n)}</option>`).join("");
          }
          setWhoLine();
          renderMenu();
          refreshSubmitState();
        };

        $("userName").onchange = ()=>{
          currentUserName = $("userName").value;
          setWhoLine();
          renderMenu();
          refreshSubmitState();
          if(currentUserName) $("qName").value = currentUserName;
        };

      }catch(err){
        console.error("loadStaff failed:", err);
        statusPill.textContent = "äººå“¡è®€å–å¤±æ•—ï¼ˆçœ‹ consoleï¼‰";
        $("userDept").innerHTML = `<option value="">è®€å–å¤±æ•—</option>`;
        $("userName").innerHTML = `<option value="">è®€å–å¤±æ•—</option>`;
      }
    }

    async function loadRestaurants(){
      try{
        const snap = await getDocs(colRestaurants);
        const list = [];
        snap.forEach(d=> list.push({ id:d.id, ...d.data() }));

        const visible = list.filter(r => r.isVisible !== false);

        visible.sort((a,b)=>{
          const aa = Number(a.createdAt||0), bb = Number(b.createdAt||0);
          if(bb !== aa) return bb - aa;
          return (a.name||"").localeCompare((b.name||""),"zh-Hant");
        });

        restaurants = visible;

        if(selectedRestaurantId && !restaurants.find(r=> r.id===selectedRestaurantId)){
          selectedRestaurantId = "";
          selectedRestaurantName = "";
          selectedRestaurantClosed = false;
          cart = [];
          renderCart();
        }

        renderRestaurants();
        fillRestaurantQuerySelect();
      }catch(err){
        console.error("loadRestaurants failed:", err);
        statusPill.textContent = "é¤å»³è®€å–å¤±æ•—ï¼ˆçœ‹ consoleï¼‰";
        $("restaurantList").innerHTML = `<div class="muted">è®€å–é¤å»³å¤±æ•—ï¼ˆRules/ç¶²è·¯ï¼‰</div>`;
      }
    }

    function renderRestaurants(){
      const wrap = $("restaurantList");
      if(restaurants.length===0){
        wrap.innerHTML = `<div class="muted">ç›®å‰æ²’æœ‰ã€Œé–‹æ”¾é¡¯ç¤ºã€çš„é¤å»³</div>`;
        return;
      }

      wrap.innerHTML = restaurants.map(r=>{
        const img = (r.imageUrl || "").trim();
        const hasImg = !!img;
        const sub = [r.address, r.phone].filter(Boolean).join(" Â· ");

        const closed = !!r.isClosed;
        const closedTag = closed
          ? `<span class="tag statusTag" style="border-color:rgba(239,68,68,.35); color:#7f1d1d; background:rgba(239,68,68,.06)">å·²çµå–®</span>`
          : `<span class="tag statusTag" style="border-color:rgba(16,185,129,.35); color:#065f46; background:rgba(16,185,129,.08)">é–‹å–®ä¸­</span>`;

        return `
          <div class="rCard ${r.id===selectedRestaurantId ? "active":""}" data-rid="${esc(r.id)}">
            ${hasImg
              ? `<img class="rImg" src="${esc(img)}" alt="img" onerror="this.style.display='none'">`
              : `<div class="rImg"></div>`
            }
            <div class="rBody">
              <div class="inline" style="justify-content:space-between">
                <h3>${esc(r.name||"æœªå‘½å")}</h3>
                ${closedTag}
              </div>
              <div class="muted">${esc(sub || "")}</div>
              <div class="inline" style="margin-top:8px">
                ${r.mapUrl ? `<span class="tag"><a href="${esc(r.mapUrl)}" target="_blank" style="color:inherit; text-decoration:none">Google Map</a></span>` : ``}
                ${img ? `<span class="tag"><a href="${esc(img)}" target="_blank" style="color:inherit; text-decoration:none">åœ–ç‰‡</a></span>` : ``}
              </div>
            </div>
          </div>
        `;
      }).join("");

      wrap.querySelectorAll(".rCard").forEach(el=>{
        el.onclick = async ()=>{
          const rid = el.dataset.rid;
          const r = restaurants.find(x=> x.id===rid);
          selectedRestaurantId = rid;
          selectedRestaurantName = r?.name || "";
          selectedRestaurantClosed = !!r?.isClosed;

          cart = [];
          renderCart();

          renderRestaurants();
          await loadMenu(rid);
          refreshClosedUI();
          renderMenu();
          refreshSubmitState();
        };
      });
    }

    function fillRestaurantQuerySelect(){
      const sel = $("qRestaurant");
      sel.innerHTML = `<option value="">å…¨éƒ¨</option>` + restaurants.map(r=>`<option value="${esc(r.id)}">${esc(r.name||"æœªå‘½å")}</option>`).join("");
    }

    async function loadMenu(rid){
      if(menuCache[rid]) return menuCache[rid];
      try{
        const menuCol = collection(db, "restaurants", rid, "menu");
        const snap = await getDocs(menuCol);
        const list = [];
        snap.forEach(d=> list.push({ id:d.id, ...d.data() }));

        list.sort((a,b)=>{
          const aa = Number(a.createdAt||0), bb = Number(b.createdAt||0);
          if(bb !== aa) return bb - aa;
          const ca = (a.category||"").localeCompare((b.category||""),"zh-Hant");
          if(ca !== 0) return ca;
          return (a.name||"").localeCompare((b.name||""),"zh-Hant");
        });

        menuCache[rid] = list;
        return list;
      }catch(err){
        console.error("loadMenu failed:", err);
        statusPill.textContent = "é¤é»è®€å–å¤±æ•—ï¼ˆçœ‹ consoleï¼‰";
        menuCache[rid] = [];
        return [];
      }
    }

    // ====== âœ… é¸é …ç¾¤çµ„å·¥å…·ï¼šå–®åƒ¹åŠ ç¸½ / é¡¯ç¤ºæ–‡å­— ======
    function optionUnitSum(optionGroups, chosen){
      const groups = Array.isArray(optionGroups) ? optionGroups : [];
      const pick = chosen || {};
      let sum = 0;
      for (let gi=0; gi<groups.length; gi++){
        const g = groups[gi] || {};
        if ((g.type || "single") !== "single") continue; // ç›®å‰å…ˆåš singleï¼ˆä¸‹æ‹‰ï¼‰
        const idx = Number(pick[gi]);
        if (!Number.isFinite(idx) || idx < 0) continue;
        const opt = (Array.isArray(g.options) ? g.options : [])[idx];
        if (!opt) continue;
        sum += Number(opt.price || 0);
      }
      return sum;
    }

    function optionText(optionGroups, chosen){
      const groups = Array.isArray(optionGroups) ? optionGroups : [];
      const pick = chosen || {};
      const out = [];
      for (let gi=0; gi<groups.length; gi++){
        const g = groups[gi] || {};
        if ((g.type || "single") !== "single") continue;
        const idx = Number(pick[gi]);
        const name = (g.name || "").trim();
        if (!Number.isFinite(idx) || idx < 0){
          // ä¸é¸ï¼ˆè‹¥ required false æ‰å¯èƒ½ï¼‰
          continue;
        }
        const opt = (Array.isArray(g.options) ? g.options : [])[idx];
        if (!opt) continue;
        const p = Number(opt.price || 0);
        out.push(`${name ? (name+"ï¼š") : ""}${opt.name || ""}${p ? (" +"+p) : ""}`);
      }
      return out.join("ï¼›");
    }

    function renderMenu(){
      const wrap = $("menuWrap");
      refreshClosedUI();

      if(!canOrder()){
        wrap.innerHTML = `<div class="muted">è«‹å…ˆé¸æ“‡éƒ¨é–€ã€äººå“¡èˆ‡é¤å»³ã€‚</div>`;
        return;
      }

      const rid = selectedRestaurantId;
      const menu = menuCache[rid] || [];
      if(menu.length===0){
        wrap.innerHTML = `<div class="muted">æ­¤é¤å»³å°šç„¡é¤é»</div>`;
        return;
      }

      const catMap = new Map();
      for(const m of menu){
        const cat = (m.category || "æœªåˆ†é¡").trim();
        if(!catMap.has(cat)) catMap.set(cat, []);
        catMap.get(cat).push(m);
      }

      wrap.innerHTML = `
        <div class="inline" style="justify-content:space-between">
          <div>
            <span class="tag">åº—å®¶</span>
            <b style="margin-left:8px">${esc(selectedRestaurantName)}</b>
          </div>
          <span class="muted">${selectedRestaurantClosed ? "å·²çµå–®ï¼šä¸å¯é€å‡º/åŠ å…¥" : "é»éŒ¯å¯åœ¨è³¼ç‰©è»Šåˆªé™¤"}</span>
        </div>
        <div class="hr"></div>
        ${Array.from(catMap.entries()).map(([cat, items])=>`
          <details open style="border:1px solid rgba(15,23,42,.10); border-radius:16px; padding:10px 12px; background:#fff; margin-top:12px;">
            <summary>${esc(cat)} <span class="tag" style="margin-left:8px">${items.length} é …</span></summary>
            <div style="margin-top:10px">
              ${items.map(m=>{
                const addons = Array.isArray(m.addons) ? m.addons : [];
                const optionGroups = Array.isArray(m.optionGroups) ? m.optionGroups : []; // âœ… æ–°å¢ï¼šé¸é …ç¾¤çµ„

                return `
                  <div class="menuItem" data-mid="${esc(m.id)}">
                    <div class="inline" style="justify-content:space-between">
                      <div>
                        <h4>${esc(m.name||"æœªå‘½å")}</h4>
                        <div class="muted">åƒ¹æ ¼ï¼š${Number(m.price||0)}ã€€ï½œã€€é è¨­æ•¸é‡ï¼š${Number(m.defaultQty||1)}</div>
                      </div>
                      <span class="tag">${optionGroups.length ? "æœ‰é¸é …/åŠ è³¼" : (addons.length ? "å¯åŠ è³¼" : "â€”")}</span>
                    </div>

                    <div class="addonBox">
                      ${optionGroups.length ? `
                        <div class="muted" style="margin-bottom:6px">é¸é …ï¼ˆä¸‹æ‹‰ï¼‰</div>
                        ${optionGroups.map((g,gi)=>{
                          const type = (g.type || "single");
                          if(type !== "single") return ``; // å…ˆåšå–®é¸ä¸‹æ‹‰
                          const req = (g.required !== false);
                          const opts = Array.isArray(g.options) ? g.options : [];
                          const hasPrice = opts.some(o=> Number(o?.price||0) > 0);

                          return `
                            <div class="optGroup">
                              <div class="optHead">
                                <b>${esc(g.name || "é¸é …")}</b>
                                <span class="tag">${req ? "å¿…é¸" : "å¯ä¸é¸"}${hasPrice ? "ï¼ˆå¯åŠ åƒ¹ï¼‰" : ""}</span>
                              </div>
                              <select data-opt-mid="${esc(m.id)}" data-gi="${gi}" ${selectedRestaurantClosed?"disabled":""}>
                                ${req ? `` : `<option value="-1">ä¸é¸æ“‡</option>`}
                                ${opts.map((o,oi)=>{
                                  const p = Number(o?.price||0);
                                  return `<option value="${oi}">${esc(o?.name||"")} ${p?(" +"+p):""}</option>`;
                                }).join("")}
                              </select>
                              <div class="muted" style="margin-top:6px">â€» é€å‡ºå¾Œæœƒè¨˜éŒ„æ­¤é¸é …</div>
                            </div>
                          `;
                        }).join("")}
                        <div class="hr"></div>
                      ` : ``}

                      <div class="muted">åŠ è³¼é …ç›®ï¼ˆå¯å¤šé¸ï¼‰</div>
                      ${addons.length===0
                        ? `<div class="muted" style="margin-top:6px">ï¼ˆæ­¤é¤é»ç„¡åŠ è³¼ï¼‰</div>`
                        : addons.map((a,idx)=>`
                            <label class="addonRow">
                              <div class="inline">
                                <input type="checkbox" data-addon-mid="${esc(m.id)}" data-idx="${idx}" ${selectedRestaurantClosed?"disabled":""}>
                                <div>
                                  <b>${esc(a.name||"")}</b>
                                  <span class="tag" style="margin-left:8px">+${Number(a.price||0)}</span>
                                  ${a.free ? `<span class="tag" style="margin-left:6px">å…è²»</span>` : ``}
                                </div>
                              </div>
                            </label>
                          `).join("")
                      }

                      <div class="qtyRow">
                        <div style="flex:1; min-width:180px">
                          <label style="margin:10px 0 6px">æ•¸é‡</label>
                          <input type="number" min="1" value="${Math.max(1, Number(m.defaultQty||1))}" data-qty-mid="${esc(m.id)}" ${selectedRestaurantClosed?"disabled":""}>
                        </div>
                        <div style="flex:2; min-width:240px">
                          <label style="margin:10px 0 6px">å‚™è¨»ï¼ˆå–®å“ï¼‰</label>
                          <input placeholder="ä¾‹ï¼šä¸è¦é¦™èœ" data-note-mid="${esc(m.id)}" ${selectedRestaurantClosed?"disabled":""}>
                        </div>
                        <div style="align-self:end">
                          <button class="primary" type="button" data-add-to-cart="${esc(m.id)}" ${selectedRestaurantClosed?"disabled":""}>åŠ å…¥</button>
                        </div>
                      </div>
                    </div>
                  </div>
                `;
              }).join("")}
            </div>
          </details>
        `).join("")}
      `;

      wrap.querySelectorAll("button[data-add-to-cart]").forEach(btn=>{
        btn.onclick = ()=>{
          if(selectedRestaurantClosed) return alert("æ­¤åº—å®¶å·²çµå–®ï¼Œæš«åœæ¥å–®ã€‚");

          const mid = btn.dataset.addToCart;
          const m = (menuCache[selectedRestaurantId] || []).find(x=> x.id===mid);
          if(!m) return;

          const qtyEl = wrap.querySelector(`[data-qty-mid="${mid}"]`);
          const noteEl = wrap.querySelector(`[data-note-mid="${mid}"]`);
          const qty = Math.max(1, Number(qtyEl?.value || 1));
          const note = (noteEl?.value || "").trim();

          // âœ… å–åŠ è³¼ï¼ˆå¤šé¸ï¼‰
          const addonsAll = Array.isArray(m.addons) ? m.addons : [];
          const checkedEls = wrap.querySelectorAll(`[data-addon-mid="${mid}"]`);
          const pickedAddons = [];
          checkedEls.forEach(ch=>{
            if(ch.checked){
              const idx = Number(ch.dataset.idx);
              const a = addonsAll[idx];
              if(a) pickedAddons.push({ name: a.name, price: Number(a.price||0), free: !!a.free });
            }
          });

          // âœ… å–ã€Œé¸é …ï¼ˆä¸‹æ‹‰ï¼‰ã€ï¼šoptionGroups
          const optionGroups = Array.isArray(m.optionGroups) ? m.optionGroups : [];
          const chosenOptions = {}; // { gi: optionIndex }
          let optionValid = true;

          wrap.querySelectorAll(`[data-opt-mid="${mid}"]`).forEach(sel=>{
            const gi = Number(sel.dataset.gi);
            const g = optionGroups[gi] || {};
            const req = (g.required !== false);
            const val = Number(sel.value);
            if(req && (!Number.isFinite(val) || val < 0)){
              optionValid = false;
              return;
            }
            chosenOptions[gi] = val; // -1 ä»£è¡¨ä¸é¸
          });

          if(!optionValid) return alert("æ­¤é¤é»æœ‰å¿…é¸é¸é …ï¼Œè«‹å…ˆé¸æ“‡ã€‚");

          cart.push({
            rid: selectedRestaurantId,
            restaurantName: selectedRestaurantName,
            menuId: mid,
            name: m.name || "",
            price: Number(m.price||0),
            qty,
            note,
            addons: pickedAddons,

            // âœ… æ–°å¢ï¼šé¸é …ç¾¤çµ„ï¼ˆåŸæ–‡ + é¸åˆ°çš„å€¼ï¼‰
            optionGroups: optionGroups,
            chosenOptions: chosenOptions
          });

          if(noteEl) noteEl.value = "";
          checkedEls.forEach(ch=> ch.checked = false);

          renderCart();
          refreshSubmitState();
        };
      });
    }

    function addonSum(it){
      return (it.addons||[]).reduce((s,a)=> s + (a && a.free ? 0 : Number(a.price||0)), 0);
    }
    function optionSum(it){
      return optionUnitSum(it.optionGroups, it.chosenOptions);
    }
    function calcLineTotal(it){
      return (Number(it.price||0) + addonSum(it) + optionSum(it)) * Number(it.qty||0);
    }
    function calcTotal(){
      return cart.reduce((s,it)=> s + calcLineTotal(it), 0);
    }

    function renderCart(){
      const wrap = $("cartWrap");
      if(cart.length===0){
        wrap.innerHTML = `<div class="muted">å°šæœªåŠ å…¥é¤é»ã€‚</div>`;
        $("totalPrice").value = "0";
        return;
      }

      wrap.innerHTML = cart.map((it, idx)=>{
        const addonTxt = (it.addons||[]).map(a=>{
          const p = (a && a.free) ? 0 : Number(a.price||0);
          return `+${a.name}${p?(" "+p):""}${a.free?"(å…è²»)":""}`;
        }).join("");

        const optTxt = optionText(it.optionGroups, it.chosenOptions);
        const noteTxt = it.note ? `ï¼ˆå‚™è¨»ï¼š${esc(it.note)}ï¼‰` : "";
        const lineTotal = calcLineTotal(it);

        return `
          <div class="cartLine">
            <div class="top">
              <div>
                <b>${esc(it.name)}</b>
                <span class="tag" style="margin-left:8px">${esc(it.restaurantName||"")}</span>

                ${optTxt ? `<div class="muted" style="margin-top:6px">é¸é …ï¼š${esc(optTxt)}</div>` : ``}
                ${addonTxt ? `<div class="muted" style="margin-top:6px">åŠ è³¼ï¼š${esc(addonTxt)}</div>` : ``}

                <div class="muted" style="margin-top:6px">
                  å–®åƒ¹ï¼š${Number(it.price||0)} ${optTxt?`ï¼ˆé¸é …åŠ åƒ¹ +${optionSum(it)}ï¼‰`:``} ${addonTxt?`ï¼ˆåŠ è³¼ +${addonSum(it)}ï¼‰`:``}
                  Ã— ${Number(it.qty||0)} ${noteTxt}
                </div>
                <div class="muted" style="margin-top:6px">å°è¨ˆï¼š${lineTotal}</div>
              </div>
              <button class="btn danger" type="button" data-del-cart="${idx}">åˆªé™¤</button>
            </div>
          </div>
        `;
      }).join("");

      wrap.querySelectorAll("button[data-del-cart]").forEach(b=>{
        b.onclick = ()=>{
          const i = Number(b.dataset.delCart);
          if(!confirm("ç¢ºå®šåˆªé™¤é€™å€‹å“é …ï¼Ÿ")) return;
          cart.splice(i,1);
          renderCart();
          refreshSubmitState();
        };
      });

      $("totalPrice").value = String(calcTotal());
    }

    async function submitOrder(){
      if(!canOrder()) return alert("è«‹å…ˆé¸æ“‡éƒ¨é–€ã€äººå“¡èˆ‡é¤å»³");
      if(cart.length===0) return alert("è³¼ç‰©è»Šæ˜¯ç©ºçš„");

      try{
        const rSnap = await getDoc(doc(db, "restaurants", selectedRestaurantId));
        const rData = rSnap.exists() ? rSnap.data() : null;
        const visible = rData ? (rData.isVisible !== false) : false;
        const closed = rData ? !!rData.isClosed : true;

        if(!visible) return alert("æ­¤åº—å®¶å·²è¢«ç®¡ç†è€…éš±è—ï¼Œç„¡æ³•é€å–®ã€‚");
        if(closed) return alert("æ­¤åº—å®¶å·²çµå–®ï¼Œæš«åœæ¥å–®ã€‚");
      }catch(err){
        console.error("check closed failed:", err);
        return alert("ç„¡æ³•ç¢ºèªåº—å®¶ç‹€æ…‹ï¼ˆRules/ç¶²è·¯ï¼‰ï¼Œæš«åœé€å–®ã€‚");
      }

      const orderDate = $("orderDate").value || todayISO();
      const remark = ($("orderRemark").value || "").trim();

      const payload = {
        orderDate,
        createdAt: Date.now(),
        userDept: currentUserDept,
        userName: currentUserName,
        restaurantId: selectedRestaurantId,
        restaurantName: selectedRestaurantName,
        orderNote: remark,
        remark: remark,
        total: calcTotal(),
        items: cart.map(it=>({
          menuId: it.menuId,
          name: it.name,
          price: Number(it.price||0),
          qty: Number(it.qty||0),
          note: it.note || "",

          // âœ… åŸæœ¬åŠ è³¼
          addons: (it.addons||[]).map(a=>({ name:a.name, price:Number(a.price||0), free:!!a.free })),

          // âœ… æ–°å¢ï¼šé¸é …ï¼ˆä¸‹æ‹‰ï¼‰
          optionGroups: Array.isArray(it.optionGroups) ? it.optionGroups : [],
          chosenOptions: it.chosenOptions || {}
        }))
      };

      try{
        statusPill.textContent = "é€å‡ºä¸­â€¦";
        await addDoc(colOrders, payload);
        statusPill.textContent = "é€å‡ºå®Œæˆ âœ…";
        alert("è¨‚å–®å·²é€å‡ºï¼");

        cart = [];
        $("orderRemark").value = "";
        renderCart();
        refreshSubmitState();

        $("qDate").value = orderDate;
        await queryRecords();
      }catch(err){
        console.error("submitOrder failed:", err);
        statusPill.textContent = "é€å‡ºå¤±æ•—ï¼ˆçœ‹ consoleï¼‰";
        alert("é€å‡ºå¤±æ•—ï¼ˆRules/ç¶²è·¯ï¼‰\n\n" + (err?.message || err));
      }
    }

    function getCurrentName(){
      return (currentUserName || "").trim();
    }

    async function queryRecords(){
      const qDate = ($("qDate").value || "").trim();
      const qRid = ($("qRestaurant").value || "").trim();
      const qName = ($("qName").value || "").trim();

      try{
        statusPill.textContent = "æŸ¥è©¢ä¸­â€¦";

        let snap;
        if(qDate){
          snap = await getDocs(query(colOrders, where("orderDate","==", qDate), limit(3000)));
        }else{
          snap = await getDocs(query(colOrders, limit(3000)));
        }

        const rows = [];
        snap.forEach(d=> rows.push({ id:d.id, ...d.data() }));

        const filtered = rows.filter(o=>{
          if(qRid && o.restaurantId !== qRid) return false;
          if(qName && !(String(o.userName||"").includes(qName))) return false;
          return true;
        }).sort((a,b)=> Number(b.createdAt||0) - Number(a.createdAt||0));

        renderRecords(filtered);
        statusPill.textContent = "å·²æŸ¥è©¢ âœ…";
      }catch(err){
        console.error("queryRecords failed:", err);
        statusPill.textContent = "æŸ¥è©¢å¤±æ•—ï¼ˆçœ‹ consoleï¼‰";
        $("recordsWrap").innerHTML = `<div class="muted">æŸ¥è©¢å¤±æ•—ï¼ˆRules/ç¶²è·¯ï¼‰</div>`;
        alert("æŸ¥è©¢å¤±æ•—ï¼ˆRules/ç¶²è·¯ï¼‰\n\n" + (err?.message || err));
      }
    }

    function renderRecords(list){
      const wrap = $("recordsWrap");
      if(list.length===0){
        wrap.innerHTML = `<div class="muted">å°šç„¡è³‡æ–™ã€‚</div>`;
        return;
      }

      wrap.innerHTML = list.map(o=>{
        const items = Array.isArray(o.items) ? o.items : [];
        const itemLines = items.map(it=>{
          const addonTxt = (it.addons||[]).map(a=>{
            const p = (a && a.free) ? 0 : Number(a.price||0);
            return `+${a.name}${p?(" "+p):""}${a.free?"(å…è²»)":""}`;
          }).join("");

          const optTxt = optionText(it.optionGroups, it.chosenOptions);
          const noteTxt = it.note ? `ï¼ˆå‚™è¨»ï¼š${esc(it.note)}ï¼‰` : "";

          const base = `â€¢ ${esc(it.name)} ${Number(it.price||0)} Ã— ${Number(it.qty||0)} ${noteTxt}`;
          const optLine = optTxt ? `<div class="muted" style="margin-top:4px">ã€€ã€€é¸é …ï¼š${esc(optTxt)}</div>` : ``;
          const addonLine = addonTxt ? `<div class="muted" style="margin-top:4px">ã€€ã€€åŠ è³¼ï¼š${esc(addonTxt)}</div>` : ``;

          return `${base}${optLine}${addonLine}`;
        }).join("<br/>");

        const canDelete = (getCurrentName() && (o.userName === getCurrentName()));
        return `
          <div style="padding:10px 12px; border:1px solid rgba(15,23,42,.10); border-radius:14px; margin-top:10px; background:#fff">
            <div class="inline" style="justify-content:space-between">
              <div>
                <b>${esc(o.userDept||"")}</b> / <b>${esc(o.userName||"")}</b>
                â€” <span class="tag">${esc(o.restaurantName||"")}</span>
                ${o.orderDate ? `<span class="tag" style="margin-left:6px">${esc(o.orderDate)}</span>` : ``}
              </div>
              ${canDelete ? `<button class="btn danger" type="button" data-del-order="${esc(o.id)}">åˆªé™¤</button>` : ``}
            </div>
            <div class="muted" style="margin-top:8px">${itemLines}</div>
            <div class="muted" style="margin-top:8px">ç¸½é‡‘é¡ï¼š${Number(o.total||0)} ${(o.orderNote||o.remark)?`ï½œæ•´ç­†å‚™è¨»ï¼š${esc(o.orderNote||o.remark)}`:""}</div>
          </div>
        `;
      }).join("");

      wrap.querySelectorAll("button[data-del-order]").forEach(btn=>{
        btn.onclick = async ()=>{
          const id = btn.dataset.delOrder;
          if(!confirm("ç¢ºå®šåˆªé™¤é€™ç­†è¨‚å–®ï¼Ÿ")) return;
          try{
            await deleteDoc(doc(db, "orders", id));
            await queryRecords();
          }catch(err){
            console.error("delete order failed:", err);
            alert("åˆªé™¤å¤±æ•—ï¼ˆRules/ç¶²è·¯ï¼‰\n\n" + (err?.message || err));
          }
        };
      });
    }

    $("btnSubmit").onclick = submitOrder;

    $("btnClearCart").onclick = ()=>{
      if(cart.length===0) return;
      if(!confirm("ç¢ºå®šæ¸…ç©ºè³¼ç‰©è»Šï¼Ÿ")) return;
      cart = [];
      renderCart();
      refreshSubmitState();
    };

    $("btnQuery").onclick = queryRecords;
    $("btnMine").onclick = async ()=>{
      if(currentUserName) $("qName").value = currentUserName;
      await queryRecords();
    };
    $("btnToday").onclick = async ()=>{
      $("qDate").value = todayISO();
      await queryRecords();
    };

    $("btnGoAdmin").onclick = ()=>{
      const pin = ($("adminPin").value || "").trim();
      if(pin !== "8520") return alert("ç®¡ç†è€…å¯†ç¢¼ä¸æ­£ç¢º");
      localStorage.setItem(roleKey, "admin");
      location.href = "./admin.html";
    };
    $("btnSwitchAdmin").onclick = ()=> $("adminPin").focus();

    $("btnLogout").onclick = ()=>{
      localStorage.removeItem(roleKey);
      location.href = "./index.html";
    };

    $("orderDate").value = todayISO();
    $("qDate").value = todayISO();
    setWhoLine();
    renderCart();
    refreshSubmitState();

    await loadStaff();
    await loadRestaurants();
    await queryRecords();

    document.addEventListener("visibilitychange", async ()=>{
      if(document.visibilityState === "visible"){
        await loadRestaurants();
        refreshClosedUI();
        renderMenu();
        refreshSubmitState();
      }
    });
  </script>
</body>
</html>
