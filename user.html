<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <title>GoldBricks 訂餐系統 - 使用者</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <style>
    * { box-sizing: border-box; margin: 0; padding: 0; }
    body {
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      background: #f9fafb;
      min-height: 100vh;
      display: flex;
      justify-content: center;
      padding: 24px;
    }
    .container {
      width: 100%;
      max-width: 900px;
    }
    h2 {
      font-size: 20px;
      margin-bottom: 4px;
    }
    .sub {
      font-size: 13px;
      color: #6b7280;
      margin-bottom: 16px;
    }
    .card {
      background: #fff;
      border-radius: 16px;
      padding: 16px 18px;
      box-shadow: 0 8px 25px rgba(15,23,42,0.06);
      margin-bottom: 16px;
    }
    .group {
      display: grid;
      grid-template-columns: repeat(auto-fit,minmax(180px,1fr));
      gap: 12px 16px;
    }
    label {
      display: block;
      font-size: 13px;
      margin-bottom: 4px;
      color: #374151;
    }
    select, input {
      width: 100%;
      padding: 8px 10px;
      border-radius: 10px;
      border: 1px solid #d1d5db;
      font-size: 13px;
    }
    input:focus, select:focus {
      outline: none;
      border-color: #fb7185;
      box-shadow: 0 0 0 2px rgba(251,113,133,0.2);
    }
    .btn {
      margin-top: 12px;
      padding: 8px 14px;
      border-radius: 999px;
      border: none;
      background: linear-gradient(90deg,#fb7185,#f97316);
      color: white;
      font-size: 13px;
      font-weight: 600;
      cursor: pointer;
    }
    .btn.secondary {
      background: #e5e7eb;
      color: #111827;
    }
    .list {
      margin-top: 10px;
      font-size: 13px;
      max-height: 300px;
      overflow-y: auto;
      border-top: 1px solid #e5e7eb;
      padding-top: 8px;
    }
    .order-row {
      padding: 6px 0;
      border-bottom: 1px dashed #e5e7eb;
    }
    .order-row:last-child {
      border-bottom: none;
    }
    .topbar {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 12px;
    }
    .topbar .info {
      font-size: 13px;
      color: #6b7280;
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="topbar">
      <div>
        <h2>使用者訂餐頁</h2>
        <div class="sub">選擇部門與人員，之後可進行訂餐與查看紀錄。</div>
      </div>
      <div class="info">
        <button class="btn secondary" id="goAdmin">切換管理者模式</button>
        <button class="btn secondary" id="logout">登出</button>
      </div>
    </div>

    <!-- 使用者資訊 -->
    <div class="card">
      <h3 style="font-size:16px;margin-bottom:8px;">1. 使用者資訊</h3>
      <div class="group">
        <div>
          <label>選擇部門</label>
          <select id="deptSelect">
            <option value="">請選擇部門</option>
            <option value="管理部">管理部</option>
            <option value="FAE">FAE</option>
            <option value="TSE">TSE</option>
            <option value="新場">新場</option>
            <option value="倉管">倉管</option>
            <option value="數據分析">數據分析</option>
            <option value="RD">RD</option>
            <option value="線上客服">線上客服</option>
            <option value="維運">維運</option>
          </select>
        </div>
        <div>
          <label>選擇人員</label>
          <select id="userSelect">
            <option value="">請先選擇部門</option>
          </select>
        </div>
      </div>
      <button class="btn" id="saveUser">確認使用者</button>
      <div class="sub" id="currentUserInfo" style="margin-top:8px;"></div>
    </div>

    <!-- 訂購紀錄 -->
    <div class="card">
      <h3 style="font-size:16px;margin-bottom:8px;">2. 訂購紀錄</h3>
      <div class="group">
        <div>
          <label>訂購日期</label>
          <input type="date" id="searchDate">
        </div>
        <div>
          <label>店家</label>
          <input id="searchStore" placeholder="輸入店家名稱關鍵字">
        </div>
        <div>
          <label>輸入名稱（餐點）</label>
          <input id="searchName" placeholder="輸入餐點關鍵字">
        </div>
      </div>
      <button class="btn" id="searchOrders">查詢訂購紀錄</button>

      <div class="list" id="orderList">
        <!-- 顯示查詢結果 -->
      </div>
    </div>
  </div>

  <script>
    // 簡單身分檢查：沒有 user 角色就導回首頁
    (function checkRole() {
      const role = localStorage.getItem("role");
      if (role !== "user") {
        // 讓管理者也可以從 admin 切過來
        if (role === "admin") return;
        window.location.href = "index.html";
      }
    })();

    // 切換管理者模式 / 登出
    document.getElementById("goAdmin").addEventListener("click", () => {
      localStorage.setItem("role", "admin");
      window.location.href = "admin.html";
    });
    document.getElementById("logout").addEventListener("click", () => {
      localStorage.removeItem("role");
      window.location.href = "index.html";
    });

    // ====== 假的人員資料（之後改成從 Firebase 讀取 staffByDept） ======
    const staffByDept = {
      "管理部": ["小美","小王"],
      "FAE": ["FAE-1","FAE-2"],
      "TSE": [],
      "新場": [],
      "倉管": [],
      "數據分析": [],
      "RD": [],
      "線上客服": [],
      "維運": []
    };

    const deptSelect = document.getElementById("deptSelect");
    const userSelect = document.getElementById("userSelect");
    const currentUserInfo = document.getElementById("currentUserInfo");

    deptSelect.addEventListener("change", () => {
      const dept = deptSelect.value;
      userSelect.innerHTML = "";
      if (!dept) {
        userSelect.innerHTML = '<option value="">請先選擇部門</option>';
        return;
      }
      const people = staffByDept[dept] || [];
      if (people.length === 0) {
        userSelect.innerHTML = '<option value="">目前此部門尚無人員（請管理者新增）</option>';
        return;
      }
      userSelect.innerHTML = '<option value="">請選擇人員</option>';
      people.forEach(name => {
        const opt = document.createElement("option");
        opt.value = name;
        opt.textContent = name;
        userSelect.appendChild(opt);
      });
    });

    document.getElementById("saveUser").addEventListener("click", () => {
      const dept = deptSelect.value;
      const name = userSelect.value;
      if (!dept || !name) {
        alert("請先選擇部門與人員");
        return;
      }
      const userInfo = { dept, name };
      localStorage.setItem("currentUser", JSON.stringify(userInfo));
      currentUserInfo.textContent = `目前使用者：${dept} - ${name}`;
    });

    // 讀取之前選擇的使用者
    (function loadCurrentUser() {
      const raw = localStorage.getItem("currentUser");
      if (!raw) return;
      try {
        const u = JSON.parse(raw);
        currentUserInfo.textContent = `目前使用者：${u.dept} - ${u.name}`;
      } catch(e) {}
    })();

    // ====== 假的訂單資料（之後改成 Firebase orders） ======
    const mockOrders = [
      {
        date: "2025-01-01",
        store: "小王便當",
        user: "小美",
        dept: "管理部",
        items: [
          { name: "排骨飯", price: 70, addons: ["加蛋+10"], qty: 2 },
          { name: "排骨飯", price: 70, addons: [], qty: 1 }
        ]
      },
      {
        date: "2025-01-01",
        store: "小王便當",
        user: "小王",
        dept: "管理部",
        items: [
          { name: "豬腳飯", price: 80, addons: ["加菜+30"], qty: 1 }
        ]
      }
    ];

    const orderList = document.getElementById("orderList");

    function renderOrders(orders) {
      orderList.innerHTML = "";
      if (orders.length === 0) {
        orderList.innerHTML = '<div style="color:#9ca3af;">查無紀錄</div>';
        return;
      }
      orders.forEach(o => {
        const div = document.createElement("div");
        div.className = "order-row";
        div.innerHTML = `
          <div style="font-weight:600;">${o.date}｜${o.store}｜${o.dept} - ${o.user}</div>
          <div style="font-size:12px;color:#6b7280;">
            ${o.items.map(i => {
              const addonText = i.addons.join("、") || "無加購";
              return `${i.name}${i.price ? "(" + i.price + ")" : ""} + ${addonText} 數量${i.qty}`;
            }).join("；")}
          </div>
        `;
        orderList.appendChild(div);
      });
    }

    // 預設顯示全部
    renderOrders(mockOrders);

    document.getElementById("searchOrders").addEventListener("click", () => {
      const date = document.getElementById("searchDate").value;
      const store = document.getElementById("searchStore").value.trim();
      const name = document.getElementById("searchName").value.trim();

      let filtered = [...mockOrders];

      if (date) {
        filtered = filtered.filter(o => o.date === date);
      }
      if (store) {
        filtered = filtered.filter(o => o.store.includes(store));
      }
      if (name) {
        filtered = filtered.filter(o =>
          o.items.some(i => i.name.includes(name))
        );
      }

      renderOrders(filtered);
    });
  </script>
</body>
</html>
