<!doctype html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>GoldBricks 呷奔啊~~ </title>
  <style>
    :root{
      --bg:#f5f4fb; --card:#fff; --text:#0f172a; --muted:#64748b;
      --primary:#fb7185; --primary2:#ff9a9e; --border:rgba(15,23,42,.10);
      --shadow:0 10px 30px rgba(15,23,42,.10); --radius:18px;
    }
    *{box-sizing:border-box}
    body{
      margin:0; font-family: ui-sans-serif, system-ui, -apple-system, "Segoe UI", Arial;
      background: radial-gradient(1200px 500px at 20% -10%, rgba(251,113,133,.22), transparent 60%),
                  radial-gradient(900px 500px at 100% 0%, rgba(255,154,158,.14), transparent 55%),
                  var(--bg);
      color:var(--text); min-height:100vh;
    }
    .wrap{padding:16px; max-width:1200px; margin:0 auto}
    .topbar{
      display:flex; align-items:center; justify-content:space-between; gap:12px;
      background: rgba(255,255,255,.78); border:1px solid var(--border);
      border-radius: var(--radius); box-shadow: var(--shadow); backdrop-filter: blur(10px);
      padding:12px 14px;
    }
    .topbar h1{margin:0; font-size:18px}
    .right{display:flex; align-items:center; gap:10px; flex-wrap:wrap}
    .pill{padding:8px 12px; border-radius:999px; border:1px solid var(--border); background:#fff; color:var(--muted); font-size:12.5px}
    .btn{
      padding:9px 12px; border-radius:14px; border:1px solid var(--border);
      background:#fff; cursor:pointer; font-weight:900;
    }
    .primary{
      border:none; background: linear-gradient(90deg, var(--primary), var(--primary2));
      color:#fff; box-shadow: 0 14px 28px rgba(251,113,133,.22);
    }
    .grid{display:grid; grid-template-columns: 1.3fr .9fr; gap:14px; margin-top:14px}
    @media (max-width:980px){.grid{grid-template-columns:1fr}}
    .card{
      background:#fff; border:1px solid var(--border); border-radius:var(--radius);
      box-shadow: 0 8px 25px rgba(15,23,42,.07); padding:14px;
    }
    .card h2{margin:0 0 10px; font-size:15px}
    label{display:block; font-size:13px; color:var(--muted); margin:10px 0 6px;}
    input,select,textarea{
      width:100%; padding:11px 12px; border-radius:14px;
      border:1px solid var(--border); outline:none; background:#fff; font-size:14px;
    }
    textarea{min-height:92px; resize:vertical}
    input:focus,select:focus,textarea:focus{border-color: rgba(251,113,133,.7)}
    .row{display:grid; grid-template-columns: 1fr 1fr; gap:10px}
    .hr{height:1px; background: var(--border); margin:12px 0}
    .muted{color:var(--muted); font-size:12.5px; line-height:1.6}
    .tag{display:inline-flex; padding:5px 10px; border-radius:999px; border:1px solid var(--border); background:#fff; color:var(--muted); font-size:12px}
    .inline{display:flex; gap:10px; align-items:center; flex-wrap:wrap}
    .restGrid{display:grid; grid-template-columns: repeat(3, 1fr); gap:10px}
    @media (max-width:980px){.restGrid{grid-template-columns: repeat(2, 1fr)}}
    @media (max-width:520px){.restGrid{grid-template-columns: 1fr}}
    .restCard{
      border:1px solid rgba(15,23,42,.10); border-radius:16px; padding:12px;
      background:#fff; cursor:pointer;
    }
    .restCard.active{
      border-color: rgba(251,113,133,.55);
      box-shadow: 0 10px 22px rgba(251,113,133,.18);
      background: linear-gradient(90deg, rgba(251,113,133,.10), rgba(255,154,158,.06));
    }
    .imgBtn{padding:6px 10px; border-radius:999px; border:1px solid var(--border); background:#fff; cursor:pointer; font-weight:900; font-size:12px}
    table{width:100%; border-collapse:collapse; font-size:13.5px}
    th,td{border-bottom:1px solid rgba(15,23,42,.08); padding:10px 8px; text-align:left; vertical-align:top}
    th{color:var(--muted); font-weight:900}
    .btnSmall{padding:7px 10px; border-radius:12px; border:1px solid var(--border); background:#fff; cursor:pointer; font-weight:900; font-size:12.5px; white-space:nowrap}
    .btnDanger{border-color: rgba(239,68,68,.35)}
    .btnDanger:hover{border-color: rgba(239,68,68,.60)}
    .btnOk:hover{border-color: rgba(16,185,129,.55)}
    .itemBox{border:1px solid rgba(15,23,42,.10); border-radius:16px; padding:12px; margin-top:10px; background:#fff}
    .addonPill{display:inline-flex; align-items:center; gap:6px; margin:6px 6px 0 0; padding:6px 10px; border:1px solid rgba(15,23,42,.10); border-radius:999px; cursor:pointer; user-select:none}
    .addonPill input{width:18px; height:18px}
    dialog{
      border:none; border-radius:16px; padding:0; max-width:420px; width:calc(100% - 24px);
      box-shadow: 0 20px 60px rgba(15,23,42,.25);
    }
    dialog::backdrop{background: rgba(15,23,42,.45)}
    .dlg{padding:14px}
    .dlg h3{margin:0 0 10px; font-size:15px}
  </style>
</head>

<body>
<div class="wrap">
  <div class="topbar">
    <div>
      <h1>使用者點餐</h1>
      <div class="muted" style="margin-top:2px">尚未選擇使用者</div>
    </div>
    <div class="right">
      <span class="pill" id="statusPill">連線中…</span>

      <!-- ✅ 改回：切換管理者（彈出輸入 PIN） -->
      <button class="btn" id="btnSwitchAdmin" type="button">管理者</button>

      <button class="btn" id="btnLogout" type="button">登出</button>
    </div>
  </div>

  <div class="grid">

    <!-- 左側：選人 + 選餐廳 + 點餐 -->
    <div>
      <div class="card">
        <h2>1）使用者資訊（需先選擇才能點餐）</h2>

        <div class="row">
          <div>
            <label>選擇部門</label>
            <select id="deptSelect">
              <option value="">請選擇</option>
            </select>
          </div>
          <div>
            <label>選擇人員</label>
            <select id="nameSelect" disabled>
              <option value="">請先選部門</option>
            </select>
          </div>
        </div>
        <p class="muted" id="hintUser" style="margin-top:10px">
          提示：若看不到部門/人員，通常是資料尚未新增，或 Rules/網路問題。
        </p>
      </div>

      <div class="card" style="margin-top:14px">
        <h2>2）選擇餐廳</h2>
        <div id="restaurantsWrap" class="muted">載入中…</div>
      </div>

      <div class="card" style="margin-top:14px">
        <h2>3）選擇餐點</h2>
        <div id="menuWrap" class="muted">請先選擇部門、人員與餐廳。</div>
      </div>
    </div>

    <!-- 右側：購物車 / 送出 / 查詢 -->
    <div>
      <div class="card">
        <h2>購物車</h2>
        <div id="cartWrap" class="muted">尚未加入餐點。</div>

        <div class="hr"></div>

        <div class="row">
          <div>
            <label>訂單日期</label>
            <input id="orderDate" type="date"/>
          </div>
          <div>
            <label>總金額</label>
            <input id="totalAmount" value="0" readonly/>
          </div>
        </div>

        <label>送出前備註（整筆訂單）</label>
        <textarea id="orderNote" placeholder="例：都不要辣、少飯…"></textarea>

        <div class="inline" style="margin-top:12px">
          <button class="btn primary" id="btnSubmit" type="button">送出</button>
          <button class="btn" id="btnClearCart" type="button">清空</button>
        </div>

        <p class="muted" style="margin-top:10px">送出後會自動顯示在下方「訂購紀錄」。</p>
      </div>

      <div class="card" style="margin-top:14px">
        <h2>3）訂購紀錄（查詢：日期 / 店家 / 輸入名稱）</h2>

        <div class="row">
          <div>
            <label>訂購日期</label>
            <input id="q_date" type="date"/>
          </div>
          <div>
            <label>店家</label>
            <select id="q_rest">
              <option value="">全部</option>
            </select>
          </div>
        </div>

        <label>輸入名稱（人員）</label>
        <input id="q_name" placeholder="例：小明"/>

        <div class="inline" style="margin-top:12px">
          <button class="btn primary" id="btnQuery" type="button">查詢</button>
          <button class="btn" id="btnQueryMine" type="button">查我的</button>
          <button class="btn" id="btnToday" type="button">今天</button>
        </div>

        <div class="hr"></div>
        <div id="recordsOut" class="muted">尚無資料。</div>
      </div>
    </div>

  </div>
</div>

<!-- ✅ 切換管理者 PIN 對話框 -->
<dialog id="adminDlg">
  <div class="dlg">
    <h3>管理者</h3>
    <div class="muted">請輸入管理者密碼</div>
    <div class="hr"></div>
    <label>管理者密碼</label>
    <input id="adminPin" inputmode="numeric" placeholder="輸入"/>
    <div class="inline" style="margin-top:12px; justify-content:flex-end">
      <button class="btn" id="btnAdminCancel" type="button">取消</button>
      <button class="btn primary" id="btnAdminGo" type="button">切換</button>
    </div>
  </div>
</dialog>

<script type="module">
  const roleKey = "gb_role";
  // 允許用戶頁：沒有 role 也可以進（但按切管理者才需要 PIN）
  // localStorage.getItem(roleKey) === "admin" 也可以直接跳 admin
  if (localStorage.getItem(roleKey) === "admin") location.href = "./admin.html";

  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-app.js";
  import {
    getFirestore, collection, getDocs, query, where, orderBy, limit, addDoc
  } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-firestore.js";

  const firebaseConfig = {
    apiKey: "AIzaSyBdgOddTGAfqqHLnhnaJRv2_y7gyweuQEo",
    authDomain: "goldbricks-order.firebaseapp.com",
    projectId: "goldbricks-order",
    storageBucket: "goldbricks-order.firebasestorage.app",
    messagingSenderId: "463709758954",
    appId: "1:463709758954:web:429dc920f2f812d51cbe93",
    measurementId: "G-YQK8ZCC26R"
  };

  const app = initializeApp(firebaseConfig);
  const db = getFirestore(app);

  const $ = (id)=> document.getElementById(id);
  const esc = (s)=> (s??"").toString()
    .replaceAll("&","&amp;").replaceAll("<","&lt;").replaceAll(">","&gt;").replaceAll('"',"&quot;");
  const money = (v)=> {
    const n = Number(v);
    return isNaN(n) ? 0 : n;
  };
  const pad2 = (n)=> String(n).padStart(2,"0");
  const todayISO = ()=>{
    const d = new Date();
    return `${d.getFullYear()}-${pad2(d.getMonth()+1)}-${pad2(d.getDate())}`;
  };

  const statusPill = $("statusPill");
  statusPill.textContent = "已連線 Firestore";

  // ====== 右上：切換管理者（彈窗） ======
  const adminDlg = $("adminDlg");
  $("btnSwitchAdmin").onclick = ()=>{
    $("adminPin").value = "";
    adminDlg.showModal();
    setTimeout(()=> $("adminPin").focus(), 30);
  };
  $("btnAdminCancel").onclick = ()=> adminDlg.close();
  $("btnAdminGo").onclick = ()=>{
    const pin = ($("adminPin").value || "").trim();
    if(pin !== "8520") return alert("密碼錯誤");
    localStorage.setItem(roleKey, "admin");
    location.href = "./admin.html";
  };
  $("adminPin").addEventListener("keydown",(e)=>{
    if(e.key==="Enter"){ e.preventDefault(); $("btnAdminGo").click(); }
    if(e.key==="Escape"){ adminDlg.close(); }
  });

  $("btnLogout").onclick = ()=>{
    localStorage.removeItem(roleKey);
    location.href = "./index.html";
  };

  // ====== Firestore collections ======
  const colStaff = collection(db, "staff");
  const colRestaurants = collection(db, "restaurants");
  const colOrders = collection(db, "orders");

  // ====== 狀態 ======
  let staffList = [];        // [{dept,name}]
  let deptMap = new Map();   // dept -> [names]
  let restaurants = [];      // [{id,name,imageUrl,...}]
  let selectedRestaurant = null; // {id,name...}
  let menuList = [];         // menu items of selected restaurant
  let cart = [];             // [{name, price, qty, note, addons:[{name,price,free}]}]
  let userDept = "";
  let userName = "";

  // ====== 載入人員 ======
  async function loadStaff(){
    try{
      const snap = await getDocs(query(colStaff, orderBy("dept","asc"), orderBy("name","asc"), limit(1000)));
      staffList = [];
      deptMap = new Map();
      snap.forEach(d=>{
        const v = d.data();
        const dept = (v.dept||"").trim();
        const name = (v.name||"").trim();
        if(!dept || !name) return;
        staffList.push({dept, name});
        if(!deptMap.has(dept)) deptMap.set(dept, []);
        deptMap.get(dept).push(name);
      });

      const deptSelect = $("deptSelect");
      deptSelect.innerHTML = `<option value="">請選擇</option>` + Array.from(deptMap.keys()).map(x=> `<option value="${esc(x)}">${esc(x)}</option>`).join("");

      $("nameSelect").innerHTML = `<option value="">請先選部門</option>`;
      $("nameSelect").disabled = true;

    }catch(err){
      console.error(err);
      $("hintUser").textContent = "讀取失敗（Rules / 網路）";
    }
  }

  $("deptSelect").onchange = ()=>{
    userDept = $("deptSelect").value;
    const nameSelect = $("nameSelect");

    if(!userDept){
      nameSelect.disabled = true;
      nameSelect.innerHTML = `<option value="">請先選部門</option>`;
      userName = "";
      refreshMenuArea();
      refreshRecordsRestaurantOptions();
      return;
    }

    const names = deptMap.get(userDept) || [];
    nameSelect.disabled = false;
    nameSelect.innerHTML = `<option value="">請選擇</option>` + names.map(n=> `<option value="${esc(n)}">${esc(n)}</option>`).join("");
    userName = "";
    refreshMenuArea();
  };

  $("nameSelect").onchange = ()=>{
    userName = $("nameSelect").value;
    refreshMenuArea();
  };

  // ====== 載入餐廳 ======
  async function loadRestaurants(){
    try{
      const snap = await getDocs(query(colRestaurants, orderBy("createdAt","desc"), limit(800)));
      restaurants = [];
      snap.forEach(d=> restaurants.push({id:d.id, ...d.data()}));

      const wrap = $("restaurantsWrap");
      if(!restaurants.length){
        wrap.innerHTML = `<div class="muted">尚無餐廳</div>`;
        return;
      }

      wrap.innerHTML = `
        <div class="restGrid">
          ${restaurants.map(r=>`
            <div class="restCard" data-rid="${r.id}">
              <div class="inline" style="justify-content:space-between">
                <b>${esc(r.name||"未命名")}</b>
                <span class="tag">餐廳</span>
              </div>
              <div class="muted" style="margin-top:6px">${esc(r.address||"")}</div>
              <div class="inline" style="margin-top:10px">
                <button class="imgBtn" type="button" data-openimg="${r.id}">圖片</button>
                ${r.mapUrl ? `<button class="imgBtn" type="button" data-openmap="${r.id}">地圖</button>` : ``}
              </div>
            </div>
          `).join("")}
        </div>
      `;

      // 點餐廳
      wrap.querySelectorAll(".restCard").forEach(el=>{
        el.onclick = async ()=>{
          const rid = el.dataset.rid;
          selectedRestaurant = restaurants.find(x=> x.id===rid) || null;
          wrap.querySelectorAll(".restCard").forEach(x=> x.classList.toggle("active", x===el));
          await loadMenu(rid);
          refreshMenuArea();
          refreshRecordsRestaurantOptions();
        };
      });

      // 圖片 / 地圖
      wrap.querySelectorAll("button[data-openimg]").forEach(btn=>{
        btn.onclick = (e)=>{
          e.stopPropagation();
          const rid = btn.dataset.openimg;
          const r = restaurants.find(x=> x.id===rid);
          const url = (r?.imageUrl || "").trim();
          if(!url) return alert("沒有圖片網址");
          window.open(url, "_blank", "noopener,noreferrer");
        };
      });
      wrap.querySelectorAll("button[data-openmap]").forEach(btn=>{
        btn.onclick = (e)=>{
          e.stopPropagation();
          const rid = btn.dataset.openmap;
          const r = restaurants.find(x=> x.id===rid);
          const url = (r?.mapUrl || "").trim();
          if(!url) return alert("沒有地圖連結");
          window.open(url, "_blank", "noopener,noreferrer");
        };
      });

    }catch(err){
      console.error(err);
      $("restaurantsWrap").innerHTML = `<div class="muted">讀取餐廳失敗（Rules / 網路）</div>`;
    }
  }

  // ====== 載入餐點（含加購） ======
  async function loadMenu(rid){
    try{
      const menuCol = collection(db, "restaurants", rid, "menu");
      const snap = await getDocs(query(menuCol, orderBy("createdAt","desc"), limit(2000)));
      menuList = [];
      snap.forEach(d=> menuList.push({id:d.id, ...d.data()}));
    }catch(err){
      console.error(err);
      menuList = [];
    }
  }

  // ====== 顯示餐點區 ======
  function refreshMenuArea(){
    const wrap = $("menuWrap");
    if(!userDept || !userName){
      wrap.innerHTML = `<div class="muted">請先選擇部門、人員。</div>`;
      return;
    }
    if(!selectedRestaurant){
      wrap.innerHTML = `<div class="muted">請先選擇餐廳。</div>`;
      return;
    }
    if(!menuList.length){
      wrap.innerHTML = `<div class="muted">此餐廳尚無餐點。</div>`;
      return;
    }

    // 分類
    const catMap = new Map();
    for(const m of menuList){
      const cat = (m.category || "未分類").trim();
      if(!catMap.has(cat)) catMap.set(cat, []);
      catMap.get(cat).push(m);
    }

    wrap.innerHTML = Array.from(catMap.entries()).map(([cat, items])=>`
      <div class="itemBox">
        <div class="inline" style="justify-content:space-between">
          <b>${esc(cat)}</b>
          <span class="tag">${items.length} 項</span>
        </div>

        <div class="hr"></div>

        ${items.map(m=>{
          const addons = m.addons || [];
          return `
            <div style="padding:10px 0; border-bottom:1px dashed rgba(15,23,42,.10)">
              <div class="inline" style="justify-content:space-between">
                <div>
                  <b>${esc(m.name||"")}</b>
                  <span class="tag" style="margin-left:8px">$${money(m.price)}</span>
                </div>
                <div class="inline">
                  <span class="muted">數量</span>
                  <input data-mid="${m.id}" data-k="qty" type="number" min="1" value="${Math.max(1, money(m.defaultQty)||1)}" style="width:90px"/>
                  <button class="btnSmall btnOk" data-add="${m.id}" type="button">加入</button>
                </div>
              </div>

              ${addons.length ? `
                <div class="muted" style="margin-top:8px">加購：</div>
                <div>
                  ${addons.map((a,i)=>`
                    <label class="addonPill">
                      <input type="checkbox" data-mid="${m.id}" data-addon-idx="${i}">
                      ${esc(a.name)} ${a.free ? '(免費)' : `+$${money(a.price)}`}
                    </label>
                  `).join("")}
                </div>
              ` : ``}

              <label style="margin-top:10px">單品備註</label>
              <input data-mid="${m.id}" data-k="note" placeholder="例：不要香菜…"/>
            </div>
          `;
        }).join("")}
      </div>
    `).join("");

    // 綁加入
    wrap.querySelectorAll("button[data-add]").forEach(btn=>{
      btn.onclick = ()=>{
        const mid = btn.dataset.add;
        const m = menuList.find(x=> x.id===mid);
        if(!m) return;

        const qtyEl = wrap.querySelector(`[data-mid="${mid}"][data-k="qty"]`);
        const noteEl = wrap.querySelector(`[data-mid="${mid}"][data-k="note"]`);
        const qty = Math.max(1, money(qtyEl?.value || 1));
        const note = (noteEl?.value || "").trim();

        const addons = (m.addons||[]).map((a,i)=>{
          const chk = wrap.querySelector(`[data-mid="${mid}"][data-addon-idx="${i}"]`);
          return chk?.checked ? { name:a.name, price: money(a.price), free: !!a.free } : null;
        }).filter(Boolean);

        cart.push({
          restaurantId: selectedRestaurant.id,
          restaurantName: selectedRestaurant.name || "",
          name: m.name || "",
          price: money(m.price),
          qty,
          note,
          addons
        });

        refreshCart();
      };
    });
  }

  // ====== 購物車 ======
  function calcCartTotal(){
    return cart.reduce((sum, it)=>{
      const addonSum = (it.addons||[]).reduce((s,a)=> s + money(a.price), 0);
      return sum + (money(it.price)+addonSum) * money(it.qty);
    }, 0);
  }

  function refreshCart(){
    const wrap = $("cartWrap");
    if(!cart.length){
      wrap.innerHTML = `<div class="muted">尚未加入餐點。</div>`;
      $("totalAmount").value = "0";
      return;
    }

    wrap.innerHTML = cart.map((it,idx)=>{
      const addonTxt = (it.addons||[]).map(a=> a.free ? `${a.name}(免費)` : `${a.name}+${money(a.price)}`).join("、");
      const addonSum = (it.addons||[]).reduce((s,a)=> s + money(a.price), 0);
      const unit = money(it.price)+addonSum;
      const sub = unit * money(it.qty);
      return `
        <div style="padding:10px 12px; border:1px solid rgba(15,23,42,.10); border-radius:14px; margin-top:10px; background:#fff">
          <div class="inline" style="justify-content:space-between">
            <div>
              <b>${esc(it.name)}</b>
              <span class="tag" style="margin-left:8px">$${money(it.price)}</span>
              <span class="tag" style="margin-left:6px">× ${money(it.qty)}</span>
              <span class="tag" style="margin-left:6px">小計 $${sub}</span>
            </div>
            <button class="btnSmall btnDanger" data-del="${idx}" type="button">刪除</button>
          </div>
          ${addonTxt ? `<div class="muted" style="margin-top:8px">加購：${esc(addonTxt)}</div>` : ``}
          ${it.note ? `<div class="muted" style="margin-top:6px">備註：${esc(it.note)}</div>` : ``}
          <div class="muted" style="margin-top:6px">店家：${esc(it.restaurantName||"")}</div>
        </div>
      `;
    }).join("");

    wrap.querySelectorAll("button[data-del]").forEach(btn=>{
      btn.onclick = ()=>{
        const idx = Number(btn.dataset.del);
        if(!confirm("確定刪除這個品項？")) return;
        cart.splice(idx,1);
        refreshCart();
      };
    });

    $("totalAmount").value = String(calcCartTotal());
  }

  $("btnClearCart").onclick = ()=>{
    if(!cart.length) return;
    if(!confirm("確定清空購物車？")) return;
    cart = [];
    refreshCart();
  };

  // ====== 送出訂單 ======
  $("orderDate").value = todayISO();
  $("q_date").value = todayISO();

  $("btnToday").onclick = ()=>{
    $("q_date").value = todayISO();
    $("orderDate").value = todayISO();
  };

  $("btnSubmit").onclick = async ()=>{
    if(!userDept || !userName) return alert("請先選擇部門、人員");
    if(!selectedRestaurant) return alert("請先選擇餐廳");
    if(!cart.length) return alert("購物車是空的");

    const orderDate = $("orderDate").value || todayISO();
    const orderNote = ($("orderNote").value || "").trim();

    // 本單只送選到的餐廳品項（若你允許跨餐廳，這裡可調整）
    const items = cart.filter(x=> x.restaurantId === selectedRestaurant.id);

    if(!items.length) return alert("購物車內沒有目前餐廳的品項");

    try{
      await addDoc(colOrders, {
        orderDate,
        userDept, userName,
        restaurantId: selectedRestaurant.id,
        restaurantName: selectedRestaurant.name || "",
        orderNote,
        items: items.map(it=>({
          name: it.name,
          price: money(it.price),
          qty: money(it.qty),
          note: it.note || "",
          addons: (it.addons||[]).map(a=> ({name:a.name, price: money(a.price), free: !!a.free}))
        })),
        createdAt: Date.now()
      });

      alert("送出成功 ✅");
      // 清掉目前餐廳的品項
      cart = cart.filter(x=> x.restaurantId !== selectedRestaurant.id);
      $("orderNote").value = "";
      refreshCart();

      // 自動查我的
      $("q_name").value = userName;
      $("q_rest").value = selectedRestaurant.id;
      $("q_date").value = orderDate;
      await queryRecords();
    }catch(err){
      console.error(err);
      alert("送出失敗（Rules / 網路）\n\n" + (err?.message || err));
    }
  };

  // ====== 查詢紀錄 ======
  function refreshRecordsRestaurantOptions(){
    const sel = $("q_rest");
    sel.innerHTML = `<option value="">全部</option>` + restaurants.map(r=> `<option value="${r.id}">${esc(r.name||"未命名")}</option>`).join("");
  }

  async function queryRecords(){
    const date = $("q_date").value;
    const rid = $("q_rest").value;
    const nameKey = ($("q_name").value || "").trim();

    if(!date) return alert("請選日期");

    try{
      // 先用日期查，再前端篩（Firestore 複合條件要索引，這樣最穩）
      const snap = await getDocs(query(colOrders, where("orderDate","==", date), limit(3000)));
      let list = [];
      snap.forEach(d=> list.push({ id:d.id, ...d.data() }));

      if(rid) list = list.filter(o=> (o.restaurantId||"") === rid);
      if(nameKey) list = list.filter(o=> (o.userName||"").includes(nameKey));

      const out = $("recordsOut");
      if(!list.length){
        out.innerHTML = `<div class="muted">尚無資料。</div>`;
        return;
      }

      out.innerHTML = list.map(o=>{
        const itemsHtml = (o.items||[]).map(it=>{
          const addonTxt = (it.addons||[]).map(a=> a.free ? `${a.name}(免費)` : `${a.name}+${money(a.price)}`).join("、");
          const addonSum = (it.addons||[]).reduce((s,a)=> s + money(a.price), 0);
          const unit = money(it.price) + addonSum;
          const sub = unit * money(it.qty);
          return `
            <div class="muted" style="margin-top:6px">
              • <b>${esc(it.name||"")}</b>
              <span class="tag" style="margin-left:6px">$${money(it.price)}</span>
              ${addonTxt ? `<span class="tag" style="margin-left:6px">加購 ${esc(addonTxt)}</span>` : ``}
              <span class="tag" style="margin-left:6px">× ${money(it.qty)}</span>
              <span class="tag" style="margin-left:6px">小計 $${sub}</span>
              ${it.note ? `<div class="muted">備註：${esc(it.note)}</div>` : ``}
            </div>
          `;
        }).join("");

        return `
          <div style="padding:10px 12px; border:1px solid rgba(15,23,42,.10); border-radius:14px; margin-top:10px; background:#fff">
            <div class="inline" style="justify-content:space-between">
              <div>
                <b>${esc(o.userDept||"")}</b> / <b>${esc(o.userName||"")}</b>
                — <span class="tag">${esc(o.restaurantName||"")}</span>
              </div>
              <span class="tag">${esc(o.orderDate||"")}</span>
            </div>
            ${o.orderNote ? `<div class="muted" style="margin-top:8px">整筆備註：${esc(o.orderNote)}</div>` : ``}
            <div style="margin-top:8px">${itemsHtml}</div>
            <div class="muted" style="margin-top:8px">訂單ID：${esc(o.id||"")}</div>
          </div>
        `;
      }).join("");

    }catch(err){
      console.error(err);
      $("recordsOut").innerHTML = `<div class="muted">查詢失敗（Rules / 網路）</div>`;
      alert("查詢失敗（Rules / 網路）\n\n" + (err?.message || err));
    }
  }

  $("btnQuery").onclick = queryRecords;
  $("btnQueryMine").onclick = async ()=>{
    $("q_name").value = userName || "";
    await queryRecords();
  };

  // ====== init ======
  await loadStaff();
  await loadRestaurants();
  refreshRecordsRestaurantOptions();
  refreshCart();
</script>
</body>
</html>
