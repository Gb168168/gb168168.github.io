<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <title>ä½¿ç”¨è€…é»é¤ - GoldBricks</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <style>
    *{box-sizing:border-box;margin:0;padding:0}
    body{font-family:system-ui,-apple-system,BlinkMacSystemFont,"Segoe UI",sans-serif;background:#f5f4fb;min-height:100vh}
    .wrap{max-width:1100px;margin:0 auto;padding:18px}
    .top{display:flex;justify-content:space-between;align-items:center;margin-bottom:14px}
    h2{font-size:18px}
    .muted{font-size:13px;color:#6b7280}
    .card{background:#fff;border-radius:16px;padding:16px 18px;box-shadow:0 8px 25px rgba(15,23,42,0.08);margin-bottom:14px}
    label{display:block;font-size:13px;color:#374151;margin-bottom:4px}
    input,select,textarea{width:100%;padding:8px 10px;border-radius:10px;border:1px solid #d1d5db;font-size:13px}
    textarea{resize:vertical;min-height:60px}
    input:focus,select:focus,textarea:focus{outline:none;border-color:#fb7185;box-shadow:0 0 0 2px rgba(251,113,133,0.2)}
    .grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(200px,1fr));gap:12px 16px}
    .btn{display:inline-flex;align-items:center;justify-content:center;padding:8px 14px;border-radius:999px;border:none;background:linear-gradient(90deg,#fb7185,#f97316);color:#fff;font-size:13px;font-weight:700;cursor:pointer}
    .btn.secondary{background:#e5e7eb;color:#111827}
    .btn.sm{padding:4px 10px;font-size:12px}
    .row{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
    .hr{height:1px;background:#e5e7eb;margin:14px 0;border:none}
    .menuGroup{margin-top:10px}
    .menuGroup h4{font-size:14px;margin:10px 0 6px}
    .item{background:#f9fafb;border-radius:12px;padding:10px 12px;margin-bottom:8px}
    .itemTop{display:flex;justify-content:space-between;gap:10px;align-items:flex-start;flex-wrap:wrap}
    .itemName{font-weight:800;font-size:14px;color:#111827}
    .price{font-size:13px;color:#6b7280}
    .qty{width:86px}
    .addons{margin-top:8px;display:flex;gap:8px;flex-wrap:wrap}
    .chip{display:inline-flex;gap:6px;align-items:center;background:#fff;border:1px solid #e5e7eb;border-radius:999px;padding:6px 10px;font-size:12px}
    .right{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
    .total{font-weight:900}
    table{border-collapse:collapse;width:100%}
    th,td{border-bottom:1px solid #e5e7eb;text-align:left;padding:8px 6px;font-size:13px}
    th{font-size:12px;color:#6b7280;background:#f9fafb}
  </style>
</head>

<body>
<div class="wrap">
  <div class="top">
    <div>
      <h2>ä½¿ç”¨è€…é»é¤</h2>
      <div class="muted">é¸æ“‡äººå“¡ â†’ é¸åº—å®¶ â†’ é»é¤é€å‡º</div>
    </div>
    <button class="btn secondary" id="btnSwitchAdmin">åˆ‡æ›ç®¡ç†è€…</button>
  </div>

  <!-- ä½¿ç”¨è€…è³‡è¨Š -->
  <div class="card">
    <h3 style="font-size:16px;margin-bottom:10px;">ä½¿ç”¨è€…è³‡è¨Š</h3>
    <div class="grid">
      <div>
        <label>éƒ¨é–€</label>
        <select id="deptSelect"></select>
      </div>
      <div>
        <label>äººå“¡</label>
        <select id="personSelect"></select>
      </div>
      <div>
        <label>è¨‚è³¼æ—¥æœŸ</label>
        <input type="date" id="orderDate">
      </div>
    </div>
  </div>

  <!-- é»é¤ -->
  <div class="card">
    <h3 style="font-size:16px;margin-bottom:10px;">é–‹å§‹é»é¤</h3>
    <div class="grid">
      <div>
        <label>åº—å®¶</label>
        <select id="restaurantSelect"></select>
      </div>
      <div>
        <label>æœå°‹é¤é»</label>
        <input id="searchInput" placeholder="è¼¸å…¥é¤é»åç¨±">
      </div>
    </div>

    <div id="menuArea"></div>

    <hr class="hr">
    <div class="row" style="justify-content:space-between;">
      <div class="total" id="totalText">ç¸½è¨ˆï¼š$0</div>
      <button class="btn" id="btnSubmit">é€å‡ºè¨‚å–®</button>
    </div>
  </div>
</div>

<!-- Firebase -->
<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js";
import { getFirestore, collection, getDocs, addDoc, serverTimestamp } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore.js";

/* ğŸ”´ æ›æˆä½ è‡ªå·±çš„ Firebase è¨­å®š */
const firebaseConfig = {
  apiKey: "PASTE_YOUR_API_KEY",
  authDomain: "PASTE_YOUR_AUTH_DOMAIN",
  projectId: "PASTE_YOUR_PROJECT_ID",
  storageBucket: "PASTE_YOUR_STORAGE_BUCKET",
  messagingSenderId: "PASTE_YOUR_SENDER_ID",
  appId: "PASTE_YOUR_APP_ID"
};

const app = initializeApp(firebaseConfig);
const db = getFirestore(app);

/* åˆ‡æ›ç®¡ç†è€… */
document.getElementById("btnSwitchAdmin").onclick = () => {
  const pwd = prompt("è«‹è¼¸å…¥ç®¡ç†è€…å¯†ç¢¼");
  if (pwd === "8520") {
    localStorage.setItem("role", "admin");
    location.href = "admin.html";
  } else if (pwd !== null) {
    alert("å¯†ç¢¼éŒ¯èª¤");
  }
};

const deptSelect = document.getElementById("deptSelect");
const personSelect = document.getElementById("personSelect");
const orderDate = document.getElementById("orderDate");
orderDate.valueAsDate = new Date();

const restaurantSelect = document.getElementById("restaurantSelect");
const menuArea = document.getElementById("menuArea");
const searchInput = document.getElementById("searchInput");
const totalText = document.getElementById("totalText");
const btnSubmit = document.getElementById("btnSubmit");

let menus = [];
let cart = new Map();

/* è¼‰å…¥äººå“¡ */
async function loadStaff() {
  const snap = await getDocs(collection(db,"staff"));
  const list = snap.docs.map(d=>d.data());
  const depts = [...new Set(list.map(s=>s.dept))];
  deptSelect.innerHTML = depts.map(d=>`<option>${d}</option>`).join("");
  deptSelect.onchange = () => {
    const ppl = list.filter(s=>s.dept===deptSelect.value).map(s=>s.name);
    personSelect.innerHTML = ppl.map(p=>`<option>${p}</option>`).join("");
  };
  deptSelect.dispatchEvent(new Event("change"));
}

/* è¼‰å…¥é¤å»³ */
async function loadRestaurants() {
  const snap = await getDocs(collection(db,"restaurants"));
  restaurantSelect.innerHTML = `<option value="">è«‹é¸æ“‡</option>` +
    snap.docs.map(d=>`<option value="${d.id}">${d.data().name}</option>`).join("");
}

/* è¼‰å…¥èœå–® */
async function loadMenus(restId) {
  menuArea.innerHTML = "";
  cart.clear();
  totalText.textContent = "ç¸½è¨ˆï¼š$0";
  const snap = await getDocs(collection(db,"menus"));
  menus = snap.docs.map(d=>({id:d.id,...d.data()}))
    .filter(m=>m.restaurantId===restId);
  renderMenu();
}

function renderMenu() {
  const kw = searchInput.value.toLowerCase();
  menuArea.innerHTML = menus.filter(m=>m.name.toLowerCase().includes(kw)).map(m=>`
    <div class="item">
      <div class="itemTop">
        <div>
          <div class="itemName">${m.name}</div>
          <div class="price">$${m.price}</div>
        </div>
        <div class="right">
          <input class="qty" type="number" min="1" value="${m.defaultQty||1}" id="q_${m.id}">
          <button class="btn sm" onclick="add('${m.id}')">åŠ å…¥</button>
        </div>
      </div>
    </div>
  `).join("");
}

window.add = id => {
  const m = menus.find(x=>x.id===id);
  const qty = +document.getElementById("q_"+id).value;
  cart.set(id,{...m,qty});
  updateTotal();
};

function updateTotal(){
  let t=0;
  cart.forEach(i=>t+=i.price*i.qty);
  totalText.textContent = `ç¸½è¨ˆï¼š$${t}`;
}

btnSubmit.onclick = async () => {
  if(!cart.size) return alert("å°šæœªé¸é¤");
  await addDoc(collection(db,"orders"),{
    dept:deptSelect.value,
    person:personSelect.value,
    date:orderDate.value,
    items:[...cart.values()],
    total:[...cart.values()].reduce((s,i)=>s+i.price*i.qty,0),
    createdAt:serverTimestamp()
  });
  alert("è¨‚å–®å·²é€å‡º");
  cart.clear();
  updateTotal();
};

restaurantSelect.onchange = e => e.target.value && loadMenus(e.target.value);
searchInput.oninput = renderMenu;

await loadStaff();
await loadRestaurants();
</script>
</body>
</html>
