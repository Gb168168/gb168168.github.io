<!DOCTYPE html>
<html lang="zh-Hant">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>å…¬å¸è¨‚é¤ç³»çµ±</title>

<style>
/* ===========================
   ğŸŒ¼ æ‰‹æ–é£²æŸ”å’Œå¯æ„›é¢¨ä¸»é¡Œ
   =========================== */

/* å…¨åŸŸ */
body {
  margin: 0;
  font-family: "Noto Sans TC", system-ui, sans-serif;
  background: #fff7ec;
  color: #4a4a4a;
}

/* Header */
header {
  background: linear-gradient(90deg, #ffb347 0%, #ffcc33 100%);
  padding: 16px 22px;
  color: #4a3200;
  font-weight: 700;
  font-size: 22px;
  box-shadow: 0 3px 12px rgba(0,0,0,0.15);
  display: flex;
  justify-content: space-between;
  align-items: center;
}
header span {
  font-size: 14px;
}

/* ä¸»å…§å®¹å€ */
main {
  max-width: 1100px;
  margin: 24px auto 100px;
  padding: 0 16px;
}

/* å¡ç‰‡ */
.card {
  background: #ffffff;
  border-radius: 18px;
  padding: 18px;
  margin-bottom: 20px;
  box-shadow: 0 4px 12px rgba(255,183,77,0.35);
  border: 2px solid #ffd27f;
}

/* æ¨™é¡Œ */
.card-title {
  font-size: 18px;
  font-weight: 700;
  margin-bottom: 12px;
  color: #6a3f00;
  display: flex;
  justify-content: space-between;
  align-items: center;
}

/* æ”¶åˆæŒ‰éˆ• */
.toggleBtn {
  background: #ffe0a8;
  border: none;
  padding: 4px 12px;
  border-radius: 12px;
  cursor: pointer;
  font-size: 13px;
  color: #6a3f00;
}
.toggleBtn:hover {
  background: #ffd082;
}

/* è¼¸å…¥æ¡† + ä¸‹æ‹‰é¸å–® */
input, select, textarea {
  width: 100%;
  padding: 8px 10px;
  border-radius: 12px;
  border: 2px solid #ffd9a5;
  margin: 4px 0 10px;
  font-size: 14px;
  background: #fffdf8;
}
input:focus, select:focus, textarea:focus {
  outline: none;
  border-color: #ffb84d;
  background: #fff6e8;
}

/* label */
label {
  font-size: 13px;
  color: #6b4b20;
}

/* æŒ‰éˆ• */
button {
  padding: 8px 16px;
  border-radius: 16px;
  border: none;
  cursor: pointer;
  font-size: 14px;
  font-weight: 600;
  background: #ffb84d;
  color: #4a3200;
  box-shadow: 0 3px 8px rgba(255,180,60,0.4);
  transition: 0.2s;
}
button:hover {
  background: #ffcc66;
}
button:disabled {
  opacity: .6;
  cursor: not-allowed;
}

/* å±éšªæŒ‰éˆ•ï¼ˆåˆªé™¤ï¼‰ */
.btn-danger {
  background: #ff7b7b;
  color: white;
}
.btn-danger:hover {
  background: #ff5252;
}

/* æ¬¡è¦æŒ‰éˆ• */
.btn-secondary {
  background: #ffe0a8;
}
.btn-secondary:hover {
  background: #ffd082;
}

/* è¡Œå…§å°æŒ‰éˆ• */
.btn-small {
  padding: 4px 10px;
  font-size: 12px;
  border-radius: 999px;
}

/* å½ˆå‡ºå¼åŠ è³¼è¦–çª—èƒŒæ™¯ */
.modal-bg {
  position: fixed;
  inset: 0;
  background: rgba(0,0,0,0.35);
  backdrop-filter: blur(2px);
  display: none;
  align-items: center;
  justify-content: center;
  z-index: 50;
}

/* å½ˆå‡ºè¦–çª—å…§å®¹ */
.modal-box {
  background: white;
  border-radius: 20px;
  padding: 18px;
  width: 90%;
  max-width: 420px;
  box-shadow: 0 8px 20px rgba(0,0,0,0.25);
}

/* é¤å»³å¡ç‰‡ */
.restaurant-box {
  border: 2px solid #ffe5b4;
  padding: 10px 12px;
  border-radius: 16px;
  background: #fffdf6;
  margin-bottom: 10px;
}

/* èœå–®åœ–ç‰‡ */
.menu-image {
  width: 100%;
  max-height: 220px;
  object-fit: contain;
  border-radius: 12px;
  margin-top: 8px;
}

/* é¤é»åˆ—è¡¨ */
.food-item {
  padding: 8px;
  background: #fff7e1;
  border-radius: 14px;
  margin-bottom: 8px;
  border: 1px solid #ffdf9c;
  display: flex;
  justify-content: space-between;
  align-items: center;
}
.food-item:hover {
  background: #ffefc8;
  cursor: pointer;
}

/* å°å­— */
.text-small {
  font-size: 12px;
  color: #777;
}

/* è¡¨æ ¼ */
.table {
  width: 100%;
  border-collapse: collapse;
  margin-top: 8px;
  font-size: 13px;
}
.table th, .table td {
  padding: 6px 8px;
  border-bottom: 1px solid #ffd9a5;
}
.table th {
  background: #fff4d6;
}

/* Flex row */
.flex-row {
  display: flex;
  gap: 10px;
  flex-wrap: wrap;
}
.flex-1 {
  flex: 1 1 200px;
}

/* Badge */
.badge {
  display: inline-block;
  padding: 2px 8px;
  border-radius: 999px;
  background: #ffe0a8;
  font-size: 11px;
  color: #6a3f00;
}

/* å€å¡Šæ”¶åˆå…§å®¹ */
.section-body {
  margin-top: 10px;
}

/* éš±è— */
.hidden { display: none; }
</style>
</head>

<body>
<header>
  <div>å…¬å¸è¨‚é¤ç³»çµ±</div>
  <span id="roleLabel">ç›®å‰èº«åˆ†ï¼šä¸€èˆ¬ä½¿ç”¨è€…</span>
</header>

<main>
  <!-- èº«åˆ†åˆ‡æ› -->
  <section class="card">
    <div class="card-title">
      <span>èº«åˆ†åˆ‡æ›</span>
    </div>
    <div class="flex-row">
      <div class="flex-1">
        <label>èº«åˆ†</label>
        <select id="roleSelect">
          <option value="user">ä¸€èˆ¬ä½¿ç”¨è€…</option>
          <option value="admin">ç®¡ç†å“¡</option>
        </select>
      </div>
      <div class="flex-1" id="adminPwdWrapper" class="hidden">
        <label>ç®¡ç†å“¡å¯†ç¢¼</label>
        <input type="password" id="adminPwd" placeholder="é è¨­ 1234" />
      </div>
      <div class="flex-1" id="adminLoginBtnWrapper" class="hidden">
        <label>&nbsp;</label>
        <button id="adminLoginBtn">ç™»å…¥ç®¡ç†å“¡</button>
      </div>
    </div>
    <p class="text-small">â€» æ­¤ç‚ºç´”å‰ç«¯ demoï¼Œå¯†ç¢¼åªå­˜åœ¨ç€è¦½å™¨ï¼Œä¸é©åˆç•¶æ­£å¼æ¬Šé™æ§ç®¡ã€‚</p>
  </section>

  <!-- ä¸€èˆ¬ä½¿ç”¨è€…å€ -->
  <section class="card" id="userSection">
    <div class="card-title">
      <span>ä¸€èˆ¬ä½¿ç”¨è€…é»é¤</span>
      <span class="badge">åƒ…é¡¯ç¤ºè‡ªå·±çš„è¨‚å–®</span>
    </div>

    <div class="flex-row">
      <div class="flex-1">
        <label>éƒ¨é–€</label>
        <select id="userDeptSelect"></select>
      </div>
      <div class="flex-1">
        <label>å§“å</label>
        <select id="userPersonSelect">
          <option value="">è«‹å…ˆé¸æ“‡éƒ¨é–€</option>
        </select>
      </div>
    </div>

    <hr>

    <div class="flex-row">
      <div class="flex-1">
        <label>é¤å»³</label>
        <select id="userRestaurantSelect">
          <option value="">è«‹å…ˆè®“ç®¡ç†å“¡æ–°å¢é¤å»³</option>
        </select>
      </div>
    </div>

    <div id="userRestaurantInfo" class="text-small" style="margin-bottom:10px;"></div>

    <div id="userFoodList">
      <p class="text-small">è«‹å…ˆé¸æ“‡é¤å»³ã€‚</p>
    </div>

    <hr>

    <h3>æˆ‘çš„è¨‚å–®</h3>
    <div id="userOrderList" class="text-small">å°šæœªæœ‰è¨‚å–®ã€‚</div>
  </section>

  <!-- ç®¡ç†å“¡å€ -->
  <section class="card hidden" id="adminSection">
    <div class="card-title">
      <span>ç®¡ç†å“¡å¾Œå°</span>
      <button class="btn-secondary btn-small" id="adminLogoutBtn">åˆ‡å›ä¸€èˆ¬ä½¿ç”¨è€…</button>
    </div>

    <!-- äººå“¡ç®¡ç† -->
    <div class="card" style="margin:10px 0;">
      <div class="card-title">
        <span>äººå“¡ç®¡ç†</span>
        <button class="toggleBtn" data-target="personBody">æ”¶åˆ</button>
      </div>
      <div id="personBody" class="section-body">
        <div class="flex-row">
          <div class="flex-1">
            <label>éƒ¨é–€</label>
            <select id="adminDeptSelect"></select>
          </div>
          <div class="flex-1">
            <label>å§“å</label>
            <input type="text" id="adminPersonName" placeholder="ä¾‹å¦‚ï¼šå°æŸ¯" />
          </div>
          <div class="flex-1">
            <label>&nbsp;</label>
            <button id="addPersonBtn">æ–°å¢äººå“¡</button>
          </div>
        </div>
        <div id="adminPersonList" class="text-small">å°šæœªæ–°å¢äººå“¡ã€‚</div>
      </div>
    </div>

    <!-- é¤å»³ç®¡ç† -->
    <div class="card" style="margin:10px 0;">
      <div class="card-title">
        <span>é¤å»³ç®¡ç†</span>
        <button class="toggleBtn" data-target="restaurantBody">æ”¶åˆ</button>
      </div>
      <div id="restaurantBody" class="section-body">
        <div class="flex-row">
          <div class="flex-1">
            <label>é¤å»³åç¨±</label>
            <input type="text" id="adminRestaurantName" placeholder="ä¾‹å¦‚ï¼šå¥½åƒä¾¿ç•¶" />
          </div>
          <div class="flex-1">
            <label>é›»è©±</label>
            <input type="text" id="adminRestaurantPhone" placeholder="ä¾‹å¦‚ï¼š02-1234-5678" />
          </div>
        </div>
        <div class="flex-row">
          <div class="flex-1">
            <label>åœ°å€</label>
            <input type="text" id="adminRestaurantAddress" placeholder="ä¾‹å¦‚ï¼šå°åŒ—å¸‚OOå€OOè·¯" />
          </div>
        </div>
        <div class="flex-row">
          <div class="flex-1">
            <label>å‚™è¨»</label>
            <input type="text" id="adminRestaurantNote" placeholder="ä¾‹å¦‚ï¼šåªæ”¶ç¾é‡‘ / æœ€æ™š 10:30 æ”¶å–®" />
          </div>
        </div>
        <div class="flex-row">
          <div class="flex-1">
            <label>èœå–®åœ–ç‰‡ç¶²å€</label>
            <input type="text" id="adminRestaurantImage" placeholder="https://..." />
          </div>
          <div class="flex-1">
            <label>&nbsp;</label>
            <button id="addRestaurantBtn">æ–°å¢é¤å»³</button>
          </div>
        </div>

        <div id="adminRestaurantList" class="text-small" style="margin-top:8px;">
          å°šæœªæ–°å¢é¤å»³ã€‚
        </div>
      </div>
    </div>

    <!-- é¤é»ç®¡ç† -->
    <div class="card" style="margin:10px 0;">
      <div class="card-title">
        <span>é¤é»ç®¡ç†ï¼ˆå«åŠ è³¼é¸é …ï¼‰</span>
        <button class="toggleBtn" data-target="foodBody">æ”¶åˆ</button>
      </div>
      <div id="foodBody" class="section-body">
        <div class="flex-row">
          <div class="flex-1">
            <label>é¤å»³</label>
            <select id="adminFoodRestaurantSelect">
              <option value="">è«‹å…ˆæ–°å¢é¤å»³</option>
            </select>
          </div>
          <div class="flex-1">
            <label>é¤é»åç¨±</label>
            <input type="text" id="adminFoodName" placeholder="ä¾‹å¦‚ï¼šæ»·è‚‰æ‹Œéºµ" />
          </div>
          <div class="flex-1">
            <label>åŸºæœ¬åƒ¹æ ¼ï¼ˆå…ƒï¼‰</label>
            <input type="number" id="adminFoodBasePrice" placeholder="ä¾‹å¦‚ï¼š80" />
          </div>
        </div>

        <!-- åŠ è³¼è¨­å®šï¼ˆç°¡åŒ–ç‰ˆï¼‰ -->
        <p class="text-small">å¯å‹¾é¸æ­¤é¤é»æ”¯æ´å“ªäº›åŠ è³¼é …ç›®ï¼š</p>
        <div class="flex-row">
          <div class="flex-1">
            <label><input type="checkbox" id="addonEgg"> åŠ è›‹ï¼ˆ+10ï¼Œcheckboxï¼‰</label>
          </div>
          <div class="flex-1">
            <label><input type="checkbox" id="addonSize"> å¤§å°ï¼ˆå° / å¤§+20ï¼Œradioï¼‰</label>
          </div>
        </div>
        <div class="flex-row">
          <div class="flex-1">
            <label><input type="checkbox" id="addonSoupDry"> æ¹¯ / ä¹¾ï¼ˆä¸åŠ åƒ¹ï¼Œradioï¼‰</label>
          </div>
          <div class="flex-1">
            <label><input type="checkbox" id="addonSweet"> ç”œåº¦ï¼ˆä¸‹æ‹‰ï¼šå…¨ç³–/åŠç³–/å¾®ç³–/ç„¡ç³–ï¼‰</label>
          </div>
        </div>
        <div class="flex-row">
          <div class="flex-1">
            <label><input type="checkbox" id="addonIce"> å†°é‡ï¼ˆä¸‹æ‹‰ï¼šæ­£å¸¸/å°‘å†°/å¾®å†°/å»å†°ï¼‰</label>
          </div>
          <div class="flex-1">
            <label><input type="checkbox" id="addonExtraQty"> åŠ æ–™ä»½æ•¸ï¼ˆnumberï¼Œæ¯ä»½ +10ï¼‰</label>
          </div>
        </div>

        <button id="addFoodBtn">æ–°å¢é¤é»</button>

        <div id="adminFoodList" class="text-small" style="margin-top:8px;">å°šæœªæ–°å¢é¤é»ã€‚</div>
      </div>
    </div>

    <!-- è¨‚å–®çµ±è¨ˆ -->
    <div class="card" style="margin:10px 0;">
      <div class="card-title">
        <span>è¨‚å–®çµ±è¨ˆ</span>
        <button class="toggleBtn" data-target="statBody">æ”¶åˆ</button>
      </div>
      <div id="statBody" class="section-body">
        <div class="flex-row">
          <div class="flex-1">
            <label>èµ·å§‹æ—¥æœŸ</label>
            <input type="date" id="statStartDate" />
          </div>
          <div class="flex-1">
            <label>çµæŸæ—¥æœŸ</label>
            <input type="date" id="statEndDate" />
          </div>
          <div class="flex-1">
            <label>æ¨¡å¼</label>
            <select id="statMode">
              <option value="restaurant">ä¾åº—å®¶</option>
              <option value="person">ä¾äººå“¡</option>
            </select>
          </div>
        </div>
        <button id="statRefreshBtn">é‡æ–°æ•´ç†çµ±è¨ˆ</button>
        <div id="statResult" class="text-small" style="margin-top:8px;">å°šæœªæœ‰è¨‚å–®è³‡æ–™ã€‚</div>
      </div>
    </div>

    <!-- åˆªé™¤ç´€éŒ„ -->
    <div class="card" style="margin:10px 0;">
      <div class="card-title">
        <span>åˆªé™¤ç´€éŒ„</span>
        <button class="toggleBtn" data-target="deleteBody">æ”¶åˆ</button>
      </div>
      <div id="deleteBody" class="section-body">
        <h4>è¨‚å–®åˆªé™¤ç´€éŒ„</h4>
        <div id="orderDeleteLog" class="text-small">å°šç„¡è¨‚å–®åˆªé™¤ç´€éŒ„ã€‚</div>
        <hr>
        <h4>é¤å»³ / é¤é»åˆªé™¤ç´€éŒ„</h4>
        <div id="itemDeleteLog" class="text-small">å°šç„¡é¤å»³ / é¤é»åˆªé™¤ç´€éŒ„ã€‚</div>
      </div>
    </div>

  </section>
</main>

<!-- åŠ è³¼å½ˆçª— -->
<div class="modal-bg" id="addonModal">
  <div class="modal-box">
    <h3 id="modalFoodName">é¤é»åç¨±</h3>
    <p class="text-small" id="modalRestaurantName">åº—å®¶</p>
    <p class="text-small">åŸºæœ¬åƒ¹æ ¼ï¼š<span id="modalBasePrice"></span> å…ƒ</p>

    <div id="modalAddonContainer" class="text-small"></div>

    <label>å‚™è¨»</label>
    <textarea id="modalNote" rows="2" placeholder="ä¾‹ï¼šä¸è¦é¦™èœã€é†¬æ±å¦å¤–è£"></textarea>

    <div style="display:flex;justify-content:space-between;margin-top:12px;">
      <button class="btn-secondary" id="modalCancelBtn">å–æ¶ˆ</button>
      <button id="modalConfirmBtn">åŠ å…¥è¨‚å–®</button>
    </div>
  </div>
</div>

<script>
/* ===========================
   è³‡æ–™çµæ§‹ & åˆå§‹
=========================== */

const STORAGE_KEY = "orderSystem_v1";

/*
data = {
  departments: [...å›ºå®š],
  people: [{id,name,dept}],
  restaurants: [{id,name,phone,address,note,image,visible,deleted}],
  foods: [{
    id, restaurantId, name, basePrice, visible, deleted,
    addons: { egg,size,soupDry,sweet,ice,extraQty }
  }],
  orders: [{
    id, personId, restaurantId, foodId,
    addonsSelection: {...}, note, basePrice, extraPrice, totalPrice,
    time, deleted
  }],
  deleteLogs: {
    orders: [{time, by, snapshot}],
    items: [{time, by, type, snapshot}]
  }
}
*/

function defaultData() {
  return {
    departments: ["ç®¡ç†éƒ¨","FAE","TSE","æ–°å ´","å€‰ç®¡","æ•¸æ“šåˆ†æ","RD","ç·šä¸Šå®¢æœ","ç¶­é‹"],
    people: [],
    restaurants: [],
    foods: [],
    orders: [],
    deleteLogs: {
      orders: [],
      items: []
    }
  };
}

let data;
try {
  const raw = localStorage.getItem(STORAGE_KEY);
  data = raw ? JSON.parse(raw) : defaultData();
} catch (e) {
  data = defaultData();
}

function saveData() {
  localStorage.setItem(STORAGE_KEY, JSON.stringify(data));
}

/* ===========================
   DOM å–å¾—
=========================== */

const roleLabel = document.getElementById("roleLabel");
const roleSelect = document.getElementById("roleSelect");
const adminPwdWrapper = document.getElementById("adminPwdWrapper");
const adminLoginBtnWrapper = document.getElementById("adminLoginBtnWrapper");
const adminPwd = document.getElementById("adminPwd");
const adminLoginBtn = document.getElementById("adminLoginBtn");
const adminLogoutBtn = document.getElementById("adminLogoutBtn");

const userSection = document.getElementById("userSection");
const adminSection = document.getElementById("adminSection");

const userDeptSelect = document.getElementById("userDeptSelect");
const userPersonSelect = document.getElementById("userPersonSelect");
const userRestaurantSelect = document.getElementById("userRestaurantSelect");
const userRestaurantInfo = document.getElementById("userRestaurantInfo");
const userFoodList = document.getElementById("userFoodList");
const userOrderList = document.getElementById("userOrderList");

const adminDeptSelect = document.getElementById("adminDeptSelect");
const adminPersonName = document.getElementById("adminPersonName");
const addPersonBtn = document.getElementById("addPersonBtn");
const adminPersonList = document.getElementById("adminPersonList");

const adminRestaurantName = document.getElementById("adminRestaurantName");
const adminRestaurantPhone = document.getElementById("adminRestaurantPhone");
const adminRestaurantAddress = document.getElementById("adminRestaurantAddress");
const adminRestaurantNote = document.getElementById("adminRestaurantNote");
const adminRestaurantImage = document.getElementById("adminRestaurantImage");
const addRestaurantBtn = document.getElementById("addRestaurantBtn");
const adminRestaurantList = document.getElementById("adminRestaurantList");

const adminFoodRestaurantSelect = document.getElementById("adminFoodRestaurantSelect");
const adminFoodName = document.getElementById("adminFoodName");
const adminFoodBasePrice = document.getElementById("adminFoodBasePrice");
const addFoodBtn = document.getElementById("addFoodBtn");
const adminFoodList = document.getElementById("adminFoodList");

const addonEgg = document.getElementById("addonEgg");
const addonSize = document.getElementById("addonSize");
const addonSoupDry = document.getElementById("addonSoupDry");
const addonSweet = document.getElementById("addonSweet");
const addonIce = document.getElementById("addonIce");
const addonExtraQty = document.getElementById("addonExtraQty");

const statStartDate = document.getElementById("statStartDate");
const statEndDate = document.getElementById("statEndDate");
const statMode = document.getElementById("statMode");
const statRefreshBtn = document.getElementById("statRefreshBtn");
const statResult = document.getElementById("statResult");

const orderDeleteLog = document.getElementById("orderDeleteLog");
const itemDeleteLog = document.getElementById("itemDeleteLog");

/* Modal */
const addonModal = document.getElementById("addonModal");
const modalFoodName = document.getElementById("modalFoodName");
const modalRestaurantName = document.getElementById("modalRestaurantName");
const modalBasePrice = document.getElementById("modalBasePrice");
const modalAddonContainer = document.getElementById("modalAddonContainer");
const modalNote = document.getElementById("modalNote");
const modalCancelBtn = document.getElementById("modalCancelBtn");
const modalConfirmBtn = document.getElementById("modalConfirmBtn");

let isAdmin = false;
let modalCurrentFoodId = null;

/* ===========================
   å·¥å…·
=========================== */

function genId(prefix) {
  return prefix + "_" + Math.random().toString(16).slice(2) + Date.now();
}

function formatDateInput(d) {
  const y = d.getFullYear();
  const m = String(d.getMonth()+1).padStart(2,"0");
  const day = String(d.getDate()).padStart(2,"0");
  return `${y}-${m}-${day}`;
}

/* ===========================
   åˆå§‹åŒ– UI
=========================== */

function initDepartments() {
  userDeptSelect.innerHTML = "";
  adminDeptSelect.innerHTML = "";
  data.departments.forEach(d => {
    const o1 = document.createElement("option");
    o1.value = d;
    o1.textContent = d;
    userDeptSelect.appendChild(o1);

    const o2 = document.createElement("option");
    o2.value = d;
    o2.textContent = d;
    adminDeptSelect.appendChild(o2);
  });
}

function refreshPersonList() {
  if (!data.people.length) {
    adminPersonList.textContent = "å°šæœªæ–°å¢äººå“¡ã€‚";
  } else {
    let html = '<table class="table"><thead><tr><th>éƒ¨é–€</th><th>å§“å</th></tr></thead><tbody>';
    data.people.forEach(p => {
      html += `<tr><td>${p.dept}</td><td>${p.name}</td></tr>`;
    });
    html += "</tbody></table>";
    adminPersonList.innerHTML = html;
  }

  // ä½¿ç”¨è€…å§“åé¸å–®ï¼ˆä¾ç›®å‰é¸çš„éƒ¨é–€ï¼‰
  const dept = userDeptSelect.value;
  userPersonSelect.innerHTML = "";
  if (!dept) {
    const opt = document.createElement("option");
    opt.value = "";
    opt.textContent = "è«‹å…ˆé¸æ“‡éƒ¨é–€";
    userPersonSelect.appendChild(opt);
    return;
  }
  const list = data.people.filter(p => p.dept === dept);
  if (!list.length) {
    const opt = document.createElement("option");
    opt.value = "";
    opt.textContent = "æ­¤éƒ¨é–€å°šæœªæ–°å¢äººå“¡";
    userPersonSelect.appendChild(opt);
    return;
  }
  const opt0 = document.createElement("option");
  opt0.value = "";
  opt0.textContent = "è«‹é¸æ“‡å§“å";
  userPersonSelect.appendChild(opt0);
  list.forEach(p => {
    const o = document.createElement("option");
    o.value = p.id;
    o.textContent = p.name;
    userPersonSelect.appendChild(o);
  });
}

function refreshRestaurantOptions() {
  // ç®¡ç†å“¡é¤é»ç®¡ç†ä¸­çš„é¤å»³ä¸‹æ‹‰
  adminFoodRestaurantSelect.innerHTML = "";
  if (!data.restaurants.length) {
    const opt = document.createElement("option");
    opt.value = "";
    opt.textContent = "è«‹å…ˆæ–°å¢é¤å»³";
    adminFoodRestaurantSelect.appendChild(opt);
  } else {
    const opt0 = document.createElement("option");
    opt0.value = "";
    opt0.textContent = "è«‹é¸æ“‡é¤å»³";
    adminFoodRestaurantSelect.appendChild(opt0);
    data.restaurants.filter(r=>!r.deleted).forEach(r => {
      const o = document.createElement("option");
      o.value = r.id;
      o.textContent = r.name + (r.visible ? "" : "ï¼ˆå·²éš±è—ï¼‰");
      adminFoodRestaurantSelect.appendChild(o);
    });
  }

  // ä½¿ç”¨è€…ç«¯é¤å»³ä¸‹æ‹‰ï¼ˆåªé¡¯ç¤º visible=true ä¸”é deletedï¼‰
  userRestaurantSelect.innerHTML = "";
  const visibleRestaurants = data.restaurants.filter(r => r.visible && !r.deleted);
  if (!visibleRestaurants.length) {
    const opt = document.createElement("option");
    opt.value = "";
    opt.textContent = "è«‹å…ˆè®“ç®¡ç†å“¡æ–°å¢é¤å»³";
    userRestaurantSelect.appendChild(opt);
  } else {
    const opt0 = document.createElement("option");
    opt0.value = "";
    opt0.textContent = "è«‹é¸æ“‡é¤å»³";
    userRestaurantSelect.appendChild(opt0);
    visibleRestaurants.forEach(r => {
      const o = document.createElement("option");
      o.value = r.id;
      o.textContent = r.name;
      userRestaurantSelect.appendChild(o);
    });
  }
}

function renderRestaurantListForAdmin() {
  if (!data.restaurants.length) {
    adminRestaurantList.textContent = "å°šæœªæ–°å¢é¤å»³ã€‚";
    return;
  }
  let html = "";
  data.restaurants.forEach(r => {
    html += `
      <div class="restaurant-box" data-rest-id="${r.id}">
        <div style="display:flex;justify-content:space-between;align-items:center;">
          <div>
            <strong>${r.name}</strong>
            ${!r.visible ? '<span class="badge">å·²éš±è—</span>' : ''}
            ${r.deleted ? '<span class="badge">å·²åˆªé™¤</span>' : ''}
          </div>
          <div>
            <label class="text-small">
              <input type="checkbox" class="restVisibleToggle" data-id="${r.id}" ${r.visible ? 'checked' : ''}>
              é¡¯ç¤ºæ–¼å‰å°
            </label>
            <button class="btn-danger btn-small" data-delete-rest="${r.id}">åˆªé™¤</button>
          </div>
        </div>
        <div class="text-small">
          é›»è©±ï¼š${r.phone || '-'}<br>
          åœ°å€ï¼š${r.address || '-'}<br>
          å‚™è¨»ï¼š${r.note || '-'}
        </div>
        ${r.image ? `<img src="${r.image}" alt="èœå–®åœ–ç‰‡" class="menu-image">` : ''}
        <div class="text-small" style="margin-top:6px;">æ­¤é¤å»³é¤é»ï¼š</div>
        <div>
          ${renderFoodsUnderRestaurant(r.id)}
        </div>
      </div>
    `;
  });
  adminRestaurantList.innerHTML = html;
}

function renderFoodsUnderRestaurant(restId) {
  const list = data.foods.filter(f => f.restaurantId === restId && !f.deleted);
  if (!list.length) return '<div class="text-small">ç›®å‰å°šæœªæ–°å¢é¤é»ã€‚</div>';
  let html = '<ul class="text-small" style="padding-left:18px;margin:4px 0;">';
  list.forEach(f => {
    html += `<li>${f.name}ï¼ˆ$${f.basePrice}ï¼‰${!f.visible ? ' <span class="badge">éš±è—</span>' : ''}</li>`;
  });
  html += "</ul>";
  return html;
}

function renderFoodListForAdmin() {
  if (!data.foods.length) {
    adminFoodList.textContent = "å°šæœªæ–°å¢é¤é»ã€‚";
    return;
  }
  let html = '<table class="table"><thead><tr><th>é¤å»³</th><th>é¤é»</th><th>åƒ¹æ ¼</th><th>é¡¯ç¤º</th><th>æ“ä½œ</th></tr></thead><tbody>';
  data.foods.forEach(f => {
    const r = data.restaurants.find(rr=>rr.id===f.restaurantId);
    html += `<tr>
      <td>${r ? r.name : '(å·²åˆªé™¤é¤å»³)'}</td>
      <td>${f.name}${f.deleted?'ï¼ˆå·²åˆªé™¤ï¼‰':''}</td>
      <td>$${f.basePrice}</td>
      <td><input type="checkbox" class="foodVisibleToggle" data-id="${f.id}" ${f.visible ? 'checked' : ''}></td>
      <td><button class="btn-danger btn-small" data-delete-food="${f.id}">åˆªé™¤</button></td>
    </tr>`;
  });
  html += "</tbody></table>";
  adminFoodList.innerHTML = html;
}

function renderUserRestaurantInfo() {
  const restId = userRestaurantSelect.value;
  if (!restId) {
    userRestaurantInfo.innerHTML = "";
    userFoodList.innerHTML = '<p class="text-small">è«‹å…ˆé¸æ“‡é¤å»³ã€‚</p>';
    return;
  }
  const r = data.restaurants.find(rr=>rr.id===restId);
  if (!r) return;
  let info = `é›»è©±ï¼š${r.phone || '-'}<br>åœ°å€ï¼š${r.address || '-'}<br>å‚™è¨»ï¼š${r.note || '-'}`;
  if (r.image) {
    info += `<br><img src="${r.image}" class="menu-image">`;
  }
  userRestaurantInfo.innerHTML = info;

  // é¡¯ç¤ºè©²é¤å»³çš„é¤é»
  const foods = data.foods.filter(f => f.restaurantId === restId && f.visible && !f.deleted);
  if (!foods.length) {
    userFoodList.innerHTML = '<p class="text-small">æ­¤é¤å»³ç›®å‰å°šæœªæœ‰å¯é»é¤é»ã€‚</p>';
    return;
  }
  let html = "";
  foods.forEach(f => {
    html += `
      <div class="food-item" data-food-id="${f.id}">
        <div>
          <div><strong>${f.name}</strong></div>
          <div class="text-small">åŸºæœ¬åƒ¹ï¼š$${f.basePrice}</div>
        </div>
        <button class="btn-small" data-order-food="${f.id}">é¸æ“‡</button>
      </div>
    `;
  });
  userFoodList.innerHTML = html;
}

function renderUserOrders() {
  const personId = userPersonSelect.value;
  if (!personId) {
    userOrderList.textContent = "å°šæœªæœ‰è¨‚å–®ã€‚";
    return;
  }
  const myOrders = data.orders.filter(o => o.personId === personId && !o.deleted);
  if (!myOrders.length) {
    userOrderList.textContent = "å°šæœªæœ‰è¨‚å–®ã€‚";
    return;
  }
  let html = '<table class="table"><thead><tr><th>æ™‚é–“</th><th>é¤å»³</th><th>é¤é»</th><th>é‡‘é¡</th><th>å‚™è¨»</th><th>æ“ä½œ</th></tr></thead><tbody>';
  myOrders.sort((a,b)=>a.time-b.time).forEach(o => {
    const r = data.restaurants.find(rr=>rr.id===o.restaurantId);
    const f = data.foods.find(ff=>ff.id===o.foodId);
    const timeStr = new Date(o.time).toLocaleString();
    html += `<tr>
      <td>${timeStr}</td>
      <td>${r ? r.name : '(å·²åˆªé™¤é¤å»³)'}</td>
      <td>${f ? f.name : '(å·²åˆªé™¤é¤é»)'}<br><span class="text-small">${describeAddonSelection(o.addonsSelection)}</span></td>
      <td>$${o.totalPrice}</td>
      <td>${o.note || ''}</td>
      <td><button class="btn-danger btn-small" data-delete-order="${o.id}">åˆªé™¤</button></td>
    </tr>`;
  });
  html += "</tbody></table>";
  userOrderList.innerHTML = html;
}

function describeAddonSelection(sel) {
  if (!sel) return "";
  const parts = [];
  if (sel.egg) parts.push("åŠ è›‹");
  if (sel.size) parts.push(sel.size === "big" ? "å¤§" : "å°");
  if (sel.soupDry) parts.push(sel.soupDry === "soup" ? "æ¹¯" : "ä¹¾");
  if (sel.sweet) parts.push("ç”œåº¦ï¼š" + sel.sweet);
  if (sel.ice) parts.push("å†°é‡ï¼š" + sel.ice);
  if (typeof sel.extraQty === "number" && sel.extraQty > 0) parts.push("åŠ æ–™ x" + sel.extraQty);
  return parts.join(" / ");
}

/* ============ åˆªé™¤ç´€éŒ„æ¸²æŸ“ ============ */

function renderDeleteLogs() {
  const d1 = data.deleteLogs.orders;
  if (!d1.length) {
    orderDeleteLog.textContent = "å°šç„¡è¨‚å–®åˆªé™¤ç´€éŒ„ã€‚";
  } else {
    let html = '<table class="table"><thead><tr><th>æ™‚é–“</th><th>åˆªé™¤è€…</th><th>æ‘˜è¦</th></tr></thead><tbody>';
    d1.forEach(l => {
      html += `<tr><td>${new Date(l.time).toLocaleString()}</td><td>${l.by}</td><td>${l.summary}</td></tr>`;
    });
    html += '</tbody></table>';
    orderDeleteLog.innerHTML = html;
  }

  const d2 = data.deleteLogs.items;
  if (!d2.length) {
    itemDeleteLog.textContent = "å°šç„¡é¤å»³ / é¤é»åˆªé™¤ç´€éŒ„ã€‚";
  } else {
    let html = '<table class="table"><thead><tr><th>æ™‚é–“</th><th>åˆªé™¤è€…</th><th>é¡å‹</th><th>æ‘˜è¦</th></tr></thead><tbody>';
    d2.forEach(l => {
      html += `<tr><td>${new Date(l.time).toLocaleString()}</td><td>${l.by}</td><td>${l.type}</td><td>${l.summary}</td></tr>`;
    });
    html += '</tbody></table>';
    itemDeleteLog.innerHTML = html;
  }
}

/* ===========================
   åŠ è³¼å½ˆçª—ç›¸é—œ
=========================== */

function openAddonModal(foodId) {
  modalCurrentFoodId = foodId;
  const f = data.foods.find(ff=>ff.id===foodId);
  if (!f) return;
  const r = data.restaurants.find(rr=>rr.id===f.restaurantId);
  modalFoodName.textContent = f.name;
  modalRestaurantName.textContent = r ? r.name : "";
  modalBasePrice.textContent = f.basePrice;
  modalNote.value = "";
  modalAddonContainer.innerHTML = "";

  const addons = f.addons || {};
  // egg checkbox
  if (addons.egg) {
    const div = document.createElement("div");
    div.innerHTML = `<label><input type="checkbox" id="modalEgg"> åŠ è›‹ï¼ˆ+10ï¼‰</label>`;
    modalAddonContainer.appendChild(div);
  }
  // size radio
  if (addons.size) {
    const div = document.createElement("div");
    div.innerHTML = `
      <div>å¤§å°ï¼š</div>
      <label><input type="radio" name="modalSize" value="small" checked> å°ï¼ˆ+0ï¼‰</label>
      <label><input type="radio" name="modalSize" value="big"> å¤§ï¼ˆ+20ï¼‰</label>
    `;
    modalAddonContainer.appendChild(div);
  }
  // soup/dry
  if (addons.soupDry) {
    const div = document.createElement("div");
    div.innerHTML = `
      <div>æ¹¯ / ä¹¾ï¼š</div>
      <label><input type="radio" name="modalSoupDry" value="soup" checked> æ¹¯</label>
      <label><input type="radio" name="modalSoupDry" value="dry"> ä¹¾</label>
    `;
    modalAddonContainer.appendChild(div);
  }
  // sweet
  if (addons.sweet) {
    const div = document.createElement("div");
    div.innerHTML = `
      <label>ç”œåº¦ï¼š
        <select id="modalSweet">
          <option value="å…¨ç³–">å…¨ç³–</option>
          <option value="åŠç³–">åŠç³–</option>
          <option value="å¾®ç³–">å¾®ç³–</option>
          <option value="ç„¡ç³–">ç„¡ç³–</option>
        </select>
      </label>
    `;
    modalAddonContainer.appendChild(div);
  }
  // ice
  if (addons.ice) {
    const div = document.createElement("div");
    div.innerHTML = `
      <label>å†°é‡ï¼š
        <select id="modalIce">
          <option value="æ­£å¸¸å†°">æ­£å¸¸å†°</option>
          <option value="å°‘å†°">å°‘å†°</option>
          <option value="å¾®å†°">å¾®å†°</option>
          <option value="å»å†°">å»å†°</option>
        </select>
      </label>
    `;
    modalAddonContainer.appendChild(div);
  }
  // extra qty
  if (addons.extraQty) {
    const div = document.createElement("div");
    div.innerHTML = `
      <label>åŠ æ–™ä»½æ•¸ï¼ˆæ¯ä»½ +10ï¼‰
        <input type="number" id="modalExtraQty" min="0" max="5" value="0">
      </label>
    `;
    modalAddonContainer.appendChild(div);
  }

  addonModal.style.display = "flex";
}

function closeAddonModal() {
  addonModal.style.display = "none";
  modalCurrentFoodId = null;
}

/* ===========================
   çµ±è¨ˆ
=========================== */

function getOrdersInRange() {
  let list = data.orders.filter(o => !o.deleted);
  const s = statStartDate.value;
  const e = statEndDate.value;
  if (s) list = list.filter(o => formatDateInput(new Date(o.time)) >= s);
  if (e) list = list.filter(o => formatDateInput(new Date(o.time)) <= e);
  return list;
}

function refreshStats() {
  const list = getOrdersInRange();
  if (!list.length) {
    statResult.textContent = "æ­¤æ—¥æœŸç¯„åœå…§å°šç„¡è¨‚å–®ã€‚";
    return;
  }
  if (statMode.value === "person") {
    // ä¾äººå“¡
    const map = {};
    list.forEach(o => {
      if (!map[o.personId]) map[o.personId] = {count:0,total:0};
      map[o.personId].count++;
      map[o.personId].total += o.totalPrice;
    });
    let html = '<table class="table"><thead><tr><th>éƒ¨é–€</th><th>å§“å</th><th>è¨‚å–®æ•¸</th><th>ç¸½é‡‘é¡</th></tr></thead><tbody>';
    Object.keys(map).forEach(pid => {
      const p = data.people.find(pp=>pp.id===pid);
      if (!p) return;
      const st = map[pid];
      html += `<tr><td>${p.dept}</td><td>${p.name}</td><td>${st.count}</td><td>$${st.total}</td></tr>`;
    });
    html += "</tbody></table>";
    // æ˜ç´°
    html += "<h4>æ˜ç´°</h4>";
    html += '<table class="table"><thead><tr><th>æ™‚é–“</th><th>å§“å</th><th>é¤å»³</th><th>é¤é»</th><th>é‡‘é¡</th><th>å‚™è¨»</th></tr></thead><tbody>';
    list.sort((a,b)=>a.time-b.time).forEach(o => {
      const p = data.people.find(pp=>pp.id===o.personId);
      const r = data.restaurants.find(rr=>rr.id===o.restaurantId);
      const f = data.foods.find(ff=>ff.id===o.foodId);
      html += `<tr>
        <td>${new Date(o.time).toLocaleString()}</td>
        <td>${p ? p.name : ''}</td>
        <td>${r ? r.name: ''}</td>
        <td>${f ? f.name: ''}<br><span class="text-small">${describeAddonSelection(o.addonsSelection)}</span></td>
        <td>$${o.totalPrice}</td>
        <td>${o.note||''}</td>
      </tr>`;
    });
    html += "</tbody></table>";
    statResult.innerHTML = html;
  } else {
    // ä¾åº—å®¶
    const map = {};
    list.forEach(o => {
      if (!map[o.restaurantId]) map[o.restaurantId] = {};
      const perRest = map[o.restaurantId];
      if (!perRest[o.foodId]) perRest[o.foodId] = {count:0, total:0, people:new Set()};
      const st = perRest[o.foodId];
      st.count++;
      st.total += o.totalPrice;
      st.people.add(o.personId);
    });

    let html = "";
    Object.keys(map).forEach(rid => {
      const r = data.restaurants.find(rr=>rr.id===rid);
      html += `<h4>${r ? r.name : '(å·²åˆªé™¤é¤å»³)'}</h4>`;
      html += '<table class="table"><thead><tr><th>é¤é»</th><th>é»é¤äººæ•¸</th><th>è¨‚å–®ä»½æ•¸</th><th>ç¸½é‡‘é¡</th></tr></thead><tbody>';
      const perRest = map[rid];
      Object.keys(perRest).forEach(fid => {
        const f = data.foods.find(ff=>ff.id===fid);
        const st = perRest[fid];
        html += `<tr>
          <td>${f ? f.name : '(å·²åˆªé™¤é¤é»)'}</td>
          <td>${st.people.size}</td>
          <td>${st.count}</td>
          <td>$${st.total}</td>
        </tr>`;
      });
      html += "</tbody></table>";
    });

    html += "<h4>æ˜ç´°</h4>";
    html += '<table class="table"><thead><tr><th>æ™‚é–“</th><th>é¤å»³</th><th>é¤é»</th><th>å§“å</th><th>é‡‘é¡</th><th>å‚™è¨»</th></tr></thead><tbody>';
    list.sort((a,b)=>a.time-b.time).forEach(o => {
      const p = data.people.find(pp=>pp.id===o.personId);
      const r = data.restaurants.find(rr=>rr.id===o.restaurantId);
      const f = data.foods.find(ff=>ff.id===o.foodId);
      html += `<tr>
        <td>${new Date(o.time).toLocaleString()}</td>
        <td>${r ? r.name: ''}</td>
        <td>${f ? f.name: ''}<br><span class="text-small">${describeAddonSelection(o.addonsSelection)}</span></td>
        <td>${p ? p.name : ''}</td>
        <td>$${o.totalPrice}</td>
        <td>${o.note||''}</td>
      </tr>`;
    });
    html += "</tbody></table>";
    statResult.innerHTML = html;
  }
}

/* ===========================
   äº‹ä»¶ç¶å®š
=========================== */

roleSelect.addEventListener("change", () => {
  if (roleSelect.value === "admin") {
    adminPwdWrapper.classList.remove("hidden");
    adminLoginBtnWrapper.classList.remove("hidden");
    userSection.classList.add("hidden");
    adminSection.classList.add("hidden");
    roleLabel.textContent = "ç›®å‰èº«åˆ†ï¼šå°šæœªç™»å…¥ç®¡ç†å“¡";
  } else {
    isAdmin = false;
    adminPwdWrapper.classList.add("hidden");
    adminLoginBtnWrapper.classList.add("hidden");
    adminSection.classList.add("hidden");
    userSection.classList.remove("hidden");
    roleLabel.textContent = "ç›®å‰èº«åˆ†ï¼šä¸€èˆ¬ä½¿ç”¨è€…";
  }
});

adminLoginBtn.addEventListener("click", () => {
  if (adminPwd.value === "1234") {
    isAdmin = true;
    adminSection.classList.remove("hidden");
    userSection.classList.add("hidden");
    roleLabel.textContent = "ç›®å‰èº«åˆ†ï¼šç®¡ç†å“¡";
  } else {
    alert("å¯†ç¢¼éŒ¯èª¤");
  }
});

adminLogoutBtn.addEventListener("click", () => {
  isAdmin = false;
  adminSection.classList.add("hidden");
  userSection.classList.remove("hidden");
  roleLabel.textContent = "ç›®å‰èº«åˆ†ï¼šä¸€èˆ¬ä½¿ç”¨è€…";
  roleSelect.value = "user";
});

/* äººå“¡æ–°å¢ */
addPersonBtn.addEventListener("click", () => {
  const dept = adminDeptSelect.value;
  const name = adminPersonName.value.trim();
  if (!name) {
    alert("è«‹è¼¸å…¥å§“å");
    return;
  }
  data.people.push({
    id: genId("p"),
    dept,
    name
  });
  adminPersonName.value = "";
  saveData();
  refreshPersonList();
});

/* éƒ¨é–€åˆ‡æ› â†’ ä½¿ç”¨è€…å§“ååˆ—è¡¨æ›´æ–° */
userDeptSelect.addEventListener("change", () => {
  refreshPersonList();
  renderUserOrders();
});

/* å§“ååˆ‡æ› â†’ æˆ‘çš„è¨‚å–®æ›´æ–° */
userPersonSelect.addEventListener("change", () => {
  renderUserOrders();
});

/* æ–°å¢é¤å»³ */
addRestaurantBtn.addEventListener("click", () => {
  const name = adminRestaurantName.value.trim();
  if (!name) {
    alert("è«‹è¼¸å…¥é¤å»³åç¨±");
    return;
  }
  const rest = {
    id: genId("r"),
    name,
    phone: adminRestaurantPhone.value.trim(),
    address: adminRestaurantAddress.value.trim(),
    note: adminRestaurantNote.value.trim(),
    image: adminRestaurantImage.value.trim(),
    visible: true,
    deleted: false
  };
  data.restaurants.push(rest);
  adminRestaurantName.value = "";
  adminRestaurantPhone.value = "";
  adminRestaurantAddress.value = "";
  adminRestaurantNote.value = "";
  adminRestaurantImage.value = "";
  saveData();
  refreshRestaurantOptions();
  renderRestaurantListForAdmin();
});

/* é¤å»³åˆ—è¡¨äº‹ä»¶ä»£ç†ï¼ˆé¡¯ç¤ºåˆ‡æ› & åˆªé™¤ï¼‰ */
adminRestaurantList.addEventListener("change", (e) => {
  if (e.target.classList.contains("restVisibleToggle")) {
    const id = e.target.dataset.id;
    const r = data.restaurants.find(rr=>rr.id===id);
    if (r) {
      r.visible = e.target.checked;
      saveData();
      refreshRestaurantOptions();
      renderRestaurantListForAdmin();
    }
  }
});
adminRestaurantList.addEventListener("click", (e) => {
  const rid = e.target.dataset.deleteRest;
  if (rid) {
    const r = data.restaurants.find(rr=>rr.id===rid);
    if (!r) return;
    if (!confirm(`ç¢ºå®šè¦åˆªé™¤é¤å»³ã€Œ${r.name}ã€ï¼Ÿ\næ­¤å‹•ä½œæœƒè®“å‰å°ç„¡æ³•å†é»æ­¤é¤å»³ï¼Œä½†æ­·å²è¨‚å–®ä»ä¿ç•™ã€‚`)) return;
    r.deleted = true;
    r.visible = false;
    // é¤é»ä¹Ÿæ¨™è¨˜ deletedï¼ˆä¸å¼·åˆ¶ï¼Œä½†å‰å°ä¸é¡¯ç¤ºï¼‰
    data.foods.filter(f=>f.restaurantId===rid).forEach(f => {
      f.deleted = true;
      f.visible = false;
    });
    // åŠ å…¥åˆªé™¤ç´€éŒ„
    data.deleteLogs.items.push({
      time: Date.now(),
      by: isAdmin ? "ç®¡ç†å“¡" : "ç³»çµ±",
      type: "é¤å»³",
      summary: `åˆªé™¤é¤å»³ï¼š${r.name}`
    });
    saveData();
    refreshRestaurantOptions();
    renderRestaurantListForAdmin();
    renderFoodListForAdmin();
    renderDeleteLogs();
  }
});

/* æ–°å¢é¤é» */
addFoodBtn.addEventListener("click", () => {
  const restId = adminFoodRestaurantSelect.value;
  const name = adminFoodName.value.trim();
  const basePrice = Number(adminFoodBasePrice.value);
  if (!restId) {
    alert("è«‹å…ˆé¸æ“‡é¤å»³");
    return;
  }
  if (!name) {
    alert("è«‹è¼¸å…¥é¤é»åç¨±");
    return;
  }
  if (isNaN(basePrice) || basePrice <= 0) {
    alert("è«‹å¡«å¯«æ­£ç¢ºçš„åŸºæœ¬åƒ¹æ ¼");
    return;
  }
  const food = {
    id: genId("f"),
    restaurantId: restId,
    name,
    basePrice,
    visible: true,
    deleted: false,
    addons: {
      egg: addonEgg.checked,
      size: addonSize.checked,
      soupDry: addonSoupDry.checked,
      sweet: addonSweet.checked,
      ice: addonIce.checked,
      extraQty: addonExtraQty.checked
    }
  };
  data.foods.push(food);
  adminFoodName.value = "";
  adminFoodBasePrice.value = "";
  addonEgg.checked = false;
  addonSize.checked = false;
  addonSoupDry.checked = false;
  addonSweet.checked = false;
  addonIce.checked = false;
  addonExtraQty.checked = false;
  saveData();
  renderRestaurantListForAdmin();
  renderFoodListForAdmin();
  if (userRestaurantSelect.value === restId) {
    renderUserRestaurantInfo();
  }
});

/* é¤é»é¡¯ç¤ºåˆ‡æ› & åˆªé™¤ï¼ˆç®¡ç†å“¡ç«¯ï¼‰ */
adminFoodList.addEventListener("change", (e) => {
  if (e.target.classList.contains("foodVisibleToggle")) {
    const id = e.target.dataset.id;
    const f = data.foods.find(ff=>ff.id===id);
    if (f) {
      f.visible = e.target.checked;
      saveData();
      renderFoodListForAdmin();
      renderRestaurantListForAdmin();
      renderUserRestaurantInfo();
    }
  }
});
adminFoodList.addEventListener("click", (e) => {
  const fid = e.target.dataset.deleteFood;
  if (fid) {
    const f = data.foods.find(ff=>ff.id===fid);
    if (!f) return;
    if (!confirm(`ç¢ºå®šè¦åˆªé™¤é¤é»ã€Œ${f.name}ã€ï¼Ÿ`)) return;
    f.deleted = true;
    f.visible = false;
    data.deleteLogs.items.push({
      time: Date.now(),
      by: isAdmin ? "ç®¡ç†å“¡" : "ç³»çµ±",
      type: "é¤é»",
      summary: `åˆªé™¤é¤é»ï¼š${f.name}`
    });
    saveData();
    renderFoodListForAdmin();
    renderRestaurantListForAdmin();
    renderUserRestaurantInfo();
    renderDeleteLogs();
  }
});

/* ä½¿ç”¨è€…é¸é¤å»³ â†’ é¡¯ç¤ºé¤é» */
userRestaurantSelect.addEventListener("change", () => {
  renderUserRestaurantInfo();
});

/* ä½¿ç”¨è€…é¤é»åˆ—è¡¨é»æ“Šï¼ˆé–‹å•ŸåŠ è³¼å½ˆçª—ï¼‰ */
userFoodList.addEventListener("click", (e) => {
  const fid = e.target.dataset.orderFood;
  if (fid) {
    const personId = userPersonSelect.value;
    if (!personId) {
      alert("è«‹å…ˆé¸æ“‡éƒ¨é–€èˆ‡å§“å");
      return;
    }
    openAddonModal(fid);
  }
});

/* Modal æŒ‰éˆ• */
modalCancelBtn.addEventListener("click", () => {
  closeAddonModal();
});

modalConfirmBtn.addEventListener("click", () => {
  if (!modalCurrentFoodId) return;
  const f = data.foods.find(ff=>ff.id===modalCurrentFoodId);
  const r = f ? data.restaurants.find(rr=>rr.id===f.restaurantId) : null;
  const personId = userPersonSelect.value;
  if (!f || !r || !personId) {
    alert("è³‡æ–™éŒ¯èª¤");
    return;
  }

  const sel = {};
  let extra = 0;

  // ä¾ç•¶åˆ addons è¨­å®šæŠ“ modal çš„é¸é …
  const addons = f.addons || {};
  if (addons.egg) {
    const cb = document.getElementById("modalEgg");
    sel.egg = cb && cb.checked;
    if (sel.egg) extra += 10;
  }
  if (addons.size) {
    const sizeRadio = document.querySelector('input[name="modalSize"]:checked');
    sel.size = sizeRadio ? sizeRadio.value : "small";
    if (sel.size === "big") extra += 20;
  }
  if (addons.soupDry) {
    const sdRadio = document.querySelector('input[name="modalSoupDry"]:checked');
    sel.soupDry = sdRadio ? sdRadio.value : "soup";
  }
  if (addons.sweet) {
    const sweetSelect = document.getElementById("modalSweet");
    sel.sweet = sweetSelect ? sweetSelect.value : null;
  }
  if (addons.ice) {
    const iceSelect = document.getElementById("modalIce");
    sel.ice = iceSelect ? iceSelect.value : null;
  }
  if (addons.extraQty) {
    const extraInput = document.getElementById("modalExtraQty");
    const qty = extraInput ? Number(extraInput.value) : 0;
    sel.extraQty = qty;
    if (qty > 0) extra += 10 * qty;
  }

  const note = modalNote.value.trim();
  const base = f.basePrice;
  const total = base + extra;

  const order = {
    id: genId("o"),
    personId,
    restaurantId: r.id,
    foodId: f.id,
    addonsSelection: sel,
    note,
    basePrice: base,
    extraPrice: extra,
    totalPrice: total,
    time: Date.now(),
    deleted: false
  };
  data.orders.push(order);
  saveData();
  closeAddonModal();
  renderUserOrders();
  refreshStats();
});

/* åˆªé™¤ä½¿ç”¨è€…è‡ªå·±çš„è¨‚å–® */
userOrderList.addEventListener("click", (e) => {
  const oid = e.target.dataset.deleteOrder;
  if (oid) {
    const o = data.orders.find(oo=>oo.id===oid);
    if (!o) return;
    if (!confirm("ç¢ºå®šè¦åˆªé™¤é€™ç­†è¨‚å–®å—ï¼Ÿ")) return;
    o.deleted = true;
    // åˆªé™¤ç´€éŒ„
    const p = data.people.find(pp=>pp.id===o.personId);
    const r = data.restaurants.find(rr=>rr.id===o.restaurantId);
    const f = data.foods.find(ff=>ff.id===o.foodId);
    data.deleteLogs.orders.push({
      time: Date.now(),
      by: p ? p.name : "ä½¿ç”¨è€…",
      summary: `åˆªé™¤è¨‚å–®ï¼š${r ? r.name : ''} / ${f ? f.name : ''} / $${o.totalPrice}`
    });
    saveData();
    renderUserOrders();
    renderDeleteLogs();
    refreshStats();
  }
});

/* æ”¶åˆæŒ‰éˆ• */
document.querySelectorAll(".toggleBtn").forEach(btn => {
  btn.addEventListener("click", () => {
    const targetId = btn.dataset.target;
    const body = document.getElementById(targetId);
    if (!body) return;
    if (body.classList.contains("hidden")) {
      body.classList.remove("hidden");
      btn.textContent = "æ”¶åˆ";
    } else {
      body.classList.add("hidden");
      btn.textContent = "å±•é–‹";
    }
  });
});

/* çµ±è¨ˆæŒ‰éˆ• */
statRefreshBtn.addEventListener("click", refreshStats);

/* Modal é»èƒŒæ™¯é—œé–‰ */
addonModal.addEventListener("click", (e) => {
  if (e.target === addonModal) closeAddonModal();
});

/* ===========================
   åˆå§‹åŒ–å‘¼å«
=========================== */

function init() {
  initDepartments();
  refreshPersonList();
  refreshRestaurantOptions();
  renderRestaurantListForAdmin();
  renderFoodListForAdmin();
  renderUserRestaurantInfo();
  renderUserOrders();
  renderDeleteLogs();

  const today = new Date();
  const todayStr = formatDateInput(today);
  statStartDate.value = todayStr;
  statEndDate.value = todayStr;
  refreshStats();
}

init();
</script>
</body>
</html>
